(function(){define("modules/clean/account/change_email_modals",["jquery","external/react","modules/core/notify","modules/core/i18n","modules/clean/form","modules/clean/account/email_verify","modules/clean/react/bubble_dropdown","modules/clean/react/input","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/viewer","modules/clean/ajax","modules/constants/viewer"],function(e,t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v,g,y,b,w,C;return y=i._,w=i.render_sentences,C=i.ungettext,g=l.Modal,b=t.DOM,v=t.createClass({propTypes:{user:t.PropTypes.object,inboxCount:t.PropTypes.number,onContinue:t.PropTypes.func},render:function(){return g({title:y("Warning!"),acceptButtonText:y("Continue anyway"),dismissButtonText:y("Cancel"),onAccept:this.showChange,ref:"modal"},this.getSSOWarning(),this.getInboxWarning())},getSSOWarning:function(){var e,t,n;return e=u.get_viewer().is_paired,n=e&&this.props.user.role===p.ROLE_WORK,t=this.props.user.sso_required,n&&t?b.div({},y("Your %(team)s Dropbox uses single sign-on. If you change your email address you may not be able to sign in.").format({team:u.get_viewer().team_name})):null},getInboxWarning:function(){var e;return e=u.get_viewer().is_paired,0===this.props.inboxCount?null:e&&this.props.user.role===p.ROLE_PERSONAL?C("Your %(num)d existing shared folder invitation in your personal Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your personal Dropbox will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount}):e&&this.props.user.role===p.ROLE_WORK?C("Your %(num)d existing shared folder invitation in your %(team)s Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your %(team)s Dropbox will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount,team:u.get_viewer().team_name}):C("Your %(num)d existing shared folder invitation will be removed if you change your email address.","Your %(num)d existing shared folder invitations will be removed if you change your email address.",this.props.inboxCount).format({num:this.props.inboxCount})},showChange:function(e){var t,n;return e.preventDefault(),n=this.refs.modal,n.close(),"function"==typeof(t=this.props).onContinue?t.onContinue():void 0}}),_=t.createClass({propTypes:{user:t.PropTypes.object,onChange:t.PropTypes.func,onVerificationCheck:t.PropTypes.func},getInitialState:function(){return{submitting:!1,errors:{}}},render:function(){return g({title:y("Update '%(email)s'").format({email:this.props.user.email}),className:"change-email-modal",acceptButtonText:y("Update email"),dismissButtonText:y("Cancel"),onAccept:this.handleSubmit,submitting:this.state.submitting,ref:"modal"},b.form({action:"/account/change_email",className:"change-email-form",onSubmit:this.handleSubmit,onKeyDown:this.handleKey,ref:"form"},b.div({},this.getPrompt()),b.div({className:"change-email-inputs"},a.text({name:"email",label:y("New email",{comment:"'email' refers to the email address"}),error:this.state.errors.email,autoComplete:"off"}),a.text({name:"confirm_email",label:y("Confirm email",{comment:"'email' refers to the email address"}),error:this.state.errors.confirm_email,autoComplete:"off"}),a.password({name:"password",label:y("Dropbox password"),error:this.state.errors.password,autoComplete:"off"}),b.input({type:"hidden",name:p.UID_PARAM_NAME,value:this.props.user.id}))))},handleKey:function(e){var t;return 13===e.keyCode&&"INPUT"===(null!=(t=e.target)?t.tagName:void 0)?this.handleSubmit(e):void 0},handleSubmit:function(e){return e.preventDefault(),this.state.submitting?void 0:this.submit()},submit:function(){var t;return this.setState({submitting:!0,errors:{}}),t=e(this.refs.form.getDOMNode()),o.submit(t,this._success,this._error,this._complete)},_success:function(t){var n,i,o,s,r,a;return r=this.refs.modal,s=this.refs.form,o=e(s.getDOMNode()).find('input[name="email"]').val(),a="NEEDS_VERIFICATION"===t,r.close(),a?"function"==typeof(n=this.props).onVerificationCheck?n.onVerificationCheck(o):void 0:"function"==typeof(i=this.props).onChange?i.onChange(o):void 0},_error:function(e){return"string"==typeof e?n.error(e):e?this.setState({errors:e}):n.error()},_complete:function(){return this.isMounted()?this.setState({submitting:!1}):void 0},getPrompt:function(){var e,t,n;return e=u.get_viewer().is_paired,n=this.props.user.email_verified,t=[],e&&this.props.user.role===p.ROLE_PERSONAL?(t.push(y("Enter a new email address for your personal Dropbox.")),n&&t.push(y("You’ll need to verify your new email address in order to finish updating your personal email."))):e&&this.props.user.role===p.ROLE_WORK?(t.push(y("Enter a new email address for your %(team)s Dropbox.").format({team:u.get_viewer().team_name})),n&&t.push(y("You’ll need to verify your new email address in order to finish updating your %(team)s email.").format({team:u.get_viewer().team_name}))):n&&t.push(y("You’ll need to verify your new email address in order to finish updating your email.")),t.length?w(t):""}}),m=t.createClass({propTypes:{name:t.PropTypes.string.isRequired,type:t.PropTypes.string.isRequired,address:t.PropTypes.string,verified:t.PropTypes.bool,doChangeAddress:t.PropTypes.func,doMakePrimary:t.PropTypes.func,doCreateAlias:t.PropTypes.func,doDeleteAlias:t.PropTypes.func},render:function(){var e;return e=this.props.verified?"address verified":"address pending",b.div({className:"email-row bs-row clearfix clear","data-type":this.props.type},b.span({className:"type"},this.props.name),null!=this.props.address?b.span({className:e},this.props.address):void 0,null!=this.props.address?r({targetButton:b.button({className:"sprite-button"},c({group:"web",name:"gear",alt:y("Options")})),arrow_position:"top-right",ref:"dropdown"},b.div({className:"list-menu list-menu-hover"},this.props.verified?void 0:b.div({className:"list-item",onClick:function(e){return function(){return e.refs.dropdown.hide(),n.info(y("Sending verification email...")),s.send_verification_email(e.props.user,e.props.email,"generic",function(){return n.success(y("Verification email sent to %(email)s").format({email:e.props.address}))})}}(this)},y("Resend verification")),"primary"===this.props.type?b.div({className:"list-item",onClick:this.props.doChangeAddress},y("Change email address")):(b.div({className:"list-item",onClick:this.props.doMakePrimary},y("Make primary",{comment:"Make [this email address] primary"})),b.div({className:"list-item",onClick:function(e){return function(){return e.props.doDeleteAlias(e.props.address)}}(this)},y("Delete email",{comment:"'email' refers to the email address"}))))):b.a({className:"address prompt",onClick:this.props.doCreateAlias},y("Add %(type_of_email)s email",{comment:"'email' refers to the email address"}).format({type_of_email:this.props.name.toLowerCase()})))}}),h=t.createClass({propTypes:{user:t.PropTypes.object,onSuccess:t.PropTypes.func},getInitialState:function(){return{submitting:!1,errors:{}}},render:function(){return g({title:y("Add recovery email"),className:"change-email-modal",acceptButtonText:y("Add recovery email"),onAccept:this.handleSubmit,submitting:this.state.submitting,ref:"modal"},b.form({action:"/account/alias/add/recovery_email",className:"change-email-form",onSubmit:this.handleSubmit,onKeyDown:this.handleKey,ref:"form"},b.div({},y("If you request a password reset, we’ll send a link to both your primary and recovery emails.")),b.div({className:"change-email-inputs"},a.text({name:"email_alias",label:y("New email"),error:this.state.errors.email_alias,autoComplete:"off",onChange:function(e){return function(t){return e.newAddress=t.target.value}}(this)}),a.password({name:"password",label:y("Dropbox password"),error:this.state.errors.password,autoComplete:"off"}),b.input({type:"hidden",name:p.UID_PARAM_NAME,value:this.props.user.id}))))},handleKey:function(e){var t;return 13===e.keyCode&&"INPUT"===(null!=(t=e.target)?t.tagName:void 0)?this.handleSubmit(e):void 0},handleSubmit:function(e){return e.preventDefault(),this.state.submitting?void 0:this.submit()},submit:function(){var t;return this.setState({submitting:!0,errors:{}}),t=e(this.refs.form.getDOMNode()),o.submit(t,this._success,this._error,this._complete)},_success:function(e){var t,i,o,s;return o=this.refs.modal,i=this.refs.form,t=this.newAddress,s="ok:NEEDS_VERIFICATION"===e,s&&n.success(y("Please check your email to verify your recovery email.")),o.close(),this.props.onSuccess(t,!s)},_error:function(e){return"string"==typeof e?n.error(e):e?this.setState({errors:e}):n.error()},_complete:function(){return this.isMounted()?this.setState({submitting:!1}):void 0},getPrompt:function(){var e,t,n;return e=u.get_viewer().is_paired,n=this.props.user.email_verified,t=[],e&&this.props.user.role===p.ROLE_PERSONAL?(t.push(y("Enter a new email address for your personal Dropbox.")),n&&t.push(y("You'll need to verify your new email address in order to finish updating your personal email."))):e&&this.props.user.role===p.ROLE_WORK?(t.push(y("Enter a new email address for your %(team)s Dropbox.").format({team:u.get_viewer().team_name})),n&&t.push(y("You'll need to verify your new email address in order to finish updating your %(team)s email.").format({team:u.get_viewer().team_name}))):n&&t.push(y("You'll need to verify your new email address in order to finish updating your email.")),t.length?w(t):""}}),f=t.createClass({propTypes:{initialAliases:t.PropTypes.array,user:t.PropTypes.object,onAliasChange:t.PropTypes.func,startChangePrimaryFlow:t.PropTypes.func},getInitialState:function(){return{aliases:this.props.initialAliases}},deleteAlias:function(e){return new d.WebRequest({url:"/account/alias/remove",type:"POST",subject_user:this.props.user,data:{alias_type:"recovery_email",alias:e},success:function(t){return function(){var n,i,o;o=t.state.aliases.slice();for(i in o)if(n=o[i],n.alias===e){o.splice(i,1);break}return t.setState({aliases:o}),t.props.onAliasChange(o)}}(this)})},createAlias:function(){return g.showInstance(new h({user:this.props.user,onSuccess:function(e){return function(t,n){var i;return i=e.state.aliases.slice(),i.push({alias:t,type:"recovery_email",verified:n}),e.props.onAliasChange(i)}}(this)}))},render:function(){var e;return g({title:y("Change %(role)s emails",{comment:"email refers to an email address"}).format({role:"personal"}),className:"change-email-options-modal",acceptButtonText:y("Close"),ref:"modal"},b.div({className:"email-list-container"},m({user:this.props.user,name:y("Primary",{comment:"Primary email address"}),type:"primary",address:this.props.user.email,verified:this.props.user.is_email_verified,doChangeAddress:function(e){return function(){return e.props.startChangePrimaryFlow()}}(this)}),function(){var t,n,i,o;for(i=this.state.aliases,o=[],t=0,n=i.length;n>t;t++)e=i[t],"recovery_email"===e.type&&o.push(m({user:this.props.user,name:y("Recovery",{comment:"Recovery email address; 'backup'"}),type:"recovery",address:e.alias,verified:e.verified,doDeleteAlias:this.deleteAlias}));return o}.call(this),0===this.state.aliases.length?m({user:this.props.user,name:y("Recovery",{comment:"Recovery email address; 'backup'"}),type:"recovery",doCreateAlias:this.createAlias}):void 0))}}),{ChangeEmailWarningModal:v,ChangeEmailModal:_,ChangeEmailOptionsModal:f,AddRecoveryEmailModal:h}})}).call(this),function(){define("modules/clean/account/email",["jquery","external/react","modules/core/browser","modules/core/notify","modules/core/i18n","modules/core/uri","modules/clean/account/change_email_modals","modules/clean/account/email_verify","modules/clean/account/verify_email_modals","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/viewer","modules/constants/viewer"],function(e,t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v,g,y,b,w,C,E,S,T,A,I;return A=o._,f=r.ChangeEmailModal,v=r.ChangeEmailOptionsModal,g=r.ChangeEmailWarningModal,_=r.AddRecoveryEmailModal,S=l.VerifyEmailModal,E=l.ResendVerifyEmailModal,T=l.VerifyEmailSentModal,w=l.EmailVerifiedModal,y=l.ChangedEmailVerifiedModal,C=c.Modal,b=function(){function e(e){var t;this.role=e,this.user=this.role?d.get_viewer().get_user_by_role(this.role,!0):d.get_viewer().deprecated_first_user_in_the_cookie,this.email_to_verify=null!=(t=this.user)?t.email:void 0,this.verify_for_change=!1}return e.prototype.polling=!1,e.prototype.show_resend=!1,e.shouldUseSimpleUI=!1,e.getForRole=function(t){return this.initalized||(this.legacy=new e(null),this.personal=new e("personal"),this.work=new e("work"),this.initalized=!0),"personal"===t?this.personal:"work"===t?this.work:this.legacy},e.get_for_user=function(e){return this.getForRole(e.role)},e.set_should_use_simple_ui=function(e){return this.shouldUseSimpleUI=e},e.reset=function(){return this.shouldUseSimpleUI=!1,this.initalized=!1},e.prototype.set_email_to_verify=function(e){return this.email_to_verify=e,this.verify_for_change=this.email_to_verify!==this.user.email},e.prototype.send_email=function(e,t){return a.send_verification_email(this.user,this.email_to_verify,e,t)},e.prototype.flash_email_sent_notification=function(){return i.success(A("Verification email sent to %(email)s").format({email:this.email_to_verify}))},e.prototype.ensure_polling=function(e){return a.listen_for_verification(this.user,this.email_to_verify,function(t){return function(){return null!=e?(t.user.is_email_verified=!0,e()):n.reload()}}(this))},e.prototype.email_sent=function(e,t){return this.show_resend=!0,this.show(null,t),this.flash_email_sent_notification(),this.ensure_polling(e)},e.prototype.show=function(e,t){return this.show_resend?this.show_resend_verify_modal(t):this.show_verify_modal(e,t)},e.prototype.show_verify_modal=function(t,n){return null==n&&(n=this.verify_for_change?"change_email":e.REASON),C.showInstance(new S({user:this.user,reason:n,email:this.email_to_verify,onShowChange:function(e){return function(){return m.show(e.user)}}(this),onEmailSent:function(n){return function(){var i;return i=e.get_for_user(n.user),i.email_sent(t)}}(this),shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_resend_verify_modal=function(t){return null==t&&(t=this.verify_for_change?"change_email":e.REASON),C.showInstance(new E({user:this.user,email:this.email_to_verify,reason:t,onShowChange:function(e){return function(){return m.show(e.user)}}(this),onEmailSent:function(t){return function(){var n;return n=e.get_for_user(t.user),n.email_sent()}}(this),shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.verified_or_send_and_show=function(e,t){return this.user.is_email_verified?("function"==typeof t&&t(),!0):(this.send_email(e,function(n){return function(){return n.email_sent(function(){return n.close(),"function"==typeof t?t():void 0},e)}}(this)),!1)},e.prototype.verified_or_show=function(e){return this.user.is_email_verified?!0:(this.show(null,e),!1)},e.prototype.show_sent_modal=function(){return C.showInstance(new T({email:this.email_to_verify,shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_verified_modal=function(){return C.showInstance(new w({reason:e.REASON,email:this.email_to_verify,shouldUseSimpleUI:e.shouldUseSimpleUI}))},e.prototype.show_verified_and_changed_modal=function(){return C.showInstance(new y({user:this.user,email:this.email_to_verify}))},e.prototype.close=function(){return C.close()},e}(),m={inbox_counts:{},set_inbox_counts:function(t){return e.extend(this.inbox_counts,t)},show_options:function(e){var t,n,i,o;return o=e.user_id,t=e.aliases,n=e.on_alias_change,i=d.get_viewer().get_user_by_id(o),i.role===p.ROLE_WORK?m.show(o):C.showInstance(new v({user:i,initialAliases:t,onAliasChange:n,startChangePrimaryFlow:function(){return function(){return m.show(o)}}(this)}))},show:function(e){var t;return t=d.get_viewer().get_user_by_id(e),this._should_show_warning(t)?this._show_warning_modal(t):this._show_change_modal(t)},_should_show_warning:function(e){var t,n,i,o;return n=d.get_viewer().is_paired,o=n&&e.role===p.ROLE_WORK,i=o&&e.sso_required,t=this.inbox_counts[e.id]>0,i||t},_show_change_modal:function(){return function(e){return C.showInstance(new f({user:e,onChange:function(t){return m.trigger_change(e,t),"/account"!==s.parse(n.get_href()).path?n.redirect("/home?send_verification_email=1"):t!==e.email?n.reload():void 0},onVerificationCheck:function(t){var n;return m.trigger_change(e,t,!0),n=b.get_for_user(e),n.set_email_to_verify(t),n.email_sent()}}))}}(this),_show_warning_modal:function(e){return C.showInstance(new g({user:e,inboxCount:this.inbox_counts[e.id],onContinue:function(t){return function(){return t._show_change_modal(e)}}(this)}))},listen_for_change:function(t,n){var i;return i=this._email_change_event_for_user(t),e(document).on(i,n)},trigger_change:function(t,n,i){var o;return o=this._email_change_event_for_user(t),e(document).trigger(o,[n,i])},_email_change_event_for_user:function(e){return"db:email_changed:"+e.id}},I=t.DOM,h=t.createClass({propTypes:{userId:t.PropTypes.number,emailName:t.PropTypes.string,initialPendingEmail:t.PropTypes.string,initialAliases:t.PropTypes.array,showRecoveryEmailsGui:t.PropTypes.bool,showAliasGui:t.PropTypes.bool,showChangeEmail:t.PropTypes.bool},getInitialState:function(){return{pendingEmail:this.props.initialPendingEmail,aliases:void 0!==this.props.initialAliases?this.props.initialAliases:[]}},pendingVerifyLinkClick:function(e){return e.preventDefault(),b.get_for_user(this.user).show(),!1},pendingVerifyCancelClick:function(t){return t.preventDefault(),e.ajax("/cancelpendingemailchange",{type:"POST",success:function(e){return function(){return e.setState({pendingEmail:void 0})}}(this),subject_user:this.user.id}),!1},onAliasChange:function(e){return this.setState({aliases:e})},onUserAddressChange:function(e,t,n){return n?this.setState({pendingEmail:t}):this.forceUpdate()},componentWillMount:function(){return this.user=d.get_viewer().get_user_by_id(this.props.userId),this.props.initialPendingEmail?b.get_for_user(this.user).set_email_to_verify(this.props.initialPendingEmail):void 0},componentDidMount:function(){return m.listen_for_change(this.user,this.onUserAddressChange)},render:function(){var e;return I.div({className:"fieldset user-info"},I.div({},I.h3({},this.props.emailName,this.props.showRecoveryEmailsGui&&this.props.showChangeEmail&&this.user.is_email_verified?I.button({className:"button-as-link inline-change",onClick:function(e){return function(t){return t.preventDefault(),m.show_options({user_id:e.props.userId,aliases:e.state.aliases,on_alias_change:e.onAliasChange}),!1}}(this)},A("Change",{comment:"Change the user's contact methods (primary email, recovery email, maybe phone?)"})):void 0),this.props.showRecoveryEmailsGui?I.h4({className:"email-type-header"},A("Primary",{comment:"Primary email address"})):void 0,I.div({},this.user.email),this.user.is_email_verified?this.props.showChangeEmail?this.props.showRecoveryEmailsGui?void 0:I.button({className:"button-as-link",onClick:function(e){return function(t){return t.preventDefault(),m.show(e.props.userId,e.state.aliases),!1}}(this)},A("Change email")):I.a({href:"/account#work"},A("Contact your team admin to change email")):I.div({},I.button({className:"button-as-link",onClick:function(e){return function(t){return t.preventDefault(),"work"===e.user.role?b.getForRole(p.ROLE_WORK).verified_or_show():b.getForRole(p.ROLE_PERSONAL).verified_or_show(),!1}}(this)},A("Verify email"))),this.props.showAliasGui&&"work"!==this.user.role?I.div({},I.button({className:"button-as-link",onClick:function(){return!1}},A("Other ways to contact you"))):void 0),this.state.pendingEmail?I.div({className:"pending-unverified-email-container"},I.br({}),I.div({}),"work"===this.user.role?I.h3({},A("Pending %(team_name)s email change").format({team_name:d.get_viewer().team_name})):"personal"===this.user.role?I.h3({},A("Pending personal email change")):I.h3({},A("Pending email change")),I.div({className:"pending-unverified-email"},this.state.pendingEmail),I.div({},I.button({className:"button-as-link",onClick:this.pendingVerifyLinkClick},A("Verify email"))),I.div({}),I.button({className:"button-as-link",onClick:this.pendingVerifyCancelClick},A("Cancel"))):void 0,this.props.showRecoveryEmailsGui&&"work"!==this.user.role&&this.user.is_email_verified?I.div({},I.br({}),I.h4({className:"email-type-header"},A("Recovery",{comment:"Recovery email address; 'backup email'"})),function(){var t,n,i,o;if(0!==this.state.aliases.length){for(i=this.state.aliases,o=[],t=0,n=i.length;n>t;t++)e=i[t],"recovery_email"===e.type&&o.push(I.div({},I.span({},e.alias),e.verified?void 0:I.span({},A(" (pending)"))));return o}return I.button({className:"button-as-link",onClick:function(e){return function(t){return t.preventDefault(),C.showInstance(new _({user:e.user,onSuccess:function(t,n){var i;return i=e.state.aliases.slice(),i.push({alias:t,type:"recovery_email",verified:n}),e.setState({aliases:i})}})),!1}}(this)},A("Add a recovery email"))}.call(this)):void 0)}}),{EmailVerification:b,ChangeEmail:m,AccountPageEmailBlock:h}})}.call(this),function(){define("modules/clean/account/email_verify",["jquery","modules/clean/ajax"],function(e,t){var n;return n={_POLLING:{},send_verification_email:function(e,n,i,o){return t.WebRequest({url:"/sendverifyemail",data:{email:n,reason:i},success:function(){return o()},subject_user:e})},check_verification:function(e,n,i,o){return t.AuthenticatedRequest({url:"/isemailverified",data:{email:n},success:function(e){return"ok"===e?i():o()},subject_user:e})},listen_for_verification:function(e,t,n){var i;return i=e.id+":"+t,this._POLLING[i]?void 0:(this._POLLING[i]=!0,this._poll_for_verification(e,t,n))},_poll_for_verification:function(e,t,n){var i;return i=4e3,this.check_verification(e,t,n,function(o){return function(){return setTimeout(function(){return o._poll_for_verification(e,t,n)},i)}}(this))}}})}.call(this),function(){define("modules/clean/account/email_verify_reasons",[],function(){var e;return e={SHARE_FOLDER:"share_folder",CREATE_API_APP:"create_api_app",PUBLIC_FOLDER:"public_folder",GENERIC:"generic",SHMODAL:"shmodal",MOBILE_SHARE_FOLDER:"mobile_share_folder",EMAIL_ALIAS:"email_alias",CAROUSEL:"carousel",CHANGE_EMAIL:"change_email",CAROUSEL_EMAIL_ALIAS:"carousel_email_alias",PROMPT_CAMPAIGN:"prompt_campaign",ADD_COMMENT:"add_comment",SUBSCRIBE_TO_COMMENTS:"subscribe_to_comments",CREATE_FILE_COLLECTOR:"create_file_collector",JOIN_DISCOVERED_TEAM:"join_discovery",NEW_DFB_TEAM_TRY:"new_dfb_team_try",NEW_DFB_TEAM_BUY:"new_dfb_team_buy",GIFT_BUY:"gift_buy",REFER_FRIENDS:"refer_friends"}})}.call(this),function(){define("modules/clean/account/verify_email_modals",["external/react","modules/core/i18n","modules/clean/account/email_verify","modules/clean/account/email_verify_reasons","modules/clean/analytics","modules/clean/react/button","modules/clean/react/modal","modules/clean/viewer","modules/clean/react/react_i18n","modules/constants/viewer"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v,g,y,b;return y=t._,m=o.UserActivityLogger,p=r.Modal,b=e.DOM,h=l.R_,v={getStyle:function(){return this.props.shouldUseSimpleUI?"simple":"default"},renderChangeEmail:function(){return this.props.shouldUseSimpleUI?void 0:b.a({href:"#",className:"change-email-before-verify",onClick:this.showChangeEmail},y("Update email address"))}},f=e.createClass({mixins:[v],propTypes:{user:e.PropTypes.object,reason:e.PropTypes.string,email:e.PropTypes.string,onEmailSent:e.PropTypes.func,onShowChange:e.PropTypes.func,shouldUseSimpleUI:e.PropTypes.bool},render:function(){var e;return e={reason:this.props.reason},m.log("web","email_verify_shown",e),p({title:y("Verify your email address"),className:"verify-email",acceptButtonText:y("Send email"),dismissButtonText:y("Cancel"),onAccept:this.sendEmail,ref:"modal",style:this.getStyle()},b.div({},b.div({},this.getPrompt()),this.renderChangeEmail()))},sendEmail:function(e){return e.preventDefault(),n.send_verification_email(this.props.user,this.props.email,this.props.reason,this.emailSent)},close:function(){return this.refs.modal.close()},emailSent:function(){var e;return this.close(),"function"==typeof(e=this.props).onEmailSent?e.onEmailSent():void 0},showChangeEmail:function(e){var t,n;return n={reason:this.props.reason},m.log("web","email_verify_change_first",n),e.preventDefault(),this.close(),"function"==typeof(t=this.props).onShowChange?t.onShowChange():void 0},getPrompt:function(){var e;switch(this.props.reason){case i.ADD_COMMENT:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can add comments. It’s as simple as clicking the link in the verification email we send to you.");case i.SUBSCRIBE_TO_COMMENTS:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can subscribe. It’s as simple as clicking the link in the verification email we send to you.");case i.SHARE_FOLDER:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to share folders. It’s as simple as clicking the link in the verification email we send to you.");case i.NEW_DFB_TEAM:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to add members to your team. It’s as simple as clicking the link in the verification email we send to you.");case i.SHMODAL:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to share links. It’s as simple as clicking the link in the verification email we send to you.");case i.CREATE_API_APP:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can register an API app. It’s as simple as clicking the link in the verification email we send to you.");case i.PUBLIC_FOLDER:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to enable your Public folder. It’s as simple as clicking the link in the verification email we send to you.");case i.CHANGE_EMAIL:return e=a.get_viewer().is_paired,e&&this.props.user.role===c.ROLE_PERSONAL?h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your personal email. It’s as simple as clicking the link in the verification email we send to you."):e&&this.props.user.role===c.ROLE_WORK?h({email:this.props.email,team:a.get_viewer().team_name},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your %(team)s email. It’s as simple as clicking the link in the verification email we send to you."):h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to finish updating your email. It’s as simple as clicking the link in the verification email we send to you.");case i.CREATE_FILE_COLLECTOR:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> to create file requests. It’s as simple as clicking the link in the verification email we send to you.");case i.GIFT_BUY:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can send gifts to your friends. It’s as simple as clicking the link in the verification email we send to you.");case i.REFER_FRIENDS:return h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can invite friends. It’s as simple as clicking the link in the verification email we send to you.");default:return h({email:this.props.email},"Verify your email address at <strong>%(email)s</strong> to share folders and ensure your account can be recovered.")}}}),_=e.createClass({mixins:[v],propTypes:{user:e.PropTypes.object,email:e.PropTypes.string,reason:e.PropTypes.string,onEmailSent:e.PropTypes.func,onShowChange:e.PropTypes.func,shouldUseSimpleUI:e.PropTypes.bool},render:function(){var e;return e={reason:this.props.reason},m.log("web","email_verify_resend_shown",e),p({title:y("Verify your email address"),buttonComponent:this.renderButtons(),ref:"modal",style:this.getStyle()},b.div({},b.div({},this.getPrompt()),this.renderChangeEmail()))},renderButtons:function(){return b.div({className:"db-modal-buttons"},s.link_button({className:"dbmodal-button",importance:"primary",onClick:this.close},y("Done")),s.link_button({className:"dbmodal-button",importance:"tertiary",onClick:this.sendEmail},y("Resend email")))},close:function(){return this.refs.modal.close()},showChangeEmail:function(e){var t,n;return n={reason:this.props.reason},m.log("web","email_verify_resend_change_first",n),e.preventDefault(),this.close(),"function"==typeof(t=this.props).onShowChange?t.onShowChange():void 0},sendEmail:function(e){return e.preventDefault(),n.send_verification_email(this.props.user,this.props.email,this.props.reason,this.emailSent)},emailSent:function(){var e;return this.close(),"function"==typeof(e=this.props).onEmailSent?e.onEmailSent():void 0},getPrompt:function(){var e;return e=a.get_viewer().is_paired,this.props.reason===i.REFER_FRIENDS?h({email:this.props.email},"Dropbox needs to verify your email address <strong>%(email)s</strong> before you can invite friends. Check your inbox and click the link in the email to verify your address. If you can’t find it, check your spam folder."):this.props.reason!==i.CHANGE_EMAIL?h({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to verify your address. If you can't find it, check your spam folder or click the button to resend the email."):e&&this.props.user.role===c.ROLE_PERSONAL?h({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your personal email. If you can't find it, check your spam folder or click the button to resend the email."):e&&this.props.user.role===c.ROLE_WORK?h({email:this.props.email,team:a.get_viewer().team_name},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your %(team)s email. If you can't find it, check your spam folder or click the button to resend the email."):h({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to finish updating your email. If you can't find it, check your spam folder or click the button to resend the email.")}}),g=e.createClass({propTypes:{email:e.PropTypes.string},render:function(){var e;return e=h({email:this.props.email},"Dropbox has sent a verification email to <strong>%(email)s</strong>. Check your inbox and click on the link in the email to verify your address. If you can't find it, check your spam folder or click the button to resend the email."),p({title:y("Verification email sent!"),acceptButtonText:y("Done")},b.div({},e))}}),d=e.createClass({propTypes:{reason:e.PropTypes.string,email:e.PropTypes.string},render:function(){return p({title:y("Your email address has been verified"),acceptButtonText:y("Done")},b.div({},this.getPrompt()))},getPrompt:function(){switch(this.props.reason){case i.NEW_DFB_TEAM:return h({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Now you can invite members to your team.");case i.SHARE_FOLDER:return h({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Now you can share folders with friends, family, or coworkers.");case i.CREATE_API_APP:return h({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. You can now register API apps.");case i.PUBLIC_FOLDER:return h({email:this.props.email},"Thanks for verifying your email address. You can now enable the Public folder for your <strong>%(email)s</strong> Dropbox.");

}return""}}),u=e.createClass({propTypes:{email:e.PropTypes.string,user:e.PropTypes.object},render:function(){return p({title:y("Your email address has been verified"),acceptButtonText:y("Done")},b.div({},this.getPrompt()))},getPrompt:function(){var e;return e=a.get_viewer().is_paired,e&&this.props.user.role===c.ROLE_PERSONAL?h({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Your personal account has successfully been changed."):e&&this.props.user.role===c.ROLE_WORK?h({email:this.props.email,team:a.get_viewer().team_name},"Thanks for verifying your email address <strong>%(email)s</strong>. Your %(team)s account has successfully been changed."):h({email:this.props.email},"Thanks for verifying your email address <strong>%(email)s</strong>. Your account has successfully been changed.")}}),{VerifyEmailModal:f,ResendVerifyEmailModal:_,VerifyEmailSentModal:g,EmailVerifiedModal:d,ChangedEmailVerifiedModal:u}})}.call(this),function(){define("modules/clean/account_photo_modal/account_header",["jquery"],function(e){var t;return t=function(){function t(){}return t.init=function(t,n,i){return e(t).add(n).on("click",function(e){return e.preventDefault(),require(["modules/clean/account_photo_modal/controller"],function(e){return e.show()})}),e(document).on("db:account_photo:photo_set",function(){return e(n).addClass(i)}),e(document).on("db:account_photo:photo_deleted",function(){return e(n).removeClass(i)})},t}()})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/activity/activity",["external/underscore","modules/clean/activity/activity_user","modules/clean/activity/comment","modules/clean/activity/like","modules/clean/datetime","modules/core/exception"],function(t,n,i,o,s,r){var a,l,c,u,d,p;return c={ADD:0,EDIT:1,POST:2,FILE:3,COMMENT:4,NS_RELATED_EVENT:5},l={SHARED_LINK_VIEW:1,SHARED_LINK_LIGHTBOX:2,BROWSE_FILE_VIEWER:3,BROWSE_LIGHTBOX:4,SONOMA:5,EMAIL_REPLY:6,SHARED_CONTENT_LINK_VIEW:7},p=function(e){return e===c.FILE?d:e===c.COMMENT?u:r.assert(!1,"Invalid activity type")},a=function(){function e(e){var t,i,s,r,a;this.activity_key=e.activity_key,this.activity_type=e.activity_type,this.activity_data=e.activity_data,this.when=e.when,this.feedback_off=e.feedback_off,this.can_edit_feedback=e.can_edit_feedback,this.seen_comment_count=e.seen_comment_count,this.isDeleted=e.isDeleted,i=e.comment_activity_dicts,r=e.like_dicts,a=e.owner,this.owner=new n(a),this.when_mses=1e3*this.when,this.comment_activities=function(){var e,n,o;for(o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(new u(t));return o}(),this.likes=function(){var e,t,n;for(n=[],e=0,t=r.length;t>e;e++)s=r[e],n.push(new o(s));return n}()}return e.prototype.when_pretty=function(){return s.ago(new Date(this.when_mses))},e.prototype.commentCount=function(){return this.comment_activities.length},e.prototype.resolvedCommentCount=function(){return t.filter(this.comment_activities,function(e){return e.comment.resolved}).length},e.prototype.unresolvedCommentCount=function(){return this.commentCount()-this.resolvedCommentCount()},e.prototype.unseenCommentCount=function(){return this.commentCount()-this.seen_comment_count},e.prototype.getPendingCommentActivities=function(){return this.comment_activities.filter(function(e){return null!=e.isPending})},e.prototype._remove_comment_activity=function(e){return this.comment_activities=this.comment_activities.filter(function(t){return t.activity_key!==e.activity_key})},e.prototype.findCommentActivityByKey=function(e){return t.findWhere(this.comment_activities,{activity_key:e})},e.prototype._add_comment_activity=function(e){return t.findWhere(this.comment_activities,{activity_key:e.activity_key})?void 0:this.comment_activities.push(e)},e.prototype._update_like=function(e,t){var n;return n=new o({liker_dict:e,when_mses:Date.now()}),t?this._add_like(n):this._remove_like(n)},e.prototype._remove_like=function(e){return this.likes=this.likes.filter(function(t){return t.liker.id!==e.liker.id})},e.prototype._add_like=function(e){return this.likes.push(e)},e.prototype.isLikedBy=function(e){return this.likes.some(function(t){return t.liker.id===e})},e.prototype._markCommentsSeen=function(e){var n;return n=t.findWhere(this.comment_activities,{activity_key:e}),this.seen_comment_count=1+n},e}(),u=function(t){function n(e){n.__super__.constructor.call(this,e),this.comment=new i(e.comment),this.permissions={user_ids_who_can_delete:e.permissions.user_ids_who_can_delete}}return e(n,t),n}(a),d=function(t){function i(e){var t;i.__super__.constructor.call(this,e),this.ns_path=e.ns_path,this.latestRevision=e.latest_revision,this.file_icon=e.file_icon,this.users_to_notify=function(){var i,o,s,r;for(s=e.users_to_notify||[],r=[],i=0,o=s.length;o>i;i++)t=s[i],r.push(new n(t));return r}()}return e(i,t),i}(a),{ActivityType:c,ActivityContext:l,get_activity_class_by_type:p,Activity:a,CommentActivity:u,FileActivity:d}})}.call(this),function(){define("modules/clean/activity/activity_local_storage",["modules/clean/storage"],function(e){var t,n;return n="tmp-file-comments-",new(t=function(){function t(){}return t.prototype.get_store=function(t,i){var o;return o=e.SessionStorage.get(""+n+t),o&&o.activity_key===i&&(new Date).getTime()-o.time<3e5?o:null},t.prototype.clear_store=function(t){return e.SessionStorage.set(""+n+t,null)},t.prototype.set_store=function(t,i,o){return e.SessionStorage.set(""+n+t,{activity_key:i,comment_activity_key:o,time:(new Date).getTime()})},t}())})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/activity/activity_store",["external/rsvp","modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/file_activity/api","modules/core/exception","modules/core/uri"],function(t,n,i,o,s,r){var a,l,c;return c=t.Promise,a=function(){function e(e,t){this.activity_context=e,this.activity_context_data=t}return e.prototype._activity_type=function(){return r.assert(!1,"Not implemented")},e.prototype._fetch_activity_url=function(){return r.assert(!1,"Not implemented")},e.prototype._comment_url=function(){return r.assert(!1,"Not implemented")},e.prototype._update_like_url=function(){return r.assert(!1,"Not implemented")},e.prototype._update_resolved_url=function(){return r.assert(!1,"Not implemented")},e.prototype._update_subscribe_url=function(){return r.assert(!1,"Not implemented")},e.prototype._update_feedback_setting_url=function(){return r.assert(!1,"Not implemented")},e.prototype._submit_product_feedback_url=function(){return r.assert(!1,"Not implemented")},e.prototype._ajaxRequestMethod=function(e){return e?n.SilentBackgroundRequestOref:n.WebRequestOref},e.prototype.gen_activities=function(e){var t,n,o,s,r;for(t=[],s=0,r=e.length;r>s;s++)o=e[s],n=i.get_activity_class_by_type(this._activity_type()),t.push(new n(o));return t},e.prototype.genActivitiesFromMap=function(e){var t,n,o,s;s={};for(o in e)n=e[o],t=i.get_activity_class_by_type(this._activity_type()),s[o]=new t(n);return s},e.prototype._parse_activity_and_callback=function(e,t){var n,i;return e=JSON.parse(e),i=e.payload,n=this.gen_activities([i]),1===(null!=n?n.length:void 0)&&"function"==typeof t?t(n[0],this.activity_context,this.activity_context_data):void 0},e.prototype.fetch_activity=function(e,t,n,i,o){var s;return s=function(e){return function(n){return e._parse_activity_and_callback(n,t)}}(this),this._ajaxRequestMethod(o)({url:this._fetch_activity_url(),type:"GET",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,activity_type:this._activity_type(),oref:i},success:s,error:n,subject_user:e.id})},e.prototype.fetchActivities=function(e,t,n,i,o){var s;return s=this._ajaxRequestMethod(o)({url:this._fetch_activities_url(),type:"GET",data:{activity_context:t,activity_context_data_batch:JSON.stringify(n),activity_type:this._activity_type(),oref:i},subject_user:e}),c.resolve(s)},e.prototype._parse_activity_and_callback_with_bolt_data=function(e,t){var n,i,o;return e=JSON.parse(e),i=e.payload,n=this.gen_activities([i]),o=e.bolt_data,1===(null!=n?n.length:void 0)&&"function"==typeof t?t(n[0],this.activity_context,this.activity_context_data,o):void 0},e.prototype.fetch_activity_and_bolt_data=function(e,t,n,i,o){var s;return s=function(e){return function(n){return e._parse_activity_and_callback_with_bolt_data(n,t)}}(this),this._ajaxRequestMethod(o)({url:this._fetch_activity_url(),type:"GET",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,activity_type:this._activity_type(),oref:i},success:s,error:n,subject_user:e.id})},e.prototype.add_comment=function(e,t,n,i,o,r,a){var l;return null==i&&(i=null),null==o&&(o=null),l=s.addComment({actorId:t.id,targetActivity:o||e,context:this.activity_context,contextData:this.activity_context_data,text:n,metadata:i}),l.then(function(t){var n,i,s,a;if(null!=o)for(a=e.comment_activities,i=0,s=a.length;s>i;i++)n=a[i],n.activity_key===o.activity_key&&n._add_comment_activity(t);else e._add_comment_activity(t);return"function"==typeof r?r(e):void 0}),l.catch(function(e){return a(e.payload)})},e.prototype.delete_comment=function(e,t,o,s,r){var a;return a=function(t){t=JSON.parse(t),e._remove_comment_activity(new i.CommentActivity(t.payload)),"function"==typeof s&&s(t.payload)},n.WebRequestOref({url:"/file_activity/comment/delete",type:"POST",data:{comment_key:o,activity_context:this.activity_context,activity_context_data:this.activity_context_data},success:a,error:r,subject_user:t.id})},e.prototype.add_like=function(e,t,n,i,o){return this._update_like(e,t,!0,this._update_like_url(),n,i,o)},e.prototype.remove_like=function(e,t,n,i,o){return this._update_like(e,t,!1,this._update_like_url(),n,i,o)},e.prototype.add_comment_like=function(e,t,n,i,o){return this._update_like(e,t,!0,this._update_comment_like_url(),n,i,o)},e.prototype.remove_comment_like=function(e,t,n,i,o){return this._update_like(e,t,!1,this._update_comment_like_url(),n,i,o)},e.prototype._update_like=function(e,t,i,o,s,r,a){var l;return e._update_like(t,i),"function"==typeof s&&s(e),l=function(){return function(n){return e._update_like(t,!i),"function"==typeof s&&s(e),"function"==typeof a?a(n):void 0}}(this),n.WebRequestOref({url:o,type:"POST",data:{activity_key:e.activity_key,activity_context:this.activity_context,activity_context_data:this.activity_context_data,liked:i},success:r,error:l,subject_user:t.id})},e.prototype.update_subscribe=function(e,t,i,o,s,r,a){var l,c,u,d,p,h;return h=o||t,l=function(){return e.users_to_notify.push(h)},u=function(){return e.users_to_notify=e.users_to_notify.filter(function(e){return e.email!==h.email})},i?l():u(),d=function(e){return function(t){return e._parse_activity_and_callback(t,r)}}(this),c=function(e){return function(t){return i?u():l(),e._parse_activity_and_callback(t,a)}}(this),p=null!=o?o.email:void 0,n.WebRequestOref({url:this._update_subscribe_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,subscribed:i,target_user_identifier:p},success:d,error:c,subject_user:t.id}),"function"==typeof s?s(e):void 0},e.prototype.update_feedback_setting=function(e,t,i,o,s,r){var a;return e.feedback_off=i,"function"==typeof o&&o(e),a=function(){return function(t){return e.feedback_off=!i,"function"==typeof o&&o(e),"function"==typeof r?r(t):void 0}}(this),n.WebRequestOref({url:this._update_feedback_setting_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,feedback_off:i},success:s,error:a,subject_user:t.id})},e.prototype.update_resolved=function(e,t,i,o,s){var r;return e.comment.resolved=i,r=function(){return function(t){return e.comment.resolved=!i,"function"==typeof s?s(t):void 0}}(this),n.WebRequestOref({url:this._update_resolved_url(),type:"POST",data:{activity_key:e.activity_key,activity_context:this.activity_context,activity_context_data:this.activity_context_data,resolved:i},success:o,error:r,subject_user:t.id})},e.prototype.mark_comments_seen=function(e,t,i,o,s){return n.SilentBackgroundRequestOref({url:this._mark_comments_seen_url(),type:"POST",data:{last_seen_comment_key:i,activity_context:this.activity_context,activity_context_data:this.activity_context_data},success:function(t){return e._markCommentsSeen(i),"function"==typeof o?o(t):void 0},error:s,subject_user:t.id})},e.prototype.submit_product_feedback=function(e,t,i,o){return n.WebRequestOref({url:this._submit_product_feedback_url(),type:"POST",data:{activity_context:this.activity_context,activity_context_data:this.activity_context_data,feedback_text:t},success:i,error:o,subject_user:e.id})},e}(),l=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype._activity_type=function(){return i.ActivityType.FILE},n.prototype._fetch_activity_url=function(){return"/file_activity/file_activity"},n.prototype._fetch_activities_url=function(){return"/file_activity/file_activity_batch"},n.prototype._comment_url=function(){return"/file_activity/comment"},n.prototype._update_like_url=function(){return"/file_activity/like"},n.prototype._update_comment_like_url=function(){return"/file_activity/comment/like"},n.prototype._update_resolved_url=function(){return"/file_activity/comment/resolve"},n.prototype._update_subscribe_url=function(){return"/file_activity/subscribe"},n.prototype._update_feedback_setting_url=function(){return"/file_activity/feedback_setting"},n.prototype._mark_comments_seen_url=function(){return"/file_activity/mark_comments_seen"},n.prototype._submit_product_feedback_url=function(){return"/file_activity/product_feedback"},n}(a),{ActivityStore:a,FileActivityStore:l}})}.call(this),function(){define("modules/clean/activity/activity_user",["modules/core/user_i18n"],function(e){var t;return t=function(){function t(t){t?(this.id=t.id,this.fname=t.fname,this.lname=t.lname,this.display_name=t.display_name,this.email=t.email,this.photo_url=t.photo_url,this.photo_circle_url=t.photo_circle_url,this.initials=e.getInitials(this.display_name),this.unique_id=t.unique_id,this.is_email_verified=t.is_email_verified,this.is_signed_in=!0):this.is_signed_in=!1}return t.prototype.get_display_identity=function(){return this.display_name?this.display_name:this.email},t}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/activity/comment",["external/react","modules/clean/activity/activity_user","modules/clean/datetime","modules/clean/referrer_cleansing_redirect"],function(t,n,i,o){var s;return s=function(){function s(e){var t,i;this.comment_gid=e.comment_gid,i=e.commenter_dict,this.comment_text=e.comment_text,this.raw_comment_text=e.raw_comment_text,this.when_mses=e.when_mses,this.resolved=e.resolved,this.revision=e.revision,t=e.comment_meta_json,this.commenter=new n(i),this.comment_metadata=null!=t?new r(t):null}var r;return r=function(){function e(e){var t;null!=e.revision&&(this.revision=e.revision),null!=e.annotation&&(this.annotation=e.annotation),null!=e.stickers&&(this.stickerId=e.stickers.id),null!=e.thumbnail_url&&(this.thumbnailUrl=e.thumbnail_url),null!=e.index&&(this.type=e.type,this.index=e.index,this.state=null!=(t=e.state)?t:"present")}return e.prototype.toMetadataDict=function(){var e;return e={},null!=this.revision&&(e.revision=this.revision),null!=this.annotation&&(e.annotation=this.annotation),null!=this.stickerId&&(e.stickers={id:this.stickerId}),null!=this.thumbnailUrl&&(e.thumbnail_url=this.thumbnailUrl),e},e.prototype.has_revision_data=function(){return null!=this.revision},e.prototype.has_annotation_data=function(){return null!=this.annotation},e.prototype.has_pptx_data=function(){return null!=this.index},e.prototype.has_sticker_data=function(){return null!=this.stickerId},e.prototype.get_sticker_id=function(){return null!=this.stickerId?this.stickerId:void 0},e.prototype.as_string=function(){return this._type_as_string(this.type)+" "+this.index},e.prototype._type_as_string=function(e){switch(e){case"slide":return"Slide";default:return console.warn("Unrecognised type: "+e),e}},e.prototype.is_deleted=function(){return"deleted"===this.state?!0:!1},e}(),s.Metadata=r,s.prototype.when_pretty=function(){return i.ago(new Date(this.when_mses))},s.prototype.has_metadata=function(){return null!=this.comment_metadata},s.prototype.get_metadata_as_string=function(){return this.has_metadata()?this.comment_metadata.as_string():""},s.prototype.is_metadata_deleted=function(){return this.has_metadata()&&this.comment_metadata.is_deleted()},s.convertRawCommentTextToHtml=function(n,i,s){var r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E;for(null==i&&(i=!0),null==s&&(s=!1),a=t.DOM,p=/@\[(?:\s*(?:dbid:)?[^:\[\]]+):(?:[^\[]+)\]/i,d=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/i,E="(?:[-a-zA-Z0-9@:%_+~#=]+[.])+[a-z]{2,6}(?:[:./?#][-a-zA-Z0-9@%_+~&=]+)*(?=[^a-zA-Z0-9_]|$)",w="http://"+E+"|https://"+E+"|www."+E+"|"+E,C=new RegExp(w,"i"),u=/\n/,v=[p,u],i&&v.push(C),g=RegExp("("+function(){var e,t,n;for(n=[],e=0,t=v.length;t>e;e++)m=v[e],n.push(m.source);return n}().join("|")+")","gi"),_=[],f=n.split(g),l=0,c=f.length;c>l;l++)r=f[l],r&&(r.match(p)?(y=r.match(d),h=y[2].trim(),h=s?"@"+h:h,_.push(a.span({className:"comment-mention"},h))):e.call(v,C)>=0&&r.match(C)?(b=r,b.indexOf("http://")<0&&b.indexOf("https://")<0&&(b="http://"+b),b=o.get_redirect_uri(b),_.push(a.a({href:b,target:"_blank"},r))):_.push(r.match(u)?a.br({}):r));return _},s}()})}.call(this),function(){define("modules/clean/activity/file_activity_cache",["external/lru","modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/activity_store","modules/clean/promise"],function(e,t,n,i,o){var s,r,a;return r=i.FileActivityStore,a=o.Promise,s=function(){function t(n){null==n&&(n=t.CACHE_SIZE),this._cache=new e(n)}return t.CACHE_SIZE=20,t.ACTIVITY_TYPE=n.ActivityType.FILE,t.FETCH_ACTIVITY_BATCH_URL="/file_activity/file_activity_batch",t.prototype.getActivity=function(e,t){return this._getFromCache(e,t)},t.prototype.setActivity=function(e,t,n){return this._putIntoCache(e,t,n)},t.prototype.fetchActivities=function(e,t,n,i){var o;return o=n.filter(function(e){return function(n){return null==e._findInCache(t,n)}}(this)),o.length>0?(new r).fetchActivities(e,t,o,i,!0).then(this._parseActivities).then(function(e){return function(n){var i,o;for(o in n)i=n[o],e._putIntoCache(t,o,i)}}(this)):a.resolve()},t.prototype._parseActivities=function(e){return e=JSON.parse(e),(new r).genActivitiesFromMap(e)},t.prototype._keyFrom=function(e,t){return e+":"+t},t.prototype._findInCache=function(e,t){return this._cache.find(this._keyFrom(e,t))},t.prototype._getFromCache=function(e,t){return this._cache.get(this._keyFrom(e,t))},t.prototype._putIntoCache=function(e,t,n){this._cache.put(this._keyFrom(e,t),n)},t}()})}.call(this),function(){define("modules/clean/activity/file_viewer_state",["modules/clean/activity/activity","modules/clean/comments/models/preview_types","modules/clean/comments/utils"],function(e,t,n){var i,o;return i=e.ActivityContext,o=function(){function e(e,t,n){null==n&&(n=null),this._file=null,this._url=t,this._fileActivity=null,this._latestRevision=null,this._currentRevision=null,e?(this.setFile(e),this._previewType=e.preview_type):n&&(this._previewType=n)}return e.prototype.setFile=function(e){return this._file=e},e.prototype.setFileActivity=function(e){return this._fileActivity=e,this._latestRevision=this._currentRevision=this._fileActivity.latestRevision},e.prototype.getPreviewType=function(e){return n.getPreviewType(e,this._previewType)},e.prototype.isAnnotationReadyFile=function(e){return null!=this.getPreviewType(e)},e.prototype.isImagePreviewFile=function(e){return this.getPreviewType(e)===t.IMAGE},e.prototype.isCurrentlyAtLatestRevision=function(){return null!=this._latestRevision&&null!=this._currentRevision?this._latestRevision.when===this._currentRevision.when:!1},e.prototype.isCurrentlyAtRevision=function(e){return null!=e&&null!=this._currentRevision?e.when===this._currentRevision.when:!1},e.prototype.isLatestRevision=function(e){return null!=e&&null!=this._latestRevision?e.when===this._latestRevision.when:!1},e.prototype.isOldRevision=function(e){return!this.isLatestRevision(e)},e.prototype.getLatestRevision=function(){return this._latestRevision},e.prototype.getCurrentRevision=function(){return this._currentRevision},e.prototype.setCurrentRevision=function(e){return this._currentRevision=e},e}(),{FileViewerState:o}})}.call(this),function(){define("modules/clean/activity/like",["modules/clean/activity/activity_user","modules/clean/datetime"],function(e,t){var n;return n=function(){function n(t){var n;n=t.liker_dict,this.when_mses=t.when_mses,this.liker=new e(n)}return n.prototype.when_pretty=function(){return t.ago(new Date(this.when_mses))},n}()})}.call(this),function(){define("modules/clean/annotations/annotation",["external/underscore"],function(){var e,t,n;return n={MARKER:0,HIGHLIGHT:1,REGION:2},t={MARKER:{CIRCLE:0},REGION:{RECTANGLE:0},HIGHLIGHT:{HIGHLIGHT:0}},e=function(){function e(e,t,n){null==e&&(e=null),null==t&&(t=null),null==n&&(n=null),this.type=e,this.subtype=t,this.pdf_coordinates=null,this.image_coordinates=null,this.text_highlight=null,this.viewportCoordinates=[],this.BUBBLE_WIDTH=320,this.annotationSize=n}return e.createAnnotationFromDict=function(t){var n,i;return n=new e,n.revision=t.revision,n.zoom=t.zoom,n.type=t.type,n.subtype=t.subtype,n.pdf_coordinates=t.pdf_coordinates,n.image_coordinates=t.image_coordinates,n.text_highlight=t.text_highlight,n.viewportCoordinates=null!=(i=t.viewportCoordinates)?i:[],n.annotationSize=28,n},e.prototype.toMetadataDict=function(){var e;return e={type:this.type,subtype:this.subtype},this.pdf_coordinates?e.pdf_coordinates=this.pdf_coordinates:this.image_coordinates&&(e.image_coordinates=this.image_coordinates),this.type===n.HIGHLIGHT&&(e.text_highlight=this.text_highlight),e},e.getCenterPosition=function(e){return{x:(e.left+e.right)/2,y:(e.top+e.bottom)/2}},e.prototype.getBoundingBox=function(){var e;switch(this.type){case n.MARKER:return e=this.getFirstViewportCoordinates(),{top:e.y-this.annotationSize/2,right:e.x+this.annotationSize/2,bottom:e.y+this.annotationSize/2,left:e.x-this.annotationSize/2};case n.HIGHLIGHT:return this._getViewportBoundingRectangle();case n.REGION:return this._getViewportBoundingRectangle()}},e.prototype.getClampedBoundingBox=function(e,t){var n;return n=this.getBoundingBox(),n.top=Math.min(Math.max(n.top,0),t),n.right=Math.min(Math.max(n.right,0),e),n.bottom=Math.min(Math.max(n.bottom,0),t),n.left=Math.min(Math.max(n.left,0),e),n},e.prototype._getViewportBoundingRectangle=function(){var e,t,n,i,o,s,r,a,l,c,u;for(l=r=this.getFirstViewportCoordinates().x,c=a=this.getFirstViewportCoordinates().y,u=this.viewportCoordinates,n=0,o=u.length;o>n;n++)for(e=u[n],i=0,s=e.length;s>i;i++)t=e[i],l=Math.min(l,t.x),r=Math.max(r,t.x),c=Math.min(c,t.y),a=Math.max(a,t.y);return{top:c,right:r,bottom:a,left:l}},e.prototype.isPdfAnnotation=function(){return null!=this.pdf_coordinates},e.prototype.isImageAnnotation=function(){return null!=this.image_coordinates},e.prototype.getFirstViewportCoordinates=function(){return this.viewportCoordinates[0][0]},e.prototype.getFirstImageCoordinates=function(){var e,t;return null!=(e=this.image_coordinates)&&null!=(t=e[0].coordinates)?t[0]:void 0},e.prototype.getFirstPdfCoordinates=function(){var e;return this.isOldCoordinatesFormat()?this.pdf_coordinates:null!=(e=this.pdf_coordinates[0].coordinates)?e[0]:void 0},e.prototype.getFirstPdfPage=function(){var e;return this.isOldCoordinatesFormat()?null!=(e=this.pdf_coordinates)?e.page:void 0:this.pdf_coordinates[0].page},e.prototype.isOldCoordinatesFormat=function(){return!(null!=this.pdf_coordinates&&null!=this.pdf_coordinates[0])},e.prototype.getSize=function(){return this.type===n.MARKER?this.annotationSize:null},e}(),{Annotation:e,AnnotationTypes:n,AnnotationSubtypes:t}})}.call(this),function(){define("modules/clean/annotations/annotation_controller",["external/react","modules/clean/annotations/annotation","modules/clean/annotations/annotation_marker","modules/clean/annotations/annotation_highlight","modules/clean/annotations/annotation_region","jquery"],function(e,t,n,i,o,s){var r,a,l,c,u,d,p;return a=t.Annotation,u=t.AnnotationTypes,c=t.AnnotationSubtypes,p=e.DOM,d=e.addons.CSSTransitionGroup,r="annotation-container",l=e.createClass({displayName:"AnnotationController",propTypes:{controllerEventHandlers:e.PropTypes.object,onAnnotationPlacedCallback:e.PropTypes.func,onAnnotationHiddenCallback:e.PropTypes.func,onAnnotationStartDragCallback:e.PropTypes.func,onAnnotationEndDragCallback:e.PropTypes.func,onAnnotationScrollCallback:e.PropTypes.func,onAnnotationScaleChangeCallback:e.PropTypes.func,isAnnotationMarkerEnabled:e.PropTypes.bool,isAnnotationHighlightEnabled:e.PropTypes.bool,isAnnotationRegionEnabled:e.PropTypes.bool,isAnnotationCreationEnabled:e.PropTypes.bool,parentContainerOffset:e.PropTypes.object},getInitialState:function(){return{activeAnnotationType:null}},getDefaultProps:function(){return{parentContainerOffset:{left:0,top:0}}},hasVisibleActiveAnnotation:function(){var e;return null!=(e=this.refs.activeAnnotationType)?e.state.isToolVisible:void 0},componentWillMount:function(){return this.allowAnnotationTypeSwitch=!0,this.isMouseDown=!1,this.positionAtLastMouseDown={}},componentDidMount:function(){var e,t,n,i,o,s;return null!=(e=this.props.controllerEventHandlers)&&(e.onHideAnnotation=this.onHideAnnotation),null!=(t=this.props.controllerEventHandlers)&&(t.onMouseMoveCallback=this.onMouseMoveCallback),null!=(n=this.props.controllerEventHandlers)&&(n.onMouseDownCallback=this.onMouseDownCallback),null!=(i=this.props.controllerEventHandlers)&&(i.onMouseUpCallback=this.onMouseUpCallback),null!=(o=this.props.controllerEventHandlers)&&(o.onScrollCallback=this.onScrollCallback),null!=(s=this.props.controllerEventHandlers)?s.onScaleChangeCallback=this.onScaleChangeCallback:void 0},_getViewerX:function(){var e;return(null!=(e=this.state.currentMouseEvent)?e.pageX:void 0)||0},_getViewerY:function(){var e;return(null!=(e=this.state.currentMouseEvent)?e.pageY:void 0)||0},_getEventPosition:function(e){return{x:e.pageX,y:e.pageY}},_allowAnnotationTypeSwitch:function(){return this.allowAnnotationTypeSwitch=!0},_disallowAnnotationTypeSwitch:function(){return this.allowAnnotationTypeSwitch=!1},_trySetActiveAnnotationType:function(e,t){return e!==this.state.activeAnnotationType&&this._isAnnotationTypeCreationEnabled(e)?(this.setState({activeAnnotationType:e},function(){return function(){return"function"==typeof t?t():void 0}}(this)),!0):("function"==typeof t&&t(),!1)},_isOnRegion:function(e){var t,n;return t=null!=(n=this.refs.activeAnnotation)?n.getDOMNode():void 0,null!=t&&(e.target===t||s.contains(t,e.target))},_isAnnotationTypeCreationEnabled:function(e){if(!this.props.isAnnotationCreationEnabled)return!1;switch(e){case u.MARKER:return this.props.isAnnotationMarkerEnabled;case u.HIGHLIGHT:return this.props.isAnnotationHighlightEnabled;case u.REGION:return this.props.isAnnotationRegionEnabled;default:return!1}},_isOnText:function(e){var t,n,i,o,r,a,l,c;if(i=s(e.target),t=i.contents(),n=(null!=(c=i.css("cursor"))?c:"").split(","),n=n[n.length-1].trim(),"text"===n||"vertical-text"===n||i.is("a")&&0===t.length)return!0;if("auto"!==n)return!1;for(r=!1,a=0,l=t.length;l>a;a++)o=t[a],o.nodeType===Node.TEXT_NODE&&(r=!0);return r},_deselectAllText:function(){var e,t;return null!=(t=document.selection)&&"function"==typeof t.empty&&t.empty(),"function"==typeof window.getSelection&&"function"==typeof(e=window.getSelection()).removeAllRanges?e.removeAllRanges():void 0},onHideAnnotation:function(){var e;return null!=(e=this.refs.activeAnnotation)?e.hideAnnotation():void 0},onMouseDownCallback:function(e){var t,n;return this.isMouseDown?void 0:(this.isMouseDown=!0,this.positionAtLastMouseDown={x:e.pageX,y:e.pageY},this.allowAnnotationTypeSwitch?(t=this.state.activeAnnotationType,!this._isOnRegion(e)&&this._isOnText(e)?(t=u.HIGHLIGHT,this._trySetActiveAnnotationType(t,function(t){return function(){var n;return null!=(n=t.refs.activeAnnotation)?n.onMouseDownCallback(e):void 0}}(this))):void 0):null!=(n=this.refs.activeAnnotation)?n.onMouseDownCallback(e):void 0)},onMouseMoveCallback:function(e){var t,n;return this.isMouseDown?(null===this.state.activeAnnotationType&&this._deselectAllText(),this.allowAnnotationTypeSwitch?(t=this.state.activeAnnotationType,this.isMouseDown&&null===t&&(t=u.REGION),this._trySetActiveAnnotationType(t,function(t){return function(){var n;return null!=(n=t.refs.activeAnnotation)?n.onMouseMoveCallback(e):void 0}}(this))):null!=(n=this.refs.activeAnnotation)?n.onMouseMoveCallback(e):void 0):void 0},onMouseUpCallback:function(e){var t,n,i,o,s,r;if(this.isMouseDown){if(this.isMouseDown=!1,this.allowAnnotationTypeSwitch){if(s=this.state.activeAnnotationType,null===s){if(this._isAnnotationTypeCreationEnabled(u.MARKER))s=u.MARKER;else if(this._isAnnotationTypeCreationEnabled(u.REGION))return void this._trySetActiveAnnotationType(u.REGION,function(t){return function(){var n;return null!=(n=t.refs.activeAnnotation)&&"function"==typeof n.createDefaultRegion?n.createDefaultRegion(e):void 0}}(this))}else s===u.REGION&&this._isAnnotationTypeCreationEnabled(u.MARKER)&&(t={x:e.pageX,y:e.pageY},n=t.x-this.positionAtLastMouseDown.x,i=t.y-this.positionAtLastMouseDown.y,o=Math.sqrt(n*n+i*i),34>=o&&(s=u.MARKER));return this._trySetActiveAnnotationType(s,function(t){return function(){var n;return null!=(n=t.refs.activeAnnotation)?n.onMouseUpCallback(e):void 0}}(this))}return null!=(r=this.refs.activeAnnotation)?r.onMouseUpCallback(e):void 0}},onScrollCallback:function(e){var t;return null!=(t=this.refs.activeAnnotation)?t.onScrollCallback(e):void 0},onScaleChangeCallback:function(e){var t;return null!=(t=this.refs.activeAnnotation)?t.onScaleChangeCallback(e):void 0},onAnnotationHiddenCallback:function(){var e;return this.setState({activeAnnotationType:null}),this._allowAnnotationTypeSwitch(),"function"==typeof(e=this.props).onAnnotationHiddenCallback?e.onAnnotationHiddenCallback():void 0},onAnnotationPlacedCallback:function(e){var t;return this._disallowAnnotationTypeSwitch(),"function"==typeof(t=this.props).onAnnotationPlacedCallback?t.onAnnotationPlacedCallback(e):void 0},onAnnotationStartDragCallback:function(e){var t;return"function"==typeof(t=this.props).onAnnotationStartDragCallback?t.onAnnotationStartDragCallback(e):void 0},onAnnotationEndDragCallback:function(e){var t;return"function"==typeof(t=this.props).onAnnotationEndDragCallback?t.onAnnotationEndDragCallback(e):void 0},onAnnotationScrollCallback:function(e){var t;return"function"==typeof(t=this.props).onAnnotationScrollCallback?t.onAnnotationScrollCallback(e):void 0},onAnnotationScaleChangeCallback:function(e){var t;return"function"==typeof(t=this.props).onAnnotationScaleChangeCallback?t.onAnnotationScaleChangeCallback(e):void 0},_renderActiveAnnotation:function(){if(null!=this.state.activeAnnotationType&&this._isAnnotationTypeCreationEnabled(this.state.activeAnnotationType))switch(this.state.activeAnnotationType){case u.MARKER:return e.createElement(n,{ref:"activeAnnotation",parentContainerOffset:this.props.parentContainerOffset,onAnnotationHiddenCallback:this.onAnnotationHiddenCallback,onAnnotationPlacedCallback:this.onAnnotationPlacedCallback,onAnnotationStartDragCallback:this.onAnnotationStartDragCallback,onAnnotationEndDragCallback:this.onAnnotationEndDragCallback,onAnnotationScrollCallback:this.onAnnotationScrollCallback,onAnnotationScaleChangeCallback:this.onAnnotationScaleChangeCallback
});case u.HIGHLIGHT:return e.createElement(i,{ref:"activeAnnotation",parentContainerOffset:this.props.parentContainerOffset,onAnnotationHiddenCallback:this.onAnnotationHiddenCallback,onAnnotationPlacedCallback:this.onAnnotationPlacedCallback,onAnnotationStartDragCallback:this.onAnnotationStartDragCallback,onAnnotationEndDragCallback:this.onAnnotationEndDragCallback,onAnnotationScrollCallback:this.onAnnotationScrollCallback,onAnnotationScaleChangeCallback:this.onAnnotationScaleChangeCallback});case u.REGION:return e.createElement(o,{ref:"activeAnnotation",parentContainerOffset:this.props.parentContainerOffset,onAnnotationHiddenCallback:this.onAnnotationHiddenCallback,onAnnotationPlacedCallback:this.onAnnotationPlacedCallback,onAnnotationStartDragCallback:this.onAnnotationStartDragCallback,onAnnotationEndDragCallback:this.onAnnotationEndDragCallback,onAnnotationScrollCallback:this.onAnnotationScrollCallback,onAnnotationScaleChangeCallback:this.onAnnotationScaleChangeCallback})}return""},render:function(){return p.div({className:""+r},this._renderActiveAnnotation())}})})}.call(this),function(){define("modules/clean/annotations/annotation_highlight",["jquery","external/react","external/underscore","modules/clean/annotations/annotation"],function(e,t,n,i){var o,s,r,a,l;return o=i.Annotation,a=i.AnnotationTypes,r=i.AnnotationSubtypes,l=t.DOM,s=t.createClass({displayName:"AnnotationHighlight",propTypes:{onAnnotationPlacedCallback:t.PropTypes.func,onAnnotationHiddenCallback:t.PropTypes.func,onAnnotationStartDragCallback:t.PropTypes.func,onAnnotationEndDragCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationScrollCallback:t.PropTypes.func,onAnnotationScaleChangeCallback:t.PropTypes.func,parentContainerOffset:t.PropTypes.object},getInitialState:function(){return{isShown:!1}},getDefaultProps:function(){return{parentContainerOffset:{left:0,top:0}}},componentWillMount:function(){return this.type=a.HIGHLIGHT,this.subtype=r.HIGHLIGHT.HIGHLIGHT,this.CONSOLIDATE_RECTANGLE_VERTICAL_BUFFER=8,this.CONSOLIDATE_RECTANGLE_HORIZONTAL_BUFFER=30},hideAnnotation:function(){return this._hideAnnotation()},_updateViewportBoundaries:function(){var e,t,n;return e=window.getSelection(),e.rangeCount>0?(t=this._isBrowserIE()?this._extractViewportClientRectanglesIEHack(e.getRangeAt(0)):this._extractViewportClientRectangles(e.getRangeAt(0)),n=this._consolidateClientRectangles(t),this._setViewportCoordinatesFromRectangles(n)):void 0},_extractViewportClientRectangles:function(e){var t,n,i,o;for(t=[],n=e.endContainer,i=e.endOffset,o=e.cloneRange();n!==e.commonAncestorContainer;)o.setStart(n,0),o.setEnd(n,i),Array.prototype.push.apply(t,o.getClientRects()),i=Array.prototype.indexOf.call(n.parentNode.childNodes,n),n=n.parentNode;return o=e.cloneRange(),o.setEnd(n,i),Array.prototype.push.apply(t,o.getClientRects()),t},_extractViewportClientRectanglesIEHack:function(e){var t,n,i;if("canvasWrapper"===e.startContainer.className&&e.setStart(e.startContainer.nextSibling.children[0].childNodes[0],0),e.startContainer===e.commonAncestorContainer)return e.getClientRects();for(t=[],i=e.cloneRange(),i.setEnd(e.startContainer,e.startContainer.length),Array.prototype.push.apply(t,i.getClientRects()),n=e.startContainer.parentNode.nextSibling;n!==e.endContainer.parentNode;)Array.prototype.push.apply(t,n.getClientRects()),n=n.nextSibling;return i.setStart(e.endContainer,0),i.setEnd(e.endContainer,e.endOffset),Array.prototype.push.apply(t,i.getClientRects()),t},_isBrowserIE:function(){var e,t,n;return n=window.navigator.userAgent,t=n.indexOf("Trident/"),e=n.indexOf("Edge/"),t>0||e>0?!0:!1},_consolidateClientRectangles:function(e){var t,n,i,o,s,r;for(n=[],i=0,o=e.length;o>i;i++)r=e[i],0!==r.width&&0!==r.height&&(n.length>0&&(s=n[n.length-1],this._isWithinConsolidationVerticalBuffer(s,r)&&this._isWithinConsolidationHorizontalBuffer(s,r))?(t=this._calculateBoundingBox(s,r),s.top=t.top,s.right=t.right,s.bottom=t.bottom,s.left=t.left):n.push({top:r.top,right:r.right,bottom:r.bottom,left:r.left}));return n},_isWithinConsolidationVerticalBuffer:function(e,t){return Math.abs(e.top-t.top)<this.CONSOLIDATE_RECTANGLE_VERTICAL_BUFFER&&Math.abs(e.bottom-t.bottom)<this.CONSOLIDATE_RECTANGLE_VERTICAL_BUFFER},_isWithinConsolidationHorizontalBuffer:function(e,t){var n,i,o;return n=this._calculateBoundingBox(e,t),i=n.right-n.left,o=t.width+(e.right-e.left),i-o<this.CONSOLIDATE_RECTANGLE_HORIZONTAL_BUFFER},_calculateBoundingBox:function(e,t){return{top:Math.min(e.top,t.top),right:Math.max(e.right,t.right),bottom:Math.max(e.bottom,t.bottom),left:Math.min(e.left,t.left)}},_setViewportCoordinatesFromRectangles:function(e){var t,n,i,o,s;for(s=[],n=0,i=e.length;i>n;n++)o=e[n],t=[],t.push({x:o.left,y:o.top}),t.push({x:o.right,y:o.bottom}),s.push(t);return this.annotation.viewportCoordinates=s},_getPositionRelativeToParentContainer:function(e){return{x:e.x-this.props.parentContainerOffset.left,y:e.y-this.props.parentContainerOffset.top}},_updateHighlightedText:function(){return this.annotation.text_highlight={snippet_before:this._getTextBeforeHighlight(),text:this._getHighlightedText(),snippet_after:this._getTextAfterHighlight()}},_generateAnnotation:function(){return this.annotation=new o(this.type,this.subtype),this._updateViewportBoundaries(),this._updateHighlightedText()},_hideAnnotation:function(){return this._isBrowserIE()&&this.state.isShown&&this.setState({isShown:!1,viewportCoordinates:null}),this.annotation=null,this.props.onAnnotationHiddenCallback()},_updateViewportCoordinatesFromUI:function(){var t,n,i,o,s,r,a,l;if(this.state.isShown){for(s=[],l=e(".annotation-highlight"),i=0,o=l.length;o>i;i++)r=l[i],n=[],t=e(r),a=t.offset(),n.push({x:a.left,y:a.top}),n.push({x:a.left+t.width(),y:a.top+t.height()}),s.push(n);return this.annotation.viewportCoordinates=s}},_getHighlightedText:function(){var e;return e=window.getSelection().toString().trim(),e=e.replace(/\s+/g," ")},_getTextBeforeHighlight:function(){return""},_getTextAfterHighlight:function(){return""},_isTextSelected:function(){return""!==this._getHighlightedText()},onMouseDownCallback:function(){return{}},onMouseMoveCallback:function(){return{}},onMouseUpCallback:function(){return setTimeout(function(e){return function(){var t,n,i,o,s,r,a,l;if(!e._isTextSelected())return e._hideAnnotation();if(e._generateAnnotation(),e.props.onAnnotationPlacedCallback(e.annotation),e._isBrowserIE()){for(l=[],r=e.annotation.viewportCoordinates,i=0,s=r.length;s>i;i++)t=r[i],n=[],o=e._getPositionRelativeToParentContainer(t[0]),a=e._getPositionRelativeToParentContainer(t[1]),n.push({x:o.x,y:o.y}),n.push({x:a.x,y:a.y}),l.push(n);return e.setState({isShown:!0,viewportCoordinates:l})}}}(this),0)},onScrollCallback:function(){var e;return null!=this.annotation?(this._isBrowserIE()?this._updateViewportCoordinatesFromUI():this._updateViewportBoundaries(),"function"==typeof(e=this.props).onAnnotationScrollCallback?e.onAnnotationScrollCallback(this.annotation):void 0):void 0},onScaleChangeCallback:function(){var e;return null!=this.annotation?(this._updateViewportBoundaries(),"function"==typeof(e=this.props).onAnnotationScaleChangeCallback?e.onAnnotationScaleChangeCallback(this.annotation):void 0):void 0},_onMarkerMouseDown:function(){return{}},_onMarkerMouseOver:function(){return{}},_onMarkerMouseUp:function(){return{}},render:function(){var e,t,n,i,o,s,r;return l.div({className:"annotation-highlight-container",ref:"highlightContainer"},function(){var a,c,u;if(this.state.isShown){for(t=[],u=this.state.viewportCoordinates,a=0,c=u.length;c>a;a++)i=u[a],n=i[0].x,r=i[0].y,o=i[1].x,e=i[1].y,s={left:n,top:r,width:o-n,height:e-r},t.push(l.div({className:"annotation-highlight",style:s}));return t}}.call(this))}})})}.call(this),function(){define("modules/clean/annotations/annotation_highlight_ui",["jquery","external/react","modules/clean/annotations/annotation"],function(e,t,n){var i,o,s,r,a,l;return i=n.Annotation,r=n.AnnotationTypes,s=n.AnnotationSubtypes,l=t.DOM,a=t.addons.classSet,o=t.createClass({displayName:"AnnotationHighlightUI",propTypes:{annotation:t.PropTypes.object,commentActivity:t.PropTypes.object,options:t.PropTypes.shape({isGhostAnnotation:t.PropTypes.bool}),onAnnotationEnterCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationLeaveCallback:t.PropTypes.func,onAnnotationClickCallback:t.PropTypes.func},getInitialState:function(){return{isHover:!1}},componentWillMount:function(){return this.initialViewport=this.props.annotation.viewportCoordinates,this.annotation=i.createAnnotationFromDict(this.props.annotation)},_isGhostAnnotation:function(){return this.props.options.isGhostAnnotation||!1},_onHighlightClick:function(){var e;return"function"==typeof(e=this.props).onAnnotationClickCallback?e.onAnnotationClickCallback({commentActivity:this.props.commentActivity}):void 0},_onHighlightMouseEnter:function(){var e;return this.setState({isHover:!0}),clearTimeout(this.mouseLeaveTimeout),this._updateViewportCoordinates(),"function"==typeof(e=this.props).onAnnotationEnterCallback?e.onAnnotationEnterCallback({annotation:this.annotation,commentActivity:this.props.commentActivity}):void 0},_onHighlightMouseOver:function(){return{}},_onHighlightMouseLeave:function(){var e;return"function"==typeof(e=this.props).onAnnotationLeaveCallback&&e.onAnnotationLeaveCallback({annotation:this.annotation,commentActivity:this.props.commentActivity}),this.mouseLeaveTimeout=setTimeout(function(e){return function(){return e.setState({isHover:!1})}}(this),100)},_updateViewportCoordinates:function(){var t,n,i,o,s,r,a,l;for(t=e(this.refs.highlightContainer.getDOMNode()),a=[],o=t.children(),s=0,r=o.length;r>s;s++)i=o[s],n=[],l=e(i).offset(),n.push({x:l.left,y:l.top}),n.push({x:l.left+e(i).width(),y:l.top+e(i).height()}),a.push(n);return this.annotation.viewportCoordinates=a},render:function(){var e,t,n,i,o,s,r,c,u,d,p,h,_,m;for(n=[],o=null!=(u=this.props.commentActivity)&&null!=(d=u.comment)?d.resolved:void 0,e={"annotation-highlight":!0,"annotation-highlight--ui":!0,"annotation-highlight--resolved":o,"highlight-hover":this.state.isHover,"annotation-highlight--ghost":this._isGhostAnnotation()},p=this.initialViewport,i=0,r=p.length;r>i;i++)c=p[i],s=c[0].x,m=c[0].y,h=c[1].x,t=c[1].y,_={left:s,top:m,width:h-s,height:t-m},n.push(l.div({className:a(e),style:_,onClick:this._onHighlightClick,onMouseEnter:this._onHighlightMouseEnter,onMouseOver:this._onHighlightMouseOver,onMouseLeave:this._onHighlightMouseLeave}));return l.div({className:"annotation-highlight-container",ref:"highlightContainer"},n)}})})}.call(this),function(){define("modules/clean/annotations/annotation_marker",["jquery","external/react","external/underscore","modules/clean/annotations/annotation"],function(e,t,n,i){var o,s,r,a,l,c;return o=i.Annotation,a=i.AnnotationTypes,r=i.AnnotationSubtypes,c=t.DOM,l=t.addons.CSSTransitionGroup,s=t.createClass({displayName:"AnnotationMarker",propTypes:{onAnnotationPlacedCallback:t.PropTypes.func,onAnnotationHiddenCallback:t.PropTypes.func,onAnnotationStartDragCallback:t.PropTypes.func,onAnnotationEndDragCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationScrollCallback:t.PropTypes.func,onAnnotationScaleChangeCallback:t.PropTypes.func,parentContainerOffset:t.PropTypes.object},getInitialState:function(){return this.type=a.MARKER,this.subtype=r.MARKER.CIRCLE,this.size=28,this.isInDragMode=!1,this._resetPositionDelta(),{isToolVisible:!1,viewerX:0,viewerY:0}},getDefaultProps:function(){return{parentContainerOffset:{left:0,top:0}}},componentWillMount:function(){return{}},hideAnnotation:function(){return this._hideAnnotation()},_getSelectionText:function(){var e;return e="",window.getSelection&&(e=window.getSelection().toString()),e},_hasSelectedText:function(){return""!==this._getSelectionText()},_resetPositionDelta:function(){return this.positionDelta={x:0,y:0}},_getOffsetPosition:function(e){var t,n,i,o,s,r,a,l;return t=e.offsetX||(null!=(i=e.nativeEvent)?i.offsetX:void 0)||(null!=(o=e.nativeEvent)&&null!=(s=o.originalEvent)?s.layerX:void 0),n=e.offsetY||(null!=(r=e.nativeEvent)?r.offsetY:void 0)||(null!=(a=e.nativeEvent)&&null!=(l=a.originalEvent)?l.layerY:void 0),{x:t-this.annotation.getSize()/2,y:n-this.annotation.getSize()/2}},_getPositionRelativeToParentContainer:function(e){return{x:e.pageX-this.props.parentContainerOffset.left,y:e.pageY-this.props.parentContainerOffset.top}},_calculateMarkerPos:function(e){var t,n;return n=this._getPositionRelativeToParentContainer(e),t=this.size/2,{x:n.x-t-this.positionDelta.x,y:n.y-t-this.positionDelta.y}},_generateAnnotation:function(e){return this.annotation=new o(this.type,this.subtype,this.size),this._updateViewportCoordinatesFromEvent(e),this.annotation},_updateViewportCoordinatesFromEvent:function(e){var t;return t={x:e.clientX-this.positionDelta.x,y:e.clientY-this.positionDelta.y},this.annotation.viewportCoordinates[0]=[t]},_hideAnnotation:function(e){var t;return this.annotation=null,this.setState({isToolVisible:!1,viewerX:null!=e?e.pageX:void 0,viewerY:null!=e?e.pageY:void 0}),"function"==typeof(t=this.props).onAnnotationHiddenCallback?t.onAnnotationHiddenCallback():void 0},_placeAnnotation:function(e){return this.setState({isToolVisible:!0,viewerX:this._calculateMarkerPos(e).x,viewerY:this._calculateMarkerPos(e).y},function(t){return function(){var n;return t._generateAnnotation(e),"function"==typeof(n=t.props).onAnnotationPlacedCallback?n.onAnnotationPlacedCallback(t.annotation):void 0}}(this))},updateViewportCoordinatesFromMarker:function(){var t,n,i,o,s;return this.state.isToolVisible&&(o=(null!=(s=this.refs.annotationMarker)?s.getDOMNode():void 0)||null,o&&(t=e(o),n=t.offset(),i={x:n.left+this.annotation.getSize()/2,y:n.top+this.annotation.getSize()/2},this.annotation.viewportCoordinates[0]=[i])),null},_startAnnotationDrag:function(e){var t;return e.preventDefault(),this.isInDragMode=!0,this.positionDelta=this._getOffsetPosition(e),this._updateViewportCoordinatesFromEvent(e),"function"==typeof(t=this.props).onAnnotationStartDragCallback?t.onAnnotationStartDragCallback(this.annotation):void 0},_endAnnotationDrag:function(e){var t;return e.preventDefault(),this.isInDragMode=!1,this._updateViewportCoordinatesFromEvent(e),this._resetPositionDelta(),"function"==typeof(t=this.props).onAnnotationEndDragCallback?t.onAnnotationEndDragCallback(this.annotation):void 0},_isOnMarker:function(t){var n,i;return this.state.isToolVisible?(n=(null!=(i=this.refs.annotationMarker)?i.getDOMNode():void 0)||null,null!=n?t.target===n||e.contains(n,t.target):!1):void 0},onMouseDownCallback:function(e){return this.state.isToolVisible&&this._isOnMarker(e)?(this._startAnnotationDrag(e),e.preventDefault()):void 0},onMouseMoveCallback:function(e){return this.isInDragMode&&this.state.isToolVisible?(this.setState({viewerX:this._calculateMarkerPos(e).x,viewerY:this._calculateMarkerPos(e).y}),e.preventDefault()):void 0},onMouseUpCallback:function(e){return this.state.isToolVisible?this.isInDragMode?this._endAnnotationDrag(e):this._hideAnnotation(e):this._hasSelectedText()?void 0:(this._placeAnnotation(e),e.preventDefault())},onScrollCallback:function(){var e;return this.state.isToolVisible?(this.updateViewportCoordinatesFromMarker(),"function"==typeof(e=this.props).onAnnotationScrollCallback?e.onAnnotationScrollCallback(this.annotation):void 0):void 0},onScaleChangeCallback:function(){var e;return this.updateViewportCoordinatesFromMarker(),"function"==typeof(e=this.props).onAnnotationScaleChangeCallback?e.onAnnotationScaleChangeCallback(this.annotation):void 0},_onMarkerMouseDown:function(){return{}},_onMarkerMouseOver:function(){var e;return"function"==typeof(e=this.props).onAnnotationOverCallback?e.onAnnotationOverCallback(this.annotation):void 0},_onMarkerMouseUp:function(){return{}},render:function(){var e;return e=[],this.state.isToolVisible&&(e=[c.div({key:"annotationMarker",ref:"annotationMarker",className:"annotation-marker annotation-marker--blue",onMouseDown:this._onMarkerMouseDown,onMouseUp:this._onMarkerMouseUp,onMouseOver:this._onMarkerMouseOver,style:{left:this.state.viewerX,top:this.state.viewerY}},c.div({className:"annotation-maker-inner"}))]),c.div({className:"annotation-marker-container"},this.state.isToolVisible?e:void 0)}})})}.call(this),function(){define("modules/clean/annotations/annotation_marker_ui",["jquery","external/react","modules/clean/annotations/annotation"],function(e,t,n){var i,o,s,r,a,l;return i=n.Annotation,r=n.AnnotationTypes,s=n.AnnotationSubtypes,l=t.DOM,a=t.addons.classSet,o=t.createClass({displayName:"AnnotationMarkerUI",propTypes:{annotation:t.PropTypes.object,commentActivity:t.PropTypes.object,options:t.PropTypes.shape({isGhostAnnotation:t.PropTypes.bool}),onAnnotationEnterCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationLeaveCallback:t.PropTypes.func,onAnnotationClickCallback:t.PropTypes.func},getInitialState:function(){return{}},getDefaultProps:function(){return{options:{}}},componentWillMount:function(){return this.initialViewport=this.props.annotation.getFirstViewportCoordinates()},_isGhostAnnotation:function(){return this.props.options.isGhostAnnotation||!1},_onMarkerClick:function(){var e;return"function"==typeof(e=this.props).onAnnotationClickCallback?e.onAnnotationClickCallback({commentActivity:this.props.commentActivity}):void 0},_onMarkerMouseEnter:function(){var t,n,i,o;return t=e(null!=(o=this.refs.annotationMarker)?o.getDOMNode():void 0),n=this.props.annotation,null==n.viewportCoordinates&&(n.viewportCoordinates=[]),n.viewportCoordinates[0]=[{x:t.offset().left+n.annotationSize/2,y:t.offset().top+n.annotationSize/2}],"function"==typeof(i=this.props).onAnnotationEnterCallback?i.onAnnotationEnterCallback({annotation:n,commentActivity:this.props.commentActivity}):void 0},_onMarkerMouseOver:function(){return{}},_onMarkerMouseLeave:function(){var e;return"function"==typeof(e=this.props).onAnnotationLeaveCallback?e.onAnnotationLeaveCallback({annotation:this.props.annotation,commentActivity:this.props.commentActivity}):void 0},render:function(){var e,t,n,i;return t=null!=(n=this.props.commentActivity)&&null!=(i=n.comment)?i.resolved:void 0,e={"annotation-marker":!0,"annotation-marker--ui":!0,"annotation-marker--blue":!t,"annotation-marker--resolved":t,"annotation-marker--ghost":this._isGhostAnnotation()},l.div({className:"annotation-marker-container",ref:"markerContainer"},l.div({key:"annotationMarker",ref:"annotationMarker",style:{left:this.initialViewport.x-this.props.annotation.annotationSize/2,top:this.initialViewport.y-this.props.annotation.annotationSize/2},className:a(e),onClick:this._onMarkerClick,onMouseEnter:this._onMarkerMouseEnter,onMouseOver:this._onMarkerMouseOver,onMouseLeave:this._onMarkerMouseLeave},l.div({className:"annotation-maker-inner"})))}})})}.call(this),function(){define("modules/clean/annotations/annotation_region",["jquery","external/react","external/underscore","modules/clean/annotations/annotation"],function(e,t,n,i){var o,s,r,a,l,c,u;return o=i.Annotation,a=i.AnnotationTypes,r=i.AnnotationSubtypes,u=t.DOM,c=t.addons.classSet,l=t.addons.CSSTransitionGroup,s=t.createClass({displayName:"AnnotationRegion",propTypes:{onAnnotationPlacedCallback:t.PropTypes.func,onAnnotationHiddenCallback:t.PropTypes.func,onAnnotationStartDragCallback:t.PropTypes.func,onAnnotationEndDragCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationScrollCallback:t.PropTypes.func,onAnnotationScaleChangeCallback:t.PropTypes.func,parentContainerOffset:t.PropTypes.object},TYPE:a.REGION,SUBTYPE:r.REGION.RECTANGLE,DEFAULT_REGION_SIZE:60,Directions:{TOP:"top",RIGHT:"right",BOTTOM:"bottom",LEFT:"left"},getInitialState:function(){return{isInDragMode:!1,resizeDirections:[],isToolVisible:!1,isInitialCreation:!1,rectangle:{top:0,right:0,bottom:0,left:0},anchorRectangle:{top:0,right:0,bottom:0,left:0},anchorMouse:{x:0,y:0}}},getDefaultProps:function(){return{parentContainerOffset:{left:0,top:0}}},_getPositionRelativeToParentContainer:function(e){return{x:e.pageX-this.props.parentContainerOffset.left,y:e.pageY-this.props.parentContainerOffset.top}},_updateAnnotationFromState:function(){var e,t,n,i;return i=this.state.rectangle.top+this.props.parentContainerOffset.top,n=this.state.rectangle.right+this.props.parentContainerOffset.left,e=this.state.rectangle.bottom+this.props.parentContainerOffset.top,t=this.state.rectangle.left+this.props.parentContainerOffset.left,this.annotation.viewportCoordinates[0]=[{x:t,y:i},{x:t,y:e},{x:n,y:e},{x:n,y:i}]},_isOnRegion:function(t){var n,i;return this.state.isToolVisible&&(n=(null!=(i=this.refs.annotationRegion)?i.getDOMNode():void 0)||null,null!=n)?t.target===n||e.contains(n,t.target):!1},_isInResizingMode:function(){return!n.isEmpty(this.state.resizeDirections)},_isModifying:function(){return this.state.isInDragMode||this._isInResizingMode()},_showNewRectangle:function(e){return this.setState({isInDragMode:!1,resizeDirections:[this.Directions.TOP,this.Directions.LEFT],isToolVisible:!0,isInitialCreation:!0,rectangle:{top:e.y,right:e.x,bottom:e.y,left:e.x},anchorRectangle:{top:e.y,right:e.x,bottom:e.y,left:e.x},anchorMouse:e})},_startDragging:function(e){return this.setState({isInDragMode:!0,resizeDirections:[],anchorRectangle:n.clone(this.state.rectangle),anchorMouse:e})},_startResizing:function(e,t){return this.setState({isInDragMode:!1,resizeDirections:n.clone(t),anchorRectangle:n.clone(this.state.rectangle),anchorMouse:e})},componentWillMount:function(){return this.annotation=new o(this.TYPE,this.SUBTYPE)},hideAnnotation:function(){var e;return this.setState({isToolVisible:!1,isInDragMode:!1,resizeDirections:[]}),"function"==typeof(e=this.props).onAnnotationHiddenCallback?e.onAnnotationHiddenCallback(this.annotation):void 0},getDimensions:function(){return{width:this.state.rectangle.right-this.state.rectangle.left,height:this.state.rectangle.bottom-this.state.rectangle.top}},createDefaultRegion:function(e){var t,n,i,o;return e.preventDefault(),n=this._getPositionRelativeToParentContainer(e),i=n.x,o=n.y,t=this.DEFAULT_REGION_SIZE/2,this.setState({isHovering:!0,isToolVisible:!0,isInDragMode:!1,resizeDirections:[],isInitialCreation:!1,rectangle:{top:o-t,right:i+t,bottom:o+t,left:i-t}},function(e){return function(){var t;return e._updateAnnotationFromState(),"function"==typeof(t=e.props).onAnnotationPlacedCallback?t.onAnnotationPlacedCallback(e.annotation):void 0}}(this))},onMouseDownCallback:function(e){var t,n;return e.preventDefault(),n=this._getPositionRelativeToParentContainer(e),this.state.isToolVisible?this._isOnRegion(e)&&!this._isInResizingMode()?(this._updateAnnotationFromState(),"function"==typeof(t=this.props).onAnnotationStartDragCallback&&t.onAnnotationStartDragCallback(this.annotation),this._startDragging(n)):void 0:this._showNewRectangle(n)},onMouseMoveCallback:function(e){var t,i,o;return e.preventDefault(),this.state.isToolVisible?this._isModifying()?(o=this._getPositionRelativeToParentContainer(e),t={x:o.x-this.state.anchorMouse.x,y:o.y-this.state.anchorMouse.y},i=n.clone(this.state.anchorRectangle),this.state.isInDragMode?i={top:this.state.anchorRectangle.top+t.y,right:this.state.anchorRectangle.right+t.x,bottom:this.state.anchorRectangle.bottom+t.y,left:this.state.anchorRectangle.left+t.x}:this._isInResizingMode()&&(this.state.resizeDirections.indexOf(this.Directions.TOP)>=0?i.top=this.state.anchorRectangle.top+t.y:this.state.resizeDirections.indexOf(this.Directions.BOTTOM)>=0&&(i.bottom=this.state.anchorRectangle.bottom+t.y),this.state.resizeDirections.indexOf(this.Directions.LEFT)>=0?i.left=this.state.anchorRectangle.left+t.x:this.state.resizeDirections.indexOf(this.Directions.RIGHT)>=0&&(i.right=this.state.anchorRectangle.right+t.x)),i={top:Math.min(i.top,i.bottom),right:Math.max(i.left,i.right),bottom:Math.max(i.top,i.bottom),left:Math.min(i.left,i.right)},this.setState({rectangle:i})):void 0:(o=this._getPositionRelativeToParentContainer(e),void this._showNewRectangle(o))},onMouseUpCallback:function(e){var t,n;return e.preventDefault(),this.state.isToolVisible?this._isModifying()?(this._updateAnnotationFromState(),this.state.isInitialCreation?"function"==typeof(t=this.props).onAnnotationPlacedCallback&&t.onAnnotationPlacedCallback(this.annotation):"function"==typeof(n=this.props).onAnnotationEndDragCallback&&n.onAnnotationEndDragCallback(this.annotation),this.setState({isInDragMode:!1,resizeDirections:[],isInitialCreation:!1})):this.hideAnnotation(e):void 0},onScrollCallback:function(){var e;return this.state.isToolVisible?(this._updateAnnotationFromState(),"function"==typeof(e=this.props).onAnnotationScrollCallback?e.onAnnotationScrollCallback(this.annotation):void 0):void 0},onScaleChangeCallback:function(){var e;return this._updateAnnotationFromState(),"function"==typeof(e=this.props).onAnnotationScaleChangeCallback?e.onAnnotationScaleChangeCallback(this.annotation):void 0},_onRegionMouseDown:function(){},_onRegionMouseOver:function(){var e;return"function"==typeof(e=this.props).onAnnotationOverCallback?e.onAnnotationOverCallback(this.annotation):void 0},_onRegionMouseUp:function(){},_onRegionMouseEnter:function(){return this.setState({isHovering:!0})},_onRegionMouseLeave:function(){return this.setState({isHovering:!1})},_onHandleMouseDown:function(e,t){var n,i;return e.preventDefault(),i=this._getPositionRelativeToParentContainer(e),this._updateAnnotationFromState(),"function"==typeof(n=this.props).onAnnotationStartDragCallback&&n.onAnnotationStartDragCallback(this.annotation),this._startResizing(i,t)},_renderSideHandles:function(){var e;return u.div({ref:"side-handle-wrapper",className:"annotation-region-side-handle--wrapper"},function(){var t,i,o,s;for(o=n.values(this.Directions),s=[],t=0,i=o.length;i>t;t++)e=o[t],s.push(function(e){return function(t){return u.div({ref:"side-handle-"+t,className:"annotation-region-side-handle annotation-region-side-handle--"+t,onMouseDown:function(n){return e._onHandleMouseDown(n,[t])}})}}(this)(e));return s}.call(this))},_renderCornerHandles:function(){var e,t,n,i,o,s;for(i=[this.Directions.TOP,this.Directions.BOTTOM],o=[],t=0,n=i.length;n>t;t++)s=i[t],o.push(function(){var t,n,i,o;for(i=[this.Directions.LEFT,this.Directions.RIGHT],o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(function(e){return function(t,n){return u.div({ref:"corner-handle-"+t+"-"+n,className:"annotation-region-corner-handle annotation-region-corner-handle--"+t+"-"+n,onMouseDown:function(i){return e._onHandleMouseDown(i,[t,n])}},u.div({ref:"corner-handle-"+t+"-"+n+"-dot",className:"annotation-region-corner-handle--dot annotation-region-corner-handle--dot--"+t+"-"+n}))}}(this)(s,e));return o}.call(this));return o},render:function(){var e,t;return t=[],this.state.isToolVisible&&(e={"annotation-region":!0,"annotation-region--blue":!0,"is-modifying":this._isModifying(),hover:this.state.isHovering},t=[u.div({key:"annotationRegion",ref:"annotationRegion",className:c(e),onMouseDown:this._onRegionMouseDown,onMouseUp:this._onRegionMouseUp,onMouseOver:this._onRegionMouseOver,onMouseOut:this._onRegionMouseOut,onMouseEnter:this._onRegionMouseEnter,onMouseLeave:this._onRegionMouseLeave,style:{left:this.state.rectangle.left,top:this.state.rectangle.top,width:this.state.rectangle.right-this.state.rectangle.left,height:this.state.rectangle.bottom-this.state.rectangle.top}},this._renderSideHandles(),this._renderCornerHandles())]),u.div({className:"annotation-region-container"},this.state.isToolVisible?t:void 0)}})})}.call(this),function(){define("modules/clean/annotations/annotation_region_ui",["jquery","external/react","modules/clean/annotations/annotation"],function(e,t,n){var i,o,s,r,a,l;return i=n.Annotation,r=n.AnnotationTypes,s=n.AnnotationSubtypes,l=t.DOM,a=t.addons.classSet,o=t.createClass({displayName:"AnnotationRegionUI",propTypes:{annotation:t.PropTypes.object,commentActivity:t.PropTypes.object,options:t.PropTypes.shape({isGhostAnnotation:t.PropTypes.bool}),onAnnotationEnterCallback:t.PropTypes.func,onAnnotationOverCallback:t.PropTypes.func,onAnnotationLeaveCallback:t.PropTypes.func,onAnnotationClickCallback:t.PropTypes.func},getInitialState:function(){return{}},_isGhostAnnotation:function(){return this.props.options.isGhostAnnotation||!1},_onRegionClick:function(){var e;return"function"==typeof(e=this.props).onAnnotationClickCallback?e.onAnnotationClickCallback({annotation:this.props.annotation,commentActivity:this.props.commentActivity}):void 0},_onRegionMouseEnter:function(){var t,n,i,o,s,r,a,l;return t=e(null!=(r=this.refs.annotationRegion)?r.getDOMNode():void 0),n=this.props.annotation,null==n.viewportCoordinates&&(n.viewportCoordinates=[]),l=t.offset().top,s=t.offset().left,o=l+t.height(),a=s+t.width(),n.viewportCoordinates[0]=[{x:s,y:l},{x:s,y:o},{x:a,y:o},{x:a,y:l}],"function"==typeof(i=this.props).onAnnotationEnterCallback?i.onAnnotationEnterCallback({annotation:n,commentActivity:this.props.commentActivity}):void 0},_onRegionMouseOver:function(){return{}},_onRegionMouseLeave:function(){var e;return"function"==typeof(e=this.props).onAnnotationLeaveCallback?e.onAnnotationLeaveCallback({annotation:this.props.annotation,commentActivity:this.props.commentActivity}):void 0},render:function(){var e,t,n,i,o;return t=null!=(i=this.props.commentActivity)&&null!=(o=i.comment)?o.resolved:void 0,n=this.props.annotation.getBoundingBox(),e={"annotation-region":!0,"annotation-region--ui":!0,"annotation-region--blue":!t,"annotation-region--resolved":t,"annotation-region--ui--blue":!t,"annotation-region--ui--resolved":t,"annotation-region--ghost":this._isGhostAnnotation()},l.div({className:"annotation-region-container"},l.div({key:"annotationRegion",ref:"annotationRegion",className:a(e),onClick:this._onRegionClick,onMouseEnter:this._onRegionMouseEnter,onMouseOver:this._onRegionMouseOver,onMouseLeave:this._onRegionMouseLeave,style:{left:n.left,top:n.top,width:n.right-n.left,height:n.bottom-n.top}},l.div({className:"annotation-region-inner"})))}})})}.call(this),function(){define("modules/clean/annotations/preview_image_annotations_toolbar",["external/react","external/underscore","jquery","modules/core/dom","modules/core/i18n","modules/clean/components/title_bubble","modules/clean/keycode","modules/clean/react/sprite"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p;return d=e.addons.classSet,p=e.DOM,u=o._,c=3e3,l=e.createClass({displayName:"PreviewImageAnnotationsToolbar",propTypes:{index:e.PropTypes.number.isRequired,count:e.PropTypes.number.isRequired,zoomPercent:e.PropTypes.number,minimumZoomPercent:e.PropTypes.number,maximumZoomPercent:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func,onFullscreen:e.PropTypes.func,onZoomIn:e.PropTypes.func,onZoomOut:e.PropTypes.func,onZoomOriginalOrFit:e.PropTypes.func},getInitialState:function(){return{isToolbarVisible:!1}},componentWillMount:function(){return window.addEventListener("mousemove",this._onMouseMove),n(document).bind("keydown",this._handleKeyPress)},componentWillUnmount:function(){return window.removeEventListener("mousemove",this._onMouseMove),clearTimeout(this.hideToolbarTimeout),n(document).unbind("keydown",this._handleKeyPress)},_onMouseMove:function(e){return this.state.isToolbarVisible||this.setState({isToolbarVisible:!0}),this.state.isToolbarVisible?(clearTimeout(this.hideToolbarTimeout),this.hideToolbarTimeout=setTimeout(function(t){return function(){return t._maybeHideToolbar(e)}}(this),c)):void 0},_handleKeyPress:function(e){var t,n,o,s;return i.focus_in_input()||i.is_input(e.target)?!0:(s=e.keyCode,s===r.EQUALS||s===r.PLUS_EQUALS_FF||s===r.PLUS_CHROME||s===r.PLUS_EQUALS_FF_GERMAN?("function"==typeof(t=this.props).onZoomIn&&t.onZoomIn(),o=!0):(s===r.MINUS_FF_MAC||s===r.MINUS_FF||s===r.MINUS_CHROME)&&("function"==typeof(n=this.props).onZoomOut&&n.onZoomOut(),o=!0),o&&null!=e.preventDefault&&e.preventDefault(),!o)},_maybeHideToolbar:function(e){return 0===n(e.target).closest(this.refs.previewToolbar.getDOMNode()).length?this.setState({isToolbarVisible:!1
}):void 0},_canFlipPrevious:function(){return this.props.index>0},_canFlipNext:function(){return this.props.index+1<this.props.count},_flipLabelText:function(){return u("%(cur_file_num)s of %(num_total_files)s").format({cur_file_num:this.props.index+1,num_total_files:this.props.count})},_zoomToolTipText:function(){return u(1===this.props.zoomPercent?"Zoom to fit":"View actual size")},_getZoomLabel:function(){return this.props.zoomPercent?u("%(zoom_percent)s%").format({zoom_percent:Math.round(100*this.props.zoomPercent)}):""},_onZoomMouseDown:function(e){return this.isZooming=!0,this._keepZooming(e,400)},_keepZooming:function(e,t){return this.isZooming?(e(),setTimeout(function(t){return function(){return t._keepZooming(e,75)}}(this),t)):void 0},_onZoomMouseUp:function(){return this.isZooming=!1},render:function(){var e,n,i,o;return this.state.isToolbarVisible?(e={"flip-button":!0,"flip-button--next":this._canFlipNext()},n={"flip-button":!0,"flip-button--previous":this._canFlipPrevious()},o={"zoom-out":!0,disabled:null!=this.props.minimumZoomPercent&&this.props.zoomPercent<=this.props.minimumZoomPercent},i={"zoom-in":!0,disabled:null!=this.props.maximumZoomPercent&&this.props.zoomPercent>=this.props.maximumZoomPercent},p.div({className:"preview-toolbar-overlay-container"},p.div({className:"preview-toolbar-overlay",ref:"previewToolbar"},p.div({className:"preview-toolbar-content"},this.props.count>1&&null!=this.props.onPrevious&&null!=this.props.onNext?p.span({className:"flip-buttons"},p.div({className:d(n),onClick:this.props.onPrevious},a({group:"web",name:"s_flip_left",alt:u("Previous")})),p.div({className:"flip-label"},this._flipLabelText()),p.div({className:d(e),onClick:this.props.onNext},a({group:"web",name:"s_flip_right",alt:u("Next")}))):void 0,null!=this.props.onZoomOut||null!=this.props.onZoomIn?p.span({className:"flip-buttons"},null!=this.props.onZoomOut?p.div({className:d(o),onMouseDown:t.partial(this._onZoomMouseDown,this.props.onZoomOut),onMouseUp:this._onZoomMouseUp},a({group:"web",name:"zoomout",alt:u("Zoom Out")})):void 0,null!=this.props.onZoomOriginalOrFit?s({text:this._zoomToolTipText(),direction:"north"},p.div({ref:"zoomLabel",className:"zoom-label",onClick:this.props.onZoomOriginalOrFit},this._getZoomLabel())):void 0,null!=this.props.onZoomIn?p.div({className:d(i),onMouseDown:t.partial(this._onZoomMouseDown,this.props.onZoomIn),onMouseUp:this._onZoomMouseUp},a({group:"web",name:"zoom",alt:u("Zoom In")})):void 0):void 0,null!=this.props.onFullscreen?p.div({className:"fullscreen",onClick:this.props.onFullscreen},a({group:"web",name:"fullscreen",alt:u("Fullscreen")}),p.span({className:"fullscreen-label"},u("Fullscreen"))):void 0)))):!1}})})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/api_v2/client",["jquery","external/underscore","modules/clean/api_v2/error","modules/clean/promise","modules/constants/env","modules/constants/request","modules/core/cookies","modules/core/notify","modules/core/uri"],function(t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m;return u=i.ApiError,h=o.Promise,m=s.WEBSERVER,p=r.JS_CSRF_COOKIE,d=function(){function e(){}return e.prototype.rpc=function(e,n,i){var o;return null==i&&(i=null),o=a.read(p)||"",new h(function(s,r){return t.ajax({type:"POST",url:c({scheme:"https",authority:m,path:"/2/"+n}).toString(),contentType:"application/json",headers:{"X-Dropbox-Subject-User":e,"X-CSRF-Token":o},data:JSON.stringify(i),noDropboxDefaults:!0}).done(function(e,t,n){return s(null!=n.responseText?JSON.parse(n.responseText):null)}).fail(function(e){return r(u.parseResponse(e.status,e.getAllResponseHeaders(),e.responseText))})})},e}(),_=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.rpc=function(e,t,i){var o;return null==i&&(i=null),o=n.__super__.rpc.apply(this,arguments),o.catch(function(e){return l.error(e.message?e.message:l.DEFAULT_ERROR),h.reject(e)})},n}(d),{ApiV2Client:d,UserActionClient:_}})}.call(this),function(){define("modules/clean/avatar/avatar_with_default",["external/react","modules/clean/avatar/photo_avatar","modules/clean/avatar/size","modules/clean/css"],function(e,t,n,i){var o,s,r,a;return r=n.VALID_AVATAR_DIMENSIONS,a=e.DOM,s=e.createFactory(t),o=e.createClass({displayName:"AvatarWithDefault",propTypes:{dimension:e.PropTypes.oneOf(r).isRequired,defaultAvatar:e.PropTypes.element.isRequired,onPhotoClick:e.PropTypes.func,photoUrl:e.PropTypes.string,optionalClass:e.PropTypes.string,shape:e.PropTypes.oneOf(["CIRCLE","SQUARE"]).isRequired},getDefaultProps:function(){return{shape:"CIRCLE"}},componentDidMount:function(){return i.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css")},render:function(){return null!=this.props.photoUrl?s({dimension:this.props.dimension,onClick:this.props.onPhotoClick,photoUrl:this.props.photoUrl,optionalClass:this.props.optionalClass,shape:this.props.shape}):this.props.defaultAvatar}})})}.call(this),function(){define("modules/clean/avatar/contact_avatar",["external/react","modules/core/user_i18n","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/size","modules/clean/contacts/data","modules/clean/contacts/types"],function(e,t,n,i,o,s,r){var a,l,c,u,d;return a=o.AVATAR_DIMENSION_BY_SIZE,u=o.VALID_AVATAR_DIMENSIONS,l=s.Contact,d=e.createElement,c=e.createClass({displayName:"ContactAvatar",propTypes:{dimension:e.PropTypes.oneOf(u).isRequired,contact:e.PropTypes.instanceOf(l).isRequired,optionalClass:e.PropTypes.string},render:function(){var e,o,s,l,c,u;return o=this.props.contact,l=o.name||o.email,c=o.photo_url,o.type===r.FB&&(c="https://graph.facebook.com/"+o.fb_id+"/picture"),s="",this.props.dimension!==a.XSMALL&&(s=t.getInitials(l)),u="CIRCLE",o.type===r.NEW_STYLE_GROUP&&(u="SQUARE"),e={dimension:this.props.dimension,photoUrl:c,optionalClass:this.props.optionalClass,defaultAvatar:d(i,{dimension:this.props.dimension,name:l,initials:s,shape:u,optionalClass:this.props.optionalClass})},d(n,e)}})})}.call(this),function(){define("modules/clean/avatar/faceholder",["external/react","modules/clean/avatar/size","modules/clean/avatar/style","modules/clean/css","modules/clean/react/image","modules/clean/static_urls"],function(e,t,n,i,o,s){var r,a,l,c,u;return a=t.VALID_AVATAR_DIMENSIONS,c=n.getClassName,u=s.static_url,l=e.DOM,r=e.createClass({displayName:"Faceholder",propTypes:{dimension:e.PropTypes.oneOf(a).isRequired,onClick:e.PropTypes.func,optionalClass:e.PropTypes.string},statics:{SRC_MAP:{16:u("/static/images/avatar/faceholder-16-vflzvFMED.png"),24:u("/static/images/avatar/faceholder-24-vflpqFBTK.png"),32:u("/static/images/avatar/faceholder-32-vflKWtuU5.png"),48:u("/static/images/avatar/faceholder-48-vfll8Voom.png"),64:u("/static/images/avatar/faceholder-64-vflHTEplh.png")},SRC_HI_RES_MAP:{16:u("/static/images/avatar/faceholder-16@2x-vflBZ7FgU.png"),24:u("/static/images/avatar/faceholder-24@2x-vflVegRLu.png"),32:u("/static/images/avatar/faceholder-32@2x-vflYmh947.png"),48:u("/static/images/avatar/faceholder-48@2x-vflUglZDR.png"),64:u("/static/images/avatar/faceholder-64@2x-vfl8eFSM8.png")}},componentDidMount:function(){return i.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css")},render:function(){var t;return t=["c-avatar--circle"],this.props.optionalClass&&t.push(this.props.optionalClass),l.div({className:c(this.props.dimension,t),onClick:this.props.onClick},e.createElement(o,{src:r.SRC_MAP[this.props.dimension],srcHiRes:r.SRC_HI_RES_MAP[this.props.dimension]}))}})})}.call(this),function(){define("modules/clean/avatar/initials_avatar",["external/react","modules/clean/avatar/size","modules/clean/avatar/style","modules/clean/css"],function(e,t,n,i){var o,s,r,a;return s=t.VALID_AVATAR_DIMENSIONS,a=n.getClassName,r=e.DOM,o=e.createClass({displayName:"InitialsAvatar",propTypes:{dimension:e.PropTypes.oneOf(s).isRequired,initials:e.PropTypes.string.isRequired,shape:e.PropTypes.oneOf(["CIRCLE","SQUARE"]).isRequired,color:e.PropTypes.string,onClick:e.PropTypes.func,optionalClass:e.PropTypes.string},componentDidMount:function(){return i.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css")},render:function(){var e;return e=["c-avatar--no-img","c-avatar--"+this.props.shape.toLowerCase()],null!=this.props.optionalClass&&e.push(this.props.optionalClass),r.div({className:a(this.props.dimension,e),onClick:this.props.onClick,style:this.getContainerStyle()},this.props.initials)},getContainerStyle:function(){var e;return e={},this.props.color&&(e.color=this.props.color),e}})})}.call(this),function(){define("modules/clean/avatar/initials_avatar_with_color",["jquery","external/react","modules/clean/avatar/initials_avatar","modules/clean/avatar/style"],function(e,t,n,i){var o,s,r;return r=i.hsl_color_value_for_avatar_name,s=t.createElement,o=t.createClass({displayName:"InitialsAvatarWithColorDerivedFromName",propTypes:{name:t.PropTypes.string.isRequired},render:function(){var t;return t=e.extend({color:r(this.props.name)},this.props),delete t.name,s(n,t)}})})}.call(this),function(){define("modules/clean/avatar/list",["external/react","modules/clean/avatar/overflow_count_pill","modules/clean/avatar/size","modules/core/i18n"],function(e,t,n,i){var o,s,r,a,l;return s=n.VALID_AVATAR_DIMENSIONS,r=i._,a=e.createElement,l=e.DOM,o=e.createClass({displayName:"HorizontalAvatarList",propTypes:{avatars:e.PropTypes.array.isRequired,avatarDimension:e.PropTypes.oneOf(s).isRequired,maxVisible:e.PropTypes.number.isRequired,undisplayableCount:e.PropTypes.number.isRequired,onOverflowCountClick:e.PropTypes.func,animation:e.PropTypes.bool},render:function(){var e,n,i;return e=this.props.avatars,n=this.props.maxVisible,i=0,this.props.undisplayableCount&&(i+=this.props.undisplayableCount),(this.props.undisplayableCount||e.length>n)&&(n--,i+=e.length-n,e=e.slice(0,n)),i&&e.push(a(t,{count:i,dimension:this.props.avatarDimension,key:"overflow_pill:"+i,onClick:this.props.onOverflowCountClick})),l.div({className:this.getClassName()},e)},getClassName:function(){return e.addons.classSet({"horizontal-avatar-list":!0,animation:this.props.animation})}})})}.call(this),function(){define("modules/clean/avatar/overflow_count_pill",["external/react","modules/clean/avatar/size","modules/clean/avatar/style","modules/clean/css"],function(e,t,n,i){var o,s,r,a;return s=t.VALID_AVATAR_DIMENSIONS,a=n.getClassName,r=e.DOM,o=e.createClass({displayName:"OverflowCountPill",propTypes:{dimension:e.PropTypes.oneOf(s).isRequired,count:e.PropTypes.number.isRequired,onClick:e.PropTypes.func},componentDidMount:function(){return i.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css")},render:function(){return r.div({className:a(this.props.dimension,["overflow-pill c-avatar--meta"]),onClick:this.props.onClick}," +"+this.props.count+" ")}})})}.call(this),function(){define("modules/clean/avatar/photo_avatar",["external/react","modules/clean/avatar/size","modules/clean/avatar/style"],function(e,t,n){var i,o,s,r,a;return o=t.VALID_AVATAR_DIMENSIONS,r=n.dynamicInlineStyle,a=n.getClassName,s=e.DOM,i=e.createClass({displayName:"PhotoAvatar",propTypes:{dimension:e.PropTypes.oneOf(o).isRequired,photoUrl:e.PropTypes.string.isRequired,onClick:e.PropTypes.func,optionalClass:e.PropTypes.string,shape:e.PropTypes.oneOf(["CIRCLE","SQUARE"])},getDefaultProps:function(){return{shape:"CIRCLE"}},render:function(){var e;return e=["c-avatar--"+this.props.shape.toLowerCase()],null!=this.props.optionalClass&&e.push(this.props.optionalClass),s.div({className:a(this.props.dimension,e),onClick:this.props.onClick},s.img({src:this.props.photoUrl,width:this.props.dimension,height:this.props.dimension,alt:""}))}})})}.call(this),function(){define("modules/clean/avatar/shared_link_avatar",["external/react","modules/clean/avatar/size","modules/clean/avatar/style","modules/clean/css","modules/clean/static_urls","modules/core/i18n"],function(e,t,n,i,o,s){var r,a,l,c,u,d;return a=t.VALID_AVATAR_DIMENSIONS,u=n.getClassName,d=o.static_url,l=s._,c=e.DOM,r=e.createClass({displayName:"SharedLinkAvatar",propTypes:{dimension:e.PropTypes.oneOf(a).isRequired,onClick:e.PropTypes.func},componentDidMount:function(){return i.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css")},render:function(){return c.div({className:u(this.props.dimension,["c-avatar--meta"]),onClick:this.props.onClick,"aria-role":"button"},c.img({src:d("/static/images/avatar/shared-link-icon-vflHCU_m6.svg"),alt:l("Shared link"),width:12}))}})})}.call(this),function(){define("modules/clean/avatar/size",[],function(){var e,t,n;return e={XSMALL:16,SMALL:24,MEDIUM:32,LARGE:48,XLARGE:64},t=function(){var t;t=[];for(n in e)t.push(e[n]);return t}(),{AVATAR_DIMENSION_BY_SIZE:e,VALID_AVATAR_DIMENSIONS:t}})}.call(this),function(){define("modules/clean/avatar/style",["external/react"],function(e){var t,n,i;return t={16:"c-avatar--xs",24:"c-avatar--s",32:"c-avatar--m",48:"c-avatar--l",64:"c-avatar--xl"},i=function(e){var t,n;for(t=5381*e.length,n=0;n<e.length;)t=e.charCodeAt(n)+((t<<6)+(t<<16)-t),n++;return t=Math.abs(t),"hsl("+t%360+", 60%, 53%)"},n=function(n,i){var o;return null==n&&(n=32),null==i&&(i=[]),o=["c-avatar",t[n]],i=i.concat(o),e.addons.classSet.apply(this,i)},{hsl_color_value_for_avatar_name:i,getClassName:n}})}.call(this),function(){define("modules/clean/avatar/viewer_avatar",["jquery","external/react","modules/clean/avatar/photo_avatar","modules/clean/avatar/size","modules/clean/css","modules/core/uri"],function(e,t,n,i,o,s){var r,a,l,c,u;return a=i.VALID_AVATAR_DIMENSIONS,c=t.createElement,u=t.DOM,r=t.createFactory(n),l=t.createClass({displayName:"ViewerAvatar",propTypes:{dimension:t.PropTypes.oneOf(a).isRequired,defaultAvatar:t.PropTypes.element.isRequired,onPhotoClick:t.PropTypes.func,photoUrl:t.PropTypes.string,optionalClass:t.PropTypes.string},getInitialState:function(){return{photoUrl:this.props.photoUrl}},componentDidMount:function(){return o.require_css("/static/css/scooter/scooter-scoped-vfl9_ndV7.css"),e(document).on("db:account_photo:photo_set",function(e){return function(t,n){var i,o,r;return i=2*e.props.dimension,r=i+"x"+i,o=s.parse(n.saved_photo_url).updateQuery({size:r}).toString(),e.setState({photoUrl:o})}}(this)),e(document).on("db:account_photo:photo_deleted",function(e){return function(){return e.setState({photoUrl:null})}}(this))},render:function(){return null!=this.state.photoUrl?r({dimension:this.props.dimension,onClick:this.props.onPhotoClick,photoUrl:this.state.photoUrl,optionalClass:this.props.optionalClass}):this.props.defaultAvatar}})})}.call(this),function(){define("modules/clean/average_counter",["external/underscore"],function(e){var t;return t=function(){function t(){this.average=0,this.count=0}return t.prototype.getAverage=function(){return this.average},t.prototype.add=function(e){return this.average=(this.average*this.count+e)/(this.count+1),this.count++},t.prototype.addArray=function(t){var n,i;return n=e.reduce(t,function(e,t){return e+t}),i=this.count+t.length,this.average=(this.average*this.count+n)/i,this.count=i},t}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/bolt",["jquery","external/underscore","modules/clean/base64","modules/constants/env","modules/core/exception","modules/core/uri"],function(n,i,o,s,r){var a,l,c,u,d,p,h,_,m,f,v;return a=1e3,l=3e5,h="/notify/subscribe",_="/payloads/subscribe",d=function(){function e(e,t){this.app_id=e,this.unique_id=t}return e}(),f=function(){function e(e,t,n,i){this.app_id=e,this.unique_id=t,this.revision=n,this.token=i}return e}(),m=function(){function e(e,t){this.revision=e,this.payload=t}return e}(),p=function(){function e(e,t){this.channel_state=e,this.payloads=t}return e}(),c=function(){function t(t,n,i){this._update_callback=n,this._refresh_callback=i,this._handle_poll_error=e(this._handle_poll_error,this),this._handle_poll_success=e(this._handle_poll_success,this),this._must_find_state=e(this._must_find_state,this),this._long_poll=e(this._long_poll,this),this._find_state=e(this._find_state,this),this._signed_channel_states=[],this._started=!1,this._backoff_window=a,this._additional_headers={},this.update_states(t)}return t.prototype._encode_channel_state=function(e){return{channel_id:{app_id:o.encode(e.app_id),unique_id:o.encode(e.unique_id)},revision:e.revision,token:e.token}},t.prototype._decode_channel_state=function(e){return new f(o.decode(e.channel_id.app_id),o.decode(e.channel_id.unique_id),e.revision,e.token)},t.prototype._decode_channel_id=function(e){return new d(o.decode(e.app_id),o.decode(e.unique_id))},t.prototype._compare_revisions=function(e,t){var n,i,o;return n=Math.max(e.length,t.length),i=Array(n-e.length+1).join("0")+e,o=Array(n-t.length+1).join("0")+t,o>i?-1:i>o?1:0},t.prototype._find_state=function(e){return i.find(this._signed_channel_states,function(t){return i.isEqual(e,t.channel_id)})},t.prototype.update_states=function(e){var t,n,i,o,s;for(s=[],t=0,n=e.length;n>t;t++)o=e[t],o=this._encode_channel_state(o),i=this._find_state(o.channel_id),null==i?s.push(this._signed_channel_states.push(o)):this._compare_revisions(o.revision,i.revision)>0?(i.revision=o.revision,s.push(i.token=o.token)):s.push(void 0);return s},t.prototype.start=function(){return this._started?void 0:(this._started=!0,this._long_poll())},t.prototype.unsubscribe=function(){return this._started=!1,null!=this._long_poll_xhr?this._long_poll_xhr.abort():void 0},t.prototype._long_poll=function(){return this._long_poll_xhr=n.ajax({url:this._subscribe_url(),type:"POST",noDropboxDefaults:!0,data:JSON.stringify({channel_states:this._signed_channel_states}),contentType:"application/json; charset=utf-8",headers:this._additional_headers,dataType:"json",timeout:12e4,success:this._handle_poll_success,error:this._handle_poll_error,xhrFields:{withCredentials:!0}})},t.prototype._must_find_state=function(e){var t,n;return n=this._find_state(e),null==n&&(t="Bolt returned unknown channel id "+e,r.assert(!1,t,null,null,!1)),n},t.prototype._handle_poll_data=function(){var e;return e="Method must be implemented.",r.assert(!1,e,null,null,!1)},t.prototype._subscribe_url=function(){return"https://"+s.BOLT_SERVER+this._subscribe_endpoint()},t.prototype._subscribe_endpoint=function(){var e;return e="Method must be implemented.",r.assert(!1,e,null,null,!1)},t.prototype._handle_poll_success=function(e,t,n){var o,s,r;return this._long_poll_xhr=null,this._started?(r=this._handle_poll_data(e,t,n),r.length>0&&i.defer(this._update_callback,r),(null!=(s=e.invalid_channels)?s.length:void 0)>0?void i.defer(this._refresh_callback,function(){var t,n,i,s;for(i=e.invalid_channels,s=[],t=0,n=i.length;n>t;t++)o=i[t],s.push(this._decode_channel_id(o));return s}.call(this)):(this._backoff_window=a,i.defer(this._long_poll))):void 0},t.prototype._handle_poll_error=function(){var e;return this._long_poll_xhr=null,this._started?(e=Math.random()*this._backoff_window,this._backoff_window=Math.min(2*this._backoff_window,l),window.setTimeout(this._long_poll,e)):void 0},t}(),u=function(n){function i(t,n,o){this._handle_poll_data=e(this._handle_poll_data,this),i.__super__.constructor.call(this,t,n,o)}return t(i,n),i.prototype._subscribe_endpoint=function(){return h},i.prototype._handle_poll_data=function(e){var t,n,i,o,s,r;if(r=[],null!=e.channel_states)for(s=e.channel_states,t=0,n=s.length;n>t;t++)o=s[t],i=this._must_find_state(o.channel_id),this._compare_revisions(o.revision,i.revision)>0&&(i.revision=o.revision,i.token=o.token,r.push(this._decode_channel_state(o)));return r},i}(c),v=function(n){function i(t,n,o){this._handle_poll_data=e(this._handle_poll_data,this),i.__super__.constructor.call(this,t,n,o)}var s;return t(i,n),s="X-Bolt-Session",i.prototype.unsubscribe=function(){return this._additional_headers[s]=null,i.__super__.unsubscribe.call(this)},i.prototype._subscribe_endpoint=function(){return _},i.prototype._handle_poll_data=function(e,t,n){var i,r,a,l,c,u,d,h,_,f,v,g,y;if(y=[],this._additional_headers={},this._additional_headers[s]=n.getResponseHeader(s),null!=e.channel_payloads)for(v=e.channel_payloads,a=0,c=v.length;c>a;a++){for(i=v[a],h=i.channel_state,d=this._must_find_state(h.channel_id),r=this._decode_channel_state(i.channel_state),f=[],g=i.payloads,l=0,u=g.length;u>l;l++)_=g[l],this._compare_revisions(_.revision,d.revision)>0&&f.push(new m(_.revision,o.decode(_.payload)));f.length>0&&y.push(new p(r,f)),this._compare_revisions(h.revision,d.revision)>0&&(d.revision=h.revision,d.token=h.token)}return y},i}(c),{BoltClient:u,ThunderClient:v,ChannelId:d,SignedChannelState:f,Payload:m,ChannelPayloads:p}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/browse/browse_drag_utils",["jquery"],function(t){var n;return n={_dragEnabledChecks:[],getDraggedLink:function(n){var i,o,s,r,a,l,c,u;if(null==n)return null;if(a=e.call(n.types,"Files")>=0,i=e.call(n.types,"text/html")>=0&&t(n.getData("text/html")).attr("draggable")||e.call(n.types,"text/uri-list")>=0&&"about:blank"===n.getData("text/uri-list")||e.call(n.types,"Url")>=0&&"about:blank"===n.getData("Url"),a||i)return null;u=null;try{l=n.getData("text/x-moz-url")}catch(e){o=e}if(null!=l&&(c=l.split("\n"),c.length>=1&&(u=c[0])),!u)try{u=n.getData("text/uri-list")}catch(e){o=e}if(!u)try{u=n.getData("Url")}catch(e){}return u||(u=null),u},buildUrlLinkfileContents:function(e){return"[InternetShortcut]\r\nURL="+e+"\r\n"},isFileDragEnabled:function(){var e,t,n,i;for(i=this._dragEnabledChecks,t=0,n=i.length;n>t;t++)if(e=i[t],!e())return!1;return!0},addFileDragEnabledCheck:function(e){return this._dragEnabledChecks.push(e)},removeFileDragEnabledCheck:function(e){var t;return t=this._dragEnabledChecks.indexOf(e),t>=0?this._dragEnabledChecks.splice(t,1):void 0},removeAllFileDragEnabledChecks:function(){return this._dragEnabledChecks=[]}}})}.call(this),function(){define("modules/clean/browse_events",[],function(){var e;return e={RENDER:"db:browse:render",BEFORE_UPDATE:"db:browse:before_update",UPDATE:"db:browse:update",NEW_PAGE:"db:browse:new_page",UPDATE_RENDERED:"db:browse:update_rendered",GA_RENDERED:"db:browse:ga_rendered"}})}.call(this),function(){define("modules/clean/browse_interface",["modules/clean/viewer","modules/constants/env","modules/constants/viewer","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o){var s,r,a,l,c,u,d;return c=t.WEBSERVER,l=n.ROLE_PERSONAL,d=i._,r="/home",u="/work",a="/personal",s={HOME_ROOT:r,WORK_ROOT:u,PERSONAL_ROOT:a,get_browse_root:function(t){return e.get_viewer().is_paired?t.role===l?a:u:r},get_browse_root_name:function(t){return e.get_viewer().is_paired?e.get_root_name(t):d("Files")},get_all_browse_roots:function(){return e.get_viewer().get_users().map(function(e){return{name:s.get_browse_root_name(e),path:s.get_browse_root(e)}})},browse_uri_for_fq_path:function(e,t){return o({scheme:"https",authority:c,path:""+s.get_browse_root(e)+t})}}})}.call(this),function(){define("modules/clean/clipboard",["jquery","modules/clean/static_urls","modules/core/dom","external/swfobject"],function(e,t,n){var i,o,s,r,a,l;return l=t.static_url,s=function(){var e,t;return e=(new Date).getTime(),t=Math.floor(1e6*Math.random()).toString().lpad(6),"swf_"+e+"_"+t},r=function(e,t){return e.on("mouseover",function(){return t.addClass("hovered")}),e.on("mousedown",function(){return t.addClass("pressed")}),e.on("mouseout",function(){return t.removeClass("hovered pressed")}),e.on("mouseup",function(){return t.removeClass("pressed")})},a=function(e,t){return window.ClipboardSWFRegister=window.ClipboardSWFRegister||{},window.ClipboardSWFRegister[e]=function(){return t()},"ClipboardSWFRegister."+e},i=function(t,i,o,c){var u,d,p;return null==o&&(o=null),null==c&&(c=null),c=c||e(document.body),p=s(),u=e("<div />",{id:"flash_copy_container"}).append(e("<div />",{id:p})).css({position:"absolute",zIndex:1}),r(u,i),c.append(u),n.clone_position(u,i,{}),d=a(p,o),window.copyLoaded=function(){return function(){var n;return n=e("#"+p)[0],n.setCopyText(t),n.setCallbackFunction(d)}}(this),window.swfobject.embedSWF(l("/static/swf/copy_clipboard-vflvMcZTC.swf"),p,"100%","100%","6.0.65",!1,!1,{wmode:"transparent",scale:"exactfit",allowScriptAccess:"always"}),u},o={clipboard_overlay:i}})}.call(this),function(){define("modules/clean/comments/actions",["external/underscore","external/reflux"],function(e,t){return t.createActions(e.object(e.map(["stopViewingComments","showResolvedComments","hideResolvedComments","showAnnotationConversation","hideAnnotationConversation","cancelHideAnnotationConversationDelayed","showAnnotationInput","hideAnnotationInput","startAnnotationCreation","stopAnnotationCreation","notifyPreviewReady","switchRevision","addComment","deleteComment","likeComment","unlikeComment","resolveComment","unresolveComment","markCommentsSeen","enableComment","disableComment","startViewingComments","addAnnotationComment","addStickerComment","postPendingComment","hideAnnotationConversationDelayed","subscribeActivity","unsubscribeActivity","revealAnnotation","receiveFileActivity","notifyAnnotationReplyFocused","notifyAnnotationReplyBlurred"],function(e){return[e,{sync:!0}]})))})}.call(this),function(){define("modules/clean/comments/animations",["jquery"],function(e){var t;return t=function(t,n){var i,o,s;return i=t.activityKey,null==n&&(n=document),o=n.querySelector(".comments-and-feedback .comment-list"),s=o.querySelector(".comment-activity[data-comment-activity-key='"+i+"']"),null!=s?(s.classList.remove("start-highlight-animation"),s.offsetWidth=s.offsetWidth,s.classList.add("start-highlight-animation"),e(o).animate({scrollTop:s.offsetTop},{duration:500}),!0):!1},{highlightComment:t}})}.call(this),function(){define("modules/clean/comments/annotation_utils",["modules/clean/annotations/annotation"],function(e){var t,n,i,o,s,r,a,l,c,u;return s=e.Annotation,n=120,o=320,t=10,i=11,a=30,r=24,u=function(e,t){var n,i,o,s;return n=e.getBoundingBox(),i=window.getComputedStyle(t),s=i.width,o=i.height,n.top>=o||n.left>=s||n.right<0||n.bottom<0},l=function(e,r){var a,l,c,u,d,p,h,_,m,f,v,g,y;return p=window.getComputedStyle(r),y=parseInt(p.width),g=parseInt(p.height),a=r.getBoundingClientRect(),m=a.top+document.body.scrollTop,_=a.left+document.body.scrollLeft,h=function(e,t,i,s){return e>=0&&i-o>e&&t>=0&&s-n>t},f=e.isImageAnnotation()?_:0,v=e.isImageAnnotation()?m:0,d=e.getClampedBoundingBox(y,g),d.left=d.left-f,d.right=d.right-f,d.top=d.top-v,d.bottom=d.bottom-v,u=s.getCenterPosition(d),l=u.x-o/2,c=d.bottom+t,h(l,c,y,g)?["top",{x:l,y:c}]:(l=d.left-o-t,c=d.top-i,h(l,c,y,g)?["right-top",{x:l,y:c}]:(l=d.right+t,c=d.top-i,h(l,c,y,g)?["left-top",{x:l,y:c}]:(l=u.x-o/2,c=d.top-n-t,h(l,c,y,g)?["bottom",{x:l,y:c}]:(l=u.x-o/2,c=u.y+t,h(l,c,y,g)?["top",{x:l,y:c}]:[null,{x:null,y:null}]))))},c=function(e,i,s){var l,c,u;switch(l=0,c=0,u=e,e){case"top":l=(o-a)/2;break;case"left-top":u="left",c=n/8;break;case"right-top":l=o-a,c=n/8,u="right";break;case"bottom":l=(o-a)/2,c=n-r-t}return[u,{x:i+l,y:s+c}]},{isAnnotationOffscreen:u,getBubblePosition:l,getExpandBubblePosition:c}})}.call(this),function(){define("modules/clean/comments/components/file_comments_pane_container",["external/underscore","external/react","external/reflux","modules/core/exception","modules/clean/comments/actions","modules/clean/comments/animations","modules/clean/comments/components/file_preview_annotations","modules/clean/comments/components/file_preview_overlay","modules/clean/comments/events","modules/clean/comments/flux","modules/clean/comments/mutations","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/event_emitter","modules/clean/file_viewer_interface_controller","modules/clean/react/file_comments/file_feedback_ui","modules/clean/react/file_comments/switch_revision_ui"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f){var v,g,y,b,w;return w=i.assert,y=m.FileFeedbackUIClass,v="annotation-overlay",b="switch-revision-container",g=t.createClass({displayName:"FileCommentsPaneContainer",mixins:[c.connect(d)],propTypes:{actorId:t.PropTypes.number,context:t.PropTypes.number,contextData:t.PropTypes.string,currentFile:t.PropTypes.object,oref:t.PropTypes.string,previewSelector:t.PropTypes.string.isRequired,shouldInitiallyFocusInput:t.PropTypes.bool,visible:t.PropTypes.bool,hideToggledCallback:t.PropTypes.func},componentWillMount:function(){return null!=this.props.actorId&&null!=this.props.contextData?this.onViewingFileWillChange(this.props):void 0},componentDidMount:function(){return this.initAnnotationReadyQueue(),l.on("preview-and-comments-ready",this.onPreviewAndCommentsReady),l.on("revision-did-change",this.onViewingRevisionDidChange),l.on("reveal-annotation",this.onRevealAnnotation),l.on("highlight-comment",s.highlightComment)},componentWillReceiveProps:function(e){return null!=this.props.actorId&&this.state.viewing.contextData!==e.contextData?this.onViewingFileWillChange(e):void 0},componentWillUnmount:function(){return l.off("preview-and-comments-ready",this.onPreviewAndCommentsReady),l.off("revision-did-change",this.onViewingRevisionDidChange),l.off("reveal-annotation",this.onRevealAnnotation),l.off("highlight-comment",s.highlightComment),this.clearAnnotationReadyQueue(),this.onViewingFileWillClose()},onViewingFileWillChange:function(e){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),o.startViewingComments({actorId:e.actorId,context:e.context,contextData:e.contextData,oref:e.oref,file:e.currentFile}),this.asyncMountFilePreviewComponents()},onViewingFileWillClose:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.unmountSwitchRevisionUI(),o.stopViewingComments()},onViewingRevisionDidChange:function(){return this.isAnnotationReady=!1,this.renderSwitchRevisionUI(),this.unmountFilePreviewComponents(),this.asyncMountFilePreviewComponents()},onPreviewAndCommentsReady:function(){return this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.mountFilePreviewAnnotations(),this.mountFilePreviewOverlay(),this.isAnnotationReady=!0,this.processAnnotationReadyQueue()},renderSwitchRevisionUI:function(){return t.render(t.createElement(f,{context:this.state.viewing.context,latestRevision:this.state.activity.latestRevision,showSwitchRevisionUI:p.isOldRevision(this.state.viewing.revision,this.state.activity.latestRevision)}),this.getOrCreateSwitchRevisionUIContainer())},unmountSwitchRevisionUI:function(){var e;return e=this.getSwitchRevisionUIContainer(),null!=e?t.unmountComponentAtNode(e):void 0},getSwitchRevisionUIContainer:function(){return document.getElementById(b)},getOrCreateSwitchRevisionUIContainer:function(){var e;return e=this.getSwitchRevisionUIContainer(),null==e&&(e=document.createElement("div"),e.id=b,document.body.appendChild(e)),e},asyncMountFilePreviewComponents:function(){return this.createFileViewerInterfaceController()},unmountFilePreviewComponents:function(){var e;return this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.destroyFileViewerInterfaceController(),"function"==typeof(e=this.state).unsubscribePreviewAndCommentsReady?e.unsubscribePreviewAndCommentsReady():void 0},mountFilePreviewAnnotations:function(){return this.filePreviewAnnotations=r.create(),this.filePreviewAnnotations.mount(this.fileViewerInterfaceController,d)},unmountFilePreviewAnnotations:function(){var e;return(null!=(e=this.filePreviewAnnotations)?e.isMounted():void 0)?this.filePreviewAnnotations.unmount():void 0},getOrCreateFilePreviewOverlayContainer:function(e){var t;return t=document.getElementById(v),t||(t=document.createElement("div"),t.id=v,e.appendChild(t)),t},mountFilePreviewOverlay:function(){var e,n;return(n=document.querySelector(this.props.previewSelector))?(this.overlayContainerNode=this.getOrCreateFilePreviewOverlayContainer(n),
e=t.createElement(a,{previewContainer:n}),t.render(e,this.overlayContainerNode)):void console.error("Preview container does not exist!")},unmountFilePreviewOverlay:function(){return t.unmountComponentAtNode(this.overlayContainerNode)},createFileViewerInterfaceController:function(){var e,t,n;return n=d.state.viewing,e=n.context,t=n.file,this.fileViewerInterfaceController=new _(e,p.getPreviewType(e,t.preview_type),this.props.previewSelector),this.fileViewerInterfaceController.on("page-rendered",function(e){return function(t){var n;return n=null!=(null!=t?t.page:void 0),!n||n&&!e.state.isPreviewReady?o.notifyPreviewReady():void 0}}(this))},destroyFileViewerInterfaceController:function(){var e;return null!=(e=this.fileViewerInterfaceController)?e.destroy():void 0},initAnnotationReadyQueue:function(){return this.annotationReadyQueue=new h},clearAnnotationReadyQueue:function(){return this.annotationReadyQueue.removeAllListeners()},processAnnotationReadyQueue:function(){return this.annotationReadyQueue.emit("reveal-annotation")},onRevealAnnotation:function(t){return this.isAnnotationReady?this.doRevealAnnotation(t):(this.annotationReadyQueue.removeAllListeners("reveal-annotation"),this.annotationReadyQueue.once("reveal-annotation",e.partial(this.doRevealAnnotation,t)))},doRevealAnnotation:function(e){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",e)},render:function(){return t.createElement(y,{feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,userId:this.state.actorId,file:this.props.currentFile,oref:this.state.oref,isPreviewReady:this.state.isPreviewReady,showResolvedComments:this.state.showResolvedComments,canCollapse:!0,enableImport:!1,previewSelector:this.props.previewSelector,shouldAutoLinkify:!0,shouldAutoResize:!0,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldUseSimpleModals:!1,showButtonColor:"white",visible:this.props.visible,hideToggledCallback:this.props.hideToggledCallback})}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/comments/components/file_preview_annotations",["external/underscore","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/string"],function(t,n,i,o,s,r,a,l,c,u){var d,p,h,_,m;return _=i.assert,p=o.Annotation,m=u.lispToPascalCase,d=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui"],h=function(){function i(t){this.prevState=t.prevState,this.state=t.state,this.interfaceController=t.interfaceController,this.onScroll=e(this.onScroll,this),this.onAnnotationUiEnter=e(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=e(this.onAnnotationUiClick,this),this.onPageRendered=e(this.onPageRendered,this),this.onAnnotationEndDrag=e(this.onAnnotationEndDrag,this),this.onAnnotationPlaced=e(this.onAnnotationPlaced,this),this.onStateChange=e(this.onStateChange,this)}return i.create=function(){return new i({prevState:{activityKeys:[],hasEphemeral:!1,isCommentDisabled:!0},state:{ephemeralAnnotation:null,isCommentDisabled:!0,commentActivityByKey:{},canAnnotate:!1},interfaceController:null})},i.prototype.setState=function(e){return t.extend(this.state,e)},i.prototype.reduceStoreState=function(e){var n,i,o,s,r,l;return l=e.showResolvedComments,i=e.activity.feedback_off!==!1,n=i?{}:e.activity.comment_activities.filter(function(e){var t;return e.isDeleted?!1:e.comment.resolved&&!l?!1:null==(null!=(t=e.comment.comment_metadata)?t.annotation:void 0)?!1:!0}),{activityKey:null!=(o=e.activity)?o.activity_key:void 0,actorId:e.actorId,activityContext:e.viewing.context,revision:e.viewing.revision,commentActivityByKey:t.indexBy(n,"activity_key"),ephemeralAnnotation:null!=(s=e.createAnnotation)?s.annotation:void 0,canAnnotate:!i&&a.isLatestRevision(e.viewing.revision,null!=(r=e.activity)?r.latestRevision:void 0)}},i.prototype.onStateChange=function(e){var t;return t=this.reduceStoreState(e),this.setState(t),this.isMounted()?this.performUpdateIfNecessary():void 0},i.prototype.mount=function(e,t){return _(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=e,this.onStateChange(t.state),this.unsubscribeStore=t.listen(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary(),this.canAnnotate?this.enableAnnotationCreation():void 0},i.prototype.unmount=function(){return _(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},i.prototype.isMounted=function(){return null!=this.interfaceController},i.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},i.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},i.prototype.addAnnotationEventListeners=function(){return d.forEach(function(e){return function(t){var n,i;return i="on"+m(t),n=e[i],null!=n?e.interfaceController.on(t,n):void 0}}(this))},i.prototype.removeAnnotationEventListeners=function(){return d.forEach(function(e){return function(t){var n,i;return i="on"+m(t),n=e[i],null!=n?e.interfaceController.off(t,n):void 0}}(this))},i.prototype.onAnnotationHidden=function(){return s.stopAnnotationCreation()},i.prototype.onAnnotationPlaced=function(e){var t;return t=p.createAnnotationFromDict(e.annotation),s.startAnnotationCreation({annotation:t}),c.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=e.annotation?e.annotation:void 0)},i.prototype.onAnnotationStartDrag=function(){return s.hideAnnotationConversation(),s.hideAnnotationInput()},i.prototype.onAnnotationEndDrag=function(e){var t;return s.hideAnnotationConversation(),t=p.createAnnotationFromDict(e.annotation),s.startAnnotationCreation({annotation:t}),c.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=e.annotation?e.annotation:void 0)},i.prototype.onPageRendered=function(e){return null!=(null!=e?e.page:void 0)?this.performUpdateOnPage(e.page):this.performUpdateIfNecessary()},i.prototype.onAnnotationUiClick=function(e){var t,i,o;return i=e.commentActivity.comment.comment_metadata,t=p.createAnnotationFromDict(i.annotation),s.switchRevision({revision:i.revision,commentActivity:e.commentActivity}),r.emit("reveal-annotation",{page:t.getFirstPdfPage(),commentActivity:e.commentActivity}),r.emit("highlight-comment",{activityKey:e.commentActivity.activity_key}),c.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(o=e.commentActivity)?o.activity_key:void 0,this.state.actorId,this.state.activityContext)},i.prototype.onAnnotationUiEnter=function(e){var t;return s.showAnnotationConversation({activityKey:e.commentActivity.activity_key,annotation:p.createAnnotationFromDict(e.annotation)}),c.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(t=e.commentActivity)?t.activity_key:void 0,this.state.actorId,this.state.activityContext)},i.prototype.onAnnotationUiLeave=function(){return s.hideAnnotationConversationDelayed(200)},i.prototype.onScaleChange=function(){return s.stopAnnotationCreation(),s.hideAnnotationConversation()},i.prototype.onScroll=function(e){var t;return s.hideAnnotationInput(),s.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),t=function(e){var t;return null!=e.annotation?(t=p.createAnnotationFromDict(e.annotation),s.startAnnotationCreation({annotation:t})):s.showAnnotationInput()}(e),this.annotationBubbleTimer=window.setTimeout(t,150)},i.prototype.onOnKeydown=function(e){return a.normalizedKeyCode.apply(e)===l.ESC?s.stopAnnotationCreation():void 0},i.prototype.onResetFileFeedbackUi=function(){return s.stopAnnotationCreation(),s.hideAnnotationConversation()},i.prototype._savePrevState=function(){var e;return this.prevState={activityKeys:Object.keys(null!=(e=this.state.commentActivityByKey)?e:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate}},i.prototype._removeAnnotation=function(e){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:e}})},i.prototype._drawAnnotation=function(e){var t,n,i,o,s;return s=this.state.revision,i=e.comment.comment_metadata,t=i.annotation,o=i.revision,n=null!=s&&null!=o?!a.isRevisionEqual(s,o):!1,this.interfaceController.dispatchEvent("draw-annotation",{annotation:e.comment.comment_metadata.annotation,commentActivity:e,options:{isGhostAnnotation:n}})},i.prototype.performUpdateIfNecessary=function(){var e,n;return this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),t.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(e=t.difference(null!=(n=this.prevState.activityKeys)?n:[],Object.keys(this.state.commentActivityByKey)),e.forEach(this._removeAnnotation,this),t.each(this.state.commentActivityByKey,this._drawAnnotation,this)),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this._savePrevState()},i.prototype.performUpdateOnPage=function(e){return this.state.isCommentDisabled?void 0:t.chain(this.state.commentActivityByKey).filter(function(t){var n;return n=p.createAnnotationFromDict(t.comment.comment_metadata.annotation),n.getFirstPdfPage()===e}).each(this._drawAnnotation,this)},i}()})}.call(this),function(){define("modules/clean/comments/components/file_preview_overlay",["external/underscore","external/react","external/reflux","modules/core/exception","modules/clean/activity/file_viewer_state","modules/clean/comments/actions","modules/clean/comments/annotation_utils","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/react/file_comments/annotation_bubble","modules/clean/react/file_comments/annotation_comments_list_ui_bubble"],function(e,t,n,i,o,s,r,a,l,c,u,d){var p,h,_;return h=i.assert,p=o.FileViewerState,_=t.DOM,t.createClass({displayName:"FilePreviewOverlay",mixins:[a.connect(l)],propTypes:{previewContainer:t.PropTypes.instanceOf(HTMLElement).isRequired},onAnnotationConversationBubbleMouseEnter:function(){return s.cancelHideAnnotationConversationDelayed()},onAnnotationCovnersationBubbleMouseLeave:function(){return s.hideAnnotationConversation()},onAnnotationReplyFocus:function(){return s.notifyAnnotationReplyFocused()},onAnnotationReplyBlur:function(){return s.notifyAnnotationReplyBlurred()},maybeRenderAnnotationInputBubble:function(){var n,i,o,s,a,l,d,p;return null!=this.state.createAnnotation&&c.canAnnotate()?(s={context:this.state.viewing.context,activity:this.state.activity,user:c.getActivityUser(this.state.actorId),position:"top",x:0,y:0},this.state.createAnnotation.showBubble&&(n=this.state.createAnnotation.annotation,o=!r.isAnnotationOffscreen(n,this.props.previewContainer),o&&(a=r.getBubblePosition(n,this.props.previewContainer),i=a[0],l=a[1],d=l.x,p=l.y,null!=i&&null!=d&&null!=p))?(e.extend(s,{showBubble:!0,position:i,x:d,y:p}),t.createElement(u,s)):(s.showBubble=!1,t.createElement(u,s))):void 0},maybeRenderAnnotationConversationBubble:function(){var n,i,o,s,a,l,u,p,_,m;return null==this.state.viewAnnotation||(l=this.state.viewAnnotation,o=l.annotation,i=l.activityKey,r.isAnnotationOffscreen(o,this.props.previewContainer)||(u=r.getBubblePosition(o,this.props.previewContainer),a=u[0],p=u[1],_=p.x,m=p.y,null==a||null==_||null==m))?void 0:(n=this.state.activity,s=e.findWhere(n.comment_activities,{activity_key:i}),h(null!=s,"Invalid activity key for currently viewing annotation: "+i),t.createElement(d,{context:this.state.viewing.context,activity:n,commentActivity:s,user:c.getActivityUser(this.state.actorId),onMouseEnter:this.onAnnotationConversationBubbleMouseEnter,onMouseLeave:this.onAnnotationCovnersationBubbleMouseLeave,onReplyInputFocus:this.onAnnotationReplyFocus,onReplyInputBlur:this.onAnnotationReplyBlur,showBubble:!0,isThreadingEnabled:!0,position:a,x:_,y:m}))},render:function(){return _.div({},this.maybeRenderAnnotationInputBubble(),this.maybeRenderAnnotationConversationBubble())}})})}.call(this),function(){define("modules/clean/comments/events",["modules/clean/event_emitter"],function(e){return new e})}.call(this),function(){define("modules/clean/comments/flux",["external/underscore","external/reflux"],function(e,t){var n,i,o;return n=t.ListenerMethods,i=t.ListenerMixin,o=function(t){return{getInitialState:function(){return t.state},componentWillMount:function(){return e.extend(this,n),this.replaceState(t.state),this.listenTo(t,this.replaceState)},componentWillUnmount:i.componentWillUnmount}},{connect:o}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/comments/models/file_activity_cursor",["external/underscore","modules/core/exception","modules/core/types","modules/clean/bolt","modules/clean/event_emitter","modules/clean/file_activity/api","modules/clean/promise","modules/clean/storage"],function(n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v;return v=o.takes,f=o.returns,p=o.Maybe,u=o.Either,h=l.Promise,_=c.SessionStorage,m=function(e,t){return new s.SignedChannelState("file_activity",e.activity_key,t.revision,t.token)},d=function(o){function r(t){this.fileActivity=t.fileActivity,this.boltData=t.boltData,this.actorId=t.actorId,this.context=t.context,this.contextData=t.contextData,this.oref=t.oref,this.isBackgroundRequest=t.isBackgroundRequest,this.boltClient=t.boltClient,this._isLive=t._isLive,this._onBoltRefresh=e(this._onBoltRefresh,this),this._onBoltUpdate=e(this._onBoltUpdate,this),this._restartLiveUpdate=e(this._restartLiveUpdate,this),this._pull=e(this._pull,this),this.pull=e(this.pull,this),this.startLiveUpdate=e(this.startLiveUpdate,this),this.stopLiveUpdate=e(this.stopLiveUpdate,this),r.__super__.constructor.call(this)}return t(r,o),r.fetch=v({actorId:p(Number),context:Number,contextData:String,oref:p(String),isBackgroundRequest:p(Boolean)},f(h,function(e){return _.set("reload-timestamp",(new Date).getTime()),a.fetchFileActivityWithBoltData(e).then(function(t){var i,o;return o=t[0],i=t[1],new r(n.extend({},e,{fileActivity:o,boltData:i,_isLive:!1}))})})),r.prototype.isLive=function(){return this._isLive},r.prototype.getFileActivity=function(){return this.fileActivity},r.prototype.stopLiveUpdate=function(){var e;return null!=(e=this.boltClient)&&e.unsubscribe(),this.boltClient=null,this._isLive=!1},r.prototype.startLiveUpdate=function(){var e;return i.assert(!this._isLive,"Already live updating"),e=m(this.fileActivity,this.boltData),this.boltClient=new s.BoltClient([e],this._onBoltUpdate,this._onBoltRefresh),this.boltClient.start(),this._isLive=!0},r.prototype.pull=function(){return this._pull().then(function(e){return function(){return e._isLive&&e._restartLiveUpdate(),e.fileActivity}}(this))},r.prototype.update=function(e){var t,n;return n=this.fileActivity,t=e(this.fileActivity),this.fileActivity=t,this.emit("updated",t,n),t},r.prototype._pull=function(){return _.set("reload-timestamp",(new Date).getTime()),a.fetchFileActivityWithBoltData({actorId:this.actorId,context:this.context,contextData:this.contextData,oref:this.oref,isBackgroundRequest:this.isBackgroundRequest}).then(function(e){return function(t){var n,i,o;return i=t[0],n=t[1],o=e.fileActivity,e.fileActivity=e.fileActivity.union(i),e.boltData=n,e.emit("updated",e.fileActivity,o)}}(this)).catch(function(e){return function(t){return e.emit("error",t),h.reject(t)}}(this))},r.prototype._restartLiveUpdate=function(){return this.stopLiveUpdate(),this.startLiveUpdate()},r.prototype._onBoltUpdate=function(e){return this._isLive&&1===(null!=e?e.length:void 0)&&e[0].unique_id===this.fileActivity.activity_key?this._pull().then(function(e){return function(){var t;return t=m(e.fileActivity,e.boltData),e.boltClient.update_states([t])}}(this)).catch(this.stopLiveUpdate):void 0},r.prototype._onBoltRefresh=function(){return this._isLive?this._pull().then(this._restartLiveUpdate).catch(this.stopLiveUpdate):void 0},r}(r)})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/comments/models/immutable_file_activity",["external/underscore","modules/core/exception","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/comments/models/immutable_comment_activity","modules/clean/immutability_helper"],function(t,n,i,o,s,r){var a,l,c,u,d,p,h,_,m,f,v,g,y,b;return c=n.assert,a=i.FileActivity,g=r.updateIn,p=r.getIn,v=r.splice,f=r.push,_=r.merge,y=function(e){return t.matcher({activity_key:e})},b=t.compose(t.negate,y),h=function(e){return function(t){var n;return n=t.liker,n.id===e}},m=t.compose(t.negate,h),u=function(e,t,n){var i,o,s,r,a,l,c,u,d,p,h;if(null==n&&(n=!1),(a=y(t))(e))return[];for(d=e.comment_activities,s=o=0,c=d.length;c>o;s=++o){if(i=d[s],a(i))return["comment_activities",s];if(!n)for(p=i.comment_activities,r=l=0,u=p.length;u>l;r=++l)if(h=p[r],a(h))return["comment_activities",s,"comment_activities",r]}return null},d=function(e,t,n){var i;if(i=u(e,t,n),null==i)throw Error("Cannot find activity with the key: "+t);return i},l=function(n){function i(){}return e(i,n),i.fromMutable=function(e){var n;return n=t.create(i.prototype,e),n.comment_activities=n.comment_activities.map(s.fromMutable),n},i.prototype.findActivityByKey=function(e){var t;return t=u(this,e),null!=t?p(this,t):null},i.prototype.purgeActivity=function(e){var n,i;return i=u(this,e),null==i?this:(c(i.length>0,"Cannot purge root activity"),n=i.pop(),g(this,i,t.partial(v,t,[[n,1]])))},i.prototype.updateDeleteActivity=function(e,n){var i;return i=u(this,e),null==i?this:g(this,i,t.partial(_,t,{isDeleted:n}))},i.prototype.appendActivity=function(e,n){var i;return i=d(this,e,!0),i.push("comment_activities"),g(this,i,t.partial(f,t,[n]))},i.prototype.updateResolveActivity=function(e,n){var i;return i=d(this,e),i.push("comment"),g(this,i,t.partial(_,t,{resolved:n}))},i.prototype.updateLikeActivity=function(e,t,n){var i;return i=d(this,e),i.push("likes"),g(this,i,function(e){var i;return t?(i=new o({liker_dict:n,when_mses:Date.now()}),f(e,[i])):e.filter(m(n.id))})},i.prototype.updateActivityStatus=function(e,n){var i;return i=d(this,e),g(this,i,t.partial(_,t,{status:n}))},i.prototype.updateEnableActivity=function(e){return _(this,{feedback_off:!e})},i.prototype.markCommentsSeen=function(e){var n,i;return i=d(this,e),c(i.length>0,"Cannot mark root activity as seen"),n=i.pop(),i.pop(),g(this,i,t.partial(_,t,{seen_comment_count:1+n}))},i.prototype.union=function(e){var n;return n=t.indexBy(e.comment_activities,"activity_key"),this.comment_activities.forEach(function(t){var i,o,s;return null!=t.isPending?e.comment_activities.push(t):(i=null!=n[t.activity_key],o=t.getPendingCommentActivities(),o.length&&null!=i?(s=e.comment_activities).push.apply(s,o):void 0)}),e},i}(a)})}.call(this),function(){define("modules/clean/comments/models/loading_spinner",[],function(){return function(e,t){return null==t||t.comment_activities.length>0?e:!1}})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/comments/models/pending_comment_activity",["external/underscore","modules/clean/activity/activity","modules/clean/activity/comment"],function(t,n,i){var o,s,r;return o=n.ActivityType,s=n.CommentActivity,r=function(n){function s(){}return e(s,n),s.prototype.isPending=!0,s.build=function(e){var n,r,a,l,c;return n=e.activityUser,c=e.text,l=e.metadata,l=null!=l?l:{},r=t.extend(Object.create(i.prototype),{commenter:n,raw_comment_text:c,resolved:!1,when_mses:(new Date).getTime(),comment_metadata:new i.Metadata(l)}),a=t.extend(new s,{activity_key:t.uniqueId("pending-activity-"),status:"PENDING",activity_type:o.COMMENT,comment_activities:[],feedback_off:!1,likes:[],owner:n,comment:r})},s}(s)})}.call(this),function(){define("modules/clean/comments/models/preview_types",[],function(){return{PDFJS:0,IMAGE:1}})}.call(this),function(){define("modules/clean/comments/revisions",["external/underscore"],function(e){var t;return t=function(t,n){var i;return i=e.clone(t),i.direct_blockserver_link=n.direct_blockserver_link,null!=i.thumbnail_url_tmpl&&(i.thumbnail_url_tmpl=n.direct_blockserver_link),i.sjid=null,i},{getFileWithRevision:t}})}.call(this),function(){define("modules/clean/comments/store",["external/underscore","external/react","external/reflux","external/lru","modules/constants/legacy","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/annotations/annotation","modules/clean/bolt","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/promise","modules/clean/storage","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/models/file_activity_cursor","modules/clean/comments/models/immutable_file_activity","modules/clean/comments/models/loading_spinner","modules/clean/comments/models/pending_comment_activity","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/react/file_viewer/actions","modules/clean/react/file_comments/logger"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T){var A,I,k,P,N,R,x,O,L,D,M;return O=s.assert,x=r._,I=l.CommentActivity,A=c.Annotation,k=d.EmailVerification,N=h.Promise,R=_.SessionStorage,M=t.addons.update,L=e.partial,P=10,D=function(e,t,n){return e=null!=e?e:"",e+":"+t+":"+n},n.createStore({listenables:e.pick(m,"startViewingComments","stopViewingComments","showResolvedComments","hideResolvedComments","notifyPreviewReady","showAnnotationConversation","hideAnnotationConversation","showAnnotationInput","hideAnnotationInput","startAnnotationCreation","stopAnnotationCreation","hideAnnotationConversationDelayed","cancelHideAnnotationConversationDelayed","switchRevision","revealAnnotation","receiveFileActivity","notifyAnnotationReplyFocused","notifyAnnotationReplyBlurred"),init:function(){return this.state=this.getInitialState()},getInitialState:function(){var e;return e={actorId:null,viewing:{context:null,contextData:null,revision:null,file:null},activity:null,showLoadingSpinner:!0,oref:null,showResolvedComments:!1,isPreviewReady:!1,annotationReplyFocused:!1,viewAnnotation:null,createAnnotation:null}},setState:function(t,n){return e.extend(this.state,t),this.trigger(this.state),"function"==typeof n?n():void 0},replaceState:function(e){return this.state=e,this.forceUpdate()},forceUpdate:function(){return this.trigger(this.state)},onReceiveFileActivity:function(e){var t,n;return n=this.state.activity,t=this.state.viewing.revision,e&&C.isLatestRevision(t,null!=n?n.latestRevision:void 0)&&(this.state.viewing.revision=e.latestRevision),this.setState({activity:e}),this.state.isPreviewReady&&null==n?f.emit("preview-and-comments-ready"):void 0},onStartViewingComments:function(e){var t,n,i,o,s,r;return t=e.actorId,n=e.context,i=e.contextData,s=e.oref,o=e.file,r=null!==this.state.contextData?y(this.state.showLoadingSpinner,this.state.activity):!0,this.setState({actorId:t,viewing:{context:n,contextData:i,file:o,revision:null},oref:s,viewAnnotation:null,createAnnotation:null,isPreviewReady:!1,showLoadingSpinner:r})},onStopViewingComments:function(){return this.setState({actorId:null,viewing:{context:null,contextData:null,revision:null,file:null},showLoadingSpinner:!0,oref:null,viewAnnotation:null,createAnnotation:null,isPreviewReady:!1})},onShowResolvedComments:function(){return this.setState({showResolvedComments:!0})},onHideResolvedComments:function(){return this.setState({showResolvedComments:!1})},onNotifyPreviewReady:function(){return this.setState({isPreviewReady:!0}),null!=this.state.activity?f.emit("preview-and-comments-ready"):void 0},onNotifyAnnotationReplyFocused:function(){return this.state.annotationReplyFocused=!0},onNotifyAnnotationReplyBlurred:function(){return this.state.annotationReplyFocused=!1},onShowAnnotationConversation:function(e){var t,n;return n=e.annotation,t=e.activityKey,this.setState({viewAnnotation:{annotation:n,activityKey:t},createAnnotation:null})},onHideAnnotationConversation:function(){return this.state.annotationReplyFocused?void 0:(this.onCancelHideAnnotationConversationDelayed(),this.setState({viewAnnotation:null}))},onHideAnnotationConversationDelayed:function(e){var t;return null!=this.state.viewAnnotation?(t=function(e){return function(){return e.onHideAnnotationConversation()}}(this),this.state.viewAnnotation.hideTimerId=window.setTimeout(t,e)):void 0},onCancelHideAnnotationConversationDelayed:function(){var e,t;return t=null!=(e=this.state.viewAnnotation)?e.hideTimerId:void 0,null!=t?(window.clearTimeout(t),this.state.viewAnnotation.timerId=null):void 0},onStartAnnotationCreation:function(e){var t;return t=e.annotation,this.setState({viewAnnotation:null,createAnnotation:{annotation:t,showBubble:!0}})},onStopAnnotationCreation:function(){return this.setState({createAnnotation:null})},onShowAnnotationInput:function(){return null!=this.state.createAnnotation?this.setState({createAnnotation:{annotation:this.state.createAnnotation.annotation,showBubble:!0}}):void 0},onHideAnnotationInput:function(){return null!=this.state.createAnnotation?this.setState({createAnnotation:{annotation:this.state.createAnnotation.annotation,showBubble:!1}}):void 0},onSwitchRevision:function(e){var t,n,i,s,r;return r=e.revision,t=e.commentActivity,C.isRevisionEqual(r,this.state.viewing.revision)?void 0:(C.isLatestRevision(r,this.state.activity.latestRevision)?(S.restoreRevision(),n=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_LATEST_REVISION):(i=w.getFileWithRevision(this.state.viewing.file,r),S.switchRevision(i),n=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_OLD_REVISION),this.setState({viewing:M(this.state.viewing,{revision:{$set:r}}),isPreviewReady:!1}),f.emit("revision-did-change"),T.log_annotation_event(n,this.state.activity.activity_key,null!=t?t.activity_key:void 0,this.state.actorId,this.state.viewing.context,null!=t&&null!=(s=t.comment.comment_metadata)?s.annotation:void 0))},onRevealAnnotation:function(e){var t,n,i,s;return n=e.commentActivity,i=n.comment.comment_metadata,s=null!=i?i.revision:void 0,t=A.createAnnotationFromDict(i.annotation),this.onSwitchRevision({revision:s,commentActivity:n}),f.emit("reveal-annotation",{page:t.getFirstPdfPage(),commentActivity:n}),T.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_BUTTON_CLICKED,this.state.activity.activity_key,i.activity_key,this.state.viewing.actorId,this.state.viewing.context,i.annotation)}})})}.call(this),function(){define("modules/clean/comments/utils",["modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/comments/actions","modules/clean/comments/models/preview_types","modules/clean/gandalf_util","modules/clean/viewer"],function(e,t,n,i,o,s){var r,a,l,c,u,d,p,h,_;return r=e.ActivityContext,u=function(e){return e===r.BROWSE_FILE_VIEWER&&o.getGandalfRule("comments_flux")},a=function(){return!0},l=function(e){var n;return n=s.get_viewer(),null!=e?new t(n.get_user_by_id(e)):n.work_user||n.personal_user?new t(n.work_user||n.personal_user):n.is_signed_in?void 0:new t},c=function(e,t){if((e===r.BROWSE_FILE_VIEWER||e===r.SHARED_LINK_VIEW)&&null!=t){if("photo"===t)return i.IMAGE;if("doc"===t||"adobecs"===t)return i.PDFJS}return null},d=function(e,t){return null==e?!0:e.revision_id===t.revision_id},p=function(e,t){return!d(e,t)},h=function(e,t){return(null!=e?e.revision_id:void 0)===(null!=t?t.revision_id:void 0)},_=function(){return this.keyCode||this.which||this.charCode},{isFluxEnabled:u,normalizedKeyCode:_,canAnnotate:a,getActivityUser:l,getPreviewType:c,isLatestRevision:d,isOldRevision:p,isRevisionEqual:h}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/components/bubble_menu",["jquery","modules/clean/keycode","modules/clean/components/bubble_dropdown"],function(n,i,o){var s;return s=function(o){function s(t,n,i,o){this.$root=t,this.arrow_direction=n,this.show_on_hover=i,this.top_adjustment=null!=o?o:0,this.onKeyDown=e(this.onKeyDown,this),this.onMouseEnter=e(this.onMouseEnter,this),this.$target=this.$root.find(".bubble-dropdown-target"),this.$target.on("keydown",this.onKeyDown),this.$menu=this.$root.find('*[role="menu"]'),this.$menuitems=this.$root.find('*[role="menuitem"]'),this.$menuitems.attr("role","menuitem"),this.$menuitems.on("keydown",this.onKeyDown),this.$menuitems.on("mouseenter",this.onMouseEnter),s.__super__.constructor.apply(this,arguments)}return t(s,o),s.prototype.focusPrevious=function(e){var t;return t=this.$menuitems.index(e),t=-1===t||0===t?this.$menuitems.length-1:t-1,this.$menuitems.get(t).focus()},s.prototype.focusNext=function(e){var t;return t=this.$menuitems.index(e),t=-1===t||t===this.$menuitems.length-1?0:t+1,this.$menuitems.get(t).focus()},s.prototype.onMouseEnter=function(){return n(this.$menu).removeClass("bubble-menu--keyboard")},s.prototype.onKeyDown=function(e){return n(this.$menu).addClass("bubble-menu--keyboard"),e.keyCode===i.DOWN?(this.focusNext(e.target),e.stopPropagation(),e.preventDefault()):e.keyCode===i.UP?(this.focusPrevious(e.target),e.stopPropagation(),e.preventDefault()):void 0},s}(o)})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/components/bubble_picker",["jquery","modules/clean/keycode"],function(t,n){var i;return i=function(){function i(t){this.$bubble_picker=t,this._on_button_keydown=e(this._on_button_keydown,this),this._on_option_keydown=e(this._on_option_keydown,this),this._on_option_mouseenter=e(this._on_option_mouseenter,this),this.enable_option=e(this.enable_option,this),this.disable_option=e(this.disable_option,this),this.show_dropdown=e(this.show_dropdown,this),this.hide_dropdown=e(this.hide_dropdown,this),this.set_value=e(this.set_value,this),this._listen=e(this._listen,this),this.$label_wrapper=this.$bubble_picker.find(".bubble-picker-label-wrapper"),this.$label_wrapper.on("keydown",this._on_button_keydown),this.$label=this.$bubble_picker.find(".bubble-picker-label"),this.$dropdown=this.$bubble_picker.find(".bubble-picker-dropdown"),this.$options=this.$bubble_picker.find("*[role='option']"),this.$options.on("mouseenter",this._on_option_mouseenter),this.$options.on("keydown",this._on_option_keydown),this._dropdown_shown=!1,this._listen()}return i.CHANGED="db:bubblepicker:changed",i.prototype._listen=function(){
return t(document).click(function(e){return function(n){var i,o;return o=t(n.target).closest(e.$label_wrapper).length>0,i=t(n.target).closest(e.$dropdown).length>0,e._dropdown_shown&&!i?e.hide_dropdown():o?e.show_dropdown():void 0}}(this)),this.$dropdown.find(".bubble-picker-option:not('.disabled')").click(function(e){return function(n){var o,s;return n.preventDefault(),o=t(n.currentTarget),o.hasClass("disabled")?void 0:(s=e.get_value(),e.set_value(o.data("value")),e.$bubble_picker.trigger(i.CHANGED,{clicked_val:o.data("value"),old_val:s}),e.hide_dropdown(),e.$label_wrapper.focus())}}(this))},i.prototype.get_value=function(){return this.$bubble_picker.attr("data-selected-value")},i.prototype.set_value=function(e){var t;return this.$bubble_picker.attr("data-selected-value",e),this.$label.empty(),this.$bubble_picker.find(".bubble-picker-option--selected").removeClass("bubble-picker-option--selected"),t=this.$bubble_picker.find("[data-value='"+e+"']").addClass("bubble-picker-option--selected"),this.$label.html(t.clone().html())},i.prototype.hide_dropdown=function(){return this.$dropdown.hide(),this._dropdown_shown=!1},i.prototype.show_dropdown=function(){var e,n;return this.$dropdown.show(),this._dropdown_shown=!0,this.$options.attr({tabindex:-1,"aria-selected":!1}),n=this.$bubble_picker.attr("data-selected-value"),e=n?this.$bubble_picker.find(".bubble-picker-option[data-value='"+n+"']")[0]:this.$bubble_picker.find(".bubble-picker-option")[0],t(e).attr({tabindex:0,"aria-selected":!0}).focus()},i.prototype.disable_option=function(e,n){var i,o;return o=this.$bubble_picker.find(".bubble-picker-option[data-value="+e+"]:not('.disabled')"),o.length>0&&(i=t(o.find(".role-option")),i.attr("saved-title",i.attr("title")),i.attr("title",n),i.attr("aria-disabled",!0)),o.addClass("disabled")},i.prototype.enable_option=function(e){var n,i;return i=this.$bubble_picker.find(".bubble-picker-option.disabled[data-value="+e+"]"),n=t(i.find(".role-option")),n.attr("saved-title")&&(n.attr("title",n.attr("saved-title")),n.removeAttr("saved-title")),n.attr("aria-disabled",!1),i.removeClass("disabled")},i.prototype._change_focus=function(e,n){return t(e).attr({tabindex:-1,"aria-selected":!1}),t(n).attr({tabindex:0,"aria-selected":!0}).focus()},i.prototype._focus_previous=function(e){var t;return t=this.$options.index(e),t>0?this._change_focus(e,this.$options.get(t-1)):void 0},i.prototype._focus_next=function(e){var t;return t=this.$options.index(e),t<this.$options.length-1?this._change_focus(e,this.$options.get(t+1)):void 0},i.prototype._on_option_mouseenter=function(){return this.$dropdown.removeClass("bubble-picker-dropdown--keyboard")},i.prototype._on_option_keydown=function(e){this.$dropdown.addClass("bubble-picker-dropdown--keyboard"),e.keyCode===n.ESC?(this.hide_dropdown(),this.$label_wrapper.focus()):e.keyCode===n.DOWN?(this._focus_next(e.target),e.preventDefault()):e.keyCode===n.UP?(this._focus_previous(e.target),e.preventDefault()):e.keyCode!==n.TAB||e.shiftKey||this.hide_dropdown()},i.prototype._on_button_keydown=function(e){e.keyCode===n.ENTER?this.$dropdown.addClass("bubble-picker-dropdown--keyboard"):e.keyCode===n.TAB&&e.shiftKey&&this.hide_dropdown()},i}()})}.call(this),function(){define("modules/clean/components/flag",["external/underscore","external/react"],function(e,t){var n,i,o,s;return s=t.DOM,o=t.addons.classSet,i={TOP:"top",MIDDLE:"middle",BOTTOM:"bottom"},n=t.createClass({statics:{FlagAlignment:i},propTypes:{alignment:t.PropTypes.oneOf(e.values(i)),reverse:t.PropTypes.bool,fixedChild:t.PropTypes.node.isRequired,flexChild:t.PropTypes.node.isRequired},getDefaultProps:function(){return{reverse:!1,alignment:i.MIDDLE}},render:function(){var e,t,n;return e={"o-flag":!0,"o-flag--rev":this.props.reverse,"o-flag--top":this.props.alignment===i.TOP,"o-flag--bottom":this.props.alignment===i.BOTTOM},t=s.div({className:"o-flag__fix"},this.props.fixedChild),n=s.div({className:"o-flag__flex"},this.props.flexChild),this.props.reverse?s.div({className:o(e)},n,t):s.div({className:o(e)},t,n)}})})}.call(this),function(){define("modules/clean/components/loading_indicator",["external/underscore","external/react","modules/core/i18n"],function(e,t,n){var i,o,s,r,a;return s=n._,a=t.DOM,r=t.addons.classSet,o={DOTS:"dots",SPINNER:"spinner",BLUE_SPINNER:"blue_spinner"},i=t.createClass({displayName:"LoadingIndicator",statics:{LoadingIndicatorStyle:o},propTypes:{style:t.PropTypes.oneOf(e.values(o)),className:t.PropTypes.string},getDefaultProps:function(){return{style:o.DOTS,className:""}},render:function(){var t;return t={},this.props.className&&(t=e.object(this.props.className.split(" ").map(function(e){return[e,!0]}))),t=e.extend(t,{"c-loader":!0,"c-loader--spinner":this.props.style===o.SPINNER,"c-loader--spinner--blue":this.props.style===o.BLUE_SPINNER}),a.div({className:r(t)},s("Loading…"))}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},n=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;define("modules/clean/components/role_picker",["external/underscore","modules/constants/viewer","modules/core/controller_helpers","modules/core/exception","modules/clean/multiaccount_login","modules/clean/page_role_observer","modules/clean/viewer"],function(i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v;return d=o.ROLE_PERSONAL,p=o.ROLE_PHOTOS,h=o.ROLE_WORK,v=r.assert,m={ALL:"all",PERSONAL:d,WORK:h},_=function(){function n(n){var o,s,r,a,l,u;null==n&&(n={}),this._actually_set_state=e(this._actually_set_state,this),this._do_login=e(this._do_login,this),this.is_user_visible=e(this.is_user_visible,this),this.is_role_visible=e(this.is_role_visible,this),this.ensure_role_is_visible=e(this.ensure_role_is_visible,this),this.set_state=e(this.set_state,this),this.get_state=e(this.get_state,this),this._allow_merged_state=null!=n.allow_merged_state?n.allow_merged_state:!0,this._limit_to_role=null!=n.limit_to_role?n.limit_to_role:null,u=c.get_viewer(),s=u.is_role_signed_in(m.PERSONAL)&&u.is_role_signed_in(m.WORK),n.initial_state?(a=i.values(m),v((r=n.initial_state,t.call(a,r)>=0),"RolePicker requires initial_state to be one of: "+a),this.set_state(n.initial_state)):this._allow_merged_state&&s?this.set_state(m.ALL):(o=u.get_users(),v(o.length,"tried to use RolePicker on a page with no users"),l=o[0],this.set_state(l.role))}return n.prototype.get_state=function(){return this._state},n.prototype.set_state=function(e){var t,n,i,o;if(v(this._allow_merged_state||e!==m.ALL,"tried to set merged state in non-merged picker"),null!=this._limit_to_role&&v(e===m.ALL||e===this._limit_to_role),e===m.ALL){for(i=[d,h,p],t=0,n=i.length;n>t;t++)if(o=i[t],!c.get_viewer().is_role_signed_in(o))return void this._do_login(o,e)}else if(o=e,!c.get_viewer().is_role_signed_in(o))return void this._do_login(o,e);return this._actually_set_state(e)},n.prototype.update_picker_ui=function(){},n.prototype.ensure_role_is_visible=function(e){return this.is_role_visible(e)?void 0:this.set_state(this._allow_merged_state?m.ALL:e)},n.prototype.is_role_visible=function(e){return this._state===m.ALL||this._state===e},n.prototype.is_user_visible=function(e){return this.is_role_visible(e.role)},n.prototype._do_login=function(e,t){return a.show_modal({role:e,on_success:function(e){return function(){return e._actually_set_state(t)}}(this)})},n.prototype._actually_set_state=function(e){return e!==this._state?(this._state=e,this.update_picker_ui(),"function"==typeof this.on_state_change?this.on_state_change(e):void 0):void 0},n}(),f=function(t){function i(t,n){this.$container=t,null==n&&(n={}),this.limit_to_role=e(this.limit_to_role,this),this.update_picker_ui=e(this.update_picker_ui,this),this.on_ui_change=e(this.on_ui_change,this),this.$bubble_picker=this.$container.find(".bubble-picker"),this.$bubble_picker.on("db:bubblepicker:changed",this.on_ui_change),i.__super__.constructor.call(this,n)}return n(i,t),i.prototype.on_ui_change=function(e,t){var n;return n=t.clicked_val,n!==this._state?(s.get_controller(this.$bubble_picker).set_value(this._state),this.set_state(n)):void 0},i.prototype.update_picker_ui=function(){return s.get_controller(this.$bubble_picker).set_value(this._state)},i.prototype.limit_to_role=function(e,t){var n,i;if(null!=e){this.ensure_role_is_visible(e);for(n in m)i=m[n],i!==e&&i!==m.ALL&&s.get_controller(this.$bubble_picker).disable_option(i,t)}else for(n in m)i=m[n],s.get_controller(this.$bubble_picker).enable_option(i);return this._limit_to_role=e},i}(_),u=function(e){function t(e,n){null==n&&(n={}),n.allow_merged_state=!1,t.__super__.constructor.call(this,e,n)}return n(t,e),t.prototype.on_state_change=function(e){var t;return t=function(){switch(e){case m.PERSONAL:return d;case m.WORK:return h}}(),l.emit(t)},t}(f),{RolePickerState:m,RolePicker:_,RoleSelect:f,PageRoleSelect:u}})}.call(this),function(){define("modules/clean/components/title_bubble",["jquery","external/react","modules/clean/css"],function(e,t,n){var i,o,s;return s=n.require_css,o=t.DOM,i=t.createClass({displayName:"TitleBubble",propTypes:{text:t.PropTypes.string.isRequired,direction:t.PropTypes.oneOf(["north","south","east","west"]).isRequired},getInitialState:function(){return{isChildFocused:!1}},componentWillMount:function(){return s("/static/css/components/title_bubble-vflIJjDSi.css")},componentDidMount:function(){return e(this.getDOMNode()).on("focusin.title-bubble",function(e){return function(){return e.setState({isChildFocused:!0})}}(this)).on("focusout.title-bubble",function(e){return function(){return e.setState({isChildFocused:!1})}}(this))},componentWillUnmount:function(){return e(this.getDOMNode()).off("focusin.title-bubble").off("focusout.title-bubble")},render:function(){var e;return e={"title-bubble-component":!0,"is-child-focused":this.state.isChildFocused},e[this.props.direction]=!0,o.div({className:t.addons.classSet(e),"data-title":this.props.text,onClick:function(e){return function(t){return t.detail>0?e.setState({isChildFocused:!1}):void 0}}(this)},t.Children.only(this.props.children))}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/contacts/bloodhound_contacts",["jquery","external/typeahead.bundle","external/underscore","modules/clean/ajax","modules/clean/contacts/cache","modules/clean/gandalf_util","modules/clean/viewer","modules/core/exception","modules/core/uri"],function(t,n,i,o,s,r,a,l,c){var u,d,p,h;return p=s.DefaultContactsCache,h=l.assert,d=100,u=function(){function t(t,n,i){var o;this.contacts_filter=null!=t?t:null,this.for_user=null!=n?n:null,this.limit=null!=i?i:10,this._get=e(this._get,this),this.server_search=r.getGandalfRule("contacts_server_search_allowed"),o=null,this.server_search&&(o={url:"/contacts/search",replace:function(e,t){return t.query=JSON.stringify(t.query),c({path:e,query:t}).toString()},rateLimitWait:300,ajax:{type:"POST"}}),this.contacts=new Bloodhound({datumTokenizer:function(e){return[e.name,e.email,e.fname,e.lname].concat(e.name_tokens)},queryTokenizer:function(e){return e.query},dupDetector:function(e,t){return e.unique_key===t.unique_key},limit:this.limit,sorter:this._contacts_sorter,local:[],sufficient:5,remote:o}),this.contacts.initialize(),this.sortedContacts=[],this.extraContacts=[],this.batchGetQueue=[],this.getQueue=[],a.get_viewer().is_signed_in&&p.load_contacts(!1,function(e){return function(t){return e._init_contacts(t)}}(this),this.server_search?d:null)}return t.prototype._contacts_sorter=function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0},t.prototype._init_contacts=function(e){return this._update_contacts(e),p.register_for_updates("bloodhound_contacts",function(e){return function(t){return e._update_contacts(t)}}(this))},t.prototype._update_contacts=function(e){var t,n,i;return this.contacts.clear(),n=e.excludePairedUserDuplicates(),null!=this.for_user&&a.get_viewer().is_user_signed_in(this.for_user)&&(n=n.includeForUser(this.for_user.id)),this.contacts_filter&&(n=n.filterContacts(this.contacts_filter)),this.contacts.add(n.contacts),i=this._dedupe_extra_contacts(),this.contacts.add(i),t=n.contacts.concat(i),t.sort(function(e){return function(t,n){return e._contacts_sorter(t,n)}}(this)),this.sortedContacts=t.slice(0,this.limit)},t.prototype.setExtraContacts=function(e){return this.extraContacts=e},t.prototype._dedupe_extra_contacts=function(){var e,t,n,i,o,s;for(t=this.contacts.index.datums,i={},n={},o=0,s=t.length;s>o;o++)e=t[o],i[e.email]=!0,n[e.dbx_account_id]=!0;return this.extraContacts.filter(function(e){return!n[e.dbx_account_id]&&!i[e.email]})},t.prototype._add_to_request_queue=function(e,t){var n,i,o;return o=Boolean(0===this.batchGetQueue.length&&0===this.getQueue.length),i=Array.isArray(e),n={query:i?e:e.trim().split(/\s+/),callback:t,match_any:i,blocking:!0},n.match_any?this.batchGetQueue.push(n):this.getQueue.push(n),o},t.prototype._next_get_request=function(){var e;return e=null,this.getQueue.length>0?e=this.getQueue[0]:this.batchGetQueue.length>0&&(e=this.batchGetQueue[0]),e},t.prototype._cleanup_request=function(e){var t;if(e.match_any){if(t=this.batchGetQueue.indexOf(e),t>=0)return this.batchGetQueue.splice(t,1)}else if(t=this.getQueue.indexOf(e),t>=0)return this.getQueue.splice(t,1)},t.prototype._get=function(){var e,t;return t=this._next_get_request(),t?(e=function(e){return function(n){return"function"==typeof t.callback&&t.callback(n),e._cleanup_request(t),e._get()}}(this),this.contacts.get(i.omit(t,"callback"),e)):void 0},t.prototype.get=function(e,t){var n;return h(Array.isArray(e)||i.isString(e)),n=this._add_to_request_queue(e,t),n?this.server_search||p.is_loaded()?this._get():p.load_contacts(!1,this._get):void 0},t.prototype.getSortVariant=function(){return p.sort_variant},t}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/cache",["jquery","modules/core/exception","modules/clean/ajax","modules/clean/contacts/list","modules/clean/profile_services/profile_services_constants","modules/clean/viewer"],function(n,i,o,s,r,a){var l,c,u;return u=i.assert,l=function(){function i(){this._update_loading_state=e(this._update_loading_state,this),this._invoke_callbacks=e(this._invoke_callbacks,this),this._invoke_all_callbacks=e(this._invoke_all_callbacks,this),this.unregister_for_updates=e(this.unregister_for_updates,this),this.register_for_updates=e(this.register_for_updates,this),this.loading_state=i.HAVENT_LOADED,this.callbacks={},this.one_time_callbacks=[],this.sort_variant=null,n(document).on("db:profile_service:auth_complete",function(e){return function(){return e.load_contacts(!0)}}(this)),n(document).on("db:profile_service:deauth_complete",function(e){return function(){return e.load_contacts(!0)}}(this))}return i.HAVENT_LOADED=0,i.LOADING_NONE_AVAILABLE=1,i.LOADING_STALE_AVAILABLE=2,i.LOADED=3,i.prototype.is_loaded=function(){return this.loading_state===i.LOADED||this.loading_state===i.LOADING_STALE_AVAILABLE},i.prototype.load_contacts=function(e,n,r){var l;if(null==r&&(r=null),a.get_viewer().is_signed_in){if(null!=n&&t.call(this.one_time_callbacks,n)<0&&this.one_time_callbacks.push(n),e){if(this.loading_state===i.LOADING_STALE_AVAILABLE)return}else{if(this.loading_state===i.LOADING_NONE_AVAILABLE)return;if(this.loading_state!==i.HAVENT_LOADED)return void this._invoke_all_callbacks()}return this._update_loading_state(this.loading_state===i.LOADED?i.LOADING_STALE_AVAILABLE:i.LOADING_NONE_AVAILABLE),l=function(e){return function(t,n){var i;return e._update_loading_state(n),e.sort_variant=t.sort_variant,i=s.create_contacts_list(t.contacts),e.precached_contacts=i.contacts,e.cached_contacts=i,e._invoke_all_callbacks()}}(this),this.loading_state===i.LOADING_NONE_AVAILABLE&&o.BackgroundRequest({url:"/get_cached_contacts",data:{version:1,limit:r},success:function(e){return function(t){var n,o;return e.loading_state===i.LOADING_NONE_AVAILABLE&&(n=JSON.parse(t),null!=(o=n.contacts)?o.length:void 0)?l(n,i.LOADING_STALE_AVAILABLE):void 0}}(this)}),o.BackgroundRequest({url:"/get_refreshed_contacts?long_running=1",data:{version:1,limit:r},success:function(){return function(e){var t;return t=JSON.parse(e),l(t,i.LOADED)}}(this)})}},i.prototype.register_for_updates=function(e,t){return this.callbacks[e]=t},i.prototype.unregister_for_updates=function(e){return t.call(Object.keys(this.callbacks),e)>=0?delete this.callbacks[e]:void 0},i.prototype._invoke_all_callbacks=function(){return this._invoke_callbacks(this.one_time_callbacks,!0),this._invoke_callbacks(this.callbacks,!1)},i.prototype._invoke_callbacks=function(e,t){var n,i,o,s,r;for(s=Object.keys(e),r=[],n=0,o=s.length;o>n;n++)i=s[n],e[i](this.cached_contacts),r.push(t?delete e[i]:void 0);return r},i.prototype._update_loading_state=function(e){return u(e===i.LOADING_NONE_AVAILABLE||e===i.LOADING_STALE_AVAILABLE||e===i.LOADED),this.loading_state=e},i}(),c=new l,{ContactsCache:l,DefaultContactsCache:c}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/data",["external/underscore","modules/core/exception","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/cache","modules/clean/contacts/types","modules/clean/fuzzy","modules/clean/gandalf_util","modules/clean/viewer"],function(n,i,o,s,r,a,l){var c,u,d,p;return p=i.assert,d=s.DefaultContactsCache,c=function(){function e(e){this.dbx_account_id=e.dbx_account_id,this.type=e.type,this.name=e.name,this.email=e.email,this.fb_id=e.fb_id,this.group_id=e.group_id,this.photo_url=e.photo_url,this.members=e.members,this.avatar_url=e.avatar_url,this.invalid=e.invalid,this.on_team=e.on_team,this.nameMatch=e.nameMatch,this.emailMatch=e.emailMatch,this.pending=e.pending}return e.prototype.getKey=function(){return this.type===r.FB?"contact-fb-"+this.fb_id:this.type===r.NEW_STYLE_GROUP?"contact-group-"+this.group_id:"contact-email-"+this.email},e.prototype.getContactID=function(){switch(this.type){case r.FB:return this.fb_id;case r.NEW_STYLE_GROUP:return this.group_id;default:return this.email}},e}(),u=function(){function i(t){var n;this.user=t.user,this.filterFunc=t.filterFunc,this._set_contacts=e(this._set_contacts,this),p(this.user,"must include user"),null==this.filterFunc&&(this.filterFunc=function(){return!0}),this.instance=i.INSTANCE++,n="contacts-data-source:"+this.instance,d.register_for_updates(n,this._set_contacts),this._team_members=[],this.bloodhound_contacts=new o(this.filterFunc,this.user,1e5)}return i.INSTANCE=0,i.prototype._set_contacts=function(e){var t;return this.user.is_team?(t=e.excludeNonTeam().contacts,this._team_members=n.map(t,function(e){return e.email})):void 0},i.prototype.is_loaded=function(){return d.is_loaded()},i.prototype._isTeamContact=function(e){return this.user.is_team&&null!=e.team&&e.team},i.prototype.isTeamEmail=function(e){return this.user.is_team&&t.call(this._team_members,e)>=0},i.prototype.getSortVariant=function(){return d.sort_variant},i.prototype.query=function(e,t){var n;return""===e.trim()?t([]):(n=function(n){return function(i){var o,s,l,u,d;for(s=[],l=0,u=i.length;u>l;l++)d=i[l],d.nameMatch=a.match(e,d.name||""),d.emailMatch=a.match(e,d.email||""),d.on_team=d.type!==r.FB&&n._isTeamContact(d),o=new c(d),o.pending=!1,s.push(o);return t(s)}}(this),this.bloodhound_contacts.get(e,n))},i.prototype.query_batch=function(e,t){var i,o,s,a,u,d,p,h,_;for(s={},a=0,d=e.length;d>a;a++)i=e[a],i.pending=!1,s[i.getContactID()]=i;if(_=function(e){return function(n){var i,o,a,l;for(o=0,a=n.length;a>o;o++)l=n[o],l.on_team=l.type!==r.FB&&e._isTeamContact(l),i=new c(l),i.pending=!1,s[i.getContactID()]=i;return t(s)}}(this),l.getGandalfRule("contacts_server_search_allowed"))return this.bloodhound_contacts.get(n.keys(s),_);for(h=[],u=0,p=e.length;p>u;u++)o=e[u],this.bloodhound_contacts.get(o.getContactID(),function(e){return h=h.concat(e)});return _(h)},i}(),{Contact:c,ContactTypes:r,ContactsDataSource:u}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/contacts/facebook_modal",["modules/clean/dbmodal"],function(n){var i,o;return i=n.DBUserModal,o=function(n){function i(t,n,o){this.show_hidden_modal=n,this.link_with_facebook=o,this.on_confirm_button_click=e(this.on_confirm_button_click,this),this.on_hide=e(this.on_hide,this),i.__super__.constructor.call(this,t,{element_id:"facebook-confirm-modal-user-"+t.id})}return t(i,n),i.prototype.on_hide=function(){return"function"==typeof this.show_hidden_modal?this.show_hidden_modal():void 0},i.prototype.on_confirm_button_click=function(){return this.hide(),this.link_with_facebook()},i}(i)})}.call(this),function(){define("modules/clean/contacts/facebook_oauth",["jquery","modules/core/exception","modules/core/uri","modules/clean/ajax","modules/clean/viewer","modules/constants/viewer"],function(e,t,n,i,o,s){var r,a;return a=t.assert,r={do_auth:function(e,t){var i;return a(null!=t,"user_id must be specified"),i=window.open(n({path:"/fb/access_token"}).updateQuery(s.UID_PARAM_NAME,t).toString(),"fb_auth","width=600,height=450"),e?r.onLoginSuccessCallback=e:void 0},post:function(e,t,s,l,c,u,d){return a(null!=d,"user_id must be specified!"),o.get_viewer().is_signed_in?("function"==typeof r.custom_show_posting&&r.custom_show_posting(),new i.WebRequest({url:"/fb/post",data:{message:e,link:t,link_name:s,description:l,from_referrals:r.from_referrals,from_getspace:r.from_getspace,picture:c?c:""},success:function(n,i,o){var a;return a=o.responseText,0===a.indexOf("ok")?"function"==typeof r.custom_show_complete?r.custom_show_complete():void 0:0===a.indexOf("auth")?r.do_auth(function(){return r.post(e,t,s,l,c,u,d)},d):void 0},error:function(){return"function"==typeof u?u():void 0},subject_user:d})):void window.open(n.parse("http://www.facebook.com/sharer.php").setQuery({u:t,t:s}).toString())}}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/list",["jquery","modules/clean/em_string","modules/clean/contacts/types"],function(n,i,o){var s;return s=function(){function n(t){var n;this.contacts=t,this._lowercaseContact=e(this._lowercaseContact,this),this._excludeType=e(this._excludeType,this),this.sortByTeamFirst=e(this.sortByTeamFirst,this),this.excludeSuspended=e(this.excludeSuspended,this),this.excludeNonTeamActive=e(this.excludeNonTeamActive,this),this.excludeNonTeam=e(this.excludeNonTeam,this),this.excludePairedUserDuplicates=e(this.excludePairedUserDuplicates,this),this.excludeTeamMembers=e(this.excludeTeamMembers,this),this.excludeFacebook=e(this.excludeFacebook,this),this.excludeNewStyleGroups=e(this.excludeNewStyleGroups,this),this.excludeMe=e(this.excludeMe,this),this.excludeByEmail=e(this.excludeByEmail,this),this.includeForViewer=e(this.includeForViewer,this),this.includeForUser=e(this.includeForUser,this),this.slice=e(this.slice,this),this.length=e(this.length,this),this.filterContacts=e(this.filterContacts,this),this.lcontacts=function(){var e,t,i,o;for(i=this.contacts,o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(this._lowercaseContact(n));return o}.call(this)}return n._format_contact_array=function(e){var t,n,o,s;for(t=22,o=0,s=e.length;s>o;o++)n=e[o],null!=n.email&&(n.email_snippet=i.em_snippet(n.email,t)),null!=n.name&&(n.name=i.em_snippet(n.name,t));return e},n.create_contacts_list=function(e){return e=n._format_contact_array(e),new n(e)},n.prototype.filterContacts=function(e){var t;return t=this.contacts.filter(e),new n(t)},n.prototype.length=function(){return this.contacts.length},n.prototype.slice=function(e,t){return new n(this.contacts.slice(e,t))},n.prototype.includeForUser=function(e){return this.filterContacts(function(t){return t.owning_user_id===e})},n.prototype.includeForViewer=function(e){var n;return n=e.get_user_ids(),this.filterContacts(function(e){var i;return i=e.owning_user_id,t.call(n,i)>=0})},n.prototype.excludeByEmail=function(e){return e=e?e.toLowerCase():"",this.filterContacts(function(t){return!(e===t.email.toLowerCase())})},n.prototype.excludeMe=function(){return this.filterContacts(function(e){return!e.is_owner})},n.prototype.excludeNewStyleGroups=function(){return this._excludeType(o.NEW_STYLE_GROUP)},n.prototype.excludeFacebook=function(){return this._excludeType(o.FB)},n.prototype.excludeTeamMembers=function(){return this.filterContacts(function(e){return!e.team})},n.prototype.excludePairedUserDuplicates=function(){return this.filterContacts(function(e){return!e.paired_user_duplicate})},n.prototype.excludeNonTeam=function(){return this.filterContacts(function(e){return e.team})},n.prototype.excludeNonTeamActive=function(){return this.filterContacts(function(e){return e.team&&"active"===e.join_state})},n.prototype.excludeSuspended=function(){return this.filterContacts(function(e){return"suspended"!==e.join_state})},n.prototype.sortByTeamFirst=function(){return new n(n.sortContactsByTeamFirst(this.contacts))},n.sortContactsByTeamFirst=function(e){var t,n,i,o,s;for(s=[],o=[],n=0,i=e.length;i>n;n++)t=e[n],t.team?s.push(t):o.push(t);return s.concat(o)},n.prototype._excludeType=function(e){return this.filterContacts(function(t){return t.type!==e})},n.prototype._lowercaseContact=function(e){var t,n,i;n={};for(t in e)i=e[t],("string"==typeof i||i instanceof String)&&(i=i.toLowerCase()),n[t]=i;return n},n}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/tokenizer",["external/react","external/underscore","modules/core/i18n","modules/clean/analytics","modules/clean/avatar/contact_avatar","modules/clean/contacts/data","modules/clean/contacts/typeahead","modules/clean/contacts/types","modules/clean/em_string","modules/clean/react/sprite","modules/clean/tokenizer","modules/clean/validators/validators","jquery"],function(t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C,E,S,T,A,I,k,P;return S=i._,m=o.ContactSearchLogger,_=r.Contact,g=r.ContactsDataSource,w=a.ContactsTypeaheadSelector,E=d.Tokenizer,T=t.createElement,A=t.DOM,C=16,P=p.check(p.create(["EmailValidator"])),f={invalid:"invalid",warn:"warn",pending:"pending",ok:"ok"},y=t.createClass({displayName:"ContactsToken",propTypes:{customClass:t.PropTypes.string,className:t.PropTypes.string,contact:t.PropTypes.object.isRequired,onRemove:t.PropTypes.func,tabIndex:t.PropTypes.number,tokenState:t.PropTypes.oneOf(function(){var e;e=[];for(I in f)k=f[I],e.push(k);return e}()).isRequired},render:function(){var e,n;return n={"tokenizer-token":!0,"contact-token":!0,invalid:this.props.tokenState===f.invalid,warned:this.props.tokenState===f.warn,pending:this.props.tokenState===f.pending},n[this.props.customClass]=null!=this.props.customClass,n[this.props.className]=null!=this.props.className,e=t.addons.classSet(n),A.a(h.extend({tabIndex:-1},this.props,{className:e}),this._renderInput(),this._renderIcon(),this._renderText(),this._makeCloseButton())},_getTokenName:function(){switch(this.props.contact.type){case l.FB:return"fb_ids";case l.EMAIL:return"emails";case l.NEW_STYLE_GROUP:return"new_style_group_ids";default:return"invalids"}},_getTokenValue:function(){switch(this.props.contact.type){case l.FB:return this.props.contact.fb_id;case l.NEW_STYLE_GROUP:return this.props.contact.group_id;default:return this.props.contact.email}},_renderIcon:function(){return this.props.contact.type===l.FB?A.img({className:"token-icon",src:"/static/images/icons/fb_16-vflbiYTkC.png"}):this.props.contact.type===l.NEW_STYLE_GROUP||this.props.contact.dbx_account_id?new s({dimension:C,contact:this.props.contact,optionalClass:"token-icon"}):""},_renderInput:function(){return A.input({type:"hidden",name:this._getTokenName(),value:this._getTokenValue()})},_renderText:function(){var e,t;return e=22,t=this.props.contact.name||this.props.contact.email,c.em_snippet(t,e)},_makeCloseButton:function(){return this.props.onRemove?A.span({className:"tokenizer-token-close",onClick:function(e){return function(){return e.props.onRemove(e.props.contact),!1}}(this),dangerouslySetInnerHTML:{__html:"&nbsp;"}}):""}}),v={basic:function(e){var t;return t=e.name&&!e.invalid&&e.email!==e.name,{state:e.invalid?f.invalid:f.ok,msg:t?e.email:null}},warn:function(e){return{state:e.pending?f.pending:e.on_team?f.ok:e.invalid?f.invalid:f.warn,msg:null}},forbid:function(e){return{state:e.pending?f.pending:e.on_team?f.ok:f.invalid,msg:null}}},b=t.createClass({displayName:"ContactsTokenizer",propTypes:{user:t.PropTypes.object.isRequired,context:t.PropTypes.string,customClass:t.PropTypes.string,customContactFilter:t.PropTypes.func,customContactValidator:t.PropTypes.func,onContentsChange:t.PropTypes.func,placeholder:t.PropTypes.string,populatedInputData:t.PropTypes.shape({tokens:t.PropTypes.array,value:t.PropTypes.string}),tabIndex:t.PropTypes.number,showContactImport:t.PropTypes.bool,shouldLogContactSearch:t.PropTypes.bool,tokenSpacing:t.PropTypes.number,focusOnMount:t.PropTypes.bool},getDefaultProps:function(){return{customContactFilter:function(){return!0},customContactValidator:v.basic,placeholder:S("Invite more people"),populatedInputData:{tokens:[],value:""},tokenSpacing:4,showContactImport:!1,shouldLogContactSearch:!1,focusOnMount:!1}},componentWillReceiveProps:function(e){var t;(e.user!==this.props.user||e.customContactFilter.toString()!==this.props.customContactFilter.toString())&&(this.contactsDataSource=new g({user:e.user,filterFunc:e.customContactFilter})),this._validateTokens(null!=(t=e.populatedInputData)?t.tokens:void 0)},componentWillMount:function(){var e;this.contactsDataSource=new g({user:this.props.user,filterFunc:this.props.customContactFilter}),this._validateTokens(null!=(e=this.props.populatedInputData)?e.tokens:void 0)},componentDidMount:function(){return this.props.shouldLogContactSearch?this.contact_search_logger=new m:void 0},_validateTokens:function(e){var t,n,i,o;if((null!=e?e.length:void 0)>0){for(i=[],t=0,n=e.length;n>t;t++)o=e[t],i.push(o.invalid=!P(o.email));return i}},finishLogging:function(e){return this.props.shouldLogContactSearch?this.contact_search_logger.log_records(this.props.user.id,e):void 0},_logTokenChangeEvent:function(e,t,n){var i,o;if(null==t&&(t=!1),null==n&&(n={}),this.props.shouldLogContactSearch){if(t)return this.contact_search_logger.flag_record_as_removed(e.getContactID());i="react_tokenizer",null!=this.props.context&&(i+="_"+this.props.context),o={context:i,contact_type:e.type,contact_id:e.getContactID(),contact_name:e.name,sort_variant:this.refs.tokenizer.props.dataSource.getSortVariant()};for(I in n)k=n[I],o[I]=k;return this.contact_search_logger.add_record(o)}},addExternalContacts:function(e){return this.refs.tokenizer.addExternalTokens(e)},render:function(){return T(E,{ref:"tokenizer",dataSource:this.contactsDataSource,customClass:this.props.customClass,initialInputText:this.props.populatedInputData.value,placeholderText:this.props.placeholder,renderSelector:function(e){return function(){return T(w,{showContactImport:e.props.showContactImport,user:e.props.user})}}(this),renderInput:function(){return A.textarea({className:"contacts-tokenizer-input",rows:1})},renderToken:this._renderToken,renderTokenHover:this._renderTokenHover,onContentsChange:this.props.onContentsChange,stringTokenizer:this.tokenizeEmails,
populatedTokenData:this.props.populatedInputData.tokens,tabIndex:this.props.tabIndex,tokenSpacing:this.props.tokenSpacing,focusOnMount:this.props.focusOnMount,logTokenChangeEvent:this._logTokenChangeEvent},this.props.children)},_renderToken:function(e){return T(y,{contact:e,tokenState:this.props.customContactValidator(e).state})},_renderTokenHover:function(e){return this.props.customContactValidator(e).msg},tokenizeEmails:function(t,i){var o,s,r,a,c,u,d,p,h,m,f;for(null==i&&(i=!1),o=/[,|;\n]+/,s=/[,|;\n ]+/,u=t.split(s),p=2===u.length&&P(u[0])&&""===u[1]?u:t.split(o),f="",i||(f=p.pop()),h=[],a=0,c=p.length;c>a;a++)d=p[a],r=d.trim(),""!==r&&h.push(new _({name:r,email:r,type:l.EMAIL,invalid:!P(r),on_team:this.refs.tokenizer.props.dataSource.isTeamEmail(r),pending:!0}));return m=function(t){return function(i){var o,s,r,a,l,c,u;for(c=[],o=t.serializeInputData().tokens,u=n.map(o,function(e){return e.getContactID()}),a=n.filter(h,function(t){var n;return n=t.getContactID(),e.call(u,n)<0}),o=o.concat(a),s=0,r=o.length;r>s;s++)l=o[s],c.push(null!=i[l.getContactID()]?i[l.getContactID()]:l);return t.refs.tokenizer.replaceTokens(c)}}(this),h.length>0&&!i&&this.refs.tokenizer.props.dataSource.query_batch(h,m),{tokens:h,value:f}},serializeInputData:function(){return this.refs.tokenizer.serializeInputData()},getContacts:function(){var e,t,n,i;return e=this.serializeInputData(),n=e.tokens,i=e.value,t=this.tokenizeEmails(i,!0),n.concat(t.tokens)},tokenizeAll:function(){return this.refs.tokenizer.tokenizeAll()}}),{ContactsTokenizer:b,ContactTokenValidator:v,ContactTokenState:f}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/contacts/typeahead",["jquery","external/react","external/underscore","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/avatar/contact_avatar","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/contacts/types","modules/clean/react/image","modules/clean/react/paging_list","modules/clean/react/sprite","modules/clean/static_urls","modules/clean/typeahead"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f){var v,g,y,b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D;return N=o.assert,P=s._,T=a.SharedFolderActivityLogger,C=u.LinkedProfileServices,E=u.ProfileServicesLinkingHandler,D=m.static_url,k=f.TypeaheadSelectorMixin,O=n.DOM,R=n.createElement,x=n.addons.classSet,L=function(e,n){return t.extend({},e,n)},S=32,g=L(k,{getOptions:function(){var e,t,n;return null==this.props.queryOptions?[]:this.state.importsExpanded?function(){var e,n,i,o;for(i=c.contact_services(),o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(new A({provider:t,connected:this.profile_services.service_is_connected(t)}));return o}.call(this):(e=this.props.queryOptions.slice(0),(null!=(n=this.profile_services)?n.has_unconnected_services(!0):void 0)&&e.push(new b),e)},renderOption:function(e){return e instanceof b?R(w):e instanceof A?R(I,{import:e}):this.props.renderQueryOption(e)},onSelect:function(t){var n,i;return t instanceof b?(this._changeSelectionIndex(0),this.setState({importsExpanded:!0})):t instanceof A?(N((i=t.provider,e.call(c.contact_services(),i)>=0),"invalid party contact provider "+t.provider),this.profile_services.service_is_connected(t.provider)?(n=P("You're already connected to %(service_name)s").format({service_name:c.to_name(t.provider)}),void r.success(n)):(this.reset(),this.link_handler.auth_service_with_user(t.provider,this.props.user.id,function(){return function(e){return E.show_import_notifications(e)}}(this)))):this.props.onSelect(t)},reset:function(){return this._changeSelectionIndex(0),this.setState({importsExpanded:!1})}}),v=n.createClass({displayName:"ContactsTypeaheadSelector",mixins:[g],propTypes:{customClass:n.PropTypes.string,onClose:n.PropTypes.func.isRequired,onSelect:n.PropTypes.func.isRequired,queryOptions:n.PropTypes.array,renderQueryOption:n.PropTypes.func.isRequired,showContactImport:n.PropTypes.bool,user:n.PropTypes.object.isRequired},componentWillMount:function(){return this.link_handler=new E,this.profile_services=null,this.props.showContactImport&&null!=this.props.user?this.profile_services=C.get_linked_profile_services_for_user(this.props.user.id):void 0},componentWillReceiveProps:function(e){var t;return 0===(null!=(t=e.queryOptions)?t.length:void 0)?this._changeSelectionIndex(-1):void 0},shouldComponentUpdate:function(e,t){return!i.isEqual(e,this.props)||!i.isEqual(t,this.state)},getDefaultProps:function(){return{showContactImport:!1,onSelect:function(){},renderQueryOption:function(e){return R(y,{contact:e})}}},onSelectionIndexChange:function(e){var t;return null!=(t=this.refs.pagingList)?t.scrollAround(e):void 0},render:function(){var e;return this.getOptions().length?(e={"typeahead-selector":!0,"contacts-selector":!0},e[this.props.customClass]=null!=this.props.customClass,n.createElement(h,{customClass:n.addons.classSet(e),pageSize:4,itemSize:49,ref:"pagingList"},this.renderOptions())):O.div({})}}),y=n.createClass({displayName:"ContactsTypeaheadSelectorOption",propTypes:{contact:n.PropTypes.object.isRequired,customClass:n.PropTypes.string},render:function(){var e,t,o,s;return e={"contacts-typeahead-option":!0},e[this.props.customClass]=null!=this.props.customClass,null!=this.props.className&&(e[this.props.className]=!0),t={primary:this._renderPrimary(),secondary:this._renderSecondary()},t=i.pick(t,function(e){return""!==e}),O.li(L(this.props,{className:n.addons.classSet(e)}),O.div({className:"option-left",key:"option-left"},this._renderIcon()),O.div({className:"option-right",key:"option-right"},function(){var n;n=[];for(o in t)s=t[o],e={"option-only":1===i.size(t)},e["option-"+o]=!0,n.push(O.div({className:x(e),key:"option-"+o},s));return n}()))},_renderPrimary:function(){return this._renderMatch(this.props.contact.name,this.props.contact.nameMatch)},_renderSecondary:function(){switch(this.props.contact.type){case d.EMAIL:return this.props.contact.email===this.props.contact.name?"":this._renderMatch(this.props.contact.email,this.props.contact.emailMatch);case d.FB:return P("Facebook message");case d.NEW_STYLE_GROUP:return this.props.contact.members;default:return""}},_renderMatch:function(e,t){var n,i,o,s,r,a,l,c,u;if(!t)return e;for(s=0,l=[],c=t.highlighted,i=0,r=c.length;r>i;i++)u=c[i],o=u[0],a=u[1],o>s&&l.push(e.slice(s,o)),n=e.slice(o,o+a),l.push(O.strong({key:"highlight-"+n+"-"+o},n)),s=o+a;return s<e.length&&l.push(e.slice(s)),l},_renderIcon:function(){return R(l,{dimension:S,contact:this.props.contact,optionalClass:"contact-icon"})}}),b=function(){function e(){}return e.prototype.getKey=function(){return"expand-importer"},e}(),w=n.createClass({displayName:"ExpandImportOption",render:function(){var e;return e={"expand-imports-option":!0,"contacts-typeahead-option":!0},null!=this.props.className&&(e[this.props.className]=!0),O.li(L(this.props,{className:n.addons.classSet(e)}),O.div({className:"option-left"},R(p,{src:D("/static/images/icons/icon-import-vflOL9sCs.png"),srcHiRes:D("/static/images/icons/icon-import@2x-vfluE8TBO.png")})),O.div({className:"option-right"},O.div({className:"option-primary option-only"},P("Import contacts"))))}}),A=function(){function e(e){this.provider=e.provider,this.connected=e.connected}return e.prototype.getKey=function(){return"third-party-import"+this.provider},e}(),I=n.createClass({displayName:"ThirdPartyImportOption",propTypes:{import:n.PropTypes.object.isRequired},render:function(){var e,t,i,o,s;return s=this.props.import,o=s.provider,t=s.connected,i=t?P("Connected"):"",e={"third-party-option":!0,"contacts-typeahead-option":!0},null!=this.props.className&&(e[this.props.className]=!0),O.li(L(this.props,{className:n.addons.classSet(e)}),O.div({className:"option-left"},O.img({src:c.to_img(o)})),O.div({className:"option-right"},O.div({className:x({"option-primary":!0,"option-only":!t})},c.to_name(o)),t?O.div({className:"option-secondary"},P("Connected")):void 0))}}),{ContactsTypeaheadSelector:v,ContactsTypeaheadSelectorOption:y,ExpandImportOption:w,ThirdPartyImportOption:I}})}.call(this),function(){define("modules/clean/contacts/types",[],function(){var e;return e={EMAIL:0,FB:1,INVALID:2,NEW_STYLE_GROUP:4,DBX_ID:6}})}.call(this),function(){define("modules/clean/contacts/util",["modules/clean/contacts/types"],function(e){var t;return t=function(){function t(){}return t.activityUserToContact=function(t,n){return null==n&&(n=0),{dbx_account_id:t.unique_id,fname:t.fname,lname:t.lname,name:t.display_name,name_tokens:[t.fname,t.lname],email:t.email,type:e.DBX_ID,priority:n,photo_url:t.photo_circle_url}},t}()})}.call(this),function(){define("modules/clean/crypto",["external/sjcl"],function(e){var t;return t={},t.getRandomValues=function(t){var n,i,o,s;for(s=e.random.randomWords(t.length),n=i=0,o=t.length;o>=0?o>i:i>o;n=o>=0?++i:--i)t[n]=s[n];return t},t})}.call(this),function(){define("modules/clean/db_bubble",["jquery","modules/core/exception"],function(e,t){var n,i;return i=t.assert,n={position:function(t,n,o){var s,r,a,l,c,u,d;for(t=e(t).css({bottom:"auto",left:"auto",position:"absolute",right:"auto",top:"auto"}),i(t.find(".db-arrow").length,"db-arrow not found"),s=t.find(".db-arrow-border"),i(s.length,"db-arrow-border not found"),l=null,d=["top","right","bottom","left"],c=0,u=d.length;u>c;c++)if(a=d[c],t.hasClass("db-"+a+"-arrow")){l=a;break}return i(l,"No db-#{direction}-arrow class set"),"left"===l?r="left+"+s.outerWidth()+"px top-"+s.position().top+"px":"right"===l?r="right-"+s.outerWidth()+"px top-"+s.position().top+"px":"top"===l?r="left-"+s.position().left+"px top+"+s.outerHeight()+"px":"bottom"===l&&(r="left-"+s.position().left+"px bottom-"+s.outerHeight()+"px"),o||(o={top:"bottom",left:"right",bottom:"top",right:"left"}[l]),t.position({my:r,at:o,of:n,collision:"none"})}}})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/dbmodal_loading",["modules/clean/dbmodal","modules/clean/uirequest"],function(t,n){var i;return i=function(t){function i(e){i.__super__.constructor.call(this,e)}return e(i,t),i.prototype.on_show=function(){return this.fetch()},i.prototype.fetch=function(){return new n(this.$modal_window,this.options.endpoint_url,{data:this.options.parameters||{},subject_user:this.options.subject_user,html_in_error_msg:this.options.html_in_error_msg,error:function(e){return function(){return e.hide()}}(this)})},i.prototype.on_confirm_button_click=null,i.prototype.on_cancel_button_click=null,i}(t.DBModal)})}.call(this),function(){define("modules/clean/display_format",["modules/core/i18n"],function(e){var t,n,i;return t=e._,i=function(n,i){var o,s,r;return null==i&&(i=2),n=parseFloat(n),o=Math.abs(n),1024>o?(i=0,s=n,r=e.ungettext("byte","bytes",n)):921600>o?(s=n/1024,r=t("KB")):943718400>o?(s=n/1048576,r=t("MB")):966367641600>o||0===i&&1099511627776>n?(s=n/1073741824,r=t("GB")):(s=n/1099511627776,r=t("TB")),s=Math.round(s*Math.pow(10,i))/parseFloat(Math.pow(10,i)),s=s.toFixed(i),s+" "+r},n={format_bytes:i}})}.call(this),function(){define("modules/clean/dropbox_nav",["jquery","modules/clean/analytics","modules/clean/photos/photos_engagement_logger"],function(e,t,n){var i;return i=function(){function i(){e(".carousel-nav-item").click(function(e){return function(){return e.log_click("carousel_nav_link_click")}}(this)),e(".composer-nav-item").click(function(e){return function(){return e.log_click("composer_nav_link_click")}}(this)),e(".mailbox-nav-item").click(function(e){return function(){return e.log_click("mailbox_nav_link_click")}}(this)),e(".carousel-nav-item").click(function(){return n.log_and_send(n.CAROUSEL_NAV_LINK_CLICK)}),e(".photos-nav-item").click(function(){return n.log_and_send(n.PHOTOS_NAV_LINK_CLICK)})}return i.prototype.log_click=function(e){return t.WebMiscActivityLogger.log(e)},i}()})}.call(this),function(){define("modules/clean/event_emitter",["external/reflux"],function(e){return e.utils.EventEmitter})}.call(this),function(){define("modules/clean/events/rollback",["jquery","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/analytics","modules/clean/react/modal","modules/clean/ajax"],function(e,t,n,i,o,s,r,a,l){var c,u,d;return d=i._,u=r.SupportExperimentsWebLogger,c={configureAllLinks:function(t,n,i,o){return null==i&&(i=null),null==o&&(o=void 0),e(t).on("click",n,function(t){var n,s,r,l,p;return null!=i&&u.log_file_restore(i),n=e(t.target),p=n.data("user-id"),r=n.data("ns-id"),s=n.data("cs-id"),l=n.data("redirect"),null==l&&(l=!0),a.SimpleModal.show({title_text:d("Undo this deletion"),body_html:d("Are you sure you want to undo this deletion?"),confirm_text:d("Undo deletion"),confirm_callback:function(){return c.rollback(p,r,s,l,o)},cancel_text:d("Cancel")}),!1})},configureLink:function(t,i,o,s,r,l){return e(t).on("click",function(e){return e.stopPropagation(),a.SimpleModal.show({title_text:i,body_html:n.escape(o).toHTML(),confirm_text:d("Restore"),confirm_callback:function(){return c.rollback(s,r,l)},cancel_text:d("Cancel")}),!1})},rollback:function(e,n,i,r,a){var c;return null==a&&(a=void 0),c={},c[n]=i,l.WebProgressRequest({url:"/cmd/restore_changesets",data:{ns_to_cs:JSON.stringify(c)},subject_user:e,html_in_error_msg:!0,progress_text:d("Restoring files..."),success:function(){return o.success(d("Finished restoring files.")),"function"==typeof a&&a(),r?t.redirect(s({path:"/browse_cs/"+e+"/"+n+"/"+i})):void 0}})}}})}.call(this),function(){define("modules/clean/file_activity/api",["external/underscore","modules/core/types","modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/comments/models/immutable_comment_activity","modules/clean/comments/models/immutable_file_activity","modules/clean/promise"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D,M,F,U,B,V;return M=t.takes,O=t.returns,_=t.Maybe,u=t.Either,m=a.Promise,w={actorId:_(Number),oref:_(String),isBackgroundRequest:_(Boolean)},A=function(t){var i,o,s,r,a,l,c,u;return u=t.url,c=t.type,o=t.data,i=t.actorId,r=t.oref,s=t.isBackgroundRequest,l=s?n.SilentBackgroundRequestOref:n.WebRequestOref,a=new m(function(t,n){return l({url:u,type:c,data:e.extend({oref:r},o),subject_user:i,success:t,error:n})}),a.then(JSON.parse)},E=function(e){var t,n,i;if("error"===e.status)throw n=null!=(i=e.payload)?i.error_text:void 0,t=Error(n),t.payload=e.payload,t.error_text=n,t;return e.payload},S=function(e){var t,n;return n=E(e),t=e.bolt_data,[n,t]},C=function(e){var t;return t=new i.FileActivity(e),r.fromMutable(t)},l=e.extend({targetActivity:u(i.FileActivity,i.CommentActivity),context:Number,contextData:String,text:String,metadata:_(Object)},w),I=M(l,O(m,function(e){var t,n,o,r,a,l,c,u,d;return t=e.actorId,u=e.targetActivity,n=e.context,o=e.contextData,d=e.text,l=e.metadata,c=e.oref,a=e.isBackgroundRequest,r={activity_context:n,activity_context_data:o,comment_text:d,comment_metadata_json:null!=l?JSON.stringify(l):null},u instanceof i.CommentActivity&&(r.target_comment_activity_key=u.activity_key),A({actorId:t,url:"/file_activity/comment",type:"POST",data:r,oref:c,isBackgroundRequest:a}).then(E).then(function(e){var t;return t=new i.CommentActivity(e),s.fromMutable(t)})})),L=M(Number,O(m,function(e){var t;return t=new m(function(t,i){return n.SilentBackgroundRequestOref({url:"/file_activity/has_seen_comments_onboarding",type:"POST",success:t,error:i,subject_user:e})}),t.then(JSON.parse).then(E)})),c=e.extend({commentActivityKey:String,context:Number,contextData:String},w),k=M(c,O(m,function(e){var t,n,i,o,s,r;return t=e.actorId,n=e.commentActivityKey,i=e.context,o=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/comment/delete",type:"POST",data:{comment_key:n,activity_context:i,activity_context_data:o},oref:r,isBackgroundRequest:s}).then(E)})),g=e.extend({liked:Boolean,commentActivityKey:String,context:Number,contextData:String},w),B=M(g,O(m,function(e){var t,n,i,o,s,r,a;return t=e.actorId,r=e.liked,n=e.commentActivityKey,i=e.context,o=e.contextData,a=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/comment/like",type:"POST",data:{activity_key:n,activity_context:i,activity_context_data:o,liked:r},oref:a,isBackgroundRequest:s}).then(E)})),v=e.extend({enableComment:Boolean,context:Number,contextData:String},w),F=M(v,O(m,function(e){var t,n,i,o,s,r;return t=e.actorId,o=e.enableComment,n=e.context,i=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/feedback_setting",type:"POST",data:{activity_context:n,activity_context_data:i,feedback_off:!o},oref:r,isBackgroundRequest:s}).then(E)})),y=e.extend({resolved:Boolean,commentActivityKey:String,context:Number,contextData:String},w),V=M(y,O(m,function(e){var t,n,i,o,s,r,a;return t=e.actorId,a=e.resolved,n=e.commentActivityKey,i=e.context,o=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/comment/resolve",type:"POST",data:{activity_key:n,activity_context:i,activity_context_data:o,resolved:a},oref:r,isBackgroundRequest:s}).then(E)})),h=e.extend({commentActivityKey:String,context:Number,contextData:String},w),x=M(h,O(m,function(e){var t,n,i,o,s,r;return t=e.actorId,n=e.commentActivityKey,i=e.context,o=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/mark_comments_seen",type:"POST",data:{last_seen_comment_key:n,activity_context:i,activity_context_data:o},oref:r,isBackgroundRequest:s}).then(E)})),p=e.extend({context:Number,contextData:String},w),T=function(e){var t,n,o,s,r;return t=e.actorId,n=e.context,o=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/file_activity",type:"GET",data:{activity_context:n,activity_context_data:o,activity_type:i.ActivityType.FILE},oref:r,isBackgroundRequest:s})},N=M(p,O(m,function(e){return T(e).then(E).then(C)})),R=M(p,O(m,function(e){return T(e).then(S).then(function(e){var t,n;return t=e[0],n=e[1],[C(t),n]})})),d=e.extend({context:Number,contextDataList:Array},w),P=M(d,O(m,function(t){var n,o,s,r,a;return n=t.actorId,o=t.context,s=t.contextDataList,a=t.oref,r=t.isBackgroundRequest,A({actorId:n,url:"/file_activity/file_activity_batch",type:"GET",data:{activity_context:o,activity_context_data_batch:JSON.stringify(s),activity_type:i.ActivityType.FILE},oref:a,isBackgroundRequest:r}).then(function(t){return e.mapObject(t,C)})})),b=e.extend({targetUserEmail:_(String),subscribed:Boolean,context:Number,contextData:String},w),U=M(b,O(m,function(e){var t,n,i,o,s,r,a;return t=e.actorId,a=e.targetUserEmail,r=e.subscribed,n=e.context,i=e.contextData,s=e.oref,o=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/subscribe",type:"POST",data:{activity_context:n,activity_context_data:i,subscribed:r,target_user_identifier:a},oref:s,isBackgroundRequest:o}).then(E)})),f=e.extend({feedbackText:String,context:Number,contextData:String},w),D=M(f,O(m,function(e){var t,n,i,o,s,r;return t=e.actorId,o=e.feedbackText,n=e.context,i=e.contextData,r=e.oref,s=e.isBackgroundRequest,A({actorId:t,url:"/file_activity/product_feedback",type:"POST",data:{activity_context:n,activity_context_data:i,feedback_text:o},oref:r,isBackgroundRequest:s}).then(E)})),{sawCommentOnboarding:L,addComment:I,deleteComment:k,updateLikeComment:B,updateResolveComment:V,updateCommentSetting:F,markCommentsSeen:x,fetchFileActivity:N,fetchFileActivityWithBoltData:R,fetchFileActivities:P,updateFileActivitySubscription:U,submitProductFeedback:D}})}.call(this),function(){define("modules/clean/file_events",[],function(){var e;return e={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",COMPRESS:"db:compress",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add",FILE_ACTIVITY_UPDATE:"db:file_activity_update"}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/file_viewer_interface_controller",["jquery","modules/clean/activity/activity","modules/clean/comments/actions","modules/clean/comments/models/preview_types","modules/clean/comments/utils","modules/clean/event_emitter","modules/clean/frame_messenger","modules/clean/keycode"],function(t,n,i,o,s,r,a){var l,c;return l=n.ActivityContext,c=function(){function n(t,n,i){switch(this._handleMessageFromWindow=e(this._handleMessageFromWindow,this),this._handleMessageFromChild=e(this._handleMessageFromChild,this),this._getIframeQuery=e(this._getIframeQuery,this),this._prepareImageInterface=e(this._prepareImageInterface,this),this._preparePdfJsInterface=e(this._preparePdfJsInterface,this),this.dispatchEvent=e(this.dispatchEvent,this),this._notifyEventsTriggered=e(this._notifyEventsTriggered,this),this.registerEventsCallbacks=e(this.registerEventsCallbacks,this),this._eventsHandler=null,this._eventEmitter=new r,this._previewType=n,this._previewSelector=i,this._previewType){case o.PDFJS:this._preparePdfJsInterface(t);break;case o.IMAGE:this._prepareImageInterface()}}return n.prototype.registerEventsCallbacks=function(e){return this._eventsHandler=e},n.prototype._notifyEventsTriggered=function(e,t){return"function"==typeof this._eventsHandler?this._eventsHandler(e,t):void 0},n.prototype.addListener=function(e,t){return this._eventEmitter.on(e,t)},n.prototype.removeListener=function(e,t){return this._eventEmitter.off(e,t)},n.prototype.once=function(e,t){return this._eventEmitter.once(e,t)},n.prototype.on=n.prototype.addListener,n.prototype.off=n.prototype.removeListener,n.prototype.dispatchEvent=function(e,t){switch(this._previewType){case o.PDFJS:return this._frameMessenger.postMessageToChildren(e,t);case o.IMAGE:return window.postMessage(JSON.stringify({action:e,parameters:t}),"*")}},n.prototype.destroy=function(){var e;switch(this._eventEmitter.removeAllListeners(),this._eventsHandler=null,this._previewType){case o.PDFJS:return null!=(e=this._frameMessenger)?e.stopListening():void 0;case o.IMAGE:return window.removeEventListener("message",this._handleMessageFromWindow)}},n.prototype._preparePdfJsInterface=function(e){return this._frameMessenger=new a,this._frameMessenger.configureChildMessaging(this._getIframeQuery(e),t.proxy(this._handleMessageFromChild,this),["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","annotation-ui-enter","annotation-ui-over","annotation-ui-leave","annotation-ui-click","page-rendered","scroll","scale-change","on-keydown"]),this._frameMessenger.startListening()},n.prototype._prepareImageInterface=function(){return window.addEventListener("message",this._handleMessageFromWindow)},n.prototype._getIframeQuery=function(e){switch(e){case l.BROWSE_FILE_VIEWER:return this._previewSelector+" iframe";case l.SHARED_LINK_VIEW:return".preview-box iframe";default:return null}},n.prototype._handleMessageFromChild=function(e){return this._eventEmitter.emit(e.action,e.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(e.action,e.parameters):void 0},n.prototype._handleMessageFromWindow=function(e){var t,n,i;try{i=JSON.parse(e.data)}catch(e){return void(t=e)}return this._eventEmitter.emit(i.action,i.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(i.action,i.parameters):void 0},n}()})}.call(this),function(){"use strict";var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/flux/base_store",["modules/core/exception","modules/clean/flux/dispatcher"],function(t,n){var i,o,s;return o=t.assert,s=function(){var t,i;return i=!1,t=[],n.dispatch_begin=function(){return i=!0},n.dispatch_end=function(){var e,n,o,s;i=!1;try{for(s=[],n=0,o=t.length;o>n;n++)e=t[n],s.push(e());return s}finally{t.length=0}},function(n){return i?e.call(t,n)<0?t.push(n):void 0:n()}}(),i=function(){function t(e){null==e&&(e=null),"function"==typeof this._init&&this._init(),this._change_listeners=[],this._dispatcher=e||n,this.dispatchToken=this._dispatcher.register(this._new_payload_wrapper.bind(this))}return t.WIPE_TYPE="WIPE_ALL",t.prototype.destructor=function(){return this._dispatcher.unregister(this.dispatchToken),this.remove_all_change_listeners()},t.prototype.emit_change=function(){var e,t,n,i,o;for(i=this._change_listeners,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(s(e));return o},t.prototype.add_change_listener=function(t){return o(!(e.call(this._change_listeners,t)>=0)),this._change_listeners.push(t)},t.prototype.remove_change_listener=function(e){var t;return this._change_listeners=function(){var n,i,o,s;for(o=this._change_listeners,s=[],n=0,i=o.length;i>n;n++)t=o[n],t!==e&&s.push(t);return s}.call(this)},t.prototype.remove_all_change_listeners=function(){return this._change_listeners.length=0},t.prototype._new_payload_wrapper=function(e){var t;return(null!=e&&null!=(t=e.action)?t.type:void 0)===this.constructor.WIPE_TYPE&&"function"==typeof this._init&&this._init(),this._new_payload(e)},t.prototype._new_payload=function(){throw new Error("Abstract method - must be implemented")},t}()})}.call(this),function(){define("modules/clean/flux/flux_store",function(){var e;return e=function(){function e(e){this._listeners=[],this._dispatcher=e,this._dispatchToken=this._dispatcher.register(this.__invokeOnDispatch.bind(this)),this.__hasChanged=!1}return e.prototype.teardown=function(){return this._dispatcher.unregister(this._dispatchToken)},e.prototype.getDispatcher=function(){return this._dispatcher},e.prototype.getDispatchToken=function(){return this._dispatchToken},e.prototype.addListener=function(e){return this._listeners.push(e),function(t){return function(){var n;return t._listeners=function(){var t,i,o,s;for(o=this._listeners,s=[],t=0,i=o.length;i>t;t++)n=o[t],n!==e&&s.push(n);return s}.call(t)}}(this)},e.prototype.hasChanged=function(){return this.__hasChanged},e.prototype.__emitChange=function(){return this.__hasChanged=!0},e.prototype.__onDispatch=function(){throw new Error("__onDispatch should be overridden by subclass")},e.prototype.__invokeOnDispatch=function(e){var t,n,i,o,s;if(this.__hasChanged=!1,this.__onDispatch(e),this.__hasChanged){for(o=this._listeners,s=[],n=0,i=o.length;i>n;n++)t=o[n],s.push(t());return s}},e}()})}.call(this),function(){var e={}.hasOwnProperty;define("modules/clean/form",["jquery","external/purify","modules/core/exception","modules/core/notify","modules/clean/ajax","modules/core/cookies","modules/constants/request"],function(t,n,i,o,s,r,a){var l,c;return c=i.assert,l={submit:function(e,t,n,i){return s.FormWebRequest({url:e.attr("action"),data:this.collect_data(e),skipErrorHandling:!0,success:function(e,i,o){var s,r,a;return r=l.parse_response(o.responseText),a=r[0],s=r[1],a?t(s):n(s)},error:function(){return n(o.DEFAULT_ERROR)},complete:i})},collect_data:function(e){var n,i,o,s,r,a,l;for(n={},a=e.find("input, select, textarea"),i=0,s=a.length;s>i;i++)if(o=a[i],r=t(o).attr("name")){if("checkbox"===t(o).attr("type"))l=t(o).prop("checked")?"True":"";else if("radio"===t(o).attr("type")){if(!t(o).prop("checked"))continue;l=t(o).val()}else l=t(o).val();r in n?("string"==typeof n[r]&&(n[r]=[n[r]]),n[r].push(l)):n[r]=l}return n},parse_response:function(e){var t,n,i,s;if(0!==e.indexOf("err:"))return[!0,e];n=e.substr(4);try{return s=JSON.parse(n),[!1,s]}catch(e){return t=e,[!1,n||o.DEFAULT_ERROR]}},parse_error:function(e){var t,n;if("string"==typeof e)return[!0,e];if("object"==typeof e)for(n in e)if(t=e[n],"message_text"in t)return[!0,t.message_text];return[!1,o.DEFAULT_ERROR]},add_vars:function(i,o){var s,r,a,l;a=[];for(r in o)e.call(o,r)&&(s=t("<input>",{type:"hidden",name:r}),s.val(o[r]),l=n.sanitize(s.prop("outerHTML")),a.push(i.append(l)));return a},post_request:function(e,i,o){var s,l;return null==i&&(i={}),null==o&&(o={}),c(null!=e,"post_request missing action"),s=t("<form>",{action:e,method:"POST",target:o.target?o.target:void 0}),i.t=r.read(a.JS_CSRF_COOKIE),this.add_vars(s,i),l=t(n.sanitize(s.prop("outerHTML"))),t("body").append(l),l.submit()}}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/frame_messenger",["jquery"],function(n){var i;return i=function(){function i(){this.handleUntrustedMessage=e(this.handleUntrustedMessage,this),Object.defineProperty(this,"trustedParentOriginForPosting",{get:function(){return this._trustedParentOriginForPosting}}),Object.defineProperty(this,"trustedChildOriginForPosting",{get:function(){var e,t,i,o;if(null!=this._trustedChildOriginForPosting)return this._trustedChildOriginForPosting;for(e=n(this._childIframeQuery),t=0,o=e.length;o>t&&(i=e[t],!this._validateChildOriginForPosting(i.src));t++);return this._trustedChildOriginForPosting}})}return i._ALLOWED_CHILD_ORIGINS=["https://www.dropboxstatic.com","https://cf.dropboxstatic.com","https://www.dropbox.com","https://dl-doc.dropbox.com","https://dl-web.dropbox.com","https://dl.dropboxusercontent.com","null"],i._ALLOWED_PARENT_ORIGINS=["https://www.dropbox.com"],i._REQUEST_PARENT_ORIGIN_POLL_DELAY=100,i.prototype._childIframeQuery=null,i.prototype._trustedChildOriginForPosting=null,i.prototype._trustedParentOriginForPosting=null,i.prototype._validActionsFromChild=[],i.prototype._validActionsFromParent=[],i.prototype._trustedMessageFromChildHandler=null,i.prototype._trustedMessageFromParentHandler=null,i.prototype._parentMessageQueue=[],i.prototype._requestParentOriginPollRetry=null,i.prototype._onParentReady=null,i.prototype.resetOriginsForPosting=function(){return this._trustedChildOriginForPosting=null,this._trustedParentOriginForPosting=null},i.prototype.configureChildMessaging=function(e,t,n){return this._childIframeQuery=e,this._trustedChildOriginForPosting=null,this._validActionsFromChild=n,this._trustedMessageFromChildHandler=t},i.prototype.configureParentMessaging=function(e,t,n){return null==n&&(n=null),this._trustedParentOriginForPosting=null,this._validActionsFromParent=t,this._trustedMessageFromParentHandler=e,this._onParentReady=n},i.prototype.startListening=function(){return window.addEventListener("message",this.handleUntrustedMessage),null!=this._validActionsFromParent&&this._validActionsFromParent.length>0&&null!=this._trustedMessageFromParentHandler&&this._requestParentOrigin(),null!=this._validActionsFromChild&&this._validActionsFromChild.length>0&&null!=this._trustedMessageFromChildHandler?this.postMessageToChildren("parent-ready"):void 0},i.prototype.stopListening=function(){return window.removeEventListener("message",this.handleUntrustedMessage)},i.prototype._getOriginFromUrl=function(e){var t;return t=document.createElement("a"),t.href=e,"https://"+t.hostname},i.prototype._isChildOriginAllowed=function(e){return t.call(this.constructor._ALLOWED_CHILD_ORIGINS,e)>=0||this._isDevVmOrigin(e)},i.prototype._isParentOriginAllowed=function(e){return t.call(this.constructor._ALLOWED_PARENT_ORIGINS,e)>=0||this._isDevVmOrigin(e)},i.prototype._isDevVmOrigin=function(e){var t;return t=e.match(/\.dev\.corp\.dropbox(static|usercontent)?\.com$/),(null!=t?t.length:void 0)>=1},i.prototype._validateChildOriginForPosting=function(e){var t;return t="null"===e?"*":this._getOriginFromUrl(e),"null"===e||this._isChildOriginAllowed(t)?(this._trustedChildOriginForPosting=t,!0):(console.warn("Untrusted message from child blocked: "+e),!1)},i.prototype.childIsValidated=function(){return null!=this._trustedChildOriginForPosting},i.prototype._validateParentOriginForPosting=function(e){var t,n,i,o,s,r,a;

if(r=this._trustedParentOriginForPosting,s=this._getOriginFromUrl(e),!this._isParentOriginAllowed(s))return console.warn("Untrusted message from parent blocked: "+e),!1;if(this._trustedParentOriginForPosting=s,this._parentMessageQueue.length>0){for(a=this._parentMessageQueue,t=0,n=a.length;n>t;t++)i=a[t],o=JSON.parse(i),this.postMessageToParent(o.action,o.parameters);this._parentMessageQueue=[]}return null!=this._trustedParentOriginForPosting&&null==r&&null!=this._onParentReady&&this._onParentReady(),!0},i.prototype.handleUntrustedMessage=function(e){var n,i,o,s,r;if(!this._isChildOriginAllowed(e.origin)&&!this._isParentOriginAllowed(e.origin))return void console.warn("Message received not in parent or child origin whitelist: "+e.origin);try{o=JSON.parse(e.data)}catch(e){return void(n=e)}return null!=o.action?"child-requesting-parent-origin"===o.action?void(this._validateChildOriginForPosting(e.origin)&&this.postMessageToChildren("parent-ready")):"parent-ready"===o.action?void this._validateParentOriginForPosting(e.origin):(s=o.action,t.call(this._validActionsFromChild,s)>=0&&this._validateChildOriginForPosting(e.origin)&&null!=this._trustedMessageFromChildHandler?void this._trustedMessageFromChildHandler(o):(r=o.action,void(t.call(this._validActionsFromParent,r)>=0&&this._validateParentOriginForPosting(e.origin)&&null!=this._trustedMessageFromParentHandler&&this._trustedMessageFromParentHandler(o)))):void 0},i.prototype._packagePostMessage=function(e,t){var n,i;return i=this.trustedChildOriginForPosting,n={action:e,parameters:t},JSON.stringify(n)},i.prototype.postMessageToChildElements=function(e,t,n){var i,o,s,r,a;if(null==n&&(n={}),null!=this.trustedChildOriginForPosting){for(r=this._packagePostMessage(t,n),a=[],i=0,s=e.length;s>i;i++)o=e[i],a.push(o.contentWindow.postMessage(r,this.trustedChildOriginForPosting));return a}},i.prototype.postMessageToChildren=function(e,t,i){var o;return null==t&&(t={}),null==i&&(i=null),null==i&&(i=this._childIframeQuery),o=n(i),this.postMessageToChildElements(o,e,t)},i.prototype.postMessageToParent=function(e,t){var n;return null==t&&(t={}),n=this._packagePostMessage(e,t),null==this.trustedParentOriginForPosting?void this._parentMessageQueue.push(n):window.parent.postMessage(n,this.trustedParentOriginForPosting)},i.prototype._requestParentOrigin=function(){var e;return window.parent.postMessage('{"action": "child-requesting-parent-origin"}',"*"),e=function(){return this._requestParentOriginPollRetry=null,null==this._trustedParentOriginForPosting?this._requestParentOrigin():void 0},setTimeout(n.proxy(e,this),this._REQUEST_PARENT_ORIGIN_POLL_DELAY)},i}()})}.call(this),function(){define("modules/clean/fuzzy",["external/underscore"],function(e){var t;return t={simpleFilter:function(e,n){return n.filter(function(n){return t.test(e,n)})},test:function(e,n){return null!==t.match(e,n)},match:function(e,t,n){var i,o,s,r,a,l,c,u,d,p,h,_,m,f;for(n=n||{},d=0,m=[],u=t.length,f=0,l=0,h=n.pre||"",p=n.post||"",s=n.caseSensitive&&t||t.toLowerCase(),i=void 0,o=void 0,e=n.caseSensitive&&e||e.toLowerCase(),c=0,_=[],r=0,a=0;u>c;)i=t[c],s[c]===e[d]?(i=h+i+p,a?a+=1:(r=c,a=1),d+=1,l+=1+l):(l=0,a&&(_.push([r,a]),a=0)),f+=l,m[m.length]=i,c++;return a&&_.push([r,a]),d===e.length?{highlighted:_,rendered:m.join(""),score:f}:null},filter:function(t,n,i){var o,s;return null==i&&(i={}),s=[],o=this._reduce.bind(this,t,i),e.reduce(n,o,s).sort(this._sort)},_reduce:function(e,n,i,o,s){var r,a;return a=o,n.extract&&(a=n.extract(o)),r=t.match(e,a,n),null!=r&&i.push({string:r.rendered,score:r.score,index:s,original:o}),i},_sort:function(e,t){var n;return n=t.score-e.score,n?n:e.index-t.index}}})}.call(this),function(){define("modules/clean/groups/api",["jquery","modules/clean/ajax","modules/clean/contacts/cache","modules/clean/viewer"],function(e,t,n,i){var o,s,r;return o=n.DefaultContactsCache,r={},s="/groups_ajax",r.ready=function(){},r.get_groups_for_user=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"get_groups_for_user",data:e,success:t})},r.get_group_info=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"get_group_info",data:e,success:t})},r.get_groups_for_team=function(e,t){return null==e&&(e={}),null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"get_groups_for_team",data:{},success:t})},r.get_users_for_group=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"get_users_in_group",data:e,success:t})},r.create_group=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"make_new_group",data:e,success:t,reload_contacts:!0})},r.create_group_with_users=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"make_new_group_with_users",data:e,success:t,reload_contacts:!0})},r.remove_group=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"remove_group",data:e,success:t,reload_contacts:!0})},r.rename_group=function(e,t,n){return null==n&&(n=function(){return{}}),r.metaserver_ajax({method:"rename_group",data:e,success:t,error:n,reload_contacts:!0})},r.add_users_to_group=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"add_users_to_group",data:e,success:t,reload_contacts:!0})},r.remove_user_from_group=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"remove_user_from_group",data:e,success:t,reload_contacts:!0})},r.change_group_member_type=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"change_group_member_type",data:e,success:t})},r.remove_namespace_from_group=function(e,t){return r.metaserver_ajax({method:"remove_namespace_from_group",data:e,success:t})},r.change_group_access_type=function(e,n){var o;return o=function(e,t,i){return n(i)},t.WebRequest({url:s+"/change_group_access_type",type:"post",data:e,subject_user:i.get_viewer().work_user,success:o})},r.make_group_join_request=function(e,t){return null==t&&(t=function(){return{}}),r.metaserver_ajax({method:"make_group_join_request",data:e,success:t})},r.refresh_account_photos=function(){var e,t;e=JSON.stringify(o.cached_contacts.contacts.map(function(e){return e.email})),t=function(e){var t,n,i,s;for(s=o.cached_contacts.contacts,n=0,i=s.length;i>n;n++)t=s[n],t.photo_url=e[t.email]},r.metaserver_ajax({method:"get_account_photo_urls_for_emails",data:{emails:e},success:t})},r.metaserver_ajax=function(n){var r,a,l,c;return c=s+"/"+n.method,a=n.reload_contacts||!1,l=function(t){var i,s;i=JSON.parse(t),i.ok&&(n.success(i.data),e(".error_msg").hide()),a&&o.load_contacts(s=!0)},r=function(t){var i;i=t.responseText,n.error&&(n.error(i.slice(4)),e(".error_msg").hide())},t.WebRequest({url:c,type:"post",data:n.data,subject_user:i.get_viewer().work_user,success:l,error:r})},r})}.call(this),function(){define("modules/clean/history",["external/modernizr","external/underscore","modules/core/browser","modules/core/exception","modules/core/uri"],function(e,t,n,i,o){var s,r;return r=i.assert,s=function(){var i,s,a,l,c,u,d,p,h,_,m,f,v;return i=new RegExp("#|;|\\?|:|@|&|=|\\+|\\$"),m=function(){var t,s,r;return r=void 0,e.history||-1===n.get_href().indexOf("#!")?(t=window.location.pathname,s=window.location.search,-1!==t.search(i)&&(t=String(o({path:t}))),r=t+s):r=n.get_href().split("#!").pop(),r},c=function(e,t){return String(o.parse(e).setQuery(t))},u=function(e){var t;return null==e&&(e=m()),t=e.split("?"),{url:e,path:t[0],qargs:o.parse(e).getQuery()}},s={},d={},f=m(),v=null,_=function(e){return"/"+e.split("/")[1]},p=function(){var e,t,n;return n=f,t=u(n),e=_(t.path),e in s?(s[e](t.path.substr(e.length+1),t.qargs),!0):!1},h=function(){var e,t,n;return n=f,t=u(n),e=_(t.path),e in d?d[e](t.path.substr(e.length+1),t.qargs):void 0},a=function(e,t){var n,i;return i=_(e),n=_(t),i!==n?h():void 0},l=function(){var e;return e=m(),e!==f?(a(f,e),f=e,p()):void 0},{init:function(){return v?void 0:(f=m(),v=setInterval(l,50))},add_callback:function(e,t,n){return this.init(),r("string"==typeof e,"DBHistory prefix is not a string"),r(0===e.indexOf("/"),"DBHistory prefix must be absolute"),r(1===e.count("/"),"multi-component prefixes arent supported"),s[e]=t,n?void 0:p()},add_exit_callback:function(e,t){return this.init(),r("string"==typeof e,"DBHistory prefix is not a string"),r(0===e.indexOf("/"),"DBHistory prefix must be absolute"),r(1===e.count("/"),"multi-component prefixes arent supported"),d[e]=t},fire_callbacks:function(){return p()},_build_url_for_state_change:function(e,t){var n;return r("string"==typeof e,"DBHistory path is not a string"),r(0===e.indexOf("/"),"DBHistory path must be absolute"),r(-1===e.indexOf("//"),"DBHistory path contains //"),n=c(e,t)},_pre_state_change:function(e){return e===f?!1:(a(f,e),!0)},_post_state_change:function(e){return null==e&&(e=!0),f=m(),e?p():void 0},replace_state:function(e,t){var n;return n=this._build_url_for_state_change(e,t),this._pre_state_change(n)&&window.history.replaceState?(window.history.replaceState(null,null,n),this._post_state_change()):void 0},push_state:function(n,i,o){var s;return null==o&&(o={}),o=t.defaults(o,{immediatelyRestoreState:!0}),r(-1===n.indexOf("?"),"DBHistory path contains ?"),r(-1===n.indexOf("#"),"DBHistory path contains #"),s=this._build_url_for_state_change(n,i),this._pre_state_change(s)?(e.history?window.history.pushState(null,null,s):window.location.href="#!"+s,this._post_state_change(o.immediatelyRestoreState)):void 0},update_query_param:function(t,n){var i;return e.history?(i=this.deconstruct_url(),i.qargs[t]=n,this.replace_state(i.path,i.qargs)):void 0},remove_query_param:function(t){var n;return e.history?(n=this.deconstruct_url(),delete n.qargs[t],this.replace_state(n.path,n.qargs)):void 0},get_url:m,construct_url:c,deconstruct_url:u,URL_ESCAPE_REGEX:i}}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_annotations",["jquery","modules/clean/image_viewer_annotation_interface","modules/clean/image_viewer_annotation_renderer","modules/clean/gandalf_util","modules/clean/image_preview_util"],function(t,n,i,o,s){var r;return r=function(){function r(){this.onResize=e(this.onResize,this),this._onScroll=e(this._onScroll,this),this._handleMessage=e(this._handleMessage,this),this.isImagePreviewAnnotationCreationEnabled=o.getGandalfRule("dw-comments-annotation-image-previews"),this.imagePreviewUtil=new s}return r.prototype.onImageLoad=function(e,t){return null==e&&(e=null),null==t&&(t=null),this.reset(),this.switchPreviewCallback=e,this.resizeImageCallback=t,this.$imageContainer=this.imagePreviewUtil.getPreviewImageContainer(),this.$image=this.imagePreviewUtil.getPreviewImage(),this._prepareAnnotations()},r.prototype._prepareAnnotations=function(){return this.isImagePreviewAnnotationCreationEnabled&&this._prepareAnnotationInterface(),this.annotationRenderer=new i,window.addEventListener("resize",this.onResize),this.imagePreviewUtil.getPreviewImageWrapper().on("scroll",this._onScroll),window.addEventListener("message",this._handleMessage),this._postPageRendered()},r.prototype._prepareAnnotationInterface=function(){var e,i;return 0===this.imagePreviewUtil.getAnnotationCreationContainer().length&&(e=this.imagePreviewUtil.getPreviewImageWrapper(),i=t("<div class='"+this.imagePreviewUtil.ANNOTATION_CREATION_CONTAINER+"' />"),this.$annotationCreationContainer=i.appendTo(e)),this._resizeAnnotationCreationContainer(),this.annotationInterface=new n,t(window).on("mouseup.image",this.annotationInterface.onMouseUpCallback).on("mousedown.image",this.annotationInterface.onMouseDownCallback).on("mousemove.image",this.annotationInterface.onMouseMoveCallback).on("keydown.image",this.annotationInterface.onKeyDownCallback),setTimeout(function(e){return function(){var t;return e._resizeAnnotationCreationContainer(),null!=(t=e.annotationInterface)?t.onScaleChangeCallback():void 0}}(this),0)},r.prototype._handleMessage=function(e){var t,n,i,o,s,r,a,l,c,u,d,p,h;try{s=JSON.parse(e.data)}catch(e){return void(i=e)}switch(s.action){case"draw-annotation":return null!=(r=this.annotationRenderer)?r.renderAnnotation(s.parameters):void 0;case"remove-annotation":return n=s.parameters.commentActivity,null!=(a=this.annotationRenderer)?a.removeAnnotation(n):void 0;case"remove-all-annotations":return null!=(l=this.annotationRenderer)?l.removeAllAnnotations():void 0;case"enable-annotation-creation":return null!=(c=this.annotationInterface)?c.enableAnnotations():void 0;case"disable-annotation-creation":return null!=(u=this.annotationInterface)?u.disableAnnotations():void 0;case"hide-annotation":return null!=(d=this.annotationInterface)?d.onHideAnnotation():void 0;case"scroll-to-annotation":return n=s.parameters.commentActivity,null!=(p=this.annotationRenderer)?p.highlightAnnotation(n):void 0;case"file-feedback-ui-ready":return this._postPageRendered();case"switch-preview":return h=s.parameters.thumbnailUrl,n=s.parameters.commentActivity,t=function(e){return function(){return n?setTimeout(function(){var t;return null!=(t=e.annotationRenderer)?t.highlightAnnotation(n):void 0},300):void 0}}(this),"function"==typeof this.switchPreviewCallback?this.switchPreviewCallback(h,t):void 0}},r.prototype._postPageRendered=function(){return this._postMessage("page-rendered")},r.prototype._postMessage=function(e,t){return null==t&&(t=null),window.postMessage(JSON.stringify({action:e,parameters:t}),"*")},r.prototype._onScroll=function(){var e;return null!=(e=this.annotationInterface)?e.onScrollCallback():void 0},r.prototype.onResize=function(e){var t,n;return null==e&&(e=!0),null!=(t=this.annotationRenderer)&&t.removeAllAnnotations(),this._postMessage("scale-change"),n=function(e){return function(){var t;return e._resizeAnnotationCreationContainer(),e._postPageRendered(),null!=(t=e.annotationInterface)&&t.onScaleChangeCallback(),"function"==typeof e.resizeImageCallback?e.resizeImageCallback():void 0}}(this),clearTimeout(this.scaleChangeTimer),e?this.scaleChangeTimer=setTimeout(n,100):n()},r.prototype._resizeAnnotationCreationContainer=function(){var e,t,n;return null!=(e=this.$annotationCreationContainer)&&e.height(this.$image.height()),null!=(t=this.$annotationCreationContainer)&&t.width(this.$image.width()),null!=(n=this.$annotationCreationContainer)?n.css("margin",this.$image.css("margin")):void 0},r.prototype.removeAnnotations=function(){var e;return null!=(e=this.annotationRenderer)?e.removeAllAnnotations():void 0},r.prototype.reset=function(){var e,n;return null!=(e=this.annotationRenderer)&&e.reset(),this.isImagePreviewAnnotationCreationEnabled&&(t(window).off("mouseup.image").off("mousedown.image").off("mousemove.image").off("keydown.image"),this.imagePreviewUtil.getPreviewImageWrapper().off("scroll",this.onResize),null!=(n=this.annotationInterface)&&n.reset()),window.removeEventListener("resize",this.onResize),window.removeEventListener("message",this._handleMessage),this._postMessage("reset-file-feedback-ui")},r}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_cache",[],function(){var t;return t=function(){function t(n){this._evict_lru=e(this._evict_lru,this),this._add_newest_node=e(this._add_newest_node,this),this._remove_node=e(this._remove_node,this),this._insert=e(this._insert,this),this.get_image=e(this.get_image,this),this.preload_image=e(this.preload_image,this),n&&(t.MAX_SIZE=n)}return t.MAX_SIZE=100,t.image_nodes_by_url={},t.oldest=null,t.newest=null,t.size=0,t.prototype.preload_image=function(e){return this._insert(e)},t.prototype.get_image=function(e){var t;return t=this._insert(e),this._remove_node(t),this._add_newest_node(t),t.image},t.prototype._insert=function(e){var n,i;return t.image_nodes_by_url[e]?t.image_nodes_by_url[e]:(i=new Image,i.src=e,n={url:e,image:i},t.image_nodes_by_url[e]=n,this._add_newest_node(n),n)},t.prototype._remove_node=function(e){var n,i;return t.oldest===e&&(t.oldest=e.newer),t.newest===e&&(t.newest=e.older),n=e.newer,i=e.older,null!=n&&(n.older=i),null!=i&&(i.newer=n),e.newer=null,e.older=null,t.size--},t.prototype._add_newest_node=function(e){return 0===t.size?(t.oldest=e,t.newest=e):(e.older=t.newest,t.newest.newer=e,t.newest=e),t.size++,this._evict_lru()},t.prototype._evict_lru=function(){var e;return t.size>t.MAX_SIZE?(e=t.oldest,this._remove_node(e),delete t.image_nodes_by_url[e.url]):void 0},t}()})}.call(this),function(){define("modules/clean/image_preview_util",["jquery","modules/clean/annotations/annotation"],function(e,t){var n,i,o,s;return n=t.Annotation,o=t.AnnotationTypes,i=t.AnnotationSubtypes,s=function(){function t(){}return t.prototype.PREVIEW_IMAGE_CONTAINER="preview-image-container",t.prototype.PREVIEW_IMAGE_WRAPPER="preview-image-wrapper",t.prototype.PREVIEW_IMAGE="preview-image",t.prototype.ANNOTATION_CREATION_CONTAINER="db-annotation-creation-container",t.prototype.ANNOTATION_LAYER_CSS="db-annotation-layer",t.prototype.ANNOTATION_CANVAS_LAYER_CSS="db-annotation-canvas-layer",t.prototype.getPreviewImageContainer=function(){return e("."+this.PREVIEW_IMAGE_CONTAINER)},t.prototype.getPreviewImageWrapper=function(){return e("."+this.PREVIEW_IMAGE_WRAPPER)},t.prototype.getPreviewImage=function(){return this.getPreviewImageContainer().find("."+this.PREVIEW_IMAGE)},t.prototype.getPreviewImageElement=function(){return this.getPreviewImage()[0]},t.prototype.getAnnotationCreationContainer=function(){return e("."+this.ANNOTATION_CREATION_CONTAINER)},t.prototype.getAnnotationLayers=function(){return e("."+this.ANNOTATION_LAYER_CSS)},t.prototype.getAnnotationLCanvasLayer=function(){return e("."+this.ANNOTATION_CANVAS_LAYER_CSS)},t.prototype.convertAnnotationImagePointsToViewportCoordinates=function(e){var t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v;for(u=[],t=this.getPreviewImageElement(),h=t.offsetLeft,_=t.offsetTop,r=t.clientWidth,s=t.clientHeight,f=e.image_coordinates,o=0,l=f.length;l>o;o++){for(n=f[o],i=[],v=n.coordinates,a=0,c=v.length;c>a;a++)m=v[a],d=m.x*r+h,p=m.y*s+_,i.push({x:d,y:p});u.push(i)}return u},t.prototype.convertAnnotationViewportCoordinatesToImagePoints=function(e){var t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v;for(d=[],t=this.getPreviewImageElement(),s=t.getBoundingClientRect(),_=s.left,m=s.top,a=t.clientWidth,r=t.clientHeight,v=e.viewportCoordinates,o=0,c=v.length;c>o;o++){for(n=v[o],i=[],l=0,u=n.length;u>l;l++)f=n[l],p=(f.x-_)/a,h=(f.y-m)/r,i.push({x:p,y:h});d.push({coordinates:i})}return d},t}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_viewer_annotation_interface",["jquery","external/react","modules/clean/annotations/annotation","modules/clean/annotations/annotation_controller","modules/clean/image_preview_util","modules/clean/gandalf_util"],function(t,n,i,o,s,r){var a,l,c,u;return a=i.Annotation,c=i.AnnotationTypes,l=i.AnnotationSubtypes,u=function(){function i(){this.onAnnotationScaleChangeCallback=e(this.onAnnotationScaleChangeCallback,this),this.onAnnotationScrollCallback=e(this.onAnnotationScrollCallback,this),this.onAnnotationEndDragCallback=e(this.onAnnotationEndDragCallback,this),this.onAnnotationStartDragCallback=e(this.onAnnotationStartDragCallback,this),this.onAnnotationPlacedCallback=e(this.onAnnotationPlacedCallback,this),this.onAnnotationHiddenCallback=e(this.onAnnotationHiddenCallback,this),this.onScaleChangeCallback=e(this.onScaleChangeCallback,this),this.onScrollCallback=e(this.onScrollCallback,this),this.onKeyDownCallback=e(this.onKeyDownCallback,this),this.onMouseUpCallback=e(this.onMouseUpCallback,this),this.onMouseMoveCallback=e(this.onMouseMoveCallback,this),this.onMouseDownCallback=e(this.onMouseDownCallback,this),this.onHideAnnotation=e(this.onHideAnnotation,this),this._prepareAnnotationCoords=e(this._prepareAnnotationCoords,this),this._prepareAnnotationController=e(this._prepareAnnotationController,this),this.imagePreviewUtil=new s,this.controllerEventHandlers={onMouseMoveCallback:t.noop,onMouseDownCallback:t.noop,onMouseUpCallback:t.noop,onHideAnnotation:t.noop,onScrollCallback:t.noop,onScaleChangeCallback:t.noop,onKeyDownCallback:t.noop},this.isAnnotationMarkerEnabled=r.getGandalfRule("dw-comments-annotation-marker"),this.isAnnotationRegionEnabled=r.getGandalfRule("dw-comments-annotation-region"),this.isAnnotationCreationEnabled=!1,this._prepareAnnotationController()}return i.prototype._sendToParent=function(e,t){return null==t&&(t=null),window.postMessage(JSON.stringify({action:e,parameters:t}),"*")},i.prototype._isOnAnnotationCreationContainer=function(e){return t(e.target).closest(".db-annotation-creation-container").length>0},i.prototype._isOnAnnotationUI=function(e){return t(e.target).parents(".db-annotation-layer").length>0},i.prototype._destroyAnnotationController=function(){var e;return e=this.imagePreviewUtil.getAnnotationLCanvasLayer(),n.unmountComponentAtNode(null!=e?e[0]:void 0),e.remove()},i.prototype._prepareAnnotationController=function(){var e,i,s;return i=this.imagePreviewUtil.getAnnotationCreationContainer(),0===i.find("."+this.imagePreviewUtil.ANNOTATION_CANVAS_LAYER_CSS).length?(s=t("<div class='"+this.imagePreviewUtil.ANNOTATION_CANVAS_LAYER_CSS+"' />"),this.$parentContainerEl=s.appendTo(i),e=this.$parentContainerEl.offset(),this.annotationController=n.render(n.createElement(o,{parentContainerOffset:e,controllerEventHandlers:this.controllerEventHandlers,onAnnotationHiddenCallback:this.onAnnotationHiddenCallback,onAnnotationPlacedCallback:this.onAnnotationPlacedCallback,onAnnotationStartDragCallback:this.onAnnotationStartDragCallback,onAnnotationEndDragCallback:this.onAnnotationEndDragCallback,onAnnotationScrollCallback:this.onAnnotationScrollCallback,onAnnotationScaleChangeCallback:this.onAnnotationScaleChangeCallback,isAnnotationMarkerEnabled:this.isAnnotationMarkerEnabled,isAnnotationHighlightEnabled:!1,isAnnotationRegionEnabled:this.isAnnotationRegionEnabled,isAnnotationCreationEnabled:this.isAnnotationCreationEnabled}),this.$parentContainerEl.get(0))):void 0},i.prototype._prepareAnnotationCoords=function(e){return null!=e&&(e=this._addTranslatedImagePoints(e)),e},i.prototype._addTranslatedImagePoints=function(e){return e.image_coordinates=this.imagePreviewUtil.convertAnnotationViewportCoordinatesToImagePoints(e),e},i.prototype._updateOffset=function(e){var t;return null!=(t=this.annotationController)?t.setProps({parentContainerOffset:this.$parentContainerEl.offset()},function(){return"function"==typeof e?e():void 0}):void 0},i.prototype.enableAnnotations=function(){var e;return t("html").addClass("annotation"),this.isAnnotationCreationEnabled=!0,null!=(e=this.annotationController)?e.setProps({isAnnotationCreationEnabled:this.isAnnotationCreationEnabled}):void 0},i.prototype.disableAnnotations=function(){var e;return t("html").removeClass("annotation"),this.isAnnotationCreationEnabled=!1,(null!=(e=this.annotationController)?e.isMounted():void 0)?this.annotationController.setProps({isAnnotationCreationEnabled:this.isAnnotationCreationEnabled}):void 0},i.prototype.reset=function(){var e,t;return this.disableAnnotations(),this._destroyAnnotationController(),null!=(e=this.imagePreviewUtil)&&null!=(t=e.getAnnotationCreationContainer())?t.remove():void 0},i.prototype.onHideAnnotation=function(){var e;return null!=(e=this.controllerEventHandlers)?e.onHideAnnotation():void 0},i.prototype.onMouseDownCallback=function(e){var t;return!this._isOnAnnotationUI(e)&&this._isOnAnnotationCreationContainer(e)&&null!=(t=this.controllerEventHandlers)?t.onMouseDownCallback(e):void 0},i.prototype.onMouseMoveCallback=function(e){var t;return(this._isOnAnnotationCreationContainer(e)||this._isOnAnnotationUI(e))&&null!=(t=this.controllerEventHandlers)?t.onMouseMoveCallback(e):void 0},i.prototype.onMouseUpCallback=function(e){var t;return(this._isOnAnnotationCreationContainer(e)||this._isOnAnnotationUI(e))&&null!=(t=this.controllerEventHandlers)?t.onMouseUpCallback(e):void 0},i.prototype.onKeyDownCallback=function(e){var t;return t=e.keyCode||e.which||e.charCode,this._sendToParent("on-keydown",{keyCode:t})},i.prototype.onScrollCallback=function(){var e;return this._updateOffset(null!=(e=this.controllerEventHandlers)?e.onScrollCallback:void 0)},i.prototype.onScaleChangeCallback=function(e){var t;return this._updateOffset(null!=(t=this.controllerEventHandlers)?t.onHideAnnotation:void 0),this._sendToParent("scale-change",e)},i.prototype.onAnnotationHiddenCallback=function(){return this._sendToParent("annotation-hidden")},i.prototype.onAnnotationPlacedCallback=function(e){return this._sendToParent("annotation-placed",{annotation:this._prepareAnnotationCoords(e)})},i.prototype.onAnnotationStartDragCallback=function(){return this._sendToParent("annotation-start-drag")},i.prototype.onAnnotationEndDragCallback=function(e){return this._sendToParent("annotation-end-drag",{annotation:this._prepareAnnotationCoords(e)})},i.prototype.onAnnotationScrollCallback=function(e){return this._sendToParent("scroll",{annotation:this._prepareAnnotationCoords(e)})},i.prototype.onAnnotationScaleChangeCallback=function(e){return this._sendToParent("scale-change",{annotation:this._prepareAnnotationCoords(e)})},i}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_viewer_annotation_renderer",["jquery","external/react","modules/clean/annotations/annotation","modules/clean/annotations/annotation_highlight_ui","modules/clean/annotations/annotation_marker_ui","modules/clean/annotations/annotation_region_ui","modules/clean/image_preview_util"],function(t,n,i,o,s,r,a){var l,c,u,d;return l=i.Annotation,u=i.AnnotationTypes,c=i.AnnotationSubtypes,d=function(){function i(){this.onAnnotationLeaveCallback=e(this.onAnnotationLeaveCallback,this),this.onAnnotationEnterCallback=e(this.onAnnotationEnterCallback,this),this.onAnnotationClickCallback=e(this.onAnnotationClickCallback,this),this._renderAnnotation=e(this._renderAnnotation,this),this.renderAnnotation=e(this.renderAnnotation,this),this.removeAnnotation=e(this.removeAnnotation,this),this.imagePreviewUtil=new a}return i.prototype._isAnnotationAlreadyRendered=function(e){return t("."+this.imagePreviewUtil.ANNOTATION_LAYER_CSS+"[data-comment-activity-key='"+e+"']").length>0},i.prototype.removeAnnotation=function(e){var i;return this._isAnnotationAlreadyRendered(e.activity_key)?(i=t("."+this.imagePreviewUtil.ANNOTATION_LAYER_CSS+"[data-comment-activity-key='"+e.activity_key+"']").get(0),n.unmountComponentAtNode(i),i.remove()):void 0},i.prototype.removeAllAnnotations=function(){return this.reset()},i.prototype.reset=function(){var e,t,i,o;for(t=this.imagePreviewUtil.getAnnotationLayers(),i=0,o=t.length;o>i;i++)e=t[i],n.unmountComponentAtNode(e);return t.remove()},i.prototype.highlightAnnotation=function(e){var n;return this._isAnnotationAlreadyRendered(e.activity_key)?(n=t("."+this.imagePreviewUtil.ANNOTATION_LAYER_CSS+"[data-comment-activity-key='"+e.activity_key+"']"),n.removeClass("start-highlight-animation"),n.width(n.width()),n.addClass("start-highlight-animation")):void 0},i.prototype.renderAnnotation=function(e){var t,n,i,a;if(null!=e.annotation&&null!=e.commentActivity&&(t=l.createAnnotationFromDict(e.annotation),i=e.commentActivity,null!=(null!=t?t.type:void 0)&&!this._isAnnotationAlreadyRendered(i.activity_key))){switch(n=null,t.type){case u.MARKER:n=s;break;case u.HIGHLIGHT:n=o;break;case u.REGION:n=r}if(null!=n)return a=null!=e.options?e.options:{},this._renderAnnotation(n,t,i,a)}},i.prototype._renderAnnotation=function(e,i,o,s){var r,a,l;return a=this.imagePreviewUtil.getPreviewImageWrapper(),(null!=a?a.length:void 0)>0?(i.viewportCoordinates=this.imagePreviewUtil.convertAnnotationImagePointsToViewportCoordinates(i),l=t("<div class='"+this.imagePreviewUtil.ANNOTATION_LAYER_CSS+"' />"),l.attr({"data-comment-activity-key":o.activity_key}),r=l.appendTo(a).get(0),n.render(n.createElement(e,{annotation:i,commentActivity:o,options:s,onAnnotationClickCallback:this.onAnnotationClickCallback,onAnnotationEnterCallback:this.onAnnotationEnterCallback,onAnnotationOverCallback:this.onAnnotationOverCallback,onAnnotationLeaveCallback:this.onAnnotationLeaveCallback}),r)):void 0},i.prototype._sendToParent=function(e,t){return null==t&&(t=null),window.postMessage(JSON.stringify({action:e,parameters:t}),"*")},i.prototype.onAnnotationClickCallback=function(e){return this._sendToParent("annotation-ui-click",e)},i.prototype.onAnnotationEnterCallback=function(e){return this._sendToParent("annotation-ui-enter",e)},i.prototype.onAnnotationOverCallback=function(){return{}},i.prototype.onAnnotationLeaveCallback=function(e){return this._sendToParent("annotation-ui-leave",e)},i}()})}.call(this),function(){define("modules/clean/immutability_helper",["external/underscore","external/react","modules/core/exception","modules/core/types"],function(e,t,n,i){var o,s,r,a,l,c,u,d,p,h,_,m,f;return r=n.assert,h=i.takes,u=i.returns,o=i.Either,s=i.Func,m=t.addons.update,f=h(o(Object,Array),Array,Function,function(e,t,n){var i,o;return o=function(e,t){var n;return n={},n[""+t]=e,n},i=t.reduceRight(o,{$apply:n}),m(e,i)}),d=function(e,t,n){return f(e,t,function(){return n})},a=h(o(Object,Array),Array,function(e,t){var n;return n=function(e,t){return null!=e?e[t]:void 0},t.reduce(n,e)}),l=function(e,t){return m(e,{$merge:t})},c=function(e,t){return m(e,{$push:t})},_=function(e,t){return m(e,{$unshift:t})},p=function(e,t){return m(e,{$splice:t})},{updateIn:f,setIn:d,getIn:a,splice:p,unshift:_,push:c,merge:l}})}.call(this),function(){define("modules/clean/js_environment",[],function(){return{isBrowser:function(){return"undefined"!=typeof window&&null!==window},isTest:function(){return"undefined"!=typeof jasmine&&null!==jasmine}}})}.call(this),function(){define("modules/clean/legacy_ui_button",["jquery"],function(e){var t;return t=function(){var t;return t=e(document),e(document).on("mouseover.ui-button",".ui-button",function(){return e(this).addClass("over")}).on("mouseout.ui-button",".ui-button",function(){return e(this).removeClass("over")}).on("mousedown.ui-button",".ui-button",function(){return e(this).addClass("down")}).on("click.ui-button",".ui-button",function(){var n;return n=e(this),n.hasClass("ui-button-dropdown")&&(n.hasClass("active")?t.trigger("dropdownClosed",[1]):t.trigger("dropdownOpened",[1])),n.toggleClass("active")}),t.on("click.ui-button",function(n){var i,o,s;return i=e(n.target),o=i.closest(".ui-button.active"),s=0,e(".ui-button.active").not(o).each(function(){var t;return t=e(this),t.hasClass("active")&&t.hasClass("ui-button-dropdown")&&(s+=1),t.removeClass("active")}),t.trigger("dropdownClosed",[s])}).on("mouseup.ui-button",function(){return e(".ui-button.down").removeClass("down")})}})}.call(this),function(){define("modules/clean/loggers/file_preview_logger",["modules/clean/ajax","modules/clean/react/file_viewer/constants","modules/clean/uuid"],function(e,t,n){var i,o,s;return o=t.EventTypes,i={},i[o.FILE_VIEWER_CLOSED]="viewer_closed",i[o.FILE_PREVIEW_ATTEMPT_STARTED]="preview_attempted",i[o.FILE_PREVIEW_SUPPORT_CONFIRMED]="support_confirmed",i[o.FILE_PREVIEW_SUPPORT_DENIED]="support_denied",i[o.FILE_PREVIEW_DOWNLOAD_SUCCEEDED]="download_succeeded",i[o.FILE_PREVIEW_DOWNLOAD_FAILED]="download_failed",i[o.FILE_PREVIEW_RENDER_SUCCEEDED]="render_succeeded",i[o.FILE_PREVIEW_RENDER_FAILED]="render_failed",new(s=function(){function t(){this._clearTimeline()}return t.prototype._initFileViewerSession=function(){return this.fileViewerSessionId=n.v4({allowInsecure:!0})},t.prototype._initFilePreviewSession=function(e){return this.filePreviewSessionId=n.v4({allowInsecure:!0}),this._clearTimeline(),this._setFile(e)},t.prototype._clearTimeline=function(){return this.filePreviewTimeline={}},t.prototype._isEventInTimeline=function(e){return e in this.filePreviewTimeline},t.prototype._addToTimeline=function(e){return this.filePreviewTimeline[e]={timestamp:Date.now()}},t.prototype._getSerializedTimeline=function(){
var e,t,n,i,o;n={},t=this.filePreviewTimeline;for(e in t)i=t[e],o=this._timelineKey(e),n[o]=i.timestamp;return n},t.prototype._timelineKey=function(e){var t;return t=i[e],t+"_ts"},t.prototype._setFile=function(e){return this.file=e},t.prototype._clearState=function(){return delete this.fileViewerSessionId,delete this.filePreviewSessionId,delete this.file,this._clearTimeline()},t.prototype._log=function(t,n){var o;return null==this.fileViewerSessionId||null==this.filePreviewSessionId?void console.warn("Attempting to log %o before a file viewer or preview session has been initiated"):t in i?null==this.file?void console.warn("No file has been initiated"):null!=n&&n!==this.file?void console.warn("Passed in file does not match previous file"):this._isEventInTimeline(t)?void 0:(this._addToTimeline(t),this._lastLoggedEventType=t,o={event_name:i[t],file_viewer_session_id:this.fileViewerSessionId,file_preview_session_id:this.filePreviewSessionId,file_ns_id:this.file.ns_id,file_sjid:this.file.sjid,file_preview_timeline:JSON.stringify(this._getSerializedTimeline())},e.AuthenticatedRequest({url:"/log/file_preview",data:o})):void console.warn("Unknown event type: %o",t)},t.prototype.logEvent=function(e,t){switch(null==t&&(t=null),e){case o.FILE_VIEWER_OPENED:return this._initFileViewerSession();case o.FILE_VIEWER_CLOSED:return this._log(e,t),this._clearState();case o.FILE_PREVIEW_ATTEMPT_STARTED:return this._initFilePreviewSession(t),this._log(e,t);case o.FILE_PREVIEW_SUPPORT_CONFIRMED:if(this._lastLoggedEventType===o.FILE_PREVIEW_ATTEMPT_STARTED)return this._log(e,t);break;case o.FILE_PREVIEW_SUPPORT_DENIED:if(this._lastLoggedEventType===o.FILE_PREVIEW_ATTEMPT_STARTED)return this._log(e,t);break;case o.FILE_PREVIEW_DOWNLOAD_SUCCEEDED:if(this._lastLoggedEventType===o.FILE_PREVIEW_SUPPORT_CONFIRMED)return this._log(e,t);break;case o.FILE_PREVIEW_DOWNLOAD_FAILED:if(this._lastLoggedEventType===o.FILE_PREVIEW_SUPPORT_CONFIRMED)return this._log(e,t);break;case o.FILE_PREVIEW_RENDER_SUCCEEDED:if(this._lastLoggedEventType===o.FILE_PREVIEW_DOWNLOAD_SUCCEEDED)return this._log(e,t);break;case o.FILE_PREVIEW_RENDER_FAILED:if(this._lastLoggedEventType===o.FILE_PREVIEW_DOWNLOAD_SUCCEEDED)return this._log(e,t)}},t}())})}.call(this),function(){define("modules/clean/loggers/file_viewer_logger",["jquery","modules/constants/python","modules/clean/analytics","modules/clean/previews/util"],function(e,t,n,i){var o,s,r,a,l;return o=t.FileViewModeType,s=t.FileViewPlatformType,r=t.FileViewTargetType,l=i.PreviewHelper,a=function(){function t(){}return t.start=function(){return n.UserActivityLogger.start("web","file_view_first_page_rendered"),n.PreviewActivityLogger.start("file_view_first_page_rendered"),n.FileViewLogger.start()},t.logPageRendered=function(t,i){var o,s,r,a,c,u,d;for(t=t,o=l.get_extension(t),a=e.extend(i.attributes,{total_time:-1,file_ext:o,source:"file-viewer",originalSize:null!=t.bytes?t.bytes:0,docPreviewStatus:t.doc_preview_status}),u=i.stats,s=0,r=u.length;r>s;s++)d=u[s],c=function(){switch(d.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}}(),a[c]=d.end-d.start;return n.UserActivityLogger.stop("web","file_view_first_page_rendered",a),n.PreviewActivityLogger.stop("file_view_first_page_rendered",{file_ext:o,extra:JSON.stringify(a)})},t.logView=function(e,t,i,o,r,a,c){var u;return null==a&&(a=1),null==c&&(c=!1),u={user_id:null!=t?t.id:void 0,target:i,platform:s.WEB,ns_id:e.ns_id,sjid:e.sjid,ns_path:e.ns_path,origin:o,action:r,shared_link_url:null,extra:{file_ext:l.get_extension(e),file_bytes:e.bytes,file_mtime:e.ts,preview_type:e.preview_type,preview_status:e.doc_preview_status,time_taken:-1,in_progress:c,is_team:1===(null!=t?t.is_team:void 0),paid:1===(null!=t?t.paid:void 0),file_view_attempts:a}},n.FileViewLogger.stop(u)},t}()})}.call(this),function(){define("modules/clean/multiaccount_login",["jquery","modules/core/browser","modules/core/controller_helpers","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/viewer","modules/clean/dbmodal","modules/clean/teams/team_assume_user_personal_locked_modal"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p;return p=i.assert,d=o._,c=a.DBModal,u=function(){function i(){}return i.$element=function(){return e("#db-modal-multiaccount-login-modal")},i.set_during_login_callback=function(e){return p(!this._during_login_callback,"already have a during_login_callback"),this._during_login_callback=e},i.show_modal=function(i){var o,a,l,u,h;return null==i&&(i={}),r.get_viewer().is_team_assume_user_session?this.show_personal_account_disabled_modal():(this.$element=e.isFunction(this.$element)?this.$element():this.$element,p(null!=(a=this.$element)?a.length:void 0,"MultiaccountLogin needs its @$element to be set"),p(!(null!=i.on_success&&null!=i.success_href),"on_success and success_href are mutually exclusive"),null!=i.user?h=i.user:null!=i.user_id?h=r.get_viewer().get_user_by_id(i.user_id,!0):null!=i.role&&(h=r.get_viewer().get_user_by_role(i.role,!0)),p(null!=h,"invalid user"),l=h.role,p(!r.get_viewer().is_user_signed_in(h),"called MultiaccountLogin for a user that's already signed in"),u="personal"===l?d("Sign in to your personal Dropbox"):d("Sign in to your %(team_name)s Dropbox").format({team_name:r.get_viewer().team_name}),o=this.$element.find("form"),n.get_controller(o).reset(),n.get_controller(o).set_input_value("login_email",h.email),this.auth_success_callback=function(e){return function(){var n;return r.get_viewer()._sign_in_all_users(),n=function(n){return null!=n?(s.error(n),r.get_viewer()._sign_out_user_by_id(h.id),void e.modal.hide()):null!=i.success_href?t.get_uri().toString()!==i.success_href?t.redirect(i.success_href):t.reload():(e.modal.hide(),"function"==typeof i.on_success?i.on_success():void 0)},null!=e._during_login_callback&&null==i.success_href?e._during_login_callback(h,n):n(),!1}}(this),e(document).off("db:multilogin:success"),e(document).on("db:multilogin:success",this.auth_success_callback),this.modal=new c({element_id:"multiaccount-login-modal"}),this.modal.show(),this.modal.set_title(u),this.$element.find('input[name="login_password"]').focus())},i.show_page_login_modal=function(e){var t,n,i,o,s,a,l;for(l=r.get_viewer(),i=null,s=l.get_users(!0),t=0,n=s.length;n>t;t++)if(a=s[t],!l.is_user_signed_in(a)){i=a;break}return i?(o={user:i},"string"==typeof e?o.success_href=e:"function"==typeof e&&(o.on_success=e),this.show_modal(o),!1):void 0},i.show_personal_account_disabled_modal=function(){var e;return e=r.get_viewer(),l.AssumePersonalLockedModal.show({displayName:e.display_name,teamName:e.team_name}),!1},i}(),INLINE_JS.MultiaccountLogin=u,u})}.call(this),function(){define("modules/clean/notification_feed",["jquery","modules/clean/ajax","modules/clean/notserver","modules/constants/legacy","modules/core/i18n","modules/clean/analytics"],function(e,t,n,i,o,s){var r,a,l,c,u;return r=n.NotClients,u=o.ungettext,a=s.ProEventsLogger,l={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:!1,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:!1,_has_acked:!1,_feed_load_callbacks:[],THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var t,n,i;this.refresh_feed(),e("#event-feed-container").scroll(function(){return l._has_more&&l._scroller_within_offset_to_bottom(l.SCROLLING_OFFSET)?l._append_event_rows(!1):void 0}),e("#event-feed-container").on("mousewheel",this.scrolling.bind(this)),e("#event-feed-container").on("DOMMouseScroll",this.scrolling.bind(this)),e("#event-feed").on("click",this._mouseclick.bind(this)),n=[];for(i in r)t=r[i],n.push(this._subscribe_user(t));return n},refresh_feed:function(e,n){var i,o,s;return s=function(t){return function(i){var o,s,r,a;return t._unread_count=i.unread_count,t._notifications=i.notifications,i.meta_notification&&(s=i.meta_notification,r=t._identifier(s),r!==t._get_last_acked_meta_not_id()&&t._unread_count++,t._current_meta_not_id=r,t._notifications.push(s)),t._has_acked=!1,t._notifications.sort(t._sort_key),t._append_event_rows(!0),t.update_jewel_ui(t._unread_count),null!=e&&null!=n?(a=e.get_user_id(),o=i.latest_nid[a],e.handler_success(n,{nid:i.latest_nid[a]})):void 0}}(this),o=function(e){return function(){var t,n,i,o;for(e._is_retrieving_feed=!1,o=e._feed_load_callbacks,n=0,i=o.length;i>n;n++)(t=o[n])();return e._feed_load_callbacks=[]}}(this),(i=function(i){return function(){var r;return i._is_retrieving_feed=!0,r={count:i.MAX_ROWS_TO_RETRIEVE},t.WebRequest({url:"/web/notifications/retrieve",data:r,dataType:"json",success:s,complete:o,error:function(){return null!=e&&null!=n?e.handler_failure(n):void 0}})}}(this))()},ack_unread_notifications:function(){return!this._has_acked&&this._unread_count>0?(this.update_jewel_ui(0),this._get_last_acked_meta_not_id()!==this._current_meta_not_id&&(this._set_last_acked_meta_not_id(this._current_meta_not_id),this._acked_ids[this._current_meta_not_id]=!0),t.WebRequest({url:"/web/notifications/ack_all",dataType:"json",success:function(e){return function(t){var n,i,o,s,r;for(r=[],n=0,o=t.length;o>n;n++)s=t[n],i=e._identifier(s),e._acked_ids[i]=!0,r.push(e._append_event_rows());return r}}(this)}),this._has_acked=!0):void 0},update_jewel_ui:function(t){var n;return n="",t>0&&(n=u("%(count)s new","%(count)s new",t,{comment:"new notification count"}).format({count:t})),e("#new-notification-count--descriptive").text(n),e("#new-notification-count").text(t).toggleClass("show",t>0),t>0&&e(".notifications-bell").addClass("shake"),setTimeout(function(){return e(".notifications-bell").removeClass("shake")},500)},scrolling:function(t){var n;return t.originalEvent&&(t=t.originalEvent),n=t.detail?-40*t.detail:t.wheelDelta,!this._has_more&&0>=n&&this._scroller_within_offset_to_bottom(0)?t.preventDefault():n>=0&&0===e("#event-feed-container")[0].scrollTop?t.preventDefault():void 0},clear_cached_client_states:function(){return this._is_retrieving_feed?void 0:(this._acked_ids={},this._append_event_rows(!0))},_subscribe_user:function(e){var t;return t=e.subscribe_user({name:"NotificationFeedUpdater",handler:function(n){return function(){return n.refresh_feed(e,t)}}(this)})},_append_event_rows:function(t){var n,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y;for(null==t&&(t=!1),t?(e("#event-feed").empty(),this._shown={},this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)):(this._num_event_rows+=this.NUM_ROWS_TO_APPEND,this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)),_=e(".feed-row").size(),o=[],f=this._notifications,u=a=0,d=f.length;d>a&&(h=f[u],!(_>=this._num_event_rows));u=++a)l=this._identifier(h),l in this._shown||(this._shown[l]=!0,g=h.status,r=e(h.notification_div),v=r,e("#event-feed").append(v),_++,c=r.find("img").get(0),c&&(n=e(c),n.attr("alt",""),s=n.attr("data-src"),s&&(this._thumb_cache[s]?(p=this._thumb_cache[s],n.attr("src",p),this._add_thumbnail_frame(n)):s in this._thumb_cache||(this._thumb_cache[s]=!1,y=h.user_id,n.data("uid",y),n.data("not-identifier",l),o.push(c)))),r.hasClass("feed-row")||(r=r.find(".feed-row")),h.type_id===i.NOTIFICATION_TYPE_META&&(r.addClass("meta-feed"),l in this._acked_ids||l!==this._get_last_acked_meta_not_id()||r.addClass("read")),g===this.USER_NOTIFICATION_STATUS_INVISIBLE&&(r.addClass("invisible"),l in this._acked_ids&&delete this._acked_ids[l]),g===this.USER_NOTIFICATION_STATUS_READ&&(l in this._acked_ids||r.addClass("read")));return m=function(t){return function(n){var i,o,s;return i=e(n),t._add_thumbnail_frame(i),l=i.data("not-identifier"),s=i.attr("data-src"),o=i.attr("src"),t._thumb_cache[s]=o}}(this),o.length&&require(["modules/clean/photos/legacy_thumb_loader"],function(e){return function(t){var n;return(n=t.batch_load_thumbs)(o,e.THUMBS_BATCH_SIZE,m)}}(this)),this._has_more=this._num_event_rows<this._notifications.length,0===e(".feed-row").length?e("#event-feed-container").addClass("empty"):e("#event-feed-container").removeClass("empty")},_identifier:function(e){return e.user_id+" "+e.type_id+" "+e.target_object_key},_sort_key:function(e,t){return e.sticky&&!t.sticky?-1:t.sticky&&!e.sticky?1:e.status===l.USER_NOTIFICATION_STATUS_UNREAD&&t.status!==l.USER_NOTIFICATION_STATUS_UNREAD?-1:t.status===l.USER_NOTIFICATION_STATUS_UNREAD&&e.status!==l.USER_NOTIFICATION_STATUS_UNREAD?1:t.feed_time-e.feed_time},_get_last_acked_meta_not_id:function(){return window.localStorage?localStorage.getItem(this.LAST_ACKED_META_ID_KEY):void 0},_set_last_acked_meta_not_id:function(e){return window.localStorage?localStorage.setItem(this.LAST_ACKED_META_ID_KEY,e):void 0},_add_thumbnail_frame:function(t){return e(t).addClass("thumbnail"),e(t).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(t){var n,i;return n=e(t.target),n.is("a")&&n.hasClass("view")&&(t.preventDefault(),i=n.attr("data-mount"),window.open(i)),n.closest("a").hasClass("meta-notification-sign-in-needed")?(t.preventDefault(),require(["modules/clean/multiaccount_login"],function(e){return function(t){return t.show_page_login_modal(function(){return e.refresh_feed()})}}(this))):void 0},_scroller_within_offset_to_bottom:function(t){var n;return n=e("#event-feed-container")[0],n.scrollTop+n.offsetHeight+t>=n.scrollHeight},log_if_sf_invite_overquota_view:function(){var e,t,n,i,o,s,r;if(e=function(e){return function(){return e.log_if_sf_invite_overquota_view()}}(this),this._is_retrieving_feed)return void this._feed_load_callbacks.push(e);for(r=this._notifications.slice(0,3),n=0,i=r.length;i>n;n++)if(o=r[n],s=o.sf_invite_overquota,t="overquota"===s?"view_shared_folder_notification_already_oq":"will_be_overquota"===s?"view_shared_folder_notification_near_oq":void 0)return void a.log(t)}},c=function(){var t,n;return t=e(document),n=function(){return e(".notification-button").hasClass("bubble-dropdown-target--active")},e(".notification-button").click(function(){return require(["dropbox"]),l.ack_unread_notifications(),n()?l.log_if_sf_invite_overquota_view():l.clear_cached_client_states()})},{UserNotifier:l,initNotificationButton:c}})}.call(this),function(){define("modules/clean/notifications/file_watcher",["jquery","external/underscore","modules/clean/notserver","modules/clean/revisions/file_revisions_iterator"],function(e,t,n,i){var o,s,r,a,l,c,u;return r=n.NotClients,u={},l=function(e){return r[e.id]},c=function(e,t){var n,i;return n=e.fq_path,i=t.id,n in u||(u[n]={}),i in u[n]||(u[n][i]=new o(e,t)),u[n][i]},o=function(){function n(t,n){var i,o;this.file=t,this.user=n,this.subscriptions=[],i=l(this.user),o=i.subscribe_sfj({name:"FileWatcher",handler:function(t){return function(){var n;return n=new e.Deferred,n.done(function(){return i.handler_success(o,{ns_map:{}})}),n.fail(function(){return i.handler_failure(o)}),t.checkForUpdates(n)}}(this)})}return n.prototype.subscribe=function(e){return this.subscriptions.push(e)},n.prototype.unsubscribe=function(e){return this.subscriptions=t.reject(this.subscriptions,e)},n.prototype.checkForUpdates=function(e){var t,n,o;return 0===this.subscriptions.length?void e.resolve():(n=new i(this.file.fq_path,this.user.id),o=n.next(1),o.done(function(e){var n,i;return i=e.revisions[0],n=i.file,t(n)}),o.then(e.resolve,e.reject),t=function(e){return function(t){var n,i,o,s,r;for(o=e.subscriptions,s=[],n=0,i=o.length;i>n;n++)r=o[n],s.push(function(e){return setTimeout(function(){return t.sjid>e.latestSjid?e.fulfill(t):void 0},0)}(r));return s}}(this))},n}(),s=function(){function e(e,t,n){this.file=e,this.user=t,this.onFulfill=n,this.latestSjid=this.file.sjid}return e.prototype.fulfill=function(e){return this.file=e,this.latestSjid=e.sjid,this.onFulfill(e)},e.prototype.cancel=function(){var e;return e=c(this.file,this.user),e.unsubscribe(this)},e}(),a={},a.subscribe=function(e,t,n){var i,o;return l(t)?(i=new s(e,t,n),o=c(e,t),o.subscribe(i),i):void 0},a._reset=function(){return u={}},a})}.call(this),function(){define("modules/clean/notifications/updated_file_notification",["jquery","modules/core/i18n","modules/core/notify"],function(e,t,n){var i,o,s;return s=t._,i=10,o=function(){function t(e){this.refresh=e,this._render()}return t.prototype.hide=function(){return this._isShowing()&&n.clear(),delete this._notification},t.prototype._render=function(){var t,o,r,a;return t=e("<span></span>").text(s("Someone edited this file.")),a=e("<span></span>").html("&nbsp;"),r=e("<a/>").text(s("Refresh")),r.on("click",this._hideAndRefresh.bind(this)),o=e("<span></span>").append(t).append(a).append(r),this._notification=n.success(o,i)},t.prototype._isShowing=function(){return null!=this._notification&&n.isShown()&&n.current()===this._notification},t.prototype._hideAndRefresh=function(){return this.hide(),this.refresh()},t}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/open_with",["external/underscore","modules/clean/browse_interface","modules/clean/filepath","modules/clean/gandalf_util","modules/core/uri"],function(t,n,i,o,s){var r;return r=function(){function r(){}var a,l,c;return r.PRELOAD_URLS={},r.MAX_SUPPORTED_FILE_SIZE_B=157286400,a=["com.adobe.Reader","Acrord32.exe","com.adobe.Acrobat","Acrobat.exe"],l=[{id:"excel",ext:["ods","xlsb","xlsm","xlsx"],icon:"excel",name:"Microsoft Excel Online"},{id:"powerpoint",ext:["odp","ppsx","pptx"],icon:"powerpoint",name:"Microsoft PowerPoint Online"},{id:"word",ext:["odt","docm","docx"],icon:"word",name:"Microsoft Word Online"},{id:"wopitest",ext:["wopitest"],icon:"word",name:"WopiTest"}],c=function(n){var o,s;return s=i.filename(n),o=i.file_extension(s).toLowerCase(),t.find(l,function(t){return e.call(t.ext,o)>=0})},r.get_open_handler_for=function(e,t){var i,o;return o=c(e.fq_path),o&&r.is_app_supported(o.id)?(i=s.encode_parts(e.fq_path),{icon:o.icon,name:o.name,uri:"/ow/msft/edit"+n.get_browse_root(t)+i}):null},r.file_supported=function(e){return!!c(e.fq_path)},r.is_adobe_app=function(t){return e.call(a,t)>=0},r.is_app_supported=function(e){switch(e){case"word":return o.getGandalfRule("wopi-edit-word");case"excel":return o.getGandalfRule("wopi-edit-excel");case"powerpoint":return o.getGandalfRule("wopi-edit-powerpoint");case"wopitest":return o.getGandalfRule("wopi-edit-wopitest");default:return!1}},r}(),__CONDITIONAL_JS__.OpenWith=r,r})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/openwith/logger",["jquery","modules/clean/ajax"],function(t,n){var i,o;return i=function(){function e(){}return e.log=function(e,t,i){return i=i||{},i.vendor=e,n.AuthenticatedRequest({url:"/ow/js_log",data:{evt:t,extra:JSON.stringify(i)}})},e}(),o=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.log=function(e,t){return i.__super__.constructor.log.call(this,"msft",e,t)},i.log_postmessage_received=function(e,t,n){var o,s,r,a,l;for(o={user_id:e,wopi_id:t},l=["origin","timeStamp","data"],s=0,a=l.length;a>s;s++)r=l[s],r in n&&(o[r]=n[r]);return i.log("postmessage_received",o)},i.log_postmessage_sent=function(e,t,n,o){var s,r,a,l,c;for(s={user_id:e,wopi_id:t,postmsg_url:n},c=["MessageId","SendTime","Values"],r=0,l=c.length;l>r;r++)a=c[r],a in o&&(s[a]=o[a]);return i.log("postmessage_sent",s)},i.log_conflict_modal_shown=function(e,t,n){var o;return o={user_id:e,wopi_id:t},i.log(n,o)},i.log_open_button_pressed=function(e,t,i,o){return n.AuthenticatedRequest({url:"/ow/log_open_button_pressed",data:{user_id:e,server_path:i+":"+o,file_extension:t}})},i}(i),__CONDITIONAL_JS__.OpenWithMicrosoftLogger=o,{OpenWithLogger:i,OpenWithMicrosoftLogger:o}})}.call(this),function(){define("modules/clean/page_role_observer",["modules/core/exception"],function(e){var t,n;return n=e.assert,new(t=function(){function e(){this._listeners=[]}return e.prototype.addListener=function(e){return n("function"==typeof e,"PageRoleState.addListener expects a function, got: "+typeof e),this._listeners.push(e)},e.prototype.removeListener=function(e){var t;return n("function"==typeof e,"PageRoleState.removeListener expects a function, got: "+typeof e),this._listeners=function(){var n,i,o,s;for(o=this._listeners,s=[],n=0,i=o.length;i>n;n++)t=o[n],t!==e&&s.push(t);return s}.call(this)},e.prototype.removeAllListeners=function(){return this._listeners=[]},e.prototype.emit=function(e){var t,n,i,o,s;for(o=this._listeners.slice(),s=[],n=0,i=o.length;i>n;n++)t=o[n],s.push(t(e));return s},e}())})}.call(this),function(){define("modules/clean/pagination_manager",["modules/clean/ajax","modules/constants/viewer","modules/core/notify","modules/core/i18n"],function(e,t,n,i){var o,s;return s=i._,o=function(){function i(){}var o,r;return o=function(){function e(e,t){this.userRole=e,this.hasMoreItems=t}return e.prototype.areAllItemsReady=function(e){return null==e&&(e=this.userRole),e===t.ROLE_BOTH?!(this.hasMoreItems[t.ROLE_PERSONAL]||this.hasMoreItems[t.ROLE_WORK]):!this.hasMoreItems[e]},e.prototype.invalidateHasMore=function(){var e,t;e=[];for(t in this.hasMoreItems)e.push(this.hasMoreItems[t]=!0);return e},e.prototype.addDataToAjax=function(e){return e.role=this.areAllItemsReady()?t.ROLE_BOTH:this.userRole},e}(),r=function(){function e(e){this.hasMoreItems=e}return e.prototype.areAllItemsReady=function(){return!this.hasMoreItems},e.prototype.invalidateHasMore=function(){return this.hasMoreItems=!0},e.prototype.addDataToAjax=function(){},e}(),i.prototype.initialize=function(e,t,n,i,o){return this.ajaxURL=n,this.newDataCallback=o,this.autoFetching=!1,this.mode=new r(e.has_more_items),this.keyName=t,this.items={},this.pages=[],this.nextRequestVoucher=e.next_request_voucher,this.userID=i,this._addPage(e.items)},i.prototype.areAllItemsReady=function(e){return this.mode.areAllItemsReady(e)},i.prototype._addPage=function(e){var t,i,o,r,a,l;for(l=[],a=[],t=0,r=e.length;r>t;t++){if(i=e[t],o=i[this.keyName],null==o)return void n.warning(s("Invalid server response"));null==this.items[o]&&(this.items[o]=i,a.push(i),l.push(o))}return this.pages.push(l),this.newDataCallback(this,a)},i.prototype.startAutoFetching=function(){return this.autoFetching=!0,this.fetchNext()},i.prototype.stopAutoFetching=function(){return this.autoFetching=!1},i.prototype.setUserRole=function(e){return this.mode=new o(e,this.mode.hasMoreItems)},i.prototype.reSync=function(e){var n;return null==e&&(e=!1),e&&(this.nextRequestVoucher=null,this.items={},this.pages=[]),n=this.autoFetching&&this.mode.areAllItemsReady(t.ROLE_BOTH),this.mode.invalidateHasMore(),n?this.startAutoFetching():void 0},i.prototype.fetchNext=function(){var i;return this.mode.areAllItemsReady(t.ROLE_BOTH)?void 0:(i={},this.nextRequestVoucher&&(i.voucher=this.nextRequestVoucher),this.mode.addDataToAjax(i),e.WebRequest({url:this.ajaxURL,data:i,subject_user:this.userID,success:function(e){return function(t){return t=JSON.parse(t),e.nextRequestVoucher=t.next_request_voucher,e.mode.hasMoreItems=t.has_more_items,e.autoFetching&&e.fetchNext(),e._addPage(t.items)}}(this),error:function(){return function(){return n.error()}}(this)}))},i.prototype.loadedPageCount=function(){return this.pages.length},i.prototype.getLoadedPage=function(e){var t,n,i,o,s;if(o=[],s=this.pages[e],null==s)return null;for(t=0,i=s.length;i>t;t++)n=s[t],o.push(this.items[n]);return o},i.prototype.getLastLoadedPage=function(){return this.getLoadedPage(this.loadedPageCount()-1)},i}()})}.call(this),function(){define("modules/clean/payments/cash",[],function(){var e,t,n,i;return i=function(){function e(){}return e._groupSymbol=",",e._decimalSymbol=".",e._minusSignSymbol="-",e._currencyFormatMap={USD:"$%v"},e.set_locale_number_format=function(t,n,i){e._groupSymbol=null!=t?t:",",e._decimalSymbol=null!=n?n:".",e._minusSignSymbol=null!=i?i:"-"},e.set_currency_format_map=function(t){e._currencyFormatMap=t},e._formatAmountThousandsHelper=function(t){var n;return n=Math.abs(parseInt(t)).toFixed(0)+"",n.length<=3?n:e._formatAmountThousandsHelper(n.substr(0,n.length-3))+e._groupSymbol+n.substr(n.length-3)},e.roundCurrency=function(e,t,n){return null==t&&(t="USD"),null==n&&(n=2),e%1===0&&(n=0),this.formatCurrency(e,t,n)},e.formatCurrency=function(t,n,i,o){var s,r,a,l;return null==n&&(n="USD"),null==i&&(i=2),null==o&&(o=!1),"JPY"===n&&(i=0),r=e.formatNumber(t,i),a=(null!=(l=e._currencyFormatMap[n])?l.replace("%v",r):void 0)||r+" "+n,o?(s=a.indexOf(e._decimalSymbol),-1===s?[a,""]:[a.slice(0,s+1),a.slice(s+1)]):a},e.formatNumber=function(t,n){return null==n&&(n=2),(0>t?e._minusSignSymbol:"")+e._formatAmountThousandsHelper(t)+(n>0?e._decimalSymbol+t.toFixed(n).split(".")[1]:"")},e}(),t=function(){function e(e,t){this.cash1=e,this.cash2=t}return e}(),n=function(){function e(){}return e}(),e=function(){function e(e,t){if(this.currency=t,!e&&0!==e||!this.currency)throw new n;this.amount=parseFloat(e)}return e.prototype.add=function(n){if(this.currency!==n.currency)throw new t(self,n);return new e(this.amount+n.amount,this.currency)},e.prototype.subtract=function(t){return this.add(new e(-t.amount,t.currency))},e.prototype.multiply=function(t){return new e(this.amount*t,this.currency)},e.prototype.divide=function(t){return new e(this.amount/t,this.currency)},e.prototype.round=function(t){var n;return null==t&&(t=2),n=Math.pow(10,t),new e(Math.round(this.amount*n)/n,this.currency)},e.prototype.toString=function(e){return null==e&&(e=2),"JPY"===this.currency&&(e=0),i.roundCurrency(this.amount,this.currency,e)},e.fromObject=function(t){return new e(t.amount,t.currency)},e}(),{CashUtil:i,CashCurrenciesDoNotMatch:t,CashNeedsAmountAndCurrency:n,Cash:e}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/payments/credit_card_util",[],function(){var t;return t={_credit_card_info_map:null,setCreditCardInfoMap:function(e){this._credit_card_info_map=e},getAllTypes:function(){var e,t;return function(){var n,i;n=this._credit_card_info_map,i=[];for(t in n)e=n[t],i.push(t);return i}.call(this)},getValidCardTypesForCountryCode:function(t){var n,i,o,s;s=[],o=this._credit_card_info_map;for(i in o)n=o[i],(e.call(n.accepted_countries,"all")>=0||e.call(n.accepted_countries,t)>=0)&&s.push(i);return s},isValidCardTypeForCountryCode:function(t,n){return e.call(this.getValidCardTypesForCountryCode(n),t)>=0},getNameForType:function(e){return this._credit_card_info_map[e].name}}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/payments/dfb_util",["jquery","external/underscore","modules/clean/payments/cash","modules/clean/payments/validation","modules/core/exception"],function(t,n,i,o,s){var r,a,l,c,u;return r=i.Cash,u=s.assert,c=function(){function e(e,t,n,i,o,s,r){this.plan_ids=e,this.schedule_ids=t,this.license_ids_and_counts=n,this.currencies=i,this.country_code=o,this.zip_code=s,this.vat_id=r,this.renew=!1,this.discount_ratio=0}return e.prototype.set_only_license_count=function(e){var t;return t=Object.keys(this.license_ids_and_counts)[0],this.license_ids_and_counts[t]=e},e.prototype.get_only_license_count=function(){var e;return e=Object.keys(this.license_ids_and_counts)[0],this.license_ids_and_counts[e]},e.prototype.set_country_code=function(e){this.country_code=e},e.prototype.set_zip_code=function(e){this.zip_code=e},e.prototype.set_currencies=function(e){this.currencies=e},e.prototype.set_renew=function(e){this.renew=e},e.prototype.set_discount_ratio=function(e){this.discount_ratio=e},e.prototype.set_vat_id=function(e){return this.vat_id=""!==e&&o.validate_vat(this.country_code,e)?e:""},e.prototype.cache_key=function(){var e;return this.currencies&&(e=this.currencies.join(",")),[this.plan_ids.join(","),this.schedule_ids.join(","),this.get_only_license_count(),e,this.country_code,this.zip_code,this.vat_id,this.renew,this.discount_ratio].join(":")},e.prototype.to_json=function(){var e;return e=this.renew?{renew:1}:{},e=n.extend(e,{plan_ids:JSON.stringify(this.plan_ids),schedule_ids:JSON.stringify(this.schedule_ids),license_ids_and_counts:JSON.stringify(this.license_ids_and_counts),currencies:this.currencies?JSON.stringify(this.currencies):"",country_code:this.country_code,zip_code:this.zip_code,vat_id:this.vat_id,discount_percentage:JSON.stringify(100*this.discount_ratio)})},e.from_transition_view_models=function(t){var i,o,s,r,a,l,c,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I;for(_=[],S=[],s=[],h=!1,o=!1,A=!1,I=!1,r=0,c=t.length;c>r;r++)if(T=t[r],_.push(T.state.plan.id),S.push(T.state.schedule.id),s.push(T.state.currency),h===!1){for(h={},m=T.state.allocated_licenses,a=0,d=m.length;d>a;a++)i=m[a],h[i.license_id]=i.license_count;o=null!=(f=T.read_only_invoice)?f.tax_country_code:void 0,I=null!=(v=T.read_only_invoice)?v.tax_zip_code:void 0,A=null!=(g=T.read_only_invoice)?g.tax_exclusion_id:void 0,I=null!=(y=T.read_only_invoice)?y.tax_zip_code:void 0}else{for(u(T.state.allocated_licenses.length===Object.keys(h).length,"License sets differ"),b=T.state.allocated_licenses,l=0,p=b.length;p>l;l++)i=b[l],u(i.license_id in h,"License sets differ"),u(h[i.license_id]===i.license_count,"License count must match");u(o===(null!=(w=T.read_only_invoice)?w.tax_country_code:void 0),"country codes must match"),u(I===(null!=(C=T.read_only_invoice)?C.tax_zip_code:void 0),"zip codes must match"),u(A===(null!=(E=T.read_only_invoice)?E.tax_exclusion_id:void 0),"VAT IDs must match")}return new e(n.uniq(_),n.uniq(S),h,n.uniq(s),o,I,A)},e}(),a=function(){function e(e){var t,n;this.transition_view_model=e,this.current_total=this.transition_view_model.read_only_invoice?r.fromObject(this.transition_view_model.read_only_invoice.total):new r(0,this.transition_view_model.state.currency),this.per_license_price=this.transition_view_model.state.per_license_prices.length?r.fromObject(this.transition_view_model.state.per_license_prices[0].price):new r(0,this.transition_view_model.state.currency),this.recurring_total=r.fromObject(this.transition_view_model.state.total_recurring_price),this.tax=r.fromObject(this.transition_view_model.prices.tax),this.recurring_total_tax=this.recurring_total.add(this.tax),n=this.transition_view_model.read_only_invoice.line_items,t=n.length>0?n[0]:void 0,this.tax_percentage=(null!=t?t.country_tax_percentage:void 0)?t.country_tax_percentage:(null!=t?t.state_tax_percentage:void 0)?t.state_tax_percentage:0}return e}(),l=function(){function n(t){this.default_transition_view_models=t,this._get_transition_info_for=e(this._get_transition_info_for,this),this._add_to_cache=e(this._add_to_cache,this),this.has_inflight_request=e(this.has_inflight_request,this),this.transition_view_model_requests={},this.transition_info_cache={},this._add_to_cache(this.default_transition_view_models)}return n.prototype.get=function(e,n){var i,o,s;return s=c.from_transition_view_models(this.default_transition_view_models),n.total_users&&s.set_only_license_count(n.total_users),n.country_code&&s.set_country_code(n.country_code),n.currency&&s.set_currencies([n.currency]),n.remove_currency&&s.set_currencies(),n.zip_code&&s.set_zip_code(n.zip_code),n.renew&&s.set_renew(n.renew),(n.vat_id||""===n.vat_id)&&s.set_vat_id(n.vat_id),n.discount_ratio&&s.set_discount_ratio(n.discount_ratio),i=s.cache_key(),(o=this._get_transition_info_for(i))?void e(o):this.transition_view_model_requests[i]?void 0:(this.transition_view_model_requests[i]=!0,t.ajax({url:"/business/transition-model",type:"GET",dataType:"json",data:s.to_json(),success:function(t){return function(n){var o;return delete t.transition_view_model_requests[i],o=t._add_to_cache(n),e(o)}}(this),error:function(e){return function(){return delete e.transition_view_model_requests[i];

}}(this)}))},n.prototype.has_inflight_request=function(){return Object.keys(this.transition_view_model_requests).length},n.prototype._add_to_cache=function(e){var t,n,i;return t=c.from_transition_view_models(e).cache_key(),n=function(){var t,n,o;for(o=[],t=0,n=e.length;n>t;t++)i=e[t],o.push(new a(i));return o}(),this.transition_info_cache[t]=n,n},n.prototype._get_transition_info_for=function(e){return e in this.transition_info_cache?this.transition_info_cache[e]:null},n}(),{DfBTransitionInfo:a,DfBTransitionInfoFetcher:l}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/payments/pro_trial_onboarding_tour",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/clean/dbmodal_loading"],function(n,i,o){var s,r,a,l;return s=o.DBModal,r=o.DBModalStack,a=function(o){function s(t){this.options=t,this._log=e(this._log,this),this._redraw=e(this._redraw,this),this._log_and_show_current_step=e(this._log_and_show_current_step,this),this._finish_tour=e(this._finish_tour,this),this._advance_tour=e(this._advance_tour,this),this._go_back_tour=e(this._go_back_tour,this),this._hide=e(this._hide,this),this._show=e(this._show,this),s.__super__.constructor.call(this,this.options),this.vertical_offset=200}return t(s,o),s.show=function(e){var t;return t=new this({element_id:"pro-trial-onboarding-tour",click_out_to_close:!1,vars:{trigger:e}}),t.show()},s.prototype._show=function(){return s.__super__._show.apply(this,arguments),this._listen(),this._current_step=0,this._log_and_show_current_step(this.vars.trigger)},s.prototype._hide=function(){return s.__super__._hide.apply(this,arguments),this._unlisten(),n("#pro-trial-tour-header-bubble").removeClass("force-hidden")},s.prototype._listen=function(){return n(document).on("click",".prev-step",this._go_back_tour),n(document).on("click","button.next-step",this._advance_tour),n(document).on("click","button.finish-tour",this._finish_tour)},s.prototype._unlisten=function(){return n(document).off("click",".prev-step",this._go_back_tour),n(document).off("click","button.next-step",this._advance_tour),n(document).on("click","button.finish-tour",this._finish_tour)},s.prototype._go_back_tour=function(e){return e.preventDefault(),this._current_step-=1,this._log_and_show_current_step()},s.prototype._advance_tour=function(e){return e.preventDefault(),this._current_step+=1,this._log_and_show_current_step()},s.prototype._finish_tour=function(){return this._log("finish_trial_onboarding"),this.hide()},s.prototype._log_and_show_current_step=function(e){var t;return t=e?{trigger:e}:{},this._log("view_trial_onboarding_"+this._current_step,t),this._redraw()},s.prototype._redraw=function(){var e,t;return this.$modal_window.find(".welcome, .tour-feature").hide(),t=this.$modal_window.find(".db-modal-x"),0===this._current_step?(this.$modal_window.find(".welcome").show(),t.hide()):(e=this._current_step,this.$modal_window.find('.tour-feature[data-step-num="'+e+'"]').show(),t.show())},s.prototype._log=function(e,t){return i.WebRequest({url:"/pro/trial_onboarding_tour_log",data:{evt:e,extra_data:JSON.stringify(t)}})},s}(s),l=function(){function e(e){this.$container=e,this._listen()}return e.prototype._listen=function(){return this.$container.find(".start-tour").on("click",function(){return function(e){return e.preventDefault(),a.show("restart_tour")}}(this))},e}(),{ProTrialOnboardingTour:a,ProTrialOnboardingTourHeaderLink:l}})}.call(this),function(){define("modules/clean/payments/validation",[],function(){var e,t;return e={AT:/^ATU[0-9]{8}$/,BE:/^BE(0?|1)[0-9]{9}$/,BG:/^BG[0-9]{9,10}$/,CH:/^CHE[0-9]{9}(TVA|MWST|IVA)$/,CY:/^CY[0-9]{8}[A-Z]$/,CZ:/^CZ[0-9]{8,10}$/,DE:/^DE[0-9]{9}$/,DK:/^DK[0-9]{8}$/,EE:/^EE[0-9]{9}$/,GR:/^EL[0-9]{9}$/,ES:/^ES([A-Z][0-9]{7}[0-9A-Z]|[0-9A-Z][0-9]{7}[A-Z])$/,FI:/^FI[0-9]{8}$/,FR:/^FR[0-9A-Z]{2}[0-9]{9}$/,GB:/^GB([0-9]{9}|[0-9]{12}|GD[0-9]{3}|HA[0-9]{3})$/,HR:/^HR[0-9]{11}$/,HU:/^HU[0-9]{8}$/,IE:/^IE([0-9][0-9A-Z+*][0-9]{5}[A-Z]{1,2}|[0-9]{7}WI)$/,IT:/^IT[0-9]{11}$/,LT:/^LT([0-9]{9}|[0-9]{12})$/,LU:/^LU[0-9]{8}$/,LV:/^LV[0-9]{11}$/,MT:/^MT[0-9]{8}$/,NL:/^NL[0-9]{9}B[0-9]{2}$/,NO:/^NO[0-9]{9}(MVA)?$/,PL:/^PL[0-9]{10}$/,PT:/^PT[0-9]{9}$/,RO:/^RO[0-9]{2,10}$/,SE:/^SE[0-9]{12}$/,SI:/^SI[0-9]{8}$/,SK:/^SK[0-9]{10}$/},t=function(t,n){var i;return i=e[t],i&&i.test(n)},{validate_vat:t}})}.call(this),function(){define("modules/clean/people/experiments/link_profile_service_modal",["external/react","jquery","modules/core/exception","modules/core/i18n","modules/clean/analytics","modules/clean/css","modules/clean/gandalf_util","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/viewer"],function(e,t,n,i,o,s,r,a,l,c,u,d){var p,h,_,m,f,v,g,y,b,w,C,E;return w=n.assert,b=i._,g=o.PeopleExperimentsLogger,m=l.LinkedProfileServices,y=l.ProfileServicesLinkingHandler,v=c.Modal,C=e.DOM,E=null,f={"SHOW-MODAL-V1":b("Add your contacts to share faster"),"SHOW-MODAL-V2":b("It’s easier to share when you add your contacts")},p={description_text:function(e,t){switch(t){case"SHOW-MODAL-V1":return b("With your %(service)s contacts in Dropbox, it’s easier to share with people you know and invite them to folders.".format({service:a.to_name(e)}));case"SHOW-MODAL-V2":return b("Add your contacts from %(service)s for a faster way to share with people you know.".format({service:a.to_name(e)}))}}},h={image:function(e){switch(e){case"SHOW-MODAL-V1":return"/static/images/people_experiments/illu_import-contacts-vflbgurKv.png";case"SHOW-MODAL-V2":return"/static/images/people_experiments/illu_import-contacts-vflbgurKv.png"}}},_=e.createClass({statics:{show_modal:function(e,t,n){var i;return w(t,"User_id not provided"),i=function(e){var i,o,s;return s=d.get_viewer().get_user_by_id(t),o=a.GOOGLE,(s.email.indexOf("yahoo")>=0||s.email.indexOf("ymail")>=0)&&(o=a.YAHOO),null!=E||e.has_connected_services()||null==r.getGandalfRule("people-link-profile-on-share-experiment")||r.isGandalfInVariant("people-link-profile-on-share-experiment","CONTROL")?n():(g.log(g.LINK_PROFILE_MODAL_SHOW,t=t,i={service:o}),E=new _({service:o,sharing_handler:n,user_id:t}),v.showInstance(E))},m.get_linked_profile_services_for_user(t,i)}},propTypes:{service:e.PropTypes.string.isRequired,sharing_handler:e.PropTypes.func.isRequired,user_id:e.PropTypes.number.isRequired},getInitialState:function(){return{link_text:"Add "+a.to_name(this.props.service)+" contacts"}},componentWillMount:function(){return s.require_css("/static/css/people_experiments/link_profile_service_modal-vflQs13XM.css")},linking_callback:function(e){var t,n,i;t=g.LINK_PROFILE_MODAL_LINK_ERROR,e.success&&(t=g.LINK_PROFILE_MODAL_LINK_SUCCESS),g.log(t,i=this.props.user_id,n={service:this.props.service,link_success:e.success}),y.show_import_notifications(e),this.props.sharing_handler(),this.refs.link_account_modal.close()},load_sharing_modal:function(e){var n,i;return n={service:this.props.service,"event-type":e.type,"event-target-class":t(e.target).attr("class")},"click"===e.type&&t(e.target).hasClass("dbmodal-button")&&(g.log(g.LINK_PROFILE_MODAL_NOT_NOW,i=this.props.user_id,n=n),this.props.sharing_handler()),g.log(g.LINK_PROFILE_MODAL_DISMISS,i=this.props.user_id,n=n)},link_service:function(e){var t,n,i;e.preventDefault(),g.log(g.LINK_PROFILE_MODAL_LINK_PROFILE,i=this.props.user_id,t={service:this.props.service}),n=new y,n.auth_service_with_user(this.props.service,this.props.user_id,this.linking_callback,"link-profile-modal-experiment")},render:function(){var e,t;return e={acceptButtonText:this.state.link_text,dismissButtonText:"Not now",onAccept:this.link_service,onDismiss:this.load_sharing_modal,ref:"link_account_modal",style:"clean"},t=r.getGandalfRule("people-link-profile-on-share-experiment"),v(e,C.div({className:"modal-body-wrapper"},C.h1({className:"modal-title"},f[t]),C.p({className:"modal-description-1"},p.description_text(this.props.service,t)),C.img({className:"modal-image",src:h.image(t)}),"SHOW-MODAL-V2"===t?C.div({className:"modal-privacy-message"},u({className:"privacy-lock",group:"web",name:"lock"}),C.p({className:"privacy-text"},b("We won’t email your contacts without your permission."))):void 0))}}),{LinkProfileServiceModal:_}})}.call(this),function(){define("modules/clean/photos/photos_engagement_logger",["jquery","modules/clean/ajax"],function(e,t){var n;return n=function(){function n(){}return n.Platform={WEB:"web",WEB_CAROUSEL:"web_carousel"},n.CAROUSEL_NAV_LINK_CLICK="carousel_nav_link_click",n.PHOTOS_NAV_LINK_CLICK="photos_nav_link_click",n.WEBAPP_VIEW_TIMELINE="webapp_view_gallery",n.WEBAPP_VIEW_SHARED_ALBUM="webapp_view_conversations",n.WEBAPP_VIEW_SHARED_ALBUMS_GRID="webapp_view_shared_albums_grid",n.WEBAPP_VIEW_ALBUMS_GRID="webapp_view_albums_grid",n.WEBAPP_VIEW_ALBUM="webapp_view_albums",n.WEBAPP_VIEW_FLASHBACK="webapp_view_flashback",n.WEBAPP_ACTION_ADD_TO_ALBUM="webapp_action_add_to_album",n.WEBAPP_ACTION_REMOVE_FROM_ALBUM="webapp_action_remove_from_album",n.WEBAPP_ACTION_DOWNLOAD="webapp_action_download",n.WEBAPP_ACTION_SHOW_IN_FOLDER="webapp_action_show_in_folder",n.WEBAPP_ACTION_DELETE="webapp_action_delete",n.WEBAPP_SHOW_EXCLUDE_MODAL="webapp_show_exclude_modal",n.ATTEMPT_EXCLUDE_CAROUSEL_SUBFOLDER="attempt_exclude_carousel_subfolder",n.ATTEMPT_EXCLUDE_CU_FOLDER="attempt_exclude_cu_folder",n.ATTEMPT_EXCLUDE_CAROUSEL_FOLDER="attempt_exclude_carousel_folder",n.ATTEMPT_EXCLUDE_DROPBOX_ROOT="attempt_exclude_dropbox_root",n.WEBAPP_GALLERY_SELECT_EVENT="webapp_gallery_select_event",n.WEBAPP_GALLERY_DESELECT_EVENT="webapp_gallery_deselect_event",n.WEBAPP_GALLERY_SELECT_ITEM="webapp_gallery_select_item",n.WEBAPP_GALLERY_DESELECT_ITEM="webapp_gallery_deselect_item",n.WEBAPP_GALLERY_TIME_FIRST_ITEM="webapp_gallery_time_first_item",n.WEBAPP_GALLERY_TIME_EVENTS_OUTLINE="webapp_gallery_time_events_outline",n.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_EVENTS="webapp_gallery_time_first_visible_events",n.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_THUMBS_BATCH="webapp_gallery_time_first_visible_thumbs_batch",n.WEBAPP_GALLERY_EMPTY="webapp_gallery_empty",n.WEBAPP_GALLERY_CONTEXT_MENU_SHOWN="webapp_gallery_context_menu_shown",n.WEBAPP_LIGHTBOX_OPEN="webapp_lightbox_open",n.WEBAPP_LIGHTBOX_DOWNLOAD="webapp_lightbox_download",n.WEBAPP_LIGHTBOX_SELECT_ITEM="webapp_lightbox_select_item",n.WEBAPP_LIGHTBOX_DESELECT_ITEM="webapp_lightbox_deselect_item",n.WEBAPP_LIGHTBOX_FORWARD="webapp_lightbox_forward",n.WEBAPP_LIGHTBOX_BACK="webapp_lightbox_back",n.WEBAPP_LIGHTBOX_SHARE="webapp_lightbox_share",n.WEBAPP_LIGHTBOX_CLOSE_ICON="webapp_lightbox_close_icon",n.WEBAPP_LIGHTBOX_CLOSE_KEY="webapp_lightbox_close_key",n.WEBAPP_TIMELINE_NAVIGATION_SHOWN="webapp_timeline_navigation_shown",n.WEBAPP_TIMELINE_NAVIGATION_TRACK_CLICKED="webapp_timeline_navigation_track_clicked",n.WEBAPP_TIMELINE_NAVIGATION_SCRUBBER_DRAGGED="webapp_timeline_navigation_scrubber_dragged",n.WEBAPP_SHARE_CART_CANCEL="webapp_share_cart_cancel",n.WEBAPP_SHARE_CART_SHARE="webapp_share_cart_share",n.WEBAPP_SHARE_CART_SHARE_FACEBOOK="webapp_share_cart_share_facebook",n.WEBAPP_SHARE_CART_SHARE_TWITTER="webapp_share_cart_share_twitter",n.WEBAPP_SHARE_CART_ITEM_CLICKED="webapp_share_cart_item_clicked",n.WEBAPP_SHARE_DROPDOWN_SEND_LINK="webapp_share_dropdown_send_link",n.WEBAPP_SHARE_DROPDOWN_SHARED_ALBUM="webapp_share_dropdown_shared_album",n.WEBAPP_OPEN_SHARE_MODAL="webapp_open_share_modal",n.WEBAPP_GALLERY_DELETE_MODAL_CONFIRMED="webapp_gallery_delete_modal_confirmed",n.WEBAPP_GALLERY_DELETE_MODAL_CANCELED="webapp_gallery_delete_modal_canceled",n.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CONFIRMED="webapp_gallery_remove_from_album_modal_confirmed",n.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CANCELED="webapp_gallery_remove_from_album_modal_canceled",n.WEBAPP_SHARE_COMPOSER_RECIPIENT="webapp_share_composer_recipient",n.WEBAPP_SHARE_COMPOSER_MESSAGE="webapp_share_composer_message",n.WEBAPP_SHARE_COMPOSER_SHARE="webapp_share_composer_share",n.WEBAPP_SHARE_COMPOSER_TWITTER="webapp_share_composer_twitter",n.WEBAPP_SHARE_COMPOSER_FACEBOOK="webapp_share_composer_facebook",n.WEBAPP_SHARE_COMPOSER_LINK="webapp_share_composer_link",n.WEBAPP_SHARE_WITH_SELF_ATTEMPT="webapp_share_with_self_attempt",n.WEBAPP_CONVERSATIONS_ROOM_CLICKED="webapp_conversations_room_clicked",n.WEBAPP_CONVERSATIONS_VIEW_SETTINGS="webapp_conversations_view_settings",n.WEBAPP_CONVERSATIONS_CLOSE_SETTINGS="webapp_conversations_close_settings",n.WEBAPP_CONVERSATIONS_TIME_FIRST_POST="webapp_conversations_time_first_post",n.WEBAPP_CONVERSATIONS_EMPTY="webapp_conversations_empty",n.WEBAPP_CONVERSATIONS_CHAT_VIEW_CLICKED="webapp_conversations_chat_view_clicked",n.WEBAPP_CONVERSATIONS_GALLERY_VIEW_CLICKED="webapp_conversations_gallery_view_clicked",n.WEBAPP_CONVERSATIONS_CHAT_VIEW_LOAD_MORE="webapp_conversations_chat_view_load_more",n.WEBAPP_CONVERSATIONS_GALLERY_VIEW_LOAD_MORE="webapp_conversations_gallery_view_load_more",n.WEBAPP_SHARING_COMMENT_SUBMIT="webapp_sharing_comment_submit",n.WEBAPP_SHARING_GALLERY_ADD_PHOTOS="webapp_sharing_gallery_add_photos",n.WEBAPP_SHARING_COPY_LINK="webapp_sharing_copy_link",n.WEBAPP_SHARING_LIKE_ITEM="webapp_sharing_like_item",n.WEBAPP_SHARING_UNLIKE_ITEM="webapp_sharing_unlike_item",n.WEBAPP_FLASHBACK_SELECT_EVENT="webapp_flashback_select_event",n.WEBAPP_FLASHBACK_SELECT_ITEM="webapp_flashback_select_item",n.WEBAPP_FLASHBACK_CLICK_ITEM="webapp_flashback_click_item",n.WEBAPP_FLASHBACK_CLICK_SHARE="webapp_flashback_click_share",n.WEBAPP_FLASHBACK_SURVEY_RESPONSE="webapp_flashback_survey_response",n.WEBAPP_FLASHBACK_SURVEY_FREE_RESPONSE="webapp_flashback_survey_free_response",n.WEBAPP_FLASHBACK_SHARE_ALL="webapp_flashback_share_all",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_FACEBOOK="webapp_flashback_share_single_item_facebook",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_TWITTER="webapp_flashback_share_single_item_twitter",n.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_LINK="webapp_flashback_share_single_item_link",n.PUBLIC_LASS_INPUT_CLICK="public_lass_input_click",n.PUBLIC_LASS_INPUT_MESSAGE="public_lass_input_message",n.PUBLIC_LASS_INPUT_SUBMIT="public_lass_input_submit",n.PUBLIC_LASS_ADD_PHOTOS="public_lass_add_photos",n.PUBLIC_LASS_LIKE_CLICK="public_lass_like_click",n.PUBLIC_LASS_START_LOGIN="public_lass_start_login",n.PUBLIC_LASS_FINISH_LOGIN="public_lass_finish_login",n.PHOTO_SPACE_START_LOGIN="photo_space_start_login",n.PHOTO_SPACE_FINISH_LOGIN="photo_space_finish_login",n.PHOTO_SPACE_SUBSCRIBE="photo_space_subscribe",n.MOBILE_DROPBOX_FLASHBACK_SHARE_CART_SHARE="share_cart_share",n.MOBILE_DROPBOX_FLASHBACK_SHARE_CART_CANCEL="share_cart_cancel",n.MOBILE_DROPBOX_FLASHBACK_LINK_GENERATED="link_generated",n.MOBILE_DROPBOX_FLASHBACK_SHARE_DONE="share_done",n.first_log_sent=!1,n.logs_queued=[],n.HACK_prefix_to_replace=null,n.HACK_prefix_replace_with=null,n.HACK_new_platform=null,n.HACK_extra={},n.hack_all_log_prefixes_and_platform=function(e){var t,i,o,s;return s=e.prefix_to_replace,o=e.prefix_replace_with,i=e.new_platform,t=e.extra,n.HACK_prefix_to_replace=s,n.HACK_prefix_replace_with=o,n.HACK_new_platform=i,n.HACK_extra=t},n.apply_hacky_log_overrides=function(t,i,o){var s,r;return n.HACK_prefix_to_replace?(r=0===t.indexOf(n.HACK_prefix_to_replace)?t.replace(n.HACK_prefix_to_replace,n.HACK_prefix_replace_with):0!==t.indexOf(n.HACK_prefix_replace_with)?n.HACK_prefix_replace_with+t:t,s=e.extend({},o,this.HACK_extra),[r,n.HACK_new_platform,s]):[t,i,o]},n.log_and_send=function(e,i,o){var s;return null==i&&(i={}),null==o&&(o=n.Platform.WEB),s=n.apply_hacky_log_overrides(e,o,i),e=s[0],o=s[1],i=s[2],t.AuthenticatedRequest({url:"/photos/photos_engagement_log",data:{event:e,extra:JSON.stringify(i),platform:o}})},n.log=function(e,t,i){var o,s;return this._init(),n.first_log_sent?(null==t&&(t={}),null==i&&(i=n.Platform.WEB),s=n.apply_hacky_log_overrides(e,i,t),e=s[0],i=s[1],t=s[2],o={event:e,extra:t,platform:i},n.logs_queued.push(o)):(n.log_and_send(e,t,i),void(n.first_log_sent=!0))},n.log_carousel=function(e,t){return n.log(e,t,n.Platform.WEB_CAROUSEL)},n._send_log_batch=function(){return n.logs_queued.length?(t.AuthenticatedRequest({url:"/photos/photos_engagement_batch_log",data:{events:JSON.stringify(n.logs_queued)}}),n.logs_queued=[]):void 0},n._init=function(){return this._initialized?void 0:(this._initialized=!0,setInterval(n._send_log_batch,1e4),e(window).unload(n._send_log_batch))},n}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/previews/file_view_rams_common",["jquery","modules/clean/gandalf_util","modules/constants/env","modules/core/browser","modules/core/uri"],function(t,n,i,o,s){var r;return r={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1e3,_PDF_PREVIEW_DOMAINS:[i.DL_DOC_DOMAIN,i.BLOCK_CLUSTER,i.PUBSERVER,i.DL_DOC_USER_CONTENT_DOMAIN],enterRamsFullscreen:function(e){return e.addClass("rams-fullscreen").data("rams-fullscreen",!0),t(window).resize()},exitRamsFullscreen:function(e){return e.removeClass("rams-fullscreen").removeData("rams-fullscreen"),t(window).resize()},isRamsFullscreenActive:function(e){var t;return t=e.data("rams-fullscreen"),null!=t&&t},_isPdfPreviewDomain:function(t){return t=t.toLowerCase(),e.call(this._PDF_PREVIEW_DOMAINS,t)>=0},_supportsNativePrinting:function(){return o.chrome||o.safari},getNativePrintUrl:function(e,t){var n,i;return this._supportsNativePrinting()?this._isPdfPreviewDomain(t)?(i=e.clone(),i.updateQuery({from_native_print:1}),n=s.parse("https://"+t+"/nativeprint"),n.updateQuery({file:i}),n.toString()):(console.warn("Blocked attempt to load pdf native print for unexpected domain"),null):null}}})}.call(this),function(){define("modules/clean/previews/file_viewer_utils",["jquery"],function(e){var t;return t=function(){return e("#file-viewer")},{getFileViewerElement:t}})}.call(this),function(){define("modules/clean/previews/pdf_loader",["external/underscore","modules/clean/ajax","modules/clean/frame_messenger","modules/clean/gandalf_util","modules/core/browser","modules/core/uri"],function(e,t,n,i,o,s){var r,a,l,c;return l=["exit-parent-fullscreen","failed","pagerendered","viewer-initialized","loaded","viewer-ready"],r="iframe.pdfjs",c=function(e){var t,n,i,o,s,r,a,l,c;t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";try{l=crypto.getRandomValues(new Uint8Array(e))}catch(e){i=e,l=[]}for(r="",s=a=0,c=e;c>=0?c>=a:a>=c;s=c>=0?++a:--a)n=e===l.length?l[s]%t.length:Math.floor(Math.random()*t.length),r+=t[n];return r},a=function(){function a(){}return a.prototype._exitFullscreenCallback=null,a.prototype._frameMessenger=new n,a.prototype._fileUrl=null,a.prototype._isFullscreen=!1,a.prototype._options={},a.prototype._ducId=c(64),a.prototype.startListening=function(){return this._frameMessenger.configureChildMessaging(r,this.handleTrustedMesssageFromChild.bind(this),l),this._frameMessenger.startListening()},a.prototype.stopListening=function(){return this._frameMessenger.stopListening()},a.prototype.handleTrustedMesssageFromChild=function(e){switch(e.action){case"viewer-initialized":return this._sendOpenFileAction();case"viewer-ready":if(this._isFullscreen)return this._sendEnterFullscreenAction();break;case"exit-parent-fullscreen":return this._isFullscreen=!1,"function"==typeof this._exitFullscreenCallback?this._exitFullscreenCallback():void 0;case"failed":return this._onFailed();case"pagerendered":return this._onPageRendered();case"loaded":return this._onLoaded()}},a.prototype.setExitFullscreenCallback=function(e){return this._exitFullscreenCallback=e},a.prototype.setIsFullscreen=function(e){return this._isFullscreen=e},a.prototype.setOnDownloadSucceeded=function(e){return this._onDownloadSucceeded=e},a.prototype.setOnDownloadFailed=function(e){return this._onDownloadFailed=e},a.prototype.setOnRenderSucceeded=function(e){return this._onRenderSucceeded=e},a.prototype.setOnRenderFailed=function(e){return this._onRenderFailed=e},a.prototype.openFile=function(n,r){var a,l,c,u;return null==r&&(r={}),this._hasDocumentDownloaded=!1,null!=n?(e.defaults(r,{disableRange:!i.getGandalfRule("docpreview-pdf-range-request-enabled")||!!o.safari_version_at_most(8),chunkSizeGandalf:i.getGandalfRule("docpreview-pdf-range-request-chunkSize"),minRangeSizeGandalf:i.getGandalfRule("docpreview-pdf-range-request-minRangeSize"),presentationMode:!1,dropboxDucId:this._ducId}),a=null,i.getGandalfRule("docpreview-debug-force-test-pdf")?a="test.pdf":i.getGandalfRule("docpreview-debug-force-test-deck-pdf")&&(a="test-deck.pdf"),null!=a&&(c=s.parse(n),u=c.getQuery(),u.canned_file_name=a,c.setQuery(u),n=c.toString()),c=s.parse(n.toString()),0===c.getPath().toString().indexOf("/pri")?(l=c.getPath().toString().slice(8),c.setPath("/pri/get_content_url"),t.WebRequest({url:c.toString(),data:{path:l},success:function(e){return function(t){var n;return n=JSON.parse(t),e._finishOpenFile(n.url,r)}}(this)})):this._finishOpenFile(n,r)):void 0},a.prototype._finishOpenFile=function(e,t){return null==t&&(t={}),this._fileUrl=e.toString(),this._options=t,this._sendOpenFileAction()},a.prototype._sendOpenFileAction=function(){return this._frameMessenger.postMessageToChildren("open-file",{fileUrl:this._fileUrl,options:this._options})},a.prototype._sendEnterFullscreenAction=function(){return this._frameMessenger.postMessageToChildren("enter-fullscreen")},a.prototype._onLoaded=function(){return"function"==typeof this._onDownloadSucceeded&&this._onDownloadSucceeded(),this._hasDocumentDownloaded=!0},a.prototype._onPageRendered=function(){return"function"==typeof this._onRenderSucceeded?this._onRenderSucceeded():void 0},a.prototype._onFailed=function(){return this._hasDocumentDownloaded?"function"==typeof this._onRenderFailed?this._onRenderFailed():void 0:"function"==typeof this._onDownloadFailed?this._onDownloadFailed():void 0},a}()})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/previews/preview_actions_helper",["jquery","modules/clean/previews/file_view_rams_common","modules/clean/previews/util","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/store","modules/constants/legacy","modules/core/browser","modules/core/uri"],function(t,n,i,o,s,r,a,l){var c,u,d,p;return p=i.PreviewHelper,d=function(){function e(){}return e.getIframeQuery=function(){return".react-file-viewer__preview iframe"},e.nativePdfPrint=function(e){var t,i,o,s;return e.doc_preview_status!==r.DOC_PREVIEW_AVAILABLE||"doc"!==(s=e.preview_type)&&"adobecs"!==s?!1:(o=p.get_progressive_url("doc",e.href),t=l.parse(o).getAuthority(),i=n.getNativePrintUrl(o,t),null==i?!1:(window.open(i,"_blank"),!0))},e.enterFullscreen=function(){return o.openFullscreen(),!1},e.exitFullscreen=function(){return o.closeFullscreen(),!1},e.isFullscreen=function(){return s.isFullscreen()},e}(),c=function(i){function o(){return o.__super__.constructor.apply(this,arguments)}return e(o,i),o.getEmbedContainer=function(){var e;return e=t("#pdf-embed-container, #html-container, #htmlified-wrapper, #code-wrapper"),1!==e.length&&(e=[]),e},o._getPdfEmbedIframe=function(){return t("#pdf-embed-iframe")},o.getIframeQuery=function(){return".preview-box iframe"},o.nativePdfPrint=function(e){var i,o,s,r;return i=this._getPdfEmbedIframe(),t("body").hasClass("file-preview-body")&&1===i.length&&null!=e?(r=l.parse(a.get_href()),r.setQuery({preview:1,force_no_progressive:1}),o=l.parse(e).getAuthority(),s=n.getNativePrintUrl(r,o),null==s?!1:(window.open(s,"_blank"),!0)):!1},o.enterFullscreen=function(){return n.enterRamsFullscreen(t(this.getEmbedContainer())),!0},o.exitFullscreen=function(){return n.exitRamsFullscreen(t(this.getEmbedContainer())),!0},o.isFullscreen=function(){return n.isRamsFullscreenActive(t(this.getEmbedContainer()))},o}(d),u=function(i){function o(){return o.__super__.constructor.apply(this,arguments)}return e(o,i),o.prototype._non_fullscreen_vert_overflow=null,o.getIframeQuery=function(){return".preview-content-container > iframe"},o.enterFullscreen=function(){var e;return n.enterRamsFullscreen(t(".preview")),e=t("html"),this._non_fullscreen_vert_overflow=e.css("overflow-y"),e.css("overflow-y","hidden"),!0},o.exitFullscreen=function(){return n.exitRamsFullscreen(t(".preview")),t("html").css("overflow-y",this._non_fullscreen_vert_overflow),this._non_fullscreen_vert_overflow=null,!0},o.isFullscreen=function(){return n.isRamsFullscreenActive(t(".preview"))},o.nativePdfPrint=function(e){var i,o,s,a;return e.doc_preview_status!==r.DOC_PREVIEW_AVAILABLE||"doc"!==(a=e.preview_type)&&"adobecs"!==a?!1:(s=p.get_progressive_url("doc",e.href),i=l.parse(s).getAuthority(),o=n.getNativePrintUrl(s,i,t("#file-viewer")),null==o?!1:(window.open(o,"_blank"),!0))},o}(d),{PreviewActions:d,LegacyFileViewerActions:u,LegacyFilePreviewActions:c}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/previews/preview_status_watcher",["modules/constants/legacy","modules/core/uri","modules/clean/ajax"],function(t,n,i){var o;return o=function(){function o(){this._onCheckError=e(this._onCheckError,this),this._onCheckSuccess=e(this._onCheckSuccess,this),this._check=e(this._check,this)}return o.TIMEOUT=1e3,o.MAX_TRIES=5,o.prototype._statusRequest=null,o.prototype._statusTimeout=null,o.prototype._statusTries=0,o.prototype.onSuccess=null,o.prototype.onError=null,o.prototype.userId=0,o.prototype.start=function(e,t,i,o){return this.userId=e,this.onSuccess=i,this.onError=o,this.url=n({path:"/doc_preview_status"+t}).toString(),this._check()},o.prototype.stop=function(){return this.reset()},o.prototype.reset=function(){var e;return null!=(e=this._statusRequest)&&e.abort(),this._statusRequest=null,clearTimeout(this._statusTimeout),this._statusTimeout=null,this._statusTries=0},o.prototype._check=function(){return this._statusTries>=o.MAX_TRIES?void("function"==typeof this.onError&&this.onError()):(this._statusTries++,this._statusRequest=i.WebRequest({url:this.url,subject_user:this.userId,success:this._onCheckSuccess,error:this._onCheckError}))},o.prototype._onCheckSuccess=function(e){switch(parseInt(e,10)){case t.DOC_PREVIEW_AVAILABLE:return"function"==typeof this.onSuccess?this.onSuccess():void 0;case t.DOC_PREVIEW_IN_PROGRESS:return this._statusTimeout=setTimeout(this._check,o.TIMEOUT);default:return"function"==typeof this.onError?this.onError():void 0}},o.prototype._onCheckError=function(){return"function"==typeof this.onError?this.onError():void 0},o}()})}.call(this),function(){define("modules/clean/previews/util",["modules/core/browser","modules/clean/analytics","modules/clean/datetime","modules/clean/filepath","modules/clean/gandalf_util","modules/constants/env","modules/constants/legacy","modules/constants/static","modules/constants/viewer","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h;return p=t.UserActivityLogger,h=n.getActingTime,u={is_annotation_marker_enabled:function(){return o.getGandalfRule("dw-comments-annotation-marker")},is_annotation_highlight_enabled:function(){return o.getGandalfRule("dw-comments-annotation-highlight")},is_annotation_region_enabled:function(){return o.getGandalfRule("dw-comments-annotation-region")},is_indesign_preview_enabled:function(){return o.getGandalfRule("docpreview-indesign_preview")},is_saveas_experiment_enabled:function(){return o.getGandalfRule("saveas_experiment")},is_password_protected_preview_enabled:function(){return o.getGandalfRule("docpreview-password-protected-preview")},is_xls_edit_enabled:function(){return o.getGandalfRule("xls-edit")},use_excel2_for_extension:function(e){var t;return null==e&&(e=""),t=d.normalize_extension(e),o.getGandalfRule("docpreview-excel2-force")&&"xls"===t}},d={get_extension:function(e){return i.file_extension(e.fq_path||e.filename).toLowerCase()},get_filename:function(e){return i.filename(e.fq_path||e.filename)},normalize_extension:function(e){var t;if("indd"===e)return e;switch(t=e.substring(0,3)){case"rtf":case"odt":return"doc";case"pps":return"ppt";case"csv":return"xls";default:return t}},get_progressive_url:function(e,t){var n,i,o,a;return i=d.normalize_extension(e),a=c.parse(t),o=!1,"doc"===i||"key"===i||"keynote"===i||"adobecs"===i||u.use_excel2_for_extension(i)?"pdf-js"!==r.PDF_PREVIEW_MODE&&(a=a.updateQuery({post_message_on_failure:1})):"xls"===i&&(n=u.is_xls_edit_enabled()?"xls/edit":"xls/preview"),n&&(a.setAuthority(o?s.WEBSERVER:a.getAuthority().replace("dl-web","dl-doc")),a.setPath(a.getPath().replace("/pri/get/","/get/")),a.setPath(a.getPath().replace("/get/","/"+n+"/"))),a=a.updateQuery({get_preview:1,saveas:u.is_saveas_experiment_enabled()?1:0})},get_pdf_js_url:function(e,t){return"pdf-js"===r.PDF_PREVIEW_MODE&&(e=c.parse(u.use_excel2_for_extension(t)?a.static_url_pdfjs_excel:a.static_url_pdfjs_viewer)),e},getModifierString:function(e){return h(1e3*e.ts)},_getVersionHistoryUrl:function(e,t){var n;return n=c(o.getGandalfRule("revision-history-web")?{path:"/history"+e.fq_path}:{path:"/revisions"+e.fq_path}),this.update_url_with_user_id(n,t.id)},redirectToVersionHistory:function(t,n){var i;return p.log("web","view_version_history"),i=d._getVersionHistoryUrl(t,n),e.redirect(i)},update_url_for_annotation:function(e){return u.is_annotation_marker_enabled()&&(e=e.updateQuery("annotation_marker","1")),u.is_annotation_highlight_enabled()&&(e=e.updateQuery("annotation_highlight","1")),u.is_annotation_region_enabled()&&(e=e.updateQuery("annotation_region","1")),e},update_url_with_user_id:function(e,t){return e.updateQuery(l.UID_PARAM_NAME,t)},isPreviewable:function(t){var n,i,o,s,a;return i=d.get_extension(t),s="doc"===(a=t.preview_type)||"excel"===a||"keynote"===a||"adobecs"===a||"linkfile"===a,o=t.bytes<r.MAX_PDF_FILE_SIZE_B||"pdf"!==i,n=!e.msie_version_at_most(9),s&&o&&n},canGeneratePreview:function(e){var t;return t=d.get_extension(e),d.isPreviewable(e)&&e.doc_preview_status!==r.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&d.extCanGeneratePreview(t)},extCanGeneratePreview:function(e){var t;return t=d.normalize_extension(e),"doc"===t||"ppt"===t||"xls"===t||"key"===t||"eps"===t||"ai"===t||"indd"===t},usesFrameMessenger:function(e){return"excel"===e||"text"===e||"doc"===e}},{PermissionHelper:u,PreviewHelper:d}})}.call(this),function(){define("modules/clean/react/activity/annotation_button",["external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/image_preview_util","modules/core/i18n"],function(e,t,n,i,o,s,r){var a,l,c,u,d,p,h,_,m,f,v,g;return l=o.Annotation,d=o.AnnotationTypes,u=o.AnnotationSubtypes,v=r._,g=e.DOM,h=610,p=790,_=28,f=6,m=3,a=120,c=e.createClass({displayName:"AnnotationButton",propTypes:{annotation:e.PropTypes.object,revision:e.PropTypes.object,isOldRevision:e.PropTypes.bool,onAnnotationButtonMouseUp:e.PropTypes.func,thumbnailUrl:e.PropTypes.string,shouldShowAnnotationUIOnImages:e.PropTypes.bool},getDefaultProps:function(){return{}},getInitialState:function(){return{}},_getThumbnail:function(e,t,n){var i;return this.props.thumbnailUrl?this._getThumbnailImageFromUrl():(i=_*t/n,g.div({className:"annotation-thumbnail-page",style:{width:i,height:_}},this._getAnnotationThumbnail(e,t,n,i,_)))},_getAnnotationThumbnail:function(e,n,i,o,s){var r,a,l,c,u,p,h,_,v,y,b,w,C,E,S,T,A,I;switch(r=this.props.annotation,r.type){case d.MARKER:return l=null!=e&&null!=(E=e[0].coordinates)?E[0]:void 0,g.div({className:"annotation-thumbnail-page__marker",style:{left:this._calculateThumbnailDistance(null!=l?l.x:void 0,n,o,f),top:this._calculateThumbnailDistance(null!=l?l.y:void 0,i,s,f)}});case d.HIGHLIGHT:for(T=[],C=r.getFirstPdfPage(),u=0,h=e.length;h>u;u++)c=e[u],c.page===C&&(a=c.coordinates[1].x-c.coordinates[0].x,
T.push(g.div({className:"annotation-thumbnail-page__highlight",style:{left:this._calculateThumbnailDistance(c.coordinates[0].x,n,o),top:this._calculateThumbnailDistance(c.coordinates[0].y,i,s,m),width:this._calculateThumbnailDistance(a,n,o)}})));return T;case d.REGION:for(T=[],C=r.getFirstPdfPage(),p=0,_=e.length;_>p;p++)S=e[p],S.page===C&&(A=t.pluck(S.coordinates,"x"),I=t.pluck(S.coordinates,"y"),b=t.min(A),v=t.max(A),w=t.min(I),y=t.max(I),T.push(g.div({className:"annotation-thumbnail-page__region",style:{left:this._calculateThumbnailDistance(b,n,o),top:this._calculateThumbnailDistance(w,i,s),width:this._calculateThumbnailDistance(v-b,n,o),height:Math.abs(this._calculateThumbnailDistance(y,i,s)-this._calculateThumbnailDistance(w,i,s))}})));return T}},_getThumbnailImageFromUrl:function(){return g.div({className:"annotation-thumbnail-image"},g.img({src:this.props.thumbnailUrl}))},_getAnnotationText:function(){var e;return e=this.props.annotation.text_highlight.text,e.length>a&&(e=e.substring(0,a-3)+"..."),'"'+e+'"'},_calculateThumbnailDistance:function(e,t,n,i){var o;return null==i&&(i=0),n-=i,o=i/2,e/t*n+o},_translateCoordinates:function(e,t,n){var i,o,s,r,a,l,c,u,d,p,h;for(d=[],s=0,a=e.length;a>s;s++){for(i=e[s],o=[],u=i.coordinates,r=0,l=u.length;l>r;r++)c=u[r],p=t(c.x),h=n(c.y),o.push({x:p,y:h});d.push({coordinates:o,page:i.page})}return d},onAnnotationButtonMouseUp:function(e){return this.props.onAnnotationButtonMouseUp(e)},render:function(){var e,t,n,o,r,a,l,c;if(t=this.props.annotation,c=this.props.revision,a=this.props.isOldRevision,t.isImageAnnotation()){if(!this.props.shouldShowAnnotationUIOnImages)return null;e=(new s).getPreviewImage(),r=e.width(),o=e.height(),n=this._translateCoordinates(t.image_coordinates,function(e){return e*r},function(e){return e*o})}else r=h,o=p,null!=(null!=(l=t.pdf_coordinates)?l[0].page_size:void 0)&&(r=t.pdf_coordinates[0].page_size.width,o=t.pdf_coordinates[0].page_size.height),n=this._translateCoordinates(t.pdf_coordinates,function(e){return e},function(e){return o-e});return g.a({className:"comment-annotation-button",onMouseUp:this.onAnnotationButtonMouseUp},g.div({className:"annotation-page-label"},this._getThumbnail(n,r,o),g.div({className:"annotation-thumbnail-label"},t.isPdfAnnotation()?g.div({className:"annotation-thumbnail-label__page"},v("Page %(page_number)s").format({page_number:t.getFirstPdfPage()})):t.isImageAnnotation()?g.div({className:"annotation-thumbnail-label__page"},v("Annotation")):void 0,g.div({className:"annotation-thumbnail-label__info"},null!=c.when&&!isNaN(new Date(null!=c.when))&&a?v("on older revision, updated %(time_ago)s").format({time_ago:i.ago(new Date(1e3*c.when))}):v("on latest revision")))),t.type===d.HIGHLIGHT?g.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/comment_activity_ui",["external/react","external/underscore","modules/core/exception","modules/clean/activity/activity","modules/clean/activity/file_viewer_state","modules/clean/annotations/annotation","modules/clean/react/activity/like_bar","modules/clean/react/activity/resolve_button","modules/clean/react/activity/time_counter","modules/clean/react/modal","modules/core/i18n","modules/clean/viewer","modules/clean/activity/comment","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/referrer_cleansing_redirect","modules/clean/sticker_util","modules/clean/react/activity/annotation_button","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/utils"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C){var E,S,T,A,I,k,P,N,R,x,O,L,D,M,F,U,B;return U=i.assert,E=o.Activity,N=o.FileActivity,S=r.Annotation,I=r.AnnotationTypes,A=r.AnnotationSubtypes,L=u.SimpleModal,F=d._,B=t.DOM,x=t.createFactory(a),O=t.createFactory(l),D=t.createFactory(c),k=t.createFactory(_),R=t.createFactory(m),M=t.createFactory(f),T=t.createFactory(y),P=t.createClass({displayName:"CommentActivityUI",propTypes:{context:t.PropTypes.number,context_activity_store:t.PropTypes.object.isRequired,parentActivity:t.PropTypes.instanceOf(E).isRequired,fileActivity:t.PropTypes.instanceOf(N).isRequired,comment_activity:t.PropTypes.object.isRequired,onUpdateResolve:t.PropTypes.func.isRequired,onDeleteComment:t.PropTypes.func.isRequired,user:t.PropTypes.object.isRequired,onLikeComment:t.PropTypes.func,onAnnotationButtonMouseUp:t.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:t.PropTypes.bool,fileViewerState:t.PropTypes.object,shouldAutoLinkify:t.PropTypes.bool,shouldUseSimpleModals:t.PropTypes.bool,shouldHidePhotoAvatars:t.PropTypes.bool,isReply:t.PropTypes.bool,shouldShowReplyButton:t.PropTypes.bool,onReplyButtonMouseUp:t.PropTypes.func,isVisibleAtMentions:t.PropTypes.bool,isOffline:t.PropTypes.bool,shouldShowAnnotationUIOnImages:t.PropTypes.bool},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isVisibleAtMentions:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,shouldShowAnnotationUIOnImages:!0}},getInitialState:function(){return{hover:!1}},onAnnotationButtonMouseUp:function(){var e,t;return C.isFluxEnabled(this.props.context)?b.revealAnnotation({commentActivity:this.props.comment_activity}):(t=this.props.comment_activity.comment,"function"==typeof(e=this.props).onAnnotationButtonMouseUp?e.onAnnotationButtonMouseUp(this.props.comment_activity,t.comment_metadata):void 0)},isCommentPending:function(){return null!=this.props.comment_activity.isPending},onUpdateResolve:function(e){return C.isFluxEnabled(this.props.context)?e?b.resolveComment(this.props.comment_activity):b.unresolveComment(this.props.comment_activity):this.props.onUpdateResolve(this.props.comment_activity,e)},onDeleteComment:function(e){var t,n;return n=this.props.shouldUseSimpleModals?"simple":"default",t=this.props.context,e.preventDefault(),L.show({title_text:F("Delete comment?"),body_html:F("Are you sure you want to delete this comment?"),cancel_text:F("Cancel"),confirm_text:F("Delete"),style:n,confirm_callback:function(e){return function(){return C.isFluxEnabled(t)?b.deleteComment({commentActivityKey:e.props.comment_activity.activity_key}):e.props.onDeleteComment(e.props.comment_activity)}}(this)})},onLikeComment:function(){var e;return"function"==typeof(e=this.props).onLikeComment?e.onLikeComment(this.props.comment_activity):void 0},_isCommentForOldRevision:function(){var e,t;return C.isFluxEnabled(this.props.context)?(t=null!=(e=this.props.comment_activity.comment.comment_metadata)?e.revision:void 0,C.isOldRevision(t,this.props.fileActivity.latestRevision)):null!=this.props.fileViewerState&&this.props.comment_activity.comment.has_metadata()?(t=this.props.comment_activity.comment.comment_metadata.revision,null!=t&&this.props.fileViewerState.isOldRevision(t)):!1},onReplyButtonMouseUp:function(){var e;return"function"==typeof(e=this.props).onReplyButtonMouseUp?e.onReplyButtonMouseUp():void 0},onRetryPendingComment:function(){return U(this.isCommentPending(),"Cannot retry posting non-pending comment"),b.postPendingComment({targetActivity:this.props.parentActivity,pendingCommentActivity:this.props.comment_activity})},_renderAnnotationLocation:function(e){var t,n;return t=S.createAnnotationFromDict(e.annotation),n=e.revision,B.div({className:"comment-annotation"},T({revision:n,annotation:t,isOldRevision:this._isCommentForOldRevision(),onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,thumbnailUrl:this.props.shouldAnnotationButtonUseThumbnailUrls?e.thumbnailUrl:"",shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages}))},renderPhoto:function(){var t,n,i;return n={dimension:32,defaultAvatar:new R({dimension:32,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials})},this.props.shouldHidePhotoAvatars||""===this.props.comment_activity.comment.commenter.photo_circle_url||(n.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),i=this.props.comment_activity.comment.commenter.id,t=e.call(p.get_viewer().get_user_ids(!0),i)>=0?new M(n):new k(n),B.div({className:"commenter-photo"},this.props.isReply?void 0:t)},renderCommentBody:function(){var e;return e=this.props.comment_activity.comment.raw_comment_text,h.convertRawCommentTextToHtml(e,this.props.shouldAutoLinkify,this.props.isVisibleAtMentions)},renderBody:function(){var e,t,i,o,s,r;return e=this.state.hover,r=p.get_viewer(),s=n.intersection(r.get_user_ids(!0),null!=(o=this.props.comment_activity.permissions)?o.user_ids_who_can_delete:void 0).length,(!s&&!r.can_moderate_comments||this.props.isOffline)&&(e=!1),t=this.props.comment_activity.comment,t.has_metadata()&&t.comment_metadata.has_annotation_data()&&(i=this._renderAnnotationLocation(t.comment_metadata)),B.div({className:"comment-body"},B.div({className:"comment-top-bar"},B.div({className:"commenter-name"},t.commenter.display_name),this.isCommentPending()||!this.props.user.is_signed_in||this.props.isReply?void 0:O({resolved:t.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline})),t.has_metadata()&&t.comment_metadata.has_sticker_data()?B.div({className:"comment-sticker-body"},B.img({src:g.getStickerImageUrl(t.comment_metadata.get_sticker_id())})):B.span({},B.div({className:"comment-text"},this.renderCommentBody()),i),this.isCommentPending()?B.div({className:"comment-bottom-bar"},"FAILED"===this.props.comment_activity.status?B.div({className:"pending-comment--failed"},B.span({className:"pending-comment__warning"},F("Unable to post comment.")),B.a({className:"pending-comment__retry",onClick:this.onRetryPendingComment},F("Retry"))):B.div({className:"pending-comment--pending"},D({when_mses:t.when_mses}))):B.div({className:"comment-bottom-bar"},x({context:this.props.context,activity:this.props.comment_activity,context_activity_store:this.props.context_activity_store,isOffline:this.props.isOffline,user:this.props.user,onLikeComment:this.onLikeComment}),this.props.shouldShowReplyButton?B.a({className:"reply-button",onMouseUp:this.onReplyButtonMouseUp},F("Reply")):void 0,B.div({className:"bottom-dot",dangerouslySetInnerHTML:{__html:"&middot;"}}),D({when_mses:t.when_mses}),e?B.span({},B.div({className:"second-bottom-dot",dangerouslySetInnerHTML:{__html:"&middot;"}}),B.div({className:"delete-icon",onMouseDown:function(e){return function(t){return e.onDeleteComment(t)}}(this)},F("Delete"))):void 0))},render:function(){var e;return e=t.addons.classSet({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply,"comment--pending":this.isCommentPending()}),B.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key,onMouseMove:function(e){return function(){return e.setState({hover:!0})}}(this),onMouseLeave:function(e){return function(){return e.setState({hover:!1})}}(this)},B.div({className:e},this.renderPhoto(),this.renderBody()))}})})}.call(this),function(){define("modules/clean/react/activity/comment_count_bubble",["external/react","modules/core/i18n"],function(e,t){var n,i,o,s,r;return o=t._,r=e.DOM,s=e.addons.classSet,n=e.createClass({displayName:"CommentCountBubble",propTypes:{unresolvedCommentCount:e.PropTypes.number.isRequired,unseenCommentCount:e.PropTypes.number.isRequired},_unresolvedCommentCountDisplay:function(){return o(this.props.unresolvedCommentCount>9?"9+":String(this.props.unresolvedCommentCount))},render:function(){var e;return e=s({"comment-count-bubble":!0,"comment-count-bubble--unseen":this.props.unseenCommentCount>0}),this.props.unresolvedCommentCount>0?r.span({className:e},this._unresolvedCommentCountDisplay()):null}}),i=e.createFactory(n),{CommentCountBubble:n,CommentCountBubbleFactory:i}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/comment_input",["jquery","external/react","external/underscore","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/contacts/util","modules/clean/gandalf_util","modules/clean/keycode","modules/clean/storage","modules/clean/react/activity/mentions_controller","modules/clean/react/activity/users_to_notify","modules/clean/react/button","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/viewer","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n","modules/constants/legacy"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S){var T,A,I,k,P,N,R,x,O,L,D,M,F,U,B,V;return F=r._,V=r.ungettext,T=l.Activity,k=l.FileActivity,I=l.CommentActivity,N=_.LocalStorage,O=E.R_,R=4e3,B=n.DOM,L=n.createFactory(n.addons.CSSTransitionGroup),x=n.createFactory(m),D=n.createFactory(f),A=n.createFactory(g),P=n.createFactory(y),M=n.createFactory(b),U=n.createFactory(v.button),n.createClass({displayName:"CommentInput",propTypes:{activity:n.PropTypes.instanceOf(k).isRequired,metadata:n.PropTypes.object,onAddComment:n.PropTypes.func,onCancelComment:n.PropTypes.func,resizeCallback:n.PropTypes.func,positionDropdownCallback:n.PropTypes.func,onFocus:n.PropTypes.func,onBlur:n.PropTypes.func,user:n.PropTypes.instanceOf(c).isRequired,onShowNewComment:n.PropTypes.func,inBlankState:n.PropTypes.bool,enableNotifyText:n.PropTypes.bool,enableNoNotifyHint:n.PropTypes.bool,showNewComment:n.PropTypes.bool,shouldPopupsDropdown:n.PropTypes.bool,verifyAfterSignUpCallback:n.PropTypes.func,initialText:n.PropTypes.string,shouldInitiallyFocusInput:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,isCommentInputDisabled:n.PropTypes.bool,shouldEnableStickers:n.PropTypes.bool,onAddSticker:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,enableImport:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,isReplyInput:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldEnableCancelButton:n.PropTypes.bool,isOffline:n.PropTypes.bool,shouldShowAvatar:n.PropTypes.bool,onStickerDropdownShown:n.PropTypes.func,onStickerDropdownHidden:n.PropTypes.func,onContactsSelectorPopupShown:n.PropTypes.func,onContactsSelectorPopupHidden:n.PropTypes.func,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:n.PropTypes.bool,shouldScrollIntoView:n.PropTypes.bool},getInitialState:function(){var e,t,n,i,o;return e=!0,o=this.props.shouldAlwaysInEditMode,t=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=(n=this.props.activity)?n.activity_key:void 0),t.length>0&&(e=!1,o=!0),{button_disabled:e,shouldShowPostButton:o,initialText:t,users_to_notify:null!=(i=this.props.activity)?i.users_to_notify:void 0,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:t.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1,shouldEnableCancelButton:!1,isOffline:!1,shouldShowAvatar:!0,metadata:null,shouldScrollIntoView:!1}},componentDidMount:function(){var e,n;return this.props.shouldScrollIntoView&&this.getDOMNode().scrollIntoView(),n=function(e,n){var i;return i=(null!=n?n.getDOMNode():void 0)||null,i?e.target===i||t.contains(i,e.target):!1},t(this.getDOMNode()).on("click.comment-input",function(e){return function(t){return n(t,e.refs.postButton)&&e.verifySubscribersBeforePost(),n(t,e.refs.showNewCommentButton)?e.props.onShowNewComment():void 0}}(this)),this._wasUsedLoggedOutPreviously()&&this.props.user.is_signed_in?this.props.user.is_email_verified?null!=o.mozilla?setTimeout(function(e){return function(){return e.postComment()}}(this),0):this.postComment():"function"==typeof(e=this.props).verifyAfterSignUpCallback?e.verifyAfterSignUpCallback():void 0:void 0},componentWillUnmount:function(){return t(this.getDOMNode()).off(".comment-input")},componentWillReceiveProps:function(e){return this.updateNotificationCount(e.activity)},componentDidUpdate:function(e,t){return!t.shouldShowPostButton&&this.state.shouldShowPostButton?this.getDOMNode().scrollIntoView():void 0},_contactsSelectorPopupShown:function(){var e;return C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id),"function"==typeof(e=this.props).onContactsSelectorPopupShown?e.onContactsSelectorPopupShown():void 0},_contactsSelectorPopupHidden:function(){var e;return"function"==typeof(e=this.props).onContactsSelectorPopupHidden?e.onContactsSelectorPopupHidden():void 0},_onAtSignKeyPress:function(){return this.props.user.is_signed_in?C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id):void 0},_onNoAtSignKeyPress:function(){return C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(){return s.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(e){var t;return s.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),t=e?S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,t,this.props.user.id)},_onStickerPopupShown:function(){return C.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_STICKERS_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.STICKER_BUTTON,this.props.user.id)},onMentionsFocus:function(e){var t;return this.togglePostButton(!0),"function"==typeof(t=this.props).onFocus?t.onFocus(e):void 0},onMentionsBlur:function(){var e;if("function"==typeof(e=this.props).onBlur&&e.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else if(!this.props.shouldAlwaysInEditMode)return this.togglePostButton(!1)},onMentionsCancel:function(){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},onKeyDown:function(e){return e.keyCode===h.ENTER&&(e.ctrlKey||e.metaKey)?(this.verifySubscribersBeforePost(),e.preventDefault()):void 0},onKeyUp:function(){return this._setPostButtonState(),this.updateNotificationCount(this.props.activity)},onPaste:function(e){return e.clipboardData.getData("text/plain").length>R?(a.error(F("The text you're trying to paste is too long.")),e.preventDefault()):setTimeout(function(e){return function(){return e._setPostButtonState(),e.updateNotificationCount(e.props.activity)}}(this),10)},refreshDropdownDirection:function(){var e;return"function"==typeof(e=this.props).positionDropdownCallback?e.positionDropdownCallback():void 0},togglePostButton:function(e){return this.setState({shouldShowPostButton:e},function(e){return function(){var t;return"function"==typeof(t=e.props).resizeCallback?t.resizeCallback():void 0}}(this))},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},_wasUsedLoggedOutPreviously:function(){return this.state.initialText.length>0&&null==this.props.initialText},updateNotificationCount:function(e){var t,n,o,s,r,a,l,u,d,p,h,_,m;if(null!=(null!=e?e.users_to_notify:void 0)){if(_=function(){var t,n,i,o;for(i=e.users_to_notify,o=[],t=0,n=i.length;n>t;t++)m=i[t],o.push(m.unique_id);return o}(),d=this.refs.mentions.extractMentions(),u=function(){var e,t,n;for(n=[],e=0,t=d.length;t>e;e++)l=d[e],n.push(l.dbx_account_id||l.identifier);return n}(),t=i.union(_,u).sort(),n=i.pluck(this.state.users_to_notify,"id").sort(),i.isEqual(n,t))return;for(p=i.object(u,d),r=i.difference(t,_),h=i.clone(e.users_to_notify),o=0,a=r.length;a>o;o++)s=r[o],h.push(new c({id:s,display_name:p[s].name}));return this.setState({users_to_notify:h})}},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(){return this.postComment()},_setPostButtonState:function(){var e;return e=""===this.refs.mentions.getEncodedMessage(),this.state.button_disabled!==e?this.setState({button_disabled:e}):void 0},verifySubscribersBeforePost:function(){var e,t,n,i;return this.props.user.is_signed_in&&(e=function(){var e,t,n,o;for(n=this.state.users_to_notify,o=[],e=0,t=n.length;t>e;e++)i=n[e],i.id!==this.props.user.id&&o.push(i);return o}.call(this),0===e.length&&0===(null!=(t=this.props.activity.comment_activities)?t.length:void 0)&&this.props.enableNoNotifyHint)?void(null!=(n=this.refs.mentions)&&n.showNoNotifyHint()):this.postComment()},postComment:function(){var e,t;return(t=this.refs.mentions.getEncodedMessage())?t.length>R?void a.error(F("The comment is too long.")):(this.shouldSaveText()||(this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._setPostButtonState(),this.togglePostButton(!1)),"function"==typeof(e=this.props).onAddComment?e.onAddComment(t):void 0):void 0},focusInput:function(){var e;return null!=(e=this.refs.mentions)?e.focusInput():void 0},getRawCommentInput:function(){var e;return null!=(e=this.refs.mentions)?e.getRawMessage():void 0},getPlaceholderText:function(){return this.placeholderText},_usersToNotifyToContacts:function(e){var t,n,i,o;for(t=[],n=0,i=e.length;i>n;n++)o=e[n],o.id!==this.props.user.id&&t.push(d.activityUserToContact(o,Number.MAX_VALUE));return t},_onCancelMouseUp:function(){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},_clearCommentLocalStorage:function(){return N.set("tmp-file-comment",null)},_getCommentLocalStorage:function(e){var n,i;return i=N.get("tmp-file-comment"),n="",i&&i.activity_key===e&&((new Date).getTime()-i.time<3e5&&(n=i.text),this._clearCommentLocalStorage()),t("<div/>").html(n).text()},_storeCommentLocalStorage:function(e,n){var i;return i=t("<div/>").text(e).html(),N.set("tmp-file-comment",{activity_key:n,text:i,time:(new Date).getTime()})},_renderShowNewComment:function(){var e,t;return t=[],this.props.showNewComment&&(e=B.a({className:"show-new-comment-button",ref:"showNewCommentButton"},B.span({className:"show-new-comment-icon",key:key}),B.span({className:"show-new-comment-text"},F("New Comment"))),t=B.div({className:"comment-show-new-comment"},e)),L({transitionName:"comment-show-new-comment",component:"div"},t)},_renderCommentBox:function(){var e,t;return this.placeholderText=F(this.props.isReplyInput?"Reply...":this.props.inBlankState?"Write a comment":"Comment or @mention"),e=null!=this.props.activity?this.props.activity.users_to_notify:[],t=x({ref:"mentions",placeholder_text:this.placeholderText,initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,showMentionsHelper:"ON"===p.getGandalfRule("comments_add_mention_dropdown")&&this.props.user.is_signed_in,enableNoAtMentions:"ON"===p.getGandalfRule("comments_no_at_mentions")&&this.props.user.is_signed_in,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:function(e){return function(){return e.updateNotificationCount(e.props.activity)}}(this),contactsSelectorPopupShown:this._contactsSelectorPopupShown,contactsSelectorPopupHidden:this._contactsSelectorPopupHidden,onContactsSelectorSuggestionsUpdate:this.props.onContactsSelectorSuggestionsUpdate,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactPopupSelectedCallback:this._contactPopupSelectedCallback,contactSelectedCallback:this._contactSelectedCallback,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(e),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldEnableStickers:this.props.shouldEnableStickers,onStickerPopupShown:this._onStickerPopupShown,onAddSticker:this.props.onAddSticker,onStickerDropdownShown:this.props.onStickerDropdownShown,onStickerDropdownHidden:this.props.onStickerDropdownHidden,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize}),B.div({className:"comment-box"},t,B.div({className:"post-area",ref:"postArea"},this.props.enableNotifyText&&!this.props.isReplyInput?this._renderTooltipContainer():void 0,this._renderButtonsContainer()))},_renderCommenterPhoto:function(){var t,n,i,o;return n={dimension:32,defaultAvatar:new P({dimension:32,shape:"CIRCLE",initials:this.props.user.initials||"?"})},this.props.shouldHidePhotoAvatars||(n.photoUrl=this.props.user.photo_circle_url),i=null!=(o=this.props.user)?o.id:void 0,t=e.call(w.get_viewer().get_user_ids(!0),i)>=0?new M(n):new A(n),B.div({className:"commenter-photo"},this.props.shouldShowAvatar?t:void 0)},_renderTooltipContainer:function(){return this.props.isOffline?B.div({className:"comment-box-text"},O({},"Posting will be re-enabled when you are online")):B.div({className:"tooltip-container"},D({usersToNotify:this.state.users_to_notify,user:this.props.user,shouldShowExtraText:!this.state.shouldShowPostButton}))},_renderCancelButton:function(){return B.a({className:"cancel-button",onMouseUp:this._onCancelMouseUp},F("Cancel"))},_renderButtonsContainer:function(){var e,t,n,i;return n=!this.state.shouldShowPostButton,t=this.state.button_disabled||this.props.isOffline,e={className:"post-button",disabled:t,ref:"postButton"},i=U(e,F("Post")),B.div({className:"button-container",hidden:n},i,this.props.shouldEnableCancelButton?this._renderCancelButton():void 0)},render:function(){var e;return e=n.addons.classSet({"comment-field":!0,"comment-field--disabled":this.props.isCommentInputDisabled||this.props.isOffline}),B.div({className:e},this._renderShowNewComment(),this._renderCommenterPhoto(),this._renderCommentBox(),this.props.isCommentInputDisabled||this.props.isOffline?B.div({className:"comment-field__diabled"},""):void 0)}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/contacts_selector",["external/react","external/typeahead.bundle","jquery","modules/clean/keycode","modules/clean/ajax","modules/clean/activity/activity_user","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/exception"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m){var f,v,g,y,b,w,C,E;return y=h.LinkedProfileServices,w=h.ProfileServicesLinkingHandler,C=t.addons.classSet,E=t.DOM,b=5,v=99,g=3,f=t.createClass({displayName:"ContactsSelector",propTypes:{showNullHint:t.PropTypes.bool,contactSelectedCallback:t.PropTypes.func,contactHighlightedCallback:t.PropTypes.func,contactSearchLogger:t.PropTypes.object,noAtMentionTriggerCallback:t.PropTypes.func,resultsLimit:t.PropTypes.number,matchFullQUery:t.PropTypes.bool,noMatchesText:t.PropTypes.string,user:t.PropTypes.object,showContactsInNullState:t.PropTypes.bool,x_offset:t.PropTypes.number,y_offset:t.PropTypes.number,enableImport:t.PropTypes.bool,show_contacts:t.PropTypes.bool,should_dropdown:t.PropTypes.bool,last_keydown:t.PropTypes.number,extraContacts:t.PropTypes.arrayOf(t.PropTypes.object),shouldHidePhotoAvatars:t.PropTypes.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&(this.profile_services=y.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:m._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1}},componentWillMount:function(){return this.contacts=new a,this.contacts.setExtraContacts(this.props.extraContacts),0===this.state.query.length&&this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidMount:function(){var e,t;return this.$typeahead_container=i(null!=(e=this.refs.suggestionsContainer)?e.getDOMNode():void 0),this.$typeahead_suggestions=i(null!=(t=this.refs.suggestionsList)?t.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),this.state.show_contacts?void 0:this._reset_import_state()},componentWillReceiveProps:function(e){return this.contacts.setExtraContacts(e.extraContacts),0===this.state.query.length&&e.showContactsInNullState!==this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidUpdate:function(){var e,t,n;return this.$typeahead_container=i(null!=(t=this.refs.suggestionsContainer)?t.getDOMNode():void 0),this.$typeahead_suggestions=i(null!=(n=this.refs.suggestionsList)?n.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof(e=this.props).contactHighlightedCallback?e.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(e){var t,n,i,o;for(i=p.contact_services(),t=0,n=i.length;n>t;t++)o=i[t],e.push(this._append_provider(o));return e},_append_provider:function(e){var t;return t=p.to_name(e),this.profile_services.service_is_connected(e)&&(t+=m._(" (Connected)")),{type:v,provider:e,name:t,photo_url:p.to_img(e)}},_import_contacts_mouseover:function(){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(e){return e.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(e){return null!=e&&this.state.focused_row!==e||null===e?this.setState({focused_row:e}):void 0},_focus_suggestion_row_mouseover:function(e){var t,n;return t=i(e.currentTarget),n=t.index(),n>-1?this._focus_suggestion_row(n):void 0},_get_suggestion_row:function(){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(e,t,n){var i,s,r,a,u;return this.isMounted()?(t=function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)r=t[e],r.type!==c.NEW_STYLE_GROUP&&i.push(r);return i}(),t=l.sortContactsByTeamFirst(t),n||(t=e.length>=b?this._getApproximateNameMatches(e,t):this._getExactFirstOrLastNameMatches(e,t)),this.matchesCountFromBloodhoundContacts=t.length,
t=t.slice(0,this.props.resultsLimit),a=t.length,u=0===a&&this.props.last_keydown!==o.SPACE&&e.indexOf(" ")<0||0===a&&this.props.matchFullQUery,n||"function"==typeof(s=this.props).noAtMentionTriggerCallback&&s.noAtMentionTriggerCallback(a),this.props.enableImport&&0===a?t=this._append_import_to_suggestions(t):a>0&&this._reset_import_state(),this.props.should_dropdown?i=0:(i=t.length-1,t.reverse()),this.setState({suggestions:t,focused_row:i,show_no_results:u,matches_count:a})):void 0},_has_suggestion_row_at_index:function(e){return null!=e&&e>=0&&e<this.get_suggestions_count()},_mouse_down_select_suggestion:function(e){return e.preventDefault(),this.select_suggestion(e.currentTarget)},_position_contacts_list:function(){var e,t;return t=this.$typeahead_container.parent(),e=this.$typeahead_container.width(),e+this.props.x_offset>t.width()?this.$typeahead_container.css("left",t.width()-e):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(t,n){var i;return function(){var o,s,r;for(r=[],o=0,s=n.length;s>o;o++)i=n[o],e.call(i.name_tokens,t)>=0&&r.push(i);return r}()},_getApproximateNameMatches:function(e,t){var n,i,o,s,r,a,l,c;for(a=[],n=0,o=t.length;o>n;n++)for(r=t[n],c=r.name_tokens,i=0,s=c.length;s>i;i++)if(l=c[i],0===l.indexOf(e)){a.push(r);break}return a},get_suggestions:function(e,t){return null==t&&(t=!0),null!=this.props.user&&this.props.user.is_signed_in?(this.contacts.get(e,function(n){return function(i){return n._get_suggestions_callback(e,i,t)}}(this)),this.setState({query:e})):void 0},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(e){var t,n,i,s,r;if(t=e.keyCode||e.which||e.charCode,e.keyCode===o.ENTER||e.keyCode===o.TAB){if(e.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row))return r=this._get_suggestion_row(this.state.focused_row),this.select_suggestion(r)}else if(((i=e.keyCode)===o.UP||i===o.DOWN)&&(n=this.get_suggestions_count(),n>0))if(e.keyCode===o.UP){if(s=null!=this.state.focused_row?this.state.focused_row:n,0!==this.state.focused_row)return this._focus_suggestion_row((s-1)%n)}else if(e.keyCode===o.DOWN&&(s=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==n-1))return this._focus_suggestion_row((s+1)%n)},select_suggestion:function(e){var t,n,o;return t=i(e),t.data("type")===v?void(null!=this.props.user&&this.props.user.is_signed_in&&(n=new w,n.auth_service_with_user(String(t.data("provider")),this.props.user.id,function(e){return w.show_import_notifications(e)},"contact-importer-modal"))):(null!=this.props.contactSearchLogger&&(o={sort_variant:this.contacts.getSortVariant(),context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:t.data("type"),contact_id:t.data("identifier"),contact_name:t.data("name"),did_select_suggestion:!0},this.props.contactSearchLogger.add_record(o)),null!=this.contactSelectedCallback&&this.contactSelectedCallback(t),this.isMounted()?this.setState({focused_row:null,suggestions:[]}):void 0)},render:function(){var e,n,i,o;return n=t.addons.classSet({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),E.div({className:n,ref:"suggestionsContainer"},this.props.show_contacts&&this.props.user?this.props.user.is_signed_in?0===this.state.query.length&&this.props.showNullHint&&!this.props.showContactsInNullState?E.div({className:"suggestion-row empty-state-row"},m._("Mention someone by name or email")):this.state.query.length||0===this.state.query.length&&this.props.showContactsInNullState?(e=E.div({ref:"suggestionsList"},function(){var e,t,i,s;for(i=this.state.suggestions,s=[],e=0,t=i.length;t>e;e++)o=i[e],s.push(function(e){return function(t){var i,o,s,a,l,p,h,_,f;return n={"import-row":t.type===v,"suggestion-row":!0,focused:null!=e.state.focused_row&&e.state.suggestions.indexOf(t)===e.state.focused_row},a=C(n),t.type===c.EMAIL?(_=t.email,l=t.email):t.type===c.FB?(_="fb_"+t.fb_id,l="Facebook Contact"):t.type===c.NEW_STYLE_GROUP?(_=t.group_id,l="Group"):t.type===v?(_="Import-"+t.name,s=E.img({src:t.photo_url})):t.type===c.DBX_ID&&(_=t.dbx_account_id,l=m._("Dropbox User")),p=!1,null!=t.name&&t.name.length>0?f=t.name:null!=t.email&&(p=!0,f=t.email,l=null),t.type===v||null==t.photo_url&&null==f||(p?h="@":(i=new r({display_name:f}),h=i.initials),o={dimension:32,defaultAvatar:new d({dimension:32,shape:"CIRCLE",initials:h})},e.props.shouldHidePhotoAvatars||(o.photoUrl=t.photo_url),s=new u(o)),E.div({key:_,className:a,"data-identifier":_,"data-name":f,"data-type":t.type,"data-photo-url":t.photo_url,"data-dbx-account-id":t.dbx_account_id||null,"data-provider":t.provider||null,onMouseDown:function(t){return e._mouse_down_select_suggestion(t)},onMouseEnter:function(t){return e._focus_suggestion_row_mouseover(t)}},E.div({className:"suggestion-wrapper"},s?E.div({className:"suggestion-avatar"},s):void 0,E.div({className:"suggestion-info"},null!=f?E.div({className:"suggestion-name"},f):void 0,null!=l?E.div({className:"suggestion-identifier"},l):void 0)))}}(this)(o));return s}.call(this)),this.state.show_no_results?E.div({},E.div({className:"suggestion-row empty-state-row"},E.div({className:"empty-state-row-text"},this.state.hover_import_contact||this.state.show_import_list?m._("Import Contacts"):this.props.noMatchesText),this.props.enableImport?(i={"import-contacts":!0,active:null!=this.state.show_import_list},E.a({className:C(i),onMouseDown:function(e){return function(t){return e._mouse_down_import_contacts(t)}}(this),onMouseEnter:function(e){return function(t){return e._import_contacts_mouseover(t)}}(this),onMouseLeave:function(e){return function(t){return e._import_contacts_mouseleave(t)}}(this)},_({group:"web",name:"user_add"}))):void 0),this.state.show_import_list?E.div({className:C({"suggestion-row-top-divider":!0,"animating-down":this.props.should_dropdown,"animating-up":!this.props.should_dropdown})},e):void 0):this._matches_count()>0?e:void 0):void 0:E.div({className:"suggestion-row empty-state-row"},m._("Login to @mention your contacts")):void 0)}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/contacts_selector_popup",["jquery","external/react","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/activity/activity","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/react/react_i18n","modules/clean/validators/validators"],function(t,n,i,o,s,r,a,l,c,u,d){var p,h,_,m,f;return _=n.DOM,h=u.R_,f=[l.UP,l.DOWN,l.ESC,l.ENTER,l.TAB],m=d.check(d.create(["EmailValidator"])),p=n.createClass({displayName:"ContactsSelectorPopup",propTypes:{showContactsInNullState:n.PropTypes.bool,shouldShowNoNotifyHint:n.PropTypes.bool,should_dropdown:n.PropTypes.bool,user:n.PropTypes.object,contactHighlightedCallback:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,emailEnteredCallback:n.PropTypes.func,clearContactHighlightedCallback:n.PropTypes.func,onAddPeopleMouseUp:n.PropTypes.func,onSkipAddMention:n.PropTypes.func,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool},getInitialState:function(){return{query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1}},getDefaultProps:function(){return{showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1}},showNoNotifyHint:function(){var e;return this.setState({shouldShowNoNotifyHint:!0}),"function"==typeof(e=this.props).clearContactHighlightedCallback?e.clearContactHighlightedCallback():void 0},contactHighlightedCallback:function(e){var t;return o.assert(!this.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof(t=this.props).contactHighlightedCallback?t.contactHighlightedCallback(e):void 0},contactSelectedCallback:function(e){var t;return this._resetInput(),"function"==typeof(t=this.props).contactSelectedCallback?t.contactSelectedCallback(e):void 0},_resetInput:function(){return this.setState({query:""}),t(this.refs.contactSelectorPopupInput.getDOMNode()).val(""),this.refs.contactSelectorPopup.get_suggestions("")},_logEmailEntered:function(e){var t;return null!=this.props.contactSearchLogger?(t={sort_variant:null,context:"mentions",contact_type:a.EMAIL,contact_id:e,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(t)):void 0},_onInputKeyDown:function(e){var t,n,o;if(n=e.keyCode||e.which||e.charCode,null!=i.msie&&n===l.ENTER){if(o=e.target.value,this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(m(o))return"function"==typeof(t=this.props).emailEnteredCallback&&t.emailEnteredCallback(o),this._logEmailEntered(o)}},_onInputKeyUp:function(t){var n,i,o;if(i=t.keyCode||t.which||t.charCode,o=t.target.value,null!=this.refs.contactSelectorPopup){if(!(e.call(f,i)>=0))return this.setState({query:o}),this.refs.contactSelectorPopup.get_suggestions(o);if(this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(t);if(i===l.ENTER&&m(o))return"function"==typeof(n=this.props).emailEnteredCallback&&n.emailEnteredCallback(o),this._logEmailEntered(o)}},_onAddPeopleMouseUp:function(e){var n;return this.setState({shouldShowNoNotifyHint:!1},function(e){return function(){var n;return t(null!=(n=e.refs.contactSelectorPopupInput)?n.getDOMNode():void 0).focus()}}(this)),"function"==typeof(n=this.props).onAddPeopleMouseUp?n.onAddPeopleMouseUp(e):void 0},_onSkipAddMention:function(e){var t;return"function"==typeof(t=this.props).onSkipAddMention?t.onSkipAddMention(e):void 0},render:function(){var e,t,n;return _.div({className:"contacts-selector-popup"},this.state.shouldShowNoNotifyHint?_.div({className:"contacts-selector-hint"},"Your comment won't notify anyone.",_.div({}),_.a({className:"",onMouseUp:this._onAddPeopleMouseUp},"Add people"),_.span({className:"bottom-dot"}," · "),_.a({className:"",onMouseUp:this._onSkipAddMention},"Just for me")):(t=_.div({className:"contacts-selector-popup-input-wrapper"},_.input({ref:"contactSelectorPopupInput",onKeyDown:this._onInputKeyDown,onKeyUp:this._onInputKeyUp,placeholder:"Type an email or name"})),e=this.state.query.trim().length>0||this.props.showContactsInNullState?_.hr({className:"separator"}):_.span({}),n=c({ref:"contactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,contactHighlightedCallback:this.contactHighlightedCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.should_dropdown,y_offset:0,x_offset:0,user:this.props.user,last_keydown:this.state.last_keydown,showNullHint:!1,showContactsInNullState:this.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),this.props.should_dropdown?[t,e,n]:[n,e,t]))}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/like_bar",["external/react","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/viewer","modules/clean/comments/actions","modules/clean/comments/utils"],function(t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v;return m=n._,f=t.DOM,v=a.get_viewer(),u=o.ActivityType,h=t.createFactory(s),_=t.createFactory(r.Tooltip),p=15,d=t.createClass({displayName:"LikeBar",propTypes:{context:t.PropTypes.number,context_activity_store:t.PropTypes.object.isRequired,activity:t.PropTypes.object.isRequired,user:t.PropTypes.object.isRequired,onLikeComment:t.PropTypes.func,isOffline:t.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},is_liked_by_viewing_user:function(){var t,n;return this.props.user.is_signed_in?(n=this.props.user.id,e.call(function(){var e,n,i,o;for(i=this.props.activity.likes,o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(t.liker.id);return o}.call(this),n)>=0):void 0},addLike:function(){var e,t,n;return c.isFluxEnabled(this.props.context)?void l.likeComment(this.props.activity):(e=this.props.activity,this.props.user.is_signed_in&&(n=function(e){return function(){return i.error(m("We weren't able to submit your like.")),e.forceUpdate()}}(this),e.activity_type===u.COMMENT?this.props.context_activity_store.add_comment_like(e,this.props.user,null,null,n):this.props.context_activity_store.add_like(e,this.props.user,null,null,n),this.setState({like_added:!0})),"function"==typeof(t=this.props).onLikeComment?t.onLikeComment():void 0)},removeLike:function(){var e,t;return c.isFluxEnabled(this.props.context)?void l.unlikeComment(this.props.activity):(e=this.props.activity,t=function(e){return function(){return i.error(m("We weren't able to remove your like.")),e.forceUpdate()}}(this),e.activity_type===u.COMMENT?this.props.context_activity_store.remove_comment_like(e,this.props.user,null,null,t):this.props.context_activity_store.remove_like(e,this.props.user,null,null,t),this.forceUpdate())},getInitialState:function(){return{like_added:!1}},onLikeClicked:function(){var e;return this.props.isOffline?(e=m(this.is_liked_by_viewing_user()?"Cannot unlike comments while offline":"Cannot like comments while offline"),i.error(e)):this.is_liked_by_viewing_user()?this.removeLike():this.addLike()},render:function(){var e,n,i,o,s,a,l,c;return a=this.props.activity.likes,c=this.is_liked_by_viewing_user()?"bluestar":"star",l=a.length,e=t.addons.classSet({"like-sprite":!0,animating:this.is_liked_by_viewing_user()&&this.state.like_added}),s=function(){var e,t,i;for(i=[],e=0,t=a.length;t>e;e++)n=a[e],i.push(n.liker);return i}(),s=s.slice(0,p),a.length>p&&s.push({id:"extra",display_name:m("%(num_extra)d more...").format({num_extra:a.length-p})}),i=l>0?f.div({className:"liker-names"},function(){var e,t,n;for(n=[],e=0,t=s.length;t>e;e++)o=s[e],n.push(function(){return function(e){return f.div({key:e.id},e.display_name)}}(this)(o));return n}.call(this)):this.props.user.is_signed_in?f.span({},m("Like")):f.span({},m("Login to like comment")),f.div({className:"like-bar"},_({position:r.TooltipPosition.TOP,tooltip_contents:i,tooltip_classname:"like-tooltip"},f.div({},f.a({className:e,onMouseDown:this.onLikeClicked},h({group:"web",name:c,alt:m("like")})),l>0?f.div({className:"like-text"},l):void 0)))}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/activity/mentions_controller",["jquery","external/react","external/purify","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/validators/validators","modules/clean/react/bubble_dropdown","modules/clean/react/input","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/react/activity/contacts_selector","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/file_comments/stickers"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g){var y,b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D,M;return N=r._,k=g.Stickers,x=n.DOM,R=n.addons.classSet,S=h.R_,y=n.createFactory(d),b=n.createFactory(f),w=n.createFactory(v),I=n.createFactory(_),P=n.createFactory(m.Tooltip),O="\ufeff",L=new RegExp(O,"g"),T=" ",A="",C="",D=[c.UP,c.DOWN,c.ESC,c.ENTER,c.TAB],M=u.check(u.create(["EmailValidator"])),E=n.createClass({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:n.PropTypes.bool,enableNoAtMentions:n.PropTypes.bool,showContactsInNullState:n.PropTypes.bool,initialText:n.PropTypes.string,user:n.PropTypes.object,position_contacts_callback:n.PropTypes.func,showMentionsHelper:n.PropTypes.bool,contactSearchLogger:n.PropTypes.object,contactsSelectorPopupShown:n.PropTypes.func,contactsSelectorPopupHidden:n.PropTypes.func,contactPopupSelectedCallback:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,onKeyDown:n.PropTypes.func,onKeyUp:n.PropTypes.func,onAtSignKeyPress:n.PropTypes.func,onNoAtSignKeyPress:n.PropTypes.func,onBlur:n.PropTypes.func,onFocus:n.PropTypes.func,onPaste:n.PropTypes.func,onCancel:n.PropTypes.func,onMention:n.PropTypes.func,placeholder_text:n.PropTypes.string,resultsLimit:n.PropTypes.number,resizeCallback:n.PropTypes.func,onSkipAddMention:n.PropTypes.func,onAddPeopleMouseUp:n.PropTypes.func,shouldInitiallyFocusInput:n.PropTypes.bool,shouldShowNoNotifyHint:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool,shouldEnableStickers:n.PropTypes.bool,onStickerPopupShown:n.PropTypes.func,onAddSticker:n.PropTypes.func,onStickerDropdownShown:n.PropTypes.func,onStickerDropdownHidden:n.PropTypes.func,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:n.PropTypes.bool},getInitialState:function(){var e;return e=this.props.shouldAlwaysInEditMode,this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(e=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:e,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new a,resultsLimit:5,shouldShowNoNotifyHint:!1,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1}},componentDidMount:function(){return this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=o.mozilla?setTimeout(function(e){return function(){return e._replaceInputWithText(e.props.initialText)}}(this),0):this._replaceInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput?setTimeout(function(e){return function(){return e.focusInput()}}(this),0):void 0},componentDidUpdate:function(e,t){var n,i;return this._componentSetup(),i=this._getCaretPosition(),t.show_contacts===this.state.show_contacts||(null!=i?i.left:void 0)===this.state.x_offset&&(null!=i?i.top:void 0)===this.state.y_offset?void 0:(n={x_offset:i.left,y_offset:i.top},this.setState(n))},showNoNotifyHint:function(){var e,t;return this.refreshDropdownDirection(),null!=(e=this.refs.mentionsHintDropdown)&&e.show(),null!=(t=this.refs.mentionsContactSelectorPopup)?t.showNoNotifyHint():void 0},_resetInputToPlaceholderState:function(){return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1})},_replaceInputWithText:function(e){var t,n,o,s,r,a;return e=i.sanitize(e,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus(),r=this._extractCursorInfo(),n=r[0],o=r[1],a=r[2],s=document.createRange(),n&&(s.setStart(n,0),t=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,e=e.replace(t,function(e){return function(t,n,i){return n=n.trim(),i=i.trim(),e._mentionWrapper(n,i)}}(this)),this.unsafeInsertHtmlAtRange(e,s,!0),!this.state.in_edit_mode)?this.setState({in_edit_mode:!0}):void 0},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=t(this.refs.input.getDOMNode()),this.$text_input=t(this.refs.textInput.getDOMNode())},_logEmailEntered:function(e){var t;return null!=this.props.contactSearchLogger?(t={sort_variant:null,context:"mentions",contact_type:l.EMAIL,contact_id:e,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(t)):void 0},_parseInputTextAndReplace:function(){var e,t;return e=0,t=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi),this._parseInputTextWithRegex(t,function(t){return function(n,i){var s,r,a,l,c;return r=n[0],s=n.index,l=r.substring(1),M(l)&&null==o.msie?(c=document.createRange(),c.setStart(i,s),c.setEnd(i,s+r.length),a=t._createMentionObject(l,l),t._addMentionIntoInput(a,c),e++,t._logEmailEntered(l)):void 0}}(this)),e>0?this.setCursorToEndOfInput():void 0},_parseInputTextWithRegex:function(e,n){var i,s,r,a,l,c,u,d;if(s=this.$text_input.html().replace(L,""),null!=s&&""!==s){for(l=this.$text_input[0].childNodes,u=[],r=0,a=l.length;a>r;r++)i=l[r],null!=o.msie&&t(i).is("p")||i.nodeType===Node.TEXT_NODE&&""!==i.nodeValue.trim()?(d=null!=o.msie?t(i).text():i.nodeValue,u.push(function(){var t;for(t=[];null!==(c=e.exec(d));)t.push(n(c,i));return t}())):u.push(void 0);return u}},refreshDropdownDirection:function(){var e;return"function"==typeof(e=this.props).position_contacts_callback?e.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(C)},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(A)},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var e,t;return t=this._getStartRangeUnicodeIndex(),e=this._getEndRangeUnicodeIndex(),t>=0&&e>0&&e>t},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(e){var t,n,o,s,r;return this._getStartRangeUnicodeIndex()>=0?(r=this._getStartRangeUnicodeIndex(),n=this.$text_input.html(),t=n.substr(0,r),o=n.substr(r),e=i.sanitize(e),s=""+t+e+o,this._dangerouslySetInputHtml(s)):void 0},_dangerouslyReplaceStartToEndRangeUnicode:function(e){var t,n,o,s,r;return this._startAndEndRangeUnicodeExistsAndValid()?(r=this._getStartRangeUnicodeIndex(),n=this._getEndRangeUnicodeIndex(),s=this.$text_input.html(),o=s.substr(0,r),t=s.substr(n),e=i.sanitize(e),this._dangerouslySetInputHtml(""+o+A+e+C+t)):void 0},_clearRangeUnicode:function(){var e;return e=this.$text_input.html(),e=e.replace(/\u0091/g,""),e=e.replace(/\u0092/g,""),this.$text_input.html(e)},_dangerouslyInsertLiveTextWithRangeUnicode:function(e){var t;return null==o.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),this._dangerouslySetInputHtml(""+this.$text_input.html()+A+C)),t=this._isSpaceBeforeStartUnicode()?"":" ",e=i.sanitize(e),this._dangerouslyReplaceStartToEndRangeUnicode(""+t+e)},_getRangeBetweenStartEndRangeUnicode:function(){var e,n,i,s,r,a,l,c,u;if(n=this.$text_input.html().replace(L,""),null!=n&&""!==n)for(l=this.$text_input[0].childNodes,s=0,r=l.length;r>s;s++)if(e=l[s],u=null!=o.msie?t(e).text():e.nodeValue,null!=u&&u.length>0&&(c=u.indexOf(A),i=u.indexOf(C),c>=0&&i>0&&i>c))return a=document.createRange(),a.setStart(e,c),a.setEnd(e,i),a},_isSpaceBeforeStartUnicode:function(){var e;return e=this._getStartRangeUnicodeIndex(),e>=0?this._isSpaceBeforeIndex(e):!1},_isSpaceBeforeIndex:function(e){var t;return t=this.$text_input.html(),e>0&&" "===t.substr(e-1,1)||e>=6&&"&nbsp;"===t.substr(e-6,6)},_dangerouslySetInputHtml:function(e){return this.$text_input.html(e)},_onAddPeopleMouseUp:function(e){var t;return"function"==typeof(t=this.props).onAddPeopleMouseUp?t.onAddPeopleMouseUp(e):void 0},_onSkipAddMention:function(e){var t,n;return null!=(n=this.refs.mentionsHintDropdown)&&n.hide(),"function"==typeof(t=this.props).onSkipAddMention?t.onSkipAddMention(e):void 0},_contactsSelectorPopupHidden:function(){var e;return this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=(null!=(e=this.refs.textInput)?e.getDOMNode():void 0)?this.setCursorToEndOfInput():void 0},_contactsSelectorPopupShown:function(){var e,t,n,i;return this.isMounted()&&this.props.showMentionsHelper?(this.state.in_edit_mode||this._clearDefaultState(),null!=(t=this.refs.mentionsContactSelectorPopup)&&null!=(n=t.refs)&&null!=(i=n.contactSelectorPopupInput)&&i.getDOMNode().focus(),"function"==typeof(e=this.props).contactsSelectorPopupShown?e.contactsSelectorPopupShown():void 0):void 0},_emailEnteredCallback:function(e){return this._addMentionIntoRangeUnicode(this._createMentionObject(e)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide()},_clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},_contactHighlightedCallback:function(e){var t,n,i;return i=(null!=e?e.data("name"):void 0)||"",n=(null!=e?e.data("identifier"):void 0)||"",this._dangerouslyInsertLiveTextWithRangeUnicode("@"+i),"function"==typeof(t=this.props).onContactsSelectorSuggestionsUpdate?t.onContactsSelectorSuggestionsUpdate():void 0},_contactPopupSelectedCallback:function(e){var t;return this._addMentionIntoRangeUnicode(this._createMentionObjectFromSuggestion(e)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide(),"function"==typeof(t=this.props).contactPopupSelectedCallback?t.contactPopupSelectedCallback(e):void 0},_contactSelectedCallback:function(e){var t;return this._addMentionIntoInput(this._createMentionObjectFromSuggestion(e)),"function"==typeof(t=this.props).contactSelectedCallback?t.contactSelectedCallback(this.isInNoAtMentionMode):void 0},_addMentionIntoRangeUnicode:function(e){var t;return this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" "),t=this._getRangeBetweenStartEndRangeUnicode(),t?(this._addMentionIntoInput(e,t),this._clearRangeUnicode()):void 0},_noAtMentionTriggerCallback:function(e){var t;if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&e>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof(t=this.props).onNoAtSignKeyPress?t.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===e)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){return setTimeout(function(e){return function(){var t,n;return e.focusInput(),t=e.$text_input[0].lastChild,null!=t?(n=document.createRange(),n.selectNode(t),n=n.cloneRange(),n.setStartAfter(t),n.collapse(!1),e._selection().removeAllRanges(),e._selection().addRange(n)):void 0}}(this),10)},_getCaretPosition:function(){var e,t,n,i;return t=null!=(i=this.refs.container)?i.getDOMNode().getClientRects()[0]:void 0,e={left:this.state.x_offset,top:this.state.y_offset},this._selection().rangeCount>0&&(n=this._selection().getRangeAt(0).getClientRects()[0],null!=n&&null!=t&&(e.left=n.left-t.left,e.top=this.props.shouldPopupsDropdown?n.bottom-t.top:n.top-t.top)),e},unsafeInsertHtmlAtRange:function(e,n,i){var o,s,r,a;for(n.deleteContents(),a=t("<span />").html(e)[0],o=document.createDocumentFragment();r=a.firstChild;)s=o.appendChild(r);return n.insertNode(o),s&&i&&(n=n.cloneRange(),n.setStartAfter(s),n.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(n)),s},_checkEndOfLine:function(){var e,n,i,r,a;return s.assert(null!=o.mozilla,"_checkEndOfLine called from non mozilla browser"),r=this._extractCursorInfo(),n=r[0],i=r[1],a=r[2],t(n).hasClass("text-input")&&t(this.$text_input.contents()[i]).is("br")&&i>0&&(e=this.$text_input.contents()[i-1],e.nodeType===Node.TEXT_NODE&&e.nodeValue===O)?this._setCursorLocation(e,0):void 0},_selection:function(){return window.getSelection()},_setCursorLocation:function(e,n){var i;if(null!=e){if(i=document.createRange(),e.nodeType===Node.TEXT_NODE)i.setStart(e,n);else{if(!t(e).hasClass("new-mention"))return;0===n?i.setStartBefore(e):i.setStartAfter(e)}return i.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(i)}},_updateCurrentWordBoundary:function(){var e,t,n,i,o,s,r;return i=this._extractCursorInfo(),t=i[0],n=i[1],o=i[2],r=o.slice(0,n).lastIndexOf(" ")+1,e=o.slice(0,n).lastIndexOf(T)+1,e>r&&(r=e),s=o.slice(n).indexOf(" "),s=-1===s?o.length:n+s,this.currentCursorWordStartPosition=r,this.currentCursorWordEndPosition=s},_cleanMentionHighlighting:function(e){var n,i,o,s,r;for(null==e&&(e=null),i=this.$text_input.children(),null!=e&&(i=[e]),r=[],o=0,s=i.length;s>o;o++)n=i[o],r.push(t(n).removeClass("selected"));return r},_cleanUpNbsp:function(){var e;return e=this.$text_input.html(),e=e.replace(/\u00a0/g," "),e=e.replace(/\s{2,}/g," "),this.$text_input.html(e)},_cleanUpDelimiters:function(){var e,n,r,a,l,c,u,d,p,h;for(s.assert(null==o.msie,"_cleanUpDelimiters() called from MSIE"),c=this._extractCursorInfo(),a=c[0],l=c[1],h=c[2],u=this.$text_input.contents(),n=0,r=u.length;r>n;n++)e=u[n],e.nodeType===Node.TEXT_NODE?(e.nodeValue=e.nodeValue.replace(L,""),""===e.nodeValue&&(e!==a?e.parentNode.removeChild(e):l=0)):t(e).hasClass("new-mention")&&(p=document.createTextNode(i.sanitize(O)),e.parentNode.insertBefore(p,e),d=document.createTextNode(i.sanitize(O)),e.parentNode.insertBefore(d,e.nextSibling));return null!=a&&a.nodeType===Node.TEXT_NODE&&a.nodeValue.length<l&&(l=a.nodeValue.length),this._setCursorLocation(a,l),null==o.mozilla&&null!=a&&""===a.nodeValue?a.parentNode.removeChild(a):void 0},_checkAndMergeAdjacentNodes:function(){var e,n,i,r,a,l,u,d,p,h;return s.assert(null!=o.msie,"_checkAndMergeAdjacentNodes called from non IE browser"),d=this._extractCursorInfo(),a=d[0],l=d[1],h=d[2],!t(a).hasClass("text-input")&&!t(a).is("p")||(p=event.keyCode)!==c.BACKSPACE&&p!==c.DELETE||(e=t(a).contents()[l],(null!=e?e.nodeType:void 0)!==Node.TEXT_NODE)?void 0:(i=e.nodeValue,n=0,u=e.previousSibling,r=e.nextSibling,null!=u&&u.nodeType===Node.TEXT_NODE&&(n=u.nodeValue.length,i=u.nodeValue+i,u.parentNode.removeChild(u)),null!=r&&r.nodeType===Node.TEXT_NODE&&(i+=r.nodeValue,r.parentNode.removeChild(r)),e.nodeValue=i,this._setCursorLocation(e,n))},_isCursorAfterSpaceOrBeginningOfLine:function(e,t){var n;if(t-1>=0){if(n=e.slice(t-1,t)," "===n||""===n||" "===n)return!0}else if(0===t)return!0;return!1},_extractCursorInfo:function(){var e,t,n;return e=this._selection().focusNode,t=this._selection().focusOffset,n="",null!=e&&e.nodeType===Node.TEXT_NODE&&(n=e.nodeValue.length?e.nodeValue:""),[e,t,n]},_clearDefaultState:function(){return this.state.default_state&&this._clearInputWithoutBlurring(),this.state.in_edit_mode?void 0:this.setState({in_edit_mode:!0})},_clearInputWithoutBlurring:function(){return null!=o.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:this.props.shouldAlwaysInEditMode}),this.$text_input.blur()},_onInputKeydownMozilla:function(e){var t,n,i,r,a,l,u,d;if(s.assert(null!=o.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine(),a=this._extractCursorInfo(),n=a[0],i=a[1],d=a[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(r=n.previousSibling,t=n.nextSibling,(l=e.keyCode)===c.DELETE||l===c.RIGHT){if(d===O&&null!=t&&this._toggleMentionSelectState(t,e))return this._setCursorLocation(n,1);

if(d.length!==i||null==t||t.nodeType!==Node.TEXT_NODE||t.nodeValue!==O)return this._cleanMentionHighlighting();if(null!=t.nextSibling&&this._toggleMentionSelectState(t.nextSibling,e))return this._setCursorLocation(t,1)}else if(((u=e.keyCode)===c.BACKSPACE||u===c.LEFT)&&0===i&&null!=r){if(d===O&&this._toggleMentionSelectState(r,e))return this._setCursorLocation(n,0);if(r.nodeType===Node.TEXT_NODE&&r.nodeValue===O&&null!=r.previousSibling&&this._toggleMentionSelectState(r.previousSibling,e))return this._setCursorLocation(r,0)}},_onInputKeydownMsie:function(e){var n,i,r,a,l,u,d,p,h,_,m;if(s.assert(null!=o.msie,"_onInputKeydownMsie called from non MSIE browser"),u=this._extractCursorInfo(),r=u[0],a=u[1],m=u[2],null!=r){if(t(r).hasClass("text-input")||t(r).is("p"))return n=t(r).contents(),((d=e.keyCode)===c.BACKSPACE||d===c.LEFT)&&a>0&&t(n[a-1]).hasClass("new-mention")?this._toggleMentionSelectState(n[a-1],e):(p=e.keyCode)!==c.DELETE&&p!==c.RIGHT||!t(n[a]).hasClass("new-mention")?this._cleanMentionHighlighting():this._toggleMentionSelectState(n[a],e);if(l=r.previousSibling,i=r.nextSibling,(h=e.keyCode)===c.BACKSPACE||h===c.LEFT){if(0===a&&null!=l&&t(l).hasClass("new-mention"))return this._toggleMentionSelectState(l,e)}else{if((_=e.keyCode)!==c.DELETE&&_!==c.RIGHT)return this._cleanMentionHighlighting();if(a===m.length&&null!=i&&t(i).hasClass("new-mention"))return this._toggleMentionSelectState(i,e)}}},_onInputKeydownWebkit:function(e){var t,n,i,r,a,l,u,d;if(s.assert(null!=o.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters(),a=this._extractCursorInfo(),n=a[0],i=a[1],d=a[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(r=n.previousSibling,t=n.nextSibling,(l=e.keyCode)===c.BACKSPACE||l===c.LEFT){if(null!=r&&d===O&&this._toggleMentionSelectState(r,e)){if(e.keyCode===c.BACKSPACE)return this._setCursorLocation(n,i-1);if(e.keyCode===c.LEFT)return this._setCursorLocation(r.previousSibling,1)}}else{if((u=e.keyCode)!==c.DELETE&&u!==c.RIGHT)return this._cleanMentionHighlighting();if(i!==d.length||null==t||t.nodeType!==Node.TEXT_NODE||t.nodeValue!==O&&0!==t.nodeValue.length){if(d===O&&0===i&&null!=t&&this._toggleMentionSelectState(t,e)){if(e.keyCode===c.DELETE)return this._setCursorLocation(n,1);if(e.keyCode===c.RIGHT)return this._setCursorLocation(t,1)}}else if(null!=t.nextSibling&&this._toggleMentionSelectState(t.nextSibling,e)){if(e.keyCode===c.DELETE)return this._setCursorLocation(t,1);if(e.keyCode===c.RIGHT)return this._setCursorLocation(t.nextSibling,1)}}},_onInputKeydown:function(t){var n,i,s,r,a,l,u,d;if(r=this._normalizeKeycode(t),this.setState({default_state:!1,last_keydown:r}),r!==c.PROCESSING)if(!(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)||r!==c.BACKSPACE&&r!==c.DELETE&&r!==c.LEFT&&r!==c.RIGHT?this._cleanMentionHighlighting():null!=o.webkit?this._onInputKeydownWebkit(t):null!=o.mozilla?this._onInputKeydownMozilla(t):null!=o.msie&&this._onInputKeydownMsie(t),"function"==typeof(n=this.props).onKeyDown&&n.onKeyDown(t),u=this._extractCursorInfo(),a=u[0],l=u[1],d=u[2],this.state.show_contacts){if(e.call(D,r)>=0){if(t.preventDefault(),r===c.ESC||0===this.contacts_selector.get_suggestions_count()&&r===c.ENTER)return this.setState({show_contacts:!1})}else if(r===c.BACKSPACE&&(null!=a?a.nodeType:void 0)===Node.TEXT_NODE&&l>0&&(s=d.substr(l-1,1),"@"===s&&this._isCursorAfterSpaceOrBeginningOfLine(d,l-1)))return this.setState({show_contacts:!1})}else if(r===c.ESC)return"function"==typeof(i=this.props).onCancel?i.onCancel():void 0},_onInputKeypress:function(e){var n,i,s,r,a,l,u,d,p;return d=this._extractCursorInfo(),l=d[0],u=d[1],p=d[2],this._normalizeKeycode(e)===c.AT_SIGN&&!this.state.mention_triggered&&("function"==typeof(n=this.props).position_contacts_callback&&n.position_contacts_callback(),r=!1,l.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(p,u)&&(r=!0,s=u):(t(l).hasClass("text-input")||null!=o.msie&&t(l).is("p"))&&(r=!0,s=0),r)?(a={search_start_position:s,search_end_position:s,mention_triggered:!0},this.setState(a),"function"==typeof(i=this.props).onAtSignKeyPress?i.onAtSignKeyPress():void 0):void 0},_onInputKeyup:function(t){var n,i,r,a,l,u,d,p,h,_,m,f;if(this.state.last_keydown===c.PROCESSING)return void s.assert(null!=o.webkit,"PROCESSING keycode detected in non-webkit browser");if(null!=o.msie&&this._checkAndMergeAdjacentNodes(),p=this._extractCursorInfo(),l=p[0],u=p[1],f=p[2],this.props.enableNoAtMentions&&this._updateCurrentWordBoundary(),a={},this.state.mention_triggered&&(a.mention_triggered=!1,a.show_contacts=!0,u-this.state.search_start_position>1&&(i=f.slice(this.state.search_start_position+1,u).indexOf("@"),a.show_contacts=-1===i?!0:!1)),!this.state.show_contacts&&!a.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(_=t.keyCode,e.call(D,_)>=0&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(t):t.keyCode!==c.ESC&&this.contacts_selector.get_suggestions(f.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(h=t.keyCode,e.call(D,h)>=0&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(t);else if(u<=this.state.search_start_position||l.nodeType!==Node.TEXT_NODE)a.show_contacts=!1;else if(t.keyCode===c.SPACE)if(d=this._parseMentionQuery(f,this.state.search_end_position).trim(),0!==d.length){if(M(d))return r=this._createMentionObject(d),this._addMentionIntoInput(r),void this._logEmailEntered(d);this.contacts_selector.get_suggestions(d,!0)}else this.setState({show_contacts:!1});else this.contacts_selector.get_suggestions(this._parseMentionQuery(f,u).trim(),!0);return(t.keyCode===c.ENTER||t.keyCode===c.TAB||t.keyCode===c.SPACE&&!this.state.show_contacts&&!a.show_contacts)&&this._parseInputTextAndReplace(),null==o.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof(n=this.props).onKeyUp&&n.onKeyUp(t),m=this._normalizeKeycode(t),e.call(D,m)>=0&&this.state.show_contacts?void 0:this.setState(a,function(e){return function(){var t;return"function"==typeof(t=e.props).resizeCallback?t.resizeCallback():void 0}}(this))},_normalizeKeycode:function(e){return e.keyCode||e.which||e.charCode},_onInputBlur:function(){var e,t;return this._parseInputTextAndReplace(),"function"==typeof(e=this.props).onBlur&&e.onBlur(),t={show_contacts:!1,default_state:!1},!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(t.in_edit_mode=!1,t.search_end_position=-1,t.search_start_position=-1),this.setState(t)},_onInputFocus:function(e){var t,n;return e.target===this.$text_input.get(0)?("function"==typeof(t=this.props).onFocus&&t.onFocus(),n={show_contacts:!1},this.state.in_edit_mode||(n.in_edit_mode=!0,n.search_end_position=-1,n.search_start_position=-1),setTimeout(function(e){return function(){return e.isMounted()?e.setState(n):void 0}}(this),0)):void 0},_onInputMouseDown:function(){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(e){var t;return this.setState({default_state:!1}),"function"==typeof(t=this.props).onPaste?t.onPaste(e):void 0},_createMentionObjectFromSuggestion:function(e){var t,n,i;return i=e.data("name"),n=e.data("identifier"),t=e.data("dbx-account-id"),this._createMentionObject(n,i,t)},_createMentionObject:function(e,t,n){return null==t&&(t=null),null==n&&(n=null),t||(t=e),n&&(e=n),{name:t,identifier:e,dbx_account_id:n}},_toggleMentionSelectState:function(e,n){if(t(e).hasClass("new-mention")){if(t(e).hasClass("selected"))return this._cleanMentionHighlighting(e),!0;n.stopPropagation(),n.preventDefault(),t(e).addClass("selected")}return!1},_onMentionMouseDown:function(e){var t;return e.preventDefault(),e.stopPropagation(),0===e.button?(this._cleanMentionHighlighting(),this._toggleMentionSelectState(e.target,e),t=document.createRange(),t.selectNode(e.target),this._selection().removeAllRanges(),this._selection().addRange(t)):null!=o.mozilla&&2===e.button?this._setCursorLocation(e.target,1):void 0},_mentionWrapper:function(e,t,n){return null!=o.webkit?"<span class='new-mention' data-id=\""+e+'" data-name="'+t+'" data-dbx-account-id="'+n+'">'+t+"</span>":'<input type="button" class=\'new-mention\' data-id="'+e+'" data-name="'+t+'" data-dbx-account-id="'+n+'" value="'+t+'"></input>'},_parseMentionQuery:function(e,t){var n;return t>this.state.search_end_position?this.setState({search_end_position:t}):t=this.state.search_end_position,n="",t<=e.length?n=e.slice(this.state.search_start_position,t):this.state.search_start_position<=e.length&&(this.setState({search_end_position:e.length}),n=e.slice(this.state.search_start_position)),n.replace("@","")},_addMentionIntoInput:function(e,n){var s,r,a,l,c,u,d,p,h,_,m,f;return u=this.refs.textInput.getDOMNode(),f=this._mentionWrapper(e.identifier,e.name,e.dbx_account_id),p=t(i.sanitize(f))[0],null!=o.webkit?p.setAttribute("contenteditable","false"):null!=o.mozilla&&p.setAttribute("style","margin-left:-3px; margin-right:-3px"),t(p).mousedown(function(e){return function(t){return e._onMentionMouseDown(t)}}(this)),null==n&&(d=this._extractCursorInfo(),l=d[0],c=d[1],m=d[2],n=document.createRange(),_=this.state.search_start_position,r=this.state.search_end_position,this.state.show_contacts||(this.setState({search_start_position:l.length}),this.setState({search_end_position:l.length}),_=l.length,r=l.length),this.isInNoAtMentionMode&&(_=this.currentCursorWordStartPosition,r=this.currentCursorWordEndPosition),n.setStart(l,_),n.setEnd(l,r)),p=this.unsafeInsertHtmlAtRange(p,n,!0),a=p.nextSibling,null!=a&&a.nodeType===Node.TEXT_NODE?(a.nodeValue=T+a.nodeValue,this._setCursorLocation(a,1)):(h=document.createTextNode(i.sanitize(T)),t(h).insertAfter(p),this._setCursorLocation(h,1)),"function"==typeof(s=this.props).onMention&&s.onMention(e),this.setState({show_contacts:!1})},focusInput:function(){var e;return this.setState({in_edit_mode:!0}),e=this.refs.textInput.getDOMNode(),e.focus()},disableMentions:function(){return this.state.show_contacts?this.setState({show_contacts:!1}):void 0},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(e){return"@[%(identifier)s:%(name)s]".format({identifier:e.identifier,name:e.name})},extractMentions:function(){var e,n,i,o,s,r,a,l;for(r=this.$text_input.find(".new-mention"),a=[],n=0,o=r.length;o>n;n++)s=r[n],i=t(s).data("id"),l=t(s).data("name"),e=t(s).data("dbx-account-id"),a.push(this._createMentionObject(i,l,e));return a},_encodeHtml:function(e){var n,i,o,s,r,a,l,c,u;if(o="",s=!1,e=e.replace(L,""),null!=e&&""!==e)for(c=t.parseHTML(e),r=0,a=c.length;a>r;r++)n=c[r],n.nodeType===Node.TEXT_NODE&&""!==n.nodeValue?(s=!0,o+=n.nodeValue):n instanceof HTMLParagraphElement?(s=!0,o=o+this._encodeHtml(t(n).html())+"\n"):t(n).hasClass("new-mention")?(s=!0,i=t(n).data(),l=this._createMentionObject(i.id,i.name),o+=this._encodedMention(l)):t(n).is("br")?o+="\n":t(n).is("div")?(u=t(n).text(),s=s||u.length>0,o=o+"\n"+u):(u=t(n).text(),s=s||u.length>0,o+=u);return o!==this.props.placeholder_text&&s?o:""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var e;return e=this.$text_input.html(),this._encodeHtml(e)},_postSticker:function(e){var t,n;return"function"==typeof(t=this.props).onAddSticker&&t.onAddSticker(e),null!=(n=this.refs.stickerDropdown)?n.hide():void 0},_renderStickerButton:function(){var e,t,n;return n=x.button({className:"stickers-bubble-target comment-sticker-add sprite-button"},x.div({className:"comment-sticker-icon"}),x.span({className:"ax-visually-hidden"},N("Add sticker"))),e=this.props.shouldPopupsDropdown?"top":"bottom",t=this.props.shouldPopupsDropdown?4:-11,x.div({className:"comment-sticker-button",onMouseDown:this.refreshDropdownDirection},y({targetButton:n,ref:"stickerDropdown",arrow_position:e+"-right",vertical_displacement:t,extra_css_class:"stickers-bubble-dropdown",horizontal_displacement:1,anchor_bottom:!this.props.shouldPopupsDropdown,bubbleDropdownShown:this.props.onStickerDropdownShown,bubbleDropdownHidden:this.props.onStickerDropdownHidden,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},k({isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker})))},render:function(){var e,t,i,s,r,a,l,c,u,d;return r={"text-input":!0,"edit-mode":this.state.in_edit_mode},l=R(r),a=!0,null!=o.webkit&&(a="plaintext-only"),e={ref:"textInput",className:l,contentEditable:a,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown},p=x.div({className:"mention-text-input-wrapper"},x.div(e,this.state.in_edit_mode?void 0:this.props.placeholder_text)),d=b({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),c=n.addons.classSet({"mentions-container":!0,"mentions-container-w-hint":this.props.showMentionsHelper}),u=n.addons.classSet({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput&&!this.props.shouldAlwaysInEditMode}),x.div({className:c,ref:"container"},x.div({className:u,ref:"input"},p,this.props.showMentionsHelper?(i=x.button({className:"comment-mention-hint-add sprite-button"},I({group:"web",name:"s_mention_add",alt:N("@mention someone")})),t=this.props.shouldPopupsDropdown?"top":"bottom",s=this.props.shouldPopupsDropdown?0:-16,x.div({className:"comment-mention-hint"},P({position:m.TooltipPosition.LEFT,tooltip_contents:S({},"@mention someone"),tooltip_classname:"notification-names-tooltip"},x.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},y({targetButton:i,autofocus:!0,ref:"mentionsHintDropdown",arrow_position:t+"-right",vertical_displacement:s,horizontal_displacement:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden,bubbleDropdownShown:this._contactsSelectorPopupShown,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},w({key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:this.props.shouldShowNoNotifyHint,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onAddPeopleMouseUp:this._onAddPeopleMouseUp,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars})))))):void 0,this.props.shouldEnableStickers?this._renderStickerButton():void 0),d)}})})}.call(this),function(){define("modules/clean/react/activity/resolve_button",["external/react","modules/core/i18n","modules/core/notify","modules/clean/react/sprite"],function(e,t,n,i){var o,s,r;return r=e.DOM,s=e.createFactory(i),o=e.createClass({displayName:"ResolveButton",propTypes:{resolved:e.PropTypes.bool.isRequired,onUpdateResolve:e.PropTypes.func.isRequired,isOffline:e.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},_updateResolved:function(){var e;return this.props.isOffline?(e=t._(this.props.resolved?"Cannot unresolve comments while offline":"Cannot resolve comments while offline"),n.error(e)):this.props.onUpdateResolve(!this.props.resolved)},render:function(){var e;return e={className:"resolved-icon",onClick:this._updateResolved,onMouseEnter:function(e){return function(){return e.setState({hover:!0})}}(this),onMouseLeave:function(e){return function(){return e.setState({hover:!1})}}(this)},this.props.resolved?r.div({className:"resolve-wrapper"},r.div(e,s({group:"web",name:"s_greencheck",alt:t._("resolve button (resolved)")})),this.state.hover?r.div({className:"unresolve-text"},t._("Unresolve")):void 0):this.props.resolved?void 0:r.div({className:"resolve-wrapper"},r.div(e,s({group:"web",name:"s_greycheck",alt:t._("resolve button (unresolved)")})),this.state.hover?r.div({className:"resolve-text"},t._("Resolve")):void 0)},getInitialState:function(){return{hover:!1}}})})}.call(this),function(){define("modules/clean/react/activity/time_counter",["external/react","modules/clean/datetime"],function(e,t){var n,i;return i=e.DOM,n=e.createClass({displayName:"TimeCounter",render:function(){var e;return e=t.ago(new Date(this.props.when_mses)),i.div({className:"activity-time-ago"},e)},updateLoop:function(){},componentDidMount:function(){return this.updateLoop()},getUpdateInterval:function(){return 5e3}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify",["external/react","modules/core/i18n","modules/clean/react/tooltip"],function(e,t,n){var i,o,s,r,a;return s=t._,a=t.ungettext,r=e.DOM,i=e.createFactory(n.Tooltip),o=e.createClass({displayName:"UsersToNotify",propTypes:{usersToNotify:e.PropTypes.array.isRequired,user:e.PropTypes.object.isRequired,shouldShowExtraText:e.PropTypes.bool.isRequired},render:function(){var e,t,o,l,c,u,d;return e=null==this.props.usersToNotify?[]:function(){var e,t,n,i;for(n=this.props.usersToNotify,i=[],e=0,t=n.length;t>e;e++)d=n[e],d.id!==this.props.user.id&&i.push(d);return i}.call(this.props.user.is_signed_in?this:this),t=e.length,t>0?(u=r.div({className:"notification-names-container"},function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)d=e[t],i.push(function(){return function(e){return r.div({key:e.id},e.get_display_identity())}}(this)(d));return i}.call(this)),l=1===t?this.props.shouldShowExtraText?s('<span class="blue">%(name)s</span> will be notified. Anyone who can view this file can comment.').format({name:e[0].get_display_identity()}):s('<span class="blue">%(name)s</span> will be notified.').format({name:e[0].get_display_identity()}):2===t?this.props.shouldShowExtraText?s('<span class="blue">%(name)s and %(name2)s</span> will be notified. Anyone who can view this file can comment.').format({name:e[0].get_display_identity(),name2:e[1].get_display_identity()}):s('<span class="blue">%(name)s and %(name2)s</span> will be notified.').format({name:e[0].get_display_identity(),name2:e[1].get_display_identity()}):this.props.shouldShowExtraText?a('<span class="blue">%(name)s and %(num)s other person</span> will be notified. Anyone who can view this file can comment.','<span class="blue">%(name)s and %(num)s others</span> will be notified. Anyone who can view this file can comment.',t-1).format({name:e[0].get_display_identity(),num:t-1}):a('<span class="blue">%(name)s and %(num)s other person</span> will be notified.','<span class="blue">%(name)s and %(num)s others</span> will be notified.',t-1).format({name:e[0].get_display_identity(),num:t-1}),o=r.div({dangerouslySetInnerHTML:{__html:l},className:"comment-box-text"}),i({position:n.TooltipPosition.TOP,tooltip_contents:u,tooltip_classname:"notification-names-tooltip"},o)):(c=s(this.props.shouldShowExtraText?"Comments won't notify anyone yet. Anyone who can view this file can comment.":"Comments won't notify anyone yet"),r.div({className:"comment-box-text"},c))}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify_facepile",["external/react","modules/core/i18n","modules/clean/react/tooltip","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar"],function(e,t,n,i,o,s){var r,a,l,c,u;return l=t._,u=t.ungettext,c=e.DOM,r=6,a=e.createClass({propTypes:{usersToNotify:e.PropTypes.array.isRequired,user:e.PropTypes.object.isRequired},render:function(){var e,t,i,a,l,u,d,p,h,_,m;for(i=function(){var e,t,n,i;for(n=this.props.usersToNotify,i=[],e=0,t=n.length;t>e;e++)m=n[e],i.push(m);return i}.call(this),e=[],h=[],a=function(){return function(t){return r>l?e.push(t):h.push(t)}}(this),l=u=0,d=i.length;d>u;l=++u)m=i[l],a(m);return c.div({className:"notify-facepile-container"},function(){var i,r,a;for(a=[],i=0,r=e.length;r>i;i++)m=e[i],t=c.div({},m.display_name),a.push(c.div({className:"notify-facepile-photo",key:m.id},n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:t,tooltip_classname:"notification-names-tooltip"},s({dimension:32,photoUrl:m.photo_circle_url,defaultAvatar:new o({dimension:32,shape:"CIRCLE",initials:m.initials}),key:m.id}))));return a}(),i.length>r?(_=c.div({},function(){var e,t,n;for(n=[],e=0,t=h.length;t>e;e++)p=h[e],n.push(c.div({},p.get_display_identity()));return n}()),n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:_,tooltip_classname:"notification-names-tooltip"},c.div({className:"notify-facepile-more"},"+"+(i.length-r)))):void 0)}})})}.call(this),function(){define("modules/clean/react/browse/columnheader",["jquery","external/react","modules/clean/react/sprite","modules/core/exception","modules/core/i18n","modules/clean/css"],function(e,t,n,i,o,s){var r,a,l,c,u,d,p,h,_,m,f,v;return _=i.assert,u=o._,v=t.DOM,m=t.createElement,f=t.addons.classSet,c={ASCENDING:"ASCENDING",DESCENDING:"DESCENDING"},l={STATIC:"STATIC",SINGLE:"SINGLE",MULTI:"MULTI"},a=t.PropTypes.shape({type:t.PropTypes.oneOf([l.STATIC,l.SINGLE,l.MULTI]).isRequired,label:t.PropTypes.string.isRequired,headerClassName:t.PropTypes.string,sortCallback:t.PropTypes.func,switchColumnCallback:t.PropTypes.func,columns:t.PropTypes.arrayOf(t.PropTypes.shape({type:t.PropTypes.oneOf([l.SINGLE]).isRequired,label:t.PropTypes.string.isRequired}))}.isRequired),r=t.createClass({displayName:"ColumnHeader",propTypes:{columns:t.PropTypes.arrayOf(a).isRequired,className:t.PropTypes.string,css:t.PropTypes.string},getInitialState:function(){var e;return this.props.columns[0].type===l.SINGLE?e=this.props.columns[0].label:this.props.columns[0].type===l.MULTI&&(e=this.props.columns[0][0].label),{activeColumn:e,cssLoaded:!1}},componentWillMount:function(){return this.props.css?s.require_css(this.props.css,function(e){return function(){return e.setState({cssLoaded:!0})}}(this)):void 0},setActiveColumn:function(e){return this.state.activeColumn!==e?this.setState({activeColumn:e}):void 0},render:function(){var e,t;return this.state.cssLoaded?(e=function(){var e,n,i,o;for(i=this.props.columns,o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(t.type===l.STATIC?m(h,{key:t.label,label:t.label,className:t.headerClassName||""}):t.type===l.SINGLE?m(p,{key:t.label,label:t.label,isSelected:t.label===this.state.activeColumn,direction:c.ASCENDING,sortCallback:t.sortCallback,setActiveColumn:this.setActiveColumn,canTriggerSortDirection:!0,className:t.headerClassName||""}):t.type===l.MULTI?m(d,{key:t.columns[0].label,columns:t.columns,setActiveColumn:this.setActiveColumn,activeColumn:this.state.activeColumn,switchColumnCallback:t.switchColumnCallback}):void 0);return o}.call(this),v.ul({role:"row",className:"col-header "+this.props.className},e)):v.ul({})}}),h=t.createClass({displayName:"_StaticColumnHeader",propTypes:{label:t.PropTypes.string.isRequired,className:t.PropTypes.string.isRequired},render:function(){return v.li({role:"columnheader",className:"static-col-header "+this.props.className},v.span({className:"col-header-contents"},this.props.label))}}),p=t.createClass({displayName:"_SingleColumnHeader",propTypes:{label:t.PropTypes.string.isRequired,className:t.PropTypes.string.isRequired,direction:t.PropTypes.string.isRequired,setActiveColumn:t.PropTypes.func,isSelected:t.PropTypes.bool.isRequired,sortCallback:t.PropTypes.func,canTriggerSortDirection:t.PropTypes.bool.isRequired,multiColumnClick:t.PropTypes.func,nextColumnLabel:t.PropTypes.string},getInitialState:function(){return{sortDirection:this.props.direction}},handleClick:function(e){var t;return t=c.ASCENDING,this.props.isSelected||this.state.sortDirection!==c.ASCENDING&&this.setState({sortDirection:c.ASCENDING}),this.props.canTriggerSortDirection&&this.props.isSelected&&(this.state.sortDirection===c.ASCENDING&&(t=c.DESCENDING),this.setState({sortDirection:t})),this.props.setActiveColumn&&this.props.setActiveColumn(this.props.label),this.props.sortCallback&&this.props.sortCallback(t),this.props.multiColumnClick?this.props.multiColumnClick(e):void 0},render:function(){var e,t,i,o;return this.state.sortDirection===c.DESCENDING?(o="arrow-down-gray",i="descending",e=u("Sort in ascending order")):this.state.sortDirection===c.ASCENDING&&(o="arrow-up-gray",i="ascending",e=u(this.props.isSelected?"Sort in descending order":"Sort in ascending order")),this.props.nextColumnLabel&&(e=u("Swap column to %(nextlabel)s",{comment:"nextlabel is the name of the column that the current column will be replaced with when this button is clicked."}).format({nextlabel:this.props.nextColumnLabel})),t={bolded:this.props.isSelected},v.li({role:"columnheader","aria-sort":this.props.isSelected?i:"",className:"sortable-col-header "+this.props.className},v.button({className:"col-header-button col-header-contents "+f(t),onClick:this.handleClick,ref:"columnButton",title:e},this.props.label,this.props.isSelected?m(n,{group:"web",name:o,alt:"",className:"sort-icon"}):void 0))}}),d=t.createClass({displayName:"_MultiColumnHeader",propTypes:{columns:t.PropTypes.arrayOf(a).isRequired,activeColumn:t.PropTypes.string.isRequired,setActiveColumn:t.PropTypes.func.isRequired,switchColumnCallback:t.PropTypes.func},getInitialState:function(){return{currentColumn:0,columnCount:this.props.columns.length}},handleClick:function(){var e;return e=(this.state.currentColumn+1)%this.state.columnCount,this.setState({currentColumn:e},function(e){return function(){return e.refs.singleColumn.refs.columnButton.getDOMNode().focus()}}(this)),this.props.setActiveColumn(this.props.columns[e].label),this.props.switchColumnCallback(e)},render:function(){var e,t;return e=this.state.currentColumn,t=(this.state.currentColumn+1)%this.state.columnCount,m(p,{canTriggerSortDirection:!1,className:this.props.columns[this.state.currentColumn].headerClassName||"",direction:c.ASCENDING,isSelected:this.props.columns[e].label===this.props.activeColumn,key:this.props.columns[e].label,label:this.props.columns[e].label,multiColumnClick:this.handleClick,nextColumnLabel:this.props.columns[t].label,ref:"singleColumn",sortCallback:this.props.columns[t].sortCallback})}}),{ColumnHeader:r,SortDirections:c,ColumnTypes:l}})}.call(this),function(){define("modules/clean/react/browse/constants",["modules/core/i18n"],function(e){var t,n,i,o,s,r,a,l;t=e._,o={},o.BrowseActionTypes={LOAD_PATH:"LOAD_PATH",ADD_FILES:"ADD_FILES",SET_PATH:"SET_PATH",SET_USER:"SET_USER",SET_URL_PREFIX:"SET_URL_PREFIX",SET_PAGINATING:"SET_PAGINATING",SET_MOUNT_POINTS:"SET_MOUNT_POINTS",CHANGE_FILES:"CHANGE_FILES",SET_SELECTED_FILES:"SET_SELECTED_FILES",TOGGLE_FILE_SELECTED:"TOGGLE_FILE_SELECTED",SELECT_FILES_IN_RANGE_TO:"SELECT_FILES_IN_RANGE_TO",SELECT_NEIGHBORING_FILE:"SELECT_NEIGHBORING_FILE",EXTEND_SELECTION_RANGE:"EXTEND_SELECTION_RANGE",SET_SHOULD_SHOW_DELETED_FILES:"SET_SHOULD_SHOW_DELETED_FILES",SET_MOST_RECENTLY_DRAGGED_OVER_FILE:"SET_MOST_RECENTLY_DRAGGED_OVER_FILE",SORT_FILES:"SORT_FILES",START_INTERNAL_FILE_DRAG:"START_INTERNAL_FILE_DRAG",STOP_INTERNAL_FILE_DRAG:"STOP_INTERNAL_FILE_DRAG",SET_COPY_MODE:"SET_COPY_MODE"},o.Direction={UP:"UP",DOWN:"DOWN"},o.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6},o.NameSpaceAccess={ACCESS_NO_ACCESS:0,ACCESS_READER:1,ACCESS_WRITER:2,ACCESS_OWNER:3},o.REACT_FILE_VIEWER_ELEMENT_ID="browse-react-file-viewer-container",o.BrowseSortField={FILENAME:"FILENAME",MODIFIED:"MODIFIED",KIND:"KIND",EXTENSION:"EXTENSION",SIZE:"SIZE"},n={IMAGE:["bmp","cr2","gif","ico","jpeg","jpg","nef","png","psd","tif","tiff","svg","svgz"],VIDEO:["3gp","3gpp","3gpp2","avi","dv","flv","m2t","m4v","mkv","mov","mp4","mpeg","mpg","mts","ts","vob","wmv"],AUDIO:["aif","flac","m4a","m4p","mp3","ogg","wav","wma"],DOCUMENT:["ai","cdr","csv","doc","docx","docm","eps","fla","indd","keynote","numbers","otf","pages","pdf","ppt","pptx","pptm","pps","ppsx","ppsm","ps","rtf","swf","txt","wpd","xls","xlsx","xlsm"],COMPRESSED_FILE:["7z","bz2","gz","gzip","rar","tar","zip"],CODE:["as","as3","c","coffee","cpp","cs","css","cxx","h","html","java","js","less","php","py","rb","sass","scss","sh","sql","vb","xhtml","xml"],DISK_IMAGE:["dmg","iso"],EXECUTABLE:["exe"],SHORTCUT:["lnk"],LINK:["url","webloc"],FONT:["ttf"]},o.FileTypeCategoryTranslations={FILE:t("file"),FOLDER:t("folder"),SHARED_FOLDER:t("shared folder"),TEAM_SHARED_FOLDER:t("team folder"),PUBLIC_FOLDER:t("folder"),IMAGE:t("image"),VIDEO:t("video"),AUDIO:t("audio"),DOCUMENT:t("document"),COMPRESSED_FILE:t("archive"),CODE:t("code"),DISK_IMAGE:t("disk image"),EXECUTABLE:t("executable"),SHORTCUT:t("shortcut"),LINK:t("link"),FONT:t("font"),SANDBOX:t("app folder")},o.DeletedFileTypeCategoryTranslations={FILE:t("deleted file"),FOLDER:t("deleted folder"),SHARED_FOLDER:t("deleted shared folder"),TEAM_SHARED_FOLDER:t("deleted team folder"),PUBLIC_FOLDER:t("deleted folder"),IMAGE:t("deleted image"),VIDEO:t("deleted video"),AUDIO:t("deleted audio"),DOCUMENT:t("deleted document"),COMPRESSED_FILE:t("deleted archive"),CODE:t("deleted code"),DISK_IMAGE:t("deleted disk image"),EXECUTABLE:t("deleted executable"),SHORTCUT:t("deleted shortcut"),LINK:t("deleted link"),FONT:t("deleted font"),SANDBOX:t("deleted app folder")},o.ExtensionCategories={};for(i in n)for(r=n[i],a=0,l=r.length;l>a;a++)s=r[a],o.ExtensionCategories[s]=i;return o})}.call(this),function(){define("modules/clean/react/browse/models",["external/immutable","modules/clean/filepath","modules/clean/react/browse/columnheader","modules/clean/react/browse/constants","modules/constants/legacy"],function(e,t,n,i,o){var s,r,a,l,c,u,d,p,h,_;return _=n.SortDirections,p=i.NameSpaceAccess,u=i.FileTypeCategoryTranslations,a=i.DeletedFileTypeCategoryTranslations,l=i.ExtensionCategories,d=i.FileTypes,c=e.Record({ago:void 0,bytes:void 0,direct_blockserver_link:void 0,doc_preview_status:void 0,fq_path:void 0,href:void 0,htmlified_link:void 0,icon:void 0,is_dir:!1,is_read_only_mount:!1,linkfile_link:void 0,ns_id:0,ns_path:void 0,preview_type:void 0,size:-1,sjid:0,sort_key:[""],target_ns:0,thumbnail_url_tmpl:void 0,ts:0,type:null,video_transcode_url:void 0}),c.prototype.getExtension=function(){var e;return e=t.filename(this.fq_path),-1===e.indexOf(".")?"":t.file_extension(e).toLowerCase()},c.prototype.getKind=function(){var e;if(this.is_dir){switch(e="FOLDER",this.type){case d.TEAM_SHARED_FOLDER:e="TEAM_SHARED_FOLDER";break;case d.SHARED_FOLDER:e="SHARED_FOLDER";break;case d.SANDBOX:e="SANDBOX";break;default:this.target_ns&&(e="SHARED_FOLDER")}return this.is_deleted?a[e]:u[e]}return e=l[this.getExtension()]||"FILE",this.is_deleted?a[e]:u[e]},h=e.Record({files:e.OrderedSet(),rangeAnchorFile:null}),r=e.Record({isSimpleSharingEnabled:!1,isPublicFolderEnabled:!1}),s=e.Record({currentNSID:o.root_ns,currentFQPath:null,currentMountPoint:null,currentNSPath:null,currentSharedFolderPermissionRole:p.ACCESS_NO_ACCESS,currentNSAllowsNesting:!1,isInFolderMode:!0,isInsideSharedFolder:!1,isInsideTeamFolder:!1,isInsideNestedSharedFolder:!1,config:new r}),{File:c,Selection:h,Config:r,BrowseContext:s}})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e;

}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/react/browse/store",["external/immutable","modules/core/exception","modules/clean/filepath","modules/clean/flux/base_store","modules/clean/react/browse/constants","modules/clean/react/browse/models","modules/clean/react/file_uploader/store","modules/clean/search/store","modules/clean/react/browse/columnheader"],function(t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v,g,y,b;return b=n.assert,u=s.BrowseActionTypes,m=s.Direction,p=s.BrowseSortField,f=r.File,v=r.Selection,_=r.Config,d=r.BrowseContext,y=a.UploaderActionTypes,g=c.SortDirections,h=function(n){function o(){return o.__super__.constructor.apply(this,arguments)}return e(o,n),o.prototype._init=function(){return this._unsortedFiles=t.Map(),this._sortedFiles=t.List(),this._path="",this._user=null,this._urlPrefix="",this._selection=new v,this._isPaginating=!1,this._context=new d,this._isSearchActive=!1,this._mountPoints=null,this._shouldShowDeletedFiles=!1,this._isFileBeingDragged=!1,this._mostRecentlyDraggedOverFile=null,this._internalFilesBeingDragged=t.List(),this._inCopyMode=!1,this._currentSort={sortField:p.FILENAME,direction:g.ASCENDING}},o.prototype.files=function(){return this._isSearchActive?l.searchResults():this._sortedFiles},o.prototype.filesMap=function(){return this._unsortedFiles},o.prototype.path=function(){return this._path},o.prototype.user=function(){return this._user},o.prototype.urlPrefix=function(){return this._urlPrefix},o.prototype.selection=function(){return this._selection.files},o.prototype.isPaginating=function(){return this._isPaginating},o.prototype.context=function(){return this._context},o.prototype.isSearchActive=function(){return this._isSearchActive},o.prototype.mountPoints=function(){return this._mountPoints},o.prototype.shouldShowDeletedFiles=function(){return this._shouldShowDeletedFiles},o.prototype.getFileByFilename=function(e){var t,n;return t="/"===this._path?"/"+e:this._path+"/"+e,n=t.toLowerCase(),this._sortedFiles.find(function(e){return e.fq_path.toLowerCase()===n})},o.prototype.getIndexOfFile=function(e){return this._sortedFiles.findIndex(function(t){return t.sjid===e.sjid})},o.prototype.isFileBeingDragged=function(){return this._isFileBeingDragged},o.prototype.mostRecentlyDraggedOverFile=function(){return this._mostRecentlyDraggedOverFile},o.prototype.internalFilesBeingDragged=function(){return this._internalFilesBeingDragged},o.prototype.inCopyMode=function(){return this._inCopyMode},o.prototype._setUser=function(e){var t;return t=e.user,null==this.user()?this._user=t:void 0},o.prototype._setPathData=function(e){var n,i,o;return o=e.path,i=e.files,n=e.context,o===this.path()?(this._unsortedFiles=this._unsortedFiles.clear(),this._sortedFiles=this._sortedFiles.clear(),this._appendFiles({path:o,files:i}),this._selection=this._selection.set("files",t.OrderedSet()),this._context=n):void 0},o.prototype._appendFiles=function(e){var n,i,o,s;return o=e.path,i=e.files,o===this.path()?(this._unsortedFiles=this._unsortedFiles.merge(function(){var e,t,o;for(o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push([n.fq_path,f(n)]);return o}()),this._sortedFiles=this._sortedFiles.concat(t.List(function(){var e,t,o;for(o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(this._unsortedFiles.get(n.fq_path));return o}.call(this))),b(this._unsortedFiles.size===this._sortedFiles.size,"appendFiles ended up with mismatched data structures"),this._sortFiles(this._currentSort,s=!1),this.emit_change()):void 0},o.prototype._applyFileDeltas=function(e){var t,n,o,s,r,a,l,c,u;if(l=e.path,o=e.fileDeltas,l===this.path()){for(s=function(e){return function(t,n){var o,s,r;if(null!=n&&i.parent_dir(n.fq_path)!==l&&(n=null),n!==t)if(null!==n&&(null!=(r=e._unsortedFiles.get(n.fq_path))?r.sjid:void 0)>=n.sjid)console.log("happily ignoring delta:"),console.log({before:t,after:n});else{if(null===n)return b(e._unsortedFiles.has(t.fq_path),"before path doesn't exist"),b(-1!==e._sortedFiles.indexOf(t),"before file not in sorted Files"),e._unsortedFiles=e._unsortedFiles.delete(t.fq_path),e._sortedFiles=e._sortedFiles.delete(e._sortedFiles.indexOf(t));if(null!==t&&t.fq_path===n.fq_path)return b(e._unsortedFiles.has(t.fq_path),"fails at 3"),o=e._sortedFiles.indexOf(t),b(-1!==o,"fails at 3.1"),e._sortedFiles=e._sortedFiles.set(o,n),e._unsortedFiles=e._unsortedFiles.set(t.fq_path,n);if(null!==t)return b(e._unsortedFiles.has(t.fq_path),"fails at 3.5"),s=e._sortedFiles.indexOf(t),b(-1!==s,"fails at 3.2"),e._sortedFiles=e._sortedFiles.delete(s),e._unsortedFiles=e._unsortedFiles.delete(t.fq_path),e._unsortedFiles=e._unsortedFiles.set(n.fq_path,n),o=e._sortedFiles.findIndex(function(e){return e.fq_path>n.fq_path}),e._sortedFiles=-1===o?e._sortedFiles.push(n):e._sortedFiles.splice(o,0,n);if(null===t)return b(!e._unsortedFiles.has(n.fq_path),"fails at 5"),b(-1===e._sortedFiles.indexOf(n),"fails at 6"),e._unsortedFiles=e._unsortedFiles.set(n.fq_path,n),o=e._sortedFiles.findIndex(function(e){return e.fq_path>n.fq_path}),e._sortedFiles=-1===o?e._sortedFiles.push(n):e._sortedFiles.splice(o,0,n)}}}(this),r=0,a=o.length;a>r;r++)c=o[r],n=c.before,t=c.after,s(n,t);return b(this._unsortedFiles.size===this._sortedFiles.size,"applyFileDeltas ended up with mismatched data structures"),this._sortFiles(this._currentSort,u=!1),console.log("4: "+(new Date).getMilliseconds()),this.emit_change()}return console.log("Ignoring new state because path is different")},o.prototype._setPath=function(e){var t;return t=e.path,this._path=t,this.emit_change()},o.prototype._setUrlPrefix=function(e){var t;return t=e.prefix,this._urlPrefix=t,this.emit_change()},o.prototype._setSelectedFiles=function(e){var n,i;return n=e.files,this._selection=this._selection.set("files",t.OrderedSet(n)),i=n.length>0?n[0]:this.files().get(0),this._selection=this._selection.set("rangeAnchorFile",i),this.emit_change()},o.prototype._setPaginating=function(e){var t;return t=e.isPaginating,this._isPaginating=t,this.emit_change()},o.prototype._setSearchActive=function(e){var t;return t=e.isSearchActive,this._isSearchActive=t,this.emit_change()},o.prototype._setMountPoints=function(e){var t;return t=e.mountPoints,this._mountPoints=t},o.prototype._toggleFileSelected=function(e){var t,n,i,o,s,r,a,l,c,u;if(n=e.file,this._selection.files.has(n)){for(this._selection=this._selection.update("files",function(e){return e.delete(n)}),a=null,t=this.files().indexOf(n),i=s=l=t+1,c=this.files().count();c>=l?c>s:s>c;i=c>=l?++s:--s)if(o=this.files().get(i),this._selection.files.has(o)){a=o;break}if(null==a)for(i=r=u=t-1;0>=u?0>=r:r>=0;i=0>=u?++r:--r)if(o=this.files().get(i),this._selection.files.has(o)){a=o;break}null==a&&(a=this.files().get(0)),this._selection=this._selection.set("rangeAnchorFile",a)}else this._selection=this._selection.update("files",function(e){return e.add(n)}).set("rangeAnchorFile",n);return this.emit_change()},o.prototype._rangeOfSelectedBlockSurrounding=function(e){var t,n,i,o;for(n=this.files().indexOf(e);o=n,n-=1,!(0>n)&&this._selection.files.has(this.files().get(n)););for(n=o;i=this.files().get(n),null!=i&&this._selection.files.has(i);)t=n,n+=1;return{startIndex:o,endIndex:t}},o.prototype._selectFilesInRangeTo=function(e){var t,n,i,o,s,r,a,l,c,u,d,p;return s=e.file,t=null!=(u=this._selection.rangeAnchorFile)?u:this.files().get(0),null!=t?(n=this.files().indexOf(t),c=this.files().indexOf(s),d=this._rangeOfSelectedBlockSurrounding(t),p=d.startIndex,i=d.endIndex,r=function(){var e,t,n,s;for(n=this.files().toArray(),s=[],l=e=0,t=n.length;t>e;l=++e)o=n[l],l>=p&&i>=l&&s.push(o);return s}.call(this),a=function(){var e,t,i,s;for(i=this.files().toArray(),s=[],l=e=0,t=i.length;t>e;l=++e)o=i[l],(l>=c&&n>=l||l>=n&&c>=l)&&s.push(o);return s}.call(this),n>c&&a.reverse(),this._selection=this._selection.update("files",function(e){return e.subtract(r).union(a)}),this.emit_change()):void 0},o.prototype._selectNeighboringFile=function(e){var t,n,i;return t=e.direction,i=this.files().indexOf(this._selection.files.last()),n=0,t===m.UP?n=Math.max(0,i-1):t===m.DOWN&&(n=Math.min(this.files().count()-1,i+1)),this._setSelectedFiles({files:[this.files().get(n)]})},o.prototype._extendSelectionRange=function(e){var t,n,i,o,s,r,a;return i=e.direction,t=null!=(s=this._selection.rangeAnchorFile)?s:this.files().get(0),null!=t?(n=this.files().indexOf(t),r=this._rangeOfSelectedBlockSurrounding(t),a=r.startIndex,o=r.endIndex,i===m.UP?n===o?a-1>=0&&(this._selection=this._selection.update("files",function(e){return function(t){return t.add(e.files().get(a-1))}}(this))):this._selection=this._selection.update("files",function(e){return function(t){return t.delete(e.files().get(o))}}(this)):i===m.DOWN&&(n===a||n!==o?o+1<this.files().count()&&(this._selection=this._selection.update("files",function(e){return function(t){return t.add(e.files().get(o+1))}}(this))):this._selection=this._selection.update("files",function(e){return function(t){return t.delete(e.files().get(a))}}(this))),this.emit_change()):void 0},o.prototype._setShouldShowDeletedFiles=function(e){var t;return t=e.shouldShowDeletedFiles,b(t===!0||t===!1,"Unexpected parameter to _setShouldShowDeletedFiles was not a boolean"),this._shouldShowDeletedFiles=t,this.emit_change()},o.prototype._setIsFileBeingDragged=function(e){var t;return t=e.numDraggingFiles,this._isFileBeingDragged=null!=t&&t>0,this.emit_change()},o.prototype._setMostRecentlyDraggedOverFile=function(e){var t;return t=e.file,this._mostRecentlyDraggedOverFile=t,this.emit_change()},o.prototype._startInternalFileDrag=function(){var e;return e=this._sortedFiles.filter(function(e){return function(t){return e._selection.files.has(t)}}(this)),this._internalFilesBeingDragged=t.List(e),this.emit_change()},o.prototype._stopInternalFileDrag=function(){return this._internalFilesBeingDragged=t.List(),this.emit_change()},o.prototype._setCopyMode=function(e){var t;return t=e.copyMode,this._inCopyMode=t,this.emit_change()},o.prototype._sortFiles=function(e,t){var n,i,o,s,r,a,l,c,u;return u=e.sortField,a=e.direction,null==t&&(t=!0),c=a===g.ASCENDING?1:-1,n=function(e,t){return e===t?0:t>e?-c:c},s=function(e,t){var i,o;return i=e.value,o=t.value,n(i,o)},o=function(e,t){var i,o,s,r;return o=e.isFolder,i=e.value,r=t.isFolder,s=t.value,o&&r?n(i,s):o?-c:r?c:n(i,s)},i=function(e,t){var i,o,s,r;return o=e.isFolder,i=e.value,r=t.isFolder,s=t.value,o&&r?n(i,s):o?1:r?-1:""===i?1:""===s?-1:n(i,s)},u===p.FILENAME?(l=-1!==navigator.platform.indexOf("Mac"),r=l?s:o,this._sortedFiles=this._sortedFiles.sortBy(function(e){return{isFolder:e.is_dir,value:e.sort_key}},r)):u===p.MODIFIED?this._sortedFiles=this._sortedFiles.sortBy(function(e){return{isFolder:e.is_dir,value:e.ts}},i):u===p.KIND?this._sortedFiles=this._sortedFiles.sortBy(function(e){return{isFolder:e.is_dir,value:e.getKind()}},i):u===p.EXTENSION?this._sortedFiles=this._sortedFiles.sortBy(function(e){return{isFolder:e.is_dir,value:e.getExtension()}},i):u===p.SIZE&&(this._sortedFiles=this._sortedFiles.sortBy(function(e){return{isFolder:e.is_dir,value:-e.bytes}},i)),this._currentSort={sortField:u,direction:a},t?this.emit_change():void 0},o.prototype._new_payload=function(e){switch(e.action.type){case u.LOAD_PATH:return this._setPathData(e.action.data);case u.ADD_FILES:return this._appendFiles(e.action.data);case u.SET_PATH:return this._setPath(e.action.data);case u.SET_USER:return this._setUser(e.action.data);case u.SET_URL_PREFIX:return this._setUrlPrefix(e.action.data);case u.CHANGE_FILES:return this._applyFileDeltas(e.action.data);case u.OPEN_PREVIEW:return this._setPreviewFile(e.action.data);case u.CLOSE_PREVIEW:return this._setPreviewFile(e.action.data);case u.SET_SELECTED_FILES:return this._setSelectedFiles(e.action.data);case u.TOGGLE_FILE_SELECTED:return this._toggleFileSelected(e.action.data);case u.SELECT_FILES_IN_RANGE_TO:return this._selectFilesInRangeTo(e.action.data);case u.SELECT_NEIGHBORING_FILE:return this._selectNeighboringFile(e.action.data);case u.EXTEND_SELECTION_RANGE:return this._extendSelectionRange(e.action.data);case u.SET_PAGINATING:return this._setPaginating(e.action.data);case u.SET_SEARCH_ACTIVE:return this._setSearchActive(e.action.data);case u.SET_MOUNT_POINTS:return this._setMountPoints(e.action.data);case u.SET_SHOULD_SHOW_DELETED_FILES:return this._setShouldShowDeletedFiles(e.action.data);case y.SET_NUM_DRAGGING_FILES:return this._setIsFileBeingDragged(e.action.data);case u.SET_MOST_RECENTLY_DRAGGED_OVER_FILE:return this._setMostRecentlyDraggedOverFile(e.action.data);case u.START_INTERNAL_FILE_DRAG:return this._startInternalFileDrag(e.action.data);case u.STOP_INTERNAL_FILE_DRAG:return this._stopInternalFileDrag(e.action.data);case u.SET_COPY_MODE:return this._setCopyMode(e.action.data);case u.SORT_FILES:return this._sortFiles(e.action.data)}},o}(o),{BrowseStore:new h,File:f,BrowseContext:d,Config:_}})}.call(this),function(){define("modules/clean/react/button",["external/react","external/underscore"],function(e,t){var n,i;return i=e.DOM,n=e.addons.classSet,{button:e.createClass({displayName:"button",propTypes:{importance:e.PropTypes.string,variant:e.PropTypes.string,disabled:e.PropTypes.bool,className:e.PropTypes.string},render:function(){var e,o,s,r;return r=this.props.importance||"primary",s={},s["button-"+r]=!0,s["button-"+this.props.variant]=null!=this.props.variant&&"standard"!==this.props.variant,null!=this.props.className&&(s[this.props.className]=!0),o=t.clone(this.props),o.className=n(s),e=i.button(o,this.props.children)}}),link_button:e.createClass({displayName:"link_button",propTypes:{importance:e.PropTypes.string,variant:e.PropTypes.string,disabled:e.PropTypes.bool,className:e.PropTypes.string},render:function(){var e,o,s,r;return r=this.props.importance||"primary",s={},s["button-"+r]=!0,s["button-"+this.props.variant]=null!=this.props.variant&&"standard"!==this.props.variant,null!=this.props.className&&(s[this.props.className]=!0),o=t.clone(this.props),o.className=n(s),e=i.a(o,this.props.children)}})}})}.call(this),function(){define("modules/clean/react/css",["external/react","external/underscore","modules/clean/css","modules/clean/js_environment"],function(e,t,n,i){var o,s,r,a;return r=e.DOM,s=e.createElement,o={LOADING:"loading",SUCCESS:"success",FAILED:"failed",FORCE_RENDERED:"force-rendered"},a=function(r,a,l){var c,u,d,p,h,_,m,f,v,g,y,b,w,C,E;for(null==l&&(l=[]),f=null!=(C=r.displayName)?C:"UnnamedComponent",E="Css("+f+")",h={},m=0,y=a.length;y>m;m++)_=a[m],h[_]=!0;for(v=0,b=l.length;b>v;v++)if(c=l[v],d="function"==typeof c.getCombinedCssPaths?c.getCombinedCssPaths():void 0,(null!=d?d.length:void 0)>0)for(g=0,w=d.length;w>g;g++)u=d[g],h[u]=!0;return p=Object.keys(h),e.createClass({displayName:E,statics:{getCombinedCssPaths:function(){return p}},propTypes:{cssPlaceholder:e.PropTypes.node,onCssFail:e.PropTypes.func,onCssLoad:e.PropTypes.func,skipCssInTest:e.PropTypes.bool},getDefaultProps:function(){return{cssPlaceholder:null,onCssFail:function(e){return e()},onCssLoad:null,skipCssInTest:!0}},getInitialState:function(){return{cssMode:o.LOADING}},componentWillMount:function(){return i.isTest()&&this.props.skipCssInTest?this.setState({cssMode:o.FORCE_RENDERED}):i.isBrowser()&&this.state.cssMode===o.LOADING?n.require_css_multi(p,this._handleCssLoaded,this._handleCssFailed):void 0},render:function(){var e;return(e=this.state.cssMode)===o.FORCE_RENDERED||e===o.SUCCESS?s(r,t.extend({ref:"wrapped"},this.props),this.props.children):this.props.cssPlaceholder},getWrappedComponent:function(){return this.refs.wrapped},_handleCssLoaded:function(){return this.setState({cssMode:o.SUCCESS},function(e){return function(){var t;return"function"==typeof(t=e.props).onCssLoad?t.onCssLoad():void 0}}(this))},_handleCssFailed:function(){return this.setState({cssMode:o.FAILED},function(e){return function(){var t;return"function"==typeof(t=e.props).onCssFail?t.onCssFail(e._forceRender):void 0}}(this))},_forceRender:function(){return this.setState({cssMode:o.FORCE_RENDERED})}})}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/dropins/contact_import_button",["modules/core/exception","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/button","modules/core/notify","modules/core/i18n"],function(t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f,v,g,y,b,w,C;return m=t.assert,d=o.LinkedProfileServices,p=o.ProfileServicesLinkingHandler,v=s.button,_=a._,l=v,g=n.addons.classSet,w=n.PropTypes,C=w.string,y=w.func,f=w.bool,b=w.number,h=function(){function t(t){var n;this.providerType=t.providerType,this.referrer=t.referrer,this.userId=t.userId,m((n=this.providerType,e.call(i.contact_services(),n)>=0),"invalid third party contact provider "+this.providerType),this._dialog=null,this._closePopupPollId=-1,this._linkHandler=new p,this._profileServices=d.get_linked_profile_services_for_user(this.userId)}return t.prototype.dialogClosePollInterval=100,t.prototype._startCloseDialogWatcher=function(e,t){return e?this._closePopupPollId=setInterval(function(n){return function(){return e.closed?(t(),clearInterval(n._closePopupPollId)):void 0}}(this),this.dialogClosePollInterval):void 0},t.prototype._preloadImportHandler=function(e,t){return function(n){return clearInterval(this._closePopupPollId),n.success?e.apply(null,arguments):t.apply(null,arguments)}},t.prototype.getServiceConnectionStatus=function(e){return d.get_linked_profile_services_for_user(this.userId,function(t){return function(){var n;return n=t._profileServices.service_is_connected(t.providerType),e(n)}}(this))},t.prototype.import=function(e){var t,n,i;return i=e.onComplete,t=e.onAlreadyImported,n=e.onCancelled,null==i&&(i=function(){}),null==t&&(t=function(){}),null==n&&(n=function(){}),this.getServiceConnectionStatus(function(e){return function(o){return o?void t():(e._linkHandler.auth_service_with_user(e.providerType,e.userId,e._preloadImportHandler(i,n),e.referrer),e._startCloseDialogWatcher(e._linkHandler._popup_window,n))}}(this))},t}(),c=n.createClass({displayName:"ContactImportButton",propTypes:{providerType:C.isRequired,userId:C.isRequired,onContactsImported:y},contactImporter:null,getDefaultProps:function(){return{onContactsImported:function(){}}},getInitialState:function(){return{isInProgress:!1,isComplete:!1,shouldDisplay:!1}},componentWillMount:function(){return this.contactImporter=new h({providerType:this.props.providerType,referrer:"suggestion",userId:this.props.userId}),this.contactImporter.getServiceConnectionStatus(function(e){return function(t){return e.setState({shouldDisplay:!t,isComplete:t})}}(this))},handleContactsImported:function(e){var t;return p.show_import_notifications(e),this.setState({isInProgress:!1,isComplete:!0}),(t=this.props).onContactsImported.apply(t,arguments)},handleCancelImportContacts:function(){return this.setState({isInProgress:!1})},handleContactsAlreadyImported:function(){var e;return e=i.to_name(this.props.providerType),this.setState({isInProgress:!1,isComplete:!0}),r.success(_("You're already connected to %(service_name)s").format({service_name:e}))},importContactsFromService:function(){return this.setState({isInProgress:!0}),this.contactImporter.import({onComplete:this.handleContactsImported,onAlreadyImported:this.handleContactsAlreadyImported,onCancelled:this.handleCancelImportContacts})},onButtonClicked:function(){return this.importContactsFromService()},render:function(){return n.createElement(u,{providerType:this.props.providerType,isInProgress:this.state.isInProgress,isComplete:this.state.isComplete,onButtonClick:this.onButtonClicked,shouldDisplay:this.state.shouldDisplay})}}),u=n.createClass({displayName:"ContactImportButtonView",propTypes:{providerType:C,isInProgress:f,isComplete:f,onButtonClick:y,shouldDisplay:f},providerNameMap:{1:"google",2:"yahoo",3:"facebook",4:"twitter",5:"yahoo-legacy",6:"mobile"},getDefaultProps:function(){return{isInProgress:!1,isComplete:!1,onButtonClick:function(){},shouldDisplay:!0}},onButtonClick:function(e){return e.preventDefault(),this.props.onButtonClick()},renderButtonOrStatus:function(){var e;return this.props.isInProgress||this.props.isComplete?(e={"contact-import__status":!0,"contact-import__status--loading":this.props.isInProgress&&!this.props.isComplete,"contact-import__status--complete":this.props.isComplete},n.createElement("div",{className:g(e)},n.createElement("span",{className:"contact-import__status-text"},this.props.isComplete?_("Imported!"):void 0),n.createElement("span",{className:"contact-import__status-icon"}))):n.createElement(l,{onClick:this.onButtonClick,className:"contact-import__button",importance:"secondary"},"Import")},render:function(){var e,t,i,o;return o={"contact-import":!0,"contact-import--disabled":!this.props.shouldDisplay},i=this.providerNameMap[this.props.providerType],e={"contact-import__service":!0},e["contact-import__service--"+i]=!0,t=e,n.createElement("div",{className:g(o)},n.createElement("span",{className:g(t)},"Gmail Contacts"),this.renderButtonOrStatus())}}),{ThirdPartyContactProvider:h,ContactImportButton:c,ContactImportButtonView:u}})}.call(this),function(){define("modules/clean/react/file_comments/annotation_bubble",["jquery","external/react","modules/core/i18n","modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/activity/file_viewer_state","modules/clean/keycode","modules/clean/storage","modules/clean/react/activity/comment_input","modules/core/browser","modules/clean/comments/actions","modules/clean/comments/annotation_utils","modules/clean/comments/utils"],function(e,t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v,g,y,b;return g=n._,m=i.FileActivity,f=s.FileViewerState,v=a.LocalStorage,b=t.DOM,y=t.addons.classSet,_=t.createFactory(l),h=t.createClass({displayName:"AnnotationBubble",propTypes:{context:t.PropTypes.number,user:t.PropTypes.object,activity:t.PropTypes.object,contextActivityStore:t.PropTypes.object,x:t.PropTypes.number,y:t.PropTypes.number,showBubble:t.PropTypes.bool,in_blank_state:t.PropTypes.bool,onAddComment:t.PropTypes.func,onCancelComment:t.PropTypes.func,annotation:t.PropTypes.object,position:t.PropTypes.string,shouldShowExpandBubble:t.PropTypes.bool},getInitialState:function(){return this.tempEnteredText="",{showExpandBubble:this.props.shouldShowExpandBubble}},getDefaultProps:function(){return{position:"top"}},componentWillReceiveProps:function(e){return this.props.shouldShowExpandBubble&&!this.tempEnteredText&&this.props.showBubble===!1&&e.showBubble===!0?this.setState({showExpandBubble:!0}):void 0},componentWillUpdate:function(e){var t,n;return this.props.showBubble===!0&&e.showBubble===!1&&(null!=(t=this._getRawCommentInput())?t.length:void 0)>0&&this._getRawCommentInput()!==(null!=(n=this.refs.commentInput)?n.getPlaceholderText():void 0)?this.tempEnteredText=this._getRawCommentInput():void 0},onInputFocus:function(){return{}},onInputBlur:function(){return{}},onAddComment:function(e){var t;return p.isFluxEnabled(this.props.context)?(u.addAnnotationComment({text:e}),u.hideAnnotationInput()):("function"==typeof(t=this.props).onAddComment&&t.onAddComment(e,this.props.annotation),this.tempEnteredText="")},onCancelComment:function(){var e;return p.isFluxEnabled(this.props.context)?u.stopAnnotationCreation():"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},_focusOnCommentInput:function(){var e;return null!=(e=this.refs.commentInput)?e.focusInput():void 0},_getRawCommentInput:function(){var e;return null!=(e=this.refs.commentInput)?e.getRawCommentInput():void 0},_onAnnotationExpandBubbleClick:function(){return this.setState({showExpandBubble:!1})},_renderCommentBox:function(){return b.div({className:"annotation-bubble__field"},_({ref:"commentInput",activity:this.props.activity,metadata:this.props.annotation,targetActivity:this.props.activity,user:this.props.user,initialText:this.tempEnteredText,inBlankState:!1,enableNotifyText:!1,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:this.props.shouldShowExpandBubble,shouldEnableCancelButton:!0,shouldInitiallyFocusInput:this.props.shouldShowExpandBubble,onAddComment:this.onAddComment,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur}))},_renderExpandBubble:function(){return b.div({className:"plus",onClick:this._onAnnotationExpandBubbleClick},"+")},render:function(){var e,t,n,i,o,s,r;return s=this.props.x||0,r=this.props.y||0,e=this.props.position,this.state.showExpandBubble&&(o=d.getExpandBubblePosition(this.props.position,this.props.x,this.props.y),t=o[0],n=o[1],s=n.x,r=n.y,e=t),b.div({className:"annotation-bubble-container"},p.isFluxEnabled(this.props.context)||this.props.showBubble?b.div({className:y((i={"annotation-bubble":!0,"annotation-bubble--hidden":!this.props.showBubble,"bubble-dropdown":!0,"expand-bubble":this.state.showExpandBubble},i[""+e]=!0,i)),style:{left:s,top:r}},this.state.showExpandBubble?this._renderExpandBubble():this._renderCommentBox(),b.div({className:"bubble-arrow-border"}),b.div({className:"bubble-arrow"})):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/annotation_comments_list_ui_bubble",["external/react","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/activity/file_viewer_state","modules/clean/datetime","modules/clean/keycode","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/storage","modules/clean/react/activity/comment_activity_ui","modules/clean/comments/utils"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f;return _=t._,p=a.LocalStorage,f=e.DOM,m=e.addons.classSet,d=e.createFactory(l),h=e.createFactory(r),u=e.createClass({displayName:"AnnotationCommentsListUIBubble",propTypes:{context:e.PropTypes.number,user:e.PropTypes.object,activity:e.PropTypes.object,contextActivityStore:e.PropTypes.object,fileViewerState:e.PropTypes.object,x:e.PropTypes.number,y:e.PropTypes.number,showBubble:e.PropTypes.bool,annotation:e.PropTypes.object,commentActivity:e.PropTypes.object,onDeleteComment:e.PropTypes.func,onLikeComment:e.PropTypes.func,onMouseLeave:e.PropTypes.func,onMouseEnter:e.PropTypes.func,onMouseOver:e.PropTypes.func,onUpdateResolve:e.PropTypes.func,onAddCommentFromList:e.PropTypes.func,onAddSticker:e.PropTypes.func,onReplyInputFocus:e.PropTypes.func,onReplyInputBlur:e.PropTypes.func,position:e.PropTypes.string,isThreadingEnabled:e.PropTypes.bool},getInitialState:function(){return{button_disabled:!0,show_post_button:!1,initial_text:""}},getDefaultProps:function(){return{isThreadingEnabled:!1}},onMouseEnter:function(){var e;return"function"==typeof(e=this.props).onMouseEnter?e.onMouseEnter():void 0},onMouseOver:function(){var e;return"function"==typeof(e=this.props).onMouseOver?e.onMouseOver(this.props.annotation):void 0},onMouseLeave:function(){var e;return"function"==typeof(e=this.props).onMouseLeave?e.onMouseLeave(this.props.annotation):void 0},onUpdateResolve:function(e,t){var n;return"function"==typeof(n=this.props).onUpdateResolve?n.onUpdateResolve(e,t):void 0},onDeleteComment:function(e){var t;return"function"==typeof(t=this.props).onDeleteComment?t.onDeleteComment(e):void 0},onLikeComment:function(e){var t;return"function"==typeof(t=this.props).onLikeComment?t.onLikeComment(e):void 0},_getRevisionDateTime:function(){var e;return e=this._getRevision(),null==e.when||isNaN(new Date(null!=e.when))?void 0:""+o.ago(new Date(1e3*e.when))},_getRevision:function(){return this.props.commentActivity.comment.comment_metadata.revision},_isOnOldRevision:function(){return c.isFluxEnabled(this.props.context)?!1:!this.props.fileViewerState.isCurrentlyAtRevision(this._getRevision())},onAddCommentFromList:function(e,t,n){var i;return null==t&&(t={}),null==n&&(n=null),this.setState({isNewReplyLoading:!0}),"function"==typeof(i=this.props).onAddCommentFromList?i.onAddCommentFromList(e,t,n):void 0},onAddSticker:function(e){var t;return this.setState({isNewReplyLoading:!0}),"function"==typeof(t=this.props).onAddSticker?t.onAddSticker(e):void 0},_renderThreadedListUI:function(){return h({context:this.props.context,key:"annotation_bubble_threaded_"+this.props.commentActivity.activity_key,activity:this.props.activity,commentActivity:this.props.commentActivity,contextActivityStore:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldAutoLinkify:!0,onAddCommentFromList:this.onAddCommentFromList,onLikeComment:this.onLikeComment,onDeleteComment:this.onDeleteComment,onUpdateResolve:this.onUpdateResolve,onReplyInputFocus:this.props.onReplyInputFocus,onReplyInputBlur:this.props.onReplyInputBlur})},_renderSingleCommentUI:function(){return d({context:this.props.context,key:"annotation_bubble_list_"+this.props.commentActivity.activity_key,comment_activity:this.props.commentActivity,parentActivity:this.props.activity,fileActivity:this.props.activity,context_activity_store:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,onLikeComment:this.onLikeComment,onDeleteComment:this.onDeleteComment,onUpdateResolve:this.onUpdateResolve})},_renderComments:function(){return f.div({className:"annotation-bubble__field",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,onMouseEnter:c.isFluxEnabled(this.props.context)?this.onMouseEnter:void 0},this._isOnOldRevision()?f.div({className:"annotation-bubble__field__old-revision"},"On older revision, updated "+this._getRevisionDateTime()):void 0,f.div({className:"comments-holder"},f.div({className:"comment-list"},this.props.isThreadingEnabled?this._renderThreadedListUI():this._renderSingleCommentUI())))},render:function(){var e,t;return t={"annotation-bubble-container":!0},e=[],this.props.showBubble&&(e=[f.div({className:"annotation-bubble bubble-dropdown "+this.props.position,style:{left:this.props.x||0,top:this.props.y||0}},this._renderComments(),f.div({className:"bubble-arrow-border"}),f.div({className:"bubble-arrow"}))]),f.div({className:m(t)},this.props.showBubble?e:void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_header",["jquery","external/react","modules/core/i18n","modules/clean/activity/activity","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/users_to_notify_facepile","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n","modules/clean/react/sprite_div","modules/clean/react/tooltip","modules/clean/comments/actions","modules/clean/comments/utils","modules/constants/legacy"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C,E;return C=n._,g=l.R_,E=t.DOM,v=t.createFactory(o),w=t.createFactory(s),m=t.createFactory(r),y=t.createFactory(c),b=t.createFactory(u.Tooltip),_=i.ActivityContext,f=t.createClass({displayName:"CommentListHeader",propTypes:{activity:t.PropTypes.object,show_resolved:t.PropTypes.bool.isRequired,toggle_show_resolved_callback:t.PropTypes.func.isRequired,num_resolved:t.PropTypes.number.isRequired,hide_callback:t.PropTypes.func.isRequired,is_subscribed:t.PropTypes.bool.isRequired,onSubscribeButtonClicked:t.PropTypes.func.isRequired,feedback_off:t.PropTypes.bool.isRequired,turn_off_feedback_callback:t.PropTypes.func.isRequired,activity_context:t.PropTypes.number.isRequired,onFacepileContactAdded:t.PropTypes.func,shouldShowDisableButton:t.PropTypes.bool.isRequired,shouldShowHideButton:t.PropTypes.bool.isRequired,user:t.PropTypes.object,isOffline:t.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},_is_browse_view:function(){return this.props.activity_context===_.BROWSE_FILE_VIEWER||this.props.activity_context===_.BROWSE_LIGHTBOX},_hide_comments:function(e){return this.refs.dropdown.hide(),this.props.hide_callback(e)},_toggle_show_resolved:function(){
return 0===this.props.num_resolved||this.props.feedback_off?void 0:(this.refs.dropdown.hide(),p.isFluxEnabled(this.props.activity_context)?this.props.show_resolved?d.hideResolvedComments():d.showResolvedComments():this.props.toggle_show_resolved_callback())},_isSubscribeDisabled:function(){return this.props.feedback_off||this.props.isOffline},_toggle_subscribe:function(){return this._isSubscribeDisabled()?void 0:(this.refs.dropdown.hide(),p.isFluxEnabled(this.props.activity_context)?this.props.is_subscribed?d.unsubscribeActivity():d.subscribeActivity():this.props.onSubscribeButtonClicked())},_isFeedbackSettingDisabled:function(){return this.props.isOffline},_turn_off_feedback:function(){return this._isFeedbackSettingDisabled()?void 0:(this.refs.dropdown.hide(),this.props.turn_off_feedback_callback())},contactSelectedCallback:function(e){var t;return this.refs.facepileContactSelectorDropdown.hide(),"function"==typeof(t=this.props).onFacepileContactAdded&&t.onFacepileContactAdded(e),a.log_event(h.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,h.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id)},_contactsSelectorPopupShown:function(){return setTimeout(function(){return function(){return e(".contacts-selector-popup input").trigger("focus")}}(this),300)},_facepileContactsSelectorPopupShown:function(){return null!=this.props.activity&&this.props.enableFacepile?a.log_event(h.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,h.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id):void 0},render:function(){var e,n,i,o,s,r,a,l,c,d,p,h;return s=[],this.props.shouldShowHideButton&&(o=E.a({key:"hide",className:"comments-header-menu-option hide",onMouseUp:this._hide_comments},y({group:"web",name:"s_hide",text:C("Hide comments")})),s.push(o)),l=C(this.props.show_resolved?"Hide resolved comments":"Show resolved comments"),r=t.addons.classSet({"comments-header-menu-option":!0,"toggle-resolved":!0,disabled:0===this.props.num_resolved||this.props.feedback_off}),a=E.a({key:"resolved",className:r,onMouseUp:this._toggle_show_resolved},y({group:"web",name:"s_resolve",text:l})),s.push(a),this.props.is_subscribed?(h=C("Unsubscribe from notifications"),d="s_notifications_off"):(h=C("Subscribe to notifications"),d="s_notifications_on"),c=t.addons.classSet({"comments-header-menu-option":!0,"toggle-subscribe":!0,disabled:this._isSubscribeDisabled()}),p=E.a({key:"subscribe",className:c,onMouseUp:this._toggle_subscribe},y({group:"web",name:d,text:h})),s.push(p),this.props.shouldShowDisableButton&&(n=t.addons.classSet({"comments-header-menu-option":!0,"toggle-feedback-setting":!0,disabled:this._isFeedbackSettingDisabled()}),i=E.a({key:"toggle-feedback-setting",className:n,onMouseUp:this._turn_off_feedback},y({group:"web",name:"s_disable",text:C("Disable comments")})),s.push(i)),E.div({className:"comment-list-header-container"},null!=this.props.activity&&this.props.enableFacepile?(this.props.user.is_signed_in?e=E.button({className:"comment-list-facepile-add-button",onMouseUp:this._contactsSelectorPopupShown},E.span({"aria-hidden":!0},"+"),E.span({className:"ax-visually-hidden"},g({},"Add subscribers"))):void 0,E.div({className:"comment-list-facepile"},b({position:u.TooltipPosition.BOTTOM,tooltip_contents:g({},"Subscribers will be notified of new comments"),tooltip_classname:"notification-names-tooltip"},E.div({className:"title"},g({},"Subscribers"))),E.div({},w({usersToNotify:this.props.activity.users_to_notify,user:this.props.user}),this.props.user.is_signed_in?E.div({className:"comment-list-facepile-add"},b({position:u.TooltipPosition.BOTTOM,tooltip_contents:g({},"Add subscribers"),tooltip_classname:"notification-names-tooltip"},m({ref:"facepileContactSelectorDropdown",targetButton:e,autofocus:!0,arrow_position:"top-right",vertical_displacement:-24,horizontal_displacement:-14,bubbleDropdownShown:this._facepileContactsSelectorPopupShown,extra_css_class:"notify-facepile-bubble-dropdown"},E.div({},v({ref:"facepileContactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,should_dropdown:!0,user:this.props.user,key:"facepileContactsPopup"}))))):void 0))):void 0,E.div({className:"comment-list-header"},E.div({className:"comment-list-header-inner"},E.span({className:"title"},g({},"Comments")),E.span({className:"options"},m({ref:"dropdown",targetButton:E.button({className:"button-as-link"},g({},"Options")),arrow_position:"top-right",vertical_displacement:8,extra_css_class:"comments-header-bubble-dropdown"},s))),E.hr({className:"separator"})))}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/file_comments/comment_list_ui",["jquery","external/react","external/underscore","modules/core/i18n","modules/clean/activity/activity","modules/clean/activity/activity_local_storage","modules/clean/activity/activity_user","modules/clean/components/loading_indicator","modules/clean/datetime","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/react/image","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/static_urls","modules/clean/comments/actions","modules/clean/comments/utils"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E){var S,T,A,I,k,P,N,R,x,O,L,D,M,F;return L=o._,F=o.ungettext,M=w.static_url,D=n.DOM,N=f.R_,R=n.addons.CSSTransitionGroup,S=n.createFactory(d.button),T=n.createFactory(g),O=n.createFactory(_),A=n.createFactory(y),I=n.createFactory(p),P=n.createFactory(m),R=n.createFactory(R),x=n.createFactory(v),k=n.createClass({displayName:"CommentListUI",propTypes:{context:n.PropTypes.number,contextActivityStore:n.PropTypes.object.isRequired,activity:n.PropTypes.object,showLoadingSpinner:n.PropTypes.bool,contactSearchLogger:n.PropTypes.object,onInputFocus:n.PropTypes.func,onInputBlur:n.PropTypes.func,height:n.PropTypes.number,user:n.PropTypes.object,onHideCommentsPane:n.PropTypes.func.isRequired,turnOffFeedbackCallback:n.PropTypes.func.isRequired,turnOnFeedbackCallback:n.PropTypes.func.isRequired,enableFacepile:n.PropTypes.bool,enableNoNotifyHint:n.PropTypes.bool,forceNullStateLoadingState:n.PropTypes.bool,shouldInitiallyFocusInput:n.PropTypes.bool,showBottomBar:n.PropTypes.bool,isNewCommentLoading:n.PropTypes.bool,showNewComment:n.PropTypes.bool,isSender:n.PropTypes.bool,showResolvedComments:n.PropTypes.bool,isUserSubscribed:n.PropTypes.bool,isCommentInputDisabled:n.PropTypes.bool,fileViewerState:n.PropTypes.object,checkScroll:n.PropTypes.func,onAddCommentFromList:n.PropTypes.func,onAddSticker:n.PropTypes.func,onShowNewComment:n.PropTypes.func,onDeleteComment:n.PropTypes.func,onUpdateResolve:n.PropTypes.func,onLikeComment:n.PropTypes.func,onToggleShowResolvedComments:n.PropTypes.func,toggleFeedbackForViewer:n.PropTypes.func,onFacepileContactAdded:n.PropTypes.func,onAnnotationButtonMouseUp:n.PropTypes.func,verifyAfterSignUpCallback:n.PropTypes.func,shouldShowHideButton:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,enableImport:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,isThreadingEnabled:n.PropTypes.bool,isVisibleAtMentions:n.PropTypes.bool,isOffline:n.PropTypes.bool,shouldAnnotationButtonUseThumbnailUrls:n.PropTypes.bool,shouldShowAnnotationUIOnImages:n.PropTypes.bool,initialCommentsCount:n.PropTypes.number},getInitialState:function(){return this.props.user.is_signed_in||(this.modals=new b),{shouldPopupsDropdown:!0}},getDefaultProps:function(){return{forceNullStateLoadingState:!1,isCommentInputDisabled:!1,fileViewerState:null,checkScroll:t.noop,onShowNewComment:t.noop,showBottomBar:!1,shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isThreadingEnabled:!1,isVisibleAtMentions:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillUnmount:function(){return t(window).unbind("resize.bottom_bar")},componentDidMount:function(){var e;return t(window).bind("resize.bottom_bar",function(e){return function(){var t;return"function"==typeof(t=e.props).checkScroll?t.checkScroll():void 0}}(this)),this.checkSize(),"function"==typeof(e=this.props).checkScroll?e.checkScroll():void 0},componentDidUpdate:function(t,n){var i,o,s,a,l,c,u,d,p,h,_,m;if(this._isActivityFetchDone()){if(a=(this.props.activity&&this.props.activity.activity_key)!==(t.activity&&t.activity.activity_key)){if(this.props.user.is_signed_in&&(_=r.get_store("like",this.props.activity.activity_key),_&&_.comment_activity_key))for(u=this.props.activity.comment_activities,s=0,l=u.length;l>s;s++)o=u[s],o.activity_key===_.comment_activity_key&&(r.clear_store("like"),d=this.props.user.id,e.call(function(){var e,t,n,i;for(n=o.likes,i=[],e=0,t=n.length;t>e;e++)c=n[e],i.push(c.liker.id);return i}(),d)<0&&this.props.contextActivityStore.add_comment_like(o,this.props.user,null,null));this.props.user.is_signed_in&&!this.props.isUserSubscribed&&(m=r.get_store("subscribe",this.props.activity.activity_key),r.clear_store("subscribe"),m&&this.toggleFeedbackForViewer())}return(null==t.activity&&(null!=(p=this.props.activity)&&null!=(h=p.comment_activities)?h.length:void 0)>0||null==n.commentBoxHeight&&this.getCommentBoxHeight())&&this.animateScrollToBottom(500),this.checkSize(),"function"==typeof(i=this.props).checkScroll?i.checkScroll():void 0}},onAddCommentFromList:function(e,t,n){var i;return null==t&&(t={}),null==n&&(n=null),E.isFluxEnabled(this.props.context)?C.addComment({targetActivity:this.props.activity,text:e,metadata:t}):"function"==typeof(i=this.props).onAddCommentFromList?i.onAddCommentFromList(e,t,n):void 0},onLikeComment:function(e){var t;return"function"==typeof(t=this.props).onLikeComment?t.onLikeComment(e):void 0},onUpdateResolve:function(e,t){var n;return"function"==typeof(n=this.props).onUpdateResolve?n.onUpdateResolve(e,t):void 0},onDeleteComment:function(e){var t;return"function"==typeof(t=this.props).onDeleteComment?t.onDeleteComment(e):void 0},onToggleShowResolvedComments:function(){var e;return"function"==typeof(e=this.props).onToggleShowResolvedComments?e.onToggleShowResolvedComments():void 0},onFacepileContactAdded:function(e){var t;return"function"==typeof(t=this.props).onFacepileContactAdded?t.onFacepileContactAdded(e):void 0},toggleFeedbackForViewer:function(){var e;return"function"==typeof(e=this.props).toggleFeedbackForViewer?e.toggleFeedbackForViewer():void 0},isScrolledToBottom:function(){var e;return e=t(this.refs.commentList.getDOMNode()),e[0].scrollHeight-e.scrollTop()-4<=e.outerHeight()},checkSize:function(){var e;return e=this.getCommentBoxHeight(),this.state.commentBoxHeight!==e?this.setState({commentBoxHeight:e}):void 0},_verifyAfterSignUpCallback:function(){var e;return"function"==typeof(e=this.props).verifyAfterSignUpCallback?e.verifyAfterSignUpCallback():void 0},onAnnotationButtonMouseUp:function(e,t){var n;return"function"==typeof(n=this.props).onAnnotationButtonMouseUp?n.onAnnotationButtonMouseUp(e,t):void 0},onAddSticker:function(e){var t;return E.isFluxEnabled(this.props.context)?C.addStickerComment({targetActivity:this.props.activity,stickerId:e}):"function"==typeof(t=this.props).onAddSticker?t.onAddSticker(e):void 0},onScroll:function(){var e;return"function"==typeof(e=this.props).checkScroll?e.checkScroll():void 0},turnOnFeedback:function(){return E.isFluxEnabled(this.props.context)?C.enableComment():this.props.turnOnFeedbackCallback()},turnOffFeedback:function(){return E.isFluxEnabled(this.props.context)&&C.disableComment(),this.props.turnOffFeedbackCallback()},_isActivityFetchDone:function(){return null!=this.props.activity},onFocus:function(){var e;return"function"==typeof(e=this.props).onInputFocus?e.onInputFocus():void 0},forceBlur:function(){return t(document.activeElement).blur()},resizeCallback:function(){return this.forceUpdate()},animateScrollToBottom:function(e){var n;return null==e&&(e=600),n=this.refs.commentList.getDOMNode(),t(n).animate({scrollTop:n.scrollHeight},{duration:e})},scrollToBottom:function(){var e;return e=this.refs.commentList.getDOMNode(),e.scrollTop=e.scrollHeight},getCommentBoxHeight:function(){return null!=this.refs.commentInput?t(this.refs.commentInput.getDOMNode()).outerHeight():0},positionDropdownCallback:function(){var e;return e=t(this.refs.commentList.getDOMNode()).height(),this.setState({shouldPopupsDropdown:Boolean(e<this.props.height/2)})},renderLoadingSpinner:function(e,t){return D.div({className:"comments-loading"},e,this.props.initialCommentsCount>0?D.div({className:"comments-loading__count",ref:"commentsLoadingCount"},t):void 0)},render:function(){var e,t,i,o,s,r,a,c,d,p,h,_,m,f,v,g;if(_=n.createElement(l,{style:l.LoadingIndicatorStyle.BLUE_SPINNER}),o=[],f=0,this._isActivityFetchDone())for(v=this.props.activity.comment_activities,c=0,d=v.length;d>c;c++)e=v[c],e.comment.resolved&&(f+=1),e.comment.resolved&&!this.props.showResolvedComments||e.isDeleted||o.push(this.props.isThreadingEnabled&&null==e.isPending?O({context:this.props.context,key:"threaded_"+e.activity_key,activity:this.props.activity,commentActivity:e,contextActivityStore:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,onAddCommentFromList:this.onAddCommentFromList,onLikeComment:this.onLikeComment,onDeleteComment:this.onDeleteComment,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onUpdateResolve:this.onUpdateResolve,shouldAutoLinkify:this.props.shouldAutoLinkify}):T({context:this.props.context,key:"comment_"+e.activity_key,parentActivity:this.props.activity,fileActivity:this.props.activity,comment_activity:e,context_activity_store:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,onLikeComment:this.onLikeComment,onDeleteComment:this.onDeleteComment,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onUpdateResolve:this.onUpdateResolve,shouldAutoLinkify:this.props.shouldAutoLinkify,isOffline:this.props.isOffline}));return i=n.addons.classSet({"comment-list":!0,scrolled:this.props.showBottomBar}),s=n.addons.classSet({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder-responsive":"ON"===u.getGandalfRule("comments_responsive_width")}),this.props.height&&(a={height:this.props.height},null!=this.state.commentBoxHeight&&(p={maxHeight:this.props.height-this.state.commentBoxHeight})),r=this._isActivityFetchDone()&&this.props.activity.feedback_off,t=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback,this.props.initialCommentsCount>0&&(h=F("Loading %(count)s comment","Loading %(count)s comments",this.props.initialCommentsCount).format({count:this.props.initialCommentsCount})),D.div({className:s,ref:"commentsHolder",style:a},D.div({className:i,ref:"commentList",onScroll:this.onScroll,style:p},I({show_resolved:this.props.showResolvedComments,toggle_show_resolved_callback:this.onToggleShowResolvedComments,hide_callback:this.props.onHideCommentsPane,is_subscribed:this.props.isUserSubscribed,onSubscribeButtonClicked:this.toggleFeedbackForViewer,num_resolved:f,shouldShowHideButton:this.props.shouldShowHideButton,shouldShowDisableButton:!r&&t,feedback_off:r,turn_off_feedback_callback:this.turnOffFeedback,activity_context:null!=(g=this.props.context)?g:this.props.contextActivityStore.activity_context,activity:this.props.activity,user:this.props.user,onFacepileContactAdded:this.onFacepileContactAdded,enableFacepile:this.props.enableFacepile,isOffline:this.props.isOffline}),this._isActivityFetchDone()?void 0:E.isFluxEnabled(this.props.context)?this.props.showLoadingSpinner?this.renderLoadingSpinner(_,h):void 0:this.props.forceNullStateLoadingState?void 0:this.renderLoadingSpinner(_,h),this._isActivityFetchDone()&&this.props.activity.feedback_off?D.div({className:"blank-state"},D.div({className:"blank-state-icon"},x({group:"web",name:"s_comments_locked"})),D.div({className:"blank-state-text"},N({},"Comments are off for this file.")),D.div({className:"blank-state-button"},S({importance:"secondary",onMouseUp:this.turnOnFeedback},N({},"Enable comments")))):o.length>0?E.isFluxEnabled(this.props.context)?o:R({transitionName:"comment"},o):this._isActivityFetchDone()&&!this.props.isNewCommentLoading||!this._isActivityFetchDone()&&this.props.forceNullStateLoadingState?D.div({className:"blank-state"},D.div({className:"blank-state-illustration"},P({src:M("/static/images/commenting/comments_null_state-vflRF2RXk.png"),srcHiRes:M("/static/images/commenting/comments_null_state@2x-vflUmaRRX.png")})),D.div({className:"blank-state-text"},N({},'Post a comment to start a discussion. <span class="blue">@Mention</span> someone to notify them.'))):void 0,this.props.isNewCommentLoading?(m=n.addons.classSet({"loading-comment":!0,"blank-state":0===o.length}),D.div({className:m},_)):void 0),(this._isActivityFetchDone()&&!this.props.activity.feedback_off||!this._isActivityFetchDone()&&this.props.forceNullStateLoadingState)&&!this.props.isCommentInputDisabled?A({activity:this.props.activity,onAddComment:this.onAddCommentFromList,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,verifyAfterSignUpCallback:this._verifyAfterSignUpCallback,ref:"commentInput",resizeCallback:this.resizeCallback,positionDropdownCallback:this.positionDropdownCallback,shouldPopupsDropdown:this.state.shouldPopupsDropdown,onFocus:this.onFocus,onBlur:this.props.onInputBlur,user:this.props.user,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,inBlankState:0===o.length,enableNotifyText:!this.props.enableFacepile,enableNoNotifyHint:this.props.enableNoNotifyHint,commentMetadataAllowed:u.getGandalfRule("pptx-commenting")||u.getGandalfRule("dw-comments-stickers"),shouldEnableStickers:u.getGandalfRule("dw-comments-stickers"),fileViewerState:this.props.fileViewerState,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,isCommentInputDisabled:this.props.isCommentInputDisabled,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals,isOffline:this.props.isOffline}):void 0)}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/file_comments/file_feedback_ui",["jquery","external/underscore","external/react","modules/constants/legacy","modules/constants/python","modules/core/i18n","modules/core/notify","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/activity/activity","modules/clean/activity/activity_store","modules/clean/activity/activity_local_storage","modules/clean/activity/activity_user","modules/clean/activity/file_activity_cache","modules/clean/activity/file_viewer_state","modules/clean/analytics","modules/clean/annotations/annotation","modules/clean/base64","modules/clean/bolt","modules/clean/file_activity/api","modules/clean/file_events","modules/clean/file_viewer_interface_controller","modules/clean/gandalf_util","modules/clean/keycode","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/storage","modules/clean/viewer","modules/clean/react/file_comments/annotation_bubble","modules/clean/react/file_comments/annotation_comments_list_ui_bubble","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_comments/switch_revision_ui","modules/clean/react/file_comments/onboarding","modules/clean/react/file_viewer/actions","modules/clean/web_timing_logger","modules/clean/comments/animations","modules/clean/comments/annotation_utils","modules/clean/comments/revisions","modules/clean/comments/utils"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D,M,F,U,B,V,H,q){var W,j,G,z,K,Y,$,Z,Q,X,J,ee,te,ne,ie,oe,se,re,ae,le,ce,ue,de,pe,he,_e,me,fe,ve,ge,ye,be,we,Ce,Ee;return Ce=r._,re=l.EmailVerification,he=m.FileViewerState,se=f.ContactSearchLogger,Q=v.Annotation,te=v.AnnotationTypes,ee=v.AnnotationSubtypes,be=T.SimpleModal,me=T.Modal,Ee=i.DOM,ge=A.R_,X=i.createFactory(N),J=i.createFactory(R),ie=i.createFactory(x),we=i.createFactory(I),oe=i.createFactory(M),ne="comment",Z=u.ActivityContext,ue=u.FileActivity,de=d.FileActivityStore,ve=1e3,_e=50,ae=50,fe=50,j=120,z=320,W=10,G=11,$=20,le=150,ye="switch-revision-container",Y="annotation-overlay",K="annotation-comments-list-ui-overlay",ce=".react-file-viewer__title-bar",pe=i.createClass({displayName:"FileFeedbackUI",propTypes:{visible:i.PropTypes.bool.isRequired,showButtonColor:i.PropTypes.string.isRequired,activity:i.PropTypes.instanceOf(ue),context:i.PropTypes.number,contextData:i.PropTypes.string,showResolvedComments:i.PropTypes.bool,fileViewerState:i.PropTypes.instanceOf(he),isPreviewReady:i.PropTypes.bool,showLoadingSpinner:i.PropTypes.bool,activityCache:i.PropTypes.instanceOf(_),activityContext:i.PropTypes.number,activityContextData:i.PropTypes.string,onActivityLoaded:i.PropTypes.func,hideToggledCallback:i.PropTypes.func,photoSocialShareVariant:i.PropTypes.string,previewWidthCallback:i.PropTypes.func,feedbackId:i.PropTypes.string.isRequired,onInputFocus:i.PropTypes.func,onInputBlur:i.PropTypes.func,userId:i.PropTypes.number,showDisabledCommentBar:i.PropTypes.bool,previewSelector:i.PropTypes.string,forceNullStateLoadingState:i.PropTypes.bool,shouldInitiallyFocusInput:i.PropTypes.bool,canCollapse:i.PropTypes.bool,shouldAutoLinkify:i.PropTypes.bool,shouldAutoResize:i.PropTypes.bool,enableImport:i.PropTypes.bool,shouldUseSimpleModals:i.PropTypes.bool,shouldHidePhotoAvatars:i.PropTypes.bool,file:i.PropTypes.object,previewType:i.PropTypes.string,oref:i.PropTypes.string,switchPreview:i.PropTypes.func,shouldCheckOffline:i.PropTypes.bool,shouldShowOnboarding:i.PropTypes.bool,onOnboardingModalOpen:i.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:i.PropTypes.bool,initialCommentsCount:i.PropTypes.number},getInitialState:function(){var e;return this.props.activityContext&&this.props.activityContextData&&(e=new de(this.props.activityContext,this.props.activityContextData)),this._previewLoadedCallback=t.noop,this.previewIsReady=!1,this.annotationUIReplyFocused=!1,{visible:this.props.visible,enabled:!0,height:0,comments_on:!0,icon:"s_comments_locked",contextActivityStore:e||new de,isNewCommentLoading:!1,showResolvedComments:!1,isCommentInputDisabled:!1,isOffline:!1}},getDefaultProps:function(){return{forceNullStateLoadingState:!1,canCollapse:!0,shouldAutoLinkify:!0,enableImport:!0,onActivityLoaded:t.noop,shouldAutoResize:!1,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,switchPreview:t.noop,file:null,shouldCheckOffline:!1,shouldShowOnboarding:!1,initialCommentsCount:-1,shouldAnnotationButtonUseThumbnailUrls:"ON"===E.getGandalfRule("comments_annotation_thumbnails")}},componentWillMount:function(){var e,t;return this.isFileViewerReactEnabled=E.getGandalfRule("file-viewer-react"),this.isAnnotationCreationEnabled=E.getGandalfRule("dw-comments-annotation-marker")||E.getGandalfRule("dw-comments-annotation-highlight")||E.getGandalfRule("dw-comments-annotation-region"),this.isAnnotationGhostEnabled=E.getGandalfRule("dw-comments-annotation-ghost"),this.isThreadingEnabled=E.getGandalfRule("dw-comments-threading"),this.isImagePreviewAnnotationEnabled=E.getGandalfRule("dw-comments-annotation-image-previews"),this.shouldShowAnnotationUIOnImages=this.isImagePreviewAnnotationEnabled||E.getGandalfRule("comments-image-previews-annotations-visible"),q.isFluxEnabled(this.props.context)?void 0:(this.getActivityUser().is_signed_in||(this.modals=new L),this.props.activityContext&&this.props.activityContextData&&(this._prepareFileViewerState(this.props.file,this.props.activityContextData,this.props.previewType),this._prepareFileViewerInterfaceController(this.props.activityContext),e=null!=(t=this.props.activityCache)?t.getActivity(this.props.activityContext,this.props.activityContextData):void 0,null!=e)?this._onActivitySuccessfullyFetched(e):void 0)},componentWillReceiveProps:function(e){var t,n,i,o,s;return q.isFluxEnabled(e.context)?void 0:this.props.activityContextData!==e.activityContextData&&(this._reset(),n={contextActivityStore:new de(e.activityContext,e.activityContextData)},(null!=(i=this.state.activity)&&null!=(o=i.comment_activities)?o.length:void 0)>0&&(n.activity=null),this.setState(n),this._prepareFileViewerState(e.file,e.activityContextData,e.previewType),this._prepareFileViewerInterfaceController(e.activityContext),t=null!=(s=this.props.activityCache)?s.getActivity(e.activityContext,e.activityContextData):void 0,null!=t)?this._onActivitySuccessfullyFetched(t):void 0},componentDidMount:function(){return this._refreshWidth(),this.props.shouldAutoResize&&this.autoResize(),this.contactSearchLogger=new se,this.props.shouldCheckOffline&&(this._checkAndSetIsOffline(),this.offlineInterval=setInterval(this._checkAndSetIsOffline,ve)),this.props.shouldAutoResize&&(this._debouncedAutoResize=n.debounce(this.autoResize,$),t(window).on("resize",this._debouncedAutoResize)),q.isFluxEnabled(this.props.context)||null==this.props.activityContext||null==this.props.activityContextData||this.state.isFetchingActivity||this._fetchActivity(this.maybeShowOnboardingModal),this._debouncedFetchActivity=n.debounce(this._fetchActivity,le)},componentDidUpdate:function(e,t){var n,i,o,s,r,a;return q.isFluxEnabled(this.props.context)?void 0:(this.props.activityContextData!==e.activityContextData&&null!=this.props.activityContextData&&(null!=this.props.activityCache&&(n=this.props.activityCache.getActivity(this.props.activityContext,this.props.activityContextData),null!=n&&this._onActivitySuccessfullyFetched(n)),this._debouncedFetchActivity()),i=this._getActivity()!==t.activity,i&&(this.notifyActivityLoaded(this._getActivity()),this.removeAllAnnotations(),this.redrawAllAnnotations(),null!=this.props.activityCache&&this.props.activityCache.setActivity(this.props.activityContext,this.props.activityContextData,this._getActivity())),s=this._showResolvedComments()!==t.showResolvedComments,s&&(this._showResolvedComments()||this.removeAllAnnotations(),this.redrawAllAnnotations()),o=this.state.comments_on!==t.comments_on||this.state.visible!==t.visible||this.state.enabled!==t.enabled||(null!=(r=this._getActivity())?r.feedback_off:void 0)!==(null!=(a=t.activity)?a.feedback_off:void 0),o?(this._refreshWidth(),this._isCommentsOnAndVisible()?(this.enableAnnotationCreation(),this.redrawAllAnnotations()):(this.removeAllAnnotations(),this.disableAnnotationCreation(),this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble())):void 0)},componentWillUnmount:function(){var e;return q.isFluxEnabled(this.props.context)||(e=document.getElementById(ye),null!=e&&i.unmountComponentAtNode(e)),this._reset()},close:function(){return this.onSwitchToLatestRevision(),this._reset()},notifyActivityLoaded:function(e){var t;return this.isMounted()?("function"==typeof(t=this.props).onActivityLoaded&&t.onActivityLoaded(e),this.props.shouldAutoResize?this.autoResize():void 0):void 0},autoResize:function(){var e;return e=t(window).height()-t(ce).height(),this.fitToHeight(e)},onPreviewAndCommentsReady:function(){var e;return t(null!=(e=this.refs.fileFeedbackUI)?e.getDOMNode():void 0).addClass("preview-ready"),this._prepareAnnotationAndCommentsBubble(),this._isCommentsOnAndVisible()?(this.enableAnnotationCreation(),this.redrawAllAnnotations()):void 0},maybeShowOnboardingModal:function(){var e;return this.props.shouldShowOnboarding?(e=oe({onOpen:this.props.onOnboardingModalOpen}),me.showInstance(e)):void 0},_reset:function(){var e;return this.disableAnnotationCreation(),this.previewIsReady=!1,i.unmountComponentAtNode(this.$annotationOverlayContainer),i.unmountComponentAtNode(this.$annotationCommentsListUIOverlayContainer),this.annotationBubble=null,this.annotationCommentsListUIBubble=null,this.props.shouldCheckOffline&&clearInterval(this.offlineInterval),this.removeAllAnnotations(),this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble(),this._stopLiveUpdate(),null!=(e=this.fileViewerInterfaceController)&&e.destroy(),null!=this._debouncedAutoResize?t(window).off("resize",this._debouncedAutoResize):void 0},_prepareFileViewerState:function(e,t,n){return this.fileViewerState=new he(e,t,n)},_prepareFileViewerInterfaceController:function(e){var t,n,i;return null!=(n=this.fileViewerInterfaceController)&&n.destroy(),i=e,t=this.fileViewerState.getPreviewType(i),this.fileViewerInterfaceController=new C(i,t,this.props.previewSelector),this.fileViewerInterfaceController.registerEventsCallbacks(this.onAnnotationEventsCallback),this.fileViewerInterfaceController.dispatchEvent("file-feedback-ui-ready")},_previewLoaded:function(){return this._previewLoadedCallback?(this._previewLoadedCallback(),this._previewLoadedCallback=t.noop):void 0},_isCommentsOnAndVisible:function(){return this.state.comments_on&&this.state.visible&&this.state.enabled&&null!=this._getActivity()&&!this._getActivity().feedback_off},_isAnnotationCreationEnabled:function(){return this.isAnnotationCreationEnabled&&this._isCommentsOnAndVisible()},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this._getActivity()&&this.previewIsReady&&!this.state.isFetchingActivity},_fileHasReplies:function(){var e,t,n,i;if(null!=this._getActivity())for(i=this._getActivity().comment_activities,t=0,n=i.length;n>t;t++)if(e=i[t],e.comment_activities.length>0)return!0;return!1},_isThreadingEnabled:function(){return this.isThreadingEnabled||this._fileHasReplies()},_checkAndSetIsOffline:function(){return this.setState({isOffline:!navigator.onLine})},_getActivity:function(){return q.isFluxEnabled(this.props.context)?this.props.activity:this.state.activity},_showResolvedComments:function(){return q.isFluxEnabled(this.props.context)?this.props.showResolvedComments:this.state.showResolvedComments},_prepareSwitchRevisionUI:function(){var e;return null!=this.props.previewSelector?(t("#"+ye).length||(e=t("<div />",{id:""+ye}),t("body").append(e)),this.$switchRevisionUIContainer=t("#"+ye).get(0),this.switchRevisionUI=i.render(i.createElement(D,{showSwitchRevisionUI:!1,onSwitchToLatestRevision:this.onSwitchToLatestRevision}),this.$switchRevisionUIContainer)):void 0},_prepareAnnotationContainers:function(){var e,n;return null!=this.props.previewSelector&&(this.$previewContainer=t(this.props.previewSelector),this.$previewContainer.length&&(this.isAnnotationCreationEnabled&&!this.annotationBubble&&this.fileViewerState.isCurrentlyAtLatestRevision()&&(t("#"+Y).length||(n=t("<div />",{id:""+Y}),this.$previewContainer.append(n)),this.$annotationOverlayContainer=t("#"+Y).get(0),this.annotationBubble=i.render(X({showBubble:!1,onAddComment:this.onAddCommentFromAnnotationBubble,onCancelComment:this.onCancelCommentFromAnnotationBubble,shouldShowExpandBubble:E.isGandalfInVariant("comments_annotation_creation_expand","ON")
}),this.$annotationOverlayContainer)),!this.annotationCommentsListUIBubble))?(t("#"+K).length||(e=t("<div />",{id:""+K}),this.$previewContainer.append(e)),this.$annotationCommentsListUIOverlayContainer=t("#"+K).get(0),this.annotationCommentsListUIBubble=i.render(J({fileViewerInterfaceController:this.fileViewerInterfaceController,fileViewerState:this.fileViewerState,showBubble:!1,isThreadingEnabled:this._isThreadingEnabled(),onDeleteComment:this.onDeleteCommentFromAnnotationBubble,onLikeComment:this.onLikeCommentFromAnnotationBubble,onMouseLeave:this.onAnnotationCommentsListUIBubbleMouseLeave,onMouseOver:this.onAnnotationCommentsListUIBubbleMouseOver,onUpdateResolve:this.onResolveCommentFromAnnotationBubble,onAddCommentFromList:this.onAddCommentFromList,onAddSticker:this.onAddCommentFromSticker,onReplyInputFocus:this.onAnnotationUIReplyFocus,onReplyInputBlur:this.onAnnotationUIReplyBlur}),this.$annotationCommentsListUIOverlayContainer)):void 0},highlightComment:function(e){return null!=e.commentActivity?B.highlightComment({activityKey:e.commentActivity.activity_key}):void 0},hideAnnotationCommentsBubble:function(e){var t;return null==e&&(e=!0),e||!this.annotationUIReplyFocused?(this.annotationUIReplyFocused=!1,null!=(t=this.annotationCommentsListUIBubble)?t.setProps({showBubble:!1}):void 0):void 0},showAnnotationCommentsBubble:function(e){var t,n,i,o,s,r,a,l,c,u;if(!this.annotationUIReplyFocused&&(clearTimeout(this.annotationCommentsListUIBubbleTimer),null!=e.annotation&&(t=Q.createAnnotationFromDict(e.annotation),s=e.commentActivity,this.annotationCommentsListUIBubble))){for(l=this._getActivity().comment_activities,u=[],r=0,a=l.length;a>r;r++)o=l[r],o.activity_key===s.activity_key?this._isBoundingBoxOffscreen(t)?u.push(void 0):(c=this._getBubbleLocation(t),n=c[0],i=c[1],u.push(null!=n?this.annotationCommentsListUIBubble.setProps({annotation:t,commentActivity:o,contextActivityStore:this.state.contextActivityStore,showBubble:!0,x:i.x,y:i.y,position:n}):void 0)):u.push(void 0);return u}},onAnnotationCommentsListUIBubbleMouseOver:function(){return clearTimeout(this.annotationCommentsListUIBubbleTimer)},onAnnotationCommentsListUIBubbleMouseLeave:function(){return this.hideAnnotationCommentsBubble(!1)},hideAnnotation:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("hide-annotation"):void 0},hideAnnotationBubble:function(){var e;return null!=(e=this.annotationBubble)?e.setProps({showBubble:!1}):void 0},placeAnnotationBubble:function(e){var t,n,i,o;if(this._isAnnotationCreationEnabled()&&null!=e.annotation&&this.annotationBubble){if(t=Q.createAnnotationFromDict(e.annotation),this._isBoundingBoxOffscreen(t))return this.hideAnnotationBubble();if(o=this._getBubbleLocation(t),n=o[0],i=o[1],null!=n)return this.annotationBubble.setProps({annotation:t,showBubble:!0,x:i.x,y:i.y,position:n})}},_prepareAnnotationAndCommentsBubble:function(){var e,t;return this._prepareAnnotationContainers(),null!=this.state.contextActivityStore?(null!=(e=this.annotationBubble)&&e.setProps({user:this.getActivityUser(),contextActivityStore:this.state.contextActivityStore,activity:this._getActivity()}),null!=(t=this.annotationCommentsListUIBubble)?t.setProps({user:this.getActivityUser(),contextActivityStore:this.state.contextActivityStore,activity:this._getActivity()}):void 0):void 0},_getBubbleLocation:function(e){return V.getBubblePosition(e,this.$previewContainer.get(0))},_isBoundingBoxOffscreen:function(e){return V.isAnnotationOffscreen(e,this.$previewContainer.get(0))},disableAnnotationCreation:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("disable-annotation-creation"):void 0},enableAnnotationCreation:function(){return this.fileViewerInterfaceController&&this.fileViewerState.isCurrentlyAtLatestRevision()&&null!=this.annotationBubble?this.fileViewerInterfaceController.dispatchEvent("enable-annotation-creation"):void 0},removeAllAnnotations:function(){return this.fileViewerInterfaceController?this.fileViewerInterfaceController.dispatchEvent("remove-all-annotations"):void 0},redrawAnnotation:function(e){return this.fileViewerInterfaceController&&this._isCommentsOnAndVisible()?this.fileViewerInterfaceController.dispatchEvent("draw-annotation",e):void 0},redrawAllAnnotations:function(e){var t,n,i,o,s,r,a,l;if(null==e&&(e=null),this._getActivity()&&this.previewIsReady&&this._isCommentsOnAndVisible()){for(r=this._getActivity().comment_activities,a=[],i=0,o=r.length;o>i;i++)n=r[i],s={},(this._showResolvedComments()||!n.comment.resolved)&&n.comment.has_metadata()&&n.comment.comment_metadata.has_annotation_data()?(l=n.comment.comment_metadata.revision,this.isAnnotationGhostEnabled||null!=l&&this.fileViewerState.isCurrentlyAtRevision(l)?(this.isAnnotationGhostEnabled&&null!=l&&!this.fileViewerState.isCurrentlyAtRevision(l)&&(s.isGhostAnnotation=!0),t=Q.createAnnotationFromDict(n.comment.comment_metadata.annotation),a.push(null!=e&&t.getFirstPdfPage()===e||null==e?this.redrawAnnotation({annotation:n.comment.comment_metadata.annotation,commentActivity:n,options:s}):void 0)):a.push(void 0)):a.push(void 0);return a}},onAnnotationEventsCallback:function(e,t){var n,i,s,r,a,l,c,u,d,p,h,_;switch(e){case"annotation-hidden":return this.hideAnnotationBubble(),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_HIDDEN,this._getActivity().activity_key,null,this.getActivityUser().id,this.props.activityContext);case"annotation-placed":return this.hideAnnotationCommentsBubble(),this.placeAnnotationBubble(t),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this._getActivity().activity_key,null,this.getActivityUser().id,this.props.activityContext,null!=t.annotation?t.annotation:void 0);case"annotation-start-drag":return this.hideAnnotationBubble();case"annotation-end-drag":return this.placeAnnotationBubble(t),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this._getActivity().activity_key,null,this.getActivityUser().id,this.props.activityContext,null!=t.annotation?t.annotation:void 0);case"page-rendered":return this.previewIsReady||(this.previewIsReady=!0,this._isPreviewAndCommentsReady()&&this.onPreviewAndCommentsReady(),this._previewLoaded()),this.redrawAllAnnotations(null!=t?t.page:void 0);case"annotation-ui-click":return n=t.commentActivity,i=null!=(a=t.commentActivity)&&null!=(l=a.comment)?l.comment_metadata:void 0,s=null!=(c=t.commentActivity)&&null!=(u=c.comment)&&null!=(d=u.comment_metadata)?d.revision:void 0,null==s||this.fileViewerState.isCurrentlyAtRevision(s)?(this.showAnnotationCommentsBubble(t),this.highlightComment(t)):this.showAnnotationWithPreview(n,i),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this._getActivity().activity_key,null!=(p=t.commentActivity)?p.activity_key:void 0,this.getActivityUser().id,this.props.activityContext);case"annotation-ui-enter":return this.showAnnotationCommentsBubble(t),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this._getActivity().activity_key,null!=(h=t.commentActivity)?h.activity_key:void 0,this.getActivityUser().id,this.props.activityContext);case"annotation-ui-leave":return clearTimeout(this.annotationCommentsListUIBubbleTimer),this.annotationCommentsListUIBubbleTimer=setTimeout(function(e){return function(){return e.hideAnnotationCommentsBubble(!1)}}(this),200);case"scale-change":return this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble();case"scroll":if(this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble(),null!=(null!=t?t.annotation:void 0))return clearTimeout(this.annotationBubbleTimer),this.annotationBubbleTimer=setTimeout(function(e){return function(){return e.placeAnnotationBubble(t)}}(this),150);break;case"on-keydown":if(r=t.keyCode||t.which||t.charCode,r===S.ESC&&(null!=(_=this.annotationBubble)?_.props.showBubble:void 0))return this.hideAnnotationBubble(),this.hideAnnotation();break;case"reset-file-feedback-ui":return this.previewIsReady=!1,this.hideAnnotationBubble(),this.hideAnnotationCommentsBubble()}},onSwitchToLatestRevision:function(){return this.switchRevision(this.fileViewerState.getLatestRevision()),this.removeSwitchToLatestRevisionUI()},setSwitchToLatestRevisionUI:function(e){var t;return this.setState({isCommentInputDisabled:!0}),null!=(t=this.switchRevisionUI)?t.setProps({showSwitchRevisionUI:!0,revision:e}):void 0},removeSwitchToLatestRevisionUI:function(){var e;return this.setState({isCommentInputDisabled:!1}),null!=(e=this.switchRevisionUI)?e.setProps({showSwitchRevisionUI:!1}):void 0},switchRevision:function(e,t,n){var i,s,r,a,l,c;return null==e||this.fileViewerState.isCurrentlyAtRevision(e)?"function"==typeof n?n():void 0:(this.removeAllAnnotations(),this.previewIsReady=!1,this.annotationBubble=null,this.annotationCommentsListUIBubble=null,this.fileViewerState.setCurrentRevision(e),c=this.fileViewerState.isCurrentlyAtLatestRevision()&&this._isAnnotationCreationEnabled(),this.props.activityContext===Z.BROWSE_FILE_VIEWER?this.isFileViewerReactEnabled?(this.fileViewerState.isOldRevision(e)?(a=H.getFileWithRevision(this.props.file,e),F.switchRevision(a)):F.restoreRevision(),n&&n()):"function"==typeof(i=this.props).switchPreview&&i.switchPreview(e.preview_link,e.direct_blockserver_link,c,n):this.props.activityContext===Z.SHARED_LINK_VIEW&&"function"==typeof(s=this.props).switchPreview&&s.switchPreview(e.revision_id,c,n,e.preview_link,t),this.fileViewerState.isOldRevision(e)?(this.setSwitchToLatestRevisionUI(e),r=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_OLD_REVISION):(this.removeSwitchToLatestRevisionUI(),r=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_LATEST_REVISION),O.log_annotation_event(r,this._getActivity().activity_key,null!=t?t.activity_key:void 0,this.getActivityUser().id,this.props.activityContext,null!=t&&null!=(l=t.comment.comment_metadata)?l.annotation:void 0))},showAnnotationWithPreview:function(e,t){var n,i;return this.fileViewerInterfaceController&&(n=Q.createAnnotationFromDict(t.annotation),i=n.getFirstPdfPage(),this.fileViewerState.isCurrentlyAtRevision(t.revision)?this._scrollToAnnotationInPreview(i,e):this.switchRevision(t.revision,e,function(t){return function(){return t._prepareFileViewerInterfaceController(t.props.activityContext),t._previewLoadedCallback=function(){return t._scrollToAnnotationInPreview(i,e)}}}(this))),O.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_BUTTON_CLICKED,this._getActivity().activity_key,t.activity_key,this.getActivityUser().id,this.props.activityContext,t.annotation)},_addRevisionToCommentMetadata:function(e){var t;return null==e&&(e={}),t=this.fileViewerState.getCurrentRevision(),t&&(e.revision=t),e},_prepareCommentMetadataWithAnnotation:function(e){var t;return t={annotation:e.toMetadataDict()},this._addRevisionToCommentMetadata(t)},onDeleteCommentFromAnnotationBubble:function(e){return this.onDeleteComment(e),this.hideAnnotationCommentsBubble(),this.fileViewerInterfaceController.dispatchEvent("remove-annotation",{commentActivity:e})},onResolveCommentFromAnnotationBubble:function(e,t){return this.onResolveComment(e,t)},onAddCommentFromAnnotationBubble:function(e,t){return this.hideAnnotationBubble(),this.onAddComment(e,this._prepareCommentMetadataWithAnnotation(t))},onCancelCommentFromAnnotationBubble:function(){return this.hideAnnotationBubble(),this.hideAnnotation()},onLikeCommentFromAnnotationBubble:function(e){return this.onLikeComment(e)},onAddCommentFromSticker:function(e){var t;return t={stickers:{id:e}},this.onAddComment("",this._addRevisionToCommentMetadata(t))},onAnnotationUIReplyFocus:function(){return this.annotationUIReplyFocused=!0},onAnnotationUIReplyBlur:function(){return this.annotationUIReplyFocused=!1},onAddCommentFromList:function(e,t,n){return null==t&&(t={}),null==n&&(n=null),this.onAddComment(e,t,n)},onDeleteCommentFromList:function(e){return this.onDeleteComment(e)},onResolveCommentFromList:function(e,t){return this.onResolveComment(e,t)},onLikeCommentFromList:function(e){return this.onLikeComment(e)},onAddComment:function(e,i,s){var r,l,u;return null==s&&(s=null),this.getActivityUser().is_signed_in?this.getActivityUser().is_email_verified?(e=t.trim(e),u=function(e){return function(t){return e.setState({isNewCommentLoading:!1,activity:n.clone(t)},function(){var t,n;return null!=s?(e.hideAnnotationCommentsBubble(),null!=(t=e.annotationCommentsListUIBubble)?t.setProps({commentActivity:s}):void 0):(null!=(n=e.refs.commentListUI)&&n.animateScrollToBottom(),e.redrawAllAnnotations())}),e.hideAnnotation()}}(this),l=function(e){return function(t){var n;return n=t.error_text||Ce("An error occurred while commenting."),a.error(n),e.setState({isNewCommentLoading:!1})}}(this),this.state.contextActivityStore.add_comment(this._getActivity(),this.getActivityUser(),e,i,s,u,l),null==s&&this.setState({isNewCommentLoading:!0},function(e){return function(){var t;return null!=(t=e.refs.commentListUI)?t.scrollToBottom():void 0}}(this)),this.setState({isSender:!0}),this.contactSearchLogger.log_records(this.getActivityUser().id,!1)):(r=re.get_for_user(this.getActivityUser()),re.set_should_use_simple_ui(this.props.shouldUseSimpleModals),r.show_verify_modal(null,c.ADD_COMMENT)):(this.modals.show_sign_in_modal(L.POST_COMMENT_VARIANT),O.log_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this._getActivity().activity_key,null,o.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON))},onDeleteComment:function(e){var t,n;return t=function(e){return function(){return a.error(Ce("An error occurred while deleting the comment.")),e.forceUpdate()}}(this),n=function(t){return function(){a.success(Ce("Comment deleted"),2),t.fileViewerInterfaceController.dispatchEvent("remove-annotation",{commentActivity:e}),t.forceUpdate()}}(this),this.state.contextActivityStore.delete_comment(this._getActivity(),this.getActivityUser(),e.activity_key,n,t)},onResolveComment:function(e,t){var n,i;return i=function(){return function(){}}(this),n=function(n){return function(){return a.error(Ce(t?"An error occurred while setting the comment to resolved.":"An error occurred while setting the comment to not resolved.")),n._onResolveUpdateUI(e,!t)}}(this),this.state.contextActivityStore.update_resolved(e,this.getActivityUser(),t,i,n),this._onResolveUpdateUI(e,t)},_onResolveUpdateUI:function(e,t){var i,o,s,r,a,l,c,u;for((null!=(a=this.annotationCommentsListUIBubble)&&null!=(l=a.props.commentActivity)?l.activity_key:void 0)===e.activity_key&&(t&&!this._showResolvedComments()?this.hideAnnotationCommentsBubble():(e=n.clone(e),e.comment.resolved=t,null!=(c=this.annotationCommentsListUIBubble)&&c.setProps({commentActivity:e}))),i=n.clone(this._getActivity()),u=i.comment_activities,s=0,r=u.length;r>s;s++)o=u[s],o.activity_key===e.activity_key&&(o.comment.resolved=t);return this.setState({activity:i})},onLikeComment:function(e){return this.getActivityUser().is_signed_in?void 0:(p.set_store("like",this._getActivity().activity_key,e.activity_key),this.modals.show_sign_in_modal(L.LIKE_COMMENT_VARIANT),O.log_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this._getActivity().activity_key,e.activity_key,o.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LIKE_BUTTON))},onToggleShowResolvedComments:function(){return this.setState({showResolvedComments:!this.state.showResolvedComments})},_isUserSubscribed:function(){var e,t,n,i;if(this._getActivity()&&this._getActivity().users_to_notify)for(n=this._getActivity().users_to_notify,e=0,t=n.length;t>e;e++)if(i=n[e],i.id===this.getActivityUser().id)return!0;return!1},toggleFeedbackForViewer:function(){var e,t,n;return this.getActivityUser().is_signed_in?(n=!this._isUserSubscribed(),t=Ce(n?"You have been subscribed.":"You have been unsubscribed."),e=Ce(n?"We failed to subscribe you.":"We failed to unsubscribe you."),this._toggleSubscribe(null,n,t,e)):(p.set_store("subscribe",this._getActivity().activity_key),this.modals.show_sign_in_modal(L.SUBSCRIBE_VARIANT),O.log_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,this._getActivity().activity_key,null,o.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON))},onFacepileContactAdded:function(t){var n,i,o,s,r,l,c,u,d;return null!=t?(o=t.data("name"),i=t.data("identifier"),l=t.data("photo-url"),n=t.data("dbx-account-id"),d=new h({id:n,display_name:o,email:i,photo_url:l,photo_circle_url:l}),c=d.id,e.call(function(){var e,t,n,i;for(n=this._getActivity().users_to_notify,i=[],e=0,t=n.length;t>e;e++)u=n[e],i.push(u.id);return i}.call(this),c)>=0?void a.error(Ce("User has already been subscribed!")):(r=Ce("User subscribed to comments."),s=Ce("An error occurred while subscribing user."),this._toggleSubscribe(d,!0,r,s))):void 0},_toggleSubscribe:function(e,t,n,i){var o,s,r,l,u;return!this.getActivityUser().is_email_verified&&t?(p.set_store("subscribe",null!=(u=this._getActivity())?u.activity_key:void 0),o=re.get_for_user(this.getActivityUser()),re.set_should_use_simple_ui(this.props.shouldUseSimpleModals),o.show_verify_modal(null,c.SUBSCRIBE_TO_COMMENTS)):(s=function(e){return function(t){return a.success(n),e.onSubscribeUpdated(t)}}(this),l=function(e){return function(t){return e.onSubscribeUpdated(t)}}(this),r=function(e){return function(t){return a.error(i),e.onSubscribeUpdated(t)}}(this),this.state.contextActivityStore.update_subscribe(this._getActivity(),this.getActivityUser(),t,e,s,l,r))},_verifyAfterSignUpCallback:function(){var e;return e=re.get_for_user(this.getActivityUser()),re.set_should_use_simple_ui(this.props.shouldUseSimpleModals),e.send_email(c.ADD_COMMENT,function(){}),e.show_resend_verify_modal(c.ADD_COMMENT)},onAnnotationButtonMouseUp:function(e,t){return this.showAnnotationWithPreview(e,t)},_scrollToAnnotationInPreview:function(e,t){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",{page:e,commentActivity:t})},resetToBlankState:function(){return 0===t(".blank-state").length?(t(".comments-holder .comment-list-facepile:visible").hide(),t(".comments-holder .comment-activity:visible").hide(),t(".comments-holder .comment-field:visible").hide(),!0):!1},showFeedbackModal:function(e){var n;return null!=e&&e.preventDefault(),n='<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Let us know how we can improve commenting in Dropbox." ></textarea> </div> </div>',be.show({title_text:Ce("Help us improve comments"),body_html:n,cancel_text:Ce("Cancel"),confirm_text:Ce("Submit Feedback"),confirm_callback:function(e){return function(){var n,i,o;return n=t("#comments-feedback-input").val(),o=function(){return a.success(Ce("Thank you! Your feedback will help improve Dropbox."))},i=function(){return function(){return a.error(Ce("There was an error submitting your feedback."))}},q.isFluxEnabled(e.props.context)?b.submitProductFeedback({actorId:e.props.userId,feedbackText:n,context:e.props.context,contextData:e.props.contextData,oref:e.props.oref}).then(o,i):e.state.contextActivityStore.submit_product_feedback(e.getActivityUser(),n,o,i)}}(this)})},getActivityUser:function(){return q.getActivityUser(this.props.userId)},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},disable:function(){return this.setState({enabled:!1})},enable:function(){return this.setState({enabled:!0}),this.forceUpdate()},turnOffComments:function(){var e;return this.setState({comments_on:!1,icon:"s_comments_locked"}),"function"==typeof(e=this.props).hideToggledCallback?e.hideToggledCallback(!1):void 0},turnOnComments:function(e){var t;return null!=e&&e.preventDefault(),this.isMounted()?(this.setState({comments_on:!0}),"function"==typeof(t=this.props).hideToggledCallback?t.hideToggledCallback(!0):void 0):void 0},turnOnFeedback:function(){return this.state.contextActivityStore.update_feedback_setting(n.clone(this._getActivity()),this.getActivityUser(),!1,function(e){return function(t){return e.setState({activity:t})}}(this))},turnOffFeedback:function(){return q.isFluxEnabled(this.props.context)||this.state.contextActivityStore.update_feedback_setting(n.clone(this._getActivity()),this.getActivityUser(),!0,function(e){return function(t){return e.setState({activity:t})}}(this)),this.turnOffComments()},onSubscribeUpdated:function(e){return this.setState({activity:e})},hide:function(e){var t;return null!=e&&e.preventDefault(),this.setState({visible:!1}),this._getActivity()&&O.log_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_HIDDEN,this._getActivity().activity_key,null,null,this.getActivityUser().id,this.props.activityContext),"function"==typeof(t=this.props).hideToggledCallback?t.hideToggledCallback(!1):void 0},show:function(e){var t;return null!=e&&e.preventDefault(),this.setState({visible:!0}),this._getActivity()&&O.log_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_SHOWN,this._getActivity().activity_key,null,null,this.getActivityUser().id,this.props.activityContext),"function"==typeof(t=this.props).hideToggledCallback?t.hideToggledCallback(!0):void 0},fitToHeight:function(e){return this.state.height!==e?this.setState({height:e}):void 0},_refreshWidth:function(){var e,n;return t(".video-js").length&&t(".video-js").css("width","100%"),n=this.state.enabled?t(this.getDOMNode()).width():0,"function"==typeof(e=this.props).previewWidthCallback?e.previewWidthCallback(n):void 0},_onActivitySuccessfullyFetched:function(e){return this.isMounted()?(e.feedback_off?this.turnOffComments():this.turnOnComments(),this.fileViewerState.setFileActivity(e),this.enable(),this.setState({activity:e,isFetchingActivity:!1},function(t){return function(){return!e.feedback_off&&t.modals&&t.modals.set_activity_key(e.activity_key),t._isPreviewAndCommentsReady()&&t.onPreviewAndCommentsReady(),t._prepareSwitchRevisionUI(),t._markAllCommentsSeen()}}(this))):void 0},_fetchActivity:function(e){var t,n;return this.isMounted()?q.isFluxEnabled(this.props.context)?(this._onActivitySuccessfullyFetched(this.props.activity),void("function"==typeof e&&e(this.props.activity))):(t=function(e){return function(){return e.disable(),e.setState({isFetchingActivity:!1})}}(this),n=function(t){return function(n,i,o,s){return t.isMounted()&&o===t.props.activityContextData?(t._onActivitySuccessfullyFetched(n),t._bolt_data=s,t.getActivityUser().is_signed_in&&t._startLiveUpdate(),"function"==typeof e?e(n):void 0):void 0}}(this),k.SessionStorage.set("reload-timestamp",(new Date).getTime()),this.state.contextActivityStore.fetch_activity_and_bolt_data(this.getActivityUser(),n,t,this.props.oref,!0),this.setState({isFetchingActivity:!0})):void 0},_hasLoaded:function(){return null!=this._getActivity()},_startLiveUpdate:function(){var e,t;return t=function(e){return function(t,n){return null==n&&(n=null),e.isMounted()?t.feedback_off?void e.turnOffComments():(e.turnOnComments(),e.setState({activity:t}),e._markAllCommentsSeen(),e.onNewActivity(n)):void 0}}(this),this._bolt_get_channel_states=function(e){var t,n,i,o,s;return s=e.activity_key,i=null!=(t=this._bolt_data)?t.revision:void 0,o=null!=(n=this._bolt_data)?n.token:void 0,[new y.SignedChannelState("file_activity",s,i,o)]},this._bolt_cb=function(e){return function(n){var i;return 1===(null!=n?n.length:void 0)&&n[0].unique_id===e._getActivity().activity_key?(i=function(i,o,s,r){var a;return e.isMounted()&&s===e.props.activityContextData?(e._bolt_data=r,n=e._bolt_get_channel_states(i),null!=(a=e._bolt_client)&&a.update_states(n),t(i,r.action_type)):void 0},k.SessionStorage.set("reload-timestamp",(new Date).getTime()),e.state.contextActivityStore.fetch_activity_and_bolt_data(e.getActivityUser(),i,null)):void 0}}(this),e=this._bolt_get_channel_states(this.state.activity),this._bolt_client=new y.BoltClient(e,this._bolt_cb,this._fetchActivity),this._bolt_client.start()},_stopLiveUpdate:function(){var e;return null!=(e=this._bolt_client)&&e.unsubscribe(),this._bolt_client=null},onNewActivity:function(e){var t;return this.setState({isNewCommentLoading:!1}),(null!=(t=this.refs.commentListUI)?t.isScrolledToBottom():void 0)||this.state.isSender||e!==o.FILE_ACTIVITY_ACTION_TYPE.NEW_COMMENT||this.setState({showNewComment:!0}),this.setState({isSender:!1})},checkCommentListScroll:function(){var e,t;return e=this.refs.commentListUI.isScrolledToBottom(),t=!e,t!==this.state.showBottomBar&&this.setState({showBottomBar:t}),e&&this.state.showNewComment?this.setState({showNewComment:!1}):void 0},onShowNewComment:function(){return this.refs.commentListUI.animateScrollToBottom(),this.setState({showNewComment:!1})},_markAllCommentsSeen:function(){var e,t,n;return this.getActivityUser().is_signed_in&&this.state.comments_on&&this.state.activity?(n=function(e){return function(){return e.notifyActivityLoaded(e._getActivity())}}(this),t=this._getActivity().comment_activities,e=t[t.length-1],e?this.state.contextActivityStore.mark_comments_seen(this._getActivity(),this.getActivityUser(),e.activity_key,n):void 0):void 0},render:function(){var e,t,n,o,s;return n=i.addons.classSet({"file-feedback":!0,"preview-ready":this.props.isPreviewReady,hidden:!this.state.enabled}),this.state.enabled||"function"==typeof(e=this.props).previewWidthCallback&&e.previewWidthCallback(0),s=this.getActivityUser(),o=s.is_signed_in&&E.getGandalfRule("comments-web-feedback"),t=this.state.height,o&&(t-=ae),this.state.isOffline&&(t-=fe),this.state.visible&&this.state.comments_on||!this.props.canCollapse?Ee.div({id:this.props.feedbackId,ref:"fileFeedbackUI",className:n,tabIndex:"-1",style:{height:this.state.height}},q.isFluxEnabled(this.props.context)||this.props.activityContext&&this.props.activityContextData?Ee.div({className:"comments-and-feedback"},this.state.isOffline?Ee.div({className:"comments-offline-banner"},Ee.div({className:"comments-offline-banner-inner"},ge({},"No Internet Connection"))):void 0,ie({ref:"commentListUI",showLoadingSpinner:this.props.showLoadingSpinner,context:this.props.context,activity:this._getActivity(),contextActivityStore:this.state.contextActivityStore,fileViewerInterfaceController:this.fileViewerInterfaceController,height:t,user:s,fileViewerState:this.fileViewerState,contactSearchLogger:this.contactSearchLogger,initialCommentsCount:this.props.initialCommentsCount,enableFacepile:E.isGandalfInVariant("comments_notify_facepile","FACEPILE"),enableNoNotifyHint:E.isGandalfInVariant("comments_no_notify_hint","ON"),forceNullStateLoadingState:this.props.forceNullStateLoadingState||0===this.props.initialCommentsCount,isNewCommentLoading:this.state.isNewCommentLoading,isSender:this.state.isSender,isUserSubscribed:this._isUserSubscribed(),shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showNewComment:this.state.showNewComment,showResolvedComments:this._showResolvedComments(),isCommentInputDisabled:this.state.isCommentInputDisabled,enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isThreadingEnabled:this._isThreadingEnabled(),isVisibleAtMentions:E.isGandalfInVariant("comments_visible_at_mentions","ON"),isOffline:this.state.isOffline,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldShowAnnotationUIOnImages:this.shouldShowAnnotationUIOnImages,onAddCommentFromList:this.onAddCommentFromList,onAddSticker:this.onAddCommentFromSticker,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onDeleteComment:this.onDeleteCommentFromList,onFacepileContactAdded:this.onFacepileContactAdded,onHideCommentsPane:this.hide,onInputBlur:this.props.onInputBlur,onInputFocus:this.props.onInputFocus,onLikeComment:this.onLikeCommentFromList,onUpdateResolve:this.onResolveCommentFromList,checkScroll:this.checkCommentListScroll,onShowNewComment:this.onShowNewComment,onSubscribeUpdated:this.onSubscribeUpdated,onToggleShowResolvedComments:this.onToggleShowResolvedComments,shouldShowHideButton:this.props.canCollapse,toggleFeedbackForViewer:this.toggleFeedbackForViewer,turnOffFeedbackCallback:this.turnOffFeedback,turnOnFeedbackCallback:this.turnOnFeedback,verifyAfterSignUpCallback:this._verifyAfterSignUpCallback}),o?Ee.div({className:"comments-feedback-link",style:{height:ae}},Ee.div({className:"comments-feedback-link-inner"},Ee.a({onMouseUp:this.showFeedbackModal},ge({},"Help us improve comments")))):void 0):void 0):this.state.comments_on&&!this.state.visible?Ee.div({id:this.props.feedbackId,className:"hidden-comments",style:{height:this.state.height}},Ee.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.show},Ee.div({className:"show-button-sprite"},we({group:"web",name:"s_show_comments_grey",alt:Ce("Show comments")})))):this._hasLoaded()&&this._getActivity().can_edit_feedback?Ee.div({id:this.props.feedbackId,className:"hidden-comments",style:{height:this.state.height},onMouseOver:this.setUnlockedIcon,onMouseOut:this.setLockedIcon},Ee.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.turnOnComments},Ee.div({className:"show-button-sprite"},we({group:"web",name:this.state.icon,alt:Ce("Show comments")})))):Ee.div({id:this.props.feedbackId,className:"hidden"})}}),{FileFeedbackUIClass:pe}})}.call(this),function(){define("modules/clean/react/file_comments/logger",["modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/annotations/annotation","modules/clean/viewer","modules/core/exception"],function(e,t,n,i,o,s){var r,a,l;return r=i.Annotation,a=function(){function t(){}return t.prototype.log_event=function(t,n,i,o,r,a,l,c,u){return null==l&&(l=null),null==c&&(c=null),null==u&&(u=null),s.assert(t,"event_type not provided"),s.assert(n,"file_activity_key not provided"),e.WebRequest({url:"/file_activity/client_log",type:"POST",data:{event_type:t,file_activity_key:n,comment_activity_key:i,client_origin_type:o,activity_context:a,annotation_type:l,annotation_subtype:c,annotation_page:u},subject_user:r})},t.prototype.log_annotation_event=function(e,t,n,i,o,s){var a,l,c,u;return null==s&&(s=null),null!=s&&(a=r.createAnnotationFromDict(s),u=a.type,c=a.subtype,l=a.getFirstPdfPage()),this.log_event(e,t,n,null,i,o,u,c,l)},t}(),l=new a})}.call(this),function(){var e=[].slice;define("modules/clean/react/file_comments/onboarding",["external/react","modules/core/i18n","modules/clean/gandalf_util","modules/clean/react/image","modules/clean/react/modal","modules/clean/react/onboarding_modal","modules/clean/static_urls"],function(t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f,v,g;return m=n._,u=s.Modal,g=a.static_url,v=t.DOM,f=t.addons.classSet,p=[{src:g("/static/images/commenting/onboarding_step1-vflB01-Fx.png"),srcHiRes:g("/static/images/commenting/onboarding_step1@2x-vflyooTgN.png")},{src:g("/static/images/commenting/onboarding_step2-vflQHsmaO.png"),srcHiRes:g("/static/images/commenting/onboarding_step2@2x-vflEm4vmD.png")},{src:g("/static/images/commenting/onboarding_step3-vflvKl_oO.png"),srcHiRes:g("/static/images/commenting/onboarding_step3@2x-vfljsqrRb.png")}],d=t.createFactory(r),c=t.createFactory(o),_=t.createClass({displayName:"slide",mixins:[t.addons.PureRenderMixin],statics:{slideImages:p},propTypes:{heading:t.PropTypes.string.isRequired,subheading:t.PropTypes.string.isRequired,image:t.PropTypes.shape({src:t.PropTypes.string.isRequired,srcHiRes:t.PropTypes.string.isRequired}).isRequired,className:t.PropTypes.string},render:function(){return v.div({className:f("comment-onboarding-slide",this.props.className)},c({src:this.props.image.src,srcHiRes:this.props.image.srcHiRes,className:"comment-onboarding-illustration"}),v.h1({className:"comment-onboarding-heading"},this.props.heading),v.h2({className:"comment-onboarding-subheading"},this.props.subheading))}}),h=t.createFactory(_),l=t.createClass({displayName:"CommentingOnboardingModal",mixins:[t.addons.PureRenderMixin],PropTypes:{onOpen:t.PropTypes.func,onClose:t.PropTypes.func},componentDidMount:function(){
var e;return"function"==typeof(e=this.props).onOpen?e.onOpen():void 0},getSlides:function(){return i.getGandalfRule("dw-comments-inline-ea")?[h({className:"comment-slide-1",heading:m("Annotate your files"),subheading:m("Give clear, focused feedback that’s faster than email."),image:p[0]}),h({className:"comment-slide-2",heading:m("Point to what you’re talking about"),subheading:m("Just click anywhere inside the doc, or drag around a specific area."),image:p[1]}),h({className:"comment-slide-3",heading:m("Never lose track of feedback"),subheading:m("Conversations stay with the file, and you can view on any device."),image:p[2]})]:[h({className:"comment-slide-1",heading:m("Comment on your files"),subheading:m("Give clear, focused feedback that’s faster than email."),image:p[0]}),h({className:"comment-slide-2",heading:m("Never lose track of feedback"),subheading:m("Conversations stay with the file, and you can view on any device."),image:p[2]})]},render:function(){return d.apply(null,[{className:"comment-onboarding-modal",slideWidth:600,onClose:this.props.onClose}].concat(e.call(this.getSlides())))}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/react/file_comments/shared_link_signup_modals",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/clean/react/file_comments/logger","modules/constants/legacy","modules/core/browser","modules/core/i18n","modules/core/notify"],function(t,n,i,o,s,r,a,l){var c,u,d;return u=i.DBModal,d=a._,c=function(){function t(){this._toggle_form=e(this._toggle_form,this),this._prepare_form=e(this._prepare_form,this),this._reload=e(this._reload,this),this.before_modal=e(this.before_modal,this),this.show_sign_in_modal=e(this.show_sign_in_modal,this),this.show_sign_up_modal=e(this.show_sign_up_modal,this),this.hide_modal=e(this.hide_modal,this),this.init_modals=e(this.init_modals,this),this.show_register=!1,this.init_modals()}return t.POST_COMMENT_VARIANT="post_comment_variant",t.LIKE_COMMENT_VARIANT="like_comment_variant",t.SUBSCRIBE_VARIANT="subscribe_variant",t.prototype.init_modals=function(){return this.default_signup_modal=new u({element_id:"shared-link-default-comments-signup-modal"}),this.default_signup_modal.before_show=this.before_modal},t.prototype.hide_modal=function(){return this.default_signup_modal.hide()},t.prototype.show_sign_up_modal=function(e){return this.show_register=!0,this.variant=e,this.default_signup_modal.show()},t.prototype.show_sign_in_modal=function(e){return this.show_register=!1,this.variant=e,this.default_signup_modal.show()},t.prototype.set_activity_key=function(e){return this.activity_key=e},t.prototype.before_modal=function(e){var t,n;return this._prepare_form(e),e.find(".toggle-form-link").click(function(t){return function(){return t._toggle_form(e)}}(this)),n=e.find(".register-form"),n.length&&n.on("db:register:success",function(e){return function(t,n){return e.user=n,l.success(d("Successfully signed up for Dropbox")),o.log_event(s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_SUCCESS,e.activity_key,null,null,e.user.id),e._reload()}}(this)),t=e.find(".login-form"),t.length?(n.length&&n.on("db:register:user_exists",function(n){return function(i){var o,s,r,a,l;for(n._toggle_form(e),a=i.prefill,l=o=0,r=a.length;r>o;l=++o)s=a[l],t.find(s).val(l);return t.find(i.focus).focus()}}(this)),t.on("db:login:success",function(e){return function(t,n){return e.user=n,l.success(d("Successfully signed in to Dropbox")),o.log_event(s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_SUCCESS,e.activity_key,null,null,e.user.id),e._reload()}}(this))):void 0},t.prototype._reload=function(){return r.reload()},t.prototype._prepare_form=function(e){switch(e.find(".form-component").hide(),e.find(".text-variant").hide(),this.show_register?e.find(".register-form-component").show():e.find(".login-form-component").show(),this.variant){case t.POST_COMMENT_VARIANT:return e.find(".text-variant.post-comment-variant").show();case t.LIKE_COMMENT_VARIANT:return e.find(".text-variant.like-comment-variant").show();case t.SUBSCRIBE_VARIANT:return e.find(".text-variant.subscribe-variant").show();default:return e.find(".text-variant.default-variant").show()}},t.prototype._toggle_form=function(e){var t,n,i,r,a,l;return a=e.find(".register-form-component"),r=e.find(".login-form-component"),a.is(":visible")?(n=s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_MODAL,a.fadeOut({complete:function(){return r.show()}})):(n=s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,r.fadeOut({complete:function(){return a.show()}})),o.log_event(n=n,i=this.activity_key,t=null,l=s.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.MODAL_TOGGLE_BUTTON)},t}()})}.call(this),function(){define("modules/clean/react/file_comments/stickers",["jquery","external/react","external/immutable","external/underscore","modules/clean/sticker_util"],function(e,t,n,i,o){var s,r,a,l;return l=t.DOM,s=t.createFactory(t.createClass({displayName:"StickerSet",propTypes:{onStickerClick:t.PropTypes.func,isSelected:t.PropTypes.bool,data:t.PropTypes.object},_onStickerClick:function(e){var t;return e.preventDefault(),t=parseInt(e.currentTarget.getAttribute("data-sticker-id")),this.props.onStickerClick(t)},render:function(){var e,n,i,s;return n=t.addons.classSet,e=n({"sticker-set":!0,"is-selected":this.props.isSelected}),l.div({className:e},function(){var e,t,n,r;for(n=this.props.data.stickers,r=[],e=0,t=n.length;t>e;e++)i=n[e],s=o.getStickerImageUrl(i.id),r.push(l.a({onClick:this._onStickerClick,"data-sticker-id":i.id},l.img({src:s})));return r}.call(this))}})),r=t.createFactory(t.createClass({displayName:"StickerTab",propTypes:{data:t.PropTypes.object,onChangeSelection:t.PropTypes.func,isSelected:t.PropTypes.bool},_onStickerTabClick:function(e){return e.preventDefault(),this.props.onChangeSelection(this.props.data.name)},render:function(){var e,n;return n=t.addons.classSet,e=n({"sticker-nav-item":!0,"is-selected":this.props.isSelected}),l.a({className:e,onClick:this._onStickerTabClick},l.img({src:o.getStickerSetImageUrl(this.props.data.id)}))}})),a=t.createFactory(t.createClass({displayName:"Stickers",SCROLL_DISTANCE:200,propTypes:{onStickerSelected:t.PropTypes.func,isPopupAbove:t.PropTypes.bool},getInitialState:function(){return{selected:"CatBlobs",scrollOffset:0}},_onChangeSelection:function(e){return this.setState({selected:e})},_onStickerSelected:function(e){return this.props.onStickerSelected(e)},_getMaxScroll:function(){var t,n,i,o,s,r;for(r=0,s=this.getDOMNode().getElementsByClassName("sticker-nav-item"),i=0,o=s.length;o>i;i++)t=s[i],r+=e(t).outerWidth(!0);return n=60,this.refs.tabs.getDOMNode().offsetWidth-r-n},_onLeftArrowPress:function(e){return e.preventDefault(),this.setState({scrollOffset:Math.min(0,this.state.scrollOffset+this.SCROLL_DISTANCE)})},_onRightArrowPress:function(e){return e.preventDefault(),this.setState({scrollOffset:Math.max(this._getMaxScroll(),this.state.scrollOffset-this.SCROLL_DISTANCE)})},_renderTabs:function(e){var n,i;return i=t.addons.classSet,n=i({"sticker-nav":!0,"show-left":this.state.scrollOffset<0,"show-right":!this.isMounted()||this.state.scrollOffset!==this._getMaxScroll(),"on-top":this.props.isPopupAbove,"on-bottom":!this.props.isPopupAbove}),l.div({className:n,ref:"tabs"},l.a({href:"#left",onClick:this._onLeftArrowPress,className:"arrow left"}),l.div({className:"sticker-nav-inner",ref:"tabScroller",style:{marginLeft:this.state.scrollOffset}},e),l.a({href:"#right",onClick:this._onRightArrowPress,className:"arrow right"}))},render:function(){var e,t,n,i,a,c;for(c=[],a=[],i=o.getStickers(),e=0,n=i.length;n>e;e++)t=i[e],c.push(new r({data:t,isSelected:t.name===this.state.selected,onChangeSelection:this._onChangeSelection})),a.push(new s({data:t,count:t.stickers.length,isSelected:t.name===this.state.selected,onStickerClick:this._onStickerSelected}));return l.div({className:"sticker-container",refs:"stickerContainer"},l.div({className:"sticker-menu-wrapper"},l.div({className:"sticker-menu"},this.props.isPopupAbove?this._renderTabs(c):void 0,l.div({className:"sticker-sets-wrapper"},a),this.props.isPopupAbove?void 0:this._renderTabs(c))))}})),{Stickers:a}})}.call(this),function(){define("modules/clean/react/file_comments/switch_revision_ui",["jquery","external/react","modules/clean/datetime","modules/clean/comments/actions","modules/clean/comments/utils"],function(e,t,n,i,o){var s,r,a;return a=t.DOM,s=t.addons.CSSTransitionGroup,r=t.createClass({displayName:"SwitchRevisionUI",propTypes:{context:t.PropTypes.number,latestRevision:t.PropTypes.object,showSwitchRevisionUI:t.PropTypes.bool,onSwitchToLatestRevision:t.PropTypes.func,revision:t.PropTypes.object},getInitialState:function(){return{}},getDefaultProps:function(){return{showSwitchRevisionUI:!1}},onSwitchToLatestRevision:function(){var e;return o.isFluxEnabled(this.props.context)?i.switchRevision({revision:this.props.latestRevision}):"function"==typeof(e=this.props).onSwitchToLatestRevision?e.onSwitchToLatestRevision():void 0},render:function(){var e;return e=[],this.props.showSwitchRevisionUI&&(e=[a.div({className:"switch-revision-bar"},a.div({className:"switch-revision-bar__title"},a.span({},"Viewing old revision"),null==this.props.revision||null==this.props.revision.when||isNaN(new Date(null!=this.props.revision.when))?void 0:a.span({className:"switch-revision-bar__title__date"},""+n.ago(new Date(1e3*this.props.revision.when)))),a.div({className:"switch-revision-bar__actions"},a.a({className:"button-elm button-tertiary",onMouseUp:this.onSwitchToLatestRevision},"Switch back to latest revision")))]),a.div({className:"switch-revision-ui"},this.props.showSwitchRevisionUI?e:void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_activity_ui",["jquery","external/react","external/underscore","modules/core/i18n","modules/clean/activity/activity","modules/clean/activity/activity_local_storage","modules/clean/activity/activity_user","modules/clean/components/loading_indicator","modules/clean/datetime","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/file_comments/logger","modules/clean/react/image","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/static_urls","modules/clean/comments/actions","modules/clean/comments/utils"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b){var w,C,E,S,T,A,I,k,P,N;return I=i._,N=i.ungettext,P=g.static_url,k=t.DOM,S=h.R_,T=t.addons.CSSTransitionGroup,w=t.createFactory(m),C=t.createFactory(f),E=t.createFactory(p),A=t.createClass({displayName:"ThreadedCommentActivityUI",propTypes:{context:t.PropTypes.number,contextActivityStore:t.PropTypes.object.isRequired,commentActivity:t.PropTypes.instanceOf(o.CommentActivity).isRequired,user:t.PropTypes.object.isRequired,onAnnotationButtonMouseUp:t.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:t.PropTypes.bool,fileViewerState:t.PropTypes.object,shouldAutoLinkify:t.PropTypes.bool,shouldUseSimpleModals:t.PropTypes.bool,shouldHidePhotoAvatars:t.PropTypes.bool,activity:t.PropTypes.instanceOf(o.FileActivity).isRequired,showResolvedComments:t.PropTypes.bool,contactSearchLogger:t.PropTypes.object,onReplyInputFocus:t.PropTypes.func,onReplyInputBlur:t.PropTypes.func,enableNoNotifyHint:t.PropTypes.bool,isCommentInputDisabled:t.PropTypes.bool,enableImport:t.PropTypes.bool,showNewComment:t.PropTypes.bool,shouldShowAnnotationUIOnImages:t.PropTypes.bool,isVisibleAtMentions:t.PropTypes.bool,checkScroll:t.PropTypes.func,onAddCommentFromList:t.PropTypes.func,onAddSticker:t.PropTypes.func,onShowNewComment:t.PropTypes.func,onDeleteComment:t.PropTypes.func.isRequired,onUpdateResolve:t.PropTypes.func,onLikeComment:t.PropTypes.func,onToggleShowResolvedComments:t.PropTypes.func,verifyAfterSignUpCallback:t.PropTypes.func},getInitialState:function(){return{shouldCollapsedReplies:!0,isNewReplyLoading:!1,shouldShowReplyInput:!1}},getDefaultProps:function(){return{isVisibleAtMentions:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillMount:function(){return this.lastCommentsCount=this.props.commentActivity.comment_activities.length},componentWillReceiveProps:function(e){return e.commentActivity.comment_activities.length>this.lastCommentsCount&&this.state.isNewReplyLoading?(this.lastCommentsCount=e.commentActivity.comment_activities.length,this.setState({isNewReplyLoading:!1})):void 0},onAddCommentFromList:function(e,t){var n;return null==t&&(t={}),b.isFluxEnabled(this.props.context)?y.addComment({targetActivity:this.props.commentActivity,text:e,metadata:t}):(this.setState({isNewReplyLoading:!0}),"function"==typeof(n=this.props).onAddCommentFromList?n.onAddCommentFromList(e,t,this.props.commentActivity):void 0)},onAddSticker:function(e){var t;return b.isFluxEnabled(this.props.context)?y.addStickerComment({targetActivity:this.props.commentActivity,stickerId:e}):(this.setState({isNewReplyLoading:!0}),"function"==typeof(t=this.props).onAddSticker?t.onAddSticker(e):void 0)},_verifyAfterSignUpCallback:function(){var e;return"function"==typeof(e=this.props).verifyAfterSignUpCallback?e.verifyAfterSignUpCallback():void 0},resizeCallback:function(){return this.forceUpdate()},onCancelComment:function(){return this.setState({shouldShowReplyInput:!1})},onLikeComment:function(e){var t;return"function"==typeof(t=this.props).onLikeComment?t.onLikeComment(e):void 0},onUpdateResolve:function(e,t){var n;return"function"==typeof(n=this.props).onUpdateResolve?n.onUpdateResolve(e,t):void 0},onDeleteComment:function(e){return this.props.onDeleteComment(e)},onAnnotationButtonMouseUp:function(e,t){var n;return"function"==typeof(n=this.props).onAnnotationButtonMouseUp?n.onAnnotationButtonMouseUp(e,t):void 0},onReplyButtonMouseUp:function(){return this.setState({shouldShowReplyInput:!this.state.shouldShowReplyInput})},onToggleReplies:function(){return this.setState({shouldCollapsedReplies:!1})},hasReplies:function(){return this.repliesCount()>0},repliesCount:function(){return this.props.commentActivity.comment_activities.length},renderCommentActivityUI:function(e,t,n,i){return null==n&&(n=!1),null==i&&(i=!1),w({context:this.props.context,key:"comment_"+t.activity_key,parentActivity:e,fileActivity:this.props.activity,comment_activity:t,context_activity_store:this.props.contextActivityStore,user:this.props.user,fileViewerState:this.props.fileViewerState,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldShowReplyButton:i,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,onLikeComment:this.onLikeComment,onDeleteComment:this.onDeleteComment,onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,onUpdateResolve:this.onUpdateResolve,shouldAutoLinkify:this.props.shouldAutoLinkify,isReply:n,onReplyButtonMouseUp:this.onReplyButtonMouseUp})},render:function(){var e,n,i,o,s,r,l,u,d;if(l=t.createElement(a,{style:a.LoadingIndicatorStyle.BLUE_SPINNER}),n=[],u=0,this.hasReplies())for(d=this.props.commentActivity.comment_activities,o=i=0,r=d.length;r>i;o=++i)e=d[o],e.comment.resolved&&(u+=1),e.comment.resolved&&!this.props.showResolvedComments||e.isDeleted||(s=o===this.repliesCount()-1,n.push(this.renderCommentActivityUI(this.props.commentActivity,e,!0,s)));return k.div({className:"threaded-comment-list"},k.div({},this.renderCommentActivityUI(this.props.activity,this.props.commentActivity,!1,!this.hasReplies())),this.hasReplies()?k.div({},this.repliesCount()>1&&this.state.shouldCollapsedReplies?k.div({},k.a({className:"replies-count-button",onMouseDown:this.onToggleReplies},N("%(num)s more comment","%(num)s more comments",this.repliesCount()-1).format({num:this.repliesCount()-1})),k.div({},n[n.length-1])):n):void 0,this.state.isNewReplyLoading?k.div({className:"comments-loading"},l):void 0,this.state.shouldShowReplyInput?C({ref:"commentInput",activity:this.props.activity,user:this.props.user,onAddComment:this.onAddCommentFromList,onCancelComment:this.onCancelComment,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,verifyAfterSignUpCallback:this._verifyAfterSignUpCallback,resizeCallback:this.resizeCallback,popupsShouldDropdown:this.state.popupsShouldDropdown,onFocus:this.props.onReplyInputFocus,onBlur:this.props.onReplyInputBlur,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,inBlankState:!0,enableNotifyText:!1,enableNoNotifyHint:this.props.enableNoNotifyHint,commentMetadataAllowed:c.getGandalfRule("pptx-commenting")||c.getGandalfRule("dw-comments-stickers"),shouldEnableStickers:c.getGandalfRule("dw-comments-stickers"),fileViewerState:this.props.fileViewerState,shouldInitiallyFocusInput:!1,shouldScrollIntoView:!0,isCommentInputDisabled:this.props.isCommentInputDisabled,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isReplyInput:!0,shouldShowAvatar:!1}):void 0,k.div({className:"threaded-comment-list__divider"},""))}})})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/react/file_uploader/store",["modules/clean/base64","modules/core/exception","modules/clean/flux/base_store","external/immutable","modules/clean/react/browse/constants"],function(t,n,i,o,s){var r,a,l,c,u,d,p,h;return p=n.assert,r=s.BrowseActionTypes,u={SET_PATH:"UPLOADER_SET_PATH",SET_USER:"UPLOADER_SET_USER",SET_NUM_DRAGGING_FILES:"SET_NUM_DRAGGING_FILES",QUEUE_UPLOADS:"QUEUE_UPLOADS",START_UPLOAD:"START_UPLOAD",COMPLETE_UPLOAD:"COMPLETE_UPLOAD",CANCEL_UPLOADS:"CANCEL_UPLOADS",SET_CURRENT_UPLOAD_PROGRESS:"SET_CURRENT_UPLOAD_PROGRESS",UPLOAD_ERROR:"UPLOAD_ERROR",SET_IS_UPLOAD_MODAL_OPEN:"SET_IS_UPLOAD_MODAL_OPEN",SET_IS_INLINE_STATUS_DISMISSED:"SET_IS_INLINE_STATUS_DISMISSED",ADD_NEW_FAILED_FILE:"ADD_NEW_FAILED_FILE"},a={PENDING:"PENDING",UPLOADING:"UPLOADING",COMPLETE:"COMPLETE",CANCELLED:"CANCELLED",FAILED:"FAILED"},c={FILE_SIZE_ERROR:"FILE_SIZE_ERROR",HTTP_ERROR:"HTTP_ERROR",CONNECTION_ERROR:"CONNECTION_ERROR",OVER_QUOTA_ERROR:"OVER_QUOTA_ERROR",IGNORED:"IGNORED",EMPTY_OR_FOLDER:"EMPTY_OR_FOLDER",PACKAGE_FILE:"PACKAGE_FILE",GENERIC:"GENERIC"},l=o.Record({uploadId:void 0,dest:"",userId:null,name:"",size:0,percentUploaded:0,status:a.PENDING,errorType:c.GENERIC,errorMessage:""}),h=function(){var e,n,i,o;for(e="",n=i=0;15>=i;n=++i)e+=String.fromCharCode(Math.floor(256*Math.random()));return o=t.encode(e),o=o.replace(/\+/g,"-"),o=o.replace(/\//g,"_"),o=o.replace(/\=*$/,"")},d=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype._init=function(){return this._path="/",this._user=null,this._fileList=o.OrderedMap(),this._currentUploadId=null,this._numDraggingFiles=0,this._isUploadModalOpen=!1,this._isInlineStatusDismissed=!1,this._numSecondsLeft=0},n.prototype.fileList=function(){return this._fileList},n.prototype.currentUpload=function(){return this._fileList.get(this._currentUploadId)},n.prototype.currentUploadPercentage=function(){return this.currentUpload().percentUploaded},n.prototype.numSecondsLeft=function(){return this._numSecondsLeft},n.prototype.isUploadCancelled=function(e){var t;return(null!=(t=this._fileList.get(e))?t.status:void 0)===a.CANCELLED},n.prototype.isInlineStatusDismissed=function(){return this._isInlineStatusDismissed},n.prototype.path=function(){return this._path},n.prototype.user=function(){return this._user},n.prototype.nextUpload=function(){return this._fileList.find(function(e){return e.status===a.PENDING})},n.prototype.numDraggingFiles=function(){return this._numDraggingFiles},n.prototype.totalSizeOfCompletedUploads=function(){return this._fileList.reduce(function(e,t){return t.status===a.COMPLETE?e+t.size:e},0)},n.prototype.totalSize=function(){return this._fileList.reduce(function(e,t){var n;return(n=t.status)===a.COMPLETE||n===a.PENDING||n===a.UPLOADING?e+t.size:e},0)},n.prototype.isUploadModalOpen=function(){return this._isUploadModalOpen},n.prototype._setUser=function(e){var t;return t=e.user,this._user=t,this.emit_change()},n.prototype._setPath=function(e){var t;return t=e.path,this._path=t,this.emit_change()},n.prototype._queueUploads=function(e){var t,n,i,o,s;for(n=e.files,s={},i=0,o=n.length;o>i;i++)t=n[i],s[t.uploadId]=t;return this._fileList=this._fileList.merge(s),this.emit_change()},n.prototype._startUpload=function(e){var t;return t=e.file,p(null==this._currentUpload),p(null!=t),p(this._fileList.get(t.uploadId)===t),this._fileList=this._fileList.update(t.uploadId,function(e){return e.set("status",a.UPLOADING)}),this._currentUploadId=t.uploadId,this.emit_change()},n.prototype._completeUpload=function(e){var t,n;return t=e.uploadId,n=this._fileList.find(function(e){return e.status===a.UPLOADING}),p(t===(null!=n?n.uploadId:void 0)),this._fileList=this._fileList.update(n.uploadId,function(e){return e.set("status",a.COMPLETE)}),this._currentUploadId=null,this.emit_change()},n.prototype._cancelUploads=function(e){var t,n,i,o;for(n=e.files,i=0,o=n.length;o>i;i++)t=n[i],this._fileList=this._fileList.update(t.uploadId,function(e){var t;return(t=e.status)===a.PENDING||t===a.UPLOADING?e.set("status",a.CANCELLED):e}),t.uploadId===this._currentUploadId&&(this._currentUploadId=null);return this.emit_change()},n.prototype._setCurrentUploadProgress=function(e){var t,n;return n=e.percentComplete,t=e.numSecondsLeft,this._fileList=this._fileList.update(this._currentUploadId,function(e){return e.set("percentUploaded",n)}),this._numSecondsLeft=t,this.emit_change()},n.prototype._handleUploadError=function(e){var t,n,i,o;return o=e.uploadId,n=e.errorType,t=e.errorMessage,i=this._fileList.get(o),p(i.uploadId===this._currentUploadId),this._fileList=this._fileList.update(i.uploadId,function(e){return e.set("status",a.FAILED).set("errorType",n).set("errorMessage",t)}),this._currentUploadId=null,this.emit_change()},n.prototype._setNumDraggingFiles=function(e){var t;return t=e.numDraggingFiles,this._numDraggingFiles=t,this.emit_change()},n.prototype._setIsUploadModalOpen=function(e){var t;return t=e.isUploadModalOpen,this._isUploadModalOpen=t,this.emit_change()},n.prototype._setIsInlineStatusDismissed=function(e){var t;return t=e.isInlineStatusDismissed,this._isInlineStatusDismissed=t,this.emit_change()},n.prototype._addNewFailedFile=function(e){var t,n,i;return i=e.file,n=e.errorType,t=e.errorMessage,null==i.uploadId&&(i=i.set("uploadId",h())),i=i.set("status",a.FAILED).set("errorType",n).set("errorMessage",t),this._fileList=this._fileList.set(i.uploadId,i),this.emit_change()},n.prototype._new_payload=function(e){switch(e.action.type){case r.SET_USER:case u.SET_USER:return this._setUser(e.action.data);case r.SET_PATH:case u.SET_PATH:return this._setPath(e.action.data);case u.QUEUE_UPLOADS:return this._queueUploads(e.action.data);case u.START_UPLOAD:return this._startUpload(e.action.data);case u.COMPLETE_UPLOAD:return this._completeUpload(e.action.data);case u.CANCEL_UPLOADS:return this._cancelUploads(e.action.data);case u.SET_CURRENT_UPLOAD_PROGRESS:return this._setCurrentUploadProgress(e.action.data);case u.UPLOAD_ERROR:return this._handleUploadError(e.action.data);case u.SET_NUM_DRAGGING_FILES:return this._setNumDraggingFiles(e.action.data);case u.SET_IS_UPLOAD_MODAL_OPEN:return this._setIsUploadModalOpen(e.action.data);case u.SET_IS_INLINE_STATUS_DISMISSED:return this._setIsInlineStatusDismissed(e.action.data);case u.ADD_NEW_FAILED_FILE:return this._addNewFailedFile(e.action.data)}},n}(i),{UploaderStore:new d,UploaderActionTypes:u,FileUpload:l,FileStatus:a,UploadErrorType:c,generateUploadId:h}})}.call(this),function(){define("modules/clean/react/file_viewer/actions",["modules/clean/previews/util","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/dispatcher","modules/clean/react/file_viewer/store","modules/clean/analytics"],function(e,t,n,i,o){var s,r,a,l;return l=e.PreviewHelper,s=t.ActionTypes,a=o.PreviewActivityLogger,new(r=function(){function e(){}return e.prototype.setup=function(e,t,i){return n.dispatch({type:s.SETUP,data:{files:e,currentIndex:t,user:i}})},e.prototype.cleanup=function(){return n.dispatch({type:s.CLEANUP})},e.prototype.updateFiles=function(e){return n.dispatch({type:s.UPDATE_FILES,data:{files:e}})},e.prototype.replaceFile=function(e){return n.dispatch({type:s.REPLACE_FILE,data:{file:e}})},e.prototype.flipNext=function(){return n.dispatch({type:s.FLIP_NEXT})},e.prototype.flipPrevious=function(){return n.dispatch({type:s.FLIP_PREVIOUS})},e.prototype.openFullscreen=function(){var e;return e={file_ext:l.get_extension(i.currentFile())},this.openFullscreenLogging(e),n.dispatch({type:s.OPEN_FULLSCREEN})},e.prototype.openFullscreenLogging=function(e){return a.log("enter-fullscreen",e)},e.prototype.closeFullscreen=function(){var e;return e={file_ext:l.get_extension(i.currentFile())},this.closeFullscreenLogging(e),n.dispatch({type:s.CLOSE_FULLSCREEN})},e.prototype.closeFullscreenLogging=function(e){return a.log("exit-fullscreen",e)},e.prototype.switchRevision=function(e){return n.dispatch({type:s.SWITCH_REVISION,data:{file:e}})},e.prototype.restoreRevision=function(){return n.dispatch({type:s.RESTORE_REVISION})},e}())})}.call(this),function(){define("modules/clean/react/file_viewer/coach_mark",["external/react","modules/clean/components/flag","modules/core/i18n","modules/clean/css","modules/clean/react/image"],function(e,t,n,i,o){var s,r,a,l,c,u,d,p,h,_,m;return a=n._,_=e.DOM,l=_.button,u=_.div,d=_.h4,p=_.img,h=_.p,m=_.strong,r=e.createFactory(t),c=e.addons.classSet,s=e.createClass({displayName:"CoachMark",propTypes:{title:e.PropTypes.string.isRequired,imageUrl:e.PropTypes.string.isRequired,imageUrl2x:e.PropTypes.string.isRequired,imageAlt:e.PropTypes.string.isRequired,buttonText:e.PropTypes.string.isRequired,onButtonClick:e.PropTypes.func.isRequired,onShown:e.PropTypes.func},componentWillMount:function(){return i.require_css("/static/css/components/bubble_dropdown-vflU9zYcq.css"),i.require_css("/static/css/components/coach_mark-vfl5FeU94.css")},componentDidMount:function(){var e;return"function"==typeof(e=this.props).onShown?e.onShown():void 0},_renderCoachMarkImage:function(){return o({className:"c-coach-mark__img",src:this.props.imageUrl,srcHiRes:this.props.imageUrl2x,alt:this.props.imageAlt})},_renderCoachMarkMessage:function(){return u({className:"coach-mark_message"},d({},this.props.title),h({refs:"coachmarkBody"},this.props.children),l({className:"button-primary button-small",onMouseUp:this.props.onButtonClick,ref:"coachmarkButton"},this.props.buttonText))},render:function(){return u({className:"c-coach-mark bubble-dropdown top-right",ref:"coachmark"},r({fixedChild:this._renderCoachMarkImage(),flexChild:this._renderCoachMarkMessage()}),u({className:"bubble-arrow-border"}),u({className:"bubble-arrow"}))}})})}.call(this),function(){define("modules/clean/react/file_viewer/constants",[],function(){var e;return e={},e.ActionTypes={SETUP:"SETUP",CLEANUP:"CLEANUP",UPDATE_FILES:"UPDATE_FILES",REPLACE_FILE:"REPLACE_FILE",FLIP_NEXT:"FLIP_NEXT",FLIP_PREVIOUS:"FLIP_PREVIOUS",OPEN_FULLSCREEN:"OPEN_FULLSCREEN",CLOSE_FULLSCREEN:"CLOSE_FULLSCREEN",SWITCH_REVISION:"SWITCH_REVISION",RESTORE_REVISION:"RESTORE_REVISION"},e.EventTypes={FILE_VIEWER_OPENED:"FILE_VIEWER_OPENED",FILE_VIEWER_CLOSED:"FILE_VIEWER_CLOSED",FILE_PREVIEW_ATTEMPT_STARTED:"FILE_PREVIEW_ATTEMPT_STARTED",FILE_PREVIEW_SUPPORT_CONFIRMED:"FILE_PREVIEW_SUPPORT_CONFIRMED",FILE_PREVIEW_SUPPORT_DENIED:"FILE_PREVIEW_SUPPORT_DENIED",FILE_PREVIEW_DOWNLOAD_SUCCEEDED:"FILE_PREVIEW_DOWNLOAD_SUCCEEDED",FILE_PREVIEW_DOWNLOAD_FAILED:"FILE_PREVIEW_DOWNLOAD_FAILED",FILE_PREVIEW_RENDER_SUCCEEDED:"FILE_PREVIEW_RENDER_SUCCEEDED",FILE_PREVIEW_RENDER_FAILED:"FILE_PREVIEW_RENDER_FAILED"},e})}.call(this),function(){define("modules/clean/react/file_viewer/copyright_flag",["external/react","modules/clean/components/title_bubble","modules/constants/env","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s){var r,a,l,c,u,d;return l=o._,a=e.createFactory(t),d=e.DOM,c=d.a,u=d.div,r=e.createClass({displayName:"CopyrightFlag",getCopyrightHref:function(){return new s({scheme:"https",authority:n.WEBSERVER,path:"/copyright_complaint",query:{ssu:i.get_href()}})},render:function(){return u({className:"react-copyright-complaint-flag"},a({text:l("Flag for copyright"),direction:"east"},c({href:this.getCopyrightHref(),className:"flag-link",title:l("Flag for copyright"),rel:"nofollow"})))}})})}.call(this),function(){define("modules/clean/react/file_viewer/dispatcher",["modules/clean/flux/dispatcher"],function(e){return e})}.call(this),function(){define("modules/clean/react/file_viewer/file_actions",["external/react","modules/clean/react/file_viewer/copyright_flag","modules/clean/react/file_viewer/more_dropdown","modules/clean/react/file_viewer/open_button","modules/clean/react/sprite","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f;return p=r._,l=e.createFactory(t),u=e.createFactory(n),d=e.createFactory(i),f=e.DOM,h=f.a,_=f.button,m=f.div,c=e.createClass({displayName:"FileActions",propTypes:{file:e.PropTypes.object.isRequired,user:e.PropTypes.object,onCloseViewer:e.PropTypes.func},getDefaultProps:function(){return{user:null,onCloseViewer:null}},getInitialState:function(){return{tkey:this.props.file.tkey||null}},_handleDownloadClick:function(e){var t;return e.preventDefault(),t=a.parse(s.get_href()).updateQuery({dl:1}).toString(),s.redirect(t)},_handleNotificationClick:function(){throw new Error("Not implemented")},_handleAccountClick:function(){throw new Error("Not implemented")},_handleSignInClick:function(){throw new Error("Not implemented")},_handleCloseClick:function(){return this.props.onCloseViewer()},_renderDownloadMenu:function(){return _({className:"button-primary download-button",onClick:this._handleDownloadClick},p("Download"))},_renderNotificationMenu:function(){return _({className:"button-secondary notifications-button",onClick:this._handleNotificationClick},p("Notifications"))},_renderAccountMenu:function(){return _({className:"button-secondary account-button",onClick:this._handleAccountClick},this.props.user.display_name)},_renderSignIn:function(){return h({className:"sign-in-link",href:"/login"},p("Sign in"))},_renderClose:function(){return null!=this.props.onCloseViewer?h({className:"react-title-bar__close",title:p("Close"),onClick:this._handleCloseClick},o({group:"web",name:"xclose"})):void 0},render:function(){return m({className:"react-title-bar__controls .shared-link"},l(),null!=this.props.user?[this._renderDownloadMenu(),this._renderNotificationMenu(),this._renderAccountMenu(),this._renderClose()]:[this._renderDownloadMenu(),this._renderSignIn()])}})})}.call(this),function(){define("modules/clean/react/file_viewer/file_owner_actions",["external/react","modules/clean/react/file_viewer/more_dropdown","modules/clean/react/file_viewer/open_button","modules/clean/react/sprite","modules/core/i18n"],function(e,t,n,i,o){var s,r,a,l,c,u,d,p,h;return c=o._,r=e.createFactory(t),a=e.createFactory(n),l=e.createFactory(i),h=e.DOM,u=h.a,d=h.button,p=h.div,s=e.createClass({displayName:"FileOwnerActions",propTypes:{file:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,onCloseViewer:e.PropTypes.func.isRequired,shareHelpers:e.PropTypes.object},getDefaultProps:function(){return{shareHelpers:null}},getInitialState:function(){return{tkey:this.props.file.tkey||null}},componentDidMount:function(){return this._setupShare()},_setupShare:function(){var e;return null!=(e=this.props.shareHelpers)?e.fetchTkey(this.props.file.fq_path,this.props.user.id,function(e){
return function(t){return e.setState({tkey:t})}}(this)):void 0},_handleCloseClick:function(){return this.props.onCloseViewer()},_handleShareClick:function(){return this.props.shareHelpers.share(this.props.file.fq_path,this.props.user.id)},_removeShareLink:function(){return this.props.shareHelpers.removeShareLink(this.props.file.fq_path,this.state.tkey,this.props.user.id,function(e){return function(){return e.setState({tkey:null})}}(this))},render:function(){return p({className:"react-title-bar__controls"},null!=this.props.shareHelpers?d({className:"share-button button-primary",onClick:this._handleShareClick},c("Share")):void 0,a({file:this.props.file,user:this.props.user}),r({file:this.props.file,user:this.props.user,tkey:this.state.tkey,onRemoveShareLink:this._removeShareLink}),u({className:"react-title-bar__close",title:c("Close"),onClick:this._handleCloseClick},l({group:"web",name:"xclose",alt:c("Close")})))}})})}.call(this),function(){define("modules/clean/react/file_viewer/file_preview",["external/react","modules/constants/legacy","modules/constants/python","modules/clean/frame_messenger","modules/clean/loggers/file_preview_logger","modules/clean/loggers/file_viewer_logger","modules/clean/previews/util","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/utils","modules/clean/react/previews/audio/preview_audio","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_html","modules/clean/react/previews/preview_image","modules/clean/react/previews/preview_image_with_annotations","modules/clean/react/previews/preview_image_zoom","modules/clean/react/previews/preview_linkfile","modules/clean/react/previews/preview_pdf","modules/clean/react/previews/preview_password_protected","modules/clean/react/previews/preview_video","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y){var b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D,M;return w=n.FileViewModeType,E=r.PermissionHelper,k=r.PreviewHelper,b=a.EventTypes,S=l.PreloadHelpers,C=".react-file-viewer__preview iframe",T=e.createFactory(c),A=e.createFactory(u),I=e.createFactory(d),P=e.createFactory(p.PreviewImage),N=e.createFactory(h.PreviewImageWithAnnotations),R=e.createFactory(_.PreviewImageZoom),x=e.createFactory(m.PreviewLinkfile),O=e.createFactory(f),L=e.createFactory(v),D=e.createFactory(g.PreviewVideo),M=e.createClass({displayName:"FilePreview",propTypes:{file:e.PropTypes.shape({preview_type:e.PropTypes.string.isRequired}).isRequired,user:e.PropTypes.object,isFullscreen:e.PropTypes.bool,onCloseViewer:e.PropTypes.func,fileViewTarget:e.PropTypes.number.isRequired,fileViewOrigin:e.PropTypes.number.isRequired,fileViewAction:e.PropTypes.number.isRequired,areImagePreviewAnnotationsVisible:e.PropTypes.bool,shouldDisplayAnnotationsToolbar:e.PropTypes.bool,index:e.PropTypes.number,count:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func},getDefaultProps:function(){return{user:null,isFullscreen:!1}},getInitialState:function(){return{hasLoadError:!1}},componentWillReceiveProps:function(e){return this.setState({hasLoadError:!1}),this._logPreviewAttempted(e.file)},componentWillMount:function(){return this._startLogger(),this._logPreviewAttempted(this.props.file)},componentWillUnmount:function(){return this._stopLogger()},_startLogger:function(){return this._viewAttempts=0,this._frameMessenger=new i,this._frameMessenger.configureChildMessaging(C,this._onFrameMessage,["pagerendered"]),this._frameMessenger.startListening()},_stopLogger:function(){return this._frameMessenger.stopListening()},_onFrameMessage:function(e){switch(e.action){case"pagerendered":return s.logPageRendered(this.props.file,e.parameters)}},_logView:function(e){return null==e&&(e=!1),this._viewAttempts++,s.logView(this.props.file,this.props.user,this.props.fileViewTarget,this.props.fileViewOrigin,this.props.fileViewAction,this._viewAttempts,e)},_logPreviewAttempted:function(e){return o.logEvent(b.FILE_PREVIEW_ATTEMPT_STARTED,e)},_renderImagePreview:function(){var e,n,i,o;return this._logView(),e=this.props.file,n=k.get_extension(e),"gif"===n&&e.bytes<=t.MAX_GIF_FILE_SIZE_B&&(i=y.parse(e.href).updateQuery({raw:1}).toString()),this.props.isFullscreen?R({thumbnailUrlTmpl:e.thumbnail_url_tmpl,lastImageUrl:S.getSizedImageUrl(e.thumbnail_url_tmpl),fileExtension:n,isFlippable:!0}):(o={"thumbnail-url-tmpl":e.thumbnail_url_tmpl,"file-extension":k.get_extension(e),"file-meta":{filename:k.get_filename(e),mtime:e.ts,formattedSize:e.size},gifUrl:i,isFullscreen:this.props.isFullscreen,"should-display-annotations-toolbar":this.props.shouldDisplayAnnotationsToolbar,index:this.props.index,count:this.props.count,onPrevious:this.props.onPrevious,onNext:this.props.onNext,"log-time-to-interactive":!0},this.props.areImagePreviewAnnotationsVisible?N(o):P(o))},_renderVideoPreview:function(){var e;return this._logView(),e=this.props.file,D({"preview-url":e.video_transcode_url,"thumbnail-url-tmpl":e.thumbnail_url_tmpl,isFullscreen:this.props.isFullscreen,shouldDisplayAnnotationsToolbar:this.props.shouldDisplayAnnotationsToolbar,index:this.props.index,count:this.props.count,onPrevious:this.props.onPrevious,onNext:this.props.onNext,"log-time-to-interactive":!0})},_renderLinkfilePreview:function(){var e;return this._logView(),e=this.props.file,x({filename:k.get_filename(e),"linkfile-data-link":e.linkfile_link,"authenticated-data-link":!0,source:"browse","log-time-to-interactive":!0})},_renderPDFPreview:function(){var e,t,n,i;return e=this.props.file,t=k.get_extension(e),n=null!=e.direct_blockserver_link?e.direct_blockserver_link:e.href,k.isPreviewable(e)?O({fileExtension:t,fqPath:e.fq_path,isFullscreen:this.props.isFullscreen,onCloseViewer:this.props.onCloseViewer,onError:this._onLoadError,onLogView:this._logView,previewStatus:e.doc_preview_status,previewType:e.preview_type,src:n,userId:null!=(i=this.props.user)?i.id:void 0}):this._renderBlankPreview()},_renderHTMLPreview:function(){var e,n,i,o,s,r;if(this._logView(),e=this.props.file,n=k.get_extension(e),"excel"===e.preview_type){if(i=null!=e.direct_blockserver_link?e.direct_blockserver_link:e.href,o=k.normalize_extension(n),s=k.get_progressive_url(o,i),E.is_password_protected_preview_enabled()&&e.doc_preview_status===t.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC)return this._renderPasswordProtectedPreview(s,n)}else{if("keynote"===e.preview_type)return this._renderBlankPreview();s=null!=e.htmlified_link?e.htmlified_link:e.href}return r=k.usesFrameMessenger(e.preview_type),I({src:s,previewType:e.preview_type,isFullscreen:this.props.isFullscreen,onError:this._onLoadError,fileExtension:n,fileDocPreviewStatus:e.doc_preview_status,filePreviewType:e.preview_type,usesFrameMessenger:r})},_renderAudioPreview:function(){var e;return this._logView(),e=this.props.file,T({src:e.direct_blockserver_link,onError:this._onLoadError,"log-time-to-interactive":!0})},_renderBlankPreview:function(){var e;return this._logView(this.state.hasLoadError),e=this.props.file,A({filename:k.get_filename(e),icon:e.icon,size:e.size,created:new Date(1e3*e.ts),isFallbackForLoadError:this.state.hasLoadError})},_renderPasswordProtectedPreview:function(e,t){var n;return this._logView(),n=this.props.file,L({filename:k.get_filename(n),fileExtension:t,icon:n.icon,size:n.size,created:new Date(1e3*n.ts),fileUrl:e,previewType:n.preview_type})},_onLoadError:function(){return this.setState({hasLoadError:!0})},_choosePreview:function(){var e;switch(this.props.file.preview_type){case"photo":return this._renderImagePreview();case"video":return this._renderVideoPreview();case"linkfile":return this._renderLinkfilePreview();case"adobecs":case"doc":return e=k.get_extension(this.props.file),"indd"!==e||E.is_indesign_preview_enabled()?this._renderPDFPreview():this._renderBlankPreview();case"excel":case"html":case"keynote":case"text":return this._renderHTMLPreview();case"audio":return this._renderAudioPreview();default:return this._renderBlankPreview()}},render:function(){return this.state.hasLoadError?this._renderBlankPreview():this._choosePreview()}})})}.call(this),function(){define("modules/clean/react/file_viewer/file_preview_update_watcher",["modules/clean/notifications/file_watcher","modules/clean/notifications/updated_file_notification","modules/core/visibility"],function(e,t,n){var i;return i=function(){function i(e,t,n){this.file=e,this.user=t,this.refresh=n,this._watchFile()}return i.prototype.stop=function(){return this._hideUpdatedFileNotification(),this._unwatchFile()},i.prototype._watchFile=function(){return this._subscription=e.subscribe(this.file,this.user,this._onFileUpdate.bind(this))},i.prototype._unwatchFile=function(){var e;return null!=(e=this._subscription)&&e.cancel(),delete this._subscription},i.prototype._showUpdatedFileNotification=function(){return this._subscription?(this._hideUpdatedFileNotification(),this._notification=new t(this._onRefresh.bind(this))):void 0},i.prototype._hideUpdatedFileNotification=function(){var e;return null!=(e=this._notification)&&e.hide(),delete this._notification},i.prototype._onFileUpdate=function(){return n.when().then(this._showUpdatedFileNotification.bind(this))},i.prototype._onRefresh=function(){return this._subscription?(this._hideUpdatedFileNotification(),this.refresh(this._subscription.file)):void 0},i}()})}.call(this),function(){define("modules/clean/react/file_viewer/file_viewer",["external/keymaster","external/react","modules/clean/activity/activity","modules/clean/activity/file_activity_cache","modules/clean/comments/utils","modules/clean/comments/components/file_comments_pane_container","modules/clean/css","modules/clean/file_events","modules/clean/gandalf_util","modules/clean/history","modules/clean/image_preview_util","modules/clean/loggers/file_preview_logger","modules/clean/loggers/file_viewer_logger","modules/clean/previews/util","modules/clean/react/file_comments/file_feedback_ui","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/file_preview","modules/clean/react/file_viewer/file_preview_update_watcher","modules/clean/react/file_viewer/flippable_controls","modules/clean/react/file_viewer/store","modules/clean/react/file_viewer/title_bar","modules/clean/react/file_viewer/utils","modules/clean/react/previews/preview_quality_popup","modules/constants/python","modules/core/dom","modules/core/i18n","modules/core/notify","modules/core/uri","modules/core/visibility"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I,k){var P,N,R,x,O,L,D,M,F,U,B,V,H,q,W,j,G;return P=n.ActivityContext,U=h.PreviewHelper,x=_.FileFeedbackUIClass,N=f.EventTypes,L=C.FlippableHelpers,F=C.PreloadHelpers,B=E.PreviewQualityPopup,W=A._,j=t.DOM.div,R=t.createFactory(x),O=t.createFactory(y),V=t.createFactory(v),q=t.createFactory(w),D="fileviewer",M="",G="",H=t.createClass({displayName:"FileViewer",propTypes:{fileViewTarget:t.PropTypes.number.isRequired,fileViewOrigin:t.PropTypes.number.isRequired,fileViewAction:t.PropTypes.number.isRequired,disableRouting:t.PropTypes.bool,onCloseViewer:t.PropTypes.func,shareHelpers:t.PropTypes.object,activityContext:t.PropTypes.number.isRequired,hideComments:t.PropTypes.bool,oref:t.PropTypes.string,shouldFocusCommentInput:t.PropTypes.bool,sharedLinkInfo:t.PropTypes.shape({url:t.PropTypes.string.isRequired,ownerName:t.PropTypes.string,ownerTeamName:t.PropTypes.string})},getDefaultProps:function(){return{onCloseViewer:null,forceFileUnlocked:!1,shouldFocusCommentInput:!1,hideComments:!1,disableRouting:!1,oref:S.OREF_CONSTANTS.BROWSE_UNKNOWN}},getInitialState:function(){return this._getStateFromStore()},componentWillMount:function(){return this._removeStoreListener=b.addListener(this._onUpdateFromStore),this._logViewerOpened(),this._watchFile(this.state.currentFile),this._setPreviewUrl(this.state.currentFile),this._setupKeymaster(),this._preloadImages(this.state.files,this.state.currentIndex),this._setDocumentTitle(U.get_filename(this.state.currentFile),!0),T.scroll_lock_document(),this._enabledPreload=l.getGandalfRule("comments_preload"),this._enabledPreload&&(this._activityCache=new i),p.start()},componentWillUpdate:function(e,t){var n,i;return n=t.currentFile,this._watchFile(n),this._setPreviewUrl(n,i=!1),this._setDocumentTitle(U.get_filename(n)),this._preloadImages(t.files,t.currentIndex),key.setScope(D)},componentWillUnmount:function(){return this._removeStoreListener(),this._logViewerClosed(),this._unwatchFile(),this._unsetPreviewUrl(),this._cleanupKeymaster(),this._unsetDocumentTitle(),T.scroll_unlock_document()},_getStateFromStore:function(){return{files:b.files(),currentIndex:b.currentIndex(),currentFile:b.currentFile(),user:b.user(),isFullscreen:b.isFullscreen()}},_onUpdateFromStore:function(){return this.setState(this._getStateFromStore())},_getActivityContextData:function(){var e;switch(e=this.state.currentFile,this.props.activityContext){case P.BROWSE_FILE_VIEWER:return e.fq_path;case P.SHARED_LINK_VIEW:return this.props.sharedLinkInfo.url;default:return null}},_logViewerOpened:function(){return d.logEvent(N.FILE_VIEWER_OPENED)},_logViewerClosed:function(){return d.logEvent(N.FILE_VIEWER_CLOSED,this.state.currentFile)},_watchFile:function(e){return l.getGandalfRule("tap-to-refresh")?(this._unwatchFile(),this.watcher=new g(e,this.state.user,this._loadUpdatedFile)):void 0},_loadUpdatedFile:function(e){return this.watcher?m.replaceFile(e):void 0},_unwatchFile:function(){var e;return null!=(e=this.watcher)&&e.stop(),delete this.watcher},_setPreviewUrl:function(e,t){var n,i,o,s;return null==t&&(t=!0),this.props.disableRouting?void 0:(o=U.get_filename(e),n=k.parse(c.get_url()),i=k.encode_parts(n.getPath()),s=n.removeQuery("select").updateQuery({preview:o}).getQuery(),t?c.push_state(i,s,{immediatelyRestoreState:!1}):c.replace_state(i,s))},_unsetPreviewUrl:function(){var e,t,n;return this.props.disableRouting?void 0:(e=k.parse(c.get_url()),t=k.encode_parts(e.getPath()),n=e.removeQuery("select").removeQuery("preview").getQuery(),c.push_state(t,n,{immediatelyRestoreState:!1}))},_onNext:function(){return m.flipNext()},_onPrevious:function(){return m.flipPrevious()},_setupKeymaster:function(){return L.isFlippableFile(this.state.currentFile)&&(key("left",D,function(e){return function(){return e._onPrevious()}}(this)),key("right",D,function(e){return function(){return e._onNext()}}(this))),key("esc",D,function(e){return function(t){var n;return T.focus_in_input()||T.is_input(t.target)||document.querySelector(".annotation-bubble")?void 0:"function"==typeof(n=e.props).onCloseViewer?n.onCloseViewer():void 0}}(this)),M=key.getScope(),key.setScope(D)},_cleanupKeymaster:function(){return key.clearScope(D),key.setScope(M)},_preloadImages:function(e,t){var n,i,o,s,r,a,l;if(0!==e.length){for(r=[0,1,2,3,4,5,6,-1,-2],l=[],o=0,s=r.length;s>o;o++)n=r[o],i=t+n,l.push(i>=0&&i<e.length&&"photo"===(null!=(a=e[t])?a.preview_type:void 0)?F.preloadImage(e[i]):void 0);return l}},_setDocumentTitle:function(e,t){return null==t&&(t=!1),t&&(G=document.title),document.title=e},_unsetDocumentTitle:function(){return""!==G?document.title=G:void 0},_renderFlippableControls:function(){return L.isFlippableFile(this.state.currentFile)&&!this.state.isFullscreen?O({index:""+(this.state.currentIndex+1),numFlippableFiles:this.state.files.length,onNext:this._onNext,onPrevious:this._onPrevious}):void 0},_renderFilePreview:function(){var e,t;return t=l.getGandalfRule("dw-comments-annotation-image-previews"),e=l.getGandalfRule("dw-comments-annotation-image-previews")||l.getGandalfRule("comments-image-previews-annotations-visible"),j({className:"react-file-viewer__preview react-file-preview"},j({className:"flex-preview-container"},l.getGandalfRule("docpreview-quality-popup-enabled")?this._renderPreviewQualityPopup():void 0,V({file:this.state.currentFile,fileViewTarget:this.props.fileViewTarget,fileViewOrigin:this.props.fileViewOrigin,fileViewAction:this.props.fileViewAction,isFullscreen:this.state.isFullscreen,onCloseViewer:this.props.onCloseViewer,user:this.state.user,areImagePreviewAnnotationsVisible:e,shouldDisplayAnnotationsToolbar:t,index:this.state.currentIndex,count:this.state.files.length,onPrevious:this._onPrevious,onNext:this._onNext})),t?void 0:this._renderFlippableControls())},_renderComments:function(){var e,n,i,r,a,l;return e=this._getActivityContextData(),n=t.addons.classSet({"react-file-viewer__activity":!0,"comments-hidden":this.state.isCommentsHidden}),"photo"===this.state.currentFile.preview_type?(i=new u,r=".react-file-viewer__preview ."+i.PREVIEW_IMAGE_CONTAINER):r=".react-file-viewer__preview .flex-preview-container",j({className:n},o.isFluxEnabled(this.props.activityContext)?t.createElement(s,{actorId:null!=(a=this.state.user)?a.id:void 0,context:this.props.activityContext,contextData:e,currentFile:this.state.currentFile,previewSelector:r,shouldInitiallyFocusInput:this.props.shouldFocusCommentInput,visible:!this.props.hideComments,hideToggledCallback:this._handleToggleComments}):R({feedbackId:"file-comments",ref:"fileFeedback",activityCache:this._activityCache,activityContext:this.props.activityContext,activityContextData:e,file:this.state.currentFile,oref:this.props.oref,userId:null!=(l=this.state.user)?l.id:void 0,canCollapse:!0,enableImport:!1,previewSelector:r,shouldAutoLinkify:!0,shouldAutoResize:!0,shouldInitiallyFocusInput:this.props.shouldFocusCommentInput,shouldUseSimpleModals:!1,showButtonColor:"white",visible:!this.props.hideComments,hideToggledCallback:this._handleToggleComments}))},_renderTitleBar:function(){return j({className:"react-file-viewer__title-bar"},q({file:this.state.currentFile,user:this.state.user,onCloseViewer:this.props.onCloseViewer,shareHelpers:this.props.shareHelpers,sharedLinkInfo:this.props.sharedLinkInfo}))},_renderPreviewQualityPopup:function(){return null!=this.props.sharedLinkInfo||this.state.user.root_ns!==this.state.currentFile.ns_id?null:t.createElement(B,{showalways:l.getGandalfRule("docpreview-quality-popup-always"),file:this.state.currentFile})},render:function(){return this.state.isFullscreen?j({className:"react-file-viewer"},this._renderFilePreview()):j({className:"react-file-viewer"},this._renderTitleBar(),j({className:"react-file-viewer__content"},this._renderFilePreview(),this._renderComments()))}})})}.call(this),function(){define("modules/clean/react/file_viewer/flippable_controls",["external/react","modules/clean/react/sprite","modules/core/i18n"],function(e,t,n){var i,o,s,r,a;return a=e.DOM,s=a.button,r=a.div,o=n._,i=e.createClass({displayName:"FlippableControls",propTypes:{index:e.PropTypes.string.isRequired,numFlippableFiles:e.PropTypes.number.isRequired,onNext:e.PropTypes.func,onPrevious:e.PropTypes.func},_handlePreviousClick:function(){var e;return"function"==typeof(e=this.props).onPrevious?e.onPrevious():void 0},_handleNextClick:function(){var e;return"function"==typeof(e=this.props).onNext?e.onNext():void 0},render:function(){return this.props.numFlippableFiles>1?r({className:"react-file-viewer__controls"},s({onClick:this._handlePreviousClick,className:"nav-control"},t({group:"web",name:"s_flip_left",alt:o("Flip left",{comment:"Flip to the previous file in a series of files"})})),r({className:"nav-text"},o("%(cur_file_num)s of %(num_total_files)s").format({cur_file_num:this.props.index,num_total_files:this.props.numFlippableFiles})),s({onClick:this._handleNextClick,className:"nav-control"},t({group:"web",name:"s_flip_right",alt:o("Flip right",{comment:"Flip to the next file in a series of files"})}))):null}})})}.call(this),function(){define("modules/clean/react/file_viewer/full_screen_helpers",["jquery","modules/clean/react/file_viewer/actions"],function(e,t){var n;return n={setupFullscreen:function(t){return t&&(e(document).on("fullscreenchange.preview",this._setupExitFullscreenListeners),e(document).on("webkitfullscreenchange.preview",this._setupExitFullscreenListeners),e(document).on("msfullscreenchange.preview",this._setupExitFullscreenListeners),e(document).on("mozfullscreenchange.preview",this._setupExitFullscreenListeners)),this.setBrowserFullscreen(t)},_setupExitFullscreenListeners:function(){return e(document).off("fullscreenchange.preview"),e(document).off("webkitfullscreenchange.preview"),e(document).off("msfullscreenchange.preview"),e(document).off("mozfullscreenchange.preview"),e(document).on("fullscreenchange.preview",t.closeFullscreen.bind(t)),e(document).on("webkitfullscreenchange.preview",t.closeFullscreen.bind(t)),e(document).on("msfullscreenchange.preview",t.closeFullscreen.bind(t)),e(document).on("mozfullscreenchange.preview",t.closeFullscreen.bind(t))},teardownExitFullscreenListeners:function(){return e(document).off("fullscreenchange.preview"),e(document).off("webkitfullscreenchange.preview"),e(document).off("msfullscreenchange.preview"),e(document).off("mozfullscreenchange.preview")},setBrowserFullscreen:function(t){var n;if(n=e("body")[0],t){if(null!=n.requestFullscreen)return n.requestFullscreen();if(null!=n.msRequestFullscreen)return n.msRequestFullscreen();if(null!=n.mozRequestFullScreen)return n.mozRequestFullScreen();if(null!=n.webkitRequestFullscreen)return n.webkitRequestFullscreen()}else{if(document.exitFullscreen)return document.exitFullscreen();if(document.msExitFullscreen)return document.msExitFullscreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen()}}},{FullscreenHelpers:n}})}.call(this),function(){define("modules/clean/react/file_viewer/more_dropdown",["external/react","modules/clean/react/bubble_menu","modules/clean/previews/util","modules/clean/react/file_action_button","modules/clean/react/sprite","modules/clean/react/sprite_div","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_,m,f,v,g,y,b,w,C,E;return c=t.BubbleMenu,h=n.PreviewHelper,d=i.FileActionButtonType,u=i.FileActionButton,f=a._,_=e.createFactory(o),m=e.createFactory(s),C=e.DOM,v=C.a,g=C.button,b=C.div,w=C.li,E=C.ul,y=e.createElement,p=e.createClass({displayName:"MoreDropdown",propTypes:{file:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,onRemoveShareLink:e.PropTypes.func.isRequired,tkey:e.PropTypes.string},_handleDownloadClick:function(e){var t;return e.preventDefault(),t=l.parse(this.props.file.href).updateQuery({dl:1}).toString(),r.redirect(t)},_handleRemoveLinkClick:function(e){return e.preventDefault(),this.props.onRemoveShareLink()},_handlePreviousVersionClick:function(e){return e.preventDefault(),h.redirectToVersionHistory(this.props.file,this.props.user)},_renderDropdownTarget:function(){return g({className:"more-button button-secondary"},_({group:"web",name:"more",alt:f("More actions")}))},_renderRemoveShareLink:function(){return y(u,{type:d.REMOVE_LINK,callback:this._handleRemoveLinkClick})},_getDropdownItems:function(){var e;return e=[],null!=this.props.onRemoveShareLink&&null!=this.props.tkey&&e.push(this._renderRemoveShareLink()),e.push(y(u,{type:d.DOWNLOAD,callback:this._handleDownloadClick})),e.push(y(u,{type:d.PREVIOUS_VERSIONS,callback:this._handlePreviousVersionClick})),e},render:function(){return y(c,{targetButton:this._renderDropdownTarget(),arrow_position:"top-right",extra_css_class:"react-file-viewer-dropdown",vertical_displacement:4,items:this._getDropdownItems()})}})})}.call(this),function(){define("modules/clean/react/file_viewer/open_button",["external/modernizr","external/react","modules/clean/open_with","modules/clean/previews/util","modules/clean/react/bubble_dropdown","modules/clean/react/file_viewer/open_button_coachmark","modules/clean/react/file_viewer/utils","modules/clean/react/sprite","modules/clean/react/sprite_div","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d){var p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I;return f=i.PreviewHelper,m=r.OpenWithHelpers,v=r.TooltipHelpers,g=r.UnityHelpers,y=u._,T=t.DOM,b=T.a,w=T.button,E=T.div,S=T.li,A=T.span,I=T.ul,p=t.createFactory(o),_=t.createFactory(s),C=t.addons.classSet,h=t.createClass({displayName:"OpenButton",propTypes:{file:t.PropTypes.object.isRequired,user:t.PropTypes.object.isRequired},getInitialState:function(){return{coachmarkHidden:!1,unityInfo:null}},componentDidMount:function(){return g.isUnityEnabled()?this._setupUnity():void 0},componentDidUpdate:function(){var e;return null!=(e=this.refs.dropdown)?e.show():void 0},_hideCoachmark:function(){return this.setState({coachmarkHidden:!0})},_setupUnity:function(){return g.getUnityFileInfo(this.props.file.ns_id,this.props.file.ns_path,this.props.user.id,function(e){return function(t){return e.isMounted()?e.setState({unityInfo:t}):void 0}}(this),function(e){return function(){return e.isMounted()?e.setState({unityInfo:{can_open_directly:!1,is_locally_available:!1}}):void 0}}(this)),window.setTimeout(function(e){return function(){return null===e.state.unityInfo&&e.isMounted()?e.setState({unityInfo:{can_open_directly:!1,is_locally_available:!1}}):void 0}}(this),1e4)},_hasUnityFolderSupport:function(){return null!=this.state.unityInfo&&this.state.unityInfo.is_locally_available&&g.clientSupportsOpenInFileBrowser()},_hasUnityFileSupport:function(){return null!=this.state.unityInfo&&this.state.unityInfo.can_open_directly!==!1},_hasOpenWithSupport:function(){return m.canOpenWith(this.props.file,this.props.user)},_getNumEnabled:function(){return(this._hasOpenWithSupport()?1:0)+(this._hasUnityFileSupport()?1:0)+(this._hasUnityFolderSupport()?1:0)},_isDropdownDisabled:function(){return this._getNumEnabled()<2},_isButtonDisabled:function(){return null===this.state.unityInfo},_getFileBrowserLabel:function(){var e,t;return e=(null!=(t=this.state.unityInfo)?t.file_browser_display_name:void 0)||y("File Browser"),y("Show in %(file_browser)s").format({file_browser:e})},_getNativeAppLabel:function(){var e,t;return e=(null!=(t=this.state.unityInfo)?t.open_application_name:void 0)||y("Desktop"),y("Open in %(app_name)s").format({app_name:e})},_onClickAnyOpenButtonType:function(){return this._hideCoachmark()},_handleUnityFileClick:function(e){var t;return this._onClickAnyOpenButtonType(),t=this.props.file,g.openFile(t.ns_id,t.ns_path,this.props.user.id),null!=e?e.preventDefault():void 0},_handleUnityFolderClick:function(e){var t;return this._onClickAnyOpenButtonType(),t=this.props.file,g.openFile(t.ns_id,t.ns_path,this.props.user.id,!0),null!=e?e.preventDefault():void 0},_handleOpenWithClick:function(e){return this._onClickAnyOpenButtonType(),m.openWith(this.props.file,this.props.user),null!=e?e.preventDefault():void 0},_handleDownloadClick:function(e){var t;return this._onClickAnyOpenButtonType(),t=d.parse(this.props.file.href).updateQuery({dl:1}).toString(),c.redirect(t),null!=e?e.preventDefault():void 0},_renderCoachmark:function(e,t){return E({className:"c-coach-mark__container"},e,this.state.coachmarkHidden?void 0:_({file:this.props.file,user:this.props.user,inDropdown:t}))},_renderMainButton:function(){var e,t,i,o;return e=C({"button-secondary":!0,"split-button":!this._isDropdownDisabled(),disabled:this._isButtonDisabled()}),this._hasUnityFileSupport()?(i=w({ref:"openButton",className:e,onClick:this._handleUnityFileClick},y("Open")),n.is_adobe_app(null!=(o=this.state.unityInfo)?o.open_application_identifier:void 0)?this._renderCoachmark(i,!1):i):this._hasUnityFolderSupport()?w({ref:"openButton",className:e,onClick:this._handleUnityFolderClick},y("Open")):this._hasOpenWithSupport()&&!this._isButtonDisabled()?(t=w({ref:"openButton",className:e,onClick:this._handleOpenWithClick},y("Open")),this._renderCoachmark(t,!1)):this._isButtonDisabled()?w({ref:"openButton",className:e},""):w({ref:"openButton",className:e,onClick:this._handleDownloadClick},y("Download"))},_renderSplitButton:function(){var e,t,n;return t=m.getOpenWithHandlerData(this.props.file,this.props.user),n=w({className:"button-secondary split-dropdown"},a({group:"web",name:"arrow-down-blue",alt:y("More options")})),e=p({targetButton:n,arrow_position:"top-right",extra_css_class:"react-file-viewer-dropdown",vertical_displacement:4,bubbleDropdownShown:this._hideCoachmark},I({className:"dropdown-contents"},this._hasUnityFileSupport()?S({},b({href:"#",onClick:this._handleUnityFileClick},l({group:"web",name:"ow_desktop",text:this._getNativeAppLabel()}))):void 0,this._hasOpenWithSupport()?S({},b({href:"#",onClick:this._handleOpenWithClick},l({group:"web",name:null!=t?t.icon:void 0,text:null!=t?t.name:void 0}))):void 0,this._hasUnityFolderSupport()?S({},b({href:"#",onClick:this._handleUnityFolderClick},l({group:"web",name:"ow_folder",text:this._getFileBrowserLabel()}))):void 0)),this._renderCoachmark(e,!0)},render:function(){return E({className:"split-button-wrap"},this._renderMainButton(),this._isDropdownDisabled()?void 0:this._renderSplitButton())}})})}.call(this),function(){define("modules/clean/react/file_viewer/open_button_coachmark",["external/react","modules/clean/previews/util","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/coach_mark","modules/clean/react/file_viewer/utils","modules/clean/react/react_i18n","modules/clean/static_urls","modules/core/i18n"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m;return u=t.PreviewHelper,p=o.TooltipHelpers,_=r.static_url,h=a._,m=e.DOM.strong,d=s.R_,l=e.createFactory(i),c=e.createClass({displayName:"OpenButtonCoachmark",propTypes:{file:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,inDropdown:e.PropTypes.string.isRequired},getInitialState:function(){return{vendor:null,application:null}},setCoachmarkConfig:function(e,t){return this.setState({vendor:e,application:t})},clearCoachmarkConfig:function(){return this.setCoachmarkConfig(null,null)},onReceiveTooltipInfo:function(e){var t,n,i,o;return n=u.get_extension(this.props.file),i=p.getVendorAndApplication(e,n),null!==i?(o=i.vendor,t=i.application,this.setCoachmarkConfig(o,t)):void 0},componentDidMount:function(){return p.fetchTooltipInfo(this.props.user.id,this.onReceiveTooltipInfo)},hasCoachmark:function(){return this.state.vendor&&this.state.application},dismissCoachmark:function(){return this.clearCoachmarkConfig()},onCoachmarkShown:function(){var e;return e=u.get_extension(this.props.file),p.logImpression(e,this.props.user.id,this.state.application)},onCoachmarkButtonClick:function(){return this.dismissCoachmark()},_renderCoachmark:function(e){var t,n,i,o,s,r;return r=e.title,i=e.imageUrl,o=e.imageUrl2x,n=e.imageAlt,s=e.openButtonBody,t=e.dropdownBody,l({title:r,imageUrl:i,imageUrl2x:o,imageAlt:n,buttonText:h("Got it."),onButtonClick:this.onCoachmarkButtonClick,onShown:this.onCoachmarkShown},this.props.inDropdown?t:s)},_renderMsftWord:function(){return this._renderCoachmark({title:"Edit shared docs together",imageUrl:_("/static/images/file_viewer/coach_mark_docx-vflGsxySJ.png"),imageUrl2x:_("/static/images/file_viewer/coach_mark_docx@2x-vflJZIQKs.png"),imageAlt:h("An illustration of a Word file"),buttonText:"Got it.",openButtonBody:d({},"Click <strong>open</strong> to edit together in Microsoft Word Online."),dropdownBody:d({},"Choose <strong>Microsoft Word Online</strong> to edit together.")})},_renderMsftExcel:function(){return this._renderCoachmark({title:"Edit shared spreadsheets together",imageUrl:_("/static/images/file_viewer/coach_mark_xlsx-vflaEwaN7.png"),imageUrl2x:_("/static/images/file_viewer/coach_mark_xlsx@2x-vflkU3Ma1.png"),imageAlt:h("An illustration of an Excel file"),openButtonBody:d({},"Click <strong>open</strong> to edit together in Microsoft Excel Online."),dropdownBody:d({},"Choose <strong>Microsoft Excel Online</strong> to edit together.")})},_renderMsftPowerpoint:function(){return this._renderCoachmark({title:"Edit shared presentations together",imageUrl:_("/static/images/file_viewer/coach_mark_pptx-vfltjppV8.png"),imageUrl2x:_("/static/images/file_viewer/coach_mark_pptx@2x-vflpvn3tE.png"),imageAlt:h("An illustration of a Powerpoint file"),openButtonBody:d({},"Click <strong>open</strong> to edit together in Microsoft PowerPoint Online."),dropdownBody:d({},"Choose <strong>Microsoft PowerPoint Online</strong> to edit together.")
})},_renderAdobeAcrobatOrReader:function(){return this._renderCoachmark({title:"Want to edit this PDF?",imageUrl:_("/static/images/file_viewer/coach_mark_pdf-vflIMdX1a.png"),imageUrl2x:_("/static/images/file_viewer/coach_mark_pdf@2x-vflUkcAgn.png"),imageAlt:h("An illustration of a PDF file"),openButtonBody:d({},"You’re looking at a preview. To open this file for editing, click <strong>Open</strong>."),dropdownBody:h("You’re looking at a preview. To open this file for editing, click here.")})},render:function(){if(this.hasCoachmark&&Modernizr.flexbox)switch(this.state.vendor){case"msft":switch(this.state.application){case"word":return this._renderMsftWord();case"excel":return this._renderMsftExcel();case"powerpoint":return this._renderMsftPowerpoint()}break;case"adbe":switch(this.state.application){case"acrobat_or_reader":return this._renderAdobeAcrobatOrReader()}}return null}})})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/react/file_viewer/store",["external/underscore","modules/clean/flux/flux_store","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/dispatcher","modules/clean/react/file_viewer/utils"],function(t,n,i,o,s){var r,a,l;return r=i.ActionTypes,l=s.FlippableHelpers,new(a=function(n){function i(e){i.__super__.constructor.call(this,e),this._files=[],this._currentIndex=0,this._user=null,this._isFullscreen=!1,this._cachedLatestRevision=null}return e(i,n),i.prototype.files=function(){return this._files},i.prototype.currentIndex=function(){return this._currentIndex},i.prototype.user=function(){return this._user},i.prototype.isFullscreen=function(){return this._isFullscreen},i.prototype.currentFile=function(){return this._files[this._currentIndex]},i.prototype.isViewingLatestRevision=function(){return!this._cachedLatestRevision},i.prototype._setup=function(e){var t,n,i;return n=e.files,t=e.currentIndex,i=e.user,this._user=i,this._updateFiles(n,n[t])},i.prototype._updateFiles=function(e,t){return l.isFlippableFile(t)?(this._files=l.filterFlippableFiles(e),this._currentIndex=this._getFileIndex(this._files,t),-1===this._currentIndex&&(this._files=[t],this._currentIndex=0)):(this._files=[t],this._currentIndex=0),this.__emitChange()},i.prototype._replaceFile=function(e){var n;return n=t.findIndex(this._files,function(t){return t.fq_path===e.fq_path}),null!=n?n===this._currentIndex&&this._cachedLatestRevision?this._cachedLatestRevision=e:(this._files[n]=e,this.__emitChange()):void 0},i.prototype._cleanup=function(){return this._files=[],this._currentIndex=0,this._user=null,this._isFullscreen=!1,this._cachedLatestRevision=null},i.prototype._nextFile=function(){return this._restoreRevision(),this._currentIndex=this._currentIndex===this._files.length-1?0:this._currentIndex+1,this.__emitChange()},i.prototype._previousFile=function(){return this._restoreRevision(),this._currentIndex=0===this._currentIndex?this._files.length-1:this._currentIndex-1,this.__emitChange()},i.prototype._setIsFullscreen=function(e){return this._isFullscreen=e,this.__emitChange()},i.prototype._switchRevision=function(e){return this._cachedLatestRevision||(this._cachedLatestRevision=this._files[this._currentIndex]),e.fq_path===this._cachedLatestRevision.fq_path&&e.sjid===this._cachedLatestRevision.sjid?this._restoreRevision():(this._files[this._currentIndex]=e,this.__emitChange())},i.prototype._restoreRevision=function(){return this._cachedLatestRevision?(this._files[this._currentIndex]=this._cachedLatestRevision,this._cachedLatestRevision=null,this.__emitChange()):void 0},i.prototype._getFileIndex=function(e,t){var n,i,o,s;for(i=o=0,s=e.length;s>o;i=++o)if(n=e[i],t.sjid===n.sjid)return i;return-1},i.prototype.__onDispatch=function(e){switch(e.action.type){case r.SETUP:return this._setup(e.action.data);case r.CLEANUP:return this._cleanup();case r.UPDATE_FILES:return this._updateFiles(e.action.data.files,this.currentFile());case r.REPLACE_FILE:return this._replaceFile(e.action.data.file);case r.FLIP_NEXT:return this._nextFile();case r.FLIP_PREVIOUS:return this._previousFile();case r.OPEN_FULLSCREEN:return this._setIsFullscreen(!0);case r.CLOSE_FULLSCREEN:return this._setIsFullscreen(!1);case r.SWITCH_REVISION:return this._switchRevision(e.action.data.file);case r.RESTORE_REVISION:return this._restoreRevision()}},i}(n))(o)})}.call(this),function(){define("modules/clean/react/file_viewer/title_bar",["external/react","modules/constants/env","modules/clean/em_string","modules/clean/filepath","modules/clean/previews/util","modules/clean/react/file_viewer/file_actions","modules/clean/react/file_viewer/file_owner_actions","modules/clean/react/sprite","modules/clean/react/image","modules/clean/components/title_bubble","modules/clean/static_urls","modules/core/i18n"],function(e,t,n,i,o,s,r,a,l,c,u,d){var p,h,_,m,f,v,g,y,b,w,C,E,S,T,A;return m=o.PreviewHelper,A=u.static_url,y=d._,S=e.DOM,b=S.a,C=S.div,E=S.h1,T=S.span,w=S.br,p=e.createFactory(s),h=e.createFactory(r),f=e.createFactory(a),g=e.createFactory(c),_=35,v=e.createClass({displayName:"TitleBar",propTypes:{file:e.PropTypes.object.isRequired,user:e.PropTypes.object,onCloseViewer:e.PropTypes.func,shareHelpers:e.PropTypes.object,sharedLinkInfo:e.PropTypes.object},getDefaultProps:function(){return{user:null,onCloseViewer:null,shareHelpers:null,sharedLinkInfo:null}},_isFileOwner:function(){return null==this.props.sharedLinkInfo},_redirectToVersionHistory:function(){return m.redirectToVersionHistory(this.props.file,this.props.user)},_renderIcon:function(){return this._isFileOwner()?this._renderFileIcon():this._renderLogo()},_renderFileIcon:function(){var e,t;return e=m.get_filename(this.props.file),t=i.file_icon(e)+"_32",f({group:"web",name:t,className:"file-icon title-bar-icon",alt:""})},_renderLogo:function(){return b({href:"//"+t.WEBSERVER+"?src=shmodel",className:"title-bar-icon"},l({alt:"Dropbox",src:A("/static/images/header/header_logo_shmodel-vflsZ7QsE.png"),srcHiRes:A("/static/images/header/header_logo_shmodel@2x-vflvJX68X.png")}))},_renderFilename:function(){return E({className:"filename"},n.em_snippet(m.get_filename(this.props.file),_))},_renderSharedFileOwner:function(){var e,t,n;return null==this.props.sharedLinkInfo||(n=this.props.sharedLinkInfo,e=n.ownerName,t=n.ownerTeamName,null==e||null==t||this._isFileOwner())?null:T({className:"file-owner"},y(" from %(owner)s (%(team)s)").format({owner:e,team:t}))},_renderLastModifier:function(){var e,t,n,i,o;return t=this.props.file,n=t.last_modified_name,e=2,this.props.sharedLinkInfo||null==t.ts?null:(i=t.event_type===e?n?y("%(modifier)s edited ",{comment:"Like 'John Smith edited just now'"}).format({modifier:n}):y("You edited ",{comment:"Like 'You edited just now'"}):y("Modified ",{comment:"Like 'Modified just now"}),o=m.getModifierString(t),T({className:"file-modifier"},i,new g({direction:"south",text:y("View file history")},b({className:"file-modifier",onClick:this._redirectToVersionHistory,href:"#"},o))))},_renderFileActions:function(){return this._isFileOwner()?h({file:this.props.file,user:this.props.user,onCloseViewer:this.props.onCloseViewer,shareHelpers:this.props.shareHelpers}):p({file:this.props.file,user:this.props.user,onCloseViewer:this.props.onCloseViewer})},render:function(){var t;return t=e.addons.classSet({"react-title-bar__fileinfo-wrap":!0,"react-title-bar__fileinfo-wrap--shared-link":null!=this.props.sharedLinkInfo}),C({className:"react-title-bar"},C({className:t},this._renderIcon(),C({className:"fileinfo"},this._renderFilename(),this._renderLastModifier(),this._renderSharedFileOwner())),this._renderFileActions())}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/file_viewer/utils",["jquery","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/image_cache","modules/clean/image_size","modules/clean/open_with","modules/clean/unity/check_file_cache","modules/clean/unity/features","modules/constants/legacy","modules/core/browser","modules/core/uri"],function(t,n,i,o,s,r,a,l,c,u,d){var p,h,_,m,f,v,g,y;return y=s.image_best_fit_size,g=new o,p=["photo","video"],h={isFlippableFile:function(t){var n;return n=t.preview_type,e.call(p,n)>=0},filterFlippableFiles:function(e){var t;return Array.isArray(e)?function(){var n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],this.isFlippableFile(t)&&o.push(t);return o}.call(this):[]}},_={canOpenWith:function(e,t){return i.getGandalfRule("wopi-button-visible")&&e.doc_preview_status!==c.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC&&e.bytes<=r.MAX_SUPPORTED_FILE_SIZE_B&&null!==r.get_open_handler_for(e,t)},getOpenWithHandlerData:function(e,t){return r.get_open_handler_for(e,t)},openWith:function(e,t){var n,i;return n=this.getOpenWithHandlerData(e,t),i=n.uri+"?hpt_click_ts="+Date.now(),u.redirect(i)}},m={getSizedImageUrl:function(e,n){return null==n&&(n=!1),n?d.parse(e).updateQuery({size_mode:5}).toString():d.parse(e).updateQuery({size:y(t(window).width(),t(window).height()),size_mode:3}).toString()},preloadImage:function(e,t){return g.preload_image(this.getSizedImageUrl(e.thumbnail_url_tmpl,t))}},f={fetchTooltipInfo:function(e,t){var i;return i=n.AuthenticatedRequest({url:"/ow/get_available_tooltips",dataType:"json",success:function(e){return t(e)},subject_user:e})},getVendorAndApplication:function(t,n){var i,o,s,r,a;for(r in t){a=t[r];for(s in a)if(i=a[s],o=i.extensions,e.call(o,n)>=0)return{vendor:r,application:s}}return null},logImpression:function(e,t,i){return n.SilentBackgroundRequest("acrobat_or_reader"===i?{url:"/ow/log_adobe_tooltip_impression",data:{app_name:i,extension:e},subject_user:t}:{url:"/ow/msft/log_tooltip_impression",data:{app_type:i,extension:e},subject_user:t})}},v={isUnityEnabled:function(){return null!=l&&i.getGandalfRule("unity-test")},isFileInUnityCache:function(e,t){return!!a.is_cached_and_locally_available(e,t)},clientSupportsOpenInFileBrowser:function(){return l.client_supports_open_in_file_browser()},getFileInfoFromUnityCache:function(e,t){return a.get(e,t)},_fetchFileBrowserDisplayName:function(e,t){var n,i;return i=function(n){return e.file_browser_display_name=n,t(e)},n=function(){return t(e)},l.file_browser_display_name(i,n)},fetchUnityFileInfo:function(e,t,n,i,o){var s;return s=function(e){return function(t){return t.is_locally_available?e._fetchFileBrowserDisplayName(t,i):i(t)}}(this),l.check_file(e,t,n,s,o)},getUnityFileInfo:function(e,t,n,i,o){var s;return this.isFileInUnityCache(e,t)?(s=this.getFileInfoFromUnityCache(e,t),s.is_locally_available&&null==s.file_browser_display_name?this._fetchFileBrowserDisplayName(s,i):i(s)):this.fetchUnityFileInfo(e,t,n,i,o)},openFile:function(e,t,n,i){return l.open_file(e,t,n,l.standard_open_file_handler,function(){return l.standard_open_file_handler(!1)},i)}},{FlippableHelpers:h,OpenWithHelpers:_,PreloadHelpers:m,TooltipHelpers:f,UnityHelpers:v}})}.call(this),function(){define("modules/clean/react/form_handlers_mixin",["modules/clean/form","modules/core/notify","jquery"],function(e,t,n){var i;return i={handleFormSubmit:function(t){return t.preventDefault(),!this.isMounted()||this.isFormSubmitting()||null!=this.formShouldSubmit&&!this.formShouldSubmit(t)?void 0:("function"==typeof this.formWillSubmit&&this.formWillSubmit(t),this.setState({__formHandlers_isSubmitting:!0}),this.clearFormErrors(),e.submit(n(t.target),this.__onFormSuccess,this.__onFormError,this.__onFormComplete))},isFormSubmitting:function(){return this.state.__formHandlers_isSubmitting},getFormError:function(e){var t;return null!=(t=this.state.__formHandlers_errors)?t[e]:void 0},clearFormErrors:function(){return this.isMounted()?this.setState({__formHandlers_errors:{}}):void 0},getInitialState:function(){return{__formHandlers_isSubmitting:!1,__formHandlers_errors:{}}},__onFormSuccess:function(e){var n,i;try{return"function"==typeof this.handleFormSuccess?this.handleFormSuccess(JSON.parse(e)):void 0}catch(e){return n=e,t.error(),"function"==typeof this.handleFormError?this.handleFormError(t.DEFAULT_ERROR):void 0}},__onFormError:function(e){return"string"==typeof e?t.error(e):this.isMounted()&&this.setState({__formHandlers_errors:e}),"function"==typeof this.handleFormError?this.handleFormError(e):void 0},__onFormComplete:function(){return this.isMounted()&&this.setState({__formHandlers_isSubmitting:!1}),"function"==typeof this.handleFormComplete?this.handleFormComplete():void 0}}})}.call(this),function(){define("modules/clean/react/helpers",["external/underscore"],function(e){var t;return t=function(e,t){var n,i,o,s,r,a,l,c,u,d,p;if(e===t)return!0;if(r=Object.keys(e),a=Object.keys(t),r.length!==a.length)return!1;for(i=0,c=r.length;c>i;i++)if(l=r[i],d=e[l],p=t[l],Array.isArray(d)&&Array.isArray(p)){if(d.length!==p.length)return!1;for(o=s=0,u=d.length;u>s;o=++s)if(n=d[o],d[o]!==p[o])return!1}else if(d!==p)return!1;return!0},{compareStateAndProps:function(t,n){return e.isEqual(this.state,n)&&e.isEqual(this.props,t)?!1:!0},shallowCompareStateAndProps:function(e,n){return t(this.state,n)&&t(this.props,e)?!1:!0}}})}.call(this),function(){define("modules/clean/react/hidden",["external/react","external/underscore"],function(e,t){var n,i,o,s;return s=e.DOM,o=e.createElement,n=e.createClass({displayName:"Hidden",render:function(){return s.div({hidden:!0,style:{display:"none"}},this.props.children)}}),i=e.createClass({displayName:"HiddenSelect",propTypes:{options:e.PropTypes.arrayOf(e.PropTypes.any).isRequired,value:e.PropTypes.any},render:function(){var e;return o(n,{},s.select(t.omit(this.props,"options"),function(){var t,n,i,o;for(i=this.props.options,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(s.option({key:e,label:e,value:e}));return o}.call(this)))}}),{Hidden:n,HiddenSelect:i}})}.call(this),function(){define("modules/clean/react/hierarchical_nav_bar",["external/react","modules/core/i18n","modules/clean/react/sprite"],function(e,t,n){var i,o,s,r,a,l,c;return l=e.DOM,a=t._,c=function(e){var t;return null==e&&(e=[]),"string"==typeof e&&(e=[e]),e=function(){var n,i,o;for(o=[],n=0,i=e.length;i>n;n++)t=e[n],null!=t&&o.push(t);return o}()},i=function(e,t,n){var i,o,s;return e=c(e),t=c(t),n=c(n),i=e.join("__"),s=t.join("__"),o=i,""!==s&&(o+="__"+s),n=n.map(function(e){return o+"--"+e}).join(" "),o+" "+n},r=i.bind(null,"hierarchical-nav-bar"),o=e.createClass({propTypes:{"nav-items":e.PropTypes.array,id:e.PropTypes.string,shouldRenderHeader:e.PropTypes.bool},getDefaultProps:function(){return{"nav-items":[],shouldRenderHeader:!0}},hasIcons:function(e){var t,n,i;for(t=0,i=e.length;i>t;t++){if(n=e[t],null!=n.icon)return!0;if(null!=n.children&&this.hasIcons(n.children))return!0}return!1},renderHeader:function(){var e;return e=l.img({src:"/static/images/icons/blue_dropbox_glyph-vflOJKOUw.png",alt:a("Dropbox home")}),l.a({href:"/",id:"home-icon",className:r("home-icon")},e)},renderNavItems:function(){var t,n;return n=this.props["nav-items"],l.ul({className:r("nav",["root",this.hasIcons(n)?void 0:"no-icon"])},function(){var i,o,r;for(r=[],i=0,o=n.length;o>i;i++)t=n[i],r.push(e.createElement(s,{item:t}));return r}())},render:function(){return l.div({className:r()},[this.props.shouldRenderHeader?this.renderHeader():void 0,this.renderNavItems()])}}),s=e.createClass({propTypes:{item:e.PropTypes.object,depth:e.PropTypes.number},getDefaultProps:function(){return{item:{href:"#",label:"",selected:!1,children:[]},depth:1}},getItemIcon:function(){var t;return t=this.props.item.icon,null!=t?e.createElement(n,t):null},getIconLabel:function(){return l.span({className:r("nav-item-label")},this.props.item.label)},renderItemLink:function(){var e,t,n;return t=this.props.item.href,n=this.props.item.key+"_link",e=r("nav-item-link"),l.a({href:t,id:n,className:e},[this.getItemIcon(),this.getIconLabel()])},renderChildItems:function(t){var n,i,o,a,c,u;for(a=[],i=this.props.depth+1,c=0,u=t.length;u>c;c++)n=t[c],o=e.createElement(s,{item:n,depth:i}),a.push(o);return l.ul({className:r("nav")},a)},render:function(){var e,t,n;return t=this.props.item.children,(null!=t?t.length:void 0)&&(e=this.renderChildItems(t)),n=["level-"+this.props.depth,null==this.props.item.icon?"no-icon":void 0,this.props.item.selected?"selected":void 0],l.li({className:r("nav-item",n)},[this.renderItemLink(),e])}}),{HierarchicalNavBar:o}})}.call(this),function(){define("modules/clean/react/image",["external/react","external/underscore","modules/core/exception"],function(e,t,n){var i,o,s,r;return o=n.assert,s=e.DOM,r=function(e){return-1!==e.indexOf("-vfl")},i=e.createClass({displayName:"Image",propTypes:{alt:e.PropTypes.string,src:e.PropTypes.string.isRequired,srcHiRes:e.PropTypes.string.isRequired,onLoad:e.PropTypes.func,className:e.PropTypes.string,id:e.PropTypes.string},getDefaultProps:function(){return{alt:""}},render:function(){var e;return o(r(this.props.src),"Non-VFL path: "+this.props.src),o(r(this.props.srcHiRes),"Non-VFL path: "+this.props.srcHiRes),e={src:this.props.src,srcSet:this.props.srcHiRes+" 2x",alt:this.props.alt,id:this.props.id,className:this.props.className,onLoad:this.props.onLoad},t.extend(e,t.pick(this.props,function(e,t){return t.match(/^(aria|data)-/)})),s.img(e)}})})}.call(this),function(){define("modules/clean/react/invite/invite_form_react",["external/react","modules/core/browser","modules/core/html","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/ajax","modules/clean/analytics","modules/clean/contacts/tokenizer","modules/clean/react/button","modules/clean/react/image","modules/clean/react/input","modules/clean/react/invite/licenses_info","modules/clean/static_urls","modules/clean/viewer"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_){var m,f,v,g,y,b,w,C,E,S,T;return g=i._,T=i.ungettext,v=a.TeamsWebActionsLogger,m=l.ContactsTokenizer,y=c.button,S=d.textarea,E=h.static_url,w=e.addons.classSet,b=e.createElement,C=e.DOM,f=e.createClass({propTypes:{"user-id":e.PropTypes.number,"team-id":e.PropTypes.number,"allow-add-licenses":e.PropTypes.bool,"is-trial":e.PropTypes.bool,"inline-buy-disabled":e.PropTypes.bool,"available-licenses":e.PropTypes.number,"exp-skip-button-is-link":e.PropTypes.bool},getDefaultProps:function(){return{"exp-skip-button-is-link":!1}},getInitialState:function(){return{invites:[],customMessage:"",isLoading:!1,errors:{}}},_getUser:function(){var e,t;return t=_.get_viewer(),e=this.props["user-id"],null!=e?t.get_user_by_id(e):t.work_user},_onCustomMessageChange:function(e){this.setState({customMessage:e.target.value})},_onSubmitButtonClick:function(e){e.preventDefault(),this._submit()},_onSkipButtonClick:function(e){e.preventDefault(),this._skip()},_skip:function(){var e;v.log("setup_skip_add_members",{team_id:this.props["team-id"]}),e=s({path:"/team/admin/members"}).updateQuery({skipped_invite:1}),t.redirect(e.toString())},_submit:function(){var e,i;this.setState({isLoading:!0}),e=function(e){return function(t){var i;if(e.setState({isLoading:!1}),null!=(null!=t?t.responseText:void 0))if(t=t.responseText,0===t.indexOf("err:")){if(i=t.substr(4),0===i.indexOf("{"))return void e.setState({errors:JSON.parse(i)});o.error(new n(i))}else o.error();else o.error()}}(this),i=function(n){return function(i){var r,a,l;if(n.setState({errors:{}}),null!=i)try{return i=JSON.parse(i),o.success(g("Invites successfully sent.")),v.log("setup_add_members",{new_user_count:i.num_invited,team_id:n.props["team-id"]}),l=s({path:"/team/admin",query:{invited_team:1}}),t.redirect(l.toString())}catch(t){return r=t,e()}}}(this),r.WebRequest({url:"/account/team/add_users",data:{emails:this.refs.tokenizer.getContacts().map(function(e){return e.email}),custom_message:this.state.customMessage,team_id:this.props["team-id"]},subject_user:this._getUser(),success:i,error:e})},_renderLicensesInfo:function(){var e,t;return e=this.props["available-licenses"]-this.state.invites.length,t=this.props["allow-add-licenses"]&&!this.props["inline-buy-disabled"],t=!1,b(p,{className:"team-invite-form__licenses-info",availableLicenses:e,showAddLicenses:t,isTrial:this.props["is-trial"]})},_renderContactsTokenizer:function(e){var t;return[null!=(null!=(t=this.state.errors)?t.emails:void 0)?C.span({className:"error-message"},this.state.errors.emails):void 0,b(m,{ref:"tokenizer",customClass:"team-invite-form__tokenizer",user:e,showContactImport:!0,tabIndex:1,placeholder:g("Enter email address"),onContentsChange:function(e){return function(t){return e.setState({invites:t})}}(this)})]},_renderCustomMessageField:function(){return b(S,{name:"custom_message",className:"team-invite-form__custom-message",value:this.state.customMessage,placeholder:g("Add an optional message"),"error-after":!0,tabIndex:2,onChange:this._onCustomMessageChange})},_renderFormButtons:function(e){var t,n,i,o,s,r;return r=g(e?"Inviting members...":"Invite and continue"),t=b(y,{className:"team-invite-form__submit-button",disabled:e,tabIndex:3,onClick:this._onSubmitButtonClick},r),o=g("Skip for now"),s={"team-invite-form__skip-button":!0},i=this.props["exp-skip-button-is-link"]?(s["team-invite-form__skip-button--is-link"]=!0,s["team-invite-form__skip-button--disabled"]=e,C.a({className:w(s),tabIndex:4,onClick:this._onSkipButtonClick},o)):b(y,{className:w(s),disabled:e,tabIndex:4,onClick:this._onSkipButtonClick,importance:"tertiary"},o),e&&(n=u({className:"team-invite-form__loading-icon",src:E("/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"),srcHiRes:E("/static/images/icons/ajax-loading-small@2x-vflAxdZTP.gif")})),C.div({className:"team-invite-form__buttons-wrapper"},[n,t,i])},render:function(){return C.form({className:"team-invite-form"},[this._renderLicensesInfo(),this._renderContactsTokenizer(this._getUser()),this._renderCustomMessageField(),this._renderFormButtons(this.state.isLoading)])}}),{InviteFormReact:f}})}.call(this),function(){define("modules/clean/react/invite/licenses_info",["external/react","modules/core/i18n","modules/clean/dbmodal"],function(e,t,n){var i,o,s,r,a,l;return s=t._,l=t.ungettext,a=e.DOM,r=e.addons.classSet,i=n.DBModalStack,o=e.createClass({propTypes:{availableLicenses:e.PropTypes.number,showAddLicenses:e.PropTypes.bool,isTrial:e.PropTypes.bool,onLicensesAdded:e.PropTypes.func,className:e.PropTypes.string},getDefaultProps:function(){return{showAddLicenses:!1,isTrial:!1}},getInitialState:function(){return{licensesAdded:0}},_getMessage:function(e){return 0>e?s("You need more licenses for this invitation."):0===e?s("You have no remaining licenses."):e>0?l("You have %(n)s remaining license.","You have %(n)s remaining licenses.",e).format({n:e}):""},render:function(){var e,t;return t=this.props.availableLicenses+this.state.licensesAdded,e=a.span(r({over:0>t}),this._getMessage(t)),a.div({className:this.props.className+" licenses-info"},e)}})})}.call(this),function(){define("modules/clean/react/modal",["external/react","jquery","modules/core/i18n","modules/core/dom","modules/clean/react/button","modules/clean/keycode"],function(e,t,n,i,o,s){var r,a,l,c,u,d,p;return c=n._,p=e.DOM,d=e.addons.classSet,r="react-modal-root",u=function(e){var n,i;return null==e&&(e=!0),n=r,i=t("#"+n),!i.length&&e&&(i=t("<div />").attr({id:n}).prependTo("body")),i[0]},a=e.createClass({displayName:"Modal",statics:{showInstance:function(n){var i;return i=u(),e.unmountComponentAtNode(i),t(i).siblings().attr("aria-hidden",!0),e.render(n,i)},close:function(n){var i;return i=u(),i?(e.unmountComponentAtNode(i),t(i).siblings().attr("aria-hidden",!1),null!=n?n.focus():void 0):void 0},unhide:function(){var e;return e=u(),e?t(e).show():void 0},hide:function(){var e;return e=u(),e?t(e).hide():void 0}},propTypes:{width:e.PropTypes.number,submitting:e.PropTypes.bool,title:e.PropTypes.string,acceptButtonText:e.PropTypes.string,dismissButtonText:e.PropTypes.string,acceptButtonImportance:e.PropTypes.string,additionalButtonsText:e.PropTypes.array,additionalButtonsHandler:e.PropTypes.func,altAction:e.PropTypes.node,headerId:e.PropTypes.string,onAccept:e.PropTypes.func,onDismiss:e.PropTypes.func,onDismissCompleted:e.PropTypes.func,onShow:e.PropTypes.func,buttonComponent:e.PropTypes.element,autoClose:e.PropTypes.bool,clickOutToClose:e.PropTypes.bool,showX:e.PropTypes.bool,acceptButtonDisabled:e.PropTypes.bool,autoFocusPrimaryInput:e.PropTypes.bool,style:e.PropTypes.oneOf(["default","clean","simple","lightbox","bare"]),setMaxHeight:e.PropTypes.bool,className:e.PropTypes.string},close:function(){return a.close(this.elementToFocusOnClose)},_invokeCallbackAndClose:function(e,t,n){return null!=e&&"function"==typeof e.call&&e.call(this,t),t.isDefaultPrevented()?void 0:this.props.autoClose||n?this.close():void 0},_dismiss:function(e){var t;return this._invokeCallbackAndClose(this.props.onDismiss,e,!0),null!=(t=this.props.onDismissCompleted)&&"function"==typeof t.call?t.call(this,e):void 0},_accept:function(e){return this._invokeCallbackAndClose(this.props.onAccept,e,!1)},_additionalButtonPressed:function(e,t){var n;return"function"==typeof(n=this.props).additionalButtonsHandler&&n.additionalButtonsHandler(t,e),this.close()},_onClickOnOverlay:function(e){return this.props.clickOutToClose?this._dismiss(e):void 0},getDefaultProps:function(){return{acceptButtonText:c("OK"),acceptButtonImportance:"primary",dismissButtonText:null,buttonComponent:null,headerId:"db-modal-title",onAccept:function(){},onDismiss:function(){},onShow:function(){},autoClose:!0,clickOutToClose:!0,style:"default",showX:!0,acceptButtonDisabled:!1,autoFocusPrimaryInput:!0}},_focus:function(){var e,n;return this.elementToFocusOnClose=document.activeElement,e=t(this.refs.modal.getDOMNode()),this.props.autoFocusPrimaryInput&&(n=e.find("input").first(),n.length?e=n:this.refs.primaryButton?e=t(this.refs.primaryButton.getDOMNode()):this.refs.tertiaryButton&&(e=t(this.refs.tertiaryButton.getDOMNode()))),e.focus()},_keyDown:function(e){var t,n;if(e.stopPropagation(),e.which===s.ESC&&this._dismiss(e),e.which!==s.BACKSPACE||i.focus_in_input()||(e.preventDefault(),this._dismiss(e)),e.which===s.TAB){if(n=i.getTabbableElementsIn(this.refs.modal.getDOMNode()),t=n.indexOf(e.target),t===n.length-1&&!e.shiftKey)return e.preventDefault(),n[0].focus();if(0===t&&e.shiftKey)return e.preventDefault(),n[n.length-1].focus()}},_renderButtons:function(){var e,t,n,i,s,r;if(this.props.buttonComponent)return this.props.buttonComponent;if(n=[],this.props.submitting&&n.push(p.span({className:"dbmodal-loading",key:"loading"},p.img({src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",alt:c("Loading")}))),this.props.acceptButtonText&&n.push(o.button({ref:"primaryButton",key:"primary",className:"dbmodal-button",importance:this.props.acceptButtonImportance,disabled:this.props.acceptButtonDisabled,onClick:this._accept},this.props.acceptButtonText)),this.props.dismissButtonText&&n.push(o.button({ref:"tertiaryButton",key:"tertiary-dismiss",className:"dbmodal-button",importance:"tertiary",onClick:this._dismiss},this.props.dismissButtonText)),this.props.additionalButtonsText)for(r=this.props.additionalButtonsText,e=i=0,s=r.length;s>i;e=++i)t=r[e],n.push(o.button({ref:"tertiaryButton",key:"tertiary-"+e,className:"dbmodal-button",importance:"tertiary",onClick:this._additionalButtonPressed.bind(this,e)},t));return n.length?p.div({className:"db-modal-buttons"},n):void 0},_renderAltAction:function(){return this.props.altAction?p.div({className:"db-modal__alt-action"},this.props.altAction):void 0},componentDidMount:function(){var e;return t(document).trigger("modalOpened",this),i.scroll_lock_document(),t(this.refs.modal.getDOMNode()).on("keydown",this._keyDown),this._focus(),"function"==typeof(e=this.props).onShow?e.onShow():void 0},componentWillUnmount:function(){return t(document).trigger("modalClosed",this),i.scroll_unlock_document(),t(this.refs.modal.getDOMNode()).off("keydown",this._keyDown)},render:function(){var e,t,n,i;return t={"db-modal-wrapper":!0,"db-modal--clean-style":"clean"===this.props.style,"db-modal--simple-style":"simple"===this.props.style,"db-modal--lightbox-style":"lightbox"===this.props.style,"db-modal--bare-style":"bare"===this.props.style},null!=this.props.className&&(t[this.props.className]=!0),e=d(t),n=this.props.width?{width:this.props.width+"px"}:{},p.div({className:e},p.div({className:"db-modal-overlay",onClick:this._onClickOnOverlay}),p.div({ref:"modal",className:"db-modal",tabIndex:0,style:n,role:"dialog","aria-labelledby":"lightbox"===this.props.style?"":this.props.headerId},p.div({className:"db-modal-box",ref:"modalBox"},"lightbox"===(i=this.props.style)||"bare"===i?p.div({className:"db-modal-"+this.props.style},this.props.children):p.div({},this.props.showX?p.button({className:"db-modal-x",onClick:this._dismiss,"aria-label":c("Close")}):void 0,p.h2({id:"db-modal-title",className:"db-modal-title"},p.div({className:"db-modal-title-text"},this.props.title)),p.div({className:"db-modal-content clearfix"},this.props.children,this._renderButtons(),this._renderAltAction())))))}}),l={show:function(t){var n;return n={acceptButtonText:t.confirm_text,onAccept:t.confirm_callback,dismissButtonText:t.cancel_text,onDismiss:t.cancel_callback,onDismissCompleted:t.cancel_completed_callback,title:t.title_text,width:t.width,className:"simple-modal",autoClose:t.autoclose,style:t.style,onShow:t.on_show},a.showInstance(new a(n,e.DOM.div({className:"simple-modal-content",dangerouslySetInnerHTML:{__html:t.body_html}})))}},{Modal:a,SimpleModal:l}})}.call(this),function(){define("modules/clean/react/onboarding_modal",["external/react","modules/core/i18n","modules/core/exception","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/slider"],function(e,t,n,i,o,s){var r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T;return C=t._,E=n.assert,a=i.button,p=o.Modal,u=s.IndicatorGroup,w=s.Slides,y=s.Slider,_=s.NavButtonGroup,T=e.DOM,S=e.addons.classSet,d=e.createFactory(p),r=e.createFactory(a),g=e.createFactory(y),b=e.createFactory(w),c=e.createFactory(u),h=e.createFactory(_),l=640,v=e.createClass({displayName:"OnboardingSlider",mixins:[e.addons.PureRenderMixin],propTypes:{width:e.PropTypes.number.isRequired,height:e.PropTypes.number,className:e.PropTypes.string,onSlideChange:e.PropTypes.func,onSlideEnd:e.PropTypes.func,initialSlideIndex:e.PropTypes.number,children:function(t,n,i){var o;return o=e.Children.count(t[n]),E(o>0,i+" has no slide to show")}},getDefaultProps:function(){return{initialSlideIndex:0}},getInitialState:function(){return{currentSlideIndex:this.props.initialSlideIndex}},isAtLastSlide:function(){return this.state.currentSlideIndex+1===this.getSlideCount()},getSlideCount:function(){return e.Children.count(this.props.children)},gotoSlide:function(e){return e!==this.state.currentSlideIndex?(E(e>=0&&e<this.getSlideCount(),"Invalid slide index: "+e),this.setState({currentSlideIndex:e},function(t){return function(){var n;return"function"==typeof(n=t.props).onSlideChange?n.onSlideChange(e):void 0}}(this))):void 0},prevSlide:function(){return this.gotoSlide(this.state.currentSlideIndex-1)},nextSlide:function(){return this.gotoSlide(this.state.currentSlideIndex+1)},render:function(){return g({className:this.props.className},b({width:this.props.width,height:this.props.height,currentSlideIndex:this.state.currentSlideIndex},this.props.children),c({slideCount:this.getSlideCount(),currentSlideIndex:this.state.currentSlideIndex,onIndicatorClick:this.gotoSlide}),h(null,this.isAtLastSlide()?r({className:"is-done",onClick:this.props.onSlideEnd},C("Got it")):r({className:"is-next",onClick:this.nextSlide},C("Next"))))}}),f=e.createFactory(v),m=e.createClass({displayName:"OnboardingModal",mixins:[e.addons.PureRenderMixin],propTypes:{className:e.PropTypes.string,onClose:e.PropTypes.func,slideWidth:e.PropTypes.number,slideHeight:e.PropTypes.number,initialSlideIndex:e.PropTypes.number},getDefaultProps:function(){return{slideWidth:l}},closeModal:function(){var e;return p.close(),"function"==typeof(e=this.props).onClose?e.onClose():void 0},render:function(){return d({acceptButtonText:null,
onDismiss:this.props.onClose,style:"clean",className:this.props.className},f({initialSlideIndex:this.props.initialSlideIndex,width:this.props.slideWidth,height:this.props.slideHeight,onSlideEnd:this.closeModal},this.props.children))}})})}.call(this),function(){define("modules/clean/react/paging_list",["external/react","jquery","external/underscore"],function(e,t,n){var i,o;return o=e.DOM,i=e.createClass({displayName:"PagingList",propTypes:{customClass:e.PropTypes.oneOfType([e.PropTypes.string,e.PropTypes.instanceOf(e.addons.classSet)]),itemSize:e.PropTypes.number.isRequired,pageSize:e.PropTypes.number.isRequired,threshold:e.PropTypes.number,useTranslate3d:e.PropTypes.bool},getDefaultProps:function(){return{threshold:100,useTranslate3d:!1}},getInitialState:function(){return{from:0,size:this._constrainSize(this.props.pageSize,this.props.children,0)}},componentWillReceiveProps:function(e){var t,n;return t=this._constrainFrom(this.state.from,e.children.length),n=this._constrainSize(this.state.size,e.children,t),this.setState({from:t,size:n})},componentDidMount:function(){return window.addEventListener("resize",this.updateFrame),this.getDOMNode().addEventListener("scroll",this.updateFrame),this.updateFrame()},shouldComponentUpdate:function(e,t){return!n.isEqual(e,this.props)||!n.isEqual(t,this.state)},componentDidUpdate:function(){return this.updateFrame()},componentWillUnmount:function(){return window.removeEventListener("resize",this.updateFrame),this.getDOMNode().removeEventListener("scroll",this.updateFrame)},_getScroll:function(){var e,t,n;return t=this.refs.scroller.getDOMNode().getBoundingClientRect().top,e=this.refs.container.getDOMNode().getBoundingClientRect().top,n=e-t},_setScroll:function(e){return this.refs.container.getDOMNode().scrollTop+=e-this._getScroll()},_getViewportSize:function(){return this.refs.container.getDOMNode().clientHeight},_getStartAndEnd:function(){var e,t;return t=Math.max(0,this._getScroll()-this.props.threshold),e=t+this._getViewportSize()+2*this.props.threshold,{start:t,end:e}},updateFrame:function(){var e,t,n,i,o,s;return i=this._getStartAndEnd(),s=i.start,e=i.end,n=this.props.itemSize,t=this._constrainFrom(Math.floor(s/n),this.props.children.length),o=this._constrainSize(Math.ceil((e-s)/n)+1,this.props.children,t),this.setState({from:t,size:o})},_getSpaceBefore:function(e){return e*this.props.itemSize},_constrainFrom:function(e,t){return e?Math.max(Math.min(e,t-1),0):0},_constrainSize:function(e,t,n){var i,o;return i=t.length,o=this.props.pageSize,Math.min(Math.max(e,o),i-n)},scrollTo:function(e){return this._setScroll(this._getSpaceBefore(e))},scrollAround:function(e){var t,n,i;return t=this._getScroll(),n=this._getSpaceBefore(e),t>n?this._setScroll(n):(i=n-this._getViewportSize()+this.props.itemSize,i>t?this._setScroll(i):void 0)},_renderItems:function(){var e;return e=this.state.from+this.state.size-1,this.props.children.slice(this.state.from,+e+1||9e9)},render:function(){var t,n,i,s;return n={position:"relative",height:this._getSpaceBefore(this.props.children.length)},s=this._getSpaceBefore(this.state.from),i=this.props.useTranslate3d?"translate3d(0px, "+s+"px, 0)":"translate(0px, "+s+"px)",t={MsTransform:i,WebkitTransform:i,transform:i},o.div({className:e.addons.classSet("paging-list",this.props.customClass),ref:"container"},o.div({style:n,ref:"scroller"},o.ul({style:t},this._renderItems())))}})})}.call(this),function(){define("modules/clean/react/previews/audio/preview_audio",["external/react","external/underscore","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri","modules/clean/average_counter","modules/clean/loggers/file_preview_logger","modules/clean/react/file_viewer/constants","modules/clean/react/previews/audio/preview_audio_play_button","modules/clean/react/previews/audio/preview_audio_details","modules/clean/react/previews/audio/preview_audio_visuals","modules/clean/react/previews/audio/preview_audio_volume","modules/clean/react/previews/audio/utils","modules/clean/web_timing_logger"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_){var m,f,v,g,y,b,w,C,E,S,T,A,I,k,P,N;return k=i._,y=l.EventTypes,I=h.PreviewAudioWaveformHelpers,P=e.DOM,N=e.PropTypes,T=e.createFactory(d),S=e.createFactory(c),E=e.createFactory(u),A=e.createFactory(p),f=2,m=1,w=1e3,v=100,b=.85,g="dropbox_duc_id",C=e.createClass({displayName:"PreviewAudio",propTypes:{src:N.string.isRequired,"log-time-to-interactive":N.bool,onError:N.func},getInitialState:function(){return{time:0,duration:0,bufferedLength:0,isPlaying:!1,isReady:!1,isMuted:!1,volumeLevel:1,rawWaveformHeights:[],waveformWidth:0}},componentWillMount:function(){return this._logPreviewEvent(y.FILE_PREVIEW_SUPPORT_CONFIRMED)},componentDidMount:function(){var e;return e=this._getAudioNode(),e.addEventListener("timeupdate",this._updateTime),e.addEventListener("durationchange",this._updateDuration),e.addEventListener("ended",this._pauseFile),e.addEventListener("canplay",this._setReady),e.addEventListener("progress",this._updateProgress),e.addEventListener("error",this._throwError),this._setWaveformWidth(),window.addEventListener("resize",this._getDebouncedWaveformWidthFunction()),this._sendWaveFormRequest()},componentWillUnmount:function(){var e;return e=this._getAudioNode(),e.removeEventListener("timeupdate",this._updateTime),e.removeEventListener("durationchange",this._updateDuration),e.removeEventListener("ended",this._pauseFile),e.removeEventListener("canplay",this._setReady),e.removeEventListener("progress",this._updateProgress),e.removeEventListener("error",this._throwError),window.removeEventListener("resize",this._getDebouncedWaveformWidthFunction())},_logPreviewEvent:function(e){return a.logEvent(e)},_getAudioNode:function(){return this.refs.audio.getDOMNode()},_getDebouncedWaveformWidthFunction:function(){return this._debouncedWaveformWidthFunction||(this._debouncedWaveformWidthFunction=t.debounce(this._setWaveformWidth,100)),this._debouncedWaveformWidthFunction},_setWaveformWidth:function(){return this.isMounted()?this.setState({waveformWidth:this.refs.audioContainer.getDOMNode().offsetWidth}):void 0},_getSrcUrl:function(){var e,t;return e=s.parse(this.props.src),e.updateQuery("duc_id",g),t=e.toString(),"//"===t.slice(0,2)&&(t="https:"+t),t},_setReady:function(){return this.props["log-time-to-interactive"]&&_.mark_time_to_interactive(),this.setState({isReady:!0}),this._logPreviewEvent(y.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(y.FILE_PREVIEW_RENDER_SUCCEEDED)},_getBufferProgress:function(){var e;return e=this._getAudioNode(),e.duration&&e.buffered.length?e.buffered.end(e.buffered.length-1):0},_updateProgress:function(){var e;return e=this._getBufferProgress(),this.setState({bufferedLength:e})},_updateTime:function(){return this.setState({time:this._getAudioNode().currentTime})},_updateTimeTo:function(e){return this._getAudioNode().currentTime=e,this.setState({time:e})},_updateDuration:function(){var e;return e=this._getBufferProgress(),this.setState({duration:this._getAudioNode().duration,bufferedLength:e})},_playOrPause:function(){return this.state.isPlaying?this._pauseFile():this._playFile()},_playFile:function(){return this._getAudioNode().play(),this.setState({isPlaying:!0})},_pauseFile:function(){return this._getAudioNode().pause(),this.setState({isPlaying:!1})},_toggleMute:function(){var e,t;return t=this.state.isMuted?this.state.volumeLevel||.1:0,this._getAudioNode().volume=t,e={isMuted:!this.state.isMuted},0===this.state.volumeLevel&&(e.volumeLevel=t),this.setState(e)},_changeVolumeTo:function(e){return this._getAudioNode().volume=e,this.setState({volumeLevel:e,isMuted:!e})},_sendWaveFormRequest:function(){var e,t;return e=this._getAudioContext(),null==e?this._generateRandomRawWaveform():(t=new XMLHttpRequest,t.open("GET",this._getSrcUrl()),t.responseType="arraybuffer",t.withCredentials=!0,t.onreadystatechange=function(n){return function(){return 4===t.readyState&&n.isMounted()?200===t.status?e.decodeAudioData(t.response,n._parseWaveFormBuffer,n._generateRandomRawWaveform):n._generateRandomRawWaveform():void 0}}(this),t.send())},_throwError:function(){return o.error(k("An audio error occurred")),n.reportException({msg:"Audio file failed to play",tags:["audioPreviews"],severity:n.SEVERITY.NONCRITICAL}),this._logPreviewEvent(y.FILE_PREVIEW_DOWNLOAD_FAILED),this.props.onError()},_updateWaveformState:function(e){return this.isMounted()?this.setState({rawWaveformHeights:e}):void 0},_generateRandomRawWaveform:function(){var e;return n.reportException({msg:"Audio could not be decoded",tags:["audioPreviews"],severity:n.SEVERITY.NONCRITICAL}),e=I.generateRandomWaveform(w),this._setWaveformWidth(),this._updateWaveformState(e)},_parseWaveFormBuffer:function(e){return this._setWaveformWidth(),I.buildFromBuffer(e,w,v,this.isMounted.bind(this),this._updateWaveformState)},_getAudioContext:function(){var e;return(e=window.AudioContext||window.webkitAudioContext)?new e:void 0},_renderAudioTag:function(){return P.audio({src:this._getSrcUrl(),preload:"auto",ref:"audio"})},_generateWaveform:function(){var e;return e=Math.floor((this.state.waveformWidth-m)/(f+m)),I.returnWaveform(this.state.rawWaveformHeights,e,b)},_renderWaveForm:function(){return T({generateWaveform:this._generateWaveform,time:this.state.time,duration:this.state.duration,bufferedLength:this.state.bufferedLength,updateTime:this._updateTimeTo,barWidth:f,barSpacing:m,waveformWidth:this.state.waveformWidth,isWaveformReady:0!==this.state.rawWaveformHeights.length,isScrubReady:this.state.isReady})},_renderToolbar:function(){return P.div({className:"toolbar"},this._renderPlayButton(),this._renderDetails(),this._renderVolume())},_renderPlayButton:function(){return S({isReady:this.state.isReady,isPlaying:this.state.isPlaying,onChange:this._playOrPause})},_renderDetails:function(){return E({time:this.state.time,duration:this.state.duration,isReady:this.state.isReady})},_renderVolume:function(){return A({isReady:this.state.isReady,isMuted:this.state.isMuted,volumeLevel:this.state.volumeLevel,onVolumeChange:this._changeVolumeTo,onMuteToggle:this._toggleMute})},render:function(){return P.div({className:"flex-preview-container"},P.div({className:"preview-audio preview-content preview-content--center"},P.div({className:"preview-audio__wrapper"},P.div({className:"preview-audio__container",ref:"audioContainer"},this._renderAudioTag(),this._renderWaveForm(),this._renderToolbar()))))}})})}.call(this),function(){define("modules/clean/react/previews/audio/preview_audio_details",["external/react","modules/clean/datetime","modules/core/i18n"],function(e,t,n){var i,o,s,r,a;return r=t.formatAudioTime,o=n._,s=e.DOM,a=e.PropTypes,i=e.createClass({displayName:"PreviewAudioDetails",propTypes:{time:a.number.isRequired,duration:a.number.isRequired,isReady:a.bool.isRequired},_formatString:function(e){return o("%(time)s").format({time:r(e)})},_getDisplayString:function(){return this.props.isReady?s.span({className:"toolbar-details__time"},this._formatString(this.props.time)+" / "+this._formatString(this.props.duration)):s.span({className:"toolbar-details__loading"},o("Loading..."))},render:function(){return s.div({className:"toolbar-details vertical-align"},s.div({className:"toolbar-details__string vertical-align__child"},this._getDisplayString()))}})})}.call(this),function(){define("modules/clean/react/previews/audio/preview_audio_play_button",["external/react","modules/clean/react/previews/audio/utils"],function(e,t){var n,i,o,s;return i=t.PreviewAudioHelpers,o=e.DOM,s=e.PropTypes,n=e.createClass({displayName:"PreviewAudioControls",propTypes:{isReady:s.bool.isRequired,isPlaying:s.bool.isRequired,onChange:s.func.isRequired},_getIconString:function(){return this.props.isReady?this.props.isPlaying?"pause":"play":"playInactive"},_renderButtonImage:function(){return i.getImage(this._getIconString())},render:function(){var e;return e=this.props.isReady?this.props.onChange:null,o.button({className:"toolbar-controller vertical-align",onClick:e},o.div({className:"toolbar-controller__button vertical-align__child"},this._renderButtonImage()))}})})}.call(this),function(){define("modules/clean/react/previews/audio/preview_audio_visuals",["external/react"],function(e){var t,n,i,o,s;return o=e.DOM,s=e.PropTypes,i=e.addons.classSet,t=.4,n=e.createClass({displayName:"PreviewAudioVisuals",propTypes:{generateWaveform:s.func.isRequired,time:s.number.isRequired,duration:s.number.isRequired,bufferedLength:s.number.isRequired,updateTime:s.func.isRequired,barWidth:s.number.isRequired,barSpacing:s.number.isRequired,waveformWidth:s.number.isRequired,isWaveformReady:s.bool.isRequired,isScrubReady:s.bool.isRequired},getInitialState:function(){return{scrubPercentage:0,isMouseDown:!1}},_getSeekPercentageFromEvent:function(e){var t,n;return t=this.refs.waveform.getDOMNode().getBoundingClientRect(),n=e.pageX-t.left,n/t.width},_getProgress:function(){return this.props.time/(this.props.duration||1)},_getBuffered:function(){return this.state.scrubPercentage>0?this.state.scrubPercentage:this.props.bufferedLength/(this.props.duration||1)},_getWidthObject:function(e){return{width:e+"%"}},_scrubTime:function(e){var t;return this.props.isScrubReady?(t=this._getSeekPercentageFromEvent(e),this._updateWaveformScrubToPercentage(t),this.state.isMouseDown?this._updateTime(e):void 0):void 0},_resetScrub:function(){return this._updateWaveformScrubToPercentage(0),this._setMouseUp()},_updateWaveformScrubToPercentage:function(e){return this.setState({scrubPercentage:e})},_updateTime:function(e){var t,n;return this.props.isScrubReady?(n=this._getSeekPercentageFromEvent(e),t=n*this.props.duration,this.props.updateTime(t)):void 0},_setMouseDown:function(){return this.setState({isMouseDown:!0})},_setMouseUp:function(){return this.setState({isMouseDown:!1})},_getClassesBasedOffBool:function(e,t,n){return e?t+" "+n:t},_getWavebarClasses:function(e){return i({wavebar__single:!0,"wavebar__single--scrubbed":e})},_renderWaveBar:function(e,t){var n,i,s,r,a,l,c;return r=1-e,l={top:100*r+"%",height:100*e+"%"},c=this.refs.waveform.getDOMNode().offsetWidth,n=(t+1)*(this.props.barWidth+this.props.barSpacing)-this.props.barWidth,this.state.scrubPercentage>0?(a=this.state.scrubPercentage*c,i=this._getWavebarClasses(a>n)):(s=this._getProgress()*c,i=this._getWavebarClasses(s>n)),[o.div({className:"wavebar__single wavebar__space"}),o.div({className:i,style:l})]},_renderWaveBars:function(){var e,t,n;return t=i({wavebar__container:!0,"wavebar__container--ready":this.props.isWaveformReady}),o.div({className:t},function(){var t,i,o,s;for(o=this.props.generateWaveform(),s=[],n=t=0,i=o.length;i>t;n=++t)e=o[n],s.push(this._renderWaveBar(e,n));return s}.call(this))},_renderWaveForm:function(){var e,n,i;return e=Math.floor(this.props.waveformWidth*t),i={height:e+"px"},n=this._getWidthObject(100*this.state.scrubPercentage),o.div({className:"waveform",style:i},o.div({className:"waveform__scrub",style:n,ref:"waveformScrub"}),this._renderWaveBars())},_renderProgressBar:function(){var e,t,n;return n=100*this._getProgress(),e=100*this._getBuffered(),t=i({"audio-progress-bar__done":!0,"audio-progress-bar__showing":n}),o.div({className:"audio-progress-bar"},o.div({className:"audio-progress-bar__buffered",style:this._getWidthObject(e)}),o.div({className:t,style:this._getWidthObject(n)}))},render:function(){return o.div({className:"visuals",onClick:this._updateTime,onMouseMove:this._scrubTime,onMouseLeave:this._resetScrub,onMouseDown:this._setMouseDown,onMouseUp:this._setMouseUp,ref:"waveform"},this._renderWaveForm(),this._renderProgressBar())}})})}.call(this),function(){define("modules/clean/react/previews/audio/preview_audio_volume",["external/react","modules/clean/react/previews/audio/utils"],function(e,t){var n,i,o,s;return n=t.PreviewAudioHelpers,o=e.DOM,s=e.PropTypes,i=e.createClass({displayName:"PreviewAudioVolume",propTypes:{isReady:s.bool.isRequired,isMuted:s.bool.isRequired,volumeLevel:s.number.isRequired,onVolumeChange:s.func.isRequired,onMuteToggle:s.func.isRequired},getInitialState:function(){return{isMouseDown:!1}},_setMouseDown:function(){return this.setState({isMouseDown:!0})},_setMouseUp:function(){return this.setState({isMouseDown:!1})},_getVolumePercentageFromEvent:function(e){var t,n;return n=this.refs.volumebar.getDOMNode().getBoundingClientRect(),t=e.pageX-n.left,t/n.width},_safeChangeVolume:function(e){return this.state.isMouseDown?this._changeVolume(e):void 0},_changeVolume:function(e){var t;return t=this._getVolumePercentageFromEvent(e),this.props.onVolumeChange(t)},_getIconString:function(){return this.props.isReady?this.props.isMuted?"volumeMuted":"volume":"volumeInactive"},_renderVolumeImage:function(){var e,t;return t=n.getImage(this._getIconString()),e=this.props.isReady?{onClick:this.props.onMuteToggle}:{},o.div({className:"toolbar-volume__button vertical-align__child"},o.button(e,t))},_renderVolumeBar:function(){var e,t;return t=this.props.isMuted||!this.props.isReady?0:100*this.props.volumeLevel,e={width:t+"%"},o.div({className:"volume-bar vertical-align__child",onMouseUp:this._setMouseUp,onMouseDown:this._setMouseDown,onMouseLeave:this._setMouseUp,onMouseMove:this._safeChangeVolume,onClick:this._changeVolume},o.div({className:"volume-bar__container",ref:"volumebar"},o.div({className:"volume-bar__selected",style:e})))},render:function(){return o.div({className:"toolbar-volume vertical-align"},this._renderVolumeImage(),this._renderVolumeBar())}})})}.call(this),function(){define("modules/clean/react/previews/audio/utils",["external/react","external/underscore","modules/clean/average_counter","modules/clean/react/sprite","modules/core/i18n"],function(e,t,n,i,o){var s,r,a;return a=o._,s={getImage:function(e){var t;return t=a("%(state)s").format({state:e}),i({group:"web",name:e,alt:t})}},r={buildFromBuffer:function(e,t,i,o,s){var r,a,l;return a=e.getChannelData(0),l=new Array(t),r=function(e){return function(){var c,u,d,p,h,_;return e>=t?void s(l):(d=Math.ceil(e*a.length/t),u=Math.ceil((e+1)*a.length/t),h=u-d,p=h>i?function(){var e,t,n;for(n=[],_=e=0,t=i;t>=0?t>e:e>t;_=t>=0?++e:--e)n.push(Math.abs(a[parseInt(Math.random()*h)+d]));return n}():a.slice(d,u),c=new n,c.addArray(p),l[e]=c.getAverage(),o()?setTimeout(r(e+1),0):void 0)}},setTimeout(r(0),0)},returnWaveform:function(e,i,o){var s,r,a,l,c,u,d,p,h,_,m;if(null==o&&(o=1),_=[],0===e.length||0>=i)return _;for(l=0,p=0,r=function(){var e,t,o;for(o=[],m=e=0,t=i;t>=0?t>e:e>t;m=t>=0?++e:--e)o.push(new n);return o}(),c=u=0,d=e.length;d>u;c=++u)h=e[c],a=Math.floor(c*i/e.length),s=r[a],s.add(h),_[a]=s.getAverage(),a!==p&&(l=Math.max(l,_[p]),p=a);return l=Math.max(l,_[i-1]),t.map(_,function(e){return e*o/l})},generateRandomWaveform:function(e){var t;return function(){var n,i,o;for(o=[],t=n=0,i=e;i>=0?i>n:n>i;t=i>=0?++n:--n)o.push(Math.random());return o}()}},{PreviewAudioHelpers:s,PreviewAudioWaveformHelpers:r}})}.call(this),function(){define("modules/clean/react/previews/password_component",["external/react"],function(e){var t,n,i,o;return o=e.DOM,i=o.input,n=o.form,t=e.createClass({displayName:"PasswordComponent",propTypes:{onPasswordSubmit:e.PropTypes.func.isRequired},_handleSubmit:function(e){var t,n;return e.preventDefault(),n=this.refs.password.getDOMNode().value,n&&"function"==typeof(t=this.props).onPasswordSubmit?t.onPasswordSubmit(n):void 0},render:function(){return n({className:"preview-blank-title",onSubmit:this._handleSubmit},[i({ref:"password",type:"password",defaultValue:"",autocomplete:"off"}),i({type:"submit",value:"Submit"})])}})})}.call(this),function(){define("modules/clean/react/previews/preview_blank",["external/react","jquery","modules/core/i18n","modules/core/uri","modules/clean/datetime","modules/clean/loggers/file_preview_logger","modules/clean/react/file_viewer/constants","modules/clean/react/sprite"],function(e,t,n,i,o,s,r,a){var l,c,u,d;return l=r.EventTypes,d=e.DOM,u=n._,c=e.createClass({displayName:"PreviewBlank",propTypes:{icon:e.PropTypes.string,filename:e.PropTypes.string.isRequired,created:e.PropTypes.object,size:e.PropTypes.string,isFallbackForLoadError:e.PropTypes.bool},getDefaultProps:function(){return{icon:"page_white_picture_32",isFallbackForLoadError:!1}},componentWillMount:function(){return this._logPreviewSupportDenied()},componentWillReceiveProps:function(){return this._logPreviewSupportDenied()},_logPreviewSupportDenied:function(){return this.props.isFallbackForLoadError?void 0:s.logEvent(l.FILE_PREVIEW_SUPPORT_DENIED)},render:function(){var e;return d.div({className:"flex-preview-container"},d.div({className:"preview-content preview-content--center"},d.div({className:"preview-blank-wrapper"},d.div({className:"preview-blank-icon"},a({group:"web",name:""+this.props.icon})),d.div({className:"preview-blank-title"},""+this.props.filename),d.div({className:"preview-blank-info"},null==this.props.created||isNaN(null!=(e=this.props.created)?e.getTime():void 0)?void 0:[d.span({},""+o.format_date(this.props.created,"MMMM dd, yyyy hh:mm a")),d.span({className:"bottom-dot"}," · ")],null!=this.props.size&&""!==this.props.size?d.span({},""+this.props.size):void 0))))}})})}.call(this),function(){define("modules/clean/react/previews/preview_flippable",["external/react","jquery","modules/clean/gandalf_util","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_image","modules/clean/react/previews/preview_image_with_annotations","modules/clean/react/previews/preview_video","modules/clean/react/sprite","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_,m,f;return d=o.PreviewImage,p=s.PreviewImageWithAnnotations,h=r.PreviewVideo,f=e.DOM,m=e.addons.classSet,_=l._,c=100,u=e.createClass({statics:{isFlippable:function(e){return"photo"===e||"video"===e}},displayName:"PreviewFlippable",propTypes:{"preview-type":e.PropTypes.oneOf(["photo","video"]),"file-extension":e.PropTypes.string.isRequired,"thumbnail-url-tmpl":e.PropTypes.string.isRequired,gifUrl:e.PropTypes.string,onLoad:e.PropTypes.func,onError:e.PropTypes.func,index:e.PropTypes.number,count:e.PropTypes.number,totalFiles:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func,imagesToPreload:e.PropTypes.array,"preview-url":e.PropTypes.string,"video-metadata-url":e.PropTypes.string,"file-meta":e.PropTypes.shape({filename:e.PropTypes.string,mtime:e.PropTypes.number,formattedSize:e.PropTypes.string}).isRequired},onImageLoad:function(){var e;return null!=(e=this.refs.previewImageWithAnnotations)?e._onImageLoad():void 0},componentWillMount:function(){return this.isImagePreviewAnnotationCreationEnabled=n.getGandalfRule("dw-comments-annotation-image-previews"),this.areImagePreviewAnnotationsVisible=this.isImagePreviewAnnotationEnabled||n.getGandalfRule("comments-image-previews-annotations-visible")},_canFlipPrevious:function(){return this.props.index>0},_canFlipNext:function(){return this.props.index+1<this.props.count},_onPrevious:function(){var e;return"function"==typeof(e=this.props).onPrevious?e.onPrevious():void 0},_onNext:function(){var e;return"function"==typeof(e=this.props).onNext?e.onNext():void 0},_flipLabelText:function(){var e;return e=this.props.totalFiles===c?"+":"",_("%(cur_file_num)s of %(num_total_files)s").format({cur_file_num:this.props.index+1,num_total_files:this.props.count})+e},_reactElementForPreviewType:function(n){var o,s;switch(n){case"photo":return s={"thumbnail-url-tmpl":this.props["thumbnail-url-tmpl"],"file-extension":this.props["file-extension"],"file-meta":this.props["file-meta"],gifUrl:this.props.gifUrl,imagesToPreload:this.props.imagesToPreload,onLoad:this.props.onLoad,onError:this.props.onError},this.areImagePreviewAnnotationsVisible?(s=t.extend(s,{ref:"previewImageWithAnnotations",index:this.props.index,count:this.props.count,onPrevious:this._onPrevious,onNext:this._onNext,"should-display-annotations-toolbar":this.isImagePreviewAnnotationCreationEnabled}),e.createElement(p,s)):e.createElement(d,s);case"video":return e.createElement(h,{"preview-url":this.props["preview-url"],"thumbnail-url-tmpl":this.props["thumbnail-url-tmpl"],onLoad:this.props.onLoad,index:this.props.index,count:this.props.count,onPrevious:this._onPrevious,onNext:this._onNext,shouldDisplayAnnotationsToolbar:this.isImagePreviewAnnotationCreationEnabled});default:return o=this.props["file-meta"],e.createElement(i,{filename:o.filename,created:new Date(1e3*o.mtime),size:o.formattedSize})}},render:function(){var e;return f.div({className:"preview-flip-container"},[this._reactElementForPreviewType(this.props["preview-type"]),this.props.count>1&&!this.isImagePreviewAnnotationCreationEnabled?(e={"flip-controls":!0,"flip-controls--prev":this._canFlipPrevious(),"flip-controls--next":this._canFlipNext()},f.div({className:m(e)},f.button({className:"flip-button-prev",onClick:this._onPrevious},a({group:"web",name:"s_flip_left",alt:_("Flip left",{comment:"Flip to the previous file in a series of files"})})),f.div({className:"flip-label"},this._flipLabelText()),f.button({className:"flip-button-next",onClick:this._onNext},a({group:"web",name:"s_flip_right",alt:_("Flip right",{comment:"Flip to the next file in a series of files"})})))):void 0])}}),{PreviewFlippable:u}})}.call(this),function(){define("modules/clean/react/previews/preview_html",["external/react","jquery","modules/clean/frame_messenger","modules/clean/previews/preview_actions_helper","modules/clean/loggers/file_preview_logger","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/full_screen_helpers","modules/clean/react/previews/preview_toolbar"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f,v,g;return p=i.PreviewActions,c=s.EventTypes,u=r.FullscreenHelpers,m=a.ReactPreviewToolbarClass,g=e.DOM,f=g.div,v=g.iframe,d="previewhtml",l=["failed","viewer-ready"],_=e.createFactory(m),h=e.createClass({displayName:"PreviewHTML",propTypes:{src:e.PropTypes.string.isRequired,previewType:e.PropTypes.string.isRequired,isFullscreen:e.PropTypes.bool.isRequired,fileExtension:e.PropTypes.string.isRequired,onError:e.PropTypes.func,filePreviewType:e.PropTypes.number,usesFrameMessenger:e.PropTypes.bool},getDefaultProps:function(){return{onError:null,filePreviewType:"",usesFrameMessenger:!0}},_getIframeProps:function(){var e;return e={type:"text/html",src:this.props.src,sandbox:"",className:d,ref:"iframe"},this.props.usesFrameMessenger&&(e.sandbox="allow-modals allow-scripts allow-forms"),e},_handleTrustedMessageFromChild:function(e){var t;switch(e.action){case"failed":return this._logPreviewEvent(c.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(c.FILE_PREVIEW_RENDER_FAILED),"function"==typeof(t=this.props).onError?t.onError():void 0;case"viewer-ready":return this._logPreviewEvent(c.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(c.FILE_PREVIEW_RENDER_SUCCEEDED),this._frameMessenger.postMessageToChildren(this.props.isFullscreen?"enter-fullscreen":"exit-viewer-fullscreen")}},componentWillMount:function(){return this._logPreviewEvent(c.FILE_PREVIEW_SUPPORT_CONFIRMED)},componentDidMount:function(){var e,i;return this.props.usesFrameMessenger&&(this._frameMessenger=new n,this._frameMessenger.configureChildMessaging("iframe."+d,this._handleTrustedMessageFromChild,l),this._frameMessenger.startListening(),u.setupFullscreen(this.props.isFullscreen),t(document).on("keydown",null!=(i=this.refs.previewToolbar)?i.onKeydown:void 0)),e=this.refs.iframe.getDOMNode(),e.onload=this._handleIframeLoad,e.onerror=this._handleIframeLoad},componentWillUnmount:function(){var e;return this.props.usesFrameMessenger&&(this._frameMessenger.stopListening(),t(document).off("keydown",null!=(e=this.refs.previewToolbar)?e.onKeydown:void 0),this.props.isFullscreen)?u.teardownExitFullscreenListeners():void 0},_handleIframeLoad:function(){return this._logPreviewEvent(c.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this.props.usesFrameMessenger?void 0:this._logPreviewEvent(c.FILE_PREVIEW_RENDER_SUCCEEDED)},_handleIframeError:function(){return this._logPreviewEvent(c.FILE_PREVIEW_DOWNLOAD_FAILED)},_logPreviewEvent:function(e){return o.logEvent(e)},_renderToolbar:function(){return _({actions:p,fileExtension:this.props.fileExtension,fileHref:this.props.src,filePreviewType:this.props.previewType,ref:"previewToolbar"})},render:function(){var e;return e=this._getIframeProps(),f({className:"preview-content"},v(e),this._renderToolbar())}})})}.call(this),function(){define("modules/clean/react/previews/preview_image",["external/react","jquery","modules/clean/analytics","modules/clean/image_cache","modules/clean/image_size","modules/clean/loggers/file_preview_logger","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/utils","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_image_zoom","modules/clean/web_timing_logger","modules/core/browser","modules/core/i18n"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C,E;return f=n.PreviewActivityLogger,E=o.image_best_fit_size,_=a.EventTypes,m=l.PreloadHelpers,y=u.PreviewImageZoom,w=e.addons.classSet,C=e.DOM,b=h._,v=e.createFactory(c),g=e.createClass({displayName:"PreviewImage",propTypes:{"thumbnail-url-tmpl":e.PropTypes.string.isRequired,"file-extension":e.PropTypes.string.isRequired,"file-meta":e.PropTypes.shape({filename:e.PropTypes.string,mtime:e.PropTypes.number,formattedSize:e.PropTypes.string}).isRequired,gifUrl:e.PropTypes.string,imagesToPreload:e.PropTypes.array,onLoad:e.PropTypes.func,onError:e.PropTypes.func,"log-time-to-interactive":e.PropTypes.bool,isFullscreen:e.PropTypes.bool},getInitialState:function(){return{imageVisibility:"hidden",imageLoadError:!1}},_logPreviewEvent:function(e){return s.logEvent(e)},_logOpen:function(){return f.log("open",{file_ext:this.props["file-extension"]})},_preloadImages:function(e){var t,n,o,s,r;if(null!=e){for(n=new i,s=[],t=0,o=e.length;o>t;t++)r=e[t],s.push(n.preload_image(m.getSizedImageUrl(r)));return s}},_onImageLoad:function(){var e,n,i;return this._logPreviewEvent(_.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(_.FILE_PREVIEW_RENDER_SUCCEEDED),n=t(".preview-image-container"),e=n.find(".preview-image"),this.props["log-time-to-interactive"]&&d.mark_time_to_interactive(),this.setState({imageVisibility:"visible"}),this._shouldDisableZoom()||e.off("click").on("click",this._onFullscreen),"function"==typeof(i=this.props).onLoad?i.onLoad():void 0},_onFullscreen:function(){return null!=this.props.isFullscreen?r.openFullscreen():y.open(this.props["thumbnail-url-tmpl"],this._gifUrlOrResizedUrl(),this.props["file-extension"])},_gifUrlOrResizedUrl:function(){return null!=this.props.gifUrl?this.props.gifUrl:m.getSizedImageUrl(this.props["thumbnail-url-tmpl"])},_onImageError:function(){var e;return this._logPreviewEvent(_.FILE_PREVIEW_DOWNLOAD_FAILED),"function"==typeof(e=this.props).onError&&e.onError(),this.setState({imageLoadError:!0})},_shouldDisableZoom:function(){return p.msie_version_at_most(9)},componentWillUnmount:function(){return null==this.props.isFullscreen?y.close():void 0},componentWillMount:function(){return this._preloadImages(this.props.imagesToPreload),this._logPreviewEvent(_.FILE_PREVIEW_SUPPORT_CONFIRMED)},componentDidMount:function(){return this._logOpen()},componentWillReceiveProps:function(e){return this._preloadImages(e.imagesToPreload),this.props["thumbnail-url-tmpl"]!==e["thumbnail-url-tmpl"]?(this._logPreviewEvent(_.FILE_PREVIEW_SUPPORT_CONFIRMED),this._logOpen(),this.setState(this.getInitialState())):void 0},_renderPreviewImage:function(){var e;return e={"preview-image-container":!0,"flex-preview-container":!0,"flex-preview-container--padded":!0,"zoom-disabled":this._shouldDisableZoom()},C.div({className:w(e)},C.div({className:"preview-image-wrapper preview-content"},C.img({className:"preview-image absolute-center",src:this._gifUrlOrResizedUrl(),style:{visibility:this.state.imageVisibility},onLoad:this._onImageLoad,onError:this._onImageError})))},_renderPreviewBlank:function(){var e;

return e=this.props["file-meta"],v({filename:e.filename,created:new Date(1e3*e.mtime),size:e.formattedSize})},render:function(){return this.state.imageLoadError?this._renderPreviewBlank():this._renderPreviewImage()}}),{PreviewImage:g}})}.call(this),function(){define("modules/clean/react/previews/preview_image_with_annotations",["external/react","jquery","modules/clean/analytics","modules/clean/annotations/preview_image_annotations_toolbar","modules/clean/image_cache","modules/clean/image_preview_util","modules/clean/image_size","modules/clean/image_annotations","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/utils","modules/clean/react/previews/preview_blank","modules/clean/react/previews/preview_image_zoom","modules/clean/web_timing_logger","modules/core/browser","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_){var m,f,v,g,y,b,w,C,E,S,T,A;return v=n.PreviewActivityLogger,A=r.image_best_fit_size,f=c.PreloadHelpers,b=d.PreviewImageZoom,S=e.addons.classSet,T=e.DOM,E=_._,C=1.25,w="40px 36px 108px",m=16,g=e.createFactory(u),y=e.createClass({displayName:"PreviewImageWithAnnotations",propTypes:{"thumbnail-url-tmpl":e.PropTypes.string.isRequired,"file-extension":e.PropTypes.string.isRequired,"file-meta":e.PropTypes.shape({filename:e.PropTypes.string,mtime:e.PropTypes.number,formattedSize:e.PropTypes.string}).isRequired,gifUrl:e.PropTypes.string,imagesToPreload:e.PropTypes.array,onLoad:e.PropTypes.func,onError:e.PropTypes.func,"log-time-to-interactive":e.PropTypes.bool,isFullscreen:e.PropTypes.bool,index:e.PropTypes.number,count:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func,"should-display-annotations-toolbar":e.PropTypes.bool},getInitialState:function(){return this.props["should-display-annotations-toolbar"]?{imageVisibility:"hidden",imageLoadError:!1,fullSizeImage:!1,width:"",height:"",zoomPercent:0,minimumZoomPercent:0,margin:"auto",padding:w}:{imageVisibility:"hidden",imageLoadError:!1}},_logOpen:function(){return v.log("open",{file_ext:this.props["file-extension"]})},_preloadImages:function(e){var t,n,i,s,r;if(null!=e){for(n=new o,s=[],t=0,i=e.length;i>t;t++)r=e[t],s.push(n.preload_image(f.getSizedImageUrl(r)));return s}},_onImageLoad:function(){var e;return this.$fullsizeImage=null,this.$image=this.imagePreviewUtil.getPreviewImage(),this.props["log-time-to-interactive"]&&p.mark_time_to_interactive(),this.setState({imageVisibility:"visible"}),this.imageAnnotations.onImageLoad(this.switchImage,this.onResizeImage),this._shouldDisableZoom()||this.$image.off("click").on("click",this._onFullscreen),this.props["should-display-annotations-toolbar"]&&(this.$fullsizeImage=new Image,this.$fullsizeImage.src=this._gifUrlOrResizedUrl(!0),this.$fullsizeImage.on("load",this._onFullsizeLoad)),"function"==typeof(e=this.props).onLoad?e.onLoad():void 0},_onFullscreen:function(){var e;return e={file_ext:this.props["file-extension"]},null!=this.props.isFullscreen?l.openFullscreen(e):b.open(this.props["thumbnail-url-tmpl"],this._gifUrlOrResizedUrl(),this.props["file-extension"])},_gifUrlOrResizedUrl:function(e){return null==e&&(e=!1),null!=this.props.gifUrl?this.props.gifUrl:f.getSizedImageUrl(this.props["thumbnail-url-tmpl"],e||this.state.fullSizeImage)},_onImageError:function(){var e;return"function"==typeof(e=this.props).onError&&e.onError(),this.setState({imageLoadError:!0})},_shouldDisableZoom:function(){var e;return h.msie_version_at_most(9)||(null!=(e=this.imageAnnotations)?e.isImagePreviewAnnotationCreationEnabled:void 0)},_onFullsizeLoad:function(){var e;return e=this._calculateZoomPercent(this.$image.height()),this.setState({zoomPercent:e,minimumZoomPercent:e,fullSizeImage:!0})},onResizeImage:function(){var e;return""===this.state.width&&""===this.state.height?(e=this._calculateZoomPercent(this.$image.height()),this.setState({zoomPercent:e,minimumZoomPercent:e})):void 0},_onZoom:function(e,t){var n,i,o,s,r,a,l,c,u,d,p,h,_,f,v;return e+"px"!==this.state.width?(v=this._calculateZoomPercent(t),v<this.state.minimumZoomPercent?void this._onZoomFit():v>m?(o=m*this.$fullsizeImage.naturalWidth,i=m*this.$fullsizeImage.naturalHeight,void this._onZoom(o,i)):(u=this.$image.width(),d=e/u,n=this.imagePreviewUtil.getPreviewImageWrapper(),l=n.scrollLeft(),c=n.scrollTop(),h=n.width(),p=n.height(),r=h*(d-1)/2+l*d,a=p*(d-1)/2+c*d,f=t>=p?"0":"auto",_=e>=h?"0":"auto",s=f+" "+_,this.setState({fullSizeImage:null!=this.$fullsizeImage,width:e+"px",height:t+"px",margin:s,zoomPercent:v,padding:"0"},function(){var e;return n.scrollLeft(r),n.scrollTop(a),this.imageAnnotations.onResize(e=!1)}))):void 0},_onZoomIn:function(){var e,t;return t=this.$image.width()*C,e=this.$image.height()*C,this._onZoom(t,e)},_onZoomOut:function(){var e,t;return t=this.$image.width()/C,e=this.$image.height()/C,this._onZoom(t,e)},_onZoomOriginalOrFit:function(){return 1===this.state.zoomPercent?this._onZoomFit():this._onZoomOriginal()},_onZoomOriginal:function(){var e,t;return t=this.$image.prop("naturalWidth"),e=this.$image.prop("naturalHeight"),this._onZoom(t,e)},_onZoomFit:function(){return""!==this.state.width?this.setState({width:"",height:"",margin:"auto",padding:w},function(){var e,t;return this.imageAnnotations.onResize(e=!1),t=this._calculateZoomPercent(this.$image.height()),this.setState({zoomPercent:t,minimumZoomPercent:t})}):void 0},_calculateZoomPercent:function(e){var t,n;return this.$fullsizeImage?(t=this.$fullsizeImage.naturalHeight,e&&t?n=e/t:void 0):void 0},switchImage:function(e,t){var n;return e===this.props["thumbnail-url-tmpl"]&&(n=!0),this.setProps({"thumbnail-url-tmpl":e,onLoad:t},function(e){return function(){return n?e._onImageLoad():void 0}}(this))},componentWillUnmount:function(){var e;return null==this.props.isFullscreen&&b.close(),null!=(e=this.imageAnnotations)?e.reset():void 0},componentWillMount:function(){return this._preloadImages(this.props.imagesToPreload),this.imageAnnotations=new a,this.imagePreviewUtil=new s},componentDidMount:function(){return this._logOpen()},componentWillReceiveProps:function(e){return this.props["should-display-annotations-toolbar"]&&e["thumbnail-url-tmpl"]!==this.props["thumbnail-url-tmpl"]&&(this.imageAnnotations.removeAnnotations(),this.setState({width:"",height:"",margin:"auto",padding:w,fullSizeImage:!1})),this._preloadImages(e.imagesToPreload),this._logOpen()},_renderAnnotationsToolbar:function(){return e.createElement(i,{index:this.props.index,count:this.props.count,zoomPercent:this.state.zoomPercent,minimumZoomPercent:this.state.minimumZoomPercent,maximumZoomPercent:m,onPrevious:this.props.onPrevious,onNext:this.props.onNext,onFullscreen:this._onFullscreen,onZoomIn:this._onZoomIn,onZoomOut:this._onZoomOut,onZoomOriginalOrFit:this._onZoomOriginalOrFit})},_renderPreviewImage:function(){var e,t,n,i;return t={},t[""+this.imagePreviewUtil.PREVIEW_IMAGE_CONTAINER]=!0,t["flex-preview-container"]=!0,t["annotations-visible"]=!0,t["zoom-disabled"]=this._shouldDisableZoom(),t["has-annotations-toolbar"]=this.props["should-display-annotations-toolbar"],e=t,i={visibility:this.state.imageVisibility},this.props["should-display-annotations-toolbar"]&&(i={visibility:this.state.imageVisibility,maxWidth:this.state.width,maxHeight:this.state.height,width:this.state.width,height:this.state.height,margin:this.state.margin},n={padding:this.state.padding}),T.div({className:S(e),style:n},T.div({className:this.imagePreviewUtil.PREVIEW_IMAGE_WRAPPER+" preview-content"},T.img({className:this.imagePreviewUtil.PREVIEW_IMAGE+" absolute-center",src:this._gifUrlOrResizedUrl(),style:i,onLoad:this._onImageLoad,onError:this._onImageError})),this.props["should-display-annotations-toolbar"]?this._renderAnnotationsToolbar():void 0)},_renderPreviewBlank:function(){var e;return e=this.props["file-meta"],g({filename:e.filename,created:new Date(1e3*e.mtime),size:e.formattedSize})},render:function(){return this.state.imageLoadError?this._renderPreviewBlank():this._renderPreviewImage()}}),{PreviewImageWithAnnotations:y}})}.call(this),function(){define("modules/clean/react/previews/preview_image_zoom",["external/jquery.mousewheel","external/jquery.fs.zoomer","external/react","jquery","modules/clean/loggers/file_preview_logger","modules/clean/react/image","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/utils","modules/clean/react/helpers","modules/clean/react/previews/preview_zoom_container","modules/clean/static_urls","modules/core/browser","modules/core/dom","modules/core/exception","modules/core/uri","modules/core/i18n"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f){var v,g,y,b,w,C,E,S,T,A;return g=a.EventTypes,y=l.PreloadHelpers,E=c.compareStateAndProps,A=d.static_url,S=n.addons.classSet,T=n.DOM,C=f._,w=n.createFactory(u),v="preview-image-zoomzoom-wrapper",b=n.createClass({statics:{open:function(e,t,o){var s,a,l;return l=i("<div />",{id:v}),i(document.body).append(l),a=b({thumbnailUrlTmpl:e,lastImageUrl:t,fileExtension:o,isFlippable:!1}),s={file_ext:o},r.openFullscreenLogging(s),n.render(a,l.get(0))},close:function(){var e;return e=document.getElementById(v),e?n.unmountComponentAtNode(e):void 0}},displayName:"PreviewImageZoom",propTypes:{thumbnailUrlTmpl:n.PropTypes.string,lastImageUrl:n.PropTypes.string,fileExtension:n.PropTypes.string,isFlippable:n.PropTypes.bool},getInitialState:function(){return{loadedFullResolutionImageUrl:null,zoomOutDisabled:!0,zoomInDisabled:!1,dragDisabled:!0}},componentWillMount:function(){return this._logPreviewEvent(g.FILE_PREVIEW_SUPPORT_CONFIRMED),this._setupImage(this.props.thumbnailUrlTmpl)},componentWillReceiveProps:function(e){return e.thumbnailUrlTmpl!==this.props.thumbnailUrlTmpl?(this._logPreviewEvent(g.FILE_PREVIEW_SUPPORT_CONFIRMED),this.setState({loadedFullResolutionImageUrl:null}),this._destroyZoomer(),this._setupImage(e.thumbnailUrlTmpl)):void 0},componentWillUnmount:function(){return this._destroyZoomer(),i(window).off("resize.zommer")},shouldComponentUpdate:E,_logPreviewEvent:function(e){return o.logEvent(e)},_setupImage:function(e){return this.fullResolutionImage=new window.Image,this.fullResolutionImage.onload=this._onFullResolutionImageLoaded,this.fullResolutionImage.onerror=this._onFullResolutionImageError,this.fullResolutionImage.src=y.getSizedImageUrl(e,!0)},_onFullResolutionImageLoaded:function(){return this.isMounted()?(this._logPreviewEvent(g.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(g.FILE_PREVIEW_RENDER_SUCCEEDED),this.setState({loadedFullResolutionImageUrl:this.fullResolutionImage.src},this._bindZoomer)):void 0},_onFullResolutionImageError:function(){return this._logPreviewEvent(g.FILE_PREVIEW_DOWNLOAD_FAILED),_.assert("Error loading full resoltuion image in zoom view")},_bindZoomer:function(){var e,t;return t=i(".preview-zoom").width(),window.zoomer(i(this.refs.previewZoomer.getDOMNode()),{controls:{zoomIn:i(this.refs.previewZoomContainer.refs.zoomControlZoomIn.getDOMNode()),zoomOut:i(this.refs.previewZoomContainer.refs.zoomControlZoomOut.getDOMNode()),zoomLabel:i(this.refs.previewZoomContainer.refs.zoomLabel.getDOMNode()),zoomLabelContainer:i(this.refs.previewZoomContainer.refs.zoomLabelContainer.getDOMNode())},customClass:"preview-zoomer-style",retina:window.devicePixelRatio>1,onZoomCallback:this._onZoomCallback,startWidth:t}),null==this.fitToZoom&&(this.fitToZoom=this._getZoomPercent()),i(window).off("resize.zoomer").on("resize.zoomer",function(e){return function(){var t;return zoomer(i(null!=(t=e.refs.previewZoomer)?t.getDOMNode():void 0),"resize"),e.fitToZoom=e._getZoomPercent()}}(this)),i(null!=(e=this.refs.previewZoomer)?e.getDOMNode():void 0).off("mousewheel.zoom").on("mousewheel.zoom",function(e){return function(t,n){return t.preventDefault(),e._zoomScroll(n*t.deltaFactor)}}(this))},_destroyZoomer:function(){var e;return window.zoomer(i(null!=(e=this.refs.previewZoomer)?e.getDOMNode():void 0),"destroy")},_onZoomCallback:function(e){return this.setState({zoomOutDisabled:e.atMinZoom,zoomInDisabled:e.atMaxZoom,dragDisabled:e.atMinZoom})},_getZoomPercent:function(){return parseFloat(i(this.refs.previewZoomContainer.refs.zoomLabel.getDOMNode()).text())},_zoomToFit:function(){var e;return i(null!=(e=this.refs.previewZoomContainer.refs.zoomControlZoomOut)?e.getDOMNode():void 0).trigger("zoomout")},_zoom100:function(e,t){var n;return zoomer(i(null!=(n=this.refs.previewZoomer)?n.getDOMNode():void 0),"zoom100",e,t)},_zoomScroll:function(e){var t;return zoomer(i(null!=(t=this.refs.previewZoomer)?t.getDOMNode():void 0),"zoomScroll",e)},_unmount:function(){var e,t;return this.props.isFlippable?r.closeFullscreen():(t=this.getDOMNode().parentNode,n.unmountComponentAtNode(t),i(t).remove(),e={file_ext:this.props.fileExtension},r.closeFullscreenLogging(e))},_onImageDoubleClick:function(e){var t;return i(e.target).hasClass("zoomer")?void 0:this._getZoomPercent()<100?(t=e.target.getBoundingClientRect(),this._zoom100(e.pageX-t.left,e.pageY-t.top)):this._zoomToFit()},_renderImage:function(){var e;return e=null,null!=this.state.loadedFullResolutionImageUrl&&(e={maxHeight:i(".preview-zoom").height(),maxWidth:i(".preview-zoom").width()}),T.div({ref:"previewZoomer",className:"preview-zoomer",style:{textAlign:"center"},onDoubleClick:null!=this.state.loadedFullResolutionImageUrl?this._onImageDoubleClick:void 0},T.img({className:"preview-zoom",src:this.state.loadedFullResolutionImageUrl||this.props.lastImageUrl,style:e}))},_renderLoading:function(){return T.div({className:"preview-zoomer-loading"},s({alt:C("Loading..."),src:A("/static/images/icons/white-on-dark-spinner-vflInam4o.gif"),srcHiRes:A("/static/images/icons/white-on-dark-spinner@2x-vfltkzAUn.gif")}))},render:function(){var e;return e=null!=this.state.loadedFullResolutionImageUrl?"zoomer-image":null!=p.mozilla?"preview-zoomer-loading":"preview-zoom",w({isFlippable:this.props.isFlippable||!1,renderZoomControls:null!=this.state.loadedFullResolutionImageUrl,onClose:this._unmount,containerClass:e,zoomOutCallback:this._zoomToFit,zoomInDisabled:this.state.zoomInDisabled,zoomOutDisabled:this.state.zoomOutDisabled,dragDisabled:this.state.dragDisabled,ref:"previewZoomContainer"},null!=p.mozilla&&null==this.state.loadedFullResolutionImageUrl?this._renderLoading():this._renderImage())}}),{PreviewImageZoom:b}})}.call(this),function(){define("modules/clean/react/previews/preview_linkfile",["external/react","jquery","modules/clean/analytics","modules/clean/ajax","modules/clean/em_string","modules/clean/filepath","modules/clean/loggers/file_preview_logger","modules/clean/previews/file_viewer_utils","modules/clean/react/file_viewer/constants","modules/clean/react/sprite","modules/clean/referrer_cleansing_redirect","modules/clean/web_timing_logger","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w;return m=n.LinkfileActivityLogger,w=s.filename_without_extension,b=s.file_extension,_=l.EventTypes,g=e.addons.classSet,y=e.DOM,v=p._,f=e.createClass({displayName:"PreviewLinkfile",propTypes:{filename:e.PropTypes.string.isRequired,"linkfile-data-link":e.PropTypes.string,"authenticated-data-link":e.PropTypes.bool.isRequired,source:e.PropTypes.string.isRequired,"log-time-to-interactive":e.PropTypes.bool},FILE_VIEWER_OPEN_PREVIEW_EVENT:"db:filepreview:open",FILE_VIEWER_CLOSE_PREVIEW_EVENT:"db:filepreview:close",SPINNER_FADE_DELAY_MSEC:150,MAX_DISPLAYED_FILENAME_CHARS:21,getInitialState:function(){return{description:null,hadError:!1,link:null}},_logEvent:function(e,t,n,i){var o;return null==i&&(i={}),o=null!=t?h.parse(t).getAuthority():null,m.log(e,b(this.props.filename),o,n,this.props.source,i)},_logPreviewEvent:function(e){return r.logEvent(e)},_isFileDataFetched:function(){return null==this.state.description},componentWillMount:function(){return this._logPreviewEvent(_.FILE_PREVIEW_SUPPORT_CONFIRMED)},componentDidMount:function(){var e;return this.props["log-time-to-interactive"]&&d.mark_time_to_interactive(),e=a.getFileViewerElement(),e.on(this.FILE_VIEWER_OPEN_PREVIEW_EVENT,this.handlePreviewOpen),e.on(this.FILE_VIEWER_CLOSE_PREVIEW_EVENT,this.handlePreviewClose),null!=this.props["linkfile-data-link"]?this.requestLinkfileData(this.props["linkfile-data-link"]):void 0},componentWillUnmount:function(){var e,t,n;return e=a.getFileViewerElement(),e.off("db:filepreview:open",this.handlePreviewOpen),e.off("db:filepreview:close",this.handlePreviewClose),this._logEvent("destroy",t=this.state.link,n=!0)},requestLinkfileData:function(e){var t,n,o;return this._logEvent("requestlinkdata",t=null,o=!0),n={url:e,dataType:"json",success:this.handleLinkDataSuccess,error:this.handleLinkDataError},this.props["authenticated-data-link"]?(n.xhrFields={withCredentials:!0},i.AuthenticatedRequest(n)):i.Request(n)},handlePreviewOpen:function(e,t){return null!=t.linkfile_link?this.requestLinkfileData(t.linkfile_link):this.handleLinkDataError()},handlePreviewClose:function(){var e,t;return this._logEvent("close",e=this.state.link,t=!0)},handleLinkDataSuccess:function(e){var t,n;return null==e.uri?void this.handleLinkDataError():(this._logEvent("displaylinkdata",t=e.uri,n=!0),this._logPreviewEvent(_.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this.setState({description:e.uri,hadError:!1,link:e.uri}),this._logPreviewEvent(_.FILE_PREVIEW_RENDER_SUCCEEDED))},handleLinkDataError:function(){var e,t;return this._logEvent("displaylinkerror",e=null,t=!1),this._logPreviewEvent(_.FILE_PREVIEW_DOWNLOAD_FAILED),this.setState({description:v("Can’t show link. Something’s wrong with this file."),hadError:!0,link:null})},handleClickOpenLinkButton:function(){var e,t,n;return null!=this.state.link?(this._logEvent("navlink",e=this.state.link,n=!0),t=u.get_redirect_uri(this.state.link),window.open(t,"_blank")):void 0},render:function(){var e,t,n,i,s,r,a,l;return e={"preview-linkfile-content":!0,"loading-content":this._isFileDataFetched()},l={"preview-linkfile-button-openlink":!0,"button-primary":!0,"has-link":null!=this.state.link},i="-",r="",null!=this.props.filename&&(i=w(this.props.filename),r=b(this.props.filename),""!==r&&(r="."+r)),a=this.MAX_DISPLAYED_FILENAME_CHARS-r.length,s=o.em_snippet(i,a),n=null!=this.state.description?this.state.description:"-",t={"preview-linkfile-description":!0,"force-show-all-text":this.state.hadError},y.div({className:"flex-preview-container"},y.div({className:"preview-content preview-content--center"},y.div({className:"preview-linkfile-box"},y.div({className:g(e),ref:"content"},y.div({className:"preview-linkfile-icon"},y.img({src:"/static/images/icons128/page_white_linkfile-vfloEntlU.png"})),y.div({className:"preview-linkfile-title"},y.span({className:"preview-linkfile-filebase",ref:"fileBase"},s),y.span({className:"preview-linkfile-fileext",ref:"fileExt"},r)),y.div({className:"preview-linkfile-info"},y.div({className:g(t),ref:"description"},n),y.button({className:g(l),onMouseUp:this.handleClickOpenLinkButton,ref:"openLinkButton"},v("Open in new tab")))))))}}),{PreviewLinkfile:f}})}.call(this),function(){define("modules/clean/react/previews/preview_password_protected",["external/react","jquery","modules/clean/datetime","modules/clean/frame_messenger","modules/clean/react/previews/password_component","modules/clean/react/previews/preview_html","modules/clean/react/sprite","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_,m,f,v;return f=e.DOM,m=f.div,v=f.span,_=a._,d=e.createFactory(o),p=e.createFactory(s),u="previewhtml",c=["incorrect_password"],h=e.createClass({displayName:"PreviewPasswordProtected",propTypes:{icon:e.PropTypes.string,filename:e.PropTypes.string.isRequired,fileExtension:e.PropTypes.string.isRequired,created:e.PropTypes.object,size:e.PropTypes.string,fileUrl:e.PropTypes.instanceOf(l),previewType:e.PropTypes.string.isRequired},getDefaultProps:function(){return{icon:"page_white_picture_32"}},getInitialState:function(){return{hasLoadError:!1,passwordSubmitted:!1,passwordAttempts:0,passwordStr:null}},_passwordChanged:function(e){return this.setState({passwordSubmitted:!0,passwordStr:e})},_handleTrustedMessageFromChild:function(e){switch(e.action){case"incorrect_password":return this.setState({passwordSubmitted:!1,passwordAttempts:this.state.passwordAttempts+1})}},componentDidMount:function(){return this._frameMessenger=new i,this._frameMessenger.configureChildMessaging("iframe."+u,this._handleTrustedMessageFromChild,c),this._frameMessenger.startListening()},componentWillUnmount:function(){return this._frameMessenger.stopListening()},_onLoadError:function(){return this.setState({hasLoadError:!0,passwordSubmitted:!1})},_renderCreatedTime:function(){return[v({},n.format_date(this.props.created,"MMMM dd, yyyy hh:mm a")),v({className:"bottom-dot"}," · ")]},_renderSize:function(){return v({},this.props.size)},_renderLoadError:function(){return v({className:"preview-password-protected-error"},_("Failed to generate preview"))},_renderInvalidPassword:function(){return v({className:"preview-password-protected-error"},_("Invalid password, please try again."))},_renderPasswordMessage:function(){return v({className:"preview-blank-title"},_("Please enter this document’s password to view it."))},_renderHtml:function(){var e,t,n;return n=this.props.fileUrl,n.updateQuery({generate_preview:1}),n.updateQuery({password_str:this.state.passwordStr}),n.setAuthority(n.getAuthority().replace("dl-web","dl-doc")),e=this._onLoadError,t=this.props.previewType,p({src:n,previewType:t,onError:e,isFullscreen:!1,fileExtension:this.props.fileExtension})},render:function(){var e;return this.state.passwordSubmitted?this._renderHtml():m({className:"preview-blank-container"},m({className:"preview-blank-wrapper"},m({className:"preview-blank-icon"},r({group:"web",name:this.props.icon})),m({className:"preview-blank-title"},this.props.filename),m({className:"preview-blank-info"},null==this.props.created||isNaN(null!=(e=this.props.created)?e.getTime():void 0)?void 0:this._renderCreatedTime(),null!=this.props.size&&""!==this.props.size?this._renderSize():void 0),this.state.hasLoadError?this._renderLoadError():this.state.passwordAttempts>0?this._renderInvalidPassword():this._renderPasswordMessage(),this.state.hasLoadError?void 0:d({onPasswordSubmit:this._passwordChanged})))}})})}.call(this),function(){define("modules/clean/react/previews/preview_pdf",["external/react","jquery","modules/constants/legacy","modules/core/i18n","modules/core/uri","modules/clean/ajax","modules/clean/components/loading_indicator","modules/clean/filepath","modules/clean/keycode","modules/clean/loggers/file_preview_logger","modules/clean/previews/pdf_loader","modules/clean/previews/preview_actions_helper","modules/clean/previews/preview_status_watcher","modules/clean/previews/util","modules/clean/react/helpers","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/full_screen_helpers","modules/clean/react/previews/preview_toolbar"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v){var g,y,b,w,C,E,S,T,A,I,k,P,N,R,x,O;return g=n.DOC_PREVIEW_AVAILABLE,y=n.DOC_PREVIEW_IN_PROGRESS,b=n.DOC_PREVIEW_UNAVAILABLE_BAD_FILE,P=i._,S=d.PreviewActions,E=h.PermissionHelper,T=h.PreviewHelper,N=_.compareStateAndProps,w=m.EventTypes,C=f.FullscreenHelpers,k=v.ReactPreviewToolbarClass,O=e.DOM,R=O.div,x=O.iframe,I=e.createFactory(k),A=e.createClass({displayName:"PreviewPDF",propTypes:{src:e.PropTypes.string.isRequired,fileExtension:e.PropTypes.string.isRequired,fqPath:e.PropTypes.string,onCloseViewer:e.PropTypes.func,onError:e.PropTypes.func,onLogView:e.PropTypes.func,previewStatus:e.PropTypes.number,previewType:e.PropTypes.string,userId:e.PropTypes.number,isFullscreen:e.PropTypes.bool},getDefaultProps:function(){return{fqPath:null,onError:null,onLogView:null,previewStatus:y,previewType:"",userId:0}},getInitialState:function(){return{keydownRegistered:!1,loading:!0}},componentWillMount:function(){return this.pdfLoader=new u,this.pdfLoader.setIsFullscreen(this.props.isFullscreen),this.pdfLoader.setExitFullscreenCallback(this._exitFullscreenCallback),this.pdfLoader.setOnDownloadFailed(this._onDownloadFailed),this.pdfLoader.setOnDownloadSucceeded(this._onDownloadSucceeded),this.pdfLoader.setOnRenderFailed(this._onRenderFailed),this.pdfLoader.setOnRenderSucceeded(this._onRenderSucceeded),this._logPreviewSupportConfirmed()},componentDidMount:function(){var e,n,i,o,s;if(this.pdfLoader.startListening(),o=T.extCanGeneratePreview(this.props.fileExtension),this.props.previewStatus===g)"function"==typeof(e=this.props).onLogView&&e.onLogView(!1),this.setState({loading:!1});else if(this.props.previewStatus!==b&&o)"function"==typeof(n=this.props).onLogView&&n.onLogView(!1),this.setState({loading:!1});else{if(this.props.previewStatus!==y||null==this.props.userId||null==this.props.fqPath)return void("function"==typeof(i=this.props).onError&&i.onError());this.statusWatcher=new p,this.statusWatcher.start(this.props.userId,this.props.fqPath,this._didFinishStatusCheck,this._failedStatusCheck)}return C.setupFullscreen(this.props.isFullscreen),this.state.loading||this.state.keydownRegistered?void 0:(t(document).on("keydown",null!=(s=this.refs.previewToolbar)?s.onKeydown:void 0),this.setState({keydownRegistered:!0}))},shouldComponentUpdate:N,componentWillReceiveProps:function(){return this._logPreviewSupportConfirmed()},componentDidUpdate:function(){var e;return this.state.loading||this.state.keydownRegistered?void 0:(t(document).on("keydown",null!=(e=this.refs.previewToolbar)?e.onKeydown:void 0),this.setState({keydownRegistered:!0}))},componentWillUnmount:function(){var e,n;return this.pdfLoader.stopListening(),null!=(e=this.statusWatcher)&&e.stop(),this.props.isFullscreen&&C.teardownExitFullscreenListeners(),t(document).off("keydown",null!=(n=this.refs.previewToolbar)?n.onKeydown:void 0)},_logPreviewSupportConfirmed:function(){return c.logEvent(w.FILE_PREVIEW_SUPPORT_CONFIRMED)},_didFinishStatusCheck:function(){var e;return"function"==typeof(e=this.props).onLogView&&e.onLogView(!0),this.setState({loading:!1})},_failedStatusCheck:function(){var e,t;return"function"==typeof(e=this.props).onLogView&&e.onLogView(!0),"function"==typeof(t=this.props).onError?t.onError():void 0},_exitFullscreenCallback:function(){return C.setBrowserFullscreen(!1),S.exitFullscreen()},_onDownloadFailed:function(){var e;return c.logEvent(w.FILE_PREVIEW_DOWNLOAD_FAILED),"function"==typeof(e=this.props).onError?e.onError():void 0},_onDownloadSucceeded:function(){return c.logEvent(w.FILE_PREVIEW_DOWNLOAD_SUCCEEDED)},_onRenderFailed:function(){var e;return c.logEvent(w.FILE_PREVIEW_RENDER_FAILED),"function"==typeof(e=this.props).onError?e.onError():void 0},_onRenderSucceeded:function(){return c.logEvent(w.FILE_PREVIEW_RENDER_SUCCEEDED)},_renderLoading:function(){var t;return t=e.createElement(r,{style:r.LoadingIndicatorStyle.BLUE_SPINNER,className:"preview-loading-indicator"}),R({className:"preview-loading-wrapper"},t)},_renderPreview:function(){var e,t,n,i;return e=T.normalize_extension(this.props.fileExtension),t=T.get_progressive_url(e,this.props.src),n={type:"application/pdf"},n.className="pdfjs",this.props.previewStatus!==g&&(t=t.updateQuery({generate_preview:1}),t.setAuthority(t.getAuthority().replace("dl-web","dl-doc"))),this.pdfLoader.openFile(t,{presentationMode:"ppt"===e}),i=T.get_pdf_js_url(t,e),i=T.update_url_with_user_id(i,this.props.userId),i=T.update_url_for_annotation(i),n.src=i,x(n)},_renderToolbar:function(){return I({actions:S,afterFileViewerExit:this.props.onCloseViewer,fileExtension:this.props.fileExtension,fileDocPreviewStatus:this.props.previewStatus,fileHref:this.props.src,filePreviewType:this.props.previewType,ref:"previewToolbar"})},render:function(){return R({className:"preview-content"},this.state.loading?this._renderLoading():[this._renderToolbar(),this._renderPreview()])}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/previews/preview_quality_popup",["external/react","modules/core/i18n","modules/clean/react/modal","modules/clean/react/button","modules/clean/react/sprite","modules/clean/analytics","jquery","modules/clean/em_string","modules/clean/filepath","modules/core/notify","modules/clean/react/react_i18n","modules/clean/viewer","modules/constants/legacy","modules/core/exception","external/underscore"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m){var f,v,g,y,b,w,C,E,S;return w=n._,f=i.Modal,g=r.PreviewQualityPopupLogger,E=_.assert,C={ASK_IF_OK:0,ASK_TO_DONATE:1,THANK_YOU:2,FADEOUT_POPUP:3,HIDDEN:4},S=t.DOM,b=d.R_,y=t.createClass({displayName:"PreviewQualitySendFeedbackModal",statics:{showInstance:function(e){return f.showInstance(e)}},getInitialState:function(){return{file_selected:!0}},propTypes:{filename:t.PropTypes.string.isRequired,done_callback:t.PropTypes.func.isRequired,dismiss_callback:t.PropTypes.func.isRequired},render:function(){var e,t;return t=l.em_snippet(c.filename(this.props.filename),32),e=c.file_icon(this.props.filename),f({title:w("Tell us what’s wrong"),acceptButtonText:w("Send feedback"),dismissButtonText:w("Cancel"),autoClose:!1,showX:!0,onAccept:this._onDone,onDismiss:this._onDismiss,ref:"modal"},S.div({className:"send_feedback_modal_content"},S.textarea({className:"feedback",name:"feedback",id:"feedback",maxLength:255,readOnly:!1,placeholder:w("My document doesn’t look right because...")}),S.div({className:"file_selection",onClick:this._fileCheckClick},S.div({className:"file_check"},S.input({type:"checkbox",checked:this.state.file_selected,onClick:this._checkboxClick,id:"file_selection_checkbox"})),S.div({className:"file_image"},s({group:"web",name:e+"_32"})),S.div({className:"file_desc"},S.div({className:"file_desc_container"},S.div({className:"main"},b({filename:t},"Include <b>%(filename)s</b>")),S.div({className:"disclaimer"},w("The Dropbox team will review your document. It will only be used to help improve previews.")))))))},_onDone:function(){var e;return e=a("#feedback").val(),this.props.done_callback(this.state.file_selected,e),this.refs.modal.close()},_onDismiss:function(){return this.props.dismiss_callback(),this.refs.modal.close()},_checkboxClick:function(e){return this.setState({file_selected:!this.state.file_selected}),e.stopPropagation()},_fileCheckClick:function(e){return this.setState({file_selected:!this.state.file_selected}),e.stopPropagation()}}),v=t.createClass({displayName:"PreviewQualityPopup",propTypes:{showalways:t.PropTypes.bool,file:t.PropTypes.object},getDefaultProps:function(){return{showalways:!1,file:null}},_SHOW_THRESHOLD:1,_BLOCKED_FILE_EXTENSIONS:["url","webloc","website"],componentDidMount:function(){return null==this.props.file?a(document).on("db:filepreview:previewupdate",this._handleStateChange):this._handleFile(this.props.file)},componentWillUnmount:function(){return null==this.props.file?a(document).off("db:filepreview:previewupdate",this._handleStateChange):void 0},getInitialState:function(){return{page_state:C.HIDDEN,file_nsid:null,file_sjid:null,filename:null,doc_preview_status:null,feedback:"",is_file_donated:!1}},render:function(){return this.state.page_state===C.ASK_IF_OK?S.div({id:"preview-quality-popup",className:"preview-quality-bar fadeout"},S.div({className:"container"},S.div({className:"title"},w("Does this document look right?"),S.div({className:"resolution"},S.a({className:"looks-good-link",onMouseUp:this.handleLooksGood},w("Yes")),S.span({className:""},w("•")),S.a({className:"something-wrong-link",onMouseUp:this.handleMarkedBad},w("No")))),S.div({className:"hide_button"},S.a({onMouseUp:this.handleDismissPopup},s({group:"web",name:"x"})))),S.hr({className:"separator"})):S.div({id:"preview-quality-dummy",className:"hidden"})},handleDismissPopup:function(){return this._logCurrentState("dismiss_popup"),this.setState({page_state:C.HIDDEN})},handleLooksGood:function(){return this._logCurrentState("good"),this.setState({page_state:C.HIDDEN})},handleMarkedBad:function(){var e;return this._logCurrentState("marked_bad"),this.setState({page_state:C.ASK_TO_DONATE}),
e=t.createElement(y,{filename:this.state.filename,done_callback:this._modal_callback_ok,dismiss_callback:this._modal_callback_dismiss}),y.showInstance(e)},_modal_callback_ok:function(e,t){return e?this._logCurrentState("bad_donated",t):this._logCurrentState("bad_no_donate",t),u.success(w("Thanks! Your feedback will help improve Dropbox."),3),this.forceUpdate(),this.setState({page_state:C.THANK_YOU})},_modal_callback_dismiss:function(){return this._logCurrentState("cancel_dialog"),this.setState({page_state:C.ASK_IF_OK})},_randomNum:function(e,t){return null==t&&(t=0),Math.random()*(e-t)+t},_shouldShow:function(t){var n,i;return i=t.toLowerCase(),e.call(this._BLOCKED_FILE_EXTENSIONS,i)>=0?!1:this.props.showalways===!0?!0:(n=this._randomNum(100),n<=this._SHOW_THRESHOLD)},_handlePreviewOpen:function(e,t){return this._shouldShow(t)?(this.setState({page_state:C.ASK_IF_OK,file_nsid:e.ns_id,file_sjid:e.sjid,filename:c.filename(e.fq_path),doc_preview_status:e.doc_preview_status}),this._log("popup_shown",this._getActiveUser(e.ns_id),e.ns_id,e.sjid,t,e.doc_preview_status)):void 0},_handlePreviewFail:function(e,t){return this._log("popup_failed",this._getActiveUser(e.ns_id),e.ns_id,e.sjid,t,e.doc_preview_status)},_handleStateChange:function(t,n){var i,o,s,r,a;if(s=n.preview_state,i=n.file_obj,"open"===s){if(o=p.get_viewer().get_users(),a=m.pluck(o,"root_ns"),r=i.ns_id,e.call(a,r)>=0)return this._handleFile(i)}else if("closed"===s)return this.setState({page_state:C.HIDDEN,file_nsid:null,file_sjid:null,filename:null,doc_preview_status:null})},_handleFile:function(e){var t,n;return t=c.file_extension(c.filename(e.fq_path),!0),(n=e.doc_preview_status)===h.DOC_PREVIEW_AVAILABLE||n===h.DOC_PREVIEW_UNAVAILABLE_OTHER?this._handlePreviewOpen(e,t):this._handlePreviewFail(e,t)},_getActiveUser:function(e){var t,n,i,o,s;for(o=p.get_viewer().get_users(),n=t=0,i=o.length;i>t;n=++t)if(s=o[n],e===s.root_ns)return s;return E(!1,"bad state - must have a valid user to match ns_id")},_logCurrentState:function(e,t,n){return null==t&&(t=""),null==n&&(n=!1),this._log(e,this._getActiveUser(this.state.file_nsid),this.state.file_nsid,this.state.file_sjid,c.file_extension(this.state.filename,!0),this.state.doc_preview_status,t)},_log:function(e,t,n,i,o,s,r){return null==r&&(r=""),g.log(e,t,n,i,o,s,r)}}),{PreviewQualityPopup:v,CARD_TYPES:C}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/react/previews/preview_toolbar",["external/keymaster","external/react","jquery","modules/clean/analytics","modules/clean/frame_messenger","modules/clean/keycode","modules/clean/previews/file_view_rams_common","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/full_screen_helpers","modules/clean/react/sprite","modules/core/dom","modules/core/exception","modules/core/i18n"],function(t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C;return f=o.PreviewActivityLogger,_=c.FullscreenHelpers,b=p.assert,w=n.createElement,C=n.DOM,y=h._,v={DEFAULT:"default",SPP:"spp",SPREADSHEET:"spreadsheet",HTML:"html"},m={},m[r.ESC]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.SPACE]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.PAGE_UP]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.PAGE_DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.LEFT]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.UP]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.RIGHT]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.EQUALS]={altKey:!0,ctrlKey:!0,metaKey:!0},m[70]={altKey:!1,ctrlKey:!1,metaKey:!1},m[80]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.PLUS_EQUALS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.MINUS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.PLUS_EQUALS_FF_GERMAN]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.MINUS_FF_MAC]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.PLUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0},m[r.MINUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0},g=n.createClass({displayName:"PreviewToolbar",propTypes:{actions:n.PropTypes.func.isRequired,fileExtension:n.PropTypes.string.isRequired,pdfLink:n.PropTypes.string,afterFileViewerExit:n.PropTypes.func,fileDocPreviewStatus:n.PropTypes.number,fileHref:n.PropTypes.string,filePreviewType:n.PropTypes.string},_TOOLBAR_ENTRY_CLASSES:{PAGE_INDICATOR:"page-indicator",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",PAGE_UP:"page-up",PAGE_DOWN:"page-down",FULLSCREEN:"fullscreen",PRINT:"print"},_ELEMENT_CONFIGURATIONS:{default:["page-indicator","zoom-in","zoom-out","page-up","page-down","fullscreen","print"],spp:["page-indicator","page-up","page-down","fullscreen","print"],spreadsheet:["zoom-in","zoom-out","fullscreen","print"],html:["fullscreen","print"]},_PARENT_TO_IFRAME_ACTIONS:{ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",PAGE_UP:"page-up",PAGE_DOWN:"page-down",ENTER_FULLSCREEN:"enter-fullscreen",EXIT_VIEWER_FULLSCREEN:"exit-viewer-fullscreen",PRINT:"print",CLEAR_MOUSE_TRACKING:"clear-mouse-tracking",SCROLL_DOWN:"scroll-down",SCROLL_UP:"scroll-up",SCROLL_LEFT:"scroll-left",SCROLL_RIGHT:"scroll-right",SCREEN_DOWN:"screen-down",SCREEN_UP:"screen-up"},_FADE_TIME_MSEC:400,_IDLE_TIME_MSEC:1500,_trustedIframeDomain:null,_fadeTimeout:null,_fullscreeningTimeout:null,_idleTimeout:null,_previewOpen:!1,_frameMessenger:null,getInitialState:function(){var e;return e={pagesCount:0,currentPage:0,visible:!1,fadingOut:!1,fullscreening:!1,disabledClasses:[],docType:v.DEFAULT}},_reset:function(){return this._clearAllTimeouts(),this.setState({pagesCount:0,currentPage:0,visible:!1,fadingOut:!1,fullscreening:!1,disabledClasses:[],docType:v.DEFAULT})},_setFullscreen:function(e,t){var n,i;return(i=e?this.props.actions.enterFullscreen():this.props.actions.exitFullscreen())?(this._clearFullscreeningTimeout(),e?(l.openFullscreenLogging(t),this.fadeOut()):(l.closeFullscreenLogging(t),this.fadeIn(),this._startIdleTimeout()),this.setState({fullscreening:!0}),this._startFullscreeningTimeout(),_.setBrowserFullscreen(e),n=e?this._PARENT_TO_IFRAME_ACTIONS.ENTER_FULLSCREEN:this._PARENT_TO_IFRAME_ACTIONS.EXIT_VIEWER_FULLSCREEN,this._frameMessenger.postMessageToChildren(n)):void 0},_isViewerFullscreen:function(){return this.props.actions.isFullscreen()},_isBrowserFullscreen:function(){return null!=document.fullScreen?document.fullScreen:null!=document.webkitIsFullScreen?document.webkitIsFullScreen:null!=document.mozFullScreen?document.mozFullScreen:null!=document.msFullscreenElement||null!=document.fullscreenElement},_handleClick:function(e){var t,n,o,s,r,a;for(r={input_method:"click",file_ext:this.props.fileExtension},t=i(e.currentTarget),a=this.state.disabledClasses,o=0,s=a.length;s>o;o++)if(n=a[o],t.hasClass(n))return;return t.hasClass(this._TOOLBAR_ENTRY_CLASSES.ZOOM_IN)?this._zoomIn(r):t.hasClass(this._TOOLBAR_ENTRY_CLASSES.ZOOM_OUT)?this._zoomOut(r):t.hasClass(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP)?this._pageUp(r):t.hasClass(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN)?this._pageDown(r):t.hasClass(this._TOOLBAR_ENTRY_CLASSES.FULLSCREEN)?this._toggleFullscreen(r):t.hasClass(this._TOOLBAR_ENTRY_CLASSES.PRINT)&&this._printDocument(r),this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.CLEAR_MOUSE_TRACKING)},_handleMessageFromChild:function(e){var t,n,i,o,s;switch(i={input_method:"child-message",file_ext:this.props.fileExtension},e.action){case"page-change":if(s=this._isToolbarReadyToShow(),t=this._sanitizePageNumber(e.parameters.current_page),o=this._sanitizePageNumber(e.parameters.pages_count),0>=t||0>=o)return;if(null!=e.parameters.doc_type&&this.setState({docType:e.parameters.doc_type}),n=[],1>=t&&n.push(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP),t>=o&&n.push(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN),this.setState({currentPage:t,pagesCount:o,disabledClasses:n}),!s&&this._isToolbarReadyToShow())return this.fadeIn(),this._startIdleTimeout();break;case"idle-mouse":return this.fadeOut(),f.log("idle-mouse",i);case"active-mouse":return this.fadeIn(),f.log("active-mouse",i);case"exit-parent-fullscreen":return this._setFullscreen(!1,i);case"keydown":if(null!=e.parameters)return this.onKeydown(e.parameters);break;case"get-keydown-keys-handled-by-parent":return this._frameMessenger.postMessageToChildren("keydown-keys-handled-by-parent",{keycodes:m})}},onPreviewOpen:function(){return this._previewOpen?!0:(i(document).on("keydown",this.onKeydown),i(document).on("fullscreenchange",this.onBrowserFullscreenChange),i(document).on("webkitfullscreenchange",this.onBrowserFullscreenChange),i(document).on("msfullscreenchange",this.onBrowserFullscreenChange),i(document).on("mozfullscreenchange",this.onBrowserFullscreenChange),this._previewOpen=!0,!0)},onPreviewClose:function(){return this._previewOpen?(i(document).off("keydown",this.onKeydown),i(document).off("fullscreenchange",this.onBrowserFullscreenChange),i(document).off("webkitfullscreenchange",this.onBrowserFullscreenChange),i(document).off("msfullscreenchange",this.onBrowserFullscreenChange),i(document).off("mozfullscreenchange",this.onBrowserFullscreenChange),this._reset(),this._frameMessenger.resetOriginsForPosting(),this._previewOpen=!1,!0):!0},componentDidMount:function(){return window.addEventListener("message",this.handleViewerMessage),this._frameMessenger=new s,this._frameMessenger.configureChildMessaging(this.props.actions.getIframeQuery(),i.proxy(this._handleMessageFromChild,this),["page-change","idle-mouse","active-mouse","exit-parent-fullscreen","keydown","child-focus","get-keydown-keys-handled-by-parent"]),this._frameMessenger.startListening()},componentWillUnmount:function(){return this._clearAllTimeouts(),this._frameMessenger.stopListening(),window.removeEventListener("message",this.handleViewerMessage)},renderPageIndicatorText:function(){var e;return this.state.currentPage<1||this.state.pagesCount<1?"":(e=y(this.state.docType===v.SPP?"Slide %(current_page)s of %(pages_count)s":"Page %(current_page)s of %(pages_count)s"),e.format({current_page:this.state.currentPage,pages_count:this.state.pagesCount}))},_renderToolbarButton:function(t,n,i,o){var s,r;return e.call(this._ELEMENT_CONFIGURATIONS[this.state.docType],t)<0?C.span({style:{display:"none"}}):(s=t+" toolbar-button-entry",r=e.call(this.state.disabledClasses,t)>=0,C.div({className:s,onMouseUp:this._handleClick},C.div({className:"toolbar-tooltip"},C.div({className:"toolbar-tooltip-container"},C.div({className:"toolbar-tooltip-pointer-border"})),C.div({className:"toolbar-tooltip-container"},C.div({className:"toolbar-tooltip-body"},o)),C.div({className:"toolbar-tooltip-container"},C.div({className:"toolbar-tooltip-pointer"}))),w(u,{group:n,name:i,className:r?"disabled":"",alt:o})))},_renderPageIndicator:function(){var t;return t=this._TOOLBAR_ENTRY_CLASSES.PAGE_INDICATOR,e.call(this._ELEMENT_CONFIGURATIONS[this.state.docType],t)>=0?C.div({className:this._TOOLBAR_ENTRY_CLASSES.PAGE_INDICATOR},this.renderPageIndicatorText()):void 0},render:function(){var e,t,n,i,o,s;return e="preview-toolbar-overlay-container ",this.state.visible||(e+="hide "),this.state.fadingOut&&(e+="fadeout "),t={className:e},s=y(this.state.docType===v.SPP?"Previous slide":"Page up"),i=y(this.state.docType===v.SPP?"Next slide":"Page down"),o=this.state.docType===v.SPP?"left":"up",n=this.state.docType===v.SPP?"right":"down",C.div(t,C.div({className:"preview-toolbar-overlay",onMouseEnter:this.onMouseEnterToolbar},C.div({className:"preview-toolbar-content"},this._renderPageIndicator(),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.ZOOM_OUT,"web","zoomout",y("Zoom out")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.ZOOM_IN,"web","zoom",y("Zoom in")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PAGE_UP,"web",o,s),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PAGE_DOWN,"web",n,i),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.FULLSCREEN,"web","fullscreen",y("Fullscreen")),this._renderToolbarButton(this._TOOLBAR_ENTRY_CLASSES.PRINT,"web","print",y("Print")))))},_sanitizePageNumber:function(e){var t;return null==e?0:(t=parseInt(e),isNaN(t)?0:t)},_getOriginFromUrl:function(e){var t;return t=document.createElement("a"),t.href=e,"https://"+t.hostname},fadeOut:function(){return this.state.fadingOut||this._clearFadeTimeout(),this.setState({fadingOut:!0,tooltipClass:null}),this._startFadeTimeout()},fadeIn:function(){return this._clearIdleTimeout(),this._isViewerFullscreen()||i("html").hasClass("no-flexbox")?void 0:this._isToolbarReadyToShow()?(this._clearFadeTimeout(),this.setState({visible:!0,fadingOut:!1})):void 0},onMouseEnterToolbar:function(){return this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.CLEAR_MOUSE_TRACKING),this._clearIdleTimeout()},onKeydown:function(e){var t,n,o,s;return n=!1,!this._frameMessenger.childIsValidated()||"dbmodal"===key.getScope()||d.focus_in_input()||d.is_input(e.target)||null!=e.target&&(t=i("#file-comments"),1!==t.length&&(t=i("#photo-comments")),1===t.length&&(e.target===t[0]||i.contains(t[0],e.target)))?void 0:(s={input_method:"keydown",file_ext:this.props.fileExtension,extra:JSON.stringify({keycode:e.keyCode})},o=e.keyCode,this.state.docType!==!v.SPP||o!==r.EQUALS&&o!==r.PLUS_EQUALS_FF&&o!==r.PLUS_CHROME&&o!==r.PLUS_EQUALS_FF_GERMAN?this.state.docType!==!v.SPP||o!==r.MINUS_FF_MAC&&o!==r.MINUS_FF&&o!==r.MINUS_CHROME?o===r.LEFT?(this.state.docType===v.SPP?this._pageUp(s):this._scrollLeft(s),n=!0):o===r.RIGHT?(this.state.docType===v.SPP?this._pageDown(s):this._scrollRight(s),n=!0):o===r.PAGE_UP?(this.state.docType===v.SPP?this._pageUp(s):this._screenUp(s),n=!0):o===r.SPACE||o===r.PAGE_DOWN?(this.state.docType===v.SPP?this._pageDown(s):this._screenDown(s),n=!0):o===r.UP?(this.state.docType===v.SPP?this._pageUp(s):this._scrollUp(s),n=!0):o===r.DOWN?(this.state.docType===v.SPP?this._pageDown(s):this._scrollDown(s),n=!0):70!==o||e.ctrlKey||e.metaKey?80===o?(this._printDocument(s),n=!0):o===r.ESC&&(this._isViewerFullscreen()?this._exitFullscreen(s):this.props.afterFileViewerExit&&!this._isAnnotationBubbleShown()&&this._exitPreview(s),n=!0):(this._isViewerFullscreen()?this._exitFullscreen(s):this._enterFullscreen(s),n=!0):(this._zoomOut(s),n=!0):(this._zoomIn(s),n=!0),n&&null!=e.preventDefault&&e.preventDefault(),!n)},_isAnnotationBubbleShown:function(){return i(".annotation-bubble-container .bubble-dropdown").length>0},_startFadeTimeout:function(){return this._fadeTimeout=setTimeout(function(e){return function(){return e._fadeTimeout=null,e.setState({visible:!1,fadingOut:!1})}}(this),this._FADE_TIME_MSEC)},_clearFadeTimeout:function(){return null!=this._fadeTimeout?(clearTimeout(this._fadeTimeout),this._fadeTimeout=null):void 0},_startFullscreeningTimeout:function(){var e;return e=function(e){return function(){return e._fullscreeningTimeout=null,e.setState({fullscreening:!1})}}(this),this._fullscreeningTimeout=setTimeout(i.proxy(e,this),a.RAMS_FULLSCREEN_TRANSITION_TIME_MSEC)},_clearFullscreeningTimeout:function(){return null!=this._fullscreeningTimeout?(clearTimeout(this._fullscreeningTimeout),this._fullscreeningTimeout=null):void 0},onIdleTimeout:function(){return this._clearIdleTimeout(),this.fadeOut()},_startIdleTimeout:function(){return this._clearIdleTimeout(),this._idleTimeout=setTimeout(i.proxy(this.onIdleTimeout,this),this._IDLE_TIME_MSEC)},_clearIdleTimeout:function(){return null!=this._idleTimeout?(clearTimeout(this._idleTimeout),this._idleTimeout=null):void 0},_clearAllTimeouts:function(){return this._clearFadeTimeout(),this._clearFullscreeningTimeout(),this._clearIdleTimeout()},_isToolbarReadyToShow:function(){return this.state.currentPage>0&&this.state.pagesCount>0},onBrowserFullscreenChange:function(){var e;return e={input_method:"browser-fullscreen-exit",file_ext:this.props.fileExtension},this._isViewerFullscreen&&!this._isBrowserFullscreen()?this._setFullscreen(!1,e):void 0},_logData:function(e,t){return"string"==typeof t.input_method?f.log(e,t):b(!1,"logData not correctly formed"),"string"==typeof t.input_method},_logAndPostMessage:function(e,t,n){return this._logData(t,n)?this._frameMessenger.postMessageToChildren(e):void 0},_zoomIn:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.ZOOM_IN,"zoom-in",e)},_zoomOut:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.ZOOM_OUT,"zoom-out",e)},_pageUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.PAGE_UP,"page-up",e)},_pageDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.PAGE_DOWN,"page-down",e)},_screenUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCREEN_UP,"screen-up",e)},_screenDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCREEN_DOWN,"screen-down",e)},_scrollUp:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_UP,"scroll-up",e)},_scrollDown:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_DOWN,"scroll-down",e)},_scrollRight:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_RIGHT,"scroll-right",e)},_scrollLeft:function(e){return this._logAndPostMessage(this._PARENT_TO_IFRAME_ACTIONS.SCROLL_LEFT,"scroll-left",e)},_toggleFullscreen:function(e){return this._isViewerFullscreen()?this._exitFullscreen(e):this._enterFullscreen(e)},_enterFullscreen:function(e){return this._setFullscreen(!0,e)},_exitFullscreen:function(e){return this._setFullscreen(!1,e)},_exitPreview:function(e){var t;return this._logData("exit-preview",e)&&"function"==typeof(t=this.props).afterFileViewerExit?t.afterFileViewerExit():void 0},_printDocument:function(e){var t;return this._logData("print",e)&&(t=this.props.actions.nativePdfPrint(this.props.pdfLink?this.props.pdfLink:{doc_preview_status:this.props.fileDocPreviewStatus,href:this.props.fileHref,preview_type:this.props.filePreviewType}),!t)?this._frameMessenger.postMessageToChildren(this._PARENT_TO_IFRAME_ACTIONS.PRINT):void 0}}),{ReactPreviewToolbarClass:g,PreviewToolbarDocType:v}})}.call(this),function(){define("modules/clean/react/previews/preview_video",["external/react","jquery","modules/clean/annotations/preview_image_annotations_toolbar","modules/clean/image_size","modules/clean/loggers/file_preview_logger","modules/clean/react/helpers","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/constants","modules/clean/react/previews/preview_zoom_container","modules/clean/react/react_i18n","modules/clean/static_urls","modules/clean/video_util","modules/clean/web_timing_logger","modules/constants/viewer","modules/core/i18n","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m){var f,v,g,y,b,w,C,E,S;return E=i.image_best_fit_size,b=s.compareStateAndProps,f=a.EventTypes,S=u.static_url,w=e.addons.classSet,C=e.DOM,y=c.R_,g=e.createFactory(l),v=e.createClass({displayName:"PreviewVideo",propTypes:{"preview-url":e.PropTypes.string,"thumbnail-url-tmpl":e.PropTypes.string,"video-metadata-url":e.PropTypes.string,onLoad:e.PropTypes.func,isFullscreen:e.PropTypes.bool,"log-time-to-interactive":e.PropTypes.bool,shouldDisplayAnnotationsToolbar:e.PropTypes.bool,index:e.PropTypes.number,count:e.PropTypes.number,onPrevious:e.PropTypes.func,onNext:e.PropTypes.func},getInitialState:function(){return{error:null}},_logPreviewEvent:function(e){return o.logEvent(e)},_getSizedImageUrl:function(){return m.parse(this.props["thumbnail-url-tmpl"]).updateQuery({size:E(t(window).width(),t(window).height()),size_mode:2}).toString()},_shutdown:function(){var e,n,i;if(t(".vjs-big-play-button").blur(),null!=this._player){try{this._player.trigger("shutdown"),"Hls"===this._player.techName&&null!=(i=this._player.tech.sourceBuffer)&&i.abort(),this._player.dispose()}catch(t){e=t}return this._player=null}},_onReady:function(){var e;return e=function(){return t(".vjs-poster").show(),t(".vjs-big-play-button").show(),t(".vjs-big-play-button").focus()},setTimeout(e,0),this._logPreviewEvent(f.FILE_PREVIEW_DOWNLOAD_SUCCEEDED),this._logPreviewEvent(f.FILE_PREVIEW_RENDER_SUCCEEDED)},_onPlay:function(){return t(".vjs-poster").hide(),t(".vjs-big-play-button").hide()},_onEnded:function(){return t(".vjs-poster").show(),t(".vjs-big-play-button").show(),t(".vjs-loading-spinner").hide()},_onError:function(e){return this._shutdown(),this.setState({error:e}),this._logPreviewEvent(f.FILE_PREVIEW_DOWNLOAD_FAILED)},_embedVideoUtil:function(){var e;return e=t(this.refs.previewVideoPlayer.getDOMNode()),this._player=d.embed(e,{src:this.props["preview-url"],type:h.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:"100%",height:"100%",controls:!0,preload:"auto",poster:this._getSizedImageUrl(),metadata_link:this.props["video-metadata-url"],metadata:null,onError:this._onError,onReady:this._onReady}),this._player.on("play",this._onPlay),this._player.on("ended",this._onEnded),t(".vjs-poster").hide(),t(".vjs-big-play-button").hide()},componentDidMount:function(){var e;return this._embedVideoUtil(),"function"==typeof(e=this.props).onLoad&&e.onLoad(),this.props["log-time-to-interactive"]&&p.mark_time_to_interactive(),this._logPreviewEvent(f.FILE_PREVIEW_SUPPORT_CONFIRMED)},componentWillUpdate:function(e){return e["preview-url"]!==this.props["preview-url"]?this._shutdown():void 0},componentDidUpdate:function(e){var t;return e["preview-url"]!==this.props["preview-url"]?(this._embedVideoUtil(),"function"==typeof(t=this.props).onLoad&&t.onLoad(),this._logPreviewEvent(f.FILE_PREVIEW_SUPPORT_CONFIRMED)):void 0},componentWillUnmount:function(){return this._shutdown()},shouldComponentUpdate:b,_renderAnnotationsToolbar:function(){return e.createElement(n,{index:this.props.index,count:this.props.count,onPrevious:this.props.onPrevious,onNext:this.props.onNext})},_renderPlayer:function(){return C.div({ref:"previewVideoPlayer",className:"video-player"})},_renderError:function(){return C.div({ref:"previewVideoError",className:"preview-video-error absolute-center"},[C.img({src:S("/static/images/preview_fail-vflc3IDxf.png")}),"needflash"===this.state.error?C.div({},y({},'Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to preview this video.')):C.div({},y({},"Unable to preview this item."))])},_renderContent:function(){return null!=this.state.error?this._renderError():this._renderPlayer()},render:function(){var e;return e={"flex-preview-container":!0,"flex-preview-container--padded":!0,"has-annotations-toolbar":this.props.shouldDisplayAnnotationsToolbar},this.props.isFullscreen?g({isFlippable:!0,renderZoomControls:!1,onClose:r.closeFullscreen,containerClass:null!=this.state.error?"preview-video-error":"video-player"},this._renderContent()):C.div({ref:"previewVideoContainer",className:w(e)},C.div({className:"preview-content"},C.div({className:"absolute-center"},this._renderContent())),this.props.shouldDisplayAnnotationsToolbar?this._renderAnnotationsToolbar():void 0)}}),{PreviewVideo:v}})}.call(this),function(){define("modules/clean/react/previews/preview_zoom_container",["external/keymaster","external/react","jquery","modules/clean/components/title_bubble","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/flippable_controls","modules/clean/react/file_viewer/store","modules/clean/react/sprite","modules/core/dom","modules/core/i18n"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f;return m=t.addons.classSet,f=t.DOM,_=c._,u=t.createFactory(s),p="",d="previewzoomcontainer",h=t.createClass({displayName:"PreviewZoomContainer",propTypes:{isFlippable:t.PropTypes.bool.isRequired,renderZoomControls:t.PropTypes.bool.isRequired,onClose:t.PropTypes.func.isRequired,containerClass:t.PropTypes.string,zoomOutCallback:t.PropTypes.func,zoomInDisabled:t.PropTypes.bool,zoomOutDisabled:t.PropTypes.bool,dragDisabled:t.PropTypes.bool},getDefaultProps:function(){return{zoomInDisabled:!0,zoomOutDisabled:!0,dragDisabled:!0}},getInitialState:function(){return{controlsHidden:!1}},componentDidMount:function(){return key("esc",d,this.props.onClose),null!=this.props.zoomOutCallback&&key("space",d,this.props.zoomOutCallback),this.props.isFlippable&&(key("left",d,o.flipPrevious),key("right",d,o.flipNext)),p=key.getScope(),key.setScope(d),this._startControlsTimer(),this._hideCursor()},componentWillUpdate:function(){return key.setScope(d)},componentWillUnmount:function(){return key.clearScope(d),key.setScope(p),clearTimeout(this.controlsHideTimer),this._showCursor()},_startControlsTimer:function(){return this._showControls(),clearTimeout(this.controlsHideTimer),this.controlsHideTimer=setTimeout(function(e){return function(){return e._hideControls()}}(this),3e3)},_showControls:function(){return this._showCursor(),this.setState({controlsHidden:!1})},_hideControls:function(){return this._hideCursor(),this.setState({controlsHidden:!0})},_showCursor:function(){return n("html").removeClass("no-cursor")},_hideCursor:function(){return n("html").addClass("no-cursor")},_onClick:function(e){var t;return t="."+this.props.containerClass+", .preview-toolbar-overlay, .preview-zoomer-close",n(e.target).is(t)||0!==n(e.target).parents(t).length?void 0:(e.preventDefault(),this.props.onClose())},_onMouseMove:function(e){return 0===n(e.target).parents(".preview-toolbar-overlay").length?this._startControlsTimer():clearTimeout(this.controlsHideTimer)},_renderControls:function(){var e,t,n;return t={"toolbar-button-entry":!0,"zoom-in":!0,disabled:this.props.zoomInDisabled},n={"toolbar-button-entry":!0,"zoom-out":!0,disabled:this.props.zoomOutDisabled},e={"preview-toolbar-overlay-container":!0,hidden:this.state.controlsHidden},f.div({ref:"previewZoomerToolbarContainer",className:m(e)},f.div({className:"preview-toolbar-overlay"},f.div({className:"preview-toolbar-content"},this.props.isFlippable?u({index:""+(r.currentIndex()+1),numFlippableFiles:r.files().length,onNext:o.flipNext,onPrevious:o.flipPrevious}):void 0,this.props.renderZoomControls?[f.div({ref:"zoomControlZoomOut",className:m(n)},a({alt:_("Zoom out"),group:"web",name:"zoomout"})),f.div({ref:"zoomLabelContainer",className:"toolbar-button-entry"},i({text:_("View actual size"),direction:"north"},f.span({ref:"zoomLabel",className:"zoom-label"}))),f.div({ref:"zoomControlZoomIn",className:m(t)},a({alt:_("Zoom in"),group:"web",name:"zoom"}))]:void 0)))},_renderClose:function(){var e;return e={"preview-zoomer-close":!0,hidden:this.state.controlsHidden},f.button({ref:"previewZoomerClose",className:m(e),onClick:this.props.onClose},a({alt:_("Close"),group:"web",name:"lightbox_close"}))},render:function(){var e;return e={"preview-zoomer-container":!0,"zoomer-drag-disabled":this.props.dragDisabled},f.div({ref:"previewZoomerContainer",className:m(e),onClick:this._onClick,onMouseMove:this._onMouseMove},this.props.children,this._renderClose(),this._renderControls())}})})}.call(this),function(){define("modules/clean/react/reset_form",["external/react","external/underscore","modules/core/i18n","modules/clean/react/button","modules/clean/react/form_handlers_mixin","modules/clean/react/form_error_mixin","modules/clean/react/input","modules/clean/react/react_i18n","modules/core/browser","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m;return _=n._,m=e.DOM,d=a.R_,u=i.button,h=e.createClass({displayName:"ResetStartForm",mixins:[o,s],propTypes:{email:e.PropTypes.string,reason:e.PropTypes.string,"is-expired":e.PropTypes.bool},defaultProps:{email:"",reason:"","is-expired":!1},render:function(){return m.form({className:"password-reset-form clearfix",action:"/ajax_reset_start",onSubmit:this.handleFormSubmit},m.div({className:"password-reset-header"},_(this.props["is-expired"]?"Please change your password":"Forgot your password?")),this.props["is-expired"]?m.div({className:"password-expriation-information"},d({reason:this.props.reason},"%(reason)s See our Help Center for more information about <a href='/help/379'> password expiration</a> and <a href='/help/1973'>securing your account</a>.")):void 0,m.div({className:"password-reset-description"},_("Enter your email address to reset your password. You may need to check your spam folder or unblock no-reply@dropbox.com.")),r.text({autofocus:!0,className:"email-field",placeholder:_("Email"),name:"email",value:this.props.email,error:this.getFormError("email"),ref:"email"}),m.input({type:"hidden",value:this.props["is-expired"],name:"is_expired"}),u({className:"submit",type:"submit",disabled:this.isFormSubmitting()},_("Submit")),m.div({className:"recover-link"}),d({},"<a href='/recover'>I can’t recover my account using this page</a>"))},handleFormSuccess:function(e){return"EXPIRED"===(null!=e?e.status:void 0)?l.redirect(e.cont):c.success(_("An e-mail has been sent to %(email)s with further instructions").format({email:t.escape(this.refs.email.getValue())}))}}),p=e.createClass({displayName:"ResetFinishForm",mixins:[o,s],propTypes:{email:e.PropTypes.string,"forgot-key":e.PropTypes.string,"is-expired":e.PropTypes.bool},defaultProps:{email:"","forgot-key":"","is-expired":!1},render:function(){return m.form({className:"password-reset-form clearfix",action:"/ajax_reset_finish",onSubmit:this.handleFormSubmit},m.div({className:"password-reset-header"},_(this.props["is-expired"]?"Please change your password":"Forgot your password?")),m.div({className:"password-reset-description"},d({email:t.escape(this.props.email)},_("Please enter a new password for your <b>%(email)s</b> account."))),r.password({autofocus:!0,className:"password-field",placeholder:_("New password"),name:"password",measureStrength:!0,error:this.getFormError("password"),ref:"password"}),r.password({className:"password-field",placeholder:_("Retype password"),name:"password2"}),m.input({type:"hidden",value:this.props["forgot-key"],name:"forgot_key"}),m.input({type:"hidden",value:this.props.email,name:"email"}),m.input({type:"hidden",value:this.props["is-expired"],name:"is_expired"}),u({className:"submit",type:"submit",disabled:this.isFormSubmitting()},_("Submit")))},handleFormSuccess:function(e){switch(null!=e?e.status:void 0){case"OK":return c.success(_("Your new password has been saved")),l.redirect(e.cont);case"EXPIRED":return l.redirect(e.cont);case"SSO":return l.redirect(e.cont);case"TWOFACTOR":return l.redirect(e.cont);case"TWOFACTOR_REQUIRED":return l.redirect(e.cont);case"SMS_ERROR":return l.redirect(e.cont)}}}),{ResetStartForm:h,ResetFinishForm:p}})}.call(this),function(){define("modules/clean/react/select",["external/react","external/underscore","jquery","modules/clean/keycode","modules/clean/react/form_error_mixin","modules/clean/react/hidden","modules/clean/react/sprite","modules/clean/react/util"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f;return l=s.HiddenSelect,d=e.addons.classSet,u=e.addons.cloneWithProps,p=e.DOM,c=e.createElement,h=function(e,t){var n,i,o,s;return s=e.scrollTop(),o=s+e.height(),i=t.position().top+s,n=i+t.height(),s>i?e.scrollTop(i):n>o?e.scrollTop(n-e.height()):void 0},f=e.PropTypes.oneOfType([e.PropTypes.string,e.PropTypes.number]),m=e.createClass({displayName:"selectOption",propTypes:{className:e.PropTypes.string,disabled:e.PropTypes.bool,title:e.PropTypes.string,value:f},render:function(){var e;return e={"list-item":!0,"select-option":!0,"select-option-disabled":this.props.disabled},null!=this.props.className&&(e[this.props.className]=!0),p.div(n.extend({"data-value":this.props.value},this.props,{className:d(e)}),this.props.children)}}),_=e.createClass({displayName:"selectInput",mixins:[o],mouseInput:!0,propTypes:{name:e.PropTypes.string,onChange:e.PropTypes.func,defaultValue:f,style:e.PropTypes.object,value:f,variant:e.PropTypes.string,className:e.PropTypes.string,valueLink:e.PropTypes.object},getDefaultProps:function(){return{errorWrapperClassName:"select-input-error-wrapper",style:null}},getInitialState:function(){return{open:!1,focused:null,keyboarsSelectPrefix:"",value:this.props.defaultValue}},_getFilteredChildren:function(){return t.isArray(this.props.children)?t.filter(this.props.children,function(e){return e}):this.props.children},render:function(){var t,n;return t={"select-input":!0,"select-input-dropdown-shown":this.state.open},
this.props.variant&&(t[this.props.variant]=!0),this.props.className&&(t[this.props.className]=!0),n={"list-menu":!0,"select-input-dropdown":!0,"select-input-disable-error":this.props["disable-errors"]},p.div({className:d(t),style:this.props.style},c(l,{name:this.props.name,defaultValue:this.props.defaultValue,value:this.getValue(),options:function(t){return function(){var n;return n=[],e.Children.forEach(t._getFilteredChildren(),function(e){return n.push(e.props.value)}),n}}(this)()}),this.renderErrorIfEnabled(),p.div({className:"select-input-input",tabIndex:0,"aria-hidden":!0,onClick:this.toggle,onKeyDown:this.handleKeydown,onMouseMove:this.handleMouseMove,ref:"label"},this.selectedOption(),p.div({className:"select-input-dropdown-arrow"},c(r,{group:"web",name:"arrow-down-gray"}))),p.div({style:{position:"relative"}},p.div({className:d(n),"aria-hidden":!0,ref:"dropdown"},this.menuChildren())))},handleMouseMove:function(e){var t,n;return(e.pageX!==t||e.pageY!==n)&&(this.mouseInput=!0),t=e.pageX,n=e.pageY},_commonPrefixLen:function(e,t){var i;for(e=n.trim(e).toLowerCase(),t=n.trim(t).toLowerCase(),i=0;i<e.length&&i<t.length&&e.charAt(i)===t.charAt(i);)i++;return i},_keyboardSelect:function(e){var n,i,o,s,r;return r=t.sortedIndex(this.sortedOptions,{text:e.toLowerCase()},"text"),o=this.sortedOptions[Math.max(r-1,0)],n=this.sortedOptions[Math.min(r,this.sortedOptions.length-1)],s=this._commonPrefixLen(e,o.text),i=this._commonPrefixLen(e,n.text),this.setState(s>=i?{keyboarsSelectPrefix:e,focused:o.value}:{keyboarsSelectPrefix:e,focused:n.value})},handleKeydown:function(e){var n,o;switch(this.mouseInput=!1,e.keyCode){case i.TAB:return this.setState({open:!1,focused:null}),!0;case i.ENTER:this.state.open&&this.state.focused?(this.setValue(this.state.focused),this.setState({open:!1})):this.toggle();break;case i.UP:this.setState(this.state.open?{focused:this.prev(this.state.focused)}:{open:!0});break;case i.DOWN:this.setState(this.state.open?{focused:this.next(this.state.focused)}:{open:!0});break;default:if(!this.state.open)return!0;t.contains(t.values(i),e.keyCode)||(n=String.fromCharCode(e.which),o=this.state.keyboarsSelectPrefix+n,this._keyboardSelect(o),this._keyboardSelect_timeout&&clearTimeout(this._keyboardSelect_timeout),this._keyboardSelect_timeout=setTimeout(function(e){return function(){return e.setState({keyboarsSelectPrefix:""}),e._keyboardSelect_timeout=null}}(this),500))}return!1},prev:function(t){var n,i;return n=null,i=null,e.Children.forEach(this._getFilteredChildren(),function(){return function(e){return i||(i=e),e.props.value===t&&(n=i),i=e}}(this)),null!=n?n.props.value:void 0},next:function(t){var n,i,o;return n=null,i=null,e.Children.forEach(this._getFilteredChildren(),function(){return function(e){return(null!=i?i.props.value:void 0)===t&&(n=e),i=e}}(this)),null!=(o=n||i)?o.props.value:void 0},menuChildren:function(){var t,n;return n=this.getValue(),t=e.Children.map(this._getFilteredChildren(),function(e){return function(t){var i;return i=u(t,{onMouseEnter:function(){return e.mouseInput?e.setState({focused:t.props.value}):void 0},onClick:function(){return t.props.disabled?void 0:(e.setState({open:!1}),e.setValue(t.props.value))},className:d({"focused-option":e.state.focused===t.props.value,"selected-option":n===t.props.value})})}}(this))},componentWillMount:function(){var i;return i=e.Children.map(this._getFilteredChildren(),function(e){return{value:e.props.value,text:n.trim(a.getText(e).toLowerCase())}}),this.sortedOptions=t.sortBy(i,"text")},componentDidMount:function(){return this.globalMenuCloser=function(e){return function(t){var i;return e.state.open&&(i=n(t.target).closest(".select-input-input"),!i.length||i[0]!==e.refs.label.getDOMNode())?e.setState({open:!1,focused:null}):void 0}}(this),n(document).on("click",this.globalMenuCloser)},componentWillUnmount:function(){return n(document).off("click",this.globalMenuCloser)},componentDidUpdate:function(){var e,t;return this.state.open&&this.state.focused?(t=n(this.refs.dropdown.getDOMNode()),e=t.find("[data-value='"+this.state.focused+"']"),h(t,e)):void 0},selectedOption:function(){var t;return t=null,e.Children.forEach(this._getFilteredChildren(),function(e){return function(n){return t||(t=n),(null!=n?n.props.value:void 0)===e.getValue()?t=n:void 0}}(this)),t?u(t):null},toggle:function(){return this.setState({open:!this.state.open,focused:null})},getValue:function(){var e,t,n,i;return null!=(e=null!=(t=null!=(n=this.props.value)?n:null!=(i=this.props.valueLink)?i.value:void 0)?t:this.state.value)?e:this.props.defaultValue},setValue:function(e){var t,n;return n=this.getValue(),this.props.valueLink?this.props.valueLink.requestChange(e):this.setState({value:e}),n!==e&&"function"==typeof(t=this.props).onChange?t.onChange(n,e):void 0}}),{input:_,option:m}})}.call(this),function(){define("modules/clean/react/sharing/shared_with_view",["external/react","modules/clean/avatar/shared_link_avatar","modules/clean/avatar/size","modules/clean/components/title_bubble","modules/clean/datetime","modules/clean/sharing/member_avatars","modules/clean/sharing/constants","modules/clean/viewer","modules/core/i18n"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_,m,f,v,g;return u=n.AVATAR_DIMENSION_BY_SIZE,g=o.nice_date_with_month_name,h=r.SHMODEL_LINK_TOKEN_VISIBILITY,m=l._,v=e.DOM,f=e.createElement,d=5,c=u.SMALL,p="--",_=e.createClass({displayName:"SharedWithView",mixins:[s],propTypes:{user:e.PropTypes.object.isRequired,onOverflowCountClick:e.PropTypes.func,onAvatarClick:e.PropTypes.func,numUndisplayableUsersAndInvites:e.PropTypes.number,groups:e.PropTypes.array,invitations:e.PropTypes.array,joinedMembers:e.PropTypes.array,animation:e.PropTypes.bool,titleButtonDirection:e.PropTypes.string,avatarDimension:e.PropTypes.number,maxVisibleAvatars:e.PropTypes.number,sharedLinkInfo:e.PropTypes.object,onSharedLinkClick:e.PropTypes.func},getDefaultProps:function(){return{titleButtonDirection:"south",avatarDimension:c,maxVisibleAvatars:d}},render:function(){return v.div({className:this.getClassName()},this.renderAvatars())},getClassName:function(){return e.addons.classSet({"shared-with-members":!0,clearfix:!0})},renderAvatars:function(){var e,t,n,i,o,s,r,a;return i=this.props.joinedMembers?this.props.joinedMembers:[],t=this.props.groups?this.props.groups.slice():[],n=this.props.invitations?this.props.invitations.slice():[],e=[],this.props.sharedLinkInfo&&e.push(this.renderSharedLink(this.props.sharedLinkInfo)),r=this.findOwnerAndMeInJoinedMembers(i),s=r[0],o=r[1],a=[],null!=s&&s===o&&(s=null),null!=s&&(a.push(s.user_id),e.push(this.renderJoinedMember(s))),null!=o&&a.push(o.user_id),this.addGroupsMembersInvitations(e,t,i,n,a),0===e.length?v.span({"aria-hidden":!0},p):this.renderAvatarList(e)},renderSharedLink:function(e){var n,o;return n=this.sharedLinkAccessTypeString(e),o=f(t,{dimension:this.props.avatarDimension,onClick:function(t){return function(){return t.props.onSharedLinkClick(e)}}(this)}),f(i,{key:"shared_link",text:n,direction:"south"},o)},sharedLinkAccessTypeString:function(e){var t,n,i,o,s,r,l,c,u,d,p;if(p=e.visibility_type,i=e.expires_posix,u=e.shared_folder_link_policy,i){if(l=(new Date).getTime()/1e3,c=i-l,n=Math.floor(c/86400),0>c)return m("Link Disabled");t=new Date(1e3*i),d=!1,s=!0,o=n>180,t=g(t,o,d,s)}if(r="MEMBERS_ONLY"===u,t){if(p===h.PUBLIC)return e.is_editable?r?m("Folder members with the link can edit until %(date)s").format({date:t}):m("People with the link can edit until %(date)s").format({date:t}):r?m("Folder members with the link can view until %(date)s").format({date:t}):m("People with the link can view until %(date)s").format({date:t});if(p===h.PASSWORD)return e.is_editable?r?m("Folder members with the password can edit until %(date)s").format({date:t}):m("People with the password can edit until %(date)s").format({date:t}):r?m("Folder members with the password can view until %(date)s").format({date:t}):m("People with the password can view until %(date)s").format({date:t});if(p===h.TEAM_ONLY)return e.is_editable?r?m("Folder members at %(team_name)s can edit until %(date)s").format({team_name:a.get_viewer().team_name,date:t}):m("People at %(team_name)s can edit until %(date)s").format({team_name:a.get_viewer().team_name,date:t}):r?m("Folder members at %(team_name)s can view until %(date)s").format({team_name:a.get_viewer().team_name,date:t}):m("People at %(team_name)s can view until %(date)s").format({team_name:a.get_viewer().team_name,date:t})}else{if(p===h.PUBLIC)return m(e.is_editable?r?"Folder members with the link can edit":"People with the link can edit":r?"Folder members with the link can view":"People with the link can view");if(p===h.PASSWORD)return m(e.is_editable?r?"Folder members with the password can edit":"People with the password can edit":r?"Folder members with the password can view":"People with the password can view");if(p===h.TEAM_ONLY)return e.is_editable?r?m("Folder members at %(team_name)s with the link can edit").format({team_name:a.get_viewer().team_name}):m("People at %(team_name)s with the link can edit").format({team_name:a.get_viewer().team_name}):r?m("Folder members at %(team_name)s with the link can view").format({team_name:a.get_viewer().team_name}):m("People at %(team_name)s with the link can view").format({team_name:a.get_viewer().team_name})}}}),{SharedWithView:_}})}.call(this),function(){define("modules/clean/react/slider",["external/react","modules/clean/css"],function(e,t){var n,i,o,s,r,a,l;return l=t.require_css,a=e.DOM,r=e.addons.classSet,n=e.createClass({displayName:"IndicatorGroup",mixins:[e.addons.PureRenderMixin],propTypes:{className:e.PropTypes.string,currentSlideIndex:e.PropTypes.number.isRequired,slideCount:e.PropTypes.number.isRequired,onIndicatorClick:e.PropTypes.func},render:function(){var e;return a.ul({className:r("c-slider__indicator-group",this.props.className)},function(){e=[];for(var t=0,n=this.props.slideCount;n>=0?n>t:t>n;n>=0?t++:t--)e.push(t);return e}.apply(this).map(function(e){return function(t){return a.li({key:"indicator-"+t,className:r({"c-slider__indicator":!0,"is-active":t===e.props.currentSlideIndex}),onClick:function(){var n;return"function"==typeof(n=e.props).onIndicatorClick?n.onIndicatorClick(t):void 0}})}}(this)))}}),i=e.createClass({displayName:"NavButtonGroup",mixins:[e.addons.PureRenderMixin],propTypes:{className:e.PropTypes.string},render:function(){return a.div({className:r("c-slider__nav-button-group",this.props.className)},this.props.children)}}),s=e.createClass({displayName:"Slides",mixins:[e.addons.PureRenderMixin],propTypes:{currentSlideIndex:e.PropTypes.number.isRequired,width:e.PropTypes.number.isRequired,height:e.PropTypes.number},getSlideCount:function(){return e.Children.count(this.props.children)},render:function(){var t;return a.div({style:{display:"inline-block",width:this.props.width+"px",height:null!=(t=this.props.height)?t:"auto",overflowX:"hidden"}},a.div({style:{width:100*this.getSlideCount()+"%"}},e.Children.map(this.props.children,function(e){return function(t,n){return a.div({className:r({"c-slider__slide":"c-slider__slide","is-active":e.props.currentSlideIndex===n}),style:{width:e.props.width+"px",transform:"translateX("+100*-e.props.currentSlideIndex+"%)"}},t)}}(this))))}}),o=e.createClass({displayName:"Slider",mixins:[e.addons.PureRenderMixin],propTypes:{className:e.PropTypes.string},componentWillMount:function(){return l("/static/css/components/slider-vflPZYrDl.css")},render:function(){return a.div({className:r("c-slider",this.props.className)},this.props.children)}}),{NavButtonGroup:i,Slider:o,IndicatorGroup:n,Slides:s}})}.call(this),function(){define("modules/clean/react/sprite_div",["external/react","modules/clean/static_urls"],function(e,t){var n,i,o,s;return s=t.static_url,o=e.DOM,n=e.PropTypes,i=e.createClass({displayName:"SpriteDiv",propTypes:{group:n.string.isRequired,name:n.string.isRequired,text:n.string,alt:n.string},render:function(){var e,t,n,i;return t=this.props.group,n=this.props.name,i=this.props.text,e=this.props.alt||"",o.div({className:"sprite-div"},o.div({className:"sprite-frame small icon-left"},o.img({className:"sprite sprite_"+t+" s_"+t+"_"+n,src:s("/static/images/icons/icon_spacer-vflN3BYt2.gif"),alt:e})),o.div({className:"sprite-text"},i))}})})}.call(this),function(){define("modules/clean/react/tooltip",["external/react","external/underscore","jquery"],function(e,t,n){var i,o,s,r,a,l,c,u,d,p;return c={TOP:0,BOTTOM:1,LEFT:2,RIGHT:3},d=e.DOM,s="tooltip-holder",i=7,r=1e4,o="data-event-id",u=function(){var e,t;return e=s,t=n("#"+e),t.length||(t=n("<div />").attr({id:e,style:"z-index: "+r}).prependTo("body")),t[0]},l=e.createClass({displayName:"TooltipBubble",propTypes:{position:e.PropTypes.oneOf(function(){var e;e=[];for(p in c)e.push(c[p]);return e}()),tooltip_target_ref:e.PropTypes.object,contents:e.PropTypes.oneOfType([e.PropTypes.element,e.PropTypes.string]),className:e.PropTypes.string,mouse_move_cb:e.PropTypes.func,mouse_out_cb:e.PropTypes.func},_getDimensionsOfElement:function(e){var t,n,i;return n=e.offset(),i=e.outerWidth(),t=e.outerHeight(),{left_x:n.left,right_x:n.left+i,top_y:n.top,bottom_y:n.top+t,width:i,height:t}},render:function(){var e,t,o,s,r;return t=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),o=n(window),r=n(window).scrollTop(),s=n(window).scrollLeft(),e=function(){switch(this.props.position){case c.TOP:return{bottom:o.height()-t.top_y+i+r};case c.BOTTOM:return{top:t.bottom_y+i-r};case c.LEFT:return{right:o.width()-t.left_x+i+s};case c.RIGHT:return{left:t.right_x+i-s}}}.call(this),d.div({className:"tooltip-bubble "+(this.props.className||""),ref:"tooltip",style:e,onMouseMove:this.props.mouse_move_cb?this.props.mouse_move_cb:void 0,onMouseLeave:this.props.mouse_out_cb?this.props.mouse_out_cb:void 0},d.div({className:"tooltip-inner"},this.props.contents))},componentDidMount:function(){return this._centerAndShow()},componentDidUpdate:function(){return this._centerAndShow()},_centerAndShow:function(){var e,t,i,o,s,r,a,l,u;return e=n(this.refs.tooltip.getDOMNode()),a=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),l=this._getDimensionsOfElement(e),r=n(window).scrollTop(),s=n(window).scrollLeft(),(i=this.props.position)===c.TOP||i===c.BOTTOM?(t=a.left_x+a.width/2-l.width/2-s,e.css("left",t+"px")):((o=this.props.position)===c.LEFT||o===c.RIGHT)&&(u=a.top_y+a.height/2-l.height/2-r,e.css("top",u+"px")),e.show()}}),a=e.createClass({displayName:"Tooltip",propTypes:{position:e.PropTypes.oneOf(function(){var e;e=[];for(p in c)e.push(c[p]);return e}()),tooltip_contents:e.PropTypes.element,tooltip_classname:e.PropTypes.string,hide_delay:e.PropTypes.number,interaction_enabled:e.PropTypes.bool},render:function(){return d.div({className:"tooltip-target",onMouseMove:function(e){return function(t){return e._show(t)}}(this),onMouseLeave:this._on_mouse_leave(),id:this.state.tooltip_id,ref:"tooltipTarget"},this.props.children)},componentDidMount:function(){return n(document).bind("scroll."+this.state.event_id,function(e){return function(t){return e._hide(t)}}(this))},componentDidUpdate:function(){return this.state.visible?this._render_tooltip():void 0},componentWillUnmount:function(){var t;return n(document).unbind("scroll."+this.state.event_id),t=u(),e.unmountComponentAtNode(t)},_on_mouse_leave:function(){return function(e){return function(t){return e.props.hide_delay>0?e._scheduleHide(e.props.hide_delay):e._hide(t)}}(this)},_render_tooltip:function(){var t,i;return i=u(),n("#"+s).css("position","fixed"),n("#"+s).css("left","0"),n("#"+s).css("right","0"),this.props.hide_delay>0&&n("#"+s).attr(o,this.state.event_id),this.props.position===c.TOP?(n("#"+s).css("top","auto"),n("#"+s).css("bottom","0")):(n("#"+s).css("top","0"),n("#"+s).css("bottom","auto")),t=l({position:this.props.position,contents:this.props.tooltip_contents,tooltip_target_ref:this.refs.tooltipTarget,className:this.props.tooltip_classname,mouse_move_cb:this.props.interaction_enabled?this._clear_timeout:void 0,mouse_out_cb:this.props.interaction_enabled?this._on_mouse_leave():void 0}),e.unmountComponentAtNode(i),e.render(t,i)},_show:function(){return!this.state.visible||this._last_timeout?(this._render_tooltip(),this.setState({visible:!0}),this._clear_timeout()):void 0},_hide:function(){var t,i;return this.state.visible?(i=u(),this._last_timeout?(t=n(i).attr(o),t===this.state.event_id&&(e.unmountComponentAtNode(i),null!=this._clear_timeout())):e.unmountComponentAtNode(i),this.setState({visible:!1})):void 0},_scheduleHide:function(e){return this.state.visible?this._last_timeout=setTimeout(this._hide,e):void 0},_clear_timeout:function(){return this._last_timeout?(clearTimeout(this._last_timeout),this._last_timeout=null):void 0},getInitialState:function(){return{visible:!1,event_id:t.uniqueId()}},getDefaultProps:function(){return{interaction_enabled:!1,hide_delay:0}}}),{Tooltip:a,TooltipPosition:c}})}.call(this),function(){define("modules/clean/referrer_cleansing_redirect",["external/sjcl","modules/constants/request","modules/core/browser","modules/core/cookies","modules/core/uri"],function(e,t,n,i,o){var s,r,a,l;return l=function(n){var o,s,r,a;return o=e.codec.utf8String.toBits(i.read(t.JS_CSRF_COOKIE)),a=e.codec.utf8String.toBits(n),s=new e.misc.hmac(o),r=s.encrypt(n),e.codec.base64.fromBits(r)},r=function(e){var t,n;return t=o.parse(e).scheme,t&&"http"!==t&&"https"!==t?"#":(n=new o({path:"/referrer_cleansing_redirect"}),n.setQuery({url:e,hmac:l(e)}),n)},a=function(e){return n.redirect(r(e))},s={get_redirect_uri:r,redirect:a}})}.call(this),function(){define("modules/clean/revisions/file_revisions_iterator",["jquery","modules/clean/ajax","modules/clean/react/browse/store"],function(e,t,n){var i,o,s,r,a;return i=n.File,r=50,o=function(){function e(e){this.file=e.file}return e}(),a=function(e){return new o({file:new i(e.preview_info)})},s=function(){function n(e,t,n){this.fqPath=e,this.userId=t,null==n&&(n={}),this.cursor=n.initialCursor||null,this.deserializer=n.deserializer||a}return n.prototype.next=function(n){var i,o;return null==n&&(n=r),o=new e.Deferred,i={path:this.fqPath,limit:n},this.cursor&&(i.cursor=this.cursor),t.WebRequest({url:"/file_revisions",type:"GET",subject_user:this.userId,data:i,success:function(e){return function(t){var n,s;return i=JSON.parse(t),e.cursor=i.cursor,s=function(){var e,t,o,s;for(o=i.revisions,s=[],e=0,t=o.length;t>e;e++)n=o[e],s.push(this.deserializer(n));return s}.call(e),o.resolve({revisions:s,hasMore:i.more})}}(this),error:function(e){return o.reject({errorText:e.error_text})}}),o.promise()},n}()})}.call(this),function(){define("modules/clean/search/constants",[],function(){var e;return e={},e.ActionTypes={SET_USER:"SET_USER",FOCUS_SEARCH_BAR:"FOCUS_SEARCH_BAR",BLUR_SEARCH_BAR:"BLUR_SEARCH_BAR",SET_SEARCH_QUERY:"SET_SEARCH_QUERY",SET_SEARCH_SUGGESTIONS:"SET_SEARCH_SUGGESTIONS",SET_HIGHLIGHTED_ROW:"SET_HIGHLIGHTED_ROW",HIGHLIGHT_PREVIOUS_ROW:"HIGHLIGHT_PREVIOUS_ROW",HIGHLIGHT_NEXT_ROW:"HIGHLIGHT_NEXT_ROW"},e})}.call(this),function(){define("modules/clean/search/search_helpers",["jquery","modules/clean/history"],function(e,t){var n;return n={buildSearchURL:function(e,i,o){var s;return s=n.queryParams(i,o),t.construct_url("/search/"+e.role,s)},queryParams:function(e,t){var n;return null==e&&(e=""),null==t&&(t=""),n=e.toLowerCase().trim().replace(/\ +/g," "),{query:n,query_unnormalized:e,last_fq_path:t}},highlightMatch:function(t,n){var i,o,s,r,a,l,c,u;for(s=0,a=0,o=e("<span />");s<t.length;)c=n[a],a>=n.length?(l=!1,r=s+t.length):c.pos>s?(l=!1,r=c.pos):(l=!0,r=c.pos+c.len),u=t.substring(s,r),i=e("<span/>").text(u),i.addClass(""),l&&i.addClass("highlighted"),o.append(i),s=r,l&&a++;return o},highlightMatchString:function(e,t){return this.highlightMatch(e,t)[0].innerHTML}}})}.call(this),function(){define("modules/clean/search/search_type",function(){var e;return e={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"}})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/search/store",["external/immutable","modules/clean/ajax","modules/clean/flux/base_store","modules/clean/search/constants"],function(t,n,i,o){var s,r;return s=o.ActionTypes,new(r=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,n),i.prototype._init=function(){return this._user=null,this._isSearchBarFocused=!1,this._isSearchBarActive=!1,this._isSearchBarLoading=!1,this._searchQuery="",this._searchSuggestions=[],this._highlightedSearchRow=0,this._searchResults=t.List()},i.prototype.user=function(){return this._user},i.prototype.isSearchBarFocused=function(){return this._isSearchBarFocused},i.prototype.isSearchBarActive=function(){return this._isSearchBarActive},i.prototype.isSearchBarLoading=function(){return this._isSearchBarLoading},i.prototype.searchQuery=function(){return this._searchQuery},i.prototype.searchSuggestions=function(){return this._searchSuggestions},i.prototype.highlightedSearchRow=function(){return this._highlightedSearchRow},i.prototype.searchResults=function(){return this._searchResults},i.prototype._setUser=function(e){var t;return t=e.user,this._user=t},i.prototype._focusSearchBar=function(){return this._isSearchBarFocused=!0,this.emit_change()},i.prototype._blurSearchBar=function(){return this._isSearchBarFocused=!1,this._setHighlightedSearchRow({index:0}),this.emit_change()},i.prototype._setSearchQuery=function(e){var t;return t=e.query,this._searchQuery=t,this._searchSuggestions=[],this._isSearchBarActive=!!this._searchQuery,this._isSearchBarLoading=this._isSearchBarActive,this._highlightedSearchRow=0,this.emit_change()},i.prototype._setSearchSuggestions=function(e){var t;return t=e.searchSuggestions,this._isSearchBarLoading=!1,this._searchSuggestions=t,this.emit_change()},i.prototype._setHighlightedSearchRow=function(e){var t;return t=e.index,this._highlightedSearchRow=t,this.emit_change()},i.prototype._highlightPreviousSearchRow=function(){return this._highlightedSearchRow=Math.max(0,this._highlightedSearchRow-1),this.emit_change()},i.prototype._highlightNextSearchRow=function(){return this._highlightedSearchRow=Math.min(this._searchSuggestions.length,this._highlightedSearchRow+1),this.emit_change()},i.prototype._new_payload=function(e){switch(e.action.type){case s.SET_USER:return this._setUser(e.action.data);case s.FOCUS_SEARCH_BAR:return this._focusSearchBar();case s.BLUR_SEARCH_BAR:return this._blurSearchBar();case s.SET_SEARCH_QUERY:return this._setSearchQuery(e.action.data);case s.SET_SEARCH_SUGGESTIONS:return this._setSearchSuggestions(e.action.data);case s.SET_HIGHLIGHTED_ROW:return this._setHighlightedSearchRow(e.action.data);case s.HIGHLIGHT_PREVIOUS_ROW:return this._highlightPreviousSearchRow();case s.HIGHLIGHT_NEXT_ROW:return this._highlightNextSearchRow()}},i}(i))})}.call(this),function(){define("modules/clean/sharing/api",["modules/clean/ajax","modules/core/exception","jquery"],function(e,t,n){var i,o,s,r,a;return r=e.WebRequest,i=e.FormWebRequest,a=t.assert,o=function(){function e(e){this.user=e}return e.REQUEST_SUCCEEDED_EVENT="db:sharing_api:request_succeeded",e.prototype.invite_more_to_folder=function(e,t,n,i,o,s){var r;return r={ns_id:e,emails:t.emails||[],fb_ids:t.fb_ids||[],group_ids:t.group_ids||[],new_style_group_ids:t.new_style_group_ids||[],custom_message:n||"",access_type:i},this._make_request("/share_ajax/invite_more",r,o,s,!0)},e.prototype.update_member_access_type=function(e,t,n,i,o){var s;return s={ns_id:e,member_uid:t,access_type:n},this._make_request("/share_ajax/update_member_access_type",s,i,o)},e.prototype.update_team_folder_access_type=function(e,t,n,i){var o;return o={ns_id:e,can_edit:t},this._make_request("/team/admin/team_folder/update_access_type",o,n,i,!0,!1)},e.prototype.update_invite_access_type=function(e,t,n,i){var o;return o={invite_id:e,access_type:t},this._make_request("/share_ajax/update_invite_access_type",o,n,i)},e.prototype.share_folder=function(e,t,n,i,o,s,r,a,l,c,u){var d,p;return d={emails:n.emails||[],fb_ids:n.fb_ids||[],group_ids:n.group_ids||[],new_style_group_ids:n.new_style_group_ids||[],custom_message:i||"",audience:o,inviter:s,shared_link_policy:r,access_type:a,folder_settings:1},e?(d.folder_name=t,p="/share_ajax/new"):(d.path=t,p=l?"/share_ajax/existing_no_recipient":"/share_ajax/existing"),(o||s)&&(d.custom_folder_settings=1),this._make_request(p,d,c,u,!0)},e.prototype.share_path=function(e,t,n,i,o,s,r,a,l,c){var u,d;return u={emails:t.emails||[],fb_ids:t.fb_ids||[],group_ids:t.group_ids||[],new_style_group_ids:t.new_style_group_ids||[],custom_message:n||"",audience:i,inviter:o,shared_link_policy:s,access_type:r,folder_settings:1,path:e},d="/share_ajax/new_path",(i||o)&&(u.custom_folder_settings=1),this._make_request(d,u,l,c,!0)},e.prototype.unshare_folder=function(e,t,n){var i;return i={ns_id:e,async:!0},t&&(i.keep_files=!0),this._make_request("/share_ajax/unshare?long_running",i,n)},e.prototype.leave_folder=function(e,t,n){var i;return i={ns_id:e},t&&(i.keep_files=!0),this._make_request("/share_ajax/leave?long_running",i,n)},e.prototype.transfer_ownership=function(e,t,n){var i;return i={ns_id:e,user_id:t},this._make_request("/share_ajax/change_sf_owner",i,n)},e.prototype.cancel_invite=function(e,t,n){var i;return i={ns_id:e,invite_id:t},this._make_request("/share_ajax/cancel_invite",i,n)},e.prototype.kick=function(e,t,n,i){var o;return o={ns_id:e,user_id:t},n&&(o.keep_files=!0),this._make_request("/share_ajax/kick_user",o,i)},e.prototype.reinvite_user=function(e,t,n){var i;return i={ns_id:e,invite_id:t},this._make_request("/share_ajax/reinvite_user",i,n)},e.prototype.update_sf_permissions=function(e,t,n,i){var o;return o={ns_id:e,new_permissions:t},this._make_request("/share_ajax/change_sf_perm",o,n,i)},e.prototype.update_sf_team_permissions=function(e,t,n,i,o,s){var r;return r={ns_id:e,audience:t,inviter:n,shared_link_policy:i},void 0!==o&&(r.activity_feed_enabled=o),this._make_request("/share_ajax/save_folder_settings",r,s)},e.prototype.validate_new_sf_path=function(e,t,n){var i;return i={share_type:"new",folder_name:e},this._make_request("/share_ajax/validate_folder",i,t,n,!0)},e.prototype.validate_existing_sf_path=function(e,t,n){var i;return i={share_type:"existing",path:e},this._make_request("/share_ajax/validate_folder",i,t,n,!0)},e.prototype._make_request=function(t,o,s,a,l,c){var u,d,p;return null==l&&(l=!1),null==c&&(c=!0),u={url:t,data:o,success:function(i,r,a){return"function"==typeof s&&s(a),n(document).trigger(e.REQUEST_SUCCEEDED_EVENT,{request_url:t,ns_id:o.ns_id||null})},error:function(e){return"function"==typeof a?a(e):void 0},complete:function(e){return function(){var t;return null!=(t=e.loading_elem)?t.removeClass("ajax-loading"):void 0}}(this)},c&&(u.subject_user=this.user.id),null!=(d=this.loading_elem)&&d.addClass("ajax-loading"),(p=l?i:r)(u)},e}(),s=function(){function e(){}return e.prototype.get_inbox_counts=function(e){return new r({url:"/inbox_count",success:function(t,n,i){var o;return o=JSON.parse(i.responseText),a("object"==typeof o,"bad inbox_count"),e(o)}})},e.prototype.get_folder_info=function(e,t){return new r({url:"/share_ajax/list_folders",success:function(t,n,i){return"function"==typeof e?e(i):void 0},error:function(e){return"function"==typeof t?t(e):void 0}})},e}(),{SharingApi:o,UserlessSharingApi:s}})}.call(this),function(){define("modules/clean/sharing/constants",["external/underscore","modules/constants/sharing"],function(e,t){var n,i,o;return n={ACCESS_NO_ACCESS:0,ACCESS_READER:1,ACCESS_WRITER:2,ACCESS_OWNER:3},i={PUBLIC:1,TEAM_ONLY:2,PASSWORD:3},o={ACCESS_LEVEL:{OWNER:"owner",WRITER:"writer",READER:"reader"},SNIPPET_SIZES:{FILENAME:50,DISPLAY_NAME:30,EMAIL:30},NameSpaceAccess:n,SHMODEL_LINK_TOKEN_VISIBILITY:i},o.ACCESS_VALUES=e.values(o.ACCESS_LEVEL),e.extend(o,t),o})}.call(this),function(){define("modules/clean/sharing/content_info",[],function(){var e;return e=function(){function e(e){var t,n,i,o;this.canBeSharedFolder=null!=(n=e.canBeSharedFolder)?n:!1,this.canShareLink=null!=(i=e.canShareLink)?i:!0,this.fileId=e.fileId,this.fqPath=e.fqPath,this.icon=e.icon,this.nsId=e.nsId,this.isSharedFolder=null!=(o=e.isSharedFolder)?o:!1,t=this.fqPath.split("/"),this.name=t[t.length-1],this.shareAsSharedFolder=this.isSharedFolder||this.canBeSharedFolder,this.id=this.shareAsSharedFolder?this.nsId?""+this.nsId:null:this.fileId?this.fileId:this.fqPath}return e.fromBrowseFile=function(t){return new e({canBeSharedFolder:t.could_be_shared_folder(),canShareLink:t.allows_shared_link,fileId:t.file_id,fqPath:t.fq_path,icon:t.icon,nsId:t.target_ns,isSharedFolder:t.target_ns&&0!==t.target_ns})},e}(),{ContentInfo:e}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/sharing/experiments/share_invite_modal",["jquery","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/dropins/contact_import_button"],function(t,n,i,o){var s,r;return s=o.ContactImportButton,r=function(){function o(n){this.settings=n,this.before_show_handler=e(this.before_show_handler,this),t(document).on(o.BEFORE_SHOW_EVENT,this.before_show_handler)}return o.BEFORE_SHOW_EVENT="db:invite_to_new_shared_folder_wizard_modal:before_show",o.prototype.before_show_handler=function(){var e,o;return e=t(".sf-invite-modal__contact-import-button").get(0),o=n.createElement(s,{providerType:i.GOOGLE,userId:this.settings.userId}),n.render(o,e)},o}()})}.call(this),function(){define("modules/clean/sharing/get_editable_link_prompt",["external/react","jquery","modules/clean/react/sprite_div","modules/clean/sharing/i18n"],function(e,t,n,i){var o,s,r,a;return s=i._,a=e.DOM,r=e.createElement,o=e.createClass({statics:{showInstance:function(n,i){var o,s;return o=i?t(i):t("<div />").attr({class:"editable-link-prompt-mount"}).appendTo("body"),s=o[0],e.unmountComponentAtNode(s),e.render(n,s)}},propTypes:{onDismiss:e.PropTypes.func.isRequired,shouldShow:e.PropTypes.bool.isRequired,targetedButton:e.PropTypes.object.isRequired},getInitialState:function(){return{arrowLeft:0,closed:!this.props.shouldShow,left:0,top:0}},componentDidMount:function(){return t(window).on("resize",this._updateOffset),t(document).on("modalClosed",this._closeModal),t(document).on("collab:m2:prompt:hide",this._closeModal),t(document).on("collab:m2:prompt:dismiss",this._dismissModal),this._updateOffset()},componentWillUnmount:function(){return t(window).off("resize",this._updateOffset),t(document).off("modalClosed",this._closeModal),t(document).off("collab:m2:prompt:hide",this._closeModal),t(document).off("collab:m2:prompt:dismiss",this._dismissModal)},render:function(){return this.state.closed?a.div({}):a.div({className:"get-editable-link-prompt",ref:"prompt",style:{left:this.state.left,top:this.state.top},onClick:function(e){return e.stopPropagation(),e.nativeEvent.stopPropagation()}},a.a({href:"#",onClick:this._dismissModal,className:"close-button"},r(n,{group:"web",name:"xclose"})),a.div({className:"content"},a.span({className:"new"},s("New!")),s("Invite people to your shared folder with a link.")),a.div({className:"learn-more"},a.a({href:"/help/9139"},s("Learn more"))),a.div({className:"prompt-arrow-border",style:{left:this.state.arrowLeft}}),a.div({className:"prompt-arrow",style:{left:this.state.arrowLeft}}))},_closeModal:function(){return this.isMounted()?this.setState({closed:!0}):void 0},_dismissModal:function(){var e;return this._closeModal(),"function"==typeof(e=this.props).onDismiss?e.onDismiss():void 0},_updateOffset:function(){var e,n,i,o,s,r,a;return this.isMounted()&&!this.state.closed?(o=this.refs.prompt.getDOMNode(),e=t(this.props.targetedButton),r=e.offset(),s=parseInt(e.css("marginTop"),10),n=t("body").offset(),a=r.top+s-n.top-o.offsetHeight-10,i=r.left+(e.outerWidth()-o.offsetWidth)/2,this.setState({arrowLeft:o.offsetWidth/2-9,top:a,left:i
})):void 0}})})}.call(this),function(){define("modules/clean/sharing/i18n",["modules/clean/react/react_i18n","modules/core/i18n"],function(e,t){var n,i,o,s,r;return s=t.i18n_default_project("sharing"),o=s._,n=s.E_,i=s.N_,r=s.ungettext,{_:o,E_:n,N_:i,ungettext:r}})}.call(this),function(){define("modules/clean/sharing/inband_link_settings_modal",["external/react","modules/clean/ajax","modules/clean/css","modules/clean/em_string","modules/clean/filepath","modules/clean/form","modules/clean/react/button","modules/clean/react/modal","modules/clean/static_urls","modules/core/i18n","modules/core/notify"],function(e,t,n,i,o,s,r,a,l,c,u){var d,p,h,_,m,f,v;return p=a.Modal,v=l.static_url,_=c._,m=e.createElement,f=e.DOM,h={ALL:"all",INVITED:"invited",TEAM:"team"},d=e.createClass({displayName:"InBandLinkSettingsModal",statics:{showInstance:function(e){return p.showInstance(e)}},propTypes:{user:e.PropTypes.object.isRequired,fqPath:e.PropTypes.string.isRequired,teamName:e.PropTypes.string.isRequired,doneCallback:e.PropTypes.func.isRequired},getInitialState:function(){return{hasLoaded:!1}},componentWillMount:function(){return n.require_css("/static/css/sharing_settings_modal-vflWGy93z.css"),t.WebRequest({subject_user:this.props.user,url:"/simple_sharing_ajax/get_member_link_settings",data:{fq_path:this.props.fqPath},success:function(e){return function(t){var n;return e.isMounted()?(n=JSON.parse(t),e.setState({hasLoaded:!0,keyToRecipients:n.key_to_recipients,memberOnly:n.member_only})):void 0}}(this),error:function(e){return function(){return e.isMounted()?e._onDone():void 0}}(this)})},render:function(){var e;return e=i.em_snippet(o.filename(this.props.fqPath),16),m(p,{acceptButtonText:_("Save settings"),autoClose:!1,dismissButtonText:_("Cancel"),onAccept:this._onSave,onDismiss:this._onDone,ref:"modal",title:_("‘%(filename)s’ settings").format({filename:e})},this.state.hasLoaded?f.div({className:"sharing-settings-modal-content"},f.table({className:"permission-settings-table"},f.tr({className:"audience-selection"},f.td({className:"prompt"},_("Who can be invited to view this folder?")),f.td({},this._renderOption("audience-all",h.ALL,_("Anyone")),this._renderOption("audience-invited",h.INVITED,_("People you’ve explicitly invited")),this._renderOption("audience-team",h.TEAM,_("People at %(team)s").format({team:this.props.teamName||"your team"})))))):this._renderLoadingSpinner())},_renderLoadingSpinner:function(){return f.div({className:"member-container spinner-div"},f.img({className:"member-loading-spinner",src:v("/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif")}))},_renderOption:function(e,t,n){return f.div({className:"option"},f.input({checked:this._mapSettingsToLocal()===t,className:"audience-input",id:e,name:"audience",onChange:this._handleOptionChanged,type:"radio",value:t}),f.label({className:"audience-label",htmlFor:e},n))},_onDone:function(){return this.refs.modal.close(),this.props.doneCallback()},_onSave:function(){return t.WebRequest({subject_user:this.props.user,url:"/simple_sharing_ajax/set_member_link_settings",data:{fq_path:this.props.fqPath,key_to_recipients:this.state.keyToRecipients,member_only:this.state.memberOnly},success:function(e){return function(t){var n,i,o;return i=s.parse_response(t),o=i[0],n=i[1],o?(u.success(_("Settings updated.")),e._onDone()):u.error(n)}}(this)})},_handleOptionChanged:function(e){return this.setState({keyToRecipients:e.currentTarget.value===h.INVITED,memberOnly:e.currentTarget.value===h.TEAM})},_mapSettingsToLocal:function(){return this.state.keyToRecipients?h.INVITED:this.state.memberOnly?h.TEAM:h.ALL}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/sharing/member_avatars",["external/react","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/photo_avatar","modules/clean/avatar/viewer_avatar","modules/clean/avatar/list","modules/clean/components/title_bubble","modules/clean/viewer","modules/constants/viewer","modules/core/i18n","modules/clean/static_urls"],function(t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v;return _=d._,v=d.ungettext,f=p.static_url,m=t.createElement,h={getInitialState:function(){return{paired_users_in_sf:!1}},componentWillMount:function(){var e;return e=this.arePairedUsersInSf(this.props.joinedMembers),this.setState({paired_users_in_sf:e,paired_users_in_sf:e})},componentWillReceiveProps:function(e){var t;return t=this.arePairedUsersInSf(e.joinedMembers),this.setState({paired_users_in_sf:t,paired_users_in_sf:t})},_wrap_with_avatar_type_and_data:function(e,t,n){return function(){return e(t,n)}},arePairedUsersInSf:function(t){var n,i,o,s,r,a,l;return t?(l=c.get_viewer(),l.is_paired&&(a=l.get_user_ids(n=!0),i=function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)o=t[e],i.push(o.user_id);return i}(),s=a[0],e.call(i,s)>=0&&(r=a[1],e.call(i,r)>=0))?!0:!1):!1},findOwnerAndMeInJoinedMembers:function(e){var t,n,i,o,s,r;for(r=null,o=null,t=n=0,i=e.length;i>n&&(s=e[t],"owner"===s.access_type&&(r=s),s.user_id===this.props.user.id&&(o=s),null==r||null==o);t=++n);return[r,o]},addGroupsMembersInvitations:function(t,n,i,o,s){var r,a,l,c,u,d,p,h,_,m,f;for(null==s&&(s=[]),l=0,d=n.length;d>l;l++)r=n[l],t.push(this.renderGroup(r));for(c=0,p=i.length;p>c;c++)_=i[c],m=_.user_id,e.call(s,m)<0&&t.push(this.renderJoinedMember(_));for(f=[],u=0,h=o.length;h>u;u++)a=o[u],f.push(t.push(this.renderInvitedPerson(a)));return f},renderAvatarList:function(e){return m(a,{avatars:e,avatarDimension:this.props.avatarDimension,maxVisible:this.props.maxVisibleAvatars,undisplayableCount:this.props.numUndisplayableUsersAndInvites||0,onOverflowCountClick:this.props.onOverflowCountClick,animation:this.props.animation})},renderJoinedMember:function(t){var i,s,a,d,p,h,_,f,v,g,y,b;return y=c.get_viewer(),g=t.user_id,_=e.call(y.get_user_ids(s=!0),g)>=0,p=null,_&&this.state.paired_users_in_sf?(h=t.user_id,v=y.get_user_by_role(u.ROLE_PERSONAL,!0),b=y.get_user_by_role(u.ROLE_WORK,!0),h===v.id?p="Personal":h===b.id&&null!=y.team_name&&(p=y.team_name)):p=t.display_name,i=this.individualAccessTypeString(p,t.access_type,_,this.state.paired_users_in_sf),f=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"member",t),d={dimension:this.props.avatarDimension,onPhotoClick:f,photoUrl:t.photo_url,defaultAvatar:m(o,{dimension:this.props.avatarDimension,name:t.display_name,initials:t.initials,shape:"CIRCLE",onClick:f})},a=_?m(r,d):m(n,d),m(l,{key:"user:"+t.user_id+":"+t.photo_url,text:i,direction:this.props.titleButtonDirection},a)},renderGroup:function(e){var t,n,i;return t=null,i=null,e.is_automatic?(i=this.teamAccessTypeString(e.name,e.access_type),t=m(s,{dimension:this.props.avatarDimension,photoUrl:f("/static/images/icons/team_32-vflk8mBzO.png"),shape:"SQUARE"})):(i=this.groupAccessTypeString(e.name,e.access_type,e.num_users),t=m(o,{dimension:this.props.avatarDimension,name:e.name,shape:"SQUARE",initials:this.getInitials(e.name),onClick:n})),n=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"group",e),m(l,{key:"group:"+e.gid+":"+e.name,text:i,direction:this.props.titleButtonDirection},t)},renderInvitedPerson:function(e){var t,n;return n=this._wrap_with_avatar_type_and_data(this.props.onAvatarClick,"invited",e),t=this.individualAccessTypeString(e.email_or_fbname,"pending",!1),m(l,{key:"invitation:"+e.invitation_id,text:t,direction:this.props.titleButtonDirection},m(i,{dimension:this.props.avatarDimension,color:"#aaa",initials:this.getInitials(e.email_or_fbname),shape:"CIRCLE",onClick:n}))},getInitials:function(e){var t,n,i;return null!=e&&e.length>0?(i=e.split(" "),t=function(){var e,t,o;for(o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(n.charAt(0).toLowerCase());return o}(),t.length>2&&(t=t.splice(0,2)),t.join("")):""},teamAccessTypeString:function(e,t){var n;return n=_("editor"===t?"%(team_group_name)s can edit":"%(team_group_name)s can view"),n.format({team_group_name:e})},groupAccessTypeString:function(e,t,n){var i;return i="editor"===t?v("%(num_users)s person in %(group_name)s can edit","%(num_users)s people in %(group_name)s can edit",n):v("%(num_users)s person in %(group_name)s can view","%(num_users)s people in %(group_name)s can view",n),i.format({group_name:e,num_users:n})},individualAccessTypeString:function(e,t,n,i){var o,s,r,a;return null==i&&(i=!1),o={viewer:_("You can view"),editor:_("You can edit"),owner:_("You’re the owner"),team:_("You’re a member of this team folder"),default:_("You")},a={viewer:_("%(name)s can view"),editor:_("%(name)s can edit"),owner:_("%(name)s is the owner"),pending:_("%(name)s hasn’t joined"),team:_("%(name)s is a member of this team folder"),default:_("%(name)s")},s={viewer:_("You (%(name)s) can view"),editor:_("You (%(name)s) can edit"),owner:_("You (%(name)s) are the owner")},r=n?i&&null!=e?s:o:a,r[t].format({name:e})}}})}.call(this),function(){define("modules/clean/sharing/members_list/members_list_modal",["jquery","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/avatar/shared_link_avatar","modules/clean/avatar/size","modules/clean/browse_events","modules/clean/em_string","modules/clean/filepath","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/sharing/members_list/members_list_row","modules/clean/sharing/non_namespace_manage_access_modal","modules/clean/sharing/inband_link_settings_modal","modules/clean/sharing/share_inband","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g){var y,b,w,C,E,S,T,A,I,k;return y=s.AVATAR_DIMENSION_BY_SIZE,E=u.Modal,S=m.ShareInband,T=f._,A=t.createElement,I=t.addons.classSet,k=t.DOM,b=t.createFactory(o),w=function(){function e(){}return e.createAndShowModal=function(e,t,n,o,s,r,a,l,c){var u;return u=function(){return S.createAndShowModal(e,t,n,o,s,r,a,l,c)},i.SimpleSharingLogger.log(e.id,19,"viewed"),E.showInstance(A(C,{user:e,fqPath:t,isDir:o,isSharedFolder:r,nsId:s,showUnshareFolderModal:n.show_unshare_folder_modal,showKickUserModal:n.show_kick_user_modal,showKickGroupModal:n.show_kick_group_modal,showUninviteModal:n.show_uninvite_modal,showLeaveFolderModal:n.show_leave_folder_modal,addPeopleCallback:u}))},e}(),C=t.createClass({propTypes:{user:t.PropTypes.object.isRequired,fqPath:t.PropTypes.string.isRequired,isDir:t.PropTypes.string.isRequired,isSharedFolder:t.PropTypes.bool.isRequired,nsId:t.PropTypes.number,showUnshareFolderModal:t.PropTypes.func,showKickUserModal:t.PropTypes.func,showKickGroupModal:t.PropTypes.func,showUninviteModal:t.PropTypes.func,showLeaveFolderModal:t.PropTypes.func,doneCallback:t.PropTypes.func,addPeopleCallback:t.PropTypes.func.isRequired},getInitialState:function(){return{hasLoaded:!1}},componentDidMount:function(){var e;return e=this.props.isSharedFolder?"/members_list":"/sm/members_list",n.WebRequest({subject_user:this.props.user,url:e,data:{fq_path:this.props.fqPath},success:function(e){return function(t){var n;return e.isMounted()?(n=JSON.parse(t),e.setState({hasLoaded:!0,amOwner:n.am_owner,hasOutOfBandLinks:n.has_out_of_band_links,isOutOfBandLinkEditable:n.is_out_of_band_link_editable,members:n.members,groups:n.groups,sharedContentMembers:n.shared_content_members,invitations:n.invitations,teamName:n.team_name,canOnlyInviteTeam:n.can_only_invite_team})):void 0}}(this)})},render:function(){return A(E,{className:"share_show_modal",autoClose:!1,title:this._renderTitle(),ref:"modal",showX:!1,buttonComponent:this._renderButtons()},this.state.hasLoaded?this._renderMemberSections():k.div({},this._renderLoadingHeader(),this._renderLoadingSpinner()))},_renderTitle:function(){var e;return e=T(this.props.isDir?"Folder management for ‘%(name)s’":"File management for ‘%(name)s’"),e=e.format({name:a.em_snippet(l.filename(this.props.fqPath),13)})},_renderTeamFolderSettings:function(){return k.div({className:"folder-settings"},this.state.canOnlyInviteTeam?k.span({className:"share-team-only"},T("This folder can only be shared with members of %(team_name)s.").format({team_name:this.state.teamName})):k.span({className:"share-anyone"},T("This folder can be shared with anyone.")))},_renderMemberCount:function(){var e,t;return t=this.state.sharedContentMembers.length+(this.state.members?this.state.members.length:0),e=this.state.groups?this.state.groups.length:0,k.h5({},k.span({},e?1===t&&1===e?T("%(num_members)s member and %(num_groups)s group").format({num_members:t,num_groups:e}):1===t&&e>1?T("%(num_members)s member and %(num_groups)s groups").format({num_members:t,num_groups:e}):t>1&&1===e?T("%(num_members)s members and %(num_groups)s group").format({num_members:t,num_groups:e}):t>1&&e>1?T("%(num_members)s members and %(num_groups)s groups").format({num_members:t,num_groups:e}):void 0:1===t?T("%(num)s member").format({num:t}):T("%(num)s members").format({num:t})))},_renderHeader:function(){return k.table({className:"member-info"},k.tr({},k.td({},this.state.amOwner&&this.props.user.is_team?this._renderTeamFolderSettings():this._renderMemberCount())))},_renderLoadingHeader:function(){return k.div({className:"member-info header-loading"})},_renderButtons:function(){var e,t,n;return k.div({className:"action-panel"},k.div({className:"clearfix folder-management-buttons"},this.state.hasLoaded?(n=this.props.isSharedFolder&&this.state.amOwner,e=this.state.sharedContentMembers.length>0||this.state.hasOutOfBandLinks,t=!this.props.isSharedFolder&&e,k.div({},n||t?A(c.button,{importance:"tertiary",onClick:this._unshareButtonClicked},T("Remove all access")):void 0,A(c.button,{importance:"tertiary",onClick:this._addPeopleButtonClicked},T("Add people")))):void 0,A(c.button,{importance:"primary",onClick:this._onDone},T("Done"))))},_addPeopleButtonClicked:function(){return this.refs.modal.close(),this.props.addPeopleCallback()},_onDone:function(){return this.refs.modal.close(),this.props.doneCallback?this.props.doneCallback():void 0},_showLeaveFolderModal:function(){return this.refs.modal.close(),this.props.showLeaveFolderModal(this.props.user,this.props.fqPath,this.props.nsId)},_showKickUserModal:function(e,t){return this.refs.modal.close(),this.props.showKickUserModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_showUninviteModal:function(e,t){return this.refs.modal.close(),this.props.showUninviteModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_showKickGroupModal:function(e,t){return this.refs.modal.close(),this.props.showKickGroupModal(this.props.user,this.props.fqPath,this.props.nsId,e,t)},_unshareButtonClicked:function(){return this.props.isSharedFolder?(E.close(),this.props.showUnshareFolderModal(this.props.user,this.props.fqPath,this.props.nsId)):n.WebRequest({url:g({path:"/sm/unshare_content"+l.normalize(this.props.fqPath)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger(r.UPDATE),v.success(T("Content unshared")),t._onDone()}}(this),error:function(){return v.error(T("An error occurred when unsharing content"))}})},_removeOOBLinkButtonClicked:function(){return n.WebRequest({url:g({path:"/sm/disable_token_at_path"+l.normalize(this.props.fqPath)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger(r.UPDATE),t.isMounted()?t.setState({hasOutOfBandLinks:!1}):void 0}}(this),error:function(){return v.error(T("An error occurred when removing links."))}})},_renderMembersListRow:function(e,t){return p({key:t,user:this.props.user,memberUid:e.member_uid,inviteId:e.invite_id,groupId:e.group_id,amOwner:this.state.amOwner,sharedContentMemberId:e.shared_content_member_id,icon:e.icon,emailOrFbname:e.email_or_fbname,name:e.name,hasJoined:e.has_joined,isMemberActive:e.is_member_active,accessType:e.access_type,showRemoveButton:e.show_remove_button,hideAccessTypeDropdown:e.hide_access_type_dropdown,canMakeEditor:e.can_make_editor,canMakeViewer:e.can_make_viewer,canMakeOwner:e.can_make_owner,showUpsell:e.show_upsell,upsellUrl:e.upsell_url,avatarPhotoUrl:e.avatar_photo_url,avatarInitials:e.avatar_initials,showKickUserModal:this._showKickUserModal,showKickGroupModal:this._showKickGroupModal,showUninviteModal:this._showUninviteModal,showLeaveFolderModal:this._showLeaveFolderModal})},_renderMembers:function(){var e,t,n,i,o;if(this.state.members){for(i=this.state.members,o=[],e=0,t=i.length;t>e;e++)n=i[e],o.push(this._renderMembersListRow(n,n.member_uid));return o}},_renderInvitations:function(){var e,t,n,i,o;if(this.state.invitations){for(i=this.state.invitations,o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(this._renderMembersListRow(t,t.invite_id));return o}},_renderGroups:function(){var e,t,n,i,o;if(this.state.groups){for(i=this.state.groups,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(this._renderMembersListRow(e,e.group_id));return o}},_renderSharedContentMembers:function(){var e,t,n,i,o;if(this.state.sharedContentMembers){for(n=this.state.sharedContentMembers,i=[],e=0,t=n.length;t>e;e++)o=n[e],i.push(this._renderMembersListRow(o,o.shared_content_member_id));return i}},_renderCollabLink:function(){return this.state.hasOutOfBandLinks?k.div({className:"bs-row clearfix clear no-hover"},b({dimension:y.SMALL}),T(this.state.isOutOfBandLinkEditable?"Anyone with the link can edit":"Anyone with the link can view"),k.div({className:"bs-actions remove-button"},k.a({},d({onClick:this._removeOOBLinkButtonClicked,group:"web",name:"xclose"})))):void 0},_getMemberHeaderClassName:function(e){return(I=t.addons.classSet)({"member-info":!0,"follow-on":"oob-link"===e||"shared-link"===e&&this.props.isSharedFolder})},_getMemberListClassName:function(){var e;return(I=t.addons.classSet)({"member-container":!0,"react-rendered":!0,"dual-pane":this.props.isSharedFolder&&(null!=(e=this.state.sharedContentMembers)?e.length:void 0)>0})},_renderMemberSections:function(){var e;return k.div({},this.props.isSharedFolder?k.div({className:this._getMemberHeaderClassName("shared-folder")},T("People who can view and edit"),k.div({className:this._getMemberListClassName()},k.div({className:"clearfix"},this._renderGroups(),this._renderMembers(),this._renderInvitations()))):void 0,!this.props.isSharedFolder||(null!=(e=this.state.sharedContentMembers)?e.length:void 0)>0?k.div({className:this._getMemberHeaderClassName("shared-link")},k.span,T("People who can view")," • ",this._renderSettingsLink(),k.div({className:this._getMemberListClassName()},k.div({className:"clearfix"},this._renderSharedContentMembers()))):void 0,this.state.hasOutOfBandLinks?k.div({className:this._getMemberHeaderClassName("oob-link")},T("Link to folder"),k.div({className:"clearfix"},this._renderCollabLink())):void 0)},_renderLoadingSpinner:function(){return k.div({className:"member-container spinner-div"},k.img({className:"member-loading-spinner",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))},_renderSettingsLink:function(){return A(c.link_button,{className:"settings-link",importance:"standard",onClick:function(e){return function(){return _.showInstance(A(_,{user:e.props.user,fqPath:e.props.fqPath,teamName:e.state.teamName}))}}(this)},T("Change settings"))}}),{MemberList:w,MembersListModal:C}})}.call(this),function(){define("modules/clean/sharing/members_list/members_list_row",["external/react","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/size","modules/clean/em_string","modules/clean/react/select","modules/clean/react/sprite","modules/core/i18n","modules/core/notify"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_,m;return c=i.AVATAR_DIMENSION_BY_SIZE,h=a._,m=e.DOM,_=e.addons.classSet,d=s.input,p=s.option,u=e.createClass({propTypes:{key:e.PropTypes.any.isRequired,memberUid:e.PropTypes.number,inviteId:e.PropTypes.number,groupId:e.PropTypes.string,sharedContentMemberId:e.PropTypes.string,user:e.PropTypes.object.isRequired,amOwner:e.PropTypes.bool,avatarPhotoUrl:e.PropTypes.string,avatarInitials:e.PropTypes.string,icon:e.PropTypes.string.isRequired,emailOrFbname:e.PropTypes.string.isRequired,name:e.PropTypes.string.isRequired,hasJoined:e.PropTypes.bool.isRequired,isMemberActive:e.PropTypes.bool,accessType:e.PropTypes.string.isRequired,hideAccessTypeDropdown:e.PropTypes.bool.isRequired,canMakeEditor:e.PropTypes.bool.isRequired,canMakeViewer:e.PropTypes.bool.isRequired,canMakeOwner:e.PropTypes.bool.isRequired,showUpsell:e.PropTypes.bool.isRequired,upsellUrl:e.PropTypes.string,showRemoveButton:e.PropTypes.bool.isRequired,showKickUserModal:e.PropTypes.func,showKickGroupModal:e.PropTypes.func,showUninviteModal:e.PropTypes.func,showLeaveFolderModal:e.PropTypes.func},_renderAvatar:function(){return t({dimension:c.SMALL,photoUrl:this.props.avatarPhotoUrl,defaultAvatar:n({dimension:c.SMALL,shape:this.props.groupId?"SQUARE":"CIRCLE",initials:this.props.avatarInitials,name:this.props.name})})},_renderDisplayName:function(){var e,t,n,i;return n=!this.props.inviteId&&this.props.name?this.props.name:this.props.emailOrFbname,this.props.memberUid===this.props.user.id?t=" "+h("(me)",i="web",e="this row represents the viewer herself."):this.props.sharedContentMemberId?t=" "+h("(link member)",i="web",e="inband view-only link member"):this.props.hasJoined||(t=" "+h("(pending)",i="web",e="this row represents one pending invitation.")),m.div({},m.a({className:"sf-display-name"},n),t?m.em({},t):void 0)},_renderAccessTypeSettings:function(){return this.props.hideAccessTypeDropdown?m.div({className:"sf-can-edit-text"},this.props.accessType):m.div({className:"sf-can-edit sf-can-edit-text"},d({name:"access_type","disable-errors":!0,defaultValue:this.props.accessType},this.props.canMakeEditor?p({value:"can edit"},h("can edit")):void 0,p({value:"can view",disabled:!this.props.canMakeViewer},h("can view")),this.props.canMakeOwner?p({value:"make owner"},h("make owner")):void 0,this.props.showUpsell?p({value:"upsell"},h("Upgrade to enable viewer permission")):void 0))},_removeButtonClicked:function(){return this.props.inviteId?this.props.showUninviteModal(this.props.inviteId,this.props.emailOrFbname):this.props.memberUid?this.props.memberUid===this.props.user.id?this.props.amOwner?l.error(h("You can’t leave this folder because you’re the owner. You must transfer ownership to another member before you can leave.")):this.props.showLeaveFolderModal():this.props.showKickUserModal(this.props.memberUid,this.props.name):this.props.groupId?this.props.showKickGroupModal(this.props.groupId,this.props.name):void 0},_renderRemoveButton:function(){return m.div({className:"bs-actions remove-button"},this.props.showRemoveButton?m.a({},r({group:"web",name:"xclose",onClick:this._removeButtonClicked})):void 0)},render:function(){return m.div({className:_({"bs-row clearfix clear no-hover":!0,"avatars-enabled":!0,unmounted:this.props.memberUid&&!this.props.isMemberActive,unjoined:!this.props.hasJoined})},m.div({className:"sf-name"},this._renderAvatar(),this._renderDisplayName()),this._renderAccessTypeSettings(),this._renderRemoveButton())}})})}.call(this),function(){define("modules/clean/sharing/namespace_conversion_alert_modal",["external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/dbmodal","modules/clean/react/modal","modules/core/i18n"],function(e,t,n,i,o,s){var r,a,l,c,u;return r=i.DBModalStack,a=o.Modal,c=s._,u=e.DOM,l=e.createClass({statics:{showInstance:function(e){return a.showInstance(e)}},propTypes:{user:e.PropTypes.object.isRequired,req_url:e.PropTypes.string.isRequired,req_data:e.PropTypes.object.isRequired,success_callback:e.PropTypes.func.isRequired},getInitialState:function(){return{converting_to_shared_folder:!1}},render:function(){return a({title:c("Convert to shared folder?"),acceptButtonText:c("Continue"),acceptButtonDisabled:this.state.converting_to_shared_folder,dismissButtonText:c("Cancel"),autoClose:!1,onAccept:this._onAccept,onDismiss:this.close,submitting:this.state.converting_to_shared_folder,ref:"modal"},u.div({},c("For other people to edit files in this folder, you have to convert it into a shared folder. Do you want to continue?")))},_onAccept:function(){return this.state.converting_to_shared_folder?void 0:(n.SimpleSharingLogger.log(this.props.user.id,24),t.FormWebRequest({subject_user:this.props.user.id,url:this.props.req_url,data:this.props.req_data,skipErrorHandling:!0,success:function(e){return function(t){return e.isMounted()?(e.setState({converting_to_shared_folder:!1}),e.props.success_callback(t)):void 0}}(this),error:function(e){return function(){return e.isMounted()?e.setState({converting_to_shared_folder:!1}):void 0}}(this)}),this.setState({converting_to_shared_folder:!0}))},close:function(){return this.refs.modal.close()},componentDidMount:function(){return n.SimpleSharingLogger.log(this.props.user.id,23)}})})}.call(this),function(){define("modules/clean/sharing/non_namespace_manage_access_modal",["jquery","external/react","modules/clean/analytics","modules/clean/ajax","modules/clean/browse_events","modules/clean/dbmodal","modules/clean/em_string","modules/clean/filepath","modules/clean/react/button","modules/clean/react/modal","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v;return h=s.DBModalStack,_=c.Modal,f=u._,v=t.DOM,m=t.createClass({statics:{showInstance:function(e){return _.showInstance(e)}},propTypes:{user:t.PropTypes.object.isRequired,fq_path:t.PropTypes.string.isRequired,done_callback:t.PropTypes.func.isRequired},render:function(){var e;return e=r.em_snippet(a.filename(this.props.fq_path),16),_({title:f("Remove access to ‘%(filename)s’?").format({filename:e}),autoClose:!1,showX:!1,buttonComponent:this._renderButtons(),ref:"modal"},v.div({},f("You previously shared this folder and gave people permission to view it. If you remove their access, only you will be able to see it.")))},_renderButtons:function(){return v.div({className:"db-modal-buttons"},v.button({className:"dbmodal-button button-primary",onClick:this._remove_link_button_clicked},f("Remove access")),v.button({className:"dbmodal-button button-tertiary",onClick:function(e){return function(){return e._onDone(!1)}}(this)},f("Cancel")))},_onDone:function(e){return this.refs.modal.close(),this.props.done_callback.bind(null,!e)()},_remove_link_button_clicked:function(){return i.WebRequest({url:p({path:"/sm/disable_token_at_path"+a.normalize(this.props.fq_path)}),subject_user:this.props.user.id,type:"POST",success:function(t){return function(){return e(document).trigger(o.UPDATE),d.success(f("Link removed")),n.SimpleSharingLogger.log(t.props.user.id,25),t._onDone(!0)}}(this),error:function(){return function(){return d.error(f("An error occurred when removing link"))}}(this)})}})})}.call(this),function(){define("modules/clean/sharing/notifications",["jquery","modules/clean/browse_interface","modules/clean/sharing/share_client","modules/clean/viewer","modules/core/browser","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h;return c=n.ShareApiClient,l=n.FolderShareApiClient,u=s._,d=function(t){var n,i;return n=e(t).closest("form"),null!=(i=n.closest(".sc-invite-action"))&&i.addClass("loading"),n.length&&new c({userId:n[0]._subject_uid.value}).dismissInviteNotification({contentId:n[0].content_id.value}).done(function(){return n.closest(".sc-invite-action").removeClass("loading")}),!1},p=function(n){var s,r;return s=e(n),s.closest(".sc-invite-action").addClass("loading"),r=i.get_viewer().get_user_by_id(n._subject_uid.value),new l({userId:r.id}).mount({contentId:n.sf_id.value}).then(function(e){var n,i,l;return n=s.closest(".sc-invite-action"),n.addClass("sf-mounted"),i=e.path_lower,l=a({path:t.get_browse_root(r)+i}).toString(),o.redirect(l)}).finally(function(){return s.closest(".sc-invite-action").removeClass("loading")}),!1},h=function(){var e;return r.info(u("Continue upgrading to add the shared folder to your Dropbox.")),e=a({path:"/pro/buy"}),e.updateQuery({cont:"sf",oqa:"sf_aoq_b_n"}),o.redirect(e.toString()),!1},{register_dismiss:d,register_mount:p,upgrade_to_mount:h}})}.call(this),function(){var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty;define("modules/clean/sharing/share_client",["modules/clean/api_v2/client","modules/clean/api_v2/types","modules/clean/promise","modules/clean/sharing/constants"],function(t,n,i,o){var s,r,a,l,c,u,d,p,h,_,m,f,v,g,y;return v=t.UserActionClient,m=n.Union,f=n.UnionScalar,d=i.Promise,s=o.ACCESS_LEVEL,h=function(t){function n(e){this.message=e,this.name="ShareError",this.stack=(new Error).stack}return e(n,t),n}(Error),y=function(e){switch(e){case s.OWNER:return new f("owner");case s.WRITER:return new f("editor");case s.READER:return new f("viewer")}},g=function(e){switch(e.type){case"owner":return s.OWNER;case"editor":return s.WRITER;case"viewer":return s.READER}},c={team:new f("team"),anyone:new f("anyone")},r={owner:new f("owner"),editors:new f("editors")},_={anyone:new f("anyone"),members:new f("members")},p=function(){function e(e){this.userId=e.userId,this.client=new v}return e.prototype.addMembers=function(e){var t,n,i,o,s,r,a;throw n=e.contentId,o=e.memberEmails,t=e.accessLevel,i=null!=(r=e.customMessage)?r:null,s=null!=(a=e.quiet)?a:!1,new TypeError("Not implemented")},e.prototype.removeMember=function(e){var t,n;throw t=e.contentId,n=e.memberId,new TypeError("Not implemented")},e.prototype.changeMemberAccess=function(e){var t,n,i;throw t=e.contentId,n=e.memberId,i=e.newAccess,new TypeError("Not implemented")},e.prototype.getMetadata=function(e){var t;throw t=e.contentId,new TypeError("Not implemented")},e.prototype.listMembers=function(e){var t,n,i;throw t=e.contentId,n=null!=(i=e.cursor)?i:null,new TypeError("Not implemented")},e.prototype.dismissInviteNotification=function(e){var t;return t=e.contentId,this.client.rpc(this.userId,"sharing/dismiss_invite_notification",{content_id:t})},e}(),u=function(t){function n(){n.__super__.constructor.apply(this,arguments),this._promises={}}return e(n,t),n.prototype.addMembers=function(e){var t,n,i,o,s,r,a;return n=e.contentId,o=e.memberEmails,t=e.accessLevel,i=null!=(r=e.customMessage)?r:null,s=null!=(a=e.quiet)?a:!1,this.createPromise("addMembers")},n.prototype.changeMemberAccess=function(e){var t,n,i;return t=e.contentId,n=e.memberId,i=e.newAccess,this.createPromise("changeMemberAccess")},n.prototype.getMetadata=function(e){var t;return t=e.contentId,this.createPromise("getMetadata")},n.prototype.dismissInviteNotification=function(e){var t,n,i;return t=e.contentId,n=null!=(i=e.cursor)?i:null,this.createPromise("dismissInviteNotification")},n.prototype.listMembers=function(e){var t,n,i;return t=e.contentId,n=null!=(i=e.cursor)?i:null,this.createPromise("listMembers")},n.prototype.removeMember=function(e){var t,n;return t=e.contentId,n=e.memberId,this.createPromise("removeMembers")},n.prototype.share=function(e){var t,n,i,o,s,r,a,l,c;return i=e.fqPath,o=null!=(s=e.memberPolicy)?s:null,t=null!=(r=e.aclUpdatePolicy)?r:null,c=null!=(a=e.sharedLinkPolicy)?a:null,n=null!=(l=e.forceAsync)?l:!1,this.createPromise("shareFolder")},n.prototype.createPromise=function(e){var t;return t=this._promises[e],null==t&&(t={},t.promise=new d(function(e,n){return t.resolve=e,t.reject=n}),this._promises[e]=t),t.promise},n.prototype.getPromise=function(e){var t;return null!=(t=this._promises[e])?t.promise:void 0},n.prototype.resolvePromise=function(e,t){var n,i;return n=this._promises[e],null!=n&&null!=(i=n.resolve)&&i.apply(null,t),n.promise},n.prototype.rejectPromise=function(e,t){var n,i;return n=this._promises[e],null!=n&&null!=(i=n.reject)&&i.apply(null,t),n.promise},n}(p),a=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.addMembers=function(e){var t,n,i,o,s,r,a;return t=e.contentId,o=e.memberEmails,n=null!=(r=e.customMessage)?r:null,
s=null!=(a=e.quiet)?a:!1,this.client.rpc(this.userId,"sharing/add_file_members",{file_id:t,member_refs:function(){var e,t,n;for(n=[],e=0,t=o.length;t>e;e++)i=o[e],n.push(new f("email",i));return n}(),custom_message:n,quiet:s})},n.prototype.changeMemberAccess=function(e){var t,n,i;throw t=e.contentId,n=e.memberId,i=e.newAccess,new h("Not permitted for files")},n.prototype.getMetadata=function(e){var t;return t=e.contentId,this.client.rpc(this.userId,"sharing/get_metadata_for_files",{file_ids:[t]})},n.prototype.listMembers=function(e){var t,n,i,o,s;return t=e.contentId,i=null!=(o=e.limit)?o:100,n=null!=(s=e.cursor)?s:null,this.client.rpc(this.userId,"sharing/list_file_members",{file_ids:[t],limit:i,cursor:n}).then(function(e){var n,i,o,s,r,a,l;if(e=m.parse(e),"file_members_list_result"!==e.type)return d.reject(e);for(l=e.value.file_members_list,i=0,o=l.length;o>i;i++){if(n=l[i],a=m.parse(n),"file_members"!==a.type)return d.reject(a);if(a.value.file_id===t)return r=function(){var e,t,n,i;for(n=a.value.members,i=[],e=0,t=n.length;t>e;e++)s=n[e],i.push({displayName:s.display_name,isInherited:s.is_inherited,memberId:2});return i}(),d.resolve(r)}return d.reject("no such members")})},n}(p),l=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.share=function(e){var t,n,i,o,s,r,a,l,c,u;return o=e.fqPath,s=null!=(r=e.memberPolicy)?r:null,t=null!=(a=e.aclUpdatePolicy)?a:null,u=null!=(l=e.sharedLinkPolicy)?l:null,i=null!=(c=e.forceAsync)?c:!1,n={path:o},null!=s&&(n.member_policy=s),null!=t&&(n.acl_update_policy=t),null!=u&&(n.shared_link_policy=u),this.client.rpc(this.userId,"sharing/share_folder",n)},n.prototype.addMembers=function(e){var t,n,i,o,s,r,a,l,c,u;return o=e.contentId,a=e.memberEmails,t=e.accessLevel,s=null!=(c=e.customMessage)?c:null,l=null!=(u=e.quiet)?u:!1,i=y(t),n={shared_folder_id:o,members:function(){var e,t,n;for(n=[],e=0,t=a.length;t>e;e++)r=a[e],n.push({member:new f("email",r),access_level:i});return n}(),custom_message:s,quiet:l},this.client.rpc(this.userId,"sharing/add_folder_member",n)},n.prototype.getMetadata=function(e){var t;return t=e.contentId,this.client.rpc(this.userId,"sharing/get_folder_metadata",{shared_folder_id:t})},n.prototype.listMembers=function(e){var t,n,i,o,s;return t=e.contentId,i=null!=(o=e.limit)?o:100,n=null!=(s=e.cursor)?s:null,this.client.rpc(this.userId,"sharing/list_folder_members",{shared_folder_id:t})},n.prototype.mount=function(e){var t;return t=e.contentId,this.client.rpc(this.userId,"sharing/mount_folder",{shared_folder_id:t})},n.prototype.unmount=function(e){var t;return t=e.contentId,this.client.rpc(this.userId,"sharing/unmount_folder",{shared_folder_id:t})},n}(p),{FileShareApiClient:a,FolderShareApiClient:l,MockShareApiClient:u,ShareError:h,ShareApiClient:p}})}.call(this),function(){define("modules/clean/sharing/share_inband",["jquery","external/underscore","modules/clean/ajax","modules/clean/analytics","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/contacts/tokenizer","modules/clean/contacts/types","modules/clean/em_string","modules/clean/file_events","modules/clean/filepath","modules/clean/form","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/select","modules/clean/sharing/inband_link_settings_modal","modules/clean/sharing/namespace_conversion_alert_modal","modules/clean/sharing/shared_folder_settings_modal","modules/clean/sharing/shared_link_for_sf","modules/clean/sharing/constants","modules/clean/viewer","modules/core/exception","modules/core/i18n","modules/core/notify","external/react"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S){var T,A,I,k,P,N,R,x,O,L,D,M,F;return k=o.EmailVerification,I=r.ContactsTokenizer,A=r.ContactTokenValidator,T=r.ContactTokenState,P=h.Modal,N=y.NameSpaceAccess,L=w.assert,O=C._,F=C.ungettext,D=S.createElement,M=S.DOM,R=function(){function t(){}return t.createAndShowModal=function(t,i,o,r,p,h,_,g){var y,b,w,C,S,T;return k.get_for_user(t).verified_or_show(s.SHARE_FOLDER)?(S=l.em_snippet(u.filename(i),16),T=O("Share ‘%(filename)s’ with others").format({filename:S}),y=O(r?"Who do you want to share this folder with?":"Who do you want to share this file with?"),w=function(e,t,n,i,o,s){return P.showInstance(D(v,{user:e,fq_path:t,is_shared_folder:n,ns_id:i,initial_allows_editor_manage_membership:o,done_callback:s}))},C=function(e,t,n,i){return P.showInstance(D(m,{user:e,fqPath:t,teamName:n,doneCallback:i}))},b=function(o,s,l,u,m,v,g){var y,b,w,C,T,A,I;if(w=function(){var e,t,n;for(n=[],e=0,t=o.length;t>e;e++)y=o[e],y.type===a.EMAIL&&n.push(y.email);return n}(),C=function(){var e,t,n;for(n=[],e=0,t=o.length;t>e;e++)y=o[e],y.type===a.FB&&n.push(y.fb_id);return n}(),T=function(){var e,t,n;for(n=[],e=0,t=o.length;t>e;e++)y=o[e],y.type===a.NEW_STYLE_GROUP&&n.push(y.group_id);return n}(),A=w.length+C.length+T.length,I=function(t,n,i){var o,s,r,a,l,u;return r=d.parse_response(t),l=r[0],s=r[1],l?(n&&e(document).trigger(c.SF_NEW),i?E.success(s):(u=F("Shared ‘%(filename)s’!","Shared ‘%(filename)s’ with %(num_recipients)s people!",A),E.success(u.format({filename:S,num_recipients:A}))),e(document).trigger("db:sharing_api:request_succeeded",{request_url:"",ns_id:p}),P.close()):(a=d.parse_error(s),l=a[0],o=a[1],l?E.error(o):E.error())},"edit"===s)if(h)n.FormWebRequest({subject_user:t.id,url:"/share_ajax/invite_more",data:{ns_id:p,emails:w,fb_ids:C,new_style_group_ids:T,custom_message:l,access_type:N.ACCESS_WRITER,is_simple_sharing:!0},skipErrorHandling:!0,success:function(e){return I(e,!1,!0)}});else{if(!_)return r?L(!1,"Tried to share unshareable folder with edit access"):E.error(O("Not implemented yet!"));b={path:i,emails:w,fb_ids:C,new_style_group_ids:T,custom_message:l,access_type:N.ACCESS_WRITER,is_simple_sharing:!0,folder_settings:1,shared_link_policy:g?g:void 0,audience:m?m:void 0,inviter:v?v:u?void 0:"me"},(b.audience||b.inviter)&&(b.custom_folder_settings=1),P.showInstance(D(f,{user:t,req_url:"/share_ajax/existing",req_data:b,success_callback:function(e){var t;return t=JSON.parse(e),null!=t.invite_message?I(t.invite_message,!0,!0):I(e,!0,!1)}}))}else n.FormWebRequest({subject_user:t.id,url:"/sm/share_inband",data:{fq_path:i,emails:w,fb_ids:C,new_style_group_ids:T,is_simple_sharing:!0,custom_message:l},skipErrorHandling:!0,success:function(e){return I(e,!1,!0)}})},P.showInstance(D(x,{user:t,fq_path:i,is_dir:r,title:T,recipient_prompt:y,send_handler:b,show_dfb_existing_folder_settings_modal:o.show_dfb_existing_folder_settings_modal,show_dfb_new_folder_settings_modal:o.show_dfb_new_folder_settings_modal,show_personal_folder_settings_modal:w,show_view_settings_modal:C,initial_access_type:"view",allows_edit:h||_,target_ns_id:p,is_shared_folder:h,sf_perm_role:g,could_be_shared_folder:_,initial_allows_editor_manage_membership:!h,initial_message:"",initial_show_message_field:!1}))):void 0},t}(),x=S.createClass({displayName:"ShareInbandModal",propTypes:{title:S.PropTypes.string.isRequired,user:S.PropTypes.object.isRequired,fq_path:S.PropTypes.string.isRequired,is_dir:S.PropTypes.bool.isRequired,recipient_prompt:S.PropTypes.string.isRequired,initial_access_type:S.PropTypes.string.isRequired,allows_edit:S.PropTypes.bool.isRequired,send_handler:S.PropTypes.func.isRequired,show_dfb_existing_folder_settings_modal:S.PropTypes.func.isRequired,show_dfb_new_folder_settings_modal:S.PropTypes.func.isRequired,show_personal_folder_settings_modal:S.PropTypes.func.isRequired,show_view_settings_modal:S.PropTypes.func.isRequired,target_ns_id:S.PropTypes.number,is_shared_folder:S.PropTypes.bool.isRequired,sf_perm_role:S.PropTypes.number.isRequired,could_be_shared_folder:S.PropTypes.bool.isRequired,tokenizer_input:S.PropTypes.shape,initial_allows_editor_manage_membership:S.PropTypes.bool,initial_audience_restriction:S.PropTypes.string,initial_inviter_restriction:S.PropTypes.string,initial_shared_link_policy_restriction:S.PropTypes.string,initial_message:S.PropTypes.string,initial_show_message_field:S.PropTypes.bool},getInitialState:function(){return{access_type:this.props.initial_access_type,tokens:[],show_message_field:this.props.initial_show_message_field,allows_editor_manage_membership:this.props.initial_allows_editor_manage_membership,audience_restriction:this.props.initial_audience_restriction,inviter_restriction:this.props.initial_inviter_restriction,shared_link_policy_restriction:this.props.initial_shared_link_policy_restriction}},componentDidMount:function(){var e;return e="m1",i.SimpleSharingLogger.log(this.props.user.id,14,null,e),this.props.is_shared_folder&&this._updateAllowingEditorManageMembership(),this.state.show_message_field?this.refs.message_field.getDOMNode().value=this.props.initial_message:void 0},shouldComponentUpdate:function(e,n){return!t.isEqual(e,this.props)||!t.isEqual(n,this.state)},render:function(){var e;return e=this._getCustomContactValidator(),D(P,{autoClose:!1,title:this.props.title,ref:"modal",buttonComponent:this._renderButtons()},M.div({className:"share-inband-container"},M.div({className:"prompt-line"},this.props.recipient_prompt),M.div({className:"recipients-container o-flag o-flag--rev o-flag--top"},D(I,{ref:"tokenizer",customClass:"recipients-tokenizer o-flag__flex",user:this.props.user,onContentsChange:this._setTokens,populatedInputData:this.props.tokenizer_input,customContactValidator:e,showContactImport:!0}),this.props.is_dir?this._renderEditDropdown():void 0),this.state.show_message_field?M.div({className:"custom-message-container sick-input small"},M.textarea({ref:"message_field",className:"textinput act_as_block",placeholder:O("Message (optional)")}),this._renderSettingsLink()):void 0,this._renderExternalTokenWarning(e)))},close:function(){return this.refs.modal.close()},get_message:function(){var e;return e=this.refs.message_field,e?e.getDOMNode().value:""},generate_share_inband_restore_callback:function(){var e,t,n,i,o;return i=this._getSerializedData(),e=this.state.access_type,t=this.get_message(),o=this.state.show_message_field,n=this.restore_inband_modal.bind(null,i,e,t,o)},_renderEditDropdown:function(){return D(_.input,{ref:"access",className:"invite-access o-flag__fix",value:this.state.access_type,onChange:function(e){return function(t,n){return e.props.allows_edit||"edit"!==n||(E.error(O("Can’t invite others to edit this folder.")),n="view"),e.setState({access_type:n})}}(this)},D(_.option,{value:"view"},O("can view")),D(_.option,{value:"edit",disabled:!this._can_edit()},O("can edit")))},_getCustomContactValidator:function(){return A.basic},_renderButtons:function(){return M.div({className:"db-modal-buttons share-inband-buttons"},D(g,{fq_path:this.props.fq_path,user:this.props.user,is_dir:this.props.is_dir,is_shared_folder:this.props.is_shared_folder,could_be_shared_folder:this.props.could_be_shared_folder,can_edit:this._can_edit(),generate_share_inband_restore_callback:this.generate_share_inband_restore_callback.bind(this)}),M.button({className:"dbmodal-button button-primary send-button",onClick:function(e){return function(){var t;return t=e._getRecipients(),0===t.length?void E.error(O("No one to share with! Please enter a valid recipient.")):e.props.send_handler(t,e.state.access_type,e.get_message(),e.state.allows_editor_manage_membership,e.state.initial_audience_restriction,e.state.initial_inviter_restriction,e.state.initial_shared_link_policy_restriction)}}(this)},O("Send")))},_setTokens:function(e){return this.setState({tokens:e}),this._validate_input(e)?this.setState({show_message_field:!0}):void 0},_validate_input:function(e){var t,n,i;for(n=0,i=e.length;i>n;n++)if(t=e[n],!t.invalid)return!0},_renderExternalTokenWarning:function(e){var t,n,i,o,s,r,a;if(!this.props.user.is_team)return!1;for(o=0,s=this.state.tokens,n=0,i=s.length;i>n;n++)t=s[n],t.invalid||e(t).state!==T.warn||(o+=1);return o>0?(r=b.get_viewer().team_name,a=O("Sharing with %(warned_tokens)s people outside of %(team_name)s").format({warned_tokens:o,team_name:r}),1===o&&(a=O("Sharing with 1 person outside of %(team_name)s").format({team_name:r})),M.span({className:"external-token-warning"},M.img({src:"/static/images/teams/sharefolder_warning-vflzbBoRL.png"}),a)):!1},_renderSettingsLink:function(){var e;return e="",e=O("edit"===this.state.access_type?this.props.is_dir?"You’re sending a link to edit this folder.":"You’re sending a link to edit this file.":this.props.is_dir?"You’re sending a link to view this folder.":"You’re sending a link to view this file."),this._can_see_settings_for_shared_folder()?M.div({className:"settings-line"},e,D(p.link_button,{className:"settings-link",importance:"standard",onClick:function(e){return function(){return e._showSettings()}}(this)},O("Change settings"))):this.props.is_dir?void 0:M.div({className:"settings-line"},e)},_showSettings:function(){var e,t,n,i,o,s,r;return s=this._getSerializedData(),e=this.state.access_type,t=this.get_message(),r=this.state.show_message_field,n=this.restore_inband_modal.bind(null,s,e,t,r),i=this.restore_inband_modal_with_allows_editor_manage_membership.bind(null,s,e,t,r),o=this.restore_inband_modal_with_saved_state.bind(null,s,e,t,r),P.close(),"edit"===this.state.access_type?"work"===this.props.user.role?this.props.is_shared_folder?this.props.show_dfb_existing_folder_settings_modal(this.props.user,this.props.fq_path,this.props.target_ns_id,n):this.props.show_dfb_new_folder_settings_modal(this.props.user,this.props.fq_path,{audience:this.props.initial_audience_restriction,inviter:this.props.initial_inviter_restriction,shared_link_policy:this.props.initial_shared_link_policy_restriction},o):this.props.show_personal_folder_settings_modal(this.props.user,this.props.fq_path,this.props.is_shared_folder,this.props.target_ns_id,this.props.initial_allows_editor_manage_membership,i):"view"===this.state.access_type?this.props.show_view_settings_modal(this.props.user,this.props.fq_path,b.get_viewer().team_name,n):void 0},_updateAllowingEditorManageMembership:function(){return this.props.is_shared_folder?n.WebRequest({url:"/share_ajax/members_can_invite",data:{ns_id:this.props.target_ns_id},subject_user:this.props.user.id,dataType:"json",success:function(e){return function(t){return e.isMounted()?e.setState({allows_editor_manage_membership:t.allows_editor_manage_membership}):void 0}}(this)}):void 0},_can_see_settings_for_shared_folder:function(){return this.props.could_be_shared_folder||this.props.is_shared_folder&&this.props.sf_perm_role===N.ACCESS_OWNER},_can_edit:function(){return!this.props.is_shared_folder||this.props.sf_perm_role===N.ACCESS_OWNER||this.props.sf_perm_role===N.ACCESS_WRITER&&this.state.allows_editor_manage_membership},_getSerializedData:function(){return this.refs.tokenizer.serializeInputData()},_getRecipients:function(){return this.refs.tokenizer.getContacts()},restore_inband_modal:function(e,t,n,i){return this.restore_inband_modal_with_settings(e,t,n,i,this.state.allows_editor_manage_membership,this.state.audience_restriction,this.state.inviter_restriction,this.state.shared_link_policy_restriction)},restore_inband_modal_with_allows_editor_manage_membership:function(e,t,n,i,o){return this.restore_inband_modal_with_settings(e,t,n,i,o,this.state.audience_restriction,this.state.inviter_restriction,this.state.shared_link_policy_restriction)},restore_inband_modal_with_saved_state:function(e,t,n,i,o,s,r){return this.restore_inband_modal_with_settings(e,t,n,i,this.state.allows_editor_manage_membership,o,s,r)},restore_inband_modal_with_settings:function(e,t,n,i,o,s,r,a){var l;return l=D(x,{user:this.props.user,fq_path:this.props.fq_path,is_dir:this.props.is_dir,title:this.props.title,recipient_prompt:this.props.recipient_prompt,send_handler:this.props.send_handler,show_dfb_existing_folder_settings_modal:this.props.show_dfb_existing_folder_settings_modal,show_dfb_new_folder_settings_modal:this.props.show_dfb_new_folder_settings_modal,show_personal_folder_settings_modal:this.props.show_personal_folder_settings_modal,show_view_settings_modal:this.props.show_view_settings_modal,initial_access_type:t,allows_edit:this.props.is_shared_folder||this.props.could_be_shared_folder,target_ns_id:this.props.target_ns_id,is_shared_folder:this.props.is_shared_folder,sf_perm_role:this.props.sf_perm_role,could_be_shared_folder:this.props.could_be_shared_folder,tokenizer_input:e,initial_allows_editor_manage_membership:o,initial_audience_restriction:s,initial_inviter_restriction:r,initial_shared_link_policy_restriction:a,initial_message:n,initial_show_message_field:i}),P.showInstance(l)}}),{ShareInband:R,ShareInbandModal:x}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/sharing/share_modal",["external/react","external/underscore","modules/clean/js_environment","modules/clean/promise","modules/clean/react/modal","modules/clean/react/util","modules/clean/sharing/constants","modules/clean/sharing/content_info","modules/clean/sharing/share_client","modules/clean/sharing/ui_util","modules/clean/sharing/views/modal_content","modules/clean/user","modules/core/notify"],function(t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C,E,S,T,A,I,k;return b=s.Modal,k=r.setStatePromise,_=a.ACCESS_LEVEL,m=a.ACCESS_VALUES,f=l.ContentInfo,v=c.FileShareApiClient,g=c.FolderShareApiClient,E=c.ShareApiClient,C=u.SHARE_UI_TYPE,T=d.ShareModalContent,y=d.MODES,A=t.createElement,I=t.DOM,w=o.Promise,S=t.createClass({displayName:"ShareModal",statics:{show:function(e,t,n){var i;return i=function(){switch(n){case C.SHARED_FOLDER:return new g({userId:e.id});case C.SHARED_FILE:return new v({userId:e.id});default:throw new Error("Unknown shareType")}}(),b.showInstance(A(S,{client:i,contentInfo:f.fromBrowseFile(t),user:e}))}},propTypes:{client:t.PropTypes.instanceOf(E),contentInfo:t.PropTypes.instanceOf(f).isRequired,defaultAccess:t.PropTypes.oneOf(m),user:t.PropTypes.instanceOf(p).isRequired},getDefaultProps:function(){return{client:null,defaultAccess:_.WRITER}},getInitialState:function(){return{customMessage:"",isMetadataLoaded:!1,uiMode:y.MEMBERSHIP,recipientAccess:this.props.contentInfo.shareAsSharedFolder?this.props.defaultAccess:_.READER,recipientTokens:[],recipientRawInput:null}},componentWillMount:function(){var e;return i.isBrowser()?(e=this._getClient(),this.props.contentInfo.shareAsSharedFolder&&!this.props.contentInfo.isSharedFolder?this._handleAllLoadSuccess():this.initialLoadingPromise=o.all([e.getMetadata({contentId:this.props.contentInfo.id}).then(this._handleGetMetadataSuccess),e.listMembers({contentId:this.props.contentInfo.id}).then(this._handleListMembersSuccess)]).then(this._handleAllLoadSuccess)):void 0},render:function(){return A(b,{style:"bare",acceptButtonText:null,dismissButtonText:null,headerId:"unified-share-modal-title",ref:"modal"},A(T,n.extend({allowedAccess:this._getAllowedAccess(),contentInfo:this.props.contentInfo,customMessage:this.state.customMessage,headerId:"unified-share-modal-title",onCloseClick:this._handleCloseClick,onContactsChange:this._handleRecipientChange,onMemberAccessChange:this._handleMemberAccessChange,onMessageChange:this._handleMessageChange,onRecipientAccessChange:this._handleRecipientAccessChange,onSend:this._handleSend,mode:this._getUIMode(),recipientAccess:this.state.recipientAccess,recipientRawInput:this.state.recipientRawInput,recipientTokens:this.state.recipientTokens,user:this.props.user},this.props)))},_getClient:function(){return null!=this.props.client?this.props.client:this.props.contentInfo.shareAsSharedFolder?new g({userId:this.props.user.id}):new v({userId:this.props.user.id})},_getAllowedAccess:function(){return this.props.contentInfo.shareAsSharedFolder?[_.READER,_.WRITER]:[_.READER]},_getRecipients:function(){var e;return function(){var t,n,i,o;for(i=this.state.recipientTokens,o=[],t=0,n=i.length;n>t;t++)e=i[t],o.push(e.email);return o}.call(this)},_getUIMode:function(){return this.state.uiMode!==y.MEMBERSHIP||this.state.isMetadataLoaded?this.state.uiMode:y.LOADING},_handleMemberAccessChange:function(){},_handleCloseClick:function(){var e;return this.isMounted()&&null!=(e=this.refs.modal)?e.close():void 0},_handleRecipientAccessChange:function(t){return this.isMounted()&&e.call(this._getAllowedAccess(),t)>=0?this.setState({recipientAccess:t}):void 0},_handleRecipientChange:function(e,t){var n,i,o;return this.isMounted()?(n={recipientRawInput:t,recipientTokens:e},e.length>0||t.length>0?((i=this.state.uiMode)===y.MEMBERSHIP||i===y.SHARE_TOKENIZING)&&(n.uiMode=y.SHARE):0!==this.state.customMessage.length||(o=this.state.uiMode)!==y.SHARE&&o!==y.SHARE_TOKENIZING||(n.uiMode=y.MEMBERSHIP),this.setState(n)):void 0},_handleMessageChange:function(e){return this.isMounted()?this.setState({customMessage:e}):void 0},_handleSend:function(){var e;return e=this._getRecipients(),e.length>0?(this.props.contentInfo.shareAsSharedFolder&&!this.props.contentInfo.id?this._getClient().share({fqPath:this.props.contentInfo.fqPath}).then(function(e){return{contentId:e.shared_folder_id}}):w.resolve({contentId:this.props.contentInfo.id})).then(function(t){return function(n){var i,o;return o=n.contentId,i=t._getClient(),t._getClient().addMembers({accessLevel:t.state.recipientAccess,contentId:o,customMessage:t.state.customMessage,memberEmails:e})}}(this)).then(function(e){return function(){var t;return h.success("Shared securely"),null!=(t=e.refs.modal)?t.close():void 0}}(this)).catch(function(e){return function(){return console.log(arguments),e.isMounted()?k(e,{uiMode:y.SHARE}):void 0}}(this)):void 0},_handleGetMetadataSuccess:function(){},_handleListMembersSuccess:function(){},_handleAllLoadSuccess:function(){return this.isMounted()?k(this,{isMetadataLoaded:!0}):void 0}})})}.call(this),function(){define("modules/clean/sharing/shared_content_link_sync_modal",["external/react","modules/clean/em_string","modules/clean/react/button","modules/clean/react/image","modules/clean/react/modal","modules/clean/sharing/i18n","modules/clean/static_urls"],function(e,t,n,i,o,s,r){var a,l,c,u,d,p,h;return u=n.button,a=o.Modal,c=s._,h=r.static_url,p=e.DOM,d=e.createElement,l=e.createClass({statics:{showInstance:function(e){return a.showInstance(e)}},displayName:"SharedContentLinkSyncModal",propTypes:{accessLevel:e.PropTypes.string.isRequired,folderName:e.PropTypes.string.isRequired,folderSize:e.PropTypes.string.isRequired,syncSharedFolderCallback:e.PropTypes.func.isRequired},render:function(){return d(a,{autoClose:!1,buttonComponent:this.renderButtons(),className:"content-link-sync-modal",clickOutToClose:!1,ref:"modal",showX:!1,title:!1},p.div({className:"content-link-sync-modal__content"},p.div({className:"content-link-sync-modal__top-panel"},d(i,{className:"content-link-sync-modal__shared-folder-img",src:h("/static/images/sharing/shared_folder-vfl0ua6f1.png"),srcHiRes:h("/static/images/sharing/shared_folder@2x-vfl55uXBw.png")}),p.div({className:"content-link-sync-modal__shared-folder-name"},t.em_snippet(this.props.folderName,30)),p.div({className:"content-link-sync-modal__shared-folder-size"},this.props.folderSize)),p.div({className:"content-link-sync-modal__tip-panel"},p.span({className:"content-link-sync-modal__tip-head"},c("Tip:")),p.span({className:"content-link-sync-modal__tip-body"},c("can_view"===this.props.accessLevel?"Add this folder to your Dropbox to see it on all your devices and get updates about changes.":"To edit this folder, add it to your Dropbox")))))},renderButtons:function(){return p.div({},d(u,{importance:"primary",className:"content-link-sync-modal__add-to-dropbox-button",onClick:this.onSyncButtonClicked},c("Add to my Dropbox")),p.div({},p.a({className:"content-link-sync-modal__not-now-label",href:"#",onClick:function(e){return function(){return e.refs.modal.close()}}(this)},c("Not now"))))},onSyncButtonClicked:function(){return this.props.syncSharedFolderCallback(),this.refs.modal.close()}})})}.call(this),function(){define("modules/clean/sharing/shared_folder_settings_modal",["external/react","modules/clean/ajax","modules/clean/em_string","modules/clean/filepath","modules/clean/form","modules/clean/react/modal","modules/core/i18n","modules/core/notify"],function(e,t,n,i,o,s,r,a){var l,c,u,d;return l=s.Modal,u=r._,d=e.DOM,c=e.createClass({displayName:"SharedFolderSettingsModal",statics:{showInstance:function(e){return l.showInstance(e)}},propTypes:{user:e.PropTypes.object.isRequired,fq_path:e.PropTypes.string.isRequired,is_shared_folder:e.PropTypes.bool.isRequired,ns_id:e.PropTypes.number,initial_allows_editor_manage_membership:e.PropTypes.bool.isRequired,done_callback:e.PropTypes.func.isRequired},getInitialState:function(){return{allows_manage_membership:this.props.initial_allows_editor_manage_membership}},render:function(){var e;return e=n.em_snippet(i.filename(this.props.fq_path),16),l({title:u("‘%(filename)s’ settings").format({filename:e}),acceptButtonText:u("Done"),autoClose:!1,showX:!1,onAccept:this._onDone,ref:"modal"},d.div({},d.input({type:"checkbox",onChange:this._checkboxUpdated,checked:this.state.allows_manage_membership,id:"allows-manage-membership-setting"}),d.label({className:"simple-sharing-allows-manage-membership-label",htmlFor:"allows-manage-membership-setting"},u("Allow anyone who can edit to manage membership of this folder"))))},_onDone:function(){return this.refs.modal.close(),this.props.done_callback.bind(null,this.state.allows_manage_membership)()},_checkboxUpdated:function(e){var n;return this.props.is_shared_folder?(n=e.target.checked?1:0,t.WebRequest({subject_user:this.props.user.id,url:"/share_ajax/change_sf_perm",data:{ns_id:this.props.ns_id,new_permissions:n},success:function(e){return function(t){var i,s,r;if(s=o.parse_response(t),r=s[0],i=s[1],r){if(a.success(u(1===n?"Editors can now manage membership of this folder.":"Editors can no longer manage membership of this folder")),!e.isMounted())return;return e.setState({allows_manage_membership:1===n})}return a.error(i)}}(this)})):this.setState({allows_manage_membership:e.target.checked})}})})}.call(this),function(){define("modules/clean/sharing/shared_link_for_sf",["external/react","modules/clean/react/button","modules/clean/react/sprite_div","modules/clean/sharing/shared_link_modal","modules/core/i18n"],function(e,t,n,i,o){var s,r,a;return r=o._,a=e.DOM,s=e.createClass({statics:{showInstance:function(t,n){return e.render(t,n)}},propTypes:{fq_path:e.PropTypes.string.isRequired,user:e.PropTypes.object.isRequired,is_dir:e.PropTypes.bool.isRequired,is_shared_folder:e.PropTypes.bool.isRequired,could_be_shared_folder:e.PropTypes.bool.isRequired,can_edit:e.PropTypes.bool.isRequired,generate_share_inband_restore_callback:e.PropTypes.func},render:function(){return a.div({className:"get-link-button-spinner"},a.button({className:"get-link-button dbmodal-button button-tertiary",onClick:function(e){return function(){var t;return t=e.props.generate_share_inband_restore_callback(),i.showInstance(i({needsFetchingTokenInfo:!0,user:e.props.user,fqPath:e.props.fq_path,isDir:e.props.is_dir,canReaderSync:!1,isSharedFolder:e.props.is_shared_folder,couldBeSharedFolder:e.props.could_be_shared_folder,canEdit:e.props.can_edit,editableLinksM2Enabled:!1,onGoBackButtonClicked:t}))}}(this)},n({group:"web",name:"s_link",text:r("Get link")})))}})})}.call(this),function(){define("modules/clean/sharing/shared_link_modal",["jquery","external/flash_detect","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/browse_events","modules/clean/clipboard","modules/clean/dbmodal","modules/clean/em_string","modules/clean/file_events","modules/clean/filepath","modules/clean/form","modules/clean/react/modal","modules/clean/sharing/namespace_conversion_alert_modal","modules/clean/sharing/constants","modules/clean/react/select","modules/clean/react/sprite_div","modules/clean/viewer","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b){var w,C,E,S,T,A,I,k,P;return w=a.DBModalStack,C=p.Modal,T=p.SimpleModal,E=_.SHMODEL_LINK_TOKEN_VISIBILITY,A=g._,P=n.DOM,k=n.addons.classSet,I=t.installed,S=n.createClass({statics:{showInstance:function(e){return w.pop(),C.showInstance(e)}},propTypes:{needsFetchingTokenInfo:n.PropTypes.bool.isRequired,user:n.PropTypes.object.isRequired,fqPath:n.PropTypes.string.isRequired,isDir:n.PropTypes.bool.isRequired,canReaderSync:n.PropTypes.bool.isRequired,isSharedFolder:n.PropTypes.bool.isRequired,couldBeSharedFolder:n.PropTypes.bool.isRequired,canEdit:n.PropTypes.bool.isRequired,initialLink:n.PropTypes.string,initialTkey:n.PropTypes.string,initialEditable:n.PropTypes.bool,initialVisibility:n.PropTypes.number,initialExpiryPosix:n.PropTypes.string,initialExpiryDays:n.PropTypes.string,initialExpiryText:n.PropTypes.string,editableLinksM2Enabled:n.PropTypes.bool,showSharedLinkSettingsModal:n.PropTypes.func,onGoBackButtonClicked:n.PropTypes.func},getInitialState:function(){return{hasFetchedTokenInfo:!this.props.needsFetchingTokenInfo,link:this.props.initialLink,tkey:this.props.initialTkey,editable:this.props.initialEditable,visibility:this.props.initialVisibility,expiryPosix:this.props.initialExpiryPosix,expiryDays:this.props.initialExpiryDays,expiryText:this.props.initialExpiryText}},componentDidMount:function(){return this.props.needsFetchingTokenInfo?this._fetchTokenInfo():void this._setupCopyToClipboard()},_fetchTokenInfo:function(){return i.WebRequest({url:b({path:"/sm/token_for_sf"+u.normalize(this.props.fqPath)}),subject_user:this.props.user.id,data:{ask_for_editable:this.props.editableLinksM2Enabled},type:"POST",dataType:"json",success:function(t){return function(n){return e(document).trigger(s.UPDATE),t.isMounted()?"ok"===n.status?(t.setState({hasFetchedTokenInfo:!0,link:n.link,tkey:n.tkey,editable:n.editable,visibility:n.visibility,expiryPosix:n.expiry_posix,expiryDays:n.expiry_days,expiryText:n.expiry_text}),t._setupCopyToClipboard(),t.refs.input.getDOMNode().select()):"error"===n.status?(y.error(n.msg),t.refs.modal.close()):void 0:void 0}}(this),error:function(e){return function(){return e.isMounted()?e.refs.modal.close():void 0}}(this)})},render:function(){var e,t;return t=l.em_snippet(u.filename(this.props.fqPath),16),e=A(I?"Copy Link":"Done"),C({title:A("Share ‘%(filename)s’ with others").format({filename:t}),buttonComponent:this._renderButtons(e),ref:"modal"},this.state.hasFetchedTokenInfo?P.div({className:"simple-sharing-share-link-modal-content"},this.props.editableLinksM2Enabled?P.div({},this._renderTopLabelForM2()):P.div({className:"simple-sharing-access-label"},this._renderAccessLabel()),P.div({className:"simple-sharing-link-field o-flag o-flag--rev o-flag--top"},P.div({className:"text-input small o-flag__flex"},P.div({className:"text-input-wrapper"},P.input({readOnly:!0,type:"text",value:this.state.link,ref:"input",className:k({"text-input-input":!0,"editable-link-m2-input":this.props.editableLinksM2Enabled}),onClick:this._selectAllText}),this.props.editableLinksM2Enabled?P.a({href:"#",onClick:this._onRemoveLinkButtonClicked,className:"close-button"},f({group:"web",name:"xclose"})):void 0)),!this.props.editableLinksM2Enabled&&this.props.isDir?this._renderEditDropdown():void 0),this.props.editableLinksM2Enabled?this._renderBottomLabelForM2():void 0):this._renderLoadingSpinner())},_renderButtons:function(e){return P.div({className:"db-modal-buttons simple-sharing-link-modal-buttons"},this.props.onGoBackButtonClicked&&this.props.editableLinksM2Enabled?P.button({className:"button-tertiary go-back-button",onClick:function(e){return function(){return e.refs.modal.close(),e.props.onGoBackButtonClicked(e.props.fqPath)}}(this)},A("Go back")):void 0,P.button({className:"dbmodal-button button-primary",onClick:function(e){return function(){return I?void 0:e.refs.modal.close()}}(this)},e))},_renderTopLabelForM2:function(){return P.h2({className:"simple-sharing-top-label"},A("Link to folder"))},_renderAccessLabel:function(){return P.label({className:"access-label"},this.state.editable?this._renderWhoCanAccessEditLabel(this.state.visibility):this._renderWhoCanAccessViewLabel(this.state.visibility));

},_renderBottomLabelForM2:function(){return P.div({className:"simple-sharing-bottom-label"},this._renderAccessLabel(),this._renderExpiryInfo(),P.span({className:"change-settings",onClick:this._onClickChangeSettings},A("Change password / add expiration")),P.span({className:"access-label"},A(".")))},_renderExpiryInfo:function(){return this.state.expiryPosix?P.label({className:"expiry-info"},A("The link will expire in %(expiry_days)s days (%(expiry_text)s).").format({expiry_days:this.state.expiryDays,expiry_text:this.state.expiryText})):void 0},_setupCopyToClipboard:function(){var t,n;return t=e(".simple-sharing-link-field").parent().parent(),I?(n=function(e){return function(){var t;return y.success(A("Link copied.")),t=e.props.editableLinksM2Enabled?"m2":"m1",o.SimpleSharingLogger.log(e.props.user.id,17,e.state.editable,t),e.refs.modal.close()}}(this),r.clipboard_overlay(t.find(".simple-sharing-link-field .text-input-wrapper input").val(),t.find(".button-primary"),n,t.find(".simple-sharing-link-field"))):void 0},_renderLoadingSpinner:function(){return P.div({className:"member-container spinner-div"},P.img({className:"member-loading-spinner",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))},_renderEditDropdown:function(){return m.input({className:"oob-invite-access o-flag__fix","disable-errors":!0,value:this.state.editable?"edit":"view",onChange:function(e){return function(t,n){return e._permissionChanged(n)}}(this)},m.option({value:"view"},A("can view")),m.option({value:"edit",disabled:!this.props.canEdit},A("can edit")))},_renderWhoCanAccessViewLabel:function(e){return e===E.PUBLIC?A(this.props.isDir?"Anyone with the link can view the folder.":"Anyone with the link can view the file."):e===E.TEAM_ONLY?this.props.isDir?(A("%(team_name)s members with the link can view the folder.").format,{team_name:v.get_viewer().team_name}):(A("%(team_name)s members with the link can view the file.").format,{team_name:v.get_viewer().team_name}):e===E.PASSWORD?A(this.props.isDir?"Anyone with the password and the link can view the folder.":"Anyone with the password and the link can view the file."):void 0},_renderWhoCanAccessEditLabel:function(e){return e===E.PUBLIC?A("Anyone with the link can join the folder and edit files."):e===E.TEAM_ONLY?A("%(team_name)s members with the link can join the folder and edit files.").format({team_name:v.get_viewer().team_name}):e===E.PASSWORD?A("Anyone with the password and the link can join the folder and edit files."):void 0},_onRemoveLinkButtonClicked:function(){var e,t,n;return o.SimpleSharingLogger.log(this.props.user.id,33),n=l.em_snippet(u.filename(this.props.fqPath),16),e=function(e){return function(){var t;return t=b({path:"/sm/disable/"+e.state.tkey}),i.WebRequest({url:t,subject_user:e.props.user.id,success:function(){var t;return y.success(A("Removed link for ‘%(filename)s‘").format({filename:n})),o.SimpleSharingLogger.log(e.props.user.id,25),"function"==typeof(t=e.props).onGoBackButtonClicked?t.onGoBackButtonClicked(e.props.fqPath):void 0},error:function(){return y.Error(A("Failed removing link"))}})}}(this),t=function(e){return function(){return e._restoreSharedLinkModal(e.props.isSharedFolder,e.state.editable)}}(this),T.show({title_text:A("Remove link to ‘%(filename)s‘").format({filename:n}),body_html:A("Are you sure you want to remove this link? People with this link will no longer be able to join the shared folder."),cancel_text:A("Cancel"),confirm_text:A("Remove link"),confirm_callback:e,cancel_completed_callback:t})},_selectAllText:function(t){var n;return e(t.currentTarget)[0].select(),n=this.props.editableLinksM2Enabled?"m2":"m1",o.SimpleSharingLogger.log(this.props.user.id,18,this.state.editable,n)},_changeSfAccess:function(e,t,n){return i.WebRequest({url:"/sm/change_sf_access",data:{link_url:this.state.link,editable:e,can_sync:this.props.canReaderSync},subject_user:this.props.user.id,type:"POST",success:t,error:n})},_updateSfAccess:function(e){return this._changeSfAccess(e,function(t){return function(){var n;return n=A(e?"Anyone with the link can edit":"Anyone with the link can view"),y.success(n),t.setState({editable:e})}}(this))},_onClickChangeSettings:function(){return this.refs.modal.close(),this.props.showSharedLinkSettingsModal(this.props.user.id,this.state.tkey,this._restoreSharedLinkModal.bind(this,this.props.isSharedFolder,this.state.editable,!0))},_restoreSharedLinkModal:function(e,t,n){var i,o,s,r;return s=e?!0:!1,i=!s,o=e&&t?!0:!1,r=S({needsFetchingTokenInfo:!!n,user:this.props.user,fqPath:this.props.fqPath,isDir:this.props.isDir,canReaderSync:!1,isSharedFolder:s,couldBeSharedFolder:i,canEdit:e||this.props.canEdit,initialLink:this.state.link,initialTkey:this.state.tkey,initialEditable:o,initialVisibility:this.state.visibility,initialExpiryPosix:this.state.expiryPosix,initialExpiryDays:this.state.expiryDays,initialExpiryText:this.state.expiryText,editableLinksM2Enabled:this.props.editableLinksM2Enabled,showSharedLinkSettingsModal:this.props.showSharedLinkSettingsModal,onGoBackButtonClicked:this.props.onGoBackButtonClicked}),C.close(),S.showInstance(r)},_permissionChanged:function(e){var t,n,i;if(t="edit"===e,this.state.editable||t!==!0){if(this.state.editable&&t===!1)return this._updateSfAccess(t)}else{if(this.props.couldBeSharedFolder)return i=function(e){return function(n){var i,o,s,r,a,l,u;return r=d.parse_response(String(n)),l=r[0],s=r[1],l?(u=function(){var t;return document.fire(c.SF_NEW),e._restoreSharedLinkModal(!0,!0),t=JSON.parse(s),y.success(t.success_msg)},o=function(){return e._restoreSharedLinkModal(!0,!1)},e._changeSfAccess(t,u,o)):(e._restoreSharedLinkModal(!1,!1),a=d.parse_error(s),l=a[0],i=a[1],l?y.error(i):y.error())}}(this),n={path:this.props.fqPath,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:!0,folder_settings:1,shared_link_policy:void 0,audience:void 0,inviter:void 0},h.showInstance(h({user:this.props.user,req_url:"/share_ajax/existing_no_recipient",req_data:n,success_callback:i}));if(this.props.isSharedFolder)return this._updateSfAccess(t);if(!this.props.isDir)return this._updateSfAccess(t)}}})})}.call(this),function(){define("modules/clean/sharing/strings",["modules/clean/sharing/constants","modules/clean/sharing/i18n"],function(e,t){var n,i,o,s;return n=e.ACCESS_LEVEL,o=t._,s={},s[""+n.OWNER]=o("Owner"),s[""+n.WRITER]=o("Editor"),s[""+n.READER]=o("Viewer"),i=s,{ACCESS_NAME:i}})}.call(this),function(){define("modules/clean/sharing/ui_util",["modules/clean/react/browse/constants","modules/clean/sharing/constants"],function(e,t){var n,i,o,s,r,a,l,c;return i=e.FileTypes,n=t.ACCESS_LEVEL,o=t.GANDALF,r={filesUI:function(){return o.TIBURON_FILE_UI},foldersUI:function(){return o.TIBURON_FOLDER_UI}},s={SHARED_FILE:"shared-file",SHARED_FOLDER:"shared-folder",SHARED_LINK:"shared-link",TEAM_FOLDER:"team-folder",PUBLIC:"public",NO_SHARE:"no-share"},a=function(e,t){var n,o,r,a,l;return n=null!=(a=t.allowLegacyPublicLinks)?a:!1,o=null!=(l=t.hasLegacyPublicAppToken)?l:!1,r=e.fq_path.toLowerCase(),o||n&&r.startsWith("/public/")?s.PUBLIC:e.is_deleted?s.NO_SHARE:e.is_team_shared_folder()?s.TEAM_FOLDER:e.is_shared_folder()||e.could_be_shared_folder()?s.SHARED_FOLDER:e.dir&&e.type!==i.PACKAGE?e.could_be_shared_link()?s.SHARED_LINK:s.NO_SHARE:s.SHARED_FILE},c=function(e,t){return t>e?-1:e===t?0:1},l=function(e){return function(t,i){return t.memberId===e?-1:i.memberId===e?1:t.access===n.OWNER?i.access===n.OWNER?c(t.displayName,i.displayName):-1:i.access===n.OWNER?1:c(t.displayName,i.displayName)}},{makeMemberSortCmp:l,chooseShareUIType:a,Tiburon:r,SHARE_UI_TYPE:s}})}.call(this),function(){define("modules/clean/sharing/views/member_list",["external/react","external/underscore","modules/clean/sharing/views/member_list_item","modules/clean/sharing/ui_util"],function(e,t,n,i){var o,s,r,a,l;return s=n.SharingMemberListItem,l=i.makeMemberSortCmp,r=e.createElement,a=e.DOM,o=e.createClass({displayName:"SharingMemberList",propTypes:{members:e.PropTypes.array.isRequired,onAccessChange:e.PropTypes.func,viewerAccountId:e.PropTypes.string.isRequired},render:function(){var e;return a.ul({className:"sharing-member-list"},function(){var n,i,o,a;for(o=this._sortedMembers(),a=[],n=0,i=o.length;i>n;n++)e=o[n],a.push(r(s,t.extend({key:e.memberId,onAccessChange:this.props.onAccessChange},e)));return a}.call(this))},_sortedMembers:function(){var e;return e=this.props.members.slice(),e.sort(l(this.props.viewerAccountId)),e}})})}.call(this),function(){define("modules/clean/sharing/views/member_list_item",["external/react","external/underscore","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/size","modules/clean/em_string","modules/clean/react/sprite","modules/clean/sharing/constants","modules/clean/sharing/i18n","modules/clean/sharing/strings"],function(e,t,n,i,o,s,r,a,l,c){var u,d,p,h,_,m,f,v,g,y,b,w;return h=o.AVATAR_DIMENSION_BY_SIZE,g=o.VALID_AVATAR_DIMENSIONS,u=a.ACCESS_LEVEL,p=a.ACCESS_VALUES,_=a.SNIPPET_SIZES,y=l._,d=c.ACCESS_NAME,b=e.createElement,w=e.DOM,f=e.createClass({displayName:"SharingMemberInfo",propTypes:{avatarInitials:e.PropTypes.string.isRequired,avatarPhotoUrl:e.PropTypes.string,avatarShape:e.PropTypes.oneOf(["SQUARE","CIRCLE"]),avatarSize:e.PropTypes.oneOf(t.values(h)),displayName:e.PropTypes.string.isRequired,email:e.PropTypes.string},getDefaultProps:function(){return{avatarShape:"CIRCLE",avatarSize:h.MEDIUM}},render:function(){return w.div({className:"sharing-member-info o-flag"},w.div({className:"sharing-member-info__avatar o-flag__fix"},b(n,{dimension:this.props.avatarSize,photoUrl:this.props.avatarPhotoUrl,defaultAvatar:b(i,{dimension:this.props.avatarSize,shape:this.props.avatarShape,initials:this.props.avatarInitials,name:this.props.displayName})})),w.div({className:"sharing-member-info__details o-flag__flex"},w.div({className:"sharing-member-info__details__name"},s.em_snippet(this.props.displayName,_.DISPLAY_NAME)),w.div({className:"sharing-member-info__details__email"},null!=this.props.email?s.em_snippet(this.props.email,_.EMAIL):void 0)))}}),m=e.createClass({displayName:"SharingMemberAccess",propTypes:{access:e.PropTypes.oneOf(p).isRequired,allowedAccess:e.PropTypes.arrayOf(e.PropTypes.oneOf(p)),canChangeAccess:e.PropTypes.bool,canMakeOwner:e.PropTypes.bool,canRemove:e.PropTypes.bool,memberId:e.PropTypes.string,onAccessChange:e.PropTypes.func},getDefaultProps:function(){return{allowedAccess:p,canChangeAccess:!0,canMakeOwner:!0,canRemove:!0,onAccessChange:null}},render:function(){return w.div({className:"sharing-member-access"},w.button({className:"sharing-member-access__current-access o-borderless-button"},d[this.props.access],this.props.canChangeAccess?b(r,{alt:"",group:"web",name:"arrow-down-gray"}):void 0))}}),v=e.createClass({displayname:"SharingMemberListItem",propTypes:function(){return t.extend({},f.propTypes,m.propTypes)}(),render:function(){return w.li({className:"sharing-member-list__item o-flag"},w.div({className:"sharing-member-list__item__member-info o-flag__flex"},b(f,t.pick(this.props,Object.keys(f.propTypes)))),w.div({className:"sharing-member-list__item__access-box o-flag__fix"},b(m,t.pick(this.props,Object.keys(m.propTypes)))))}}),{SharingMemberInfo:f,SharingMemberAccess:m,SharingMemberListItem:v}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/sharing/views/modal_content",["external/react","external/underscore","modules/clean/contacts/tokenizer","modules/clean/em_string","modules/clean/js_environment","modules/clean/react/button","modules/clean/react/css","modules/clean/react/sprite","modules/clean/sharing/constants","modules/clean/sharing/content_info","modules/clean/sharing/i18n","modules/clean/sharing/views/member_list","modules/clean/user"],function(t,n,i,o,s,r,a,l,c,u,d,p,h){var _,m,f,v,g,y,b,w,C,E,S,T,A;return v=i.ContactsTokenizer,f=r.button,_=c.ACCESS_LEVEL,m=c.ACCESS_VALUES,w=c.SNIPPET_SIZES,g=u.ContentInfo,E=d._,T=t.createElement,A=t.DOM,y={LOADING:"loading",MEMBERSHIP:"membership",SHARE:"share",SHARE_TOKENIZING:"share-tokenizing",SHARE_SENDING:"share-sending"},b=n.values(y),S=t.createClass({displayName:"ShareModalContent",statics:{MODES:y},propTypes:{allowedAccess:t.PropTypes.arrayOf(t.PropTypes.oneOf(m)),contentInfo:t.PropTypes.instanceOf(g).isRequired,customMessage:t.PropTypes.string,headerId:t.PropTypes.string,isWorkUser:t.PropTypes.bool,members:t.PropTypes.array,mode:t.PropTypes.oneOf(b),onCloseClick:t.PropTypes.func,onContactsChange:t.PropTypes.func,onMemberAccessChange:t.PropTypes.func,onMessageChange:t.PropTypes.func,onRecipientAccessChange:t.PropTypes.func,onSend:t.PropTypes.func,recipientAccess:t.PropTypes.oneOf(m).isRequired,recipientRawInput:t.PropTypes.string,recipientTokens:t.PropTypes.array,user:t.PropTypes.instanceOf(h).isRequired},getDefaultProps:function(){return{allowedAccess:[_.READER,_.WRITER],customMessage:null,headerId:"unified-share-modal-title",isWorkUser:!1,members:[],mode:y.MEMBERSHIP,onCloseClick:null,onContactsChange:null,onMemberAccessChange:null,onMessageChange:null,onRecipientAccessChange:null,onSend:null,recipientRawInput:"",recipientTokens:[]}},render:function(){return A.div({className:"unified-share-modal unified-share-modal--"+this.props.mode},this._renderHeaderSection(),this._renderToSection(),this._renderMainSection(),this._renderFooterSection())},_renderHeaderSection:function(){var e;return e=null!=this.props.contentInfo.icon?this.props.contentInfo.icon:this.props.contentInfo.shareAsSharedFolder?"folder_user_32":"page_white_32",A.div({className:"unified-share-modal__section"},A.div({className:"unified-share-modal__title",id:this.props.headerId},T(l,{alt:"",className:"unified-share-modal__title__icon",group:"web",name:e}),A.h3({className:"unified-share-modal__title__name"},o.em_snippet(this.props.contentInfo.name,w.FILENAME))),A.button({className:"unified-share-modal__close c-borderless-button",onClick:this.props.onCloseClick},T(l,{group:"web",name:"xclose",alt:E("Close Modal")})))},_renderToSection:function(){var t,n;return A.div({className:"unified-share-modal__section"},A.div({className:"o-flag"},A.div({className:"unified-share-modal__to-label o-flag__fix"},"To:"),A.div({className:"unified-share-modal__to-input-box o-flag__flex"},A.div({className:"o-flag--rev"},A.div({className:"o-flag__flex"},T(v,{focusOnMount:!0,onContentsChange:this.props.onContactsChange,populatedInputData:{tokens:this.props.recipientTokens,value:this.props.recipientRawInput},placeholder:E(this.props.isWorkUser?"Email, name, or group":"Email or name"),user:this.props.user})),A.div({className:"o-flag__fix"},A.div({className:"unified-share-modal__to-access"},this.props.contentInfo.shareAsSharedFolder?A.select({name:"access",ref:"accessLevel",onChange:this._handleRecipientAccessChange,value:this.props.recipientAccess},A.option({value:_.READER,disabled:(t=!_.READER,e.call(this.props.allowedAccess,t)>=0)},E("Can view")),A.option({value:_.WRITER,disabled:(n=!_.WRITER,e.call(this.props.allowedAccess,n)>=0)},E("Can edit"))):E("Can view")))))))},_renderFooterSection:function(){var e;return this.props.contentInfo.shareAsSharedFolder||(e=this.props.mode)===y.SHARE||e===y.SHARE_TOKENIZING||e===y.SHARE_SENDING?A.div({className:"unified-share-modal__footer o-flag--rev"},A.div({className:"unified-share-modal__footer__left o-flag__flex"},this.props.contentInfo.shareAsSharedFolder?A.button({className:"unified-share-modal__folder-settings c-borderless-button"},T(l,{alt:"",group:"web",name:"s_gear"}),E("Folder settings")):void 0),A.div({className:"unified-share-modal__footer__right o-flag__fix"},function(){switch(this.props.mode){case y.SHARE:case y.SHARE_TOKENIZING:case y.SHARE_SENDING:return T(f,{className:"unified-share-modal__share-send",disabled:this.props.mode===y.SHARE_SENDING||0===this.props.recipientTokens.length&&0===this.props.recipientRawInput.length,onClick:this._handleSendClick},E("Send invites"));default:return null}}.call(this))):null},_renderMainSection:function(){switch(this.props.mode){case y.LOADING:return this._renderMainLoading();case y.MEMBERSHIP:return this._renderMainMembership();case y.SHARE:return this._renderMainShare();case y.SHARE_TOKENZING:return this._renderMainShareTokenizing();case y.SHARE_SENDING:return this._renderMainShareSending();default:return null}},_renderMainLoading:function(){return A.div({className:"unified-share-modal__main unified-share-modal__main--text unified-share-modal__section"},E("Loading..."))},_renderMainMembership:function(){return this.props.members.length>0?A.div({className:"unified-share-modal__main unified-share-modal__section o-scrollable"},T(p,{viewerAccountId:this.props.user.account_id,members:this.props.members,onMemberAccessChange:this.props.onMemberAccessChange})):A.div({className:"unified-share-modal__main unified-share-modal__main--text unified-share-modal__section"},E("No current members"))},_renderMainShare:function(){return A.textarea({className:"unified-share-modal__main unified-share-modal__section",placeholder:E("Add a message (optional)"),onChange:this._handleMessageChange,ref:"customMessage",value:this.props.customMessage})},_renderMainShareTokenizing:function(){return A.div({className:"unified-share-modal__main unified-share-modal__section o-scrollable"},null)},_renderMainShareSending:function(){return A.div({className:"unified-share-modal__main unified-share-modal__main--text unified-share-modal__section"},E("Sending..."))},_handleMessageChange:function(e){var t;return"function"==typeof(t=this.props).onMessageChange?t.onMessageChange(e.target.value):void 0},_handleRecipientAccessChange:function(e){var t;return"function"==typeof(t=this.props).onRecipientAccessChange?t.onRecipientAccessChange(e.target.value):void 0},_handleSendClick:function(e){var t,n,i;return e.preventDefault(),e.stopPropagation(),"function"==typeof(t=this.props).onSend?t.onSend(null!=(n=this.refs.accessLevel)?n.value:void 0,null!=(i=this.refs.customMessage)?i.value:void 0):void 0}}),C=a(S,["/static/css/sharing/share_modal-vfl5t-n2X.css","/static/css/react/contacts_tokenizer-vfl4iOdNb.css"]),{ShareModalContent:C,MODES:y}})}.call(this),function(){define("modules/clean/sticker_util",["modules/constants/stickers"],function(e){var t;return new(t=function(){function t(){}return t.prototype.getStickerImageUrl=function(t){return e.sticker_img_url+"/"+t},t.prototype.getStickerSetImageUrl=function(t){return e.sticker_set_img_url+"/"+t},t.prototype.getStickers=function(){var t,n,i,o,s,r,a,l,c,u,d;if(!this.stickers){for(this.stickers=e.sets,a=this.stickers,t=0,o=a.length;o>t;t++)u=a[t],u.stickers=[];for(l=e.stickers,n=0,s=l.length;s>n;n++)for(d=l[n],c=this.stickers,i=0,r=c.length;r>i;i++)if(u=c[i],d.set_id===u.id){u.stickers.push(d);break}}return this.stickers},t}())})}.call(this),function(){define("modules/clean/teams/team_assume_user_personal_locked_modal",["external/react","modules/core/i18n","modules/clean/react/modal"],function(e,t,n){var i,o,s,r,a,l,c;return r=t._,l=t.render_sentences,c=t.ungettext,o=n.Modal,s=n.SimpleModal,a=e.DOM,i=e.createClass({displayName:"AssumePersonalLockedModal",statics:{show:function(e){return o.showInstance(i(e))}},propTypes:{displayName:e.PropTypes.string,teamName:e.PropTypes.string},_close:function(e){return e.preventDefault(),o.close()},_getModalProps:function(){return{title:r("Personal account not accessible"),acceptButtonText:r("Close"),dismissButtonText:null,onAccept:this._close}},render:function(){return o(this._getModalProps(),a.div({className:"team-assume-user-modal"},r("%(display_name)s’s personal account isn’t managed by the %(team_name)s team, so its contents aren’t accessible to admins.").format({display_name:this.props.displayName,team_name:this.props.teamName})))}}),{AssumePersonalLockedModal:i}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;define("modules/clean/teams/team_folder_modal",["modules/core/browser","modules/clean/components/ajax_form","modules/clean/dbmodal"],function(n,i,o){var s,r;return s=o.DBModal,r=function(o){function s(){return this.on_confirm_button_click=e(this.on_confirm_button_click,this),this._$form=e(this._$form,this),s.__super__.constructor.apply(this,arguments)}return t(s,o),s.prototype._$form=function(){return this.$modal_window.find(".new_team_folder_form")},s.prototype.on_confirm_button_click=function(e){return e.preventDefault(),this._$form().submit()},s.prototype.on_show=function(){var e;return e=this._$form(),new i(e),e.on(i.SUCCESS_EVENT,function(e){return function(t,i){return e.options.open_created_folder?n.redirect(i.sf_info.href):n.reload()}}(this)),this.options.back_fn?this.$modal_window.find("a.back").on("click",function(e){return function(t){return e.options.back_fn(t,e)}}(this)):void 0},s}(s)})}.call(this),function(){define("modules/clean/teams/trial_buy_now",["jquery","modules/clean/ajax","modules/clean/react/modal","modules/core/browser","modules/core/i18n"],function(e,t,n,i,o){var s,r,a;return r=o._,a=o.ungettext,s={showModal:function(e){var t,i;return i=r("Buy Dropbox for Business now"),t=a("You have <strong>%(days)s</strong> day remaining in your Dropbox for Business trial. Buy now to ensure that your team continues to work efficiently!","You have <strong>%(days)s</strong> days remaining in your Dropbox for Business trial. Buy now to ensure that your team continues to work efficiently!",e).format({days:e}),n.SimpleModal.show({title_text:i,body_html:t,confirm_text:r("Buy now"),confirm_callback:s._confirm,cancel_callback:s._cancel})},_confirm:function(){return e.ajax({type:"POST",url:"/team/setup/trial_buy_now/dismiss",success:function(){return function(){return i.redirect("/team/renew")}}(this)})},_cancel:function(){return e.post("/team/setup/trial_buy_now/dismiss")}}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/tokenizer",["external/react","jquery","external/underscore","modules/clean/keycode","modules/clean/typeahead"],function(t,n,i,o,s){var r,a,l,c,u;return l=s.TypeaheadSelector,u=t.DOM,c=t.addons.classSet,r=t.createClass({propTypes:{className:t.PropTypes.string,data:t.PropTypes.any,onRemove:t.PropTypes.func},render:function(){var e;return e={"tokenizer-token":!0},e[this.props.className]=!0,u.a(n.extend({tabIndex:-1},this.props,{className:c(e)}),String(this.props.data),this._makeCloseButton())},_makeCloseButton:function(){return this.props.onRemove?u.span({className:"tokenizer-token-close",onClick:function(e){return function(){return e.props.onRemove(),!1}}(this),dangerouslySetInnerHTML:{__html:"&nbsp;"}}):""}}),a=t.createClass({displayName:"Tokenizer",propTypes:{customClass:t.PropTypes.string,dataSource:t.PropTypes.object.isRequired,initialInputText:t.PropTypes.string,logTokenChangeEvent:t.PropTypes.func,onContentsChange:t.PropTypes.func,onTokenAdd:t.PropTypes.func,onTokenRemove:t.PropTypes.func,placeholderText:t.PropTypes.string,populatedTokenData:t.PropTypes.array,renderToken:t.PropTypes.func.isRequired,renderTokenHover:t.PropTypes.func,renderInput:t.PropTypes.func.isRequired,renderSelector:t.PropTypes.func.isRequired,stringTokenizer:t.PropTypes.func.isRequired,tokenSpacing:t.PropTypes.number,focusOnMount:t.PropTypes.bool,tabIndex:t.PropTypes.number},getDefaultProps:function(){return{initialInputText:"",renderInput:function(){return u.input()},renderSelector:function(){return l()},renderToken:function(e){return r({data:e})},stringTokenizer:function(e,t){var n,i;return n=e.split(","),i=t?"":n.pop(),{tokens:n,value:i}},tokenSpacing:3,focusOnMount:!1}},getInitialState:function(){return this.tokenData=this.props.populatedTokenData||[],{queryResults:null,tokenData:this.tokenData,selectedTokenIndex:null,inputWidth:150,numLines:1}},componentDidMount:function(){return setTimeout(this._resizeTokenizerInput,0),this.refs.input.getDOMNode().value=this.props.initialInputText,n(this.refs.tokenizer_input.getDOMNode()).on("keydown",this._proxyKeys),document.addEventListener("click",this._handleDocumentClick,!1),this.props.focusOnMount?this.refs.input.getDOMNode().focus():void 0},componentWillUnmount:function(){return n(this.refs.tokenizer_input.getDOMNode()).off("keydown",this._proxyKeys),document.removeEventListener("click",this._handleDocumentClick,!1)},componentDidUpdate:function(){return this._resizeTokenizerInput()},render:function(){var e,n;return e={"react-tokenizer":!0},null!=this.props.customClass&&(e[this.props.customClass]=null!=this.props.customClass),n={padding:this.props.tokenSpacing,paddingRight:0,maxHeight:this.props.tokenSpacing+3*(this.props.tokenSpacing+29)+14+2},this.state.numLines>3&&(n.overflowY="auto",n.overflowX="visible"),u.div({onClick:this._handleMyClick,className:t.addons.classSet(e)},u.div({className:"tokenizer-input",ref:"tokenizer_input",style:n},u.div({className:"token-container",style:{marginLeft:-this.props.tokenSpacing,marginBottom:-this.props.tokenSpacing}},this._renderTokens(),this._renderInput())),this._renderSelector())},serializeInputData:function(){return{tokens:this.tokenData,value:this.refs.input.getDOMNode().value}},tokenizeAll:function(){var e,t;return e=this.refs.input.getDOMNode(),t=this.props.stringTokenizer(e.value,!0).tokens,t.length>0&&this._addTokens(t,!1),e.value="",this.refs.selector.close()},addExternalTokens:function(e){this._addTokens(e,!1,null),this.refs.selector.close()},_addTokens:function(t,n,o){var s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b;for(null==n&&(n=!1),null==o&&(o=null),c=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},b=i.map(this.tokenData,c),_=t.filter(function(t){var n;return n=c(t),e.call(b,n)<0}),this.tokenData=this.tokenData.concat(_),this.setState({tokenData:this.tokenData}),u=0,p=_.length;p>u;u++)l=_[u],"function"==typeof(s=this.props).onTokenAdd&&s.onTokenAdd(l);for("function"==typeof(r=this.props).onContentsChange&&r.onContentsChange(this.tokenData,null!=(m=this.refs.input)?m.getDOMNode().value:void 0),l=n?{search_expr:o,selected_pos:(null!=(f=this.refs.selector)?f.state.selectionIndex:void 0)||0,num_query_results:null!=(v=this.state.queryResults)?v.length:void 0,did_select_suggestion:!0}:{did_select_suggestion:!1},g=[],d=0,h=_.length;h>d;d++)y=_[d],g.push("function"==typeof(a=this.props).logTokenChangeEvent?a.logTokenChangeEvent(y,!1,l):void 0);return g},_addToken:function(e,t,n){return null==t&&(t=!1),null==n&&(n=null),this._addTokens([e],t,n)},removeTokens:function(e){var t,n,i,o,s,r,a,l,c,u,d,p,h,_;for(_=this.state.selectedTokenIndex,h=[],r=0,c=e.length;c>r;r++)o=e[r],p=this.tokenData.indexOf(o),-1!==p&&(_===p?_=null:_>p&&(_-=1),this.tokenData.splice(p,1),h.push(o));for(s=this.refs.input.getDOMNode(),s.focus(),this._setSelectedToken(_),this.setState({tokenData:this.tokenData,queryResults:null}),a=0,u=h.length;u>a;a++)o=h[a],"function"==typeof(t=this.props).onTokenRemove&&t.onTokenRemove(o);for(l=0,d=h.length;d>l;l++)o=h[l],"function"==typeof(n=this.props).logTokenChangeEvent&&n.logTokenChangeEvent(o,!0);return"function"==typeof(i=this.props).onContentsChange?i.onContentsChange(this.tokenData,s.value):void 0},removeToken:function(e){return this.removeTokens([e])},replaceTokens:function(e){var t,n;return this.tokenData=e,this.setState({tokenData:e}),"function"==typeof(t=this.props).onContentsChange?t.onContentsChange(this.tokenData,null!=(n=this.refs.input)?n.getDOMNode().value:void 0):void 0},_renderTokens:function(){var e,n,i,o,s,r,a,l,c,u,d,p;for(u=[],a=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},c=this.state.tokenData,s=r=0,l=c.length;l>r;s=++r)i=c[s],p=this.props.renderToken(i),d=this.state.selectedTokenIndex===s,o="function"==typeof(e=this.props).renderTokenHover?e.renderTokenHover(i):void 0,n=t.addons.classSet({selected:d,"title-bubble-component":null!=o,south:null!=o}),u.push(t.addons.cloneWithProps(p,{ref:"token"+s,key:"token"+a(i),style:{margin:"0 0 "+this.props.tokenSpacing+"px "+this.props.tokenSpacing+"px"},className:n,"data-title":o,onClick:this._setSelectedToken.bind(this,s),onRemove:this.removeToken.bind(this,i),tokenSpacing:this.props.tokenSpacing}));return u},_renderSelector:function(){return t.addons.cloneWithProps(this.props.renderSelector(),{ref:"selector",queryOptions:this.state.queryResults,onSelect:this._onSelect,onClose:this._clearResults})},_renderInput:function(){var e;return e=this.state.tokenData.length?"":this.props.placeholderText,t.addons.cloneWithProps(this.props.renderInput(),{ref:"input",style:{width:this.state.inputWidth,marginLeft:this.props.tokenSpacing,marginBottom:this.props.tokenSpacing},onChange:this._textUpdated,placeholder:e,tabIndex:this.props.tabIndex,onClick:this._setSelectedToken.bind(this,null)})},_getTokenizerInput:function(){return this.refs.tokenizer_input},_getTokenComponents:function(){var e;return function(){var t,n,i;for(i=[],e=t=0,n=this.state.tokenData.length;n>=0?n>t:t>n;e=n>=0?++t:--t)i.push(this.refs["token"+e]);return i}.call(this).filter(function(e){return e})},_setSelectedToken:function(e){return null!=e?(this.refs["token"+e].getDOMNode().focus(),this.refs.selector.close()):this.refs.input.getDOMNode().focus(),this.setState({selectedTokenIndex:e})},_resizeTokenizerInput:function(){var e,t,n,i,o,s,r,a,l,c,u,d,p;for(i=function(e){return e.getDOMNode().clientWidth},t=80,d=i(this._getTokenizerInput()),n=this.props.tokenSpacing+2,e=this.props.tokenSpacing,a=0,p=this._getTokenComponents(),l=1,s=0,r=p.length;r>s;s++)c=p[s],u=i(c)+n,a+u+e>d&&(l+=1,a=0),a+=u;return o=d-a-e-2,t>o&&(l+=1,o=d-e),o!==this.state.inputWidth?this.setState({inputWidth:o,numLines:l}):void 0},_onSelect:function(e){var t;return t=this.refs.input.getDOMNode(),t.focus(),this._addToken(e,!0,t.value),t.value="",this.setState({queryResults:null})},_handleMyClick:function(e){var t;return"function"==typeof(t=e.nativeEvent).stopImmediatePropagation?t.stopImmediatePropagation():void 0},_handleDocumentClick:function(){return this.refs.selector.close()},_proxyKeys:function(e){return!this._shouldListenForTokenNavigation()||this._onTokenNavigate(e)?this.refs.selector.onKeyDown(e):void 0},_shouldListenForTokenNavigation:function(){var e;return this.state.tokenData.length?(e=this.refs.input.getDOMNode(),0===e.selectionStart&&0===e.selectionEnd):!1},_textUpdated:function(){var t,n,o,s,r,a;return n=this.refs.input.getDOMNode(),o=n.value,s=this.props.stringTokenizer(o),r=s.tokens,a=s.value,a!==o&&(n.value=a,a||this.refs.selector.close()),r.length>0?this._addTokens(r,!1):"function"==typeof(t=this.props).onContentsChange&&t.onContentsChange(this.tokenData,a),this.props.dataSource.query(a,function(t){return function(n){var o,s;return a||(n=null),o=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},s=i.map(t.tokenData,o),n=null!=n?n.filter(function(t){var n;return n=o(t),e.call(s,n)<0}):null,t.setState({queryResults:n})}}(this))},_clearResults:function(){return this.setState({queryResults:null})},_onTokenNavigate:function(e){var t;if(0===this.state.tokenData.length)return!0;switch(t=this.state.selectedTokenIndex,e.keyCode){case o.BACKSPACE:return null===t?this._setSelectedToken(this.state.tokenData.length-1):this.removeToken(this.state.tokenData[t]),!1;case o.LEFT:return null===t?this._setSelectedToken(this.state.tokenData.length-1):t>0&&this._setSelectedToken(t-1),!1;case o.RIGHT:return null===t?!0:(this._setSelectedToken(t>=this.state.tokenData.length-1?null:t+1),!1);case o.DELETE:if(null!==t)return this.removeToken(this.state.tokenData[t]),!1;break;default:return!0}}}),{Token:r,Tokenizer:a}})}.call(this),function(){define("modules/clean/top_notif",["jquery"],function(e){var t,n,i,o,s,r;return r={HIDE_EVENT:"db:topnotificationbar:hide",hide:function(){return e("#top-notification-bar-container").hide(),
e("body").removeClass("top-notification-bar"),e(document).trigger(this.HIDE_EVENT)}},n={init:function(){return e(".eu-bar-dismiss").on("click",function(t){return t.preventDefault(),r.hide(),e.ajax({url:"/dismiss_eu_cookie_notification",type:"POST"})})}},i={init:function(){return e(".expired-ios-bar-dismiss").on("click",function(t){return t.preventDefault(),r.hide(),e.ajax({url:"/dismiss_expired_ios_notification",type:"POST"})})}},t={init:function(){return e("#early-admin-access-fts-and-link-controls-banner-dismiss").on("click",function(t){return t.preventDefault(),r.hide(),e.ajax({url:"/team/dismiss_sharing_controls_banner",type:"POST"})})}},o={init:function(){return e("#locale-switch-banner-dismiss").on("click",function(t){return t.preventDefault(),r.hide(),e.ajax({url:"/dismiss_locale_switch_banner",type:"POST"})})}},s={init:function(){return e("#super-inactive-recover-bar-dismiss").on("click",function(t){return t.preventDefault(),r.hide(),e.ajax({url:"/dismiss_super_inactive_recover_bar",type:"POST"})})}},{TopNotificationBar:r,EUCookieNotificationBar:n,ExpiredIOSNotificationBar:i,DfBAdminEarlyAccessSharingControlsBar:t,LocaleSwitchBar:o,SuperInactiveRecoverBar:s}})}.call(this),function(){define("modules/clean/typeahead",["external/react","external/underscore","modules/clean/fuzzy","modules/clean/keycode"],function(e,t,n,i){var o,s,r,a,l;return l=e.DOM,s=function(){function e(e){this.local=(null!=e?e:{}).local}return e.prototype.query=function(e,i){var o;return o=t.map(n.filter(e,this.local),function(e){return e.original}),i(o)},e}(),a={getInitialState:function(){return{selectionIndex:0}},getOptions:function(){var e;return this.props.queryOptions?(e=this.props.maxVisible||this.props.queryOptions.length,this.props.queryOptions.slice(0,e)):[]},renderOptions:function(){var t,n,i,o,s,r,a,l,c;for(c=[],l=this.getOptions(),s=function(e){return("function"==typeof e.getKey?e.getKey():void 0)||String(e)},o=i=0,r=l.length;r>i;o=++i)n=l[o],t={selected:this.state.selectionIndex===o,"typeahead-option":!0},a=this.renderOption(n),c.push(e.addons.cloneWithProps(a,{className:e.addons.classSet(t),key:"option"+s(n),onMouseEnter:this._hover.bind(this,o),onClick:this.onSelect.bind(this,n)}));return c},onSelect:function(e){return this.props.onSelect(e),this.reset()},renderOption:function(e){return this.props.renderQueryOption(e)},onKeyDown:function(e){switch(e.keyCode){case i.UP:return this._navigate(-1),e.preventDefault();case i.DOWN:return this._navigate(1),e.preventDefault();case i.ENTER:return this._selectSelectionIndex(e);case i.ESC:return this.close(),e.preventDefault();case i.TAB:return this._selectSelectionIndex(e);default:return this.reset()}},_selectSelectionIndex:function(e){var t,n;return n=this.getOptions(),n.length&&(t=this.state.selectionIndex,-1!==t)?(this.onSelect(n[t]),e.preventDefault()):void 0},reset:function(){return this._changeSelectionIndex(0)},close:function(){var e;return"function"==typeof(e=this.props).onClose&&e.onClose(),this.reset()},_hover:function(e){return this._changeSelectionIndex(e)},_navigate:function(e){var t,n,i;return(n=this.getOptions().length)?(t=this.state.selectionIndex+e,i=n+1,-1>t?t+=i:t>=n&&(t-=i),this._changeSelectionIndex(t)):void 0},_changeSelectionIndex:function(e){return e!==this.state.selectionIndex&&"function"==typeof this.onSelectionIndexChange&&this.onSelectionIndexChange(e),this.setState({selectionIndex:e})}},o=e.createClass({displayName:"Autocomplete",propTypes:{customClass:e.PropTypes.string,dataSource:e.PropTypes.object.isRequired,renderCompletionText:e.PropTypes.func.isRequired,renderInput:e.PropTypes.func.isRequired,renderSelector:e.PropTypes.func.isRequired},getDefaultProps:function(){return{renderCompletionText:function(e){return String(e)},renderInput:function(){return l.input()},renderSelector:function(){return r()}}},getInitialState:function(){return{queryResults:null}},render:function(){var t;return t={},t[this.props.customClass]=null!=this.props.customClass,l.div({className:e.addons.classSet(t)},this._renderInput(),this._renderSelector())},_renderInput:function(){return e.addons.cloneWithProps(this.props.renderInput(),{ref:"input",onChange:this._inputChanged,onKeyDown:this._proxyKeys})},_renderSelector:function(){return e.addons.cloneWithProps(this.props.renderSelector(),{ref:"selector",queryOptions:this.state.queryResults,onSelect:this._autocomplete,onClose:this._clearResults})},_inputChanged:function(){var e;return e=this.refs.input.getDOMNode().value,this.props.dataSource.query(e,function(t){return function(n){return e||(n=[]),t.setState({queryResults:n})}}(this)),this.refs.selector.reset()},_proxyKeys:function(e){return this.refs.selector.onKeyDown(e)},_autocomplete:function(e){var t;return t=this.refs.input.getDOMNode(),t.focus(),t.value=this.props.renderCompletionText(e),this._clearResults()},_clearResults:function(){return this.setState({queryResults:null})}}),r=e.createClass({displayName:"TypeaheadSelector",mixins:[a],propTypes:{customClass:e.PropTypes.string,maxVisible:e.PropTypes.number,onClose:e.PropTypes.func.isRequired,onSelect:e.PropTypes.func.isRequired,queryOptions:e.PropTypes.array,renderQueryOption:e.PropTypes.func.isRequired},getDefaultProps:function(){return{maxVisible:7,onClose:function(){},onSelect:function(){},renderQueryOption:function(e){return l.li({},String(e))}}},render:function(){var t;return this.getOptions().length?(t={"typeahead-selector":!0},t[this.props.customClass]=null!=this.props.customClass,l.ul({className:e.addons.classSet(t)},this.renderOptions())):l.div({})}}),{Autocomplete:o,DataSource:s,TypeaheadSelector:r,TypeaheadSelectorMixin:a}})}.call(this),function(){define("modules/clean/unity/check_file_cache",["modules/clean/unity/features"],function(e){var t;return null!=e?(t=function(){function t(){}return t._cache={},t.is_cached_and_locally_available=function(t,n){var i;return i=this._cache[e.server_path(t,n)],null!=i&&i.is_locally_available},t.get=function(t,n){return this._cache[e.server_path(t,n)]},t.set=function(e,t){return this._cache[e]=t},t.set_batch=function(e){var t,n,i;n=[];for(i in e)t=e[i],n.push(this._cache[i]=t);return n},t.clear=function(){return this._cache={}},t}(),__CONDITIONAL_JS__.UnityCheckFileCache=t,t):void 0})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/unity/connection",["jquery","modules/core/exception","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/connection_error","modules/clean/unity/logger","modules/clean/unity/versions","modules/clean/unity/web_socket","modules/clean/viewer"],function(n,i,o,s,r,a,l,c,u,d){var p;return u.web_sockets_supported()?p=function(){function p(){this._on_response_timeout=e(this._on_response_timeout,this),this._on_message=e(this._on_message,this),this._set_connection_state=e(this._set_connection_state,this),this._on_error=e(this._on_error,this),this._on_close=e(this._on_close,this),r.getGandalfRule("unity-web-debug")&&(window.uc=this),this.client_version=null,this._on_open_callbacks=[],this._on_open_failed_callbacks=[],this._on_close_callbacks=[],this._pending_callbacks=[],this._response_callbacks={},this._ws=null,this._port=null,this._active_ports={},this._connection_state=p._CONNECTION_PENDING,this._current_message_id=1,this._permission_level=null,this.logger=new l,this._routes={check_unity_version:this._check_unity_version.bind(this),fetch_unity_nonce:this._fetch_unity_nonce.bind(this),complete_handshake:this._complete_handshake.bind(this)}}return p._CONNECTION_OPENED_STATE=0,p._VERSION_CHECK_STATE=1,p._FETCHING_NONCE_STATE=2,p._NONCE_RETURNED_TO_CLIENT_STATE=3,p._HANDSHAKE_COMPLETED_STATE=4,p._CONNECTION_PENDING=0,p._CONNECTION_ESTABLISHED=1,p._CONNECTION_CLOSED=2,p._CONNECTION_RETRYING=3,p._RESPONSE_TIMEOUT=5e3,p._MIN_PORT=17600,p._MAX_PORT=17602,p.SECURE_PERMISSION="secure",p.INSECURE_WEB_PERMISSION="insecure_web",p.INSECURE_CLIENT_PERMISSION="insecure_client",p.INSECURE_PERMISSION="insecure",p.prototype.start=function(){return u.load_flash_policy_if_needed()?this._attempt_handshake():void this._set_connection_state(p._CONNECTION_CLOSED)},p.prototype._attempt_handshake=function(){var e,t,n,s,r,a,l,c;try{for(s=n=r=p._MIN_PORT,a=p._MAX_PORT;a>=r?a>=n:n>=a;s=a>=r?++n:--n)this._active_ports[s]=!0,l={scheme:"ws",authority:"127.0.0.1:"+s.toString(),path:"/ws"},c=u.create(o(l).toString()),c.onmessage=this._on_message({ws:c,port:s,state:p._CONNECTION_OPENED_STATE,client_version:null,client_has_auth:null}),c.onclose=this._on_close(s),c.onerror=this._on_error(s)}catch(t){e=t,this.logger.report_event("unity_failure",{message:"WebSocket creation failed. Message: "+e.message,error_name:e.name,port:s,stack:i.stackTrace()}),this._set_connection_state(p._CONNECTION_CLOSED)}return this.logger.report_event("handshake_started")},p.prototype._on_close=function(e){return function(t){return function(n){var i;return 1e3===(i=n.code)||1001===i||1005===i||1006===i||t.logger.report_event("unity_failure",{message:"WebSocket closed. Code: "+n.code+". Reason: "+n.reason,port:e}),t._close_port(e)}}(this)},p.prototype._on_error=function(e){return function(t){return function(n){return t.logger.report_event("unity_failure",{message:"WebSocket error. Message: "+n.data,port:e}),t._close_port(e)}}(this)},p.prototype._close_port=function(e){return e in this._active_ports&&(delete this._active_ports[e],n.isEmptyObject(this._active_ports))?this._connection_state===p._CONNECTION_ESTABLISHED?this._retry_connection():this._set_connection_state(p._CONNECTION_CLOSED):void 0},p.prototype._retry_connection=function(){return this.logger.report_event("connection_retrying"),this._set_connection_state(p._CONNECTION_RETRYING),this.client_version=this._ws=this._port=null,this._attempt_handshake()},p.prototype._set_connection_state=function(e){var t,n,o,s,r,l,c,u,d,h,_,m,f,v,g,y,b,w,C,E;if(e!==this._connection_state){if(h=this._connection_state,i.assert(h!==p._CONNECTION_CLOSED,"Shouldn't unclose a closed connection."),this._connection_state=e,e===p._CONNECTION_ESTABLISHED){if(i.assert(this._is_connection_in_progress(h),"Can only establish from pending or retrying."),this.logger.report_event("handshake_complete"),h===p._CONNECTION_PENDING)for(v=this._on_open_callbacks,s=0,c=v.length;c>s;s++)(m=v[s])();for(C=[];this._pending_callbacks.length;)g=this._pending_callbacks.pop(),n=g[0],o=g[1],C.push(this.is_ready()?n():"function"==typeof o?o(a.UNEXPECTED_ERROR):void 0);return C}if(e!==p._CONNECTION_RETRYING){if(e===p._CONNECTION_CLOSED){if(h===p._CONNECTION_PENDING)for(this.logger.report_event("connection_not_established"),y=this._on_open_failed_callbacks,r=0,u=y.length;u>r;r++)(f=y[r])();else if(h===p._CONNECTION_RETRYING)for(this.logger.report_event("connection_terminated"),b=this._on_close_callbacks,l=0,d=b.length;d>l;l++)(_=b[l])();else i.assert(!1,"CONNECTION_CLOSED can only be set from PENDING or RETRYING");for(E=[];this._pending_callbacks.length;)w=this._pending_callbacks.pop(),t=w[0],o=w[1],E.push("function"==typeof o?o(a.CONNECTION_CLOSED):void 0);return E}return i.assert(!1,"Changing connection_state to CONNECTION_PENDING not supported.")}}},p.prototype._on_message=function(e){return function(t){return function(n){var i,o,s,r,a,l;return o=JSON.parse(n.data),null==o.func||null==(null!=(s=o.header)?s.message_id:void 0)||null==(null!=(r=o.header)?r.should_respond:void 0)?void t._terminate_handshake(e.ws,"Malformed message from client.",{message:n.data}):(null!=(null!=(a=o.header)?a.log_data:void 0)&&t.logger.update(o.header.log_data),t.logger.update({port:e.port}),"response"===o.func?t._on_response(o.header.message_id,o.data):(i=t._routes[o.func],null==i?void t._terminate_handshake(e.ws,"Unknown function.",{function:o.func}):(l=t.is_ready()?i(o.data):i(e,o.data),o.header.should_respond?t.send("response",l,null,null,o.header.message_id):void 0)))}}(this)},p.prototype.send=function(e,t,n,i,o){return null==t&&(t=null),null==n&&(n=null),null==i&&(i=null),null==o&&(o=null),this._send_with_ws(this._ws,e,t,n,i,o)},p.prototype._send_with_ws=function(e,t,n,o,s,r){var l,c,u,d;null==n&&(n=null),null==o&&(o=null),null==s&&(s=null),null==r&&(r=null),null==r&&(r=this._current_message_id,i.assert(this._current_message_id%2===1,"Web-initiated message_ids should remain odd"),this._current_message_id+=2),null!==o&&(d=window.setTimeout(this._on_response_timeout(r),p._RESPONSE_TIMEOUT),this._response_callbacks[r]=[o,s,d]),u={func:t,header:{message_id:r,should_respond:null!==o,log_data:this.logger.get_log_data_for_client()}},null!=n&&(u.data=n);try{return e.send(JSON.stringify(u))}catch(e){return l=e,this.logger.report_event("unity_failure",{message:"WebSocket send failed. Message: "+l.message,error_name:l.name}),"function"==typeof s?s(a.COULD_NOT_SEND):void 0}},p.prototype._on_response=function(e,t){var n,i,o,s;return e in this._response_callbacks?(i=this._response_callbacks[e],o=i[0],n=i[1],s=i[2],delete this._response_callbacks[e],window.clearTimeout(s),o(t)):void 0},p.prototype._on_response_timeout=function(e){return function(t){return function(){var n,i,o;return o=t._response_callbacks[e],n=o[0],i=o[1],n=o[2],delete t._response_callbacks[e],"function"==typeof i?i(a.CONNECTION_TIMEOUT):void 0}}(this)},p.prototype._check_unity_version=function(e,t){var n;return e.state!==p._CONNECTION_OPENED_STATE?void this._terminate_handshake(e.ws,"Handshake version check at wrong time of protocol."):(e.state=p._VERSION_CHECK_STATE,e.client_version=t.client_version,t.client_version<c.UNITY_HANDSHAKE?void this._terminate_handshake(e.ws,"Client version is too old."):(n=d.get_viewer().is_signed_in,t.client_version<c.PERMISSION_LEVELS&&!n?void this._terminate_handshake(e.ws,"Client version is too old to support insecure web connections."):(this.logger.report_event("handshake_version_check"),t.client_version>=c.PERMISSION_LEVELS?this._send_with_ws(e.ws,"initiate_handshake",{secure_web:n}):this._send_with_ws(e.ws,"initiate_handshake"))))},p.prototype._fetch_unity_nonce=function(e,t){return e.state===p._VERSION_CHECK_STATE?(e.state=p._FETCHING_NONCE_STATE,this.logger.report_event("handshake_fetch_nonce"),this._retrieve_unity_nonce(e,t.nonce_key)):this._terminate_handshake(e.ws,"Fetch Unity nonce at wrong time of protocol.")},p.prototype._retrieve_unity_nonce=function(e,t){return s.WebRequest({url:o({path:"/retrieve_unity_nonce"}),dataType:"json",data:{nonce_key:t},success:function(t){return function(n){var o;switch(n.status){case"OK":return e.state=p._NONCE_RETURNED_TO_CLIENT_STATE,e.client_version>=c.PORT_CHECK&&(i.assert(n.message.client_port,"Port check must happen in version "+e.client_version),n.message.client_port!==e.port)?void t._terminate_handshake(e.ws,"Mismatched ports.",{client_port:n.message.client_port,web_port:e.port}):(e.client_has_auth=n.message.client_has_auth,o=d.get_viewer().is_signed_in,e.client_has_auth&&o?t._permission_level=p.SECURE_PERMISSION:(i.assert(e.client_version>=c.PERMISSION_LEVELS,"Insecure connections only supported by client_version >= "+c.PERMISSION_LEVELS+"."),t._permission_level=e.client_has_auth?p.INSECURE_WEB_PERMISSION:o?p.INSECURE_CLIENT_PERMISSION:p.INSECURE_PERMISSION),t.logger.update({unity_permission_level:t._permission_level}),t.logger.report_event("handshake_nonce_sent_to_unity_server"),t._send_with_ws(e.ws,"verify_unity_nonce",{nonce:n.message.nonce}));case"MISMATCHED_USER_IDS":return t._terminate_handshake(e.ws,"Mismatched user_ids.",{client_user_ids:n.message.client_user_ids,web_user_ids:n.message.web_user_ids});case"INVALID":return t._terminate_handshake(e.ws,"Could not find nonce with given nonce_key.");case"AUTH_REQUIRED":return t._terminate_handshake(e.ws,"Did not have the necessary authentication to retrieve nonce.")}}}(this),error:function(t){return function(n,i,o){return t._terminate_handshake(e.ws,"Unable to retrieve nonce from server",{status:i,error_string:o})}}(this)})},p.prototype._complete_handshake=function(e,t){var n;return e.state===p._NONCE_RETURNED_TO_CLIENT_STATE&&t.is_success?(e.state=p._HANDSHAKE_COMPLETED_STATE,this._connection_state===p._CONNECTION_CLOSED?this._terminate_handshake(e.ws,"No more handshakes are allowed to complete."):null!=this._ws?(n="Only one Unity handshake can succeed! There's likely a MITM attack, so close all connections.",this._terminate_handshake(e.ws,n),this._terminate_handshake(this._ws,n),this.client_version=null,this._ws=null,this._port=null,this._set_connection_state(p._CONNECTION_CLOSED)):(this.client_version=e.client_version,this._ws=e.ws,this._port=e.port,this._set_connection_state(p._CONNECTION_ESTABLISHED))):this._terminate_handshake(e.ws,"Unable to complete handshake.")},p.prototype._terminate_handshake=function(e,t,i){var o;return null==i&&(i=null),o={message:t},null!=i&&n.extend(o,i),r.getGandalfRule("unity-web-debug")&&console.error(o),this.logger.report_event("unity_failure",o),e.close()},p.prototype._is_connection_in_progress=function(e){return e===p._CONNECTION_PENDING||e===p._CONNECTION_RETRYING},p.prototype.add_on_open_callback=function(e){return this._on_open_callbacks.push(e)},p.prototype.add_on_open_failed_callback=function(e){return this._on_open_failed_callbacks.push(e)},p.prototype.add_on_close_callback=function(e){return this._on_close_callbacks.push(e)},p.prototype.call_when_ready=function(e,t){return null==t&&(t=null),this.is_ready()?e():this._is_connection_in_progress(this._connection_state)?this._pending_callbacks.push([e,t]):"function"==typeof t?t(a.CONNECTION_CLOSED):void 0},p.prototype.is_ready=function(){var e;return(null!=(e=this._ws)?e.readyState:void 0)===WebSocket.OPEN&&this._connection_state===p._CONNECTION_ESTABLISHED},p.prototype.feature_supported=function(e,n){var o;return i.assert(null!==this._permission_level,"Connection is not ready."),this.client_version<e?!1:(o=this._permission_level,t.call(n,o)>=0)},p}():void 0})}.call(this),function(){define("modules/clean/unity/connection_error",[],function(){var e;return e=function(){function e(){}return e.CONNECTION_TIMEOUT="connection_timeout",e.CONNECTION_CLOSED="connection_closed",e.COULD_NOT_SEND="could_not_send",e.UNEXPECTED_ERROR="unexpected_error",e}()})}.call(this),function(){define("modules/clean/unity/features",["external/modernizr","jquery","modules/clean/ajax","modules/clean/filepath","modules/clean/gandalf_util","modules/clean/unity/connection","modules/clean/unity/versions","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,n,i,o,s,r,a,l,c,u){var d;return null!=s?(d=function(){function e(){}return e._uc=new s,e._has_handshake_started=!1,e._start_handshake_if_needed=function(){return this._has_handshake_started?void 0:(this._uc.start(),this._has_handshake_started=!0)},e._cached_file_browser_display_name=null,e.continue_as_user=function(e,t,n,i){return null==i&&(i=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(o){return function(){return o._uc.feature_supported(r.WEB_DESTINY,[s.INSECURE_WEB_PERMISSION])?(o._uc.logger.report_event("continue_as_user",{browser:e,refresh_token:t}),o._uc.send("continue_as_user",{browser:e,refresh_token:t},n,i)):void 0}}(this),i)},e.continue_as_user_direct=function(e,t){return null==t&&(t=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(n){return function(){return n._uc.feature_supported(r.WEB_DESTINY_V2,[s.INSECURE_WEB_PERMISSION])?(n._uc.logger.report_event("continue_as_user_direct"),n._uc.send("continue_as_user_direct",null,e,t)):void 0}}(this),t)},e.web_destiny_info=function(e,t){return null==t&&(t=null),this._start_handshake_if_needed(),this._uc.call_when_ready(function(n){return function(){return n._uc.feature_supported(r.WEB_DESTINY_V2,[s.INSECURE_WEB_PERMISSION])?(n._uc.logger.report_event("web_destiny_info"),n._uc.send("web_destiny_info",null,e,t)):void 0}}(this),t)},e.client_supports_open_in_file_browser=function(){return o.getGandalfRule("unity-file-browser")&&this._uc.feature_supported(r.OPEN_IN_FILE_BROWSER,[s.SECURE_PERMISSION])},e.open_file=function(e,t,o,l,c,d){var p;return null==c&&(c=null),null==d&&(d=!1),this._start_handshake_if_needed(),p=this.server_path(e,t),this._uc.call_when_ready(function(e){return function(){var t;return e._uc.feature_supported(r.UNITY_HANDSHAKE,[s.SECURE_PERMISSION])?(e._uc.logger.report_event("open_file",{user_id:o,path_id:p,file_extension:i.file_extension_for_logging(p),in_file_browser:d}),n.AuthenticatedRequest({url:u({path:"/unity_open_log"}),data:{user_id:o,server_path:p,file_extension:i.file_extension_for_logging(p),in_file_browser:d,unity_session_id:e._uc.logger.unity_session_id(),buildno:e._uc.logger._data.buildno,host_id:e._uc.logger._data.host_id}}),t={server_path:p,user_id:o},e._uc.client_version>=r.OPEN_IN_FILE_BROWSER?t.in_file_browser=d:a.assert(!d,"The connected client doesn't support opening in file browser."),e._uc.send("open_file",t,l,c)):void 0}}(this),c)},e.standard_open_file_handler=function(e){return e?void 0:c.error(l._("Error opening file"))},e.check_file=function(e,t,n,o,a){var l,c;return null==a&&(a=null),this._start_handshake_if_needed(),c=this.server_path(e,t),l=function(e){return function(t){return e._check_file_deprecated_on_client()&&(t={is_locally_available:t}),o(t)}}(this),this._uc.call_when_ready(function(e){return function(){return e._uc.feature_supported(r.UNITY_HANDSHAKE,[s.SECURE_PERMISSION])?(e._uc.logger.report_event("check_file",{user_id:n,path_id:c,file_extension:i.file_extension_for_logging(c)}),e._uc.send("check_file",{server_path:c,user_id:n},l,a)):void 0}}(this),a)},e.add_on_ready_callback=function(e){return this._uc.call_when_ready(e)},e.check_file_batch=function(e,n,o,a){var l,c,u,d,p;return null==a&&(a=null),l=t.Deferred(),this._start_handshake_if_needed(),p=function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)u=e[t],i.push(this.server_path(u.ns_id,u.ns_path));return i}.call(this),d=function(e){return function(t){var n,i;if(e._check_file_deprecated_on_client())for(n in t)i=t[n],t[n]={is_locally_available:i};return o(t),l.resolve(t)}}(this),c=function(e){return"function"==typeof a&&a(e),l.reject(e)},this._uc.call_when_ready(function(e){return function(){var t;return e._uc.feature_supported(r.UNITY_HANDSHAKE,[s.SECURE_PERMISSION])?(e._uc.logger.report_event("check_file_batch",{user_id:n,path_ids:p,file_extensions:function(){var e,n,o;for(o=[],e=0,n=p.length;n>e;e++)t=p[e],o.push(i.file_extension_for_logging(t));return o}()}),e._uc.send("check_file_batch",{server_paths:p,user_id:n},d,c)):void 0}}(this),c),l.promise()},e.file_browser_display_name=function(e,t){var n,i;return null==t&&(t=null),null!=this._cached_file_browser_display_name?void e(this._cached_file_browser_display_name):(n=function(t){return function(n){return t._cached_file_browser_display_name=n,e(n)}}(this),this._start_handshake_if_needed(),i=function(i){return function(){return i._uc.feature_supported(r.CHECK_FILE_RETURNS_OBJ,[s.SECURE_PERMISSION])?(i._uc.logger.report_event("file_browser_display_name"),i._uc.send("file_browser_display_name",null,n,t)):e(null)}}(this),this._uc.call_when_ready(i,t))},e._check_file_deprecated_on_client=function(){return r.UNITY_HANDSHAKE<=this._uc.client_version&&this._uc.client_version<r.CHECK_FILE_RETURNS_OBJ},e.server_path=function(e,t){return e+":"+t},e}(),__CONDITIONAL_JS__.UnityFeatures=d,d):void 0})}.call(this),function(){define("modules/clean/unity/flash_config",["external/flash_detect","modules/clean/gandalf_util","modules/constants/static","modules/core/browser"],function(e,t,n,i){return window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0,window.DefaultWebSocket=window.WebSocket,!i.safari_version_at_most(8)&&e.versionAtLeast(10,3)&&(window.WEB_SOCKET_FORCE_FLASH=!0),window.WEB_SOCKET_SWF_LOCATION=n.static_url_web_socket_swf,t.getGandalfRule("unity-web-debug")?void 0:window.WEB_SOCKET_LOGGER={log:function(){},error:function(){}}})}.call(this),function(){define("modules/clean/unity/logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions"],function(e,t,n,i,o){var s;return s=function(){function s(){this._data={logging_source:"web",web_unity_version:o.LATEST}}return s.prototype.update=function(t){return e.extend(this._data,t)},s.prototype.report_event=function(e,o){return null==o&&(o=null),this._data.event_name=e,this._data.local_ts=(new Date).getTime()/1e3,this._data.extra=JSON.stringify(o||{}),n.WebRequest({url:t({path:"/unity_connection_log"}),data:this._data}),i.getGandalfRule("unity-web-debug")?console.log(this._data):void 0},s.prototype.get_log_data_for_client=function(){return{web_unity_version:this._data.web_unity_version,user_agent:window.navigator.userAgent}},s.prototype.unity_session_id=function(){return this._data.unity_session_id},s}()})}.call(this),function(){define("modules/clean/unity/versions",function(){var e;return e=function(){function e(){}return e.LATEST=9,e.INITIAL_UNITY=1,e.UNITY_HANDSHAKE=2,e.REUNITY=3,e.OPEN_IN_FILE_BROWSER=4,e.CHECK_FILE_RETURNS_OBJ=5,e.PERMISSION_LEVELS=6,e.WEB_DESTINY=7,e.WEB_DESTINY_V2=8,e.PORT_CHECK=9,e}()})}.call(this),function(){define("modules/clean/unity/web_socket",["modules/constants/env","modules/core/browser","modules/clean/unity/logger","external/web_socket"],function(e,t,n,i){var o,s;return o=e.IS_PROD?17603:17604,s=function(){function e(){}return e.create=function(e){return"function"==typeof i.__initialize&&i.__initialize(),new i(e)},e.load_flash_policy_if_needed=function(){var e;if(e=new n,null!=(null!=i?i.loadFlashPolicyFile:void 0))e.report_event("load_flash_policy_file"),i.loadFlashPolicyFile("xmlsocket://127.0.0.1:"+o);else{if(!t.safari_version_at_most(8))return e.report_event("unity_failure",{message:"Could not use WebSockets."}),!1;e.report_event("using_default_web_socket")}return!0},e.web_sockets_supported=function(){return null!=i},e}()})}.call(this),function(){define("modules/clean/upsell/prompt_loader",["jquery","modules/clean/dbmodal","modules/clean/uirequest"],function(e,t,n){var i,o,s,r;return i=t.DBModalStack,o={init:function(t,i,o,s){return t?new n(e("#ha-container"),"/prompt/ha",{data:{ref_controller:i,ref_action:o,campaign_id:s},subject_user:t}):void 0}},s={init:function(t,i,o,s,r){return new n(e("#outer-frame"),"/prompt/main_campaign",{data:{ref_controller:i,ref_action:o,in_app:s,sprite_group:r},dataType:"json",subject_user:t,success:function(){return e(".db-modal-overlay").is(":visible")?void 0:e("#db-modal-upsell-home-modal").addClass("show-upsell-modal").trigger("show-upsell-modal")}})}},r={init:function(t,i){return new n(e("#page-header"),"/prompt/top_notification_bar",{data:{ref_controller:t,ref_action:i},success:function(){return e("body").addClass(e("[data-body-class]").data("body-class"))}})}},{HALoader:o,PromptLoader:s,TopNotificationBarLoader:r}})}.call(this),function(){define("modules/clean/uuid",["modules/clean/crypto"],function(e){var t,n,i,o,s,r,a,l,c;return n=/generator isn't seeded/,o={},t=function(){var e,t;for(t=[],a=e=0;255>=e;a=++e)t.push((a+256).toString(16).substr(1));return t}(),i=function(e){var n,i;return i=function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)n=e[i],s.push(t[n]);return s}(),i.join("")},l=function(e){return 255&e},c=function(e){var t,n,o;return t=[e.slice(0,4),e.slice(4,6),e.slice(6,8),e.slice(8,10),e.slice(10,16)],n=function(){var n,o,s;for(s=[],n=0,o=t.length;o>n;n++)e=t[n],s.push(i(e));return s}(),o=n.join("-")},r=function(t){var i,o,r,a,c;null==t&&(t={}),c=new Array(16);try{e.getRandomValues(c)}catch(e){if(o=e,!o.message.match(n)||!t.allowInsecure)throw o;s(c)}return i=function(){var e,t,n;for(n=[],e=0,t=c.length;t>e;e++)a=c[e],n.push(l(a));return n}()},s=function(e){var t,n,i;for(i=Math.pow(2,8),a=t=0,n=e.length;n>=0?n>t:t>n;a=n>=0?++t:--t)e[a]=Math.floor(Math.random()*i);return e},o.v4=function(e){var t;return null==e&&(e={}),t=r({allowInsecure:e.allowInsecure}),t[6]=15&t[6]|64,t[8]=63&t[8]|128,c(t)},o})}.call(this),function(){define("modules/clean/video_util",["jquery","modules/core/browser","modules/core/i18n","external/flash_detect","external/videojs/video","external/videojs/videojs_hls","modules/clean/ajax","modules/constants/static","modules/constants/viewer"],function(e,t,n,i,o,s,r,a,l){var c,u,d;return u=n._,c={_video_counter:0,embed:function(n,i){var o,s,c,p,h,_,m,f,v,g,y,b,w;if(null==i&&(i={}),!this.can_embed_type(i.type))return null!=i.onError&&setTimeout(function(){return i.onError("needflash")},0),document.createElement("div");for(i.preload="undefined"!=typeof i.preload?i.preload:!0,i.preload&&(i.preload="auto"),p="video-"+this._video_counter,this._video_counter+=1,w=e("<video/>",{class:"video-js vjs-default-skin vjs-big-play-centered",id:p,controls:i.controls}),w=w[0],o=-1,v=["width","height","preload","poster","autoplay"],c=0,h=v.length;h>c;c++)m=v[c],i[m]&&w.setAttribute(m,i[m]);return g=e("<source/>",{src:i.src,type:i.type}),g=g[0],w.appendChild(g),n=e(n),n.empty(),n=n[0],n.appendChild(w),_=function(){var n,s,a,l;return l=this,"function"==typeof i.onReady&&i.onReady(),n=function(){return null!=l.hls?l.hls.fillBuffer():void 0},t&&(t.ipad&&(s=0,e(document).on("dropdownOpened modalOpened",function(t,n){return s+=n,e(l.el_).children("video").removeAttr("controls")}),e(document).on("dropdownClosed modalClosed",function(t,n){return s-=n,0===s?e(l.el_).children("video").attr("controls","controls"):void 0})),t.msie&&"9.0"===t.version&&l.on("playing",function(){return l.removeClass("vjs-seeking")})),"Hls"===l.techName&&l.on("seeked",function(){return l.controlBar.currentTimeDisplay.updateContent()}),l.on("pause",function(){return o=setInterval(n,500),l.ended()?l.removeClass("vjs-has-started"):void 0}),l.on("play",function(){return clearInterval(o),o=-1}),l.on("dispose",function(){return clearInterval(o)}),l.on("ended",function(){return l.src({type:i.type,src:i.src})}),"application/vnd.apple.mpegurl"===i.type&&d(l),a=function(){return l.addClass("show-truncated-bar")},!i.metadata&&i.metadata_link?r.AuthenticatedRequest({url:i.metadata_link,type:"GET",data:{},xhrFields:{withCredentials:!0},success:function(e){return"function"==typeof i.metadata_cb&&i.metadata_cb(e),e=JSON.parse(e),e.is_truncated?a.defer():void 0}}):i.metadata&&i.metadata.is_truncated?a.defer():void 0},b=u("The clip displayed here is a preview. To view the entire video, download or add it to your Dropbox."),l.transcoder_hls4web&&(videojs.Hls.GOAL_BUFFER_LENGTH=120),videojs.TruncatedBar=videojs.Component.extend(),videojs.TruncatedBar.prototype.options_={loadEvent:"play",components:{}},videojs.TruncatedBar.prototype.createEl=function(){var e;return e=videojs.createEl("div",{className:"truncated-bar",id:"truncated-video-message-bar"}),e.textContent=b,e},videojs.options.children.TruncatedBar={},document.location.search.indexOf("bitrate-overlay=1")>=0&&(videojs.BitrateOverlay=videojs.Component.extend(),videojs.BitrateOverlay.prototype.options_={loadEvent:"play",components:{}},videojs.BitrateOverlay.prototype.createEl=function(){var e;return e=videojs.createEl("div",{className:"bitrate-overlay",id:"bitrate-overlay"}),e.textContent="bitrate: N/A",e},videojs.options.children.BitrateOverlay={}),s={swf:a.static_url_video_js_swf,flashVars:{contentType:i.type,hlsDebugLevel:l.hls_debug_level}},y=l.transcoder_hls4web?["html5","hls","flash"]:["flash"],f=videojs(w,{flash:s,techOrder:y},_),i.onError&&f.on("error",i.onError),f},can_embed_type:function(e){var t;return""!==("function"==typeof(t=document.createElement("video")).canPlayType?t.canPlayType(e):void 0)?!0:i.installed&&i.majorAtLeast(10)?"application/vnd.apple.mpegurl"===e||"video/flv"===e||"video/mp4"===e:!1}},d=function(t){var n,i,o,s,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T,A,I,k,P,N,R,x,O,L,D;for(S=[250,500,1500,3e3],v=null,C=null,w=null,R=0,y=-1,f=!1,b=null,m=-1,I=[],x=!0,L=0,_={},g=0,E=S.length;E>g;g++)k=S[g],_[k.toString()]=0;return O=null,D=[],A=100,P=function(){var e,n,i,o,s;for(e={},n=0,i=S.length;i>n;n++)k=S[n],
s=_[k.toString()],e[k.toString()]=Math.round(s/L*100)||0;return o={duration:Math.round(1e3*t.duration()),initial_bitrate:S[y]||0,initial_play_wait:b||0,bitrate_percentages:JSON.stringify(e),stalls:R,quality_events:JSON.stringify(I),xhr_errors:JSON.stringify(D),percentage_watched:A},N(),r.AuthenticatedRequest({url:"/video_web_play_log",type:"POST",data:o})},N=function(){var e,t;for(v=null,C=null,w=null,R=0,y=-1,f=!1,b=null,m=-1,I=[],x=!0,L=0,_={},e=0,t=S.length;t>e;e++)k=S[e],_[k.toString()]=0;return O=null,D=[],A=100},o=function(){return p(),P()},u=function(){return p(),A=Math.round(t.currentTime()/t.duration()*100),isFinite(A)||(A=0),P()},h=function(){return x?(O=Date.now(),x=!1):void 0},p=function(){var e;return x?void 0:(e=Date.now()-O,L+=e,_[S[m].toString()]+=e,x=!0)},a=function(){return null===v&&(w=v=Date.now()),C=Date.now()},n=function(){var n;return n=t.hls.selectPlaylist().attributes.BANDWIDTH/1e3,e(".bitrate-overlay").text("bitrate: "+n),S.indexOf(n)},i=function(){return m=n(),y=m,h(),f?void 0:(b=null===v?0:Date.now()-v,f=!0)},s=function(){return p()},c=function(){return C=Date.now()},d=function(){return p(),Date.now()-C>5e3?R+=1:void 0},l=function(){var e;return t.ended()||t.error()||t.paused()?void 0:(p(),e=m,m=n(),Date.now()-v<1e3?y=m:I.push([S[e],S[m],Date.now()-w]),w=Date.now(),h())},t.on("play",a),t.on("pause",s),t.on("canplay",i),t.on("waiting",d),t.on("seeking",c),t.on("ended",o),t.on("shutdown",u),t.on("mediachange",l),"Hls"===t.techName?(T=videojs.Hls.xhr,videojs.Hls.xhr=function(e,t){var n;return n=function(e,n){var i;return e&&(i="",(""===this.responseType||"text"===this.responseType)&&(i=this.responseText),D.push([this.status.toString(),i,n])),t.call(this,e,n)},T.call(this,e,n)}):void 0},c})}.call(this),function(){define("modules/constants/python",[],function(){return PythonConstants||{}})}.call(this),function(){define("modules/constants/sharing",[],function(){return"undefined"!=typeof SharingServerConstants&&null!==SharingServerConstants?SharingServerConstants:{}})}.call(this),function(){define("modules/constants/static",[],function(){return StaticConstants||{}})}.call(this),function(){define("modules/constants/stickers",[],function(){return window.StickerConstants})}.call(this),function(){"use strict";var e=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/core/type",["external/underscore"],function(t){var n,i,o,s,r,a,l,c;return r={},r.Type=n=function(){function e(e,n){if(!t.isString(e)&&!t.isFunction(e))throw new TypeError("First parameter needs to be a string identifying the type");if(!t.isFunction(n))throw new TypeError("Second parameter needs to be a predicate defining the type");this.getTypeString=t.isFunction(e)?e:function(){return e},this.predicate=n}return e}(),o=function(e){var i,s;if(c(e))return!0;if(e instanceof n)return!0;if(t.isFunction(e))return!0;if(t.isArray(e)){if(1!==e.length)return!1;if(!o(e[0]))return!1}else{if(!(t.isObject(e)&&null==e.prototype&&e.constructor===Object&&t.keys(e).length>0))return!1;for(i in e)if(s=e[i],!o(s))return!1}return!0},i=function(){var e,i,s,r,a,l,c;return c=new n("undefined",t.isUndefined),i=new n("null",t.isNull),e=new n("Boolean",t.isBoolean),s=new n("Number",t.isNumber),a=new n("String",t.isString),r=new n("Object",function(e){return t.isObject(e)&&!t.isFunction(e)&&!t.isArray(e)}),l=new n("Type",o),function(t){return"undefined"==typeof t?c:null===t?i:t===Boolean?e:t===Number?s:t===String?a:t===Object?r:t===n?l:void 0}}(),r.isBasicType=c=function(e){return null!=i(e)},r.firstFailingKeypath=a=function(o,s,r){var l,u,d,p,h,_,m,f,v,g;if(null==r&&(r=[]),c(o)){if(!i(o).predicate(s))return r}else if(o instanceof n){if(!o.predicate(s))return r}else if(t.isFunction(o)){if(!(s instanceof o))return r}else if(t.isArray(o)){if(a(Array,s,r))return r;for(u=d=0,_=s.length;_>d;u=++d){if(l=s[u],r.push(u),a(o[0],l,r))return r;r.pop()}}else{if(a(Object,s,r))return r;for(g=t.keys(o),f=t.keys(s),h=0,m=f.length;m>h;h++)if(p=f[h],e.call(g,p)<0)return r;for(p in o){if(v=o[p],r.push(p),a(v,s[p],r))return r;r.pop()}}},r.checkType=s=function(e,t){return null==a(e,t)},r.getTypeString=l=function(e){var o,s,r;if(c(e))return i(e).getTypeString();if(e instanceof n)return e.getTypeString();if(t.isFunction(e))return e.name;if(t.isArray(e))return"["+l(e[0])+"]";s=[];for(o in e)r=e[o],s.push(o+": "+l(r));return"{"+s.join(", ")+"}"},r})}.call(this),function(){"use strict";var e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},t={}.hasOwnProperty,n=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},i=[].slice;define("modules/core/types",["external/underscore","modules/constants/env","modules/core/type"],function(t,o,s){var r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S,T;return f=s.Type,v=s.checkType,w=s.getTypeString,b=s.firstFailingKeypath,C=s.isBasicType,h=function(){try{return Boolean(localStorage.production_typechecking)}catch(e){return!1}}(),m=function(t){function n(e){n.__super__.constructor.call(this,w.bind(null,e),v.bind(null,e))}return e(n,t),n}(f),u=function(i){function o(e,n){null!=o.names?o.names.set(this,e):this.__name===e,null!=n&&t.extend(this,n)}e(o,i);try{o.names=new WeakMap}catch(e){o.names=null}return o.prototype.getTypeString=function(){return null!=o.names?o.names.get(this):this.__name},o.prototype.predicate=function(e){return n.call(t.values(this),e)>=0},o}(f),l=function(t){function n(e){this.valType=e}return e(n,t),n.prototype.getTypeString=function(){return"Dict[string -> "+w(this.valType)+"]"},n.prototype.predicate=function(e){var t,n;return function(){var i;i=[];for(t in e)n=e[t],i.push(v(this.valType,n));return i}.call(this).every(function(e){return e})},n}(f),g=function(e,n){var o,s,r,a,l,c,u,d;if(C(e));else if(e instanceof f)null!=e.parameter_types&&t.isFunction(n)&&!n.isTypeChecked&&(n=T.apply(null,i.call(e.parameter_types).concat([n])));else if(t.isFunction(e));else if(t.isArray(e))for(r=a=0,c=n.length;c>a;r=++a)o=n[r],s=g(e[0],o),s!==o&&(n=n.slice(),n[r]=s);else for(l in e)u=e[l],d=g(u,n[l]),d!==n[l]&&(n=t.clone(n),n[l]=d);return n},E=function(e,n,i,o){var s,r,a,l;for(s=0,l=n.length;l>s;s++)r=n[s],o=o[r],i=t.isArray(i)?i[0]:i[r];return n.length>0&&(a=", key "+n.join(".")),a=null!=a?a:"","Argument "+e+a+": Value "+JSON.stringify(o,null,"  ")+" doesn't match type "+w(i)},T=function(){var e,n,o,s;return s=2<=arguments.length?i.call(arguments,0,n=arguments.length-1):(n=0,[]),e=arguments[n++],o=function(){var n,o,r,a,l,c,u,d,p,h,_,f;if(o=1<=arguments.length?i.call(arguments,0):[],n=s,d=t.find(s,function(e){return e instanceof m}),null!=d&&(p=t.indexOf(n,d),h=Math.max(o.length-n.length+1,0),_=[p,1],t.times(h,function(){return _.push(d)}),n=n.slice(),n.splice.apply(n,_)),o.length>n.length)throw new Error("Too many arguments: Supplied "+o.length+" but expected up to "+n.length);for(a=l=0,c=n.length;c>l;a=++l){if(f=n[a],r=b(f,o[a]),null!=r)throw u=E(a,r,f,o[a]),new TypeError(u);o[a]=g(f,o[a])}return e.apply(this,o)},o.isTypeChecked=!0,o},S=function(e,t){var n;return n=function(){var n,o,s,r;if(n=1<=arguments.length?i.call(arguments,0):[],r=t.apply(this,n),o=b(e,r),null!=o)throw s=E(0,o,e,r),new TypeError(s);return r},t.isTypeChecked&&(n.isTypeChecked=!0),n},c=function(e,t){var n,i;return n=function(){return"("+w(e)+"|"+w(t)+")"},i=function(n){return v(e,n)||v(t,n)},new f(n,i)},p=function(e){var t,n,i;return e instanceof f&&e.isOptional||e instanceof m?e:(t=function(){return"?"+w(e)},n=function(t){return null==t||v(e,t)},i=new f(t,n),e instanceof f&&null!=e.parameter_types&&(i.parameter_types=e.parameter_types),i.isOptional=!0,i)},d=function(){var e,n,o,s;return s=1<=arguments.length?i.call(arguments,0):[],e=function(){return"function("+s.map(w).join(", ")+")"},n=t.isFunction,o=new f(e,n),o.parameter_types=s,o},_=function(e){return new m(e)},a=function(e){return new l(e)},y={},y.takes=S(Function,T(_(f),Function,T)),y.returns=S(Function,T(f,Function,S)),y.Type=f,y.Enum=u,y.Dict=S(f,T(f,a)),y.Either=S(f,T(f,f,c)),y.Maybe=S(f,T(f,p)),y.Splat=S(f,T(f,_)),y.Any=r=new f("Any",function(){return!0}),y.Func=S(f,T(_(f),d)),y.inject=S(Object,T(Object,function(e){return t.extend(e,t.omit(y,"inject"))})),o.IS_PROD&&!h&&(y.takes=function(){var e,t,n;return e=2<=arguments.length?i.call(arguments,0,n=arguments.length-1):(n=0,[]),t=arguments[n++]},y.returns=function(){var e,t,n;return e=2<=arguments.length?i.call(arguments,0,n=arguments.length-1):(n=0,[]),t=arguments[n++]}),y})}.call(this),function(){define("modules/core/user_i18n",["modules/constants/viewer"],function(e){var t;return t=function(){function t(){}return t.getInitials=function(e){var n;return e?(n=e.split(" "),n.length>=2?t._is_cjk_locale()?n[n.length-1][0]+n[0][0]:n[0][0]+n[n.length-1][0]:t._is_cjk_locale()&&!t._is_ascii_name(e)&&e.length>1?e.substring(0,2):e.substring(0,1)):""},t._is_ascii_name=function(e){var t,n,i,o;for(n=i=0,o=e.length;o>i;n=++i)if(t=e[n],e.charCodeAt(n)>=128)return!1;return!0},t._is_cjk_locale=function(){var t;return"zh"===(t=e.USER_LOCALE)||"ja"===t||"ko"===t},t}()})}.call(this),function(){define("modules/core/visibility",["jquery"],function(e){var t,n,i;return t={},i=function(){return document.hasFocus()},n=function(t){return e(window).one("focus",t)},t.when=function(){var t,o;return t=new e.Deferred,o=function(){return t.resolve()},i()?o():n(o),t.promise()},t})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/browse/preview_sf_members",["dropbox","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/photo_avatar","modules/clean/avatar/size","modules/clean/avatar/viewer_avatar","modules/clean/browse_events","modules/clean/components/loading_indicator","modules/clean/components/title_bubble","modules/clean/dbmodal","modules/clean/em_string","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/sharing/api","modules/clean/viewer","modules/core/browser","modules/core/i18n","modules/clean/sharing/member_avatars","modules/clean/static_urls","modules/clean/filepath"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C,E,S){var T,A,I,k,P,N,R,x,O,L,D,M,F,U,B,V,H,q,W;return k=t.Browse,N=t.ExistingSharedFolderOptionsContent,F=t.SharingModals,D=o.SharedFolderActivityLogger,I=c.AVATAR_DIMENSION_BY_SIZE,P=_.DBModalStack,M=g.SharingApi,B=w._,W=w.ungettext,q=E.static_url,V=n.createElement,H=n.DOM,x=15,A=I.MEDIUM,U="south",T=!0,O=function(){function t(t){this._sharing_api_request_handler=e(this._sharing_api_request_handler,this),this._log_event=e(this._log_event,this),this._browse_update_handler=e(this._browse_update_handler,this),this.focus_sharing_options_modal_invite_form=e(this.focus_sharing_options_modal_invite_form,this),this.overflow_click_handler=e(this.overflow_click_handler,this),this.avatar_click_handler=e(this.avatar_click_handler,this),this.invite_button_click_handler=e(this.invite_button_click_handler,this),this.settings_button_click_handler=e(this.settings_button_click_handler,this),this.container_element=t[0],this.last_visited_ns_id=null,this.$body=$j("body"),this.$browse_files=$j("#browse-files"),$j(document).on(d.UPDATE,this._browse_update_handler),$j(document).on(M.REQUEST_SUCCEEDED_EVENT,this._sharing_api_request_handler)}return t.prototype.settings_button_click_handler=function(){return this._show_shared_folder_members_modal(),this._log_event("preview_sf_members_settings_button_clicked")},t.prototype.invite_button_click_handler=function(){return this._show_add_people_modal(),this._log_event("preview_sf_members_invite_button_clicked")},t.prototype.avatar_click_handler=function(){return this._log_event("preview_sf_members_avatar_clicked")},t.prototype.overflow_click_handler=function(){return this._show_shared_folder_members_modal(),this._log_event("preview_sf_members_overflow_number_clicked")},t.prototype.focus_sharing_options_modal_invite_form=function(){return P.unregister(N.CONTENT_LOADED_EVENT,this.focus_sharing_options_modal_invite_form),$j("#sharing-options-new-collab-input").focus()},t.prototype._should_show_create_share_ui=function(){return k.can_nest_in_containing_ns&&k.containing_ns_path()},t.prototype._browse_update_handler=function(){var e;return k.inside_dir&&k.inside_shared_folder?(e={user:k.active_user,onSettingsButtonClick:this.settings_button_click_handler,onOverflowCountClick:this.overflow_click_handler,onAvatarClick:this.avatar_click_handler},e.folderName=this._should_show_create_share_ui()?S.filename(k.containing_fq_path()):k.containing_mount_point().split("/").pop(),e.folderType=k.inside_team_folder?"TEAM":"SHARED",i.WebRequest({url:"/share_ajax/preview_members/"+k.containing_ns_id(),subject_user:k.active_user,data:{max_results:x},success:function(t){return function(i){return i=JSON.parse(i),i.ns_id===k.containing_ns_id()?(e=$j.extend({},e,{numUndisplayableUsersAndInvites:i.num_avatars_not_shown,numUsersAndInvites:i.num_users_and_invites,numUsersAndInvitesOutsideTeam:i.num_users_and_invites_outside_team,groups:i.groups,invitations:i.invitations,joinedMembers:i.joined_members}),i.user_can_invite&&("SHARED"===e.folderType||t._should_show_create_share_ui())&&(e.inviteButton=new R({onClick:t.invite_button_click_handler})),n.render(new L(e),t.container_element),k.update_header_height()):void 0}}(this)}),k.containing_ns_id()!==this.last_visited_ns_id&&(n.render(new L(e),this.container_element),k.update_header_height()),this._log_event("preview_sf_members_shown")):n.unmountComponentAtNode(this.container_element)&&k.update_header_height(),this.last_visited_ns_id=k.inside_dir?k.containing_ns_id():null},t.prototype._show_shared_folder_members_modal=function(){return this._should_show_create_share_ui()?F.show_share_existing_modal(k.containing_fq_path(),k.active_user,k.can_change_new_ns_options):F.show_shared_folder_options_modal(k.containing_mount_point(),k.active_user)},t.prototype._show_add_people_modal=function(){return this._should_show_create_share_ui()?F.show_share_existing_modal(k.containing_fq_path(),k.active_user):(P.register(N.CONTENT_LOADED_EVENT,this.focus_sharing_options_modal_invite_form),F.show_shared_folder_options_modal(k.containing_mount_point(),k.active_user))},t.prototype._log_event=function(e,t){return null==t&&(t={}),t.ns_id=k.containing_ns_id(),D.log("web",e,k.active_user,t)},t.prototype._sharing_api_request_handler=function(e,t){var n;return n=t.request_url,n.indexOf("/share_ajax/leave")>-1||n.indexOf("/share_ajax/unshare")>-1||!k.inside_dir||t.ns_id!==k.containing_ns_id()?void 0:this._browse_update_handler()},t}(),L=n.createClass({displayName:"PreviewSFMembersView",mixins:[C],propTypes:{folderName:n.PropTypes.string.isRequired,folderType:n.PropTypes.oneOf(["SHARED","TEAM"]).isRequired,user:n.PropTypes.object.isRequired,onSettingsButtonClick:n.PropTypes.func.isRequired,onOverflowCountClick:n.PropTypes.func,onAvatarClick:n.PropTypes.func,inviteButton:n.PropTypes.element,numUndisplayableUsersAndInvites:n.PropTypes.number,numUsersAndInvites:n.PropTypes.number,numUsersAndInvitesOutsideTeam:n.PropTypes.number,groups:n.PropTypes.array,invitations:n.PropTypes.array,joinedMembers:n.PropTypes.array,avatarDimension:n.PropTypes.number,titleButtonDirection:n.PropTypes.string},getDefaultProps:function(){return{titleButtonDirection:U,avatarDimension:A,maxVisibleAvatars:x,animation:T}},render:function(){return H.div({className:this.getClassName()},this.renderButtons(),this.renderFolderInfo(),this.props.numUsersAndInvites?"SHARED"===this.props.folderType?this.renderAvatars():this.renderTeamFolder():H.div({className:"loading-indicator-container"},V(p)))},getClassName:function(){return n.addons.classSet({"preview-sf-members-box":!0,clearfix:!0,"team-folder":"TEAM"===this.props.folderType})},renderTeamFolder:function(){var e,t;return e=null,this.props.groups&&(t=this.props.groups[0],t&&t.is_automatic&&(e=B("editor"===t.access_type?"%(group_name)s can edit":"%(group_name)s can view"),e=e.format({group_name:t.name}))),H.div({className:"team-folder-member-entry"},l({dimension:24,photoUrl:q("/static/images/icons/team_24-vflGwWtBj.png"),shape:"SQUARE",optionalClass:"u-l-fl"}),H.div({className:"team-folder-string"},e))},renderButtons:function(){return H.div({className:"buttons"},V(v.button,{className:"settings-button",importance:"tertiary",onClick:this.props.onSettingsButtonClick,title:B("Settings")},B("Settings")),this.props.inviteButton)},renderFolderInfo:function(){return H.div({className:"shared-folder-info"},H.span({className:"shared-folder-name"},m.em_snippet(this.props.folderName,18)),this.props.numUsersAndInvites?H.span({className:"bullet"},"•"):void 0,this.props.numUsersAndInvites?this.renderNumberOfMembers():void 0)},renderNumberOfMembers:function(){var e,t;return t=W("%(num_total)s member","%(num_total)s members",this.props.numUsersAndInvites,{comment:'Another pluralized string MAY be concatenated to this to make a string like: "15 members (4 outside of TechCorp Inc.)"'}),this.props.numUsersAndInvitesOutsideTeam?(t+=W(" (%(num_outside)s outside of %(team_name)s)"," (%(num_outside)s outside of %(team_name)s)",this.props.numUsersAndInvitesOutsideTeam,{comment:'This will be concatenated to another string to make a string like: "15 members (4 outside of TechCorp Inc.)"'}),e=t.format({num_total:this.props.numUsersAndInvites,num_outside:this.props.numUsersAndInvitesOutsideTeam,team_name:m.em_snippet(y.get_viewer().team_name,16)})):e=t.format({num_total:this.props.numUsersAndInvites}),H.span({className:"members-string"},e)},renderAvatars:function(){var e,t,n,i,o;return e=[],o=[],this.props.numUsersAndInvites&&(i=this.findOwnerAndMeInJoinedMembers(this.props.joinedMembers),n=i[0],t=i[1],null!=n&&(e.push(this.renderJoinedMember(n)),o.push(n.user_id)),null!=t&&t!==n&&(e.push(this.renderJoinedMember(t)),o.push(t.user_id)),this.addGroupsMembersInvitations(e,this.props.groups,this.props.joinedMembers,this.props.invitations,o)),this.renderAvatarList(e)}}),R=n.createClass({displayName:"InviteButton",propTypes:{onClick:n.PropTypes.func.isRequired},render:function(){return v.button({className:"invite-button",importance:"tertiary",onClick:this.props.onClick,title:B("Add members")})}}),O})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/browse/shared_with",["dropbox","external/react","modules/clean/ajax","modules/clean/analytics","modules/clean/avatar/shared_link_avatar","modules/clean/avatar/size","modules/clean/browse_events","modules/clean/components/title_bubble","modules/clean/dbmodal","modules/clean/em_string","modules/clean/file_events","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/sharing/shared_with_view","modules/clean/sharing/api","modules/clean/sharing/shared_link_modal","modules/clean/viewer","modules/core/browser","modules/core/i18n","modules/clean/sharing/member_avatars","modules/clean/account/email","modules/clean/datetime"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y,b,w,C){var E,S,T,A,I,k,P,N,R,x,O,L,D,M,F,U,B,V,H,q,W,j,G,z,K,Y,$;return T=t.Browse,B=t.SharingModals,V=t.SharingShmodel,j=t.UpdateEvents,H=t.SimpleSharing,k=t.ExistingSharedFolderOptionsModal,L=t.SharedLinkSettingsModal,O=o.SharedFolderActivityLogger,S=r.AVATAR_DIMENSION_BY_SIZE,A=c.DBModalStack,F=_.SharedWithView,U=m.SharingApi,G=y._,$=y.ungettext,I=w.EmailVerification,Y=C.nice_date_with_month_name,K=n.DOM,z=n.createElement,R=5,E=S.SMALL,q="south",x="--",N="file_row_sharing_menu",P=100,W={PUBLIC:1,TEAM_ONLY:2,PASSWORD:3},D=function(){function t(t){this.render_callback=t.render_callback,this.max_visible_avatars=t.max_visible_avatars,this._load_next_shared_link_info=e(this._load_next_shared_link_info,this),this._load_all_sf_info=e(this._load_all_sf_info,this),this._sf_info_stale=e(this._sf_info_stale,this),this._exists_unloaded_sf=e(this._exists_unloaded_sf,this),this._load_sf_info_if_missing=e(this._load_sf_info_if_missing,this),this.preload=e(this.preload,this),this.loading_sf_info=!1,this.loading_link_info=!1,this.loaded_sf_info=!1,this.ns_to_props={},this.shared_link_maps_by_folder={},this.looked_up_files_in_curr_dir={}}return t.prototype.preload=function(){return null!=T.inside_root_folder&&T.inside_root_folder||""===window.encodedpath?this._load_all_sf_info():void 0},t.prototype.get_props_for_file=function(e){var t,n,i,o;return n=null,null!=e.target_ns&&(n=this.ns_to_props[e.target_ns]),t=T.containing_fq_path(),o=this.shared_link_maps_by_folder[t],o&&(i=o[this._shared_link_key(e)],i?(n||(n={user:T.active_user}),n.sharedLinkInfo=i):null!=n&&delete n.sharedLinkInfo),n},t.prototype.ready_for_render=function(){var e;return this._in_directory_with_shared_folders()&&!this.loaded_sf_info?!1:(e=T.containing_fq_path(),!e in this.shared_link_maps_by_folder?!1:!0)},t.prototype.load_missing_info=function(){return this._load_sf_info_if_missing(),this._load_shared_link_info_if_missing()},t.prototype.load_all_info=function(){return this._load_all_sf_info(),this._load_all_shared_link_info()},t.prototype.load_on_update=function(){return this._load_sf_info_if_missing(),this._load_all_shared_link_info()},t.prototype.load_on_link_remove=function(){var e;return e=T.containing_fq_path(),this.shared_link_maps_by_folder[e]={},this._load_all_shared_link_info()},t.prototype._load_sf_info_if_missing=function(){return this._in_directory_with_shared_folders()&&(this._exists_unloaded_sf()||this._sf_info_stale())?this._load_all_sf_info():void 0},t.prototype._in_directory_with_shared_folders=function(){var e,t,n,i;if(!T.inside_dir)return!1;for(i=T.files,t=0,n=i.length;n>t;t++)if(e=i[t],parseInt(e.target_ns))return!0;return!1},t.prototype._exists_unloaded_sf=function(){var e,t,n,i;for(i=T.files,t=0,n=i.length;n>t;t++)if(e=i[t],parseInt(e.target_ns)&&null==this.ns_to_props[e.target_ns])return!0;return!1},t.prototype._sf_info_stale=function(){var e,t,n,i,o,s;for(s=!T.inside_shared_folder,i=T.files,t=0,n=i.length;n>t;t++)if(e=i[t],parseInt(e.target_ns)&&null!=(null!=(o=this.ns_to_props[e.target_ns])?o.includeInherited:void 0)==!s)return this.loaded_sf_info=!1,!0;return!1},t.prototype._load_all_sf_info=function(){return null==T.active_user||this.loading_sf_info?void 0:(this.loading_sf_info=!0,i.WebRequest({url:"/share_ajax/shared_with",dataType:"json",subject_user:T.active_user,data:{max_results:this.max_visible_avatars,fq_path_prefix:T.containing_fq_path(),include_inherited:!T.inside_shared_folder},success:function(e){return function(t){var n,i,o,s,r;for(r={},n=0,i=t.length;i>n;n++)s=t[n],o={user:T.active_user,numUndisplayableUsersAndInvites:s.num_avatars_not_shown,groups:s.groups,invitations:s.invitations,joinedMembers:s.joined_members,includeInherited:!T.inside_shared_folder},r[s.ns_id]=o;return e.ns_to_props=r,e.loading_sf_info=!1,e.loaded_sf_info=!0,e.render_callback()}}(this)}))},t.prototype._shared_link_key=function(e){return e.fq_path+"_"+e.to_key()},t.prototype._load_shared_link_info_if_missing=function(){return this.loading_link_info?void 0:this._load_next_shared_link_info()},t.prototype._load_all_shared_link_info=function(){return this.looked_up_files_in_curr_dir={},this._load_next_shared_link_info()},t.prototype._load_next_shared_link_info=function(e){var t,n,o,s,r;if(null==e&&(e=null),this.loading_link_info=!1,!(T.in_search_mode()||e&&e!==T.containing_fq_path())){for(null===e&&(e=T.containing_fq_path()),n=[],r=T.files,o=0,s=r.length;s>o&&(t=r[o],t.fq_path in this.looked_up_files_in_curr_dir||(n.push(t.fq_path),this.looked_up_files_in_curr_dir[t.fq_path]=!0,n.length!==P));o++);if(0!==n.length)return this.loading_link_info=!0,i.SilentBackgroundRequest({url:"/sm/get_token_info",dataType:"json",data:{paths:JSON.stringify(n)},subject_user:T.active_user.id,success:function(t){return function(n){var i,o,s,r,a,l;for(a=t.shared_link_maps_by_folder[e]||{},r=n.shmodels,o=0,s=r.length;s>o;o++)l=r[o],l.disabled||(i=T.find_file(l.path),null!=i&&(a[t._shared_link_key(i)]=l));return t.shared_link_maps_by_folder[e]=a,t.render_callback(),t._load_next_shared_link_info(e)}}(this)})}},t}(),M=function(){function t(t,n){this.shared_link_image_static_url_map=n,this._render_all=e(this._render_all,this),this._sharing_api_request_handler=e(this._sharing_api_request_handler,this),this._browse_link_remove_handler=e(this._browse_link_remove_handler,this),this._browse_update_handler=e(this._browse_update_handler,this),this._browse_add_handler=e(this._browse_add_handler,this),this._browse_rename_handler=e(this._browse_rename_handler,this),this._browse_render_handler=e(this._browse_render_handler,this),this._open_shared_folder_options_modal=e(this._open_shared_folder_options_modal,this),this._wrap_avatar_click_handler_with_fq_path=e(this._wrap_avatar_click_handler_with_fq_path,this),this._wrap_handler_with_fq_path=e(this._wrap_handler_with_fq_path,this),this.overflow_click_handler=e(this.overflow_click_handler,this),this.avatar_click_handler=e(this.avatar_click_handler,this),this.shared_link_avatar_click_handler=e(this.shared_link_avatar_click_handler,this),this.cached_loader=new D({render_callback:this._render_all,max_visible_avatars:R}),this.first_render=!0,this.rendered_element_by_file_key={},$j(document).on(a.RENDER,this._browse_render_handler),$j(document).on(j.ADD,this._browse_add_handler),$j(document).on(a.UPDATE,this._browse_update_handler),$j(document).on(U.REQUEST_SUCCEEDED_EVENT,this._sharing_api_request_handler),$j(document).on(d.RENAME,this._browse_rename_handler),$j(document).on(a.NEW_PAGE,this._browse_add_handler),$j(document).on(d.LINKS_REMOVE,this._browse_link_remove_handler),setTimeout(this.cached_loader.preload,50)}return t.prototype.shared_link_avatar_click_handler=function(e){var t,n,i;return n=e.path,i=T.active_user,I.get_for_user(i).verified_or_show()?(t=T.find_file(n),V.shmodel(n,N)):void 0},t.prototype.avatar_click_handler=function(e){return this._open_shared_folder_options_modal(e)},t.prototype.overflow_click_handler=function(e){return this._open_shared_folder_options_modal(e)},t.prototype._wrap_handler_with_fq_path=function(e,t){var n;return n=t.fq_path,function(){return function(){return e(n)}}(this)},t.prototype._wrap_avatar_click_handler_with_fq_path=function(e){var t;return t=e.fq_path,function(e){return function(n,i){return e.avatar_click_handler(t,n,i)}}(this)},t.prototype._open_shared_folder_options_modal=function(e){var t,n;return n=T.active_user,I.get_for_user(n).verified_or_show()?(t=new k(n,e),t.show()):void 0},t.prototype._browse_render_handler=function(){return this.rendered_element_by_file_key={},setTimeout(this._render_all,20)},t.prototype._browse_rename_handler=function(){return setTimeout(this._render_all,1e3)},t.prototype._browse_add_handler=function(){return this.cached_loader.load_missing_info()},t.prototype._browse_update_handler=function(){return T.in_search_mode()?void $j("#browse-box").removeClass("show-shared-with"):(this.rendered_element_by_file_key={},$j("#browse-box").addClass("show-shared-with"),this.cached_loader.load_on_update())},t.prototype._browse_link_remove_handler=function(){return this.cached_loader.load_on_link_remove()},t.prototype._sharing_api_request_handler=function(e,t){var n;return n=t.request_url,n.indexOf("/share_ajax/leave")>-1||n.indexOf("/share_ajax/unshare")>-1?void 0:this.cached_loader.load_all_info()},t.prototype._are_props_equal=function(e,t){var n,i,o,s;for(s=["sharedLinkInfo","user","numUndisplayableUsersAndInvites","groups","invitations","joinedMembers"],i=0,o=s.length;o>i;i++)if(n=s[i],e[n]!==t[n])return!1;return!0},t.prototype._render_all=function(){var e,t,i,o,s,r,a,l,c,u,d;if(this.cached_loader.ready_for_render()){for(e=this.first_render,this.first_render=!1,l=T.files,u=[],o=0,s=l.length;s>o;o++){if(i=l[o],r=this.cached_loader.get_props_for_file(i),d=i.is_deleted?G("deleted"):r?null:x,c=this.rendered_element_by_file_key[i.to_key()],null!=c){if(null!=d&&c.text_display===d)continue;if(null!=c.react_comp&&null!=r&&(a=c.react_comp,a.isMounted()&&this._are_props_equal(a.props,r)))continue}t=$j(i.get_div()).find(".sharing .sharers"),t.length?null!=d?(t.text(d),u.push(this.rendered_element_by_file_key[i.to_key()]={text_display:d})):(r.animation=e,r.onOverflowCountClick=this._wrap_handler_with_fq_path(this.overflow_click_handler,i),r.onAvatarClick=this._wrap_avatar_click_handler_with_fq_path(i),r.onSharedLinkClick=this.shared_link_avatar_click_handler,a=n.render(new F(r),t[0]),u.push(this.rendered_element_by_file_key[i.to_key()]={react_comp:a})):u.push(void 0)}return u}},t}()})}.call(this),function(){define("modules/dirty/home",["jquery","dropbox","modules/clean/account/email","modules/clean/analytics","modules/clean/browse_events","modules/clean/payments/pro_trial_onboarding_tour","modules/clean/teams/trial_buy_now","modules/clean/viewer","modules/dirty/sharing/sharing_growth_email_experiments"],function(e,t,n,i,o,s,r,a,l){var c,u,d,p,h,_;return c=t.Browse,d=t.FileOps,_=t.SharingModals,u=n.EmailVerification,h=i.SharedFolderActivityLogger,p={init:function(t){var n,i,o;return t.show_email_just_verified?u.getForRole(t.role).show_verified_modal():t.show_email_just_verified_and_changed?u.getForRole(t.role).show_verified_and_changed_modal():t.show_sent_verification_email?u.getForRole(t.role).show_sent_modal():t.show_upload?(i=function(){var e;return t.email_src&&(e={ns_id:c.containing_ns_id(),email_src:t.email_src},h.log("web","show_upload_modal_for_sf_from_email",c.active_user,e),l.listen_for_first_upload(c.active_user,e)),d.show_upload.bind(d)()},p._call_when_browse_ready(i)):t.show_share_existing_modal?(t.email_src&&(n={email_src:t.email_src},h.log("web","show_share_existing_folder_modal_from_email",c.active_user,n)),_.show_share_existing_modal(t.fq_path,c.active_user)):t.show_share_options&&!t.share_subfolder?(o=a.get_viewer().get_user_by_role(t.role),o||(o=a.get_viewer().get_users()[0]),_.show_shared_folder_options_modal(t.fq_path,o)):t.show_share_options&&t.share_subfolder?(o=a.get_viewer().get_user_by_role(t.role),o||(o=a.get_viewer().get_users()[0]),_.show_shared_subfolder_modal(t.fq_path,o)):t.show_pro_trial_modal?s.ProTrialOnboardingTour.show("trial_start"):t.remaining_trial_days?r.showModal(t.remaining_trial_days):t.show_upsell_modal?e("#db-modal-upsell-home-modal").addClass("show-upsell-modal").trigger("show-upsell-modal"):void 0},_call_when_browse_ready:function(e){var t;return c.first_load?(t=function(){return document.stopObserving(o.UPDATE,t),e()},document.observe(o.UPDATE,t)):e()}}})}.call(this),function(){var e=[].slice;define("modules/dirty/react/file_comments/file_viewer_feedback_ui",["jquery","external/react","modules/constants/python","modules/clean/activity/activity","modules/clean/activity/file_activity_cache","modules/clean/file_activity/api","modules/clean/file_events","modules/clean/gandalf_util","modules/clean/previews/preview_actions_helper","modules/clean/react/file_comments/file_feedback_ui","modules/clean/viewer","modules/core/notify"],function(t,n,i,o,s,r,a,l,c,u,d,p){var h,_,m,f,v,g,y;return h=o.ActivityContext,v=c.LegacyFileViewerActions,m=u.FileFeedbackUIClass,g=n.DOM,_=n.createFactory(m),y=d.get_viewer(),f=n.createClass({displayName:"FileViewerFeedbackUI",propTypes:{shouldShowOnboarding:n.PropTypes.bool},getDefaultProps:function(){return{shouldShowOnboarding:!1}},getInitialState:function(){return this.setCommentsVisibility(!0),this._enabledPreload=l.getGandalfRule("comments_preload"),this._enabledPreload&&(this._activityCache=new s),{shouldShowOnboarding:this.props.shouldShowOnboarding}},componentDidMount:function(){var e;return t("#file-viewer").on("db:filepreview:open db:filepreview:fileinfo",function(e){return function(n,i,o,s,r,a,l,c){return t("#file-viewer").addClass("comments"),clearTimeout(e.feedbackLoadTimer),e.feedbackLoadTimer=setTimeout(function(){
return e._setFile(i,o,s,!1,c,r,l)},10)}}(this)),t("#file-viewer").trigger("db:commenting:init"),t("#file-viewer").on("db:filepreview:prev db:filepreview:next",function(e){return function(t,n,i,o,s){var r,a;return r=null!=(a=e.refs.fileFeedback)?a.resetToBlankState():void 0,clearTimeout(e.feedbackLoadTimer),e.feedbackLoadTimer=setTimeout(function(){return e._setFile(n,i,o,!r,s)},250)}}(this)),t("#file-viewer").on("db:filepreview:close",function(e){return function(){var t;return null!=(t=e.refs.fileFeedback)&&t.close(),e.setState({activityContext:null,activityContextData:null})}}(this)),e=function(e){return function(){return t("#file-viewer").addClass("comments"),e.autoResize()}}(this),t("#file-viewer").on("preview_failed",e),t(window).resize(function(e){return function(){return e.autoResize()}}(this))},onActivityLoaded:function(e){return t(document).trigger(a.FILE_ACTIVITY_UPDATE,[this.state.file,e])},onOnboardingModalOpen:function(){return this.setState({shouldShowOnboarding:!1}),r.sawCommentOnboarding(this.state.viewingUserId)},_getContextAndContextDataFromFile:function(e,t){var n,o;return t===i.FileViewTargetType.SHARED_LINK?(n=h.SHARED_LINK_VIEW,o=e.href):t===i.FileViewTargetType.SHARED_CONTENT_LINK?(n=h.SHARED_CONTENT_LINK_VIEW,o=e.href):(n=h.BROWSE_FILE_VIEWER,o=e.fq_path),[n,o]},_preloadActivities:function(e,t,n,i){var o,s,r,a,l,c,u,d;if(this._enabledPreload){for(s=[],a=[],u=t.map(function(e){return function(t){return e._getContextAndContextDataFromFile(t,n)}}(this)),l=0,c=u.length;c>l;l++)d=u[l],o=d[0],r=d[1],s.push(o),a.push(r);return this._activityCache.fetchActivities(e,s[0],a,i)}},_setFile:function(e,t,n,o,s,r,a){var l,c,u,d;return null==o&&(o=!1),null==s&&(s=[]),null==r&&(r=!1),null==a&&(a=i.OREF_CONSTANTS.BROWSE_UNKNOWN),d=this._getContextAndContextDataFromFile(e,t),l=d[0],c=d[1],l===h.SHARED_LINK_VIEW&&(n=y.work_user||y.personal_user?(y.work_user||y.personal_user).id:void 0),u={activityContext:l,activityContextData:c,file:e,key:e.ns_id+"_"+e.sjid,viewingUserId:n,forceNullStateLoadingState:o,shouldInitiallyFocusInput:r,oref:a},this._preloadActivities(n,s,t,a),this.setState(u,function(e){return function(){return e.autoResize()}}(this))},_switchPreview:function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],require(["dropbox"],function(e){var n;return n=e.FileViewer,n.switch_preview.apply(n,t)},function(){return p.error(p.DEFAULT_ERROR)})},render:function(){return g.div({},_({ref:"fileFeedback",activityContext:this.state.activityContext,activityContextData:this.state.activityContextData,onActivityLoaded:this.onActivityLoaded,feedbackId:"file-comments",previewWidthCallback:this.setPreviewWidth,showButtonColor:"white",userId:this.state.viewingUserId,key:this.state.key,visible:this._commentsVisible,hideToggledCallback:this.setCommentsVisibility,previewSelector:"#file-viewer-container .preview .preview-content-container",forceNullStateLoadingState:this.state.forceNullStateLoadingState,shouldInitiallyFocusInput:this.state.shouldInitiallyFocusInput,oref:this.state.oref,file:this.state.file,activityCache:this._activityCache,switchPreview:this._switchPreview,shouldShowOnboarding:this.state.shouldShowOnboarding,onOnboardingModalOpen:this.onOnboardingModalOpen}))},setCommentsVisibility:function(e){return this._commentsVisible=e},autoResize:function(){return this.autoResizeWidth(),this.autoResizeHeight()},autoResizeWidth:function(){var e;return this.setPreviewWidth(t(null!=(e=this.refs.fileFeedback)?e.getDOMNode():void 0).width())},autoResizeHeight:function(){var e,n;return e=t("#file-viewer").hasClass("no-preview")?t(window).height():t("#file-viewer-container").height()-t("#file-viewer-container .title-bar").height(),null!=(n=this.refs.fileFeedback)?n.fitToHeight(e):void 0},setPreviewWidth:function(e){var n,i,o,s,r,a;return n=t("#file-viewer"),i=n.find("#file-viewer-container"),s=i.find(".preview"),0!==s.length?(n.hasClass("no-preview")?(a=i.width()-e,r=e?(t(window).width()-e)/2+"px":t(window).width()/2+"px"):n.hasClass("doc-preview")||n.hasClass("html-preview")||n.hasClass("htmlified-preview")||n.hasClass("adobecs-preview")||n.hasClass("linkfile-preview")||n.hasClass("photo-preview")||n.hasClass("video-preview")?(a=v.isFullscreen()?window.innerWidth:i.width()-e,r="0"):(a=i.width()-e,r="50%"),s.width()!==a&&(s.width(a),o=i.find(".loading"),null!=o&&o.width(a)),s.css("left")!==r?i.css("left",r):void 0):void 0}}),{FileViewerFeedbackUI:f}})}.call(this),function(){define("modules/dirty/react/file_viewer/controller",["external/react","modules/constants/python","modules/clean/activity/activity","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/file_viewer","modules/dirty/react/file_viewer/share_helpers"],function(e,t,n,i,o,s){var r,a,l,c,u;return a=t.FileViewModeType,l=t.FileViewTargetType,r=n.ActivityContext,c=e.createFactory(o),u={fileViewer:null,targetElementId:"",_onClose:null,open:function(t,n,o,a,u){var d,p;return this.targetElementId=a,this.isShown()?void 0:(u.fileViewTarget===l.SHARED_LINK?u.activityContext=r.SHARED_LINK_VIEW:u.fileViewTarget===l.SHARED_CONTENT_LINK?u.activityContext=r.SHARED_CONTENT_LINK_VIEW:(u.activityContext=r.BROWSE_FILE_VIEWER,u.shareHelpers=s),null!=o&&(this._onClose=u.onCloseViewer,u.onCloseViewer=this.close.bind(this)),i.setup(t,n,o),d=c(u),p=document.getElementById(this.targetElementId),this.fileViewer=e.render(d,p))},updateFiles:function(e){return this.isShown()?i.updateFiles(e):void 0},close:function(){var t;return this.isShown()?(t=document.getElementById(this.targetElementId),e.unmountComponentAtNode(t),i.cleanup(),this.fileViewer=null,"function"==typeof this._onClose?this._onClose():void 0):void 0},isShown:function(){return null!=this.fileViewer}}})}.call(this),function(){define("modules/dirty/react/file_viewer/share_helpers",["modules/core/notify","modules/clean/ajax","modules/clean/filepath"],function(e,t,n){var i,o;return o=function(t){return require(["dropbox"],t,function(){return e.error(e.DEFAULT_ERROR)})},i={fetchTkey:function(e,n,i){return t.WebRequest({url:"/sm/get_token",type:"POST",data:{path:e},dataType:"json",subject_user:n,success:function(e){return i(e.tkey)}})},share:function(e,t){return o(function(n){var i;return i=n.ShareLinkModal,new i(t,e,"file_viewer").show()})},removeShareLink:function(e,t,i,s){return o(function(o){var r,a;return r=o.SharingModel,a=n.filename(e),r.confirm_remove(a,t,0,0,0,i,0,0,0,s)})}}})}.call(this),function(){define("modules/dirty/react/previews/preview_toolbar",["jquery","external/underscore","external/react","modules/core/notify","modules/clean/filepath","modules/clean/previews/preview_actions_helper","modules/clean/react/previews/preview_toolbar","modules/core/exception"],function(e,t,n,i,o,s,r,a){var l,c,u,d,p,h,_,m,f;return c=s.LegacyFileViewerActions,l=s.LegacyFilePreviewActions,h=r.ReactPreviewToolbarClass,d=r.PreviewToolbarDocType,m=a.assert,p=n.createFactory(h),f=function(e){return require(["dropbox"],e,function(){return i.error(i.DEFAULT_ERROR)})},_={FILE_VIEWER:"FILE_VIEWER",FILE_PREVIEW:"FILE_PREVIEW"},u=n.createClass({displayName:"PreviewToolbar",propTypes:{"viewer-type":n.PropTypes.oneOf(t.values(_)).isRequired},getInitialState:function(){var e;return this.props["viewer-type"]===_.FILE_VIEWER?e=c:this.props["viewer-type"]===_.FILE_PREVIEW&&(e=l),{actions:e,fileDocPreviewStatus:null,fileExtension:null,fileHref:null,filePreviewType:null,pdfLink:null}},componentDidMount:function(){return this._listenForFileEvents()},componentDidUpdate:function(){var t,n,i,o;return this.props["viewer-type"]===_.FILE_VIEWER&&(t=e("#file-viewer"),1===t.length&&(t.on("db:filepreview:open",null!=(n=this.refs.reactPreviewToolbar)?n.onPreviewOpen:void 0),t.on("db:filepreview:close",null!=(i=this.refs.reactPreviewToolbar)?i.onPreviewClose:void 0))),null!=(o=this.refs.reactPreviewToolbar)?o.onPreviewOpen():void 0},componentWillUnmount:function(){var t,n,i,o;if(this.props["viewer-type"]===_.FILE_VIEWER){if(t=e("#file-viewer"),1===t.length)return t.off("db:filepreview:open",null!=(n=this.refs.reactPreviewToolbar)?n.onPreviewOpen:void 0),t.off("db:filepreview:close",null!=(i=this.refs.reactPreviewToolbar)?i.onPreviewClose:void 0)}else if(this.props["viewer-type"]===_.FILE_PREVIEW)return null!=(o=this.refs.reactPreviewToolbar)?o.onPreviewClose:void 0},_listenForFileEvents:function(){return this.props["viewer-type"]===_.FILE_VIEWER?e("#file-viewer").on("db:filepreview:open",function(e){return function(t,n){return null!=n.fq_path?e.setState({fileDocPreviewStatus:n.doc_preview_status,fileExtension:o.file_extension_for_logging(n.fq_path),fileHref:n.href,filePreviewType:n.preview_type}):void 0}}(this)):this.props["viewer-type"]===_.FILE_PREVIEW?this.state.actions.getEmbedContainer().on("previewrendered",function(e){return function(){return f(function(t){var n,i;return n=t.FilePreview,i=t.SharingModel,e.setState({pdfLink:n.pdfLink,fileExtension:o.file_extension_for_logging(i.filename)})})}}(this)):void 0},_onAfterFileViewerExit:function(){return f(function(e){var t;return t=e.FileViewer,t.hide()})},render:function(){var e;return this.state.fileExtension?(e=null,this.props["viewer-type"]===_.FILE_VIEWER&&(e=this._onAfterFileViewerExit),p({ref:"reactPreviewToolbar",actions:this.state.actions,fileExtension:this.state.fileExtension,afterFileViewerExit:e,pdfLink:this.state.pdfLink,fileDocPreviewStatus:this.state.fileDocPreviewStatus,fileHref:this.state.fileHref,filePreviewType:this.state.filePreviewType})):null}}),{PreviewToolbar:u,ViewerTypes:_}})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/search/search_bar",["jquery","external/underscore","external/modernizr","modules/core/exception","modules/core/i18n","modules/core/browser","modules/core/notify","modules/clean/ajax","modules/clean/analytics","modules/clean/browse_events","modules/clean/filepath","modules/clean/gandalf_util","modules/clean/keycode","modules/clean/page_role_observer","modules/clean/search/search_helpers","modules/clean/search/search_type","modules/clean/viewer","modules/constants/python","modules/constants/viewer"],function(t,n,i,o,s,r,a,l,c,u,d,p,h,_,m,f,v,g,y){var b,w,C,E,S,T;return T=o.assert,S=s._,E=c.SearchClientActivityLogger,b=y.ROLE_PERSONAL,w=y.ROLE_WORK,C=function(){function o(n,i,s,r){this.user_id=i,this.origin=s,null==r&&(r={}),this._focusDropdownRow=e(this._focusDropdownRow,this),this._unfocusDropdownRow=e(this._unfocusDropdownRow,this),this._getDropdownRow=e(this._getDropdownRow,this),this._hasDropdownRowAtIndex=e(this._hasDropdownRowAtIndex,this),this._getDropdownRowCount=e(this._getDropdownRowCount,this),this._isSearchBarVisible=e(this._isSearchBarVisible,this),this._fileForKey=e(this._fileForKey,this),this._keyForDropdownIndex=e(this._keyForDropdownIndex,this),this._runSearch=e(this._runSearch,this),this._openSuggestionByFileKey=e(this._openSuggestionByFileKey,this),this._suggestionClicked=e(this._suggestionClicked,this),this._buildSuggestion=e(this._buildSuggestion,this),this._getDropdownRowFocuser=e(this._getDropdownRowFocuser,this),this._displaySuggestions=e(this._displaySuggestions,this),this._hideSuggestions=e(this._hideSuggestions,this),this._showSuggestions=e(this._showSuggestions,this),this._gatherSuggestions=e(this._gatherSuggestions,this),this._searchInputUpdate=e(this._searchInputUpdate,this),this._trackKeyDownInSearchBar=e(this._trackKeyDownInSearchBar,this),this._searchBarUnFocused=e(this._searchBarUnFocused,this),this._searchBarFocused=e(this._searchBarFocused,this),this.blur=e(this.blur,this),this.focus=e(this.focus,this),this._on_role_change=e(this._on_role_change,this),this._on_browse_update=e(this._on_browse_update,this),this._on_window_blur=e(this._on_window_blur,this),this._on_window_focus=e(this._on_window_focus,this),this._debug_log=e(this._debug_log,this),this.$search_bar_holder=t(n),this.$search_bar=this.$search_bar_holder.find("#browse-search-input input"),this.$search_button=this.$search_bar_holder.find("#search-button"),this.$suggestion_list_holder=this.$search_bar_holder.find("#browse-search-suggested-list"),this.$suggestion_list=this.$suggestion_list_holder.find(".search-results"),this.$search_text=this.$suggestion_list_holder.find(".search-text"),this.$search_loading=this.$suggestion_list_holder.find("#search-loading"),this._prev_search_val="",this._prev_search_scope="",this._focused_dropdown_row=-1,this._window_blurred=!1,this._fq_path="",this._debug=!1,this._is_transitioning=!1,t(window).on("blur",this._on_window_blur),t(window).on("focus",this._on_window_focus),t(document).on(u.UPDATE,this._on_browse_update),_.addListener(this._on_role_change),this.$search_bar_holder.on("submit",function(e){return e.preventDefault()}),this.$search_bar.on("focus",function(e){return function(){return e._debug_log("input-focus"),setTimeout(function(){return e._searchBarFocused()},0)}}(this)),this.$search_bar.on("blur",function(e){return function(){return e._debug_log("input-blur"),setTimeout(function(){return e._searchBarUnFocused()},0)}}(this)),this.$search_bar.on("keydown",this._trackKeyDownInSearchBar),this.$search_button.on("click",this._runSearch),this.$search_text.on("mousedown",this._runSearch),this.$search_text.on("mousemove",this._getDropdownRowFocuser(0)),this._hideSuggestions(),this.$search_loading.hide(),r.listen_for_search_events===!0&&t(document).on(o.FOCUS_SEARCH_EVENT,this.focus)}return o.FOCUS_SEARCH_EVENT="db:searchbar:focus",o.SUBMIT_SEARCH_EVENT="db:searchbar:submit",o.PREVIEW_SEARCH_EVENT="db:searchbar:preview",o.prototype._files={},o.prototype.teardown=function(){return t(document).off(o.FOCUS_SEARCH_EVENT,this.focus),t(document).off(u.UPDATE,this._on_browse_update),t(window).off("blur",this._on_window_blur),t(window).off("focus",this._on_window_focus),_.removeListener(this._on_role_change)},o.prototype._debug_log=function(e){return this._debug?console.log("SearchBar: "+e):void 0},o.prototype._on_window_focus=function(){return this._window_blurred=!1},o.prototype._on_window_blur=function(){return this._window_blurred=!0},o.prototype._on_browse_update=function(e,t){return this._fq_path=(null!=t?t.containing_fq_path:void 0)||""},o.prototype._on_role_change=function(e){var t;return this.$search_bar.val(""),this._searchInputUpdate(),t=v.get_viewer(),this.user_id=t.get_user_by_role(e).id},o.prototype.focus=function(){return this.$search_bar.trigger("focus"),this._searchBarFocused(!0)},o.prototype.blur=function(){return this.$search_bar.trigger("blur"),this._searchBarUnFocused(!0)},o.prototype.previewFile=function(e,n){var i,s,l;return null==n&&(n=!1),l=v.get_viewer().get_user_by_id(this.user_id),s=this.origin,p.getGandalfRule("file-viewer-react")&&!e.is_dir?void require(["modules/dirty/react/file_viewer/controller"],function(t){return t.open([e],0,l,"react-file-viewer",{disableRouting:!0,oref:g.OREF_CONSTANTS.BROWSE_SEARCHBOX,fileViewTarget:g.FileViewTargetType.PRIVATE,fileViewOrigin:s,fileViewAction:g.FileViewActionType.SEARCH})},function(){return a.error(a.DEFAULT_ERROR)}):(i=t.Event(o.PREVIEW_SEARCH_EVENT),this.$search_bar.trigger(i,[{file:e,force_new_window:n}]),i.isDefaultPrevented()?void 0:n===!0?r.open_tab(e.href):e.dir?r.redirect(e.href):require(["dropbox"],function(t){var n;return n=t.FileViewer,n.show(e,l,{},g.OREF_CONSTANTS.BROWSE_SEARCHBOX)},function(){return a.error(a.DEFAULT_ERROR)}))},o.prototype._scopedSearch=function(){return""!==this._fq_path},o.prototype._searchBarFocused=function(e){return null==e&&(e=!1),this._debug_log("unfocus, winblur="+this._window_blurred.toString()),!e&&this._window_blurred||this.$search_bar.hasClass("focused")?void 0:(this.$search_bar_holder.addClass("focused"),this.$search_bar.addClass("focused"),this._is_transitioning=!0,this._callAfterTransition(function(e){return function(){return e._is_transitioning=!1}}(this)),this._searchInputUpdate())},o.prototype._searchBarUnFocused=function(e){return null==e&&(e=!1),this._debug_log("unfocus, winblur="+this._window_blurred.toString()),!e&&this._window_blurred||!this.$search_bar.hasClass("focused")?void 0:(this.$search_bar.removeClass("focused"),this.$search_bar_holder.removeClass("focused"),this._hideSuggestions())},o.prototype._trackKeyDownInSearchBar=function(e){switch(e.keyCode){case h.ESC:return this._onEscKey(e);case h.ENTER:return this._onEnterKey(e);case h.UP:return this._onUpKey(e);case h.DOWN:return this._onDownKey(e);case h.LEFT:case h.RIGHT:break;default:return clearTimeout(this.search_key_up_timer),this.search_key_up_timer=setTimeout(function(e){return function(){return e._searchInputUpdate(!0)}}(this),100)}},o.prototype._onEscKey=function(){return this.blur()},o.prototype._onEnterKey=function(){return 0===this._focused_dropdown_row||-1===this._focused_dropdown_row?this._runSearch():this._openSuggestionByFileKey(this._keyForDropdownIndex(this._focused_dropdown_row),!1)},o.prototype._onUpKey=function(e){return this._isSearchBarVisible()?(this._focusDropdownRow(Math.max(0,this._focused_dropdown_row-1)),e.preventDefault()):void 0},o.prototype._onDownKey=function(e){return this._isSearchBarVisible()?(this._focusDropdownRow(Math.min(this._getDropdownRowCount()-1,this._focused_dropdown_row+1)),e.preventDefault()):this._searchInputUpdate()},o.prototype._searchInputUpdate=function(){var e,t,i,o,s,r;return s=this.$search_bar.val(),""===s?(this.$search_text.html(""),this.$search_bar_holder.removeClass("active"),this._hideSuggestions(),this.$search_text.html(""),this.$suggestion_list.html(""),this._prev_search_val="",this._prev_search_scope=""):(this.$search_bar_holder.addClass("active"),this._showSuggestions(),r=v.get_viewer().get_user_by_id(this.user_id),i=v.get_root_name(r),e=S("Search for ‘%(res)s’ in %(root)s").format({res:'<span class="search-val-text">'+n.escape(s)+"</span>",root:n.escape(i)}),this._scopedSearch()&&(t=d.filename(this._fq_path),e=S("Search for ‘%(res)s’ in %(path)s").format({res:'<span class="search-val-text">'+n.escape(s)+"</span>",path:"<span>"+n.escape(t)+"</span>"})),o='<span class="dropdown-top-text">'+e+"</span>",this.$search_text.html(o),this._gatherSuggestions())},o.prototype._gatherSuggestions=function(){var e,t,n,i;if(n=this.$search_bar.val(),this._prev_search_val===n){if(this._scopedSearch()&&this._prev_search_scope===this._fq_path)return;if(""===this._prev_search_scope)return}return this.$suggestion_list.html(""),e={query:n,filename_only:!0,max_results:8},this._scopedSearch()?(e.fq_path=this._fq_path,this._prev_search_scope=this._fq_path):this._prev_search_scope="",this._prev_search_val=n,this.$search_loading.show(),t={firefly:!0,path_scoped:!1,search_type:f.COMPLETION,query_string:n},E.log("query_started",this.user_id,t),i=(new Date).getTime(),l.WebRequest({url:"/ajax_fulltext_search",data:e,subject_user:this.user_id,success:function(e){return function(o,s,r){var a,l;return e.$search_loading.hide(),l=r.getResponseHeader("x-dropbox-request-id"),o=JSON.parse(o),a=o.file_info.length>0?o.file_info[0]:null,t=E.create_completion_log_dict(t,l,i,n,n===e.$search_bar.val(),o.file_info.length,null,a),E.log("query_completed",e.user_id,t),n===e.$search_bar.val()?e._displaySuggestions(o,l):void 0}}(this),error:function(e){return function(n,o){var s;return e.$search_loading.hide(),s=n.getResponseHeader("x-dropbox-request-id"),t=E.create_completion_log_dict(t,s,i,null,null,null,o),E.log("query_failed",e.user_id,t)}}(this)})},o.prototype._showSuggestions=function(){return this._callAfterTransition(function(e){return function(){return e.$search_bar.hasClass("focused")?(e.$suggestion_list_holder.show(),e._focusDropdownRow(0)):void 0}}(this))},o.prototype._hideSuggestions=function(){return this.$suggestion_list_holder.hide()},o.prototype._displaySuggestions=function(e,t){var n,i,o,s,r,a,l,c;for(null==t&&(t=null),i=e.file_info,this._files={},l=[],a=i.slice(0,8),s=o=0,r=a.length;r>o;s=++o)n=a[s],c=this._buildSuggestion(n),c.on("mousemove",this._getDropdownRowFocuser(s+1)),l.push(c),this._files[this._keyForFile(n)]=this._createBrowseFileShim(n,t);return this.$suggestion_list.html(l),this.$suggestion_list_holder.addClass("ie8hax").removeClass("ie8hax")},o.prototype._getDropdownRowFocuser=function(e){return function(t){return function(){return t._focusDropdownRow(e)}}(this)},o.prototype._buildSuggestion=function(e){var n,i,o,s,r,a,l;return l=e.fq_path.split("/"),r=l.slice(-1)[0],i=m.highlightMatch(r,e.filename_highlights).addClass("file-name"),a=2===l.length?"/":l.slice(0,-1).join("/"),o=t("<span class='file-path'><span class='file-path-in' /><span class='file-location' /></span>"),o.find(".file-path-in").text(S("in ")),o.find(".file-location").text(a),n=t("<img class='sprite sprite_web icon s_web_"+e.icon+"' src='/static/images/icons/icon_spacer-vflN3BYt2.gif'/>"),s=t('<div class="search-item clearfix"/>').append(o.prepend(n,i)),s.attr("data-identity",this._keyForFile(e)),s.data("suggestion-href",e.href),s.on("mousedown",this._suggestionClicked),s},o.prototype._suggestionClicked=function(e){var t,n;return t=1,n=e.metaKey||e.button===t,this._openSuggestionByFileKey(this._keyForElement(e.target),n),this._searchBarUnFocused(!0)},o.prototype._openSuggestionByFileKey=function(e,t){var n;return n=this._fileForKey(e),this.previewFile(n,t),this._hideSuggestions()},o.prototype._runSearch=function(){var e,i,s;return clearTimeout(this.search_key_up_timer),e=t.Event(o.SUBMIT_SEARCH_EVENT),this.$search_bar.trigger(e),!e.isDefaultPrevented()&&t.trim(this.$search_bar.val())?(s=v.get_viewer().get_user_by_id(this.user_id),i=m.buildSearchURL(s,this.$search_bar.val(),this._fq_path),this.$search_bar_holder.removeClass("active").addClass("loading"),n.defer(function(){return r.redirect(i)}),this._hideSuggestions()):void 0},o.prototype._keyForFile=function(e){return e.ns_id+"_"+e.sjid},o.prototype._keyForDropdownIndex=function(e){return this._getDropdownRow(e).data("identity")},o.prototype._fileForKey=function(e){return this._files[e]},o.prototype._keyForElement=function(e){return t(e).closest("[data-identity]").attr("data-identity")},o.prototype._isSearchBarVisible=function(){return this.$suggestion_list_holder.is(":visible")},o.prototype._getDropdownRowCount=function(){return this._isSearchBarVisible()?this.$suggestion_list.children().size()+1:0},o.prototype._hasDropdownRowAtIndex=function(e){return e>=-1&&e<this._getDropdownRowCount()},o.prototype._getDropdownRow=function(e){return T(this._hasDropdownRowAtIndex(e),"Focus on nonexistent search bar suggestion"),0===e?this.$search_text:this.$suggestion_list.children().eq(e-1)},o.prototype._unfocusDropdownRow=function(){return this._hasDropdownRowAtIndex(this._focused_dropdown_row)&&(this._getDropdownRow(this._focused_dropdown_row).removeClass("focused"),this.$search_bar_holder.addClass("ie8hax").removeClass("ie8hax")),this._focused_dropdown_row=-1},o.prototype._focusDropdownRow=function(e){return this._focused_dropdown_row!==e?(this._unfocusDropdownRow(),this._getDropdownRow(e).addClass("focused"),this.$search_bar_holder.addClass("ie8hax").removeClass("ie8hax"),this._focused_dropdown_row=e):void 0},o.prototype._createBrowseFileShim=function(e,t){var i;return null==t&&(t=null),n.extend({},e,{filename:d.filename(e.fq_path),size:"None"!==e.size?e.size:"",is_deleted:-1===e.bytes,dir:e.is_dir?1:0,sort_key:e.sort_key||[""],request_id:t,match_type:null!=(i=e.match_type)?i:"UNKNOWN_MATCH",last_modified_fname:null,caption:null})},o.prototype._callAfterTransition=function(e){var t,o;return o=this.$search_bar.css("transition-duration"),t=o&&"0s"!==o,i.csstransitions&&t&&this._is_transitioning?this.$search_bar.one("transitionend",e):n.defer(e)},o}()})}.call(this),function(){define("modules/dirty/sharing/sf_access_type",["jquery","modules/core/controller_helpers","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/components/bubble_picker","modules/clean/dbmodal","modules/clean/dbmodal_loading","modules/clean/groups/api","modules/clean/sharing/api","modules/clean/viewer"],function(e,t,n,i,o,s,r,a,l,c,u){var d,p,h,_,m,f;return f=n._,_=o.SharedFolderActivityLogger,d=r.DBModal,p=r.DBModalStack,m=c.SharingApi,h=function(){function e(e,n){this.$access_type_el=e,this.ajax_data=n,this.bubble_picker=t.get_controller(this.$access_type_el),this.$access_type_el.on(s.CHANGED,function(e){return function(t,n){var i,o,s,r,a,l;return s=n.old_val,o=n.clicked_val,Number(s)===Number(o)?!1:(e.ajax_data&&(l=u.get_viewer().get_user_by_id(e.ajax_data.user_id),r=e.ajax_data.params,i=e.ajax_data.access_types,a=e.$access_type_el.closest(".bs-row").find(".sf-display-name").text(),"owner"===i[o]?(e.show_make_owner_modal(l,r.member_uid,r.ns_id,a,o),e.bubble_picker.set_value(s)):e.update_access_type(l,r,a,o)),!1)}}(this))}return e.prototype.show_make_owner_modal=function(e,t,n,o,s){return require(["dropbox"],function(i){var r;return r=i.MakeOwnerModal,p.push(new r(e,{element_id:"make-owner-confirm-modal",member_uid:t,member_name:o,ns_id:n,access_type:s}))},function(){return i.error(i.DEFAULT_ERROR)})},e.prototype.update_access_type=function(e,t,n,o){var s,r,c;return s={ns_id:t.ns_id,access_type:o},c=function(o){return function(r){var l,c,u;if(u=JSON.parse(r.responseText),s.member_id=t.member_uid,"OK"===u.status){switch(s.succes=!0,u.access_type){case"viewer":c=f("%(name)s can only view now.").format({name:n});break;case"editor":c=f("%(name)s can edit now.").format({name:n});break;case"owner":c=f("%(name)s is the owner now.").format({name:n})}c&&i.success(c)}else"ERROR"===u.status&&(s.succes=!1,u.msg&&(s.message=u.msg,i.error(u.msg)),u.reload&&(l=d.get_containing_modal(o.$access_type_el),l&&l instanceof a&&l.fetch()));return _.log("web","invite_modal_change_callback",e,s)}}(this),r=new m(e),t.member_uid?(r.update_member_access_type(t.ns_id,t.member_uid,o,c),s.member_uid=t.member_uid,_.log("web","invite_modal_change_collaborator",e,s)):t.invite_id?(r.update_invite_access_type(t.invite_id,o,c),s.invite_id=t.invite_id,_.log("web","invite_modal_change_invite",e,s)):t?(l.change_group_access_type({ns_id:t.ns_id,group_id:t.group_gid,access_type:o},c),s.group_id=t.group_gid,_.log("web","invite_modal_change_group",e,s)):void 0},e}()})}.call(this),function(){define("modules/dirty/sharing/sharing_growth_email_experiments",["dropbox","modules/clean/analytics"],function(e,t){var n,i,o;return o=e.Upload,n=t.SharedFolderActivityLogger,i=function(){function e(){}return e.listen_for_first_upload=function(e,t){var i;return i=function(){return function(){return n.log("web","file_upload",e,t),document.stopObserving(o.QUEUE_EVT,i),document.stopObserving(o.CHOOSE_FILE_BASIC,i)}}(this),document.observe(o.QUEUE_EVT,i),document.observe(o.CHOOSE_FILE_BASIC,i)},e}()})}.call(this),function(){define("modules/dirty/unity_browse_interface",["dropbox","jquery","modules/clean/unity/check_file_cache","modules/clean/unity/features"],function(e,t,n,i){var o,s;return o=e.Browse,null!=n&&null!=i?s=function(){function e(){}return e.BATCH_SIZE_LIMIT=100,e.CHECK_FILES_PADDING=50,e.listen=function(){return o.add_visible_change_callback(e.browse_visible_change_callback)},e.check_file_callback=function(e){return n.set_batch(e)},e.browse_visible_change_callback=function(t,n,o,s){var r,a,l,c,u,d;if(t.length&&(c=Math.max(0,o-e.CHECK_FILES_PADDING),d=Math.min(t.length-1,s+e.CHECK_FILES_PADDING),a=t.slice(c,+d+1||9e9),l=e._get_files_to_check(a),l.length)){for(e._remove_unneeded_items_from_cache(a),u=[];l.length;)r=l.splice(0,e.BATCH_SIZE_LIMIT),u.push(i.check_file_batch(r,n,e.check_file_callback));return u}},e._get_files_to_check=function(e){var t;return function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)t=e[i],t.bytes>=0&&n.is_cached_and_locally_available(t.ns_id,t.ns_path)!==!0&&s.push(t);return s}()},e._remove_unneeded_items_from_cache=function(e){var t,o,s,r,a;for(o={},r=0,a=e.length;a>r;r++)s=e[r],n.is_cached_and_locally_available(s.ns_id,s.ns_path)===!0&&(t=n.get(s.ns_id,s.ns_path),o[i.server_path(s.ns_id,s.ns_path)]=t);return n.clear(),n.set_batch(o)},e}():void 0})}.call(this);