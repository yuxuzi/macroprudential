(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["external/underscore","external/lru","modules/clean/comments/actions","modules/clean/comments/models/file_activity_cursor","modules/clean/comments/store","modules/clean/promise"],function(e,r,n,o,i,s){var u,c,a;return c=s.Promise,a=function(t,e,r,n){return null==n&&(n=""),t=null!=t?t:"",t+":"+e+":"+r+":"+n},u=function(){function s(e){this._cache=e._cache,this._pendingRequests=e._pendingRequests,this._unsubscribeStore=e._unsubscribeStore,this._sendFileActivity=e._sendFileActivity,this._state=e._state,this.onCursorUpdated=t(this.onCursorUpdated,this),this.onFetchCompleted=t(this.onFetchCompleted,this),this.onStoreUpdate=t(this.onStoreUpdate,this)}return s.getInstance=function(){var t;return t=s,null==t.__instance&&(t.__instance=t.create(i,n.receiveFileActivity)),t.__instance},s.create=function(t,e,n){var o,i;return null==n&&(n=10),o=new r(n),o.shift=function(){var t,e;return e=r.prototype.shift.call(this),t=e.value,null!=t&&t.removeAllListeners(),null!=t&&t.stopLiveUpdate(),e},i=new s({_cache:o,_pendingRequests:{},_state:{},_sendFileActivity:e}),i._unsubscribeStore=t.listen(i.onStoreUpdate),i.onStoreUpdate(t.state),i},s.prototype.dispose=function(){return this._unsubscribeStore()},s.prototype.replaceState=function(t){var e;return this.shouldUpdate(t)?(this.willUpdate(t),e=this._state,this._state=t,this.didUpdate(e)):void 0},s.prototype.getState=function(){return this._state},s.prototype.onStoreUpdate=function(t){var e,r,n,o,i,s;return e=t.actorId,i=t.oref,s=t.viewing,r=s.context,n=s.contextData,o={oref:i,actorId:e,context:r,contextData:n},this.replaceState(o)},s.prototype.shouldUpdate=function(t){return!e.isEqual(this._state,t)},s.prototype.willUpdate=function(){var t;return t=this.getCurrentCursor(),null!=t?this.deactivateCursor(t):void 0},s.prototype.didUpdate=function(){var t;return t=this.getCurrentFetchKey(),this.isFetching(t)||(this.sendActivity(null),this.isNullState(this._state))?void 0:this.fetchAndSend(this._state)},s.prototype.getFetchKey=function(t){var e,r,n,o;return e=t.actorId,r=t.context,n=t.contextData,o=t.oref,a(e,r,n,o)},s.prototype.getCurrentFetchKey=function(){return this.getFetchKey(this._state)},s.prototype.getCurrentCursor=function(){var t;return t=this.getCurrentFetchKey(),this._cache.get(t)},s.prototype.isFetching=function(t){return this.getFetchKey(t)in this._pendingRequests},s.prototype.isNullState=function(t){return!(null!=t.context&&null!=t.contextData)},s.prototype.activateCursor=function(t){return t.on("updated",this.onCursorUpdated),t.on("error",this.onCursorError),t.startLiveUpdate()},s.prototype.deactivateCursor=function(t){return t.off("updated",this.onCursorUpdated),t.off("error",this.onCursorError),t.stopLiveUpdate()},s.prototype.deactivateCurrentCursor=function(){var t;return t=this.getCurrentCursor(),null!=t?this.deactivateCursor(t):void 0},s.prototype.fetchAndSend=function(t){var r,n,i,s,u,h;return r=t.actorId,i=t.context,s=t.contextData,h=t.oref,u=a(r,i,s,h),n=this._cache.get(u),null!=n?(this.activateCursor(n),this.sendActivity(n.getFileActivity()),c.resolve()):(this._pendingRequests[u]=!0,o.fetch({actorId:r,context:i,contextData:s,oref:h}).then(e.partial(this.onFetchCompleted,u)).catch(e.partial(this.onFetchFailed,u)).finally(function(t){return function(){return delete t._pendingRequests[u]}}(this)))},s.prototype.onFetchCompleted=function(t,e){return this._cache.set(t,e),this.getCurrentFetchKey()===t?(this.activateCursor(e),this.sendActivity(e.getFileActivity())):void 0},s.prototype.onFetchFailed=function(t,e){throw e},s.prototype.onCursorError=function(t){throw t},s.prototype.onCursorUpdated=function(t){return this.sendActivity(t)},s.prototype.sendActivity=function(t){return this._sendFileActivity(t)},s.prototype.modify=function(t){var e,r;return e=this.getCurrentCursor(),null!=e?(r=e.update(t),this.sendActivity(r),!0):!1},s.prototype.forcePull=function(){var t;return null!=(t=this.getCurrentCursor())?t.pull():void 0},s}()})}).call(this);